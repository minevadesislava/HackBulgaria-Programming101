<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>basicTypes/MkId.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The AQUA Project, Glasgow University, 1998
%

This module contains definitions for the IdInfo for things that
have a standard form, namely:

- data constructors
- record selectors
- method and superclass selectors
- primitive operations

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>MkId</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>        <span class='hs-varid'>mkDictFunId</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDictFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDictSelId</span><span class='hs-layout'>,</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-varid'>mkPrimOpId</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFCallId</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-varid'>wrapNewTypeBody</span><span class='hs-layout'>,</span> <span class='hs-varid'>unwrapNewTypeBody</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>wrapFamInstBody</span><span class='hs-layout'>,</span> <span class='hs-varid'>unwrapFamInstScrut</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>wrapTypeFamInstBody</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapTypeUnbranchedFamInstBody</span><span class='hs-layout'>,</span> <span class='hs-varid'>unwrapTypeFamInstScrut</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>unwrapTypeUnbranchedFamInstScrut</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-conid'>DataConBoxer</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDataConRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDataConWorkId</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-comment'>-- And some particular Ids; see below for why they are wired in</span>
<a name="line-21"></a>        <span class='hs-varid'>wiredInIds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ghcPrimIds</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>unsafeCoerceName</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeCoerceId</span><span class='hs-layout'>,</span> <span class='hs-varid'>realWorldPrimId</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>voidPrimId</span><span class='hs-layout'>,</span> <span class='hs-varid'>voidArgId</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>nullAddrId</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqId</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazyId</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazyIdKey</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>coercionTokenId</span><span class='hs-layout'>,</span> <span class='hs-varid'>magicDictId</span><span class='hs-layout'>,</span> <span class='hs-varid'>coerceId</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>	<span class='hs-comment'>-- Re-export error Ids</span>
<a name="line-28"></a>	<span class='hs-keyword'>module</span> <span class='hs-conid'>PrelRules</span>
<a name="line-29"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Rules</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelRules</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>exprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCast</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUnfold</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>maybeToList</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Wired in Ids}
%*                                                                      *
%************************************************************************

Note [Wired-in Ids]
~~~~~~~~~~~~~~~~~~~
There are several reasons why an Id might appear in the wiredInIds:

(1) The ghcPrimIds are wired in because they can't be defined in
    Haskell at all, although the can be defined in Core.  They have
    compulsory unfoldings, so they are always inlined and they  have
    no definition site.  Their home module is GHC.Prim, so they
    also have a description in primops.txt.pp, where they are called
    'pseudoops'.

(2) The 'error' function, eRROR_ID, is wired in because we don't yet have
    a way to express in an interface file that the result type variable
    is 'open'; that is can be unified with an unboxed type

    [The interface file format now carry such information, but there's
    no way yet of expressing at the definition site for these 
    error-reporting functions that they have an 'open' 
    result type. -- sof 1/99]

(3) Other error functions (rUNTIME_ERROR_ID) are wired in (a) because
    the desugarer generates code that mentiones them directly, and
    (b) for the same reason as eRROR_ID

(4) lazyId is wired in because the wired-in version overrides the
    strictness of the version defined in GHC.Base

In cases (2-4), the function has a definition in a library module, and
can be called; but the wired-in version means that the details are 
never read from that module's interface file; instead, the full definition
is right here.

\begin{code}
<pre><a name="line-1"></a><a name="wiredInIds"></a><span class='hs-definition'>wiredInIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>wiredInIds</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>lazyId</span><span class='hs-layout'>,</span> <span class='hs-varid'>dollarId</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>errorIds</span>		<span class='hs-comment'>-- Defined in MkCore</span>
<a name="line-5"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>ghcPrimIds</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="ghcPrimIds"></a><span class='hs-comment'>-- These Ids are exported from GHC.Prim</span>
<a name="line-8"></a><span class='hs-definition'>ghcPrimIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-definition'>ghcPrimIds</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span>   <span class='hs-comment'>-- These can't be defined in Haskell, but they have</span>
<a name="line-11"></a>        <span class='hs-comment'>-- perfectly reasonable unfoldings in Core</span>
<a name="line-12"></a>    <span class='hs-varid'>realWorldPrimId</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-varid'>voidPrimId</span><span class='hs-layout'>,</span>
<a name="line-14"></a>    <span class='hs-varid'>unsafeCoerceId</span><span class='hs-layout'>,</span>
<a name="line-15"></a>    <span class='hs-varid'>nullAddrId</span><span class='hs-layout'>,</span>
<a name="line-16"></a>    <span class='hs-varid'>seqId</span><span class='hs-layout'>,</span>
<a name="line-17"></a>    <span class='hs-varid'>magicDictId</span><span class='hs-layout'>,</span>
<a name="line-18"></a>    <span class='hs-varid'>coerceId</span><span class='hs-layout'>,</span>
<a name="line-19"></a>    <span class='hs-varid'>proxyHashId</span>
<a name="line-20"></a>    <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Data constructors}
%*                                                                      *
%************************************************************************

The wrapper for a constructor is an ordinary top-level binding that evaluates
any strict args, unboxes any args that are going to be flattened, and calls
the worker.

We're going to build a constructor that looks like:

        data (Data a, C b) =>  T a b = T1 !a !Int b

        T1 = /\ a b -> 
             \d1::Data a, d2::C b ->
             \p q r -> case p of { p ->
                       case q of { q ->
                       Con T1 [a,b] [p,q,r]}}

Notice that

* d2 is thrown away --- a context in a data decl is used to make sure
  one *could* construct dictionaries at the site the constructor
  is used, but the dictionary isn't actually used.

* We have to check that we can construct Data dictionaries for
  the types a and Int.  Once we've done that we can throw d1 away too.

* We use (case p of q -> ...) to evaluate p, rather than "seq" because
  all that matters is that the arguments are evaluated.  "seq" is 
  very careful to preserve evaluation order, which we don't need
  to be here.

  You might think that we could simply give constructors some strictness
  info, like PrimOps, and let CoreToStg do the let-to-case transformation.
  But we don't do that because in the case of primops and functions strictness
  is a *property* not a *requirement*.  In the case of constructors we need to
  do something active to evaluate the argument.

  Making an explicit case expression allows the simplifier to eliminate
  it in the (common) case where the constructor arg is already evaluated.

Note [Wrappers for data instance tycons]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the case of data instances, the wrapper also applies the coercion turning
the representation type into the family instance type to cast the result of
the wrapper.  For example, consider the declarations

  data family Map k :: * -> *
  data instance Map (a, b) v = MapPair (Map a (Pair b v))

The tycon to which the datacon MapPair belongs gets a unique internal
name of the form :R123Map, and we call it the representation tycon.
In contrast, Map is the family tycon (accessible via
tyConFamInst_maybe). A coercion allows you to move between
representation and family type.  It is accessible from :R123Map via
tyConFamilyCoercion_maybe and has kind

  Co123Map a b v :: {Map (a, b) v ~ :R123Map a b v}

The wrapper and worker of MapPair get the types

        -- Wrapper
  $WMapPair :: forall a b v. Map a (Map a b v) -> Map (a, b) v
  $WMapPair a b v = MapPair a b v `cast` sym (Co123Map a b v)

        -- Worker
  MapPair :: forall a b v. Map a (Map a b v) -> :R123Map a b v

This coercion is conditionally applied by wrapFamInstBody.

It's a bit more complicated if the data instance is a GADT as well!

   data instance T [a] where
        T1 :: forall b. b -> T [Maybe b]

Hence we translate to

        -- Wrapper
  $WT1 :: forall b. b -> T [Maybe b]
  $WT1 b v = T1 (Maybe b) b (Maybe b) v
                        `cast` sym (Co7T (Maybe b))

        -- Worker
  T1 :: forall c b. (c ~ Maybe b) => b -> :R7T c

        -- Coercion from family type to representation type
  Co7T a :: T [a] ~ :R7T a

Note [Newtype datacons]
~~~~~~~~~~~~~~~~~~~~~~~
The "data constructor" for a newtype should always be vanilla.  At one
point this wasn't true, because the newtype arising from
     class C a => D a
looked like
       newtype T:D a = D:D (C a)
so the data constructor for T:C had a single argument, namely the
predicate (C a).  But now we treat that as an ordinary argument, not
part of the theta-type, so all is well.


%************************************************************************
%*                                                                      *
\subsection{Dictionary selectors}
%*                                                                      *
%************************************************************************

Selecting a field for a dictionary.  If there is just one field, then
there's nothing to do.  

Dictionary selectors may get nested forall-types.  Thus:

        class Foo a where
          op :: forall b. Ord b => a -> b -> b

Then the top-level type for op is

        op :: forall a. Foo a => 
              forall b. Ord b => 
              a -> b -> b

This is unlike ordinary record selectors, which have all the for-alls
at the outside.  When dealing with classes it's very convenient to
recover the original type signature from the class op selector.

\begin{code}
<pre><a name="line-1"></a><a name="mkDictSelId"></a><span class='hs-definition'>mkDictSelId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>	     <span class='hs-comment'>-- True &lt;=&gt; don't include the unfolding</span>
<a name="line-3"></a>			     <span class='hs-comment'>-- Little point on imports without -O, because the</span>
<a name="line-4"></a>			     <span class='hs-comment'>-- dictionary itself won't be visible</span>
<a name="line-5"></a> 	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>	     <span class='hs-comment'>-- Name of one of the *value* selectors </span>
<a name="line-6"></a>	       		     <span class='hs-comment'>-- (dictionary superclass or method)</span>
<a name="line-7"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-8"></a><span class='hs-definition'>mkDictSelId</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>no_unf</span> <span class='hs-varid'>name</span> <span class='hs-varid'>clas</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalId</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassOpId</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sel_ty</span> <span class='hs-varid'>info</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>sel_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dict_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>the_arg_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>        <span class='hs-comment'>-- We can't just say (exprType rhs), because that would give a type</span>
<a name="line-13"></a>        <span class='hs-comment'>--      C a -&gt; C a</span>
<a name="line-14"></a>        <span class='hs-comment'>-- for a single-op class (after all, the selector is the identity)</span>
<a name="line-15"></a>        <span class='hs-comment'>-- But it's type must expose the representation of the dictionary</span>
<a name="line-16"></a>        <span class='hs-comment'>-- to get (say)         C a -&gt; (a -&gt; a)</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>base_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span>
<a name="line-19"></a>                <span class='hs-varop'>`setArityInfo`</span>         <span class='hs-num'>1</span>
<a name="line-20"></a>                <span class='hs-varop'>`setStrictnessInfo`</span>    <span class='hs-varid'>strict_sig</span>
<a name="line-21"></a>                <span class='hs-varop'>`setUnfoldingInfo`</span>     <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>no_unf</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-22"></a>	                                <span class='hs-keyword'>else</span> <span class='hs-varid'>mkImplicitUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-23"></a>		   <span class='hs-comment'>-- In module where class op is defined, we must add</span>
<a name="line-24"></a>		   <span class='hs-comment'>-- the unfolding, even though it'll never be inlined</span>
<a name="line-25"></a>		   <span class='hs-comment'>-- because we use that to generate a top-level binding</span>
<a name="line-26"></a>		   <span class='hs-comment'>-- for the ClassOp</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>base_info</span> <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>alwaysInlinePragma</span>
<a name="line-29"></a>    	   	   <span class='hs-comment'>-- See Note [Single-method classes] in TcInstDcls</span>
<a name="line-30"></a>		   <span class='hs-comment'>-- for why alwaysInlinePragma</span>
<a name="line-31"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>base_info</span>  <span class='hs-varop'>`setSpecInfo`</span>       <span class='hs-varid'>mkSpecInfo</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rule</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>		       		  <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>neverInlinePragma</span>
<a name="line-33"></a>		   <span class='hs-comment'>-- Add a magic BuiltinRule, and never inline it</span>
<a name="line-34"></a>		   <span class='hs-comment'>-- so that the rule is always available to fire.</span>
<a name="line-35"></a>		   <span class='hs-comment'>-- See Note [ClassOp/DFun selection] in TcInstDcls</span>
<a name="line-36"></a>
<a name="line-37"></a>    <span class='hs-varid'>n_ty_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tyvars</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-comment'>-- This is the built-in rule that goes</span>
<a name="line-40"></a>    <span class='hs-comment'>-- 	    op (dfT d1 d2) ---&gt;  opT d1 d2</span>
<a name="line-41"></a>    <span class='hs-varid'>rule</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"Class op "</span> <span class='hs-varop'>`appendFS`</span> 
<a name="line-42"></a>    	   	       	 	     <span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ru_fn</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-44"></a>    	               <span class='hs-layout'>,</span> <span class='hs-varid'>ru_nargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_ty_args</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-45"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ru_try</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dictSelRule</span> <span class='hs-varid'>val_index</span> <span class='hs-varid'>n_ty_args</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-comment'>-- The strictness signature is of the form U(AAAVAAAA) -&gt; T</span>
<a name="line-48"></a>        <span class='hs-comment'>-- where the V depends on which item we are selecting</span>
<a name="line-49"></a>        <span class='hs-comment'>-- It's worth giving one, so that absence info etc is generated</span>
<a name="line-50"></a>        <span class='hs-comment'>-- even if the selector isn't inlined</span>
<a name="line-51"></a>
<a name="line-52"></a>    <span class='hs-varid'>strict_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosedStrictSig</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_dmd</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>topRes</span>
<a name="line-53"></a>    <span class='hs-varid'>arg_dmd</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evalDmd</span>
<a name="line-54"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkManyUsedDmd</span> <span class='hs-varop'>$</span>
<a name="line-55"></a>                          <span class='hs-varid'>mkProdDmd</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>the_arg_id</span> <span class='hs-varop'>==</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>evalDmd</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>absDmd</span>
<a name="line-56"></a>                                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_ids</span> <span class='hs-keyglyph'>]</span>
<a name="line-57"></a>
<a name="line-58"></a>    <span class='hs-varid'>tycon</span>      	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span>
<a name="line-59"></a>    <span class='hs-varid'>new_tycon</span>  	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-60"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>data_con</span><span class='hs-keyglyph'>]</span> 	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span>
<a name="line-61"></a>    <span class='hs-varid'>tyvars</span>     	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUnivTyVars</span> <span class='hs-varid'>data_con</span>
<a name="line-62"></a>    <span class='hs-varid'>arg_tys</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConRepArgTys</span> <span class='hs-varid'>data_con</span>	<span class='hs-comment'>-- Includes the dictionary superclasses</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-comment'>-- 'index' is a 0-index into the *value* arguments of the dictionary</span>
<a name="line-65"></a>    <span class='hs-varid'>val_index</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assoc</span> <span class='hs-str'>"MkId.mkDictSelId"</span> <span class='hs-varid'>sel_index_prs</span> <span class='hs-varid'>name</span>
<a name="line-66"></a>    <span class='hs-varid'>sel_index_prs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>idName</span> <span class='hs-layout'>(</span><span class='hs-varid'>classAllSelIds</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varop'>`zip`</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-varid'>the_arg_id</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getNth</span> <span class='hs-varid'>arg_ids</span> <span class='hs-varid'>val_index</span>
<a name="line-69"></a>    <span class='hs-varid'>pred</span>       	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-70"></a>    <span class='hs-varid'>dict_id</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocal</span> <span class='hs-num'>1</span> <span class='hs-varid'>pred</span>
<a name="line-71"></a>    <span class='hs-varid'>arg_ids</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocalsNum</span> <span class='hs-num'>2</span> <span class='hs-varid'>arg_tys</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>tyvars</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>dict_id</span>   <span class='hs-varid'>rhs_body</span><span class='hs-layout'>)</span>
<a name="line-74"></a>    <span class='hs-varid'>rhs_body</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unwrapNewTypeBody</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>dict_id</span><span class='hs-layout'>)</span>
<a name="line-75"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>dict_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>dict_id</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>the_arg_id</span><span class='hs-layout'>)</span>
<a name="line-76"></a>                                <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>varToCoreExpr</span> <span class='hs-varid'>the_arg_id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-77"></a>				<span class='hs-comment'>-- varToCoreExpr needed for equality superclass selectors</span>
<a name="line-78"></a>				<span class='hs-comment'>--   sel a b d = case x of { MkC _ (g:a~b) _ -&gt; CO g }</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="dictSelRule"></a><span class='hs-definition'>dictSelRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleFun</span>
<a name="line-81"></a><span class='hs-comment'>-- Tries to persuade the argument to look like a constructor</span>
<a name="line-82"></a><span class='hs-comment'>-- application, using exprIsConApp_maybe, and then selects</span>
<a name="line-83"></a><span class='hs-comment'>-- from it</span>
<a name="line-84"></a><span class='hs-comment'>--       sel_i t1..tk (D t1..tk op1 ... opm) = opi</span>
<a name="line-85"></a><span class='hs-comment'>--</span>
<a name="line-86"></a><span class='hs-definition'>dictSelRule</span> <span class='hs-varid'>val_index</span> <span class='hs-varid'>n_ty_args</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>id_unf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span>
<a name="line-87"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>dict_arg</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>drop</span> <span class='hs-varid'>n_ty_args</span> <span class='hs-varid'>args</span>
<a name="line-88"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>exprIsConApp_maybe</span> <span class='hs-varid'>id_unf</span> <span class='hs-varid'>dict_arg</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>getNth</span> <span class='hs-varid'>con_args</span> <span class='hs-varid'>val_index</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Boxing and unboxing
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="mkDataConWorkId"></a><span class='hs-definition'>mkDataConWorkId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><span class='hs-definition'>mkDataConWorkId</span> <span class='hs-varid'>wkr_name</span> <span class='hs-varid'>data_con</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalId</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataConWrapId</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>wkr_name</span> <span class='hs-varid'>nt_wrap_ty</span> <span class='hs-varid'>nt_work_info</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalId</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataConWorkId</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>wkr_name</span> <span class='hs-varid'>alg_wkr_ty</span> <span class='hs-varid'>wkr_info</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>data_con</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-comment'>----------- Workers for data types --------------</span>
<a name="line-12"></a>    <span class='hs-varid'>alg_wkr_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConRepType</span> <span class='hs-varid'>data_con</span>
<a name="line-13"></a>    <span class='hs-varid'>wkr_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConRepArity</span> <span class='hs-varid'>data_con</span>
<a name="line-14"></a>    <span class='hs-varid'>wkr_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span>
<a name="line-15"></a>                <span class='hs-varop'>`setArityInfo`</span>       <span class='hs-varid'>wkr_arity</span>
<a name="line-16"></a>                <span class='hs-varop'>`setStrictnessInfo`</span>  <span class='hs-varid'>wkr_sig</span>
<a name="line-17"></a>                <span class='hs-varop'>`setUnfoldingInfo`</span>   <span class='hs-varid'>evaldUnfolding</span>  <span class='hs-comment'>-- Record that it's evaluated,</span>
<a name="line-18"></a>                                                     <span class='hs-comment'>-- even if arity = 0</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>wkr_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosedStrictSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>wkr_arity</span> <span class='hs-varid'>topDmd</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConCPR</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>
<a name="line-21"></a>        <span class='hs-comment'>--      Note [Data-con worker strictness]</span>
<a name="line-22"></a>        <span class='hs-comment'>-- Notice that we do *not* say the worker is strict</span>
<a name="line-23"></a>        <span class='hs-comment'>-- even if the data constructor is declared strict</span>
<a name="line-24"></a>        <span class='hs-comment'>--      e.g.    data T = MkT !(Int,Int)</span>
<a name="line-25"></a>        <span class='hs-comment'>-- Why?  Because the *wrapper* is strict (and its unfolding has case</span>
<a name="line-26"></a>        <span class='hs-comment'>-- expresssions that do the evals) but the *worker* itself is not.</span>
<a name="line-27"></a>        <span class='hs-comment'>-- If we pretend it is strict then when we see</span>
<a name="line-28"></a>        <span class='hs-comment'>--      case x of y -&gt; $wMkT y</span>
<a name="line-29"></a>        <span class='hs-comment'>-- the simplifier thinks that y is "sure to be evaluated" (because</span>
<a name="line-30"></a>        <span class='hs-comment'>--  $wMkT is strict) and drops the case.  No, $wMkT is not strict.</span>
<a name="line-31"></a>        <span class='hs-comment'>--</span>
<a name="line-32"></a>        <span class='hs-comment'>-- When the simplifer sees a pattern </span>
<a name="line-33"></a>        <span class='hs-comment'>--      case e of MkT x -&gt; ...</span>
<a name="line-34"></a>        <span class='hs-comment'>-- it uses the dataConRepStrictness of MkT to mark x as evaluated;</span>
<a name="line-35"></a>        <span class='hs-comment'>-- but that's fine... dataConRepStrictness comes from the data con</span>
<a name="line-36"></a>        <span class='hs-comment'>-- not from the worker Id.</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-comment'>----------- Workers for newtypes --------------</span>
<a name="line-39"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nt_tvs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>nt_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSig</span> <span class='hs-varid'>data_con</span>
<a name="line-40"></a>    <span class='hs-varid'>res_ty_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>nt_tvs</span>
<a name="line-41"></a>    <span class='hs-varid'>nt_wrap_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>data_con</span>
<a name="line-42"></a>    <span class='hs-varid'>nt_work_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span>          <span class='hs-comment'>-- The NoCaf-ness is set by noCafIdInfo</span>
<a name="line-43"></a>                  <span class='hs-varop'>`setArityInfo`</span> <span class='hs-num'>1</span>      <span class='hs-comment'>-- Arity 1</span>
<a name="line-44"></a>                  <span class='hs-varop'>`setInlinePragInfo`</span>    <span class='hs-varid'>alwaysInlinePragma</span>
<a name="line-45"></a>                  <span class='hs-varop'>`setUnfoldingInfo`</span>     <span class='hs-varid'>newtype_unf</span>
<a name="line-46"></a>    <span class='hs-varid'>id_arg1</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocal</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>nt_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-47"></a>    <span class='hs-varid'>newtype_unf</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>data_con</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-48"></a>                            <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>nt_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>data_con</span>  <span class='hs-layout'>)</span>
<a name="line-49"></a>			      <span class='hs-comment'>-- Note [Newtype datacons]</span>
<a name="line-50"></a>                   <span class='hs-varid'>mkCompulsoryUnfolding</span> <span class='hs-varop'>$</span> 
<a name="line-51"></a>                   <span class='hs-varid'>mkLams</span> <span class='hs-varid'>nt_tvs</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>id_arg1</span> <span class='hs-varop'>$</span> 
<a name="line-52"></a>                   <span class='hs-varid'>wrapNewTypeBody</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>res_ty_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id_arg1</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="dataConCPR"></a><span class='hs-definition'>dataConCPR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-55"></a><span class='hs-definition'>dataConCPR</span> <span class='hs-varid'>con</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataTyCon</span> <span class='hs-varid'>tycon</span>     <span class='hs-comment'>-- Real data types only; that is, </span>
<a name="line-57"></a>                          <span class='hs-comment'>-- not unboxed tuples or newtypes</span>
<a name="line-58"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>con</span>  <span class='hs-comment'>-- No existentials </span>
<a name="line-59"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>wkr_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-60"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>wkr_arity</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>mAX_CPR_SIZE</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>is_prod</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>vanillaCprProdRes</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConRepArity</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-62"></a>               <span class='hs-keyword'>else</span> <span class='hs-varid'>cprSumRes</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTag</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-65"></a>  <span class='hs-keyword'>where</span>
<a name="line-66"></a>    <span class='hs-varid'>is_prod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isProductTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-67"></a>    <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>con</span>
<a name="line-68"></a>    <span class='hs-varid'>wkr_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConRepArity</span> <span class='hs-varid'>con</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-varid'>mAX_CPR_SIZE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span>
<a name="line-71"></a>    <span class='hs-varid'>mAX_CPR_SIZE</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span>
<a name="line-72"></a>    <span class='hs-comment'>-- We do not treat very big tuples as CPR-ish:</span>
<a name="line-73"></a>    <span class='hs-comment'>--      a) for a start we get into trouble because there aren't </span>
<a name="line-74"></a>    <span class='hs-comment'>--         "enough" unboxed tuple types (a tiresome restriction, </span>
<a name="line-75"></a>    <span class='hs-comment'>--         but hard to fix), </span>
<a name="line-76"></a>    <span class='hs-comment'>--      b) more importantly, big unboxed tuples get returned mainly</span>
<a name="line-77"></a>    <span class='hs-comment'>--         on the stack, and are often then allocated in the heap</span>
<a name="line-78"></a>    <span class='hs-comment'>--         by the caller.  So doing CPR for them may in fact make</span>
<a name="line-79"></a>    <span class='hs-comment'>--         things worse.</span>
</pre>\end{code}

-------------------------------------------------
--         Data constructor representation
-- 
-- This is where we decide how to wrap/unwrap the 
-- constructor fields
--
--------------------------------------------------


\begin{code}
<pre><a name="line-1"></a><a name="Unboxer"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Unboxer</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-2"></a>  <span class='hs-comment'>-- Unbox: bind rep vars by decomposing src var</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="Boxer"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Boxer</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnitBox</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Boxer</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-comment'>-- Box:   build src arg using these rep vars</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="DataConBoxer"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>DataConBoxer</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DCB</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>                       <span class='hs-comment'>-- Bind these src-level vars, returning the</span>
<a name="line-9"></a>                       <span class='hs-comment'>-- rep-level vars to bind in the pattern</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="mkDataConRep"></a><span class='hs-definition'>mkDataConRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>DataConRep</span>
<a name="line-12"></a><span class='hs-definition'>mkDataConRep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>wrap_name</span> <span class='hs-varid'>data_con</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>wrapper_reqd</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>NoDataConRep</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wrap_args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newLocal</span> <span class='hs-varid'>wrap_arg_tys</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrap_body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_rep_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_args</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varid'>unboxers</span><span class='hs-layout'>)</span> 
<a name="line-19"></a>                                 <span class='hs-varid'>initial_wrap_app</span>
<a name="line-20"></a>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wrap_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalId</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataConWrapId</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>wrap_name</span> <span class='hs-varid'>wrap_ty</span> <span class='hs-varid'>wrap_info</span>
<a name="line-22"></a>             <span class='hs-varid'>wrap_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span>
<a name="line-23"></a>                    	 <span class='hs-varop'>`setArityInfo`</span>         <span class='hs-varid'>wrap_arity</span>
<a name="line-24"></a>                    	     <span class='hs-comment'>-- It's important to specify the arity, so that partial</span>
<a name="line-25"></a>                    	     <span class='hs-comment'>-- applications are treated as values</span>
<a name="line-26"></a>		    	 <span class='hs-varop'>`setInlinePragInfo`</span>    <span class='hs-varid'>alwaysInlinePragma</span>
<a name="line-27"></a>                    	 <span class='hs-varop'>`setUnfoldingInfo`</span>     <span class='hs-varid'>wrap_unf</span>
<a name="line-28"></a>                    	 <span class='hs-varop'>`setStrictnessInfo`</span>    <span class='hs-varid'>wrap_sig</span>
<a name="line-29"></a>                    	     <span class='hs-comment'>-- We need to get the CAF info right here because TidyPgm</span>
<a name="line-30"></a>                    	     <span class='hs-comment'>-- does not tidy the IdInfo of implicit bindings (like the wrapper)</span>
<a name="line-31"></a>                    	     <span class='hs-comment'>-- so it not make sure that the CAF info is sane</span>
<a name="line-32"></a>
<a name="line-33"></a>    	     <span class='hs-varid'>wrap_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosedStrictSig</span> <span class='hs-varid'>wrap_arg_dmds</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConCPR</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>
<a name="line-34"></a>    	     <span class='hs-varid'>wrap_arg_dmds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mk_dmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropList</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varid'>wrap_bangs</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    	     <span class='hs-varid'>mk_dmd</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBanged</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evalDmd</span>
<a name="line-36"></a>    	                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topDmd</span>
<a name="line-37"></a>    	         <span class='hs-comment'>-- The Cpr info can be important inside INLINE rhss, where the</span>
<a name="line-38"></a>    	         <span class='hs-comment'>-- wrapper constructor isn't inlined.</span>
<a name="line-39"></a>    	         <span class='hs-comment'>-- And the argument strictness can be important too; we</span>
<a name="line-40"></a>    	         <span class='hs-comment'>-- may not inline a contructor when it is partially applied.</span>
<a name="line-41"></a>    	         <span class='hs-comment'>-- For example:</span>
<a name="line-42"></a>    	         <span class='hs-comment'>--      data W = C !Int !Int !Int</span>
<a name="line-43"></a>    	         <span class='hs-comment'>--      ...(let w = C x in ...(w p q)...)...</span>
<a name="line-44"></a>    	         <span class='hs-comment'>-- we want to see that w is strict in its two arguments</span>
<a name="line-45"></a>
<a name="line-46"></a>    	     <span class='hs-varid'>wrap_unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInlineUnfolding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>wrap_arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>wrap_rhs</span>
<a name="line-47"></a>             <span class='hs-varid'>wrap_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>`minusList`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-48"></a>    	     <span class='hs-varid'>wrap_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>wrap_tvs</span> <span class='hs-varop'>$</span> 
<a name="line-49"></a>    	                <span class='hs-varid'>mkLams</span> <span class='hs-varid'>wrap_args</span> <span class='hs-varop'>$</span>
<a name="line-50"></a>    	                <span class='hs-varid'>wrapFamInstBody</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>res_ty_args</span> <span class='hs-varop'>$</span>
<a name="line-51"></a>                        <span class='hs-varid'>wrap_body</span>
<a name="line-52"></a>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DCR</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dcr_wrap_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap_id</span>
<a name="line-54"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_boxer</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_boxer</span> <span class='hs-varid'>boxers</span>
<a name="line-55"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tys</span>
<a name="line-56"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_stricts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_strs</span>
<a name="line-57"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>dcr_bangs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>ev_tys</span> <span class='hs-varid'>wrap_bangs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>data_con</span>
<a name="line-61"></a>    <span class='hs-varid'>res_ty_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>)</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-62"></a>    <span class='hs-varid'>tycon</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>data_con</span>       <span class='hs-comment'>-- The representation TyCon (not family)</span>
<a name="line-63"></a>    <span class='hs-varid'>wrap_ty</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>data_con</span>
<a name="line-64"></a>    <span class='hs-varid'>ev_tys</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqSpecPreds</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varop'>++</span> <span class='hs-varid'>theta</span>
<a name="line-65"></a>    <span class='hs-varid'>all_arg_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_tys</span>                         <span class='hs-varop'>++</span> <span class='hs-varid'>orig_arg_tys</span>
<a name="line-66"></a>    <span class='hs-varid'>orig_bangs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mk_pred_strict_mark</span> <span class='hs-varid'>ev_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>data_con</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-varid'>wrap_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span> <span class='hs-varop'>++</span> <span class='hs-varid'>orig_arg_tys</span>
<a name="line-69"></a>    <span class='hs-varid'>wrap_arity</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>wrap_arg_tys</span>
<a name="line-70"></a>    	     <span class='hs-comment'>-- The wrap_args are the arguments *other than* the eq_spec</span>
<a name="line-71"></a>    	     <span class='hs-comment'>-- Because we are going to apply the eq_spec args manually in the</span>
<a name="line-72"></a>    	     <span class='hs-comment'>-- wrapper</span>
<a name="line-73"></a>
<a name="line-74"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>wrap_bangs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tys_w_strs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span>
<a name="line-75"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip3</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConArgRep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_arg_tys</span> <span class='hs-varid'>orig_bangs</span><span class='hs-layout'>)</span>
<a name="line-76"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>unboxers</span><span class='hs-layout'>,</span> <span class='hs-varid'>boxers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>wrappers</span>
<a name="line-77"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_strs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>rep_tys_w_strs</span><span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-varid'>wrapper_reqd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Newtypes have only a worker</span>
<a name="line-80"></a>                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>isBanged</span> <span class='hs-varid'>orig_bangs</span>   <span class='hs-comment'>-- Some forcing/unboxing</span>
<a name="line-81"></a>                                              <span class='hs-comment'>-- (includes eq_spec)</span>
<a name="line-82"></a>                    <span class='hs-varop'>||</span> <span class='hs-varid'>isFamInstTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Cast result</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-varid'>initial_wrap_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWorkId</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                      <span class='hs-varop'>`mkTyApps`</span>  <span class='hs-varid'>res_ty_args</span>
<a name="line-86"></a>    	              <span class='hs-varop'>`mkVarApps`</span> <span class='hs-varid'>ex_tvs</span>                 
<a name="line-87"></a>    	              <span class='hs-varop'>`mkCoApps`</span>  <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>eq_spec</span>
<a name="line-88"></a>    	                <span class='hs-comment'>-- Dont box the eq_spec coercions since they are</span>
<a name="line-89"></a>    	                <span class='hs-comment'>-- marked as HsUnpack by mk_dict_strict_mark</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-varid'>mk_boxer</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Boxer</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataConBoxer</span>
<a name="line-92"></a>    <span class='hs-varid'>mk_boxer</span> <span class='hs-varid'>boxers</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DCB</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>ty_args</span> <span class='hs-varid'>src_vars</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-93"></a>                      <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ex_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeList</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>src_vars</span>
<a name="line-94"></a>                               <span class='hs-varid'>subst1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span>
<a name="line-95"></a>                               <span class='hs-varid'>subst2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubstList</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>ex_tvs</span> 
<a name="line-96"></a>                                                          <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>ex_vars</span><span class='hs-layout'>)</span>
<a name="line-97"></a>                         <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst2</span> <span class='hs-varid'>boxers</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropList</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>src_vars</span><span class='hs-layout'>)</span>
<a name="line-98"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex_vars</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-99"></a>
<a name="line-100"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>src_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>src_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>data_con</span> <span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-101"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnitBox</span> <span class='hs-conop'>:</span> <span class='hs-varid'>boxers</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>src_var</span> <span class='hs-conop'>:</span> <span class='hs-varid'>src_vars</span><span class='hs-layout'>)</span>
<a name="line-102"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids2</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>boxers</span> <span class='hs-varid'>src_vars</span>
<a name="line-103"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>src_var</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rep_ids2</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Boxer</span> <span class='hs-varid'>boxer</span> <span class='hs-conop'>:</span> <span class='hs-varid'>boxers</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>src_var</span> <span class='hs-conop'>:</span> <span class='hs-varid'>src_vars</span><span class='hs-layout'>)</span>
<a name="line-105"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>boxer</span> <span class='hs-varid'>subst</span>
<a name="line-106"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids2</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>boxers</span> <span class='hs-varid'>src_vars</span>
<a name="line-107"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rep_ids2</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>src_var</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-108"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mk_boxer"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a>    <span class='hs-varid'>mk_rep_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Unboxer</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-111"></a>    <span class='hs-varid'>mk_rep_app</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>con_app</span> 
<a name="line-112"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>con_app</span>
<a name="line-113"></a>    <span class='hs-varid'>mk_rep_app</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>wrap_arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>unboxer</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>con_app</span> 
<a name="line-114"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>unbox_fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unboxer</span> <span class='hs-varid'>wrap_arg</span>
<a name="line-115"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_rep_app</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarApps</span> <span class='hs-varid'>con_app</span> <span class='hs-varid'>rep_ids</span><span class='hs-layout'>)</span>
<a name="line-116"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unbox_fn</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="newLocal"></a><span class='hs-comment'>-------------------------</span>
<a name="line-119"></a><span class='hs-definition'>newLocal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>Var</span>
<a name="line-120"></a><span class='hs-definition'>newLocal</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueUs</span> 
<a name="line-121"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSysLocal</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"dt"</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="dataConArgRep"></a><span class='hs-comment'>-------------------------</span>
<a name="line-124"></a><span class='hs-definition'>dataConArgRep</span>
<a name="line-125"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> 
<a name="line-126"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-127"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBang</span>
<a name="line-128"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsBang</span>   <span class='hs-comment'>-- Like input but with HsUnpackFailed if necy</span>
<a name="line-129"></a>      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictnessMark</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Rep types</span>
<a name="line-130"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unboxer</span><span class='hs-layout'>,</span> <span class='hs-conid'>Boxer</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-131"></a>
<a name="line-132"></a><span class='hs-definition'>dataConArgRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ty</span> <span class='hs-conid'>HsNoBang</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNoBang</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>NotMarkedStrict</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitUnboxer</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBoxer</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-definition'>dataConArgRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- No '!'</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNoBang</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>NotMarkedStrict</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitUnboxer</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBoxer</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-definition'>dataConArgRep</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>arg_ty</span> 
<a name="line-139"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-varid'>unpk_prag</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- {-# UNPACK #-} !</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_OmitInterfacePragmas</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Don't unpack if -fomit-iface-pragmas</span>
<a name="line-141"></a>          <span class='hs-comment'>-- Don't unpack if we aren't optimising; rather arbitrarily, </span>
<a name="line-142"></a>          <span class='hs-comment'>-- we use -fomit-iface-pragmas as the indication</span>
<a name="line-143"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_co</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topNormaliseType_maybe</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>arg_ty</span>
<a name="line-144"></a>                     <span class='hs-comment'>-- Unwrap type families and newtypes</span>
<a name="line-145"></a>        <span class='hs-varid'>arg_ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_co</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span><span class='hs-layout'>;</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arg_ty</span> <span class='hs-layout'>}</span>
<a name="line-146"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isUnpackableType</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>arg_ty'</span>
<a name="line-147"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dataConArgUnpack</span> <span class='hs-varid'>arg_ty'</span>
<a name="line-148"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unpk_prag</span> <span class='hs-keyword'>of</span>
<a name="line-149"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_UnboxStrictFields</span> <span class='hs-varid'>dflags</span>
<a name="line-150"></a>              <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_UnboxSmallStrictFields</span> <span class='hs-varid'>dflags</span> 
<a name="line-151"></a>                   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rep_tys</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Unpack one-wide fields]</span>
<a name="line-152"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>unpack_me</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unpack_me</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_co</span> <span class='hs-keyword'>of</span>
<a name="line-154"></a>      <span class='hs-conid'>Nothing</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>   <span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span>
<a name="line-155"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span><span class='hs-varid'>rep_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>rep_ty</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span>
<a name="line-156"></a>
<a name="line-157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Record the strict-but-no-unpack decision</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strict_but_not_unpacked</span> <span class='hs-varid'>arg_ty</span>
<a name="line-159"></a>
<a name="line-160"></a><span class='hs-definition'>dataConArgRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ty</span> <span class='hs-conid'>HsStrict</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strict_but_not_unpacked</span> <span class='hs-varid'>arg_ty</span>
<a name="line-162"></a>
<a name="line-163"></a><span class='hs-definition'>dataConArgRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-164"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dataConArgUnpack</span> <span class='hs-varid'>arg_ty</span>
<a name="line-165"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-definition'>dataConArgRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_rep_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-169"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dataConArgUnpack</span> <span class='hs-varid'>co_rep_ty</span>
<a name="line-170"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>co_rep_ty</span> <span class='hs-varid'>wrappers</span><span class='hs-layout'>)</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="strict_but_not_unpacked"></a><span class='hs-definition'>strict_but_not_unpacked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBang</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>StrictnessMark</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unboxer</span><span class='hs-layout'>,</span> <span class='hs-conid'>Boxer</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-173"></a><span class='hs-definition'>strict_but_not_unpacked</span> <span class='hs-varid'>arg_ty</span>
<a name="line-174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrict</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>MarkedStrict</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>seqUnboxer</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBoxer</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="wrapCo"></a><span class='hs-comment'>-------------------------</span>
<a name="line-177"></a><span class='hs-definition'>wrapCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unboxer</span><span class='hs-layout'>,</span> <span class='hs-conid'>Boxer</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unboxer</span><span class='hs-layout'>,</span> <span class='hs-conid'>Boxer</span><span class='hs-layout'>)</span>
<a name="line-178"></a><span class='hs-definition'>wrapCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>rep_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>unbox_rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>box_rep</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- co :: arg_ty ~ rep_ty</span>
<a name="line-179"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unboxer</span><span class='hs-layout'>,</span> <span class='hs-varid'>boxer</span><span class='hs-layout'>)</span>
<a name="line-180"></a>  <span class='hs-keyword'>where</span>
<a name="line-181"></a>    <span class='hs-varid'>unboxer</span> <span class='hs-varid'>arg_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rep_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocal</span> <span class='hs-varid'>rep_ty</span>
<a name="line-182"></a>                        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unbox_rep</span> <span class='hs-varid'>rep_id</span>
<a name="line-183"></a>                        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>rep_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>arg_id</span> <span class='hs-varop'>`Cast`</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-184"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>co_bind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rep_fn</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-185"></a>    <span class='hs-varid'>boxer</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Boxer</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-186"></a>            <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_expr</span><span class='hs-layout'>)</span> 
<a name="line-187"></a>                    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>box_rep</span> <span class='hs-keyword'>of</span>
<a name="line-188"></a>                         <span class='hs-conid'>UnitBox</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rep_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocal</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rep_ty</span><span class='hs-layout'>)</span>
<a name="line-189"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>rep_id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>rep_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-190"></a>                         <span class='hs-conid'>Boxer</span> <span class='hs-varid'>boxer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>boxer</span> <span class='hs-varid'>subst</span>
<a name="line-191"></a>               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-192"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_expr</span> <span class='hs-varop'>`Cast`</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>sco</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="seqUnboxer"></a><span class='hs-comment'>------------------------</span>
<a name="line-195"></a><span class='hs-definition'>seqUnboxer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unboxer</span>
<a name="line-196"></a><span class='hs-definition'>seqUnboxer</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="unitUnboxer"></a><span class='hs-definition'>unitUnboxer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unboxer</span>
<a name="line-199"></a><span class='hs-definition'>unitUnboxer</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-200"></a>
<a name="line-201"></a><a name="unitBoxer"></a><span class='hs-definition'>unitBoxer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Boxer</span>
<a name="line-202"></a><span class='hs-definition'>unitBoxer</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnitBox</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="dataConArgUnpack"></a><span class='hs-comment'>-------------------------</span>
<a name="line-205"></a><span class='hs-definition'>dataConArgUnpack</span>
<a name="line-206"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>
<a name="line-207"></a>   <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictnessMark</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Rep types</span>
<a name="line-208"></a>       <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unboxer</span><span class='hs-layout'>,</span> <span class='hs-conid'>Boxer</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-209"></a>
<a name="line-210"></a><span class='hs-definition'>dataConArgUnpack</span> <span class='hs-varid'>arg_ty</span>
<a name="line-211"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>arg_ty</span>
<a name="line-212"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConSingleAlgDataCon_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-213"></a>      <span class='hs-comment'>-- NB: check for an *algebraic* data type</span>
<a name="line-214"></a>      <span class='hs-comment'>-- A recursive newtype might mean that </span>
<a name="line-215"></a>      <span class='hs-comment'>-- 'arg_ty' is a newtype</span>
<a name="line-216"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rep_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConInstArgTys</span> <span class='hs-varid'>con</span> <span class='hs-varid'>tc_args</span>
<a name="line-217"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>con</span> <span class='hs-layout'>)</span>
<a name="line-218"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>rep_tys</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>dataConRepStrictness</span> <span class='hs-varid'>con</span>
<a name="line-219"></a>    <span class='hs-layout'>,</span><span class='hs-layout'>(</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>arg_id</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-220"></a>       <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rep_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newLocal</span> <span class='hs-varid'>rep_tys</span>
<a name="line-221"></a>          <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unbox_fn</span> <span class='hs-varid'>body</span>
<a name="line-222"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>arg_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_id</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-223"></a>                         <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-224"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>unbox_fn</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-225"></a>     <span class='hs-layout'>,</span> <span class='hs-conid'>Boxer</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-226"></a>       <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rep_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newLocal</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>rep_tys</span>
<a name="line-227"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ids</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWorkId</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-228"></a>                             <span class='hs-varop'>`mkTyApps`</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span>
<a name="line-229"></a>                             <span class='hs-varop'>`mkVarApps`</span> <span class='hs-varid'>rep_ids</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-231"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dataConArgUnpack"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-232"></a>    <span class='hs-comment'>-- An interface file specified Unpacked, but we couldn't unpack it</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="isUnpackableType"></a><span class='hs-definition'>isUnpackableType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-235"></a><span class='hs-comment'>-- True if we can unpack the UNPACK the argument type </span>
<a name="line-236"></a><span class='hs-comment'>-- See Note [Recursive unboxing]</span>
<a name="line-237"></a><span class='hs-comment'>-- We look "deeply" inside rather than relying on the DataCons</span>
<a name="line-238"></a><span class='hs-comment'>-- we encounter on the way, because otherwise we might well</span>
<a name="line-239"></a><span class='hs-comment'>-- end up relying on ourselves!</span>
<a name="line-240"></a><span class='hs-definition'>isUnpackableType</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>ty</span>
<a name="line-241"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-242"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConSingleAlgDataCon_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-243"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>con</span>
<a name="line-244"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ok_con_args</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>con</span>
<a name="line-245"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-246"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-247"></a>  <span class='hs-keyword'>where</span>
<a name="line-248"></a>    <span class='hs-varid'>ok_arg</span> <span class='hs-varid'>tcs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>bang</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>attempt_unpack</span> <span class='hs-varid'>bang</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>ok_ty</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>norm_ty</span>
<a name="line-249"></a>        <span class='hs-keyword'>where</span>
<a name="line-250"></a>          <span class='hs-varid'>norm_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topNormaliseType</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>ty</span>
<a name="line-251"></a>    <span class='hs-varid'>ok_ty</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>ty</span>
<a name="line-252"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-253"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span>
<a name="line-254"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>tcs</span><span class='hs-layout'>)</span>
<a name="line-255"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConSingleAlgDataCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-256"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>con</span>
<a name="line-257"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ok_con_args</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs</span> <span class='hs-varop'>`addOneToNameSet`</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>con</span>
<a name="line-258"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-259"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-260"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-261"></a>
<a name="line-262"></a>    <span class='hs-varid'>ok_con_args</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>con</span>
<a name="line-263"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>ok_arg</span> <span class='hs-varid'>tcs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-264"></a>         <span class='hs-comment'>-- NB: dataConStrictMarks gives the *user* request; </span>
<a name="line-265"></a>         <span class='hs-comment'>-- We'd get a black hole if we used dataConRepBangs</span>
<a name="line-266"></a>
<a name="line-267"></a>    <span class='hs-varid'>attempt_unpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-268"></a>    <span class='hs-varid'>attempt_unpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>unpk</span><span class='hs-layout'>)</span> <span class='hs-varid'>bang</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bang</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>unpk</span>
<a name="line-269"></a>    <span class='hs-varid'>attempt_unpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>bang</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bang</span>  <span class='hs-comment'>-- Be conservative</span>
<a name="line-270"></a>    <span class='hs-varid'>attempt_unpack</span> <span class='hs-conid'>HsStrict</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-271"></a>    <span class='hs-varid'>attempt_unpack</span> <span class='hs-conid'>HsNoBang</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [Unpack one-wide fields]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The flag UnboxSmallStrictFields ensures that any field that can
(safely) be unboxed to a word-sized unboxed field, should be so unboxed.
For example:

    data A = A Int#
    newtype B = B A
    data C = C !B
    data D = D !C
    data E = E !()
    data F = F !D
    data G = G !F !F

All of these should have an Int# as their representation, except
G which should have two Int#s.  

However 

    data T = T !(S Int)
    data S = S !a

Here we can represent T with an Int#.

Note [Recursive unboxing]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  data R = MkR {-# UNPACK #-} !S Int
  data S = MkS {-# UNPACK #-} !Int
The representation arguments of MkR are the *representation* arguments
of S (plus Int); the rep args of MkS are Int#.  This is all fine.

But be careful not to try to unbox this!
	data T = MkT {-# UNPACK #-} !T Int
Because then we'd get an infinite number of arguments.

Here is a more complicated case:
	data S = MkS {-# UNPACK #-} !T Int
	data T = MkT {-# UNPACK #-} !S Int
Each of S and T must decide independendently whether to unpack
and they had better not both say yes. So they must both say no.

Also behave conservatively when there is no UNPACK pragma
	data T = MkS !T Int
with -funbox-strict-fields or -funbox-small-strict-fields
we need to behave as if there was an UNPACK pragma there.

But it's the *argument* type that matters. This is fine:
	data S = MkS S !Int
because Int is non-recursive.


Note [Unpack equality predicates]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have a GADT with a contructor C :: (a~[b]) => b -> T a
we definitely want that equality predicate *unboxed* so that it
takes no space at all.  This is easily done: just give it
an UNPACK pragma. The rest of the unpack/repack code does the
heavy lifting.  This one line makes every GADT take a word less
space for each equality predicate, so it's pretty important!


\begin{code}
<pre><a name="line-1"></a><a name="mk_pred_strict_mark"></a><span class='hs-definition'>mk_pred_strict_mark</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBang</span>
<a name="line-2"></a><span class='hs-definition'>mk_pred_strict_mark</span> <span class='hs-varid'>pred</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEqPred</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span>	<span class='hs-comment'>-- Note [Unpack equality predicates]</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsNoBang</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Wrapping and unwrapping newtypes and type families
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="wrapNewTypeBody"></a><span class='hs-definition'>wrapNewTypeBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a><span class='hs-comment'>-- The wrapper for the data constructor for a newtype looks like this:</span>
<a name="line-3"></a><span class='hs-comment'>--      newtype T a = MkT (a,Int)</span>
<a name="line-4"></a><span class='hs-comment'>--      MkT :: forall a. (a,Int) -&gt; T a</span>
<a name="line-5"></a><span class='hs-comment'>--      MkT = /\a. \(x:(a,Int)). x `cast` sym (CoT a)</span>
<a name="line-6"></a><span class='hs-comment'>-- where CoT is the coercion TyCon assoicated with the newtype</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- The call (wrapNewTypeBody T [a] e) returns the</span>
<a name="line-9"></a><span class='hs-comment'>-- body of the wrapper, namely</span>
<a name="line-10"></a><span class='hs-comment'>--      e `cast` (CoT [a])</span>
<a name="line-11"></a><span class='hs-comment'>--</span>
<a name="line-12"></a><span class='hs-comment'>-- If a coercion constructor is provided in the newtype, then we use</span>
<a name="line-13"></a><span class='hs-comment'>-- it, otherwise the wrap/unwrap are both no-ops </span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><span class='hs-comment'>-- If the we are dealing with a newtype *instance*, we have a second coercion</span>
<a name="line-16"></a><span class='hs-comment'>-- identifying the family instance with the constructor of the newtype</span>
<a name="line-17"></a><span class='hs-comment'>-- instance.  This coercion is applied in any case (ie, composed with the</span>
<a name="line-18"></a><span class='hs-comment'>-- coercion constructor of the newtype or applied by itself).</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>wrapNewTypeBody</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-varid'>result_expr</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>)</span>
<a name="line-22"></a>    <span class='hs-varid'>wrapFamInstBody</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-varop'>$</span>
<a name="line-23"></a>    <span class='hs-varid'>mkCast</span> <span class='hs-varid'>result_expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-keyword'>where</span>
<a name="line-25"></a>    <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConCo</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-comment'>-- When unwrapping, we do *not* apply any family coercion, because this will</span>
<a name="line-28"></a><span class='hs-comment'>-- be done via a CoPat by the type checker.  We have to do it this way as</span>
<a name="line-29"></a><span class='hs-comment'>-- computing the right type arguments for the coercion requires more than just</span>
<a name="line-30"></a><span class='hs-comment'>-- a spliting operation (cf, TcPat.tcConPat).</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="unwrapNewTypeBody"></a><span class='hs-definition'>unwrapNewTypeBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-33"></a><span class='hs-definition'>unwrapNewTypeBody</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-varid'>result_expr</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-varid'>mkCast</span> <span class='hs-varid'>result_expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConCo</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="wrapFamInstBody"></a><span class='hs-comment'>-- If the type constructor is a representation type of a data instance, wrap</span>
<a name="line-38"></a><span class='hs-comment'>-- the expression into a cast adjusting the expression type, which is an</span>
<a name="line-39"></a><span class='hs-comment'>-- instance of the representation type, to the corresponding instance of the</span>
<a name="line-40"></a><span class='hs-comment'>-- family instance type.</span>
<a name="line-41"></a><span class='hs-comment'>-- See Note [Wrappers for data instance tycons]</span>
<a name="line-42"></a><span class='hs-definition'>wrapFamInstBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-43"></a><span class='hs-definition'>wrapFamInstBody</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCast</span> <span class='hs-varid'>body</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="wrapTypeFamInstBody"></a><span class='hs-comment'>-- Same as `wrapFamInstBody`, but for type family instances, which are</span>
<a name="line-50"></a><span class='hs-comment'>-- represented by a `CoAxiom`, and not a `TyCon`</span>
<a name="line-51"></a><span class='hs-definition'>wrapTypeFamInstBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-52"></a><span class='hs-definition'>wrapTypeFamInstBody</span> <span class='hs-varid'>axiom</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCast</span> <span class='hs-varid'>body</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>axiom</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="wrapTypeUnbranchedFamInstBody"></a><span class='hs-definition'>wrapTypeUnbranchedFamInstBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-56"></a><span class='hs-definition'>wrapTypeUnbranchedFamInstBody</span> <span class='hs-varid'>axiom</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTypeFamInstBody</span> <span class='hs-varid'>axiom</span> <span class='hs-num'>0</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="unwrapFamInstScrut"></a><span class='hs-definition'>unwrapFamInstScrut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-60"></a><span class='hs-definition'>unwrapFamInstScrut</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-varid'>scrut</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCast</span> <span class='hs-varid'>scrut</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- data instances only</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scrut</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="unwrapTypeFamInstScrut"></a><span class='hs-definition'>unwrapTypeFamInstScrut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-67"></a><span class='hs-definition'>unwrapTypeFamInstScrut</span> <span class='hs-varid'>axiom</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span> <span class='hs-varid'>scrut</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCast</span> <span class='hs-varid'>scrut</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>axiom</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="unwrapTypeUnbranchedFamInstScrut"></a><span class='hs-definition'>unwrapTypeUnbranchedFamInstScrut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-71"></a><span class='hs-definition'>unwrapTypeUnbranchedFamInstScrut</span> <span class='hs-varid'>axiom</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unwrapTypeFamInstScrut</span> <span class='hs-varid'>axiom</span> <span class='hs-num'>0</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Primitive operations}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkPrimOpId"></a><span class='hs-definition'>mkPrimOpId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><span class='hs-definition'>mkPrimOpId</span> <span class='hs-varid'>prim_op</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>strict_sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpSig</span> <span class='hs-varid'>prim_op</span>
<a name="line-6"></a>    <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-7"></a>    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInName</span> <span class='hs-varid'>gHC_PRIM</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOcc</span> <span class='hs-varid'>prim_op</span><span class='hs-layout'>)</span> 
<a name="line-8"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>mkPrimOpIdUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpTag</span> <span class='hs-varid'>prim_op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                         <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-conid'>UserSyntax</span>
<a name="line-10"></a>    <span class='hs-varid'>id</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalId</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimOpId</span> <span class='hs-varid'>prim_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-11"></a>                
<a name="line-12"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span>
<a name="line-13"></a>           <span class='hs-varop'>`setSpecInfo`</span>          <span class='hs-varid'>mkSpecInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>primOpRules</span> <span class='hs-varid'>name</span> <span class='hs-varid'>prim_op</span><span class='hs-layout'>)</span>
<a name="line-14"></a>           <span class='hs-varop'>`setArityInfo`</span>         <span class='hs-varid'>arity</span>
<a name="line-15"></a>           <span class='hs-varop'>`setStrictnessInfo`</span>    <span class='hs-varid'>strict_sig</span>
<a name="line-16"></a>           <span class='hs-varop'>`setInlinePragInfo`</span>    <span class='hs-varid'>neverInlinePragma</span>
<a name="line-17"></a>               <span class='hs-comment'>-- We give PrimOps a NOINLINE pragma so that we don't</span>
<a name="line-18"></a>               <span class='hs-comment'>-- get silly warnings from Desugar.dsRule (the inline_shadows_rule </span>
<a name="line-19"></a>               <span class='hs-comment'>-- test) about a RULE conflicting with a possible inlining</span>
<a name="line-20"></a>               <span class='hs-comment'>-- cf Trac #7287</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-comment'>-- For each ccall we manufacture a separate CCallOpId, giving it</span>
<a name="line-23"></a><span class='hs-comment'>-- a fresh unique, a type that is correct for this particular ccall,</span>
<a name="line-24"></a><span class='hs-comment'>-- and a CCall structure that gives the correct details about calling</span>
<a name="line-25"></a><span class='hs-comment'>-- convention etc.  </span>
<a name="line-26"></a><span class='hs-comment'>--</span>
<a name="line-27"></a><span class='hs-comment'>-- The *name* of this Id is a local name whose OccName gives the full</span>
<a name="line-28"></a><span class='hs-comment'>-- details of the ccall, type and all.  This means that the interface </span>
<a name="line-29"></a><span class='hs-comment'>-- file reader can reconstruct a suitable Id</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="mkFCallId"></a><span class='hs-definition'>mkFCallId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-32"></a><span class='hs-definition'>mkFCallId</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>fcall</span> <span class='hs-varid'>ty</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-34"></a>    <span class='hs-comment'>-- A CCallOpId should have no free type variables; </span>
<a name="line-35"></a>    <span class='hs-comment'>-- when doing substitutions won't substitute over it</span>
<a name="line-36"></a>    <span class='hs-varid'>mkGlobalId</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCallId</span> <span class='hs-varid'>fcall</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fcall</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-39"></a>    <span class='hs-comment'>-- The "occurrence name" of a ccall is the full info about the</span>
<a name="line-40"></a>    <span class='hs-comment'>-- ccall; it is encoded, but may have embedded spaces etc!</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFCallName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ_str</span>
<a name="line-43"></a>
<a name="line-44"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span>
<a name="line-45"></a>           <span class='hs-varop'>`setArityInfo`</span>         <span class='hs-varid'>arity</span>
<a name="line-46"></a>           <span class='hs-varop'>`setStrictnessInfo`</span>    <span class='hs-varid'>strict_sig</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>tau</span>
<a name="line-50"></a>    <span class='hs-varid'>arity</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span>
<a name="line-51"></a>    <span class='hs-varid'>strict_sig</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosedStrictSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>evalDmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>topRes</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{DictFuns and default methods}
%*                                                                      *
%************************************************************************

Note [Dict funs and default methods]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Dict funs and default methods are *not* ImplicitIds.  Their definition
involves user-written code, so we can't figure out their strictness etc
based on fixed info, as we can for constructors and record selectors (say).

NB: See also Note [Exported LocalIds] in Id

\begin{code}
<pre><a name="line-1"></a><a name="mkDictFunId"></a><span class='hs-definition'>mkDictFunId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>      <span class='hs-comment'>-- Name to use for the dict fun;</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> 
<a name="line-5"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-7"></a><span class='hs-comment'>-- Implements the DFun Superclass Invariant (see TcInstDcls)</span>
<a name="line-8"></a><span class='hs-comment'>-- See Note [Dict funs and default methods]</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>mkDictFunId</span> <span class='hs-varid'>dfun_name</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExportedLocalId</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFunId</span> <span class='hs-varid'>n_silent</span> <span class='hs-varid'>is_nt</span><span class='hs-layout'>)</span>
<a name="line-12"></a>                      <span class='hs-varid'>dfun_name</span>
<a name="line-13"></a>                      <span class='hs-varid'>dfun_ty</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>is_nt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span>
<a name="line-16"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>n_silent</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfun_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDictFunTy</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="mkDictFunTy"></a><span class='hs-definition'>mkDictFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>mkDictFunTy</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>silent_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfun_ty</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>dfun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>silent_theta</span> <span class='hs-varop'>++</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-23"></a>    <span class='hs-varid'>silent_theta</span> 
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span> 
<a name="line-25"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-27"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-varid'>discard</span> <span class='hs-varop'>$</span>
<a name="line-28"></a>        <span class='hs-varid'>substTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTopTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyVars</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>classSCTheta</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                   <span class='hs-comment'>-- See Note [Silent Superclass Arguments]</span>
<a name="line-31"></a>    <span class='hs-varid'>discard</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`eqPred`</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span>
<a name="line-32"></a>                 <span class='hs-comment'>-- See the DFun Superclass Invariant in TcInstDcls</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Un-definable}
%*                                                                      *
%************************************************************************

These Ids can't be defined in Haskell.  They could be defined in
unfoldings in the wired-in GHC.Prim interface file, but we'd have to
ensure that they were definitely, definitely inlined, because there is
no curried identifier for them.  That's what mkCompulsoryUnfolding
does.  If we had a way to get a compulsory unfolding from an interface
file, we could do that, but we don't right now.

unsafeCoerce# isn't so much a PrimOp as a phantom identifier, that
just gets expanded into a type coercion wherever it occurs.  Hence we
add it as a built-in Id with an unfolding here.

The type variables we use here are "open" type variables: this means
they can unify with both unlifted and lifted types.  Hence we provide
another gun with which to shoot yourself in the foot.

\begin{code}
<pre><a name="line-1"></a><a name="lazyIdName"></a><span class='hs-definition'>lazyIdName</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeCoerceName</span><span class='hs-layout'>,</span> <span class='hs-varid'>nullAddrName</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqName</span><span class='hs-layout'>,</span>
<a name="line-2"></a>   <span class='hs-varid'>realWorldName</span><span class='hs-layout'>,</span> <span class='hs-varid'>voidPrimIdName</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionTokenName</span><span class='hs-layout'>,</span>
<a name="line-3"></a>   <span class='hs-varid'>magicDictName</span><span class='hs-layout'>,</span> <span class='hs-varid'>coerceName</span><span class='hs-layout'>,</span> <span class='hs-varid'>proxyName</span><span class='hs-layout'>,</span> <span class='hs-varid'>dollarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-4"></a><a name="unsafeCoerceName"></a><span class='hs-definition'>unsafeCoerceName</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"unsafeCoerce#"</span><span class='hs-layout'>)</span>  <span class='hs-varid'>unsafeCoerceIdKey</span>  <span class='hs-varid'>unsafeCoerceId</span>
<a name="line-5"></a><a name="nullAddrName"></a><span class='hs-definition'>nullAddrName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"nullAddr#"</span><span class='hs-layout'>)</span>      <span class='hs-varid'>nullAddrIdKey</span>      <span class='hs-varid'>nullAddrId</span>
<a name="line-6"></a><a name="seqName"></a><span class='hs-definition'>seqName</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"seq"</span><span class='hs-layout'>)</span>            <span class='hs-varid'>seqIdKey</span>           <span class='hs-varid'>seqId</span>
<a name="line-7"></a><a name="realWorldName"></a><span class='hs-definition'>realWorldName</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"realWorld#"</span><span class='hs-layout'>)</span>     <span class='hs-varid'>realWorldPrimIdKey</span> <span class='hs-varid'>realWorldPrimId</span>
<a name="line-8"></a><a name="voidPrimIdName"></a><span class='hs-definition'>voidPrimIdName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"void#"</span><span class='hs-layout'>)</span>          <span class='hs-varid'>voidPrimIdKey</span>      <span class='hs-varid'>voidPrimId</span>
<a name="line-9"></a><span class='hs-definition'>lazyIdName</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_MAGIC</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"lazy"</span><span class='hs-layout'>)</span>           <span class='hs-varid'>lazyIdKey</span>          <span class='hs-varid'>lazyId</span>
<a name="line-10"></a><a name="coercionTokenName"></a><span class='hs-definition'>coercionTokenName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"coercionToken#"</span><span class='hs-layout'>)</span> <span class='hs-varid'>coercionTokenIdKey</span> <span class='hs-varid'>coercionTokenId</span>
<a name="line-11"></a><a name="magicDictName"></a><span class='hs-definition'>magicDictName</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"magicDict"</span><span class='hs-layout'>)</span>      <span class='hs-varid'>magicDictKey</span>       <span class='hs-varid'>magicDictId</span>
<a name="line-12"></a><a name="coerceName"></a><span class='hs-definition'>coerceName</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"coerce"</span><span class='hs-layout'>)</span>         <span class='hs-varid'>coerceKey</span>          <span class='hs-varid'>coerceId</span>
<a name="line-13"></a><a name="proxyName"></a><span class='hs-definition'>proxyName</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_PRIM</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"proxy#"</span><span class='hs-layout'>)</span>         <span class='hs-varid'>proxyHashKey</span>       <span class='hs-varid'>proxyHashId</span>
<a name="line-14"></a><a name="dollarName"></a><span class='hs-definition'>dollarName</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWiredInIdName</span> <span class='hs-varid'>gHC_BASE</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"$"</span><span class='hs-layout'>)</span>              <span class='hs-varid'>dollarIdKey</span>        <span class='hs-varid'>dollarId</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="dollarId"></a><span class='hs-definition'>dollarId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>  <span class='hs-comment'>-- Note [dollarId magic]</span>
<a name="line-2"></a><span class='hs-definition'>dollarId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>dollarName</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setUnfoldingInfo`</span> <span class='hs-varid'>unf</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>alphaTy</span> <span class='hs-varid'>openBetaTy</span>
<a name="line-6"></a>    <span class='hs-varid'>ty</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>openBetaTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>             <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_ty</span>
<a name="line-8"></a>    <span class='hs-varid'>unf</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInlineUnfolding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-9"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocals</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>alphaTy</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>    <span class='hs-varid'>rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>openBetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-11"></a>             <span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="proxyHashId"></a><span class='hs-comment'>------------------------------------------------</span>
<a name="line-14"></a><span class='hs-comment'>-- proxy# :: forall a. Proxy# a</span>
<a name="line-15"></a><span class='hs-definition'>proxyHashId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-16"></a><span class='hs-definition'>proxyHashId</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>proxyName</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setUnfoldingInfo`</span> <span class='hs-varid'>evaldUnfolding</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Note [evaldUnfoldings]</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>ty</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkProxyPrimTy</span> <span class='hs-varid'>k</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-varid'>kv</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kKiVar</span>
<a name="line-22"></a>    <span class='hs-varid'>k</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>kv</span>
<a name="line-23"></a>    <span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarList</span> <span class='hs-varid'>k</span>
<a name="line-24"></a>    <span class='hs-varid'>t</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="unsafeCoerceId"></a><span class='hs-comment'>------------------------------------------------</span>
<a name="line-27"></a><span class='hs-comment'>-- unsafeCoerce# :: forall a b. a -&gt; b</span>
<a name="line-28"></a><span class='hs-definition'>unsafeCoerceId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-29"></a><span class='hs-definition'>unsafeCoerceId</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>unsafeCoerceName</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-31"></a>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>alwaysInlinePragma</span>
<a name="line-33"></a>                       <span class='hs-varop'>`setUnfoldingInfo`</span>  <span class='hs-varid'>mkCompulsoryUnfolding</span> <span class='hs-varid'>rhs</span>
<a name="line-34"></a>           
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>openAlphaTyVar</span><span class='hs-layout'>,</span><span class='hs-varid'>openBetaTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>openAlphaTy</span> <span class='hs-varid'>openBetaTy</span><span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocals</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>openAlphaTy</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a>    <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>openAlphaTyVar</span><span class='hs-layout'>,</span><span class='hs-varid'>openBetaTyVar</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-40"></a>          <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnsafeCo</span> <span class='hs-varid'>openAlphaTy</span> <span class='hs-varid'>openBetaTy</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="nullAddrId"></a><span class='hs-comment'>------------------------------------------------</span>
<a name="line-43"></a><span class='hs-definition'>nullAddrId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-44"></a><span class='hs-comment'>-- nullAddr# :: Addr#</span>
<a name="line-45"></a><span class='hs-comment'>-- The reason is is here is because we don't provide </span>
<a name="line-46"></a><span class='hs-comment'>-- a way to write this literal in Haskell.</span>
<a name="line-47"></a><span class='hs-definition'>nullAddrId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>nullAddrName</span> <span class='hs-varid'>addrPrimTy</span> <span class='hs-varid'>info</span>
<a name="line-48"></a>  <span class='hs-keyword'>where</span>
<a name="line-49"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>alwaysInlinePragma</span>
<a name="line-50"></a>                       <span class='hs-varop'>`setUnfoldingInfo`</span>  <span class='hs-varid'>mkCompulsoryUnfolding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>nullAddrLit</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="seqId"></a><span class='hs-comment'>------------------------------------------------</span>
<a name="line-53"></a><span class='hs-definition'>seqId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>	<span class='hs-comment'>-- See Note [seqId magic]</span>
<a name="line-54"></a><span class='hs-definition'>seqId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>seqName</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>alwaysInlinePragma</span>
<a name="line-57"></a>                       <span class='hs-varop'>`setUnfoldingInfo`</span>  <span class='hs-varid'>mkCompulsoryUnfolding</span> <span class='hs-varid'>rhs</span>
<a name="line-58"></a>                       <span class='hs-varop'>`setSpecInfo`</span>       <span class='hs-varid'>mkSpecInfo</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>seq_cast_rule</span><span class='hs-keyglyph'>]</span>
<a name="line-59"></a>           
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-layout'>,</span><span class='hs-varid'>betaTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>alphaTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>betaTy</span> <span class='hs-varid'>betaTy</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-63"></a>              <span class='hs-comment'>-- NB argBetaTyVar; see Note [seqId magic]</span>
<a name="line-64"></a>
<a name="line-65"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocals</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>betaTy</span><span class='hs-keyglyph'>]</span>
<a name="line-66"></a>    <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-layout'>,</span><span class='hs-varid'>betaTyVar</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-varid'>betaTy</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-comment'>-- See Note [Built-in RULES for seq]</span>
<a name="line-69"></a>    <span class='hs-varid'>seq_cast_rule</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_name</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"seq of cast"</span>
<a name="line-70"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ru_fn</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqName</span>
<a name="line-71"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ru_nargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-72"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ru_try</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match_seq_of_cast</span>
<a name="line-73"></a>                                <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="match_seq_of_cast"></a><span class='hs-definition'>match_seq_of_cast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RuleFun</span>
<a name="line-76"></a>    <span class='hs-comment'>-- See Note [Built-in RULES for seq]</span>
<a name="line-77"></a><span class='hs-definition'>match_seq_of_cast</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>]</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>seqId</span> <span class='hs-varop'>`mkApps`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span>
<a name="line-79"></a>                              <span class='hs-varid'>scrut</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-definition'>match_seq_of_cast</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="lazyId"></a><span class='hs-comment'>------------------------------------------------</span>
<a name="line-83"></a><span class='hs-definition'>lazyId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>	<span class='hs-comment'>-- See Note [lazyId magic]</span>
<a name="line-84"></a><span class='hs-definition'>lazyId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>lazyIdName</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-85"></a>  <span class='hs-keyword'>where</span>
<a name="line-86"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span>
<a name="line-87"></a>    <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>alphaTy</span> <span class='hs-varid'>alphaTy</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>
<a name="line-90"></a><a name="magicDictId"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-91"></a><span class='hs-definition'>magicDictId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>  <span class='hs-comment'>-- See Note [magicDictId magic]</span>
<a name="line-92"></a><span class='hs-definition'>magicDictId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>magicDictName</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-93"></a>  <span class='hs-keyword'>where</span>
<a name="line-94"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>neverInlinePragma</span>
<a name="line-95"></a>  <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>alphaTy</span>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="coerceId"></a><span class='hs-definition'>coerceId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-100"></a><span class='hs-definition'>coerceId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>coerceName</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-101"></a>  <span class='hs-keyword'>where</span>
<a name="line-102"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setInlinePragInfo`</span> <span class='hs-varid'>alwaysInlinePragma</span>
<a name="line-103"></a>                       <span class='hs-varop'>`setUnfoldingInfo`</span>  <span class='hs-varid'>mkCompulsoryUnfolding</span> <span class='hs-varid'>rhs</span>
<a name="line-104"></a>    <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kKiVar</span>
<a name="line-105"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>kv</span>
<a name="line-106"></a>    <span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarList</span> <span class='hs-varid'>k</span>
<a name="line-107"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>aTy</span><span class='hs-layout'>,</span><span class='hs-varid'>bTy</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-108"></a>    <span class='hs-varid'>eqRTy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>coercibleTyCon</span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>aTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>bTy</span><span class='hs-keyglyph'>]</span>
<a name="line-109"></a>    <span class='hs-varid'>eqRPrimTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>eqReprPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>aTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>bTy</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a>    <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kv</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eqRTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>aTy</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>bTy</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>eqR</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>eq</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocals</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eqRTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>aTy</span><span class='hs-layout'>,</span><span class='hs-varid'>eqRPrimTy</span><span class='hs-keyglyph'>]</span>
<a name="line-113"></a>    <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kv</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>eqR</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-114"></a>          <span class='hs-varid'>mkWildCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>eqR</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqRTy</span> <span class='hs-varid'>bTy</span> <span class='hs-varop'>$</span>
<a name="line-115"></a>	  <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>coercibleDataCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eq</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>eq</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [dollarId magic]
~~~~~~~~~~~~~~~~~~~~~
The only reason that ($) is wired in is so that its type can be
    forall (a:*, b:Open). (a->b) -> a -> b
That is, the return type can be unboxed.  E.g. this is OK
    foo $ True    where  foo :: Bool -> Int#
because ($) doesn't inspect or move the result of the call to foo.
See Trac #8739.

There is a special typing rule for ($) in TcExpr, so the type of ($)
isn't looked at there, BUT Lint subsequently (and rightly) complains
if sees ($) applied to Int# (say), unless we give it a wired-in type
as we do here.

Note [Unsafe coerce magic]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We define a *primitive*
   GHC.Prim.unsafeCoerce#
and then in the base library we define the ordinary function
   Unsafe.Coerce.unsafeCoerce :: forall (a:*) (b:*). a -> b
   unsafeCoerce x = unsafeCoerce# x

Notice that unsafeCoerce has a civilized (albeit still dangerous)
polymorphic type, whose type args have kind *.  So you can't use it on
unboxed values (unsafeCoerce 3#).

In contrast unsafeCoerce# is even more dangerous because you *can* use
it on unboxed things, (unsafeCoerce# 3#) :: Int. Its type is
   forall (a:OpenKind) (b:OpenKind). a -> b

Note [seqId magic]
~~~~~~~~~~~~~~~~~~
'GHC.Prim.seq' is special in several ways. 

a) Its second arg can have an unboxed type
      x `seq` (v +# w)
   Hence its second type variable has ArgKind

b) Its fixity is set in LoadIface.ghcPrimIface

c) It has quite a bit of desugaring magic. 
   See DsUtils.lhs Note [Desugaring seq (1)] and (2) and (3)

d) There is some special rule handing: Note [User-defined RULES for seq]

e) See Note [Typing rule for seq] in TcExpr.

Note [User-defined RULES for seq]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Roman found situations where he had
      case (f n) of _ -> e
where he knew that f (which was strict in n) would terminate if n did.
Notice that the result of (f n) is discarded. So it makes sense to
transform to
      case n of _ -> e

Rather than attempt some general analysis to support this, I've added
enough support that you can do this using a rewrite rule:

  RULE "f/seq" forall n.  seq (f n) e = seq n e

You write that rule.  When GHC sees a case expression that discards
its result, it mentally transforms it to a call to 'seq' and looks for
a RULE.  (This is done in Simplify.rebuildCase.)  As usual, the
correctness of the rule is up to you.

To make this work, we need to be careful that the magical desugaring
done in Note [seqId magic] item (c) is *not* done on the LHS of a rule.
Or rather, we arrange to un-do it, in DsBinds.decomposeRuleLhs.

Note [Built-in RULES for seq]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We also have the following built-in rule for seq

  seq (x `cast` co) y = seq x y

This eliminates unnecessary casts and also allows other seq rules to
match more often.  Notably,     

   seq (f x `cast` co) y  -->  seq (f x) y
  
and now a user-defined rule for seq (see Note [User-defined RULES for seq])
may fire.


Note [lazyId magic]
~~~~~~~~~~~~~~~~~~~
    lazy :: forall a?. a? -> a?   (i.e. works for unboxed types too)

Used to lazify pseq:   pseq a b = a `seq` lazy b

Also, no strictness: by being a built-in Id, all the info about lazyId comes from here,
not from GHC.Base.hi.   This is important, because the strictness
analyser will spot it as strict!

Also no unfolding in lazyId: it gets "inlined" by a HACK in CorePrep.
It's very important to do this inlining *after* unfoldings are exposed 
in the interface file.  Otherwise, the unfolding for (say) pseq in the
interface file will not mention 'lazy', so if we inline 'pseq' we'll totally
miss the very thing that 'lazy' was there for in the first place.
See Trac #3259 for a real world example.

lazyId is defined in GHC.Base, so we don't *have* to inline it.  If it
appears un-applied, we'll end up just calling it.


Note [magicDictId magic]
~~~~~~~~~~~~~~~~~~~~~~~~~

The identifier `magicDict` is just a place-holder, which is used to
implement a primitve that we cannot define in Haskell but we can write
in Core.  It is declared with a place-holder type:

    magicDict :: forall a. a

The intention is that the identifier will be used in a very specific way,
to create dictionaries for classes with a single method.  Consider a class
like this:

   class C a where
     f :: T a

We are going to use `magicDict`, in conjunction with a built-in Prelude
rule, to cast values of type `T a` into dictionaries for `C a`.  To do
this, we define a function like this in the library:

  data WrapC a b = WrapC (C a => Proxy a -> b)

  withT :: (C a => Proxy a -> b)
        ->  T a -> Proxy a -> b
  withT f x y = magicDict (WrapC f) x y

The purpose of `WrapC` is to avoid having `f` instantiated.
Also, it avoids impredicativity, because `magicDict`'s type
cannot be instantiated with a forall.  The field of `WrapC` contains
a `Proxy` parameter which is used to link the type of the constraint,
`C a`, with the type of the `Wrap` value being made.

Next, we add a built-in Prelude rule (see prelude/PrelRules.hs),
which will replace the RHS of this definition with the appropriate
definition in Core.  The rewrite rule works as follows:

magicDict@t (wrap@a@b f) x y
---->
f (x `cast` co a) y

The `co` coercion is the newtype-coercion extracted from the type-class.
The type class is obtain by looking at the type of wrap.



-------------------------------------------------------------
@realWorld#@ used to be a magic literal, \tr{void#}.  If things get
nasty as-is, change it back to a literal (@Literal@).

voidArgId is a Local Id used simply as an argument in functions
where we just want an arg to avoid having a thunk of unlifted type.
E.g.
        x = \ void :: Void# -> (# p, q #)

This comes up in strictness analysis

Note [evaldUnfoldings]
~~~~~~~~~~~~~~~~~~~~~~
The evaldUnfolding makes it look that some primitive value is
evaluated, which in turn makes Simplify.interestingArg return True,
which in turn makes INLINE things applied to said value likely to be
inlined.


\begin{code}
<pre><a name="line-1"></a><a name="realWorldPrimId"></a><span class='hs-definition'>realWorldPrimId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>   <span class='hs-comment'>-- :: State# RealWorld</span>
<a name="line-2"></a><span class='hs-definition'>realWorldPrimId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>realWorldName</span> <span class='hs-varid'>realWorldStatePrimTy</span>
<a name="line-3"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setUnfoldingInfo`</span> <span class='hs-varid'>evaldUnfolding</span>    <span class='hs-comment'>-- Note [evaldUnfoldings]</span>
<a name="line-4"></a>                                  <span class='hs-varop'>`setOneShotInfo`</span> <span class='hs-varid'>stateHackOneShot</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="voidPrimId"></a><span class='hs-definition'>voidPrimId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>     <span class='hs-comment'>-- Global constant :: Void#</span>
<a name="line-7"></a><span class='hs-definition'>voidPrimId</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>voidPrimIdName</span> <span class='hs-varid'>voidPrimTy</span>
<a name="line-8"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>noCafIdInfo</span> <span class='hs-varop'>`setUnfoldingInfo`</span> <span class='hs-varid'>evaldUnfolding</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Note [evaldUnfoldings]</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="voidArgId"></a><span class='hs-definition'>voidArgId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>       <span class='hs-comment'>-- Local lambda-bound :: Void#</span>
<a name="line-11"></a><span class='hs-definition'>voidArgId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysLocal</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"void"</span><span class='hs-layout'>)</span> <span class='hs-varid'>voidArgIdKey</span> <span class='hs-varid'>voidPrimTy</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="coercionTokenId"></a><span class='hs-definition'>coercionTokenId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> 	      <span class='hs-comment'>-- :: () ~ ()</span>
<a name="line-14"></a><span class='hs-definition'>coercionTokenId</span> <span class='hs-comment'>-- Used to replace Coercion terms when we go to STG</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pcMiscPrelId</span> <span class='hs-varid'>coercionTokenName</span> 
<a name="line-16"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>eqPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitTy</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                 <span class='hs-varid'>noCafIdInfo</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="pcMiscPrelId"></a><span class='hs-definition'>pcMiscPrelId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><span class='hs-definition'>pcMiscPrelId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVanillaGlobalWithInfo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>info</span>
<a name="line-4"></a>    <span class='hs-comment'>-- We lie and say the thing is imported; otherwise, we get into</span>
<a name="line-5"></a>    <span class='hs-comment'>-- a mess with dependency analysis; e.g., core2stg may heave in</span>
<a name="line-6"></a>    <span class='hs-comment'>-- random calls to GHCbase.unpackPS__.  If GHCbase is the module</span>
<a name="line-7"></a>    <span class='hs-comment'>-- being compiled, then it's just a matter of luck if the definition</span>
<a name="line-8"></a>    <span class='hs-comment'>-- will be in "the right place" to be in scope.</span>
</pre>\end{code}
</body>
</html>
