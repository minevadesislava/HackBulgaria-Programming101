<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>ghci/Linker.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2005-2012
%
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- | The dynamic linker for GHCi.</span>
<a name="line-2"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><span class='hs-comment'>-- This module deals with the top-level issues of dynamic linking,</span>
<a name="line-4"></a><span class='hs-comment'>-- calling the object-code linker and the byte-code linker where</span>
<a name="line-5"></a><span class='hs-comment'>-- necessary.</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# OPTIONS -fno-cse #-}</span>
<a name="line-8"></a><span class='hs-comment'>-- -fno-cse is needed for GLOBAL_VAR's to behave properly</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Linker</span> <span class='hs-layout'>(</span> <span class='hs-varid'>getHValue</span><span class='hs-layout'>,</span> <span class='hs-varid'>showLinkerState</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                <span class='hs-varid'>linkExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>linkDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>unload</span><span class='hs-layout'>,</span> <span class='hs-varid'>withExtendedLinkEnv</span><span class='hs-layout'>,</span>
<a name="line-12"></a>                <span class='hs-varid'>extendLinkEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>deleteFromLinkEnv</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                <span class='hs-varid'>extendLoadedPkgs</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                <span class='hs-varid'>linkPackages</span><span class='hs-layout'>,</span><span class='hs-varid'>initDynLinker</span><span class='hs-layout'>,</span><span class='hs-varid'>linkModule</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>                <span class='hs-comment'>-- Saving/restoring globals</span>
<a name="line-17"></a>                <span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-varid'>saveLinkerGlobals</span><span class='hs-layout'>,</span> <span class='hs-varid'>restoreLinkerGlobals</span>
<a name="line-18"></a>        <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ObjLink</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ByteCodeLink</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ByteCodeItbls</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ByteCodeAsm</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Packages</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DriverPhases</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Finder</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Maybes</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Config</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SysTools</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-comment'>-- Standard libraries</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>MVar</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<a name="line-62"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt; 704</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>findFile</span><span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-cpp'>#else</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span>
<a name="line-66"></a><span class='hs-cpp'>#endif</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>Package</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>depends</span><span class='hs-layout'>,</span> <span class='hs-conid'>PackageId</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Exception</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                        The Linker's state
%*                                                                      *
%************************************************************************

The persistent linker state *must* match the actual state of the
C dynamic linker at all times, so we keep it in a private global variable.

The global IORef used for PersistentLinkerState actually contains another MVar.
The reason for this is that we want to allow another loaded copy of the GHC
library to side-effect the PLS and for those changes to be reflected here.

The PersistentLinkerState maps Names to actual closures (for
interpreted code only), for use during linking.

\begin{code}
<pre><a name="line-1"></a><span class='hs-conid'>GLOBAL_VAR_M</span><span class='hs-layout'>(</span><span class='hs-varid'>v_PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-varid'>newMVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"Dynamic linker not initialised"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-conid'>GLOBAL_VAR</span><span class='hs-layout'>(</span><span class='hs-varid'>v_InitLinkerDone</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Set True when dynamic linker is initialised</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="modifyPLS_"></a><span class='hs-definition'>modifyPLS_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PersistentLinkerState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-5"></a><span class='hs-definition'>modifyPLS_</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_PersistentLinkerState</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>modifyMVar_</span> <span class='hs-varid'>f</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="modifyPLS"></a><span class='hs-definition'>modifyPLS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>PersistentLinkerState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-8"></a><span class='hs-definition'>modifyPLS</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_PersistentLinkerState</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>modifyMVar</span> <span class='hs-varid'>f</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="PersistentLinkerState"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-11"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PersistentLinkerState</span> <span class='hs-layout'>{</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-comment'>-- Current global mapping from Names to their true values</span>
<a name="line-14"></a>        <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureEnv</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>        <span class='hs-comment'>-- The current global mapping from RdrNames of DataCons to</span>
<a name="line-17"></a>        <span class='hs-comment'>-- info table addresses.</span>
<a name="line-18"></a>        <span class='hs-comment'>-- When a new Unlinked is linked into the running image, or an existing</span>
<a name="line-19"></a>        <span class='hs-comment'>-- module in the image is replaced, the itbl_env must be updated</span>
<a name="line-20"></a>        <span class='hs-comment'>-- appropriately.</span>
<a name="line-21"></a>        <span class='hs-varid'>itbl_env</span>    <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>ItblEnv</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- The currently loaded interpreted modules (home package)</span>
<a name="line-24"></a>        <span class='hs-varid'>bcos_loaded</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- And the currently-loaded compiled modules (home package)</span>
<a name="line-27"></a>        <span class='hs-varid'>objs_loaded</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- The currently-loaded packages; always object code</span>
<a name="line-30"></a>        <span class='hs-comment'>-- Held, as usual, in dependency order; though I am not sure if</span>
<a name="line-31"></a>        <span class='hs-comment'>-- that is really important</span>
<a name="line-32"></a>        <span class='hs-varid'>pkgs_loaded</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span>
<a name="line-33"></a>     <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="emptyPLS"></a><span class='hs-definition'>emptyPLS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-36"></a><span class='hs-definition'>emptyPLS</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PersistentLinkerState</span> <span class='hs-layout'>{</span>
<a name="line-37"></a>                        <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameEnv</span><span class='hs-layout'>,</span>
<a name="line-38"></a>                        <span class='hs-varid'>itbl_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameEnv</span><span class='hs-layout'>,</span>
<a name="line-39"></a>                        <span class='hs-varid'>pkgs_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>init_pkgs</span><span class='hs-layout'>,</span>
<a name="line-40"></a>                        <span class='hs-varid'>bcos_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-41"></a>                        <span class='hs-varid'>objs_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a>  <span class='hs-comment'>-- Packages that don't need loading, because the compiler</span>
<a name="line-44"></a>  <span class='hs-comment'>-- shares them with the interpreted program.</span>
<a name="line-45"></a>  <span class='hs-comment'>--</span>
<a name="line-46"></a>  <span class='hs-comment'>-- The linker's symbol table is populated with RTS symbols using an</span>
<a name="line-47"></a>  <span class='hs-comment'>-- explicit list.  See rts/Linker.c for details.</span>
<a name="line-48"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>init_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rtsPackageId</span><span class='hs-keyglyph'>]</span>
<a name="line-49"></a>
<a name="line-50"></a>
<a name="line-51"></a><a name="extendLoadedPkgs"></a><span class='hs-definition'>extendLoadedPkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-52"></a><span class='hs-definition'>extendLoadedPkgs</span> <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>=</span>
<a name="line-53"></a>  <span class='hs-varid'>modifyPLS_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-54"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>s</span><span class='hs-layout'>{</span> <span class='hs-varid'>pkgs_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pkgs_loaded</span> <span class='hs-varid'>s</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="extendLinkEnv"></a><span class='hs-definition'>extendLinkEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>HValue</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-57"></a><span class='hs-comment'>-- Automatically discards shadowed bindings</span>
<a name="line-58"></a><span class='hs-definition'>extendLinkEnv</span> <span class='hs-varid'>new_bindings</span> <span class='hs-keyglyph'>=</span>
<a name="line-59"></a>  <span class='hs-varid'>modifyPLS_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-60"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>new_closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendClosureEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_bindings</span>
<a name="line-61"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pls</span><span class='hs-layout'>{</span> <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_closure_env</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="deleteFromLinkEnv"></a><span class='hs-definition'>deleteFromLinkEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-64"></a><span class='hs-definition'>deleteFromLinkEnv</span> <span class='hs-varid'>to_remove</span> <span class='hs-keyglyph'>=</span>
<a name="line-65"></a>  <span class='hs-varid'>modifyPLS_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-66"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>new_closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delListFromNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>to_remove</span>
<a name="line-67"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pls</span><span class='hs-layout'>{</span> <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_closure_env</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="getHValue"></a><span class='hs-comment'>-- | Get the 'HValue' associated with the given name.</span>
<a name="line-70"></a><span class='hs-comment'>--</span>
<a name="line-71"></a><span class='hs-comment'>-- May cause loading the module that contains the name.</span>
<a name="line-72"></a><span class='hs-comment'>--</span>
<a name="line-73"></a><span class='hs-comment'>-- Throws a 'ProgramError' if loading fails or the name cannot be found.</span>
<a name="line-74"></a><span class='hs-definition'>getHValue</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HValue</span>
<a name="line-75"></a><span class='hs-definition'>getHValue</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-76"></a>  <span class='hs-varid'>initDynLinker</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-77"></a>  <span class='hs-varid'>pls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modifyPLS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-78"></a>           <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-79"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>pls'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkDependencies</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span>
<a name="line-80"></a>             <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>failed</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-81"></a>                            <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pls'</span><span class='hs-layout'>)</span>
<a name="line-82"></a>            <span class='hs-keyword'>else</span>
<a name="line-83"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls</span><span class='hs-layout'>,</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span>
<a name="line-84"></a>  <span class='hs-varid'>lookupName</span> <span class='hs-layout'>(</span><span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="linkDependencies"></a><span class='hs-definition'>linkDependencies</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-87"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>
<a name="line-88"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-definition'>linkDependencies</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>span</span> <span class='hs-varid'>needed_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-90"></a><span class='hs-comment'>--   initDynLinker (hsc_dflags hsc_env)</span>
<a name="line-91"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>hpt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span>
<a name="line-92"></a>       <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-93"></a>   <span class='hs-comment'>-- The interpreter and dynamic linker can only handle object code built</span>
<a name="line-94"></a>   <span class='hs-comment'>-- the "normal" way, i.e. no non-std ways like profiling or ticky-ticky.</span>
<a name="line-95"></a>   <span class='hs-comment'>-- So here we check the build tag: if we're building a non-standard way</span>
<a name="line-96"></a>   <span class='hs-comment'>-- then we need to find &amp; link object files built the "normal" way.</span>
<a name="line-97"></a>   <span class='hs-varid'>maybe_normal_osuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNonStdWay</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span>
<a name="line-98"></a>
<a name="line-99"></a>   <span class='hs-comment'>-- Find what packages and linkables are required</span>
<a name="line-100"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>lnks</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLinkDeps</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>pls</span>
<a name="line-101"></a>                               <span class='hs-varid'>maybe_normal_osuf</span> <span class='hs-varid'>span</span> <span class='hs-varid'>needed_mods</span>
<a name="line-102"></a>
<a name="line-103"></a>   <span class='hs-comment'>-- Link the packages and modules required</span>
<a name="line-104"></a>   <span class='hs-varid'>pls1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkPackages'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pkgs</span> <span class='hs-varid'>pls</span>
<a name="line-105"></a>   <span class='hs-varid'>linkModules</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pls1</span> <span class='hs-varid'>lnks</span>
<a name="line-106"></a>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-comment'>-- | Temporarily extend the linker state.</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="withExtendedLinkEnv"></a><span class='hs-definition'>withExtendedLinkEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExceptionMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-111"></a>                       <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>HValue</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-112"></a><span class='hs-definition'>withExtendedLinkEnv</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>action</span>
<a name="line-113"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbracket</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendLinkEnv</span> <span class='hs-varid'>new_env</span><span class='hs-layout'>)</span>
<a name="line-114"></a>               <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>reset_old_env</span><span class='hs-layout'>)</span>
<a name="line-115"></a>               <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>action</span><span class='hs-layout'>)</span>
<a name="line-116"></a>    <span class='hs-keyword'>where</span>
<a name="line-117"></a>        <span class='hs-comment'>-- Remember that the linker state might be side-effected</span>
<a name="line-118"></a>        <span class='hs-comment'>-- during the execution of the IO action, and we don't want to</span>
<a name="line-119"></a>        <span class='hs-comment'>-- lose those changes (we might have linked a new module or</span>
<a name="line-120"></a>        <span class='hs-comment'>-- package), so the reset action only removes the names we</span>
<a name="line-121"></a>        <span class='hs-comment'>-- added earlier.</span>
<a name="line-122"></a>          <span class='hs-varid'>reset_old_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-123"></a>            <span class='hs-varid'>modifyPLS_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-124"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>cur</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span>
<a name="line-125"></a>                    <span class='hs-varid'>new</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delListFromNameEnv</span> <span class='hs-varid'>cur</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>new_env</span><span class='hs-layout'>)</span>
<a name="line-126"></a>                <span class='hs-keyword'>in</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pls</span><span class='hs-layout'>{</span> <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new</span> <span class='hs-layout'>}</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-comment'>-- filterNameMap removes from the environment all entries except</span>
<a name="line-129"></a><span class='hs-comment'>-- those for a given set of modules;</span>
<a name="line-130"></a><span class='hs-comment'>-- Note that this removes all *local* (i.e. non-isExternal) names too</span>
<a name="line-131"></a><span class='hs-comment'>-- (these are the temporary bindings from the command line).</span>
<a name="line-132"></a><span class='hs-comment'>-- Used to filter both the ClosureEnv and ItblEnv</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="filterNameMap"></a><span class='hs-definition'>filterNameMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-135"></a><span class='hs-definition'>filterNameMap</span> <span class='hs-varid'>mods</span> <span class='hs-varid'>env</span>
<a name="line-136"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameEnv</span> <span class='hs-varid'>keep_elt</span> <span class='hs-varid'>env</span>
<a name="line-137"></a>   <span class='hs-keyword'>where</span>
<a name="line-138"></a>     <span class='hs-varid'>keep_elt</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>n</span>
<a name="line-139"></a>                      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span>
<a name="line-140"></a>
<a name="line-141"></a>
<a name="line-142"></a><a name="showLinkerState"></a><span class='hs-comment'>-- | Display the persistent linker state.</span>
<a name="line-143"></a><span class='hs-definition'>showLinkerState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-144"></a><span class='hs-definition'>showLinkerState</span> <span class='hs-varid'>dflags</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>pls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_PersistentLinkerState</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>readMVar</span>
<a name="line-146"></a>       <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>SevDump</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultDumpStyle</span>
<a name="line-147"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"----- Linker state -----"</span><span class='hs-layout'>,</span>
<a name="line-148"></a>                        <span class='hs-varid'>text</span> <span class='hs-str'>"Pkgs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgs_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-149"></a>                        <span class='hs-varid'>text</span> <span class='hs-str'>"Objs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>objs_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-150"></a>                        <span class='hs-varid'>text</span> <span class='hs-str'>"BCOs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bcos_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Initialisation}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="initDynLinker"></a><span class='hs-comment'>-- | Initialise the dynamic linker.  This entails</span>
<a name="line-2"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><span class='hs-comment'>--  a) Calling the C initialisation procedure,</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>--  b) Loading any packages specified on the command line,</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>--  c) Loading any packages specified on the command line, now held in the</span>
<a name="line-8"></a><span class='hs-comment'>--     @-l@ options in @v_Opt_l@,</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>--  d) Loading any @.o\/.dll@ files specified on the command line, now held</span>
<a name="line-11"></a><span class='hs-comment'>--     in @ldInputs@,</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>--  e) Loading any MacOS frameworks.</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><span class='hs-comment'>-- NOTE: This function is idempotent; if called more than once, it does</span>
<a name="line-16"></a><span class='hs-comment'>-- nothing.  This is useful in Template Haskell, where we call it before</span>
<a name="line-17"></a><span class='hs-comment'>-- trying to link.</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-definition'>initDynLinker</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-20"></a><span class='hs-definition'>initDynLinker</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-21"></a>  <span class='hs-varid'>modifyPLS_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-22"></a>    <span class='hs-varid'>done</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_InitLinkerDone</span>
<a name="line-23"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>done</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pls0</span>
<a name="line-24"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_InitLinkerDone</span> <span class='hs-conid'>True</span>
<a name="line-25"></a>                    <span class='hs-varid'>reallyInitDynLinker</span> <span class='hs-varid'>dflags</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="reallyInitDynLinker"></a><span class='hs-definition'>reallyInitDynLinker</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-28"></a><span class='hs-definition'>reallyInitDynLinker</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-29"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Initialise the linker state</span>
<a name="line-30"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>pls0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyPLS</span> <span class='hs-varid'>dflags</span>
<a name="line-31"></a>
<a name="line-32"></a>          <span class='hs-comment'>-- (a) initialise the C dynamic linker</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>initObjLinker</span>
<a name="line-34"></a>
<a name="line-35"></a>          <span class='hs-comment'>-- (b) Load packages from the command-line (Note [preload packages])</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>pls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkPackages'</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>preloadPackages</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgState</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>pls0</span>
<a name="line-37"></a>
<a name="line-38"></a>          <span class='hs-comment'>-- (c) Link libraries from the command-line</span>
<a name="line-39"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cmdline_ld_inputs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldInputs</span> <span class='hs-varid'>dflags</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>minus_ls</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>lib</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-chr'>'-'</span><span class='hs-conop'>:</span><span class='hs-chr'>'l'</span><span class='hs-conop'>:</span><span class='hs-varid'>lib</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cmdline_ld_inputs</span> <span class='hs-keyglyph'>]</span>
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lib_paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libraryPaths</span> <span class='hs-varid'>dflags</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>libspecs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>locateLib</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-varid'>lib_paths</span><span class='hs-layout'>)</span> <span class='hs-varid'>minus_ls</span>
<a name="line-43"></a>
<a name="line-44"></a>          <span class='hs-comment'>-- (d) Link .o files from the command-line</span>
<a name="line-45"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>classified_ld_inputs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyLdInput</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-46"></a>                                    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FileOption</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cmdline_ld_inputs</span> <span class='hs-keyglyph'>]</span>
<a name="line-47"></a>
<a name="line-48"></a>          <span class='hs-comment'>-- (e) Link any MacOS frameworks</span>
<a name="line-49"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-50"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>framework_paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>platformUsesFrameworks</span> <span class='hs-varid'>platform</span>
<a name="line-51"></a>                                <span class='hs-keyword'>then</span> <span class='hs-varid'>frameworkPaths</span> <span class='hs-varid'>dflags</span>
<a name="line-52"></a>                                <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-53"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>frameworks</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>platformUsesFrameworks</span> <span class='hs-varid'>platform</span>
<a name="line-54"></a>                           <span class='hs-keyword'>then</span> <span class='hs-varid'>cmdlineFrameworks</span> <span class='hs-varid'>dflags</span>
<a name="line-55"></a>                           <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-56"></a>          <span class='hs-comment'>-- Finally do (c),(d),(e)</span>
<a name="line-57"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cmdline_lib_specs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classified_ld_inputs</span> <span class='hs-keyglyph'>]</span>
<a name="line-58"></a>                               <span class='hs-varop'>++</span> <span class='hs-varid'>libspecs</span>
<a name="line-59"></a>                               <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Framework</span> <span class='hs-varid'>frameworks</span>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cmdline_lib_specs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pls</span>
<a name="line-61"></a>                                    <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-62"></a>
<a name="line-63"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>preloadLib</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>lib_paths</span> <span class='hs-varid'>framework_paths</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmdline_lib_specs</span>
<a name="line-64"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>maybePutStr</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"final link ... "</span>
<a name="line-65"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resolveObjs</span>
<a name="line-66"></a>
<a name="line-67"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>succeeded</span> <span class='hs-varid'>ok</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"done"</span>
<a name="line-68"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"linking extra libraries/objects failed"</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pls</span>
<a name="line-71"></a>        <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-72"></a>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-comment'>{- Note [preload packages]
<a name="line-75"></a>
<a name="line-76"></a>Why do we need to preload packages from the command line?  This is an
<a name="line-77"></a>explanation copied from #2437:
<a name="line-78"></a>
<a name="line-79"></a>I tried to implement the suggestion from #3560, thinking it would be
<a name="line-80"></a>easy, but there are two reasons we link in packages eagerly when they
<a name="line-81"></a>are mentioned on the command line:
<a name="line-82"></a>
<a name="line-83"></a>  * So that you can link in extra object files or libraries that
<a name="line-84"></a>    depend on the packages. e.g. ghc -package foo -lbar where bar is a
<a name="line-85"></a>    C library that depends on something in foo. So we could link in
<a name="line-86"></a>    foo eagerly if and only if there are extra C libs or objects to
<a name="line-87"></a>    link in, but....
<a name="line-88"></a>
<a name="line-89"></a>  * Haskell code can depend on a C function exported by a package, and
<a name="line-90"></a>    the normal dependency tracking that TH uses can't know about these
<a name="line-91"></a>    dependencies. The test ghcilink004 relies on this, for example.
<a name="line-92"></a>
<a name="line-93"></a>I conclude that we need two -package flags: one that says "this is a
<a name="line-94"></a>package I want to make available", and one that says "this is a
<a name="line-95"></a>package I want to link in eagerly". Would that be too complicated for
<a name="line-96"></a>users?
<a name="line-97"></a>-}</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="classifyLdInput"></a><span class='hs-definition'>classifyLdInput</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>LibrarySpec</span><span class='hs-layout'>)</span>
<a name="line-100"></a><span class='hs-definition'>classifyLdInput</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>f</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isObjectFilename</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Object</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDynLibFilename</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLLPath</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-104"></a>        <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>SevInfo</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultUserStyle</span>
<a name="line-105"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Warning: ignoring unrecognised input `"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>f</span> <span class='hs-varop'>++</span> <span class='hs-str'>"'"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-106"></a>        <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-107"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="preloadLib"></a><span class='hs-definition'>preloadLib</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LibrarySpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-110"></a><span class='hs-definition'>preloadLib</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>lib_paths</span> <span class='hs-varid'>framework_paths</span> <span class='hs-varid'>lib_spec</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>maybePutStr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-str'>"Loading object "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showLS</span> <span class='hs-varid'>lib_spec</span> <span class='hs-varop'>++</span> <span class='hs-str'>" ... "</span><span class='hs-layout'>)</span>
<a name="line-112"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>lib_spec</span> <span class='hs-keyword'>of</span>
<a name="line-113"></a>          <span class='hs-conid'>Object</span> <span class='hs-varid'>static_ish</span>
<a name="line-114"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>preload_static</span> <span class='hs-varid'>lib_paths</span> <span class='hs-varid'>static_ish</span>
<a name="line-115"></a>                   <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>b</span>  <span class='hs-keyword'>then</span> <span class='hs-str'>"done"</span>
<a name="line-116"></a>                                                <span class='hs-keyword'>else</span> <span class='hs-str'>"not found"</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>          <span class='hs-conid'>Archive</span> <span class='hs-varid'>static_ish</span>
<a name="line-119"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>preload_static_archive</span> <span class='hs-varid'>lib_paths</span> <span class='hs-varid'>static_ish</span>
<a name="line-120"></a>                   <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>b</span>  <span class='hs-keyword'>then</span> <span class='hs-str'>"done"</span>
<a name="line-121"></a>                                                <span class='hs-keyword'>else</span> <span class='hs-str'>"not found"</span><span class='hs-layout'>)</span>
<a name="line-122"></a>
<a name="line-123"></a>          <span class='hs-conid'>DLL</span> <span class='hs-varid'>dll_unadorned</span>
<a name="line-124"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>maybe_errstr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadDLL</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSOName</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>dll_unadorned</span><span class='hs-layout'>)</span>
<a name="line-125"></a>                   <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_errstr</span> <span class='hs-keyword'>of</span>
<a name="line-126"></a>                      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"done"</span>
<a name="line-127"></a>                      <span class='hs-conid'>Just</span> <span class='hs-varid'>mm</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>OSDarwin</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-128"></a>                        <span class='hs-varid'>preloadFailed</span> <span class='hs-varid'>mm</span> <span class='hs-varid'>lib_paths</span> <span class='hs-varid'>lib_spec</span>
<a name="line-129"></a>                      <span class='hs-conid'>Just</span> <span class='hs-varid'>mm</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-130"></a>                        <span class='hs-comment'>-- As a backup, on Darwin, try to also load a .so file</span>
<a name="line-131"></a>                        <span class='hs-comment'>-- since (apparently) some things install that way - see</span>
<a name="line-132"></a>                        <span class='hs-comment'>-- ticket #8770.</span>
<a name="line-133"></a>                        <span class='hs-varid'>err2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadDLL</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-str'>"lib"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dll_unadorned</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"so"</span>
<a name="line-134"></a>                        <span class='hs-keyword'>case</span> <span class='hs-varid'>err2</span> <span class='hs-keyword'>of</span>
<a name="line-135"></a>                          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"done"</span>
<a name="line-136"></a>                          <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>preloadFailed</span> <span class='hs-varid'>mm</span> <span class='hs-varid'>lib_paths</span> <span class='hs-varid'>lib_spec</span>
<a name="line-137"></a>
<a name="line-138"></a>          <span class='hs-conid'>DLLPath</span> <span class='hs-varid'>dll_path</span>
<a name="line-139"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>maybe_errstr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadDLL</span> <span class='hs-varid'>dll_path</span>
<a name="line-140"></a>                   <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_errstr</span> <span class='hs-keyword'>of</span>
<a name="line-141"></a>                      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"done"</span>
<a name="line-142"></a>                      <span class='hs-conid'>Just</span> <span class='hs-varid'>mm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>preloadFailed</span> <span class='hs-varid'>mm</span> <span class='hs-varid'>lib_paths</span> <span class='hs-varid'>lib_spec</span>
<a name="line-143"></a>
<a name="line-144"></a>          <span class='hs-conid'>Framework</span> <span class='hs-varid'>framework</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-145"></a>              <span class='hs-keyword'>if</span> <span class='hs-varid'>platformUsesFrameworks</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-146"></a>              <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>maybe_errstr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadFramework</span> <span class='hs-varid'>framework_paths</span> <span class='hs-varid'>framework</span>
<a name="line-147"></a>                      <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_errstr</span> <span class='hs-keyword'>of</span>
<a name="line-148"></a>                         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"done"</span>
<a name="line-149"></a>                         <span class='hs-conid'>Just</span> <span class='hs-varid'>mm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>preloadFailed</span> <span class='hs-varid'>mm</span> <span class='hs-varid'>framework_paths</span> <span class='hs-varid'>lib_spec</span>
<a name="line-150"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"preloadLib Framework"</span>
<a name="line-151"></a>
<a name="line-152"></a>  <span class='hs-keyword'>where</span>
<a name="line-153"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-154"></a>
<a name="line-155"></a>    <span class='hs-varid'>preloadFailed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LibrarySpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-156"></a>    <span class='hs-varid'>preloadFailed</span> <span class='hs-varid'>sys_errmsg</span> <span class='hs-varid'>paths</span> <span class='hs-varid'>spec</span>
<a name="line-157"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>maybePutStr</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"failed.\n"</span>
<a name="line-158"></a>            <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-varop'>$</span>
<a name="line-159"></a>              <span class='hs-conid'>CmdLineError</span> <span class='hs-layout'>(</span>
<a name="line-160"></a>                    <span class='hs-str'>"user specified .o/.so/.DLL could not be loaded ("</span>
<a name="line-161"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>sys_errmsg</span> <span class='hs-varop'>++</span> <span class='hs-str'>")\nWhilst trying to load:  "</span>
<a name="line-162"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>showLS</span> <span class='hs-varid'>spec</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\nAdditional directories searched:"</span>
<a name="line-163"></a>                    <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>paths</span> <span class='hs-keyword'>then</span> <span class='hs-str'>" (none)"</span> <span class='hs-keyword'>else</span>
<a name="line-164"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersperse</span> <span class='hs-str'>"\n"</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>"   "</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>paths</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-165"></a>
<a name="line-166"></a>    <span class='hs-comment'>-- Not interested in the paths in the static case.</span>
<a name="line-167"></a>    <span class='hs-varid'>preload_static</span> <span class='hs-sel'>_paths</span> <span class='hs-varid'>name</span>
<a name="line-168"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>name</span>
<a name="line-169"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-170"></a>                     <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>dynamicGhc</span>
<a name="line-171"></a>                                 <span class='hs-keyword'>then</span> <span class='hs-varid'>dynLoadObjs</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span>
<a name="line-172"></a>                                 <span class='hs-keyword'>else</span> <span class='hs-varid'>loadObj</span> <span class='hs-varid'>name</span>
<a name="line-173"></a>                             <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-174"></a>    <span class='hs-varid'>preload_static_archive</span> <span class='hs-sel'>_paths</span> <span class='hs-varid'>name</span>
<a name="line-175"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>name</span>
<a name="line-176"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-177"></a>                     <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>dynamicGhc</span>
<a name="line-178"></a>                                 <span class='hs-keyword'>then</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Loading archives not supported"</span>
<a name="line-179"></a>                                 <span class='hs-keyword'>else</span> <span class='hs-varid'>loadArchive</span> <span class='hs-varid'>name</span>
<a name="line-180"></a>                             <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Link a byte-code expression
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="linkExpr"></a><span class='hs-comment'>-- | Link a single expression, /including/ first linking packages and</span>
<a name="line-2"></a><span class='hs-comment'>-- modules that this expression depends on.</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- Raises an IO exception ('ProgramError') if it can't find a compiled</span>
<a name="line-5"></a><span class='hs-comment'>-- version of the dependents to link.</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-definition'>linkExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnlinkedBCO</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HValue</span>
<a name="line-8"></a><span class='hs-definition'>linkExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>span</span> <span class='hs-varid'>root_ul_bco</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-10"></a>     <span class='hs-comment'>-- Initialise the linker (if it's not been done already)</span>
<a name="line-11"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-12"></a>   <span class='hs-layout'>;</span> <span class='hs-varid'>initDynLinker</span> <span class='hs-varid'>dflags</span>
<a name="line-13"></a>
<a name="line-14"></a>     <span class='hs-comment'>-- Take lock for the actual work.</span>
<a name="line-15"></a>   <span class='hs-layout'>;</span> <span class='hs-varid'>modifyPLS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-16"></a>
<a name="line-17"></a>     <span class='hs-comment'>-- Link the packages and modules required</span>
<a name="line-18"></a>   <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls</span><span class='hs-layout'>,</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkDependencies</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pls0</span> <span class='hs-varid'>span</span> <span class='hs-varid'>needed_mods</span>
<a name="line-19"></a>   <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>failed</span> <span class='hs-varid'>ok</span> <span class='hs-keyword'>then</span>
<a name="line-20"></a>        <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-21"></a>     <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-22"></a>
<a name="line-23"></a>     <span class='hs-comment'>-- Link the expression itself</span>
<a name="line-24"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>ie</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>itbl_env</span> <span class='hs-varid'>pls</span>
<a name="line-25"></a>         <span class='hs-varid'>ce</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span>
<a name="line-26"></a>
<a name="line-27"></a>     <span class='hs-comment'>-- Link the necessary packages and linkables</span>
<a name="line-28"></a>   <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>root_hval</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkSomeBCOs</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>ce</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>root_ul_bco</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls</span><span class='hs-layout'>,</span> <span class='hs-varid'>root_hval</span><span class='hs-layout'>)</span>
<a name="line-30"></a>   <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-31"></a>   <span class='hs-keyword'>where</span>
<a name="line-32"></a>     <span class='hs-varid'>free_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>bcoFreeNames</span> <span class='hs-varid'>root_ul_bco</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a>     <span class='hs-varid'>needed_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>
<a name="line-35"></a>     <span class='hs-varid'>needed_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>free_names</span><span class='hs-layout'>,</span>
<a name="line-36"></a>                     <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Names from other modules</span>
<a name="line-37"></a>                     <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Exclude wired-in names</span>
<a name="line-38"></a>                   <span class='hs-keyglyph'>]</span>                        <span class='hs-comment'>-- (see note below)</span>
<a name="line-39"></a>        <span class='hs-comment'>-- Exclude wired-in names because we may not have read</span>
<a name="line-40"></a>        <span class='hs-comment'>-- their interface files, so getLinkDeps will fail</span>
<a name="line-41"></a>        <span class='hs-comment'>-- All wired-in names are in the base package, which we link</span>
<a name="line-42"></a>        <span class='hs-comment'>-- by default, so we can safely ignore them here.</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="dieWith"></a><span class='hs-definition'>dieWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-45"></a><span class='hs-definition'>dieWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocMessage</span> <span class='hs-conid'>SevFatal</span> <span class='hs-varid'>span</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>
<a name="line-48"></a><a name="checkNonStdWay"></a><span class='hs-definition'>checkNonStdWay</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>checkNonStdWay</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>srcspan</span> <span class='hs-keyglyph'>=</span>
<a name="line-50"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>interpWays</span> <span class='hs-varop'>==</span> <span class='hs-varid'>haskellWays</span>
<a name="line-51"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-52"></a>    <span class='hs-comment'>-- see #3604: object files compiled for way "dyn" need to link to the</span>
<a name="line-53"></a>    <span class='hs-comment'>-- dynamic packages, so we can't load them into a statically-linked GHCi.</span>
<a name="line-54"></a>    <span class='hs-comment'>-- we have to treat "dyn" in the same way as "prof".</span>
<a name="line-55"></a>    <span class='hs-comment'>--</span>
<a name="line-56"></a>    <span class='hs-comment'>-- In the future when GHCi is dynamically linked we should be able to relax</span>
<a name="line-57"></a>    <span class='hs-comment'>-- this, but they we may have to make it possible to load either ordinary</span>
<a name="line-58"></a>    <span class='hs-comment'>-- .o files or -dynamic .o files into GHCi (currently that's not possible</span>
<a name="line-59"></a>    <span class='hs-comment'>-- because the dynamic objects contain refs to e.g. __stginit_base_Prelude_dyn</span>
<a name="line-60"></a>    <span class='hs-comment'>-- whereas we have __stginit_base_Prelude_.</span>
<a name="line-61"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>objectSuf</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>normalObjectSuffix</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>haskellWays</span><span class='hs-layout'>)</span>
<a name="line-62"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>failNonStd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>srcspan</span>
<a name="line-63"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>dynamicGhc</span>
<a name="line-64"></a>                           <span class='hs-keyword'>then</span> <span class='hs-str'>"dyn_o"</span>
<a name="line-65"></a>                           <span class='hs-keyword'>else</span> <span class='hs-str'>"o"</span>
<a name="line-66"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>haskellWays</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>wayRTSOnly</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ways</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="normalObjectSuffix"></a><span class='hs-definition'>normalObjectSuffix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>
<a name="line-69"></a><span class='hs-definition'>normalObjectSuffix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>phaseInputExt</span> <span class='hs-conid'>StopLn</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="failNonStd"></a><span class='hs-definition'>failNonStd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-definition'>failNonStd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>srcspan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dieWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>srcspan</span> <span class='hs-varop'>$</span>
<a name="line-73"></a>  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Dynamic linking required, but this is a non-standard build (eg. prof)."</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-74"></a>  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"You need to build the program twice: once the"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ghciWay</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"way, and then"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-75"></a>  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the desired way using -osuf to set the object file suffix."</span><span class='hs-layout'>)</span>
<a name="line-76"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>ghciWay</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>dynamicGhc</span>
<a name="line-77"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"dynamic"</span><span class='hs-layout'>)</span>
<a name="line-78"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"normal"</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="getLinkDeps"></a><span class='hs-definition'>getLinkDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomePackageTable</span>
<a name="line-81"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-82"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>                   <span class='hs-comment'>-- replace object suffices?</span>
<a name="line-83"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>                          <span class='hs-comment'>-- for error messages</span>
<a name="line-84"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>                         <span class='hs-comment'>-- If you need these</span>
<a name="line-85"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- ... then link these first</span>
<a name="line-86"></a><span class='hs-comment'>-- Fails with an IO exception if it can't find enough files</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-definition'>getLinkDeps</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>replace_osuf</span> <span class='hs-varid'>span</span> <span class='hs-varid'>mods</span>
<a name="line-89"></a><span class='hs-comment'>-- Find all the packages and linkables that a set of modules depends on</span>
<a name="line-90"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-91"></a>        <span class='hs-comment'>-- 1.  Find the dependent home-pkg-modules/packages from each iface</span>
<a name="line-92"></a>        <span class='hs-comment'>-- (omitting modules from the interactive package, which is already linked)</span>
<a name="line-93"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mods_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs_s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>follow_deps</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOut</span> <span class='hs-varid'>isInteractiveModule</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span>
<a name="line-94"></a>                                        <span class='hs-varid'>emptyUniqSet</span> <span class='hs-varid'>emptyUniqSet</span><span class='hs-layout'>;</span>
<a name="line-95"></a>
<a name="line-96"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span>
<a name="line-97"></a>        <span class='hs-comment'>-- 2.  Exclude ones already linked</span>
<a name="line-98"></a>        <span class='hs-comment'>--      Main reason: avoid findModule calls in get_linkable</span>
<a name="line-99"></a>            <span class='hs-varid'>mods_needed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods_s</span> <span class='hs-varop'>`minusList`</span> <span class='hs-varid'>linked_mods</span>     <span class='hs-layout'>;</span>
<a name="line-100"></a>            <span class='hs-varid'>pkgs_needed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgs_s</span> <span class='hs-varop'>`minusList`</span> <span class='hs-varid'>pkgs_loaded</span> <span class='hs-varid'>pls</span> <span class='hs-layout'>;</span>
<a name="line-101"></a>
<a name="line-102"></a>            <span class='hs-varid'>linked_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span><span class='hs-varop'>.</span><span class='hs-varid'>linkableModule</span><span class='hs-layout'>)</span>
<a name="line-103"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>objs_loaded</span> <span class='hs-varid'>pls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bcos_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span>  <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a>        <span class='hs-comment'>-- 3.  For each dependent module, find its linkable</span>
<a name="line-106"></a>        <span class='hs-comment'>--     This will either be in the HPT or (in the case of one-shot</span>
<a name="line-107"></a>        <span class='hs-comment'>--     compilation) we may need to use maybe_getFileLinkable</span>
<a name="line-108"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>osuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>objectSuf</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>lnks_needed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_linkable</span> <span class='hs-varid'>osuf</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods_needed</span>
<a name="line-110"></a>
<a name="line-111"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lnks_needed</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs_needed</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-112"></a>  <span class='hs-keyword'>where</span>
<a name="line-113"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-114"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-115"></a>
<a name="line-116"></a>        <span class='hs-comment'>-- The ModIface contains the transitive closure of the module dependencies</span>
<a name="line-117"></a>        <span class='hs-comment'>-- within the current package, *except* for boot modules: if we encounter</span>
<a name="line-118"></a>        <span class='hs-comment'>-- a boot module, we have to find its real interface and discover the</span>
<a name="line-119"></a>        <span class='hs-comment'>-- dependencies of that.  Hence we need to traverse the dependency</span>
<a name="line-120"></a>        <span class='hs-comment'>-- tree recursively.  See bug #936, testcase ghci/prog007.</span>
<a name="line-121"></a>    <span class='hs-varid'>follow_deps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- modules to follow</span>
<a name="line-122"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>ModuleName</span>         <span class='hs-comment'>-- accum. module dependencies</span>
<a name="line-123"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>PackageId</span>          <span class='hs-comment'>-- accum. package dependencies</span>
<a name="line-124"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- result</span>
<a name="line-125"></a>    <span class='hs-varid'>follow_deps</span> <span class='hs-conid'>[]</span>     <span class='hs-varid'>acc_mods</span> <span class='hs-varid'>acc_pkgs</span>
<a name="line-126"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqSetToList</span> <span class='hs-varid'>acc_mods</span><span class='hs-layout'>,</span> <span class='hs-varid'>uniqSetToList</span> <span class='hs-varid'>acc_pkgs</span><span class='hs-layout'>)</span>
<a name="line-127"></a>    <span class='hs-varid'>follow_deps</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-conop'>:</span><span class='hs-varid'>mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc_mods</span> <span class='hs-varid'>acc_pkgs</span>
<a name="line-128"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-129"></a>          <span class='hs-varid'>mb_iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initIfaceCheck</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-130"></a>                        <span class='hs-varid'>loadInterface</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-131"></a>          <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_iface</span> <span class='hs-keyword'>of</span>
<a name="line-132"></a>                    <span class='hs-conid'>Maybes</span><span class='hs-varop'>.</span><span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-133"></a>                    <span class='hs-conid'>Maybes</span><span class='hs-varop'>.</span><span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>iface</span>
<a name="line-134"></a>
<a name="line-135"></a>          <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>link_boot_mod_error</span> <span class='hs-varid'>mod</span>
<a name="line-136"></a>
<a name="line-137"></a>          <span class='hs-keyword'>let</span>
<a name="line-138"></a>            <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span>
<a name="line-139"></a>            <span class='hs-varid'>deps</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface</span>
<a name="line-140"></a>
<a name="line-141"></a>            <span class='hs-varid'>pkg_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-varid'>deps</span>
<a name="line-142"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>boot_deps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_deps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>is_boot</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_mods</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span>
<a name="line-143"></a>                    <span class='hs-keyword'>where</span> <span class='hs-varid'>is_boot</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>m</span>
<a name="line-144"></a>                          <span class='hs-varid'>is_boot</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>m</span>
<a name="line-145"></a>
<a name="line-146"></a>            <span class='hs-varid'>boot_deps'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>acc_mods</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>boot_deps</span>
<a name="line-147"></a>            <span class='hs-varid'>acc_mods'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addListToUniqSet</span> <span class='hs-varid'>acc_mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mod_deps</span><span class='hs-layout'>)</span>
<a name="line-148"></a>            <span class='hs-varid'>acc_pkgs'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addListToUniqSet</span> <span class='hs-varid'>acc_pkgs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pkg_deps</span>
<a name="line-149"></a>          <span class='hs-comment'>--</span>
<a name="line-150"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>this_pkg</span>
<a name="line-151"></a>             <span class='hs-keyword'>then</span> <span class='hs-varid'>follow_deps</span> <span class='hs-varid'>mods</span> <span class='hs-varid'>acc_mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>addOneToUniqSet</span> <span class='hs-varid'>acc_pkgs'</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-152"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>follow_deps</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModule</span> <span class='hs-varid'>this_pkg</span><span class='hs-layout'>)</span> <span class='hs-varid'>boot_deps'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span>
<a name="line-153"></a>                              <span class='hs-varid'>acc_mods'</span> <span class='hs-varid'>acc_pkgs'</span>
<a name="line-154"></a>        <span class='hs-keyword'>where</span>
<a name="line-155"></a>            <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"need to link module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-156"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"due to use of Template Haskell"</span>
<a name="line-157"></a>
<a name="line-158"></a>
<a name="line-159"></a>    <span class='hs-varid'>link_boot_mod_error</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span>
<a name="line-160"></a>        <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span>
<a name="line-161"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-162"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be linked; it is only available as a boot module"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-163"></a>
<a name="line-164"></a>    <span class='hs-varid'>no_obj</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>b</span>
<a name="line-165"></a>    <span class='hs-varid'>no_obj</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dieWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-166"></a>                     <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot find object file for module "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-167"></a>                        <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-168"></a>                     <span class='hs-varid'>while_linking_expr</span>
<a name="line-169"></a>
<a name="line-170"></a>    <span class='hs-varid'>while_linking_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"while linking an interpreted expression"</span><span class='hs-layout'>)</span>
<a name="line-171"></a>
<a name="line-172"></a>        <span class='hs-comment'>-- This one is a build-system bug</span>
<a name="line-173"></a>
<a name="line-174"></a>    <span class='hs-varid'>get_linkable</span> <span class='hs-varid'>osuf</span> <span class='hs-varid'>mod_name</span>      <span class='hs-comment'>-- A home-package module</span>
<a name="line-175"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>mod_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>mod_name</span>
<a name="line-176"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>adjust_linkable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybes</span><span class='hs-varop'>.</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"getLinkDeps"</span> <span class='hs-layout'>(</span><span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>mod_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-177"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-178"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>    <span class='hs-comment'>-- It's not in the HPT because we are in one shot mode,</span>
<a name="line-179"></a>                <span class='hs-comment'>-- so use the Finder to get a ModLocation...</span>
<a name="line-180"></a>             <span class='hs-varid'>mb_stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findHomeModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_name</span>
<a name="line-181"></a>             <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_stuff</span> <span class='hs-keyword'>of</span>
<a name="line-182"></a>                  <span class='hs-conid'>Found</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>found</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mod</span>
<a name="line-183"></a>                  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>no_obj</span> <span class='hs-varid'>mod_name</span>
<a name="line-184"></a>        <span class='hs-keyword'>where</span>
<a name="line-185"></a>            <span class='hs-varid'>found</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-186"></a>                <span class='hs-comment'>-- ...and then find the linkable for it</span>
<a name="line-187"></a>               <span class='hs-varid'>mb_lnk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findObjectLinkableMaybe</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>;</span>
<a name="line-188"></a>               <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_lnk</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-189"></a>                  <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>no_obj</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>;</span>
<a name="line-190"></a>                  <span class='hs-conid'>Just</span> <span class='hs-varid'>lnk</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>adjust_linkable</span> <span class='hs-varid'>lnk</span>
<a name="line-191"></a>              <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-192"></a>
<a name="line-193"></a>            <span class='hs-varid'>adjust_linkable</span> <span class='hs-varid'>lnk</span>
<a name="line-194"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>new_osuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replace_osuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-195"></a>                        <span class='hs-varid'>new_uls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>adjust_ul</span> <span class='hs-varid'>new_osuf</span><span class='hs-layout'>)</span>
<a name="line-196"></a>                                        <span class='hs-layout'>(</span><span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>lnk</span><span class='hs-layout'>)</span>
<a name="line-197"></a>                        <span class='hs-varid'>return</span> <span class='hs-varid'>lnk</span><span class='hs-layout'>{</span> <span class='hs-varid'>linkableUnlinked</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>new_uls</span> <span class='hs-layout'>}</span>
<a name="line-198"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-199"></a>                        <span class='hs-varid'>return</span> <span class='hs-varid'>lnk</span>
<a name="line-200"></a>
<a name="line-201"></a>            <span class='hs-varid'>adjust_ul</span> <span class='hs-varid'>new_osuf</span> <span class='hs-layout'>(</span><span class='hs-conid'>DotO</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-202"></a>                <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>osuf</span> <span class='hs-varop'>`isSuffixOf`</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-203"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>file_base</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropTail</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>osuf</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>file</span>
<a name="line-204"></a>                    <span class='hs-varid'>new_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>file_base</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>new_osuf</span>
<a name="line-205"></a>                <span class='hs-varid'>ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>new_file</span>
<a name="line-206"></a>                <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span>
<a name="line-207"></a>                   <span class='hs-keyword'>then</span> <span class='hs-varid'>dieWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-208"></a>                          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot find normal object file "</span><span class='hs-layout'>)</span>
<a name="line-209"></a>                                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>new_file</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>while_linking_expr</span>
<a name="line-210"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DotO</span> <span class='hs-varid'>new_file</span><span class='hs-layout'>)</span>
<a name="line-211"></a>            <span class='hs-varid'>adjust_ul</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DotA</span> <span class='hs-varid'>fp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"adjust_ul DotA "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>fp</span><span class='hs-layout'>)</span>
<a name="line-212"></a>            <span class='hs-varid'>adjust_ul</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DotDLL</span> <span class='hs-varid'>fp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"adjust_ul DotDLL "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>fp</span><span class='hs-layout'>)</span>
<a name="line-213"></a>            <span class='hs-varid'>adjust_ul</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BCOs</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>l</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
              Loading a Decls statement
%*                                                                      *
%************************************************************************
\begin{code}
<pre><a name="line-1"></a><a name="linkDecls"></a><span class='hs-definition'>linkDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CompiledByteCode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> <span class='hs-varop'>--[HValue]</span>
<a name="line-2"></a><span class='hs-definition'>linkDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteCode</span> <span class='hs-varid'>unlinkedBCOs</span> <span class='hs-varid'>itblEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>    <span class='hs-comment'>-- Initialise the linker (if it's not been done already)</span>
<a name="line-4"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-5"></a>    <span class='hs-varid'>initDynLinker</span> <span class='hs-varid'>dflags</span>
<a name="line-6"></a>
<a name="line-7"></a>    <span class='hs-comment'>-- Take lock for the actual work.</span>
<a name="line-8"></a>    <span class='hs-varid'>modifyPLS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-9"></a>
<a name="line-10"></a>    <span class='hs-comment'>-- Link the packages and modules required</span>
<a name="line-11"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>pls</span><span class='hs-layout'>,</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkDependencies</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pls0</span> <span class='hs-varid'>span</span> <span class='hs-varid'>needed_mods</span>
<a name="line-12"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>failed</span> <span class='hs-varid'>ok</span>
<a name="line-13"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-14"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-comment'>-- Link the expression itself</span>
<a name="line-17"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ie</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>itbl_env</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>itblEnv</span>
<a name="line-18"></a>        <span class='hs-varid'>ce</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-comment'>-- Link the necessary packages and linkables</span>
<a name="line-21"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>final_gce</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkSomeBCOs</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>ce</span> <span class='hs-varid'>unlinkedBCOs</span>
<a name="line-22"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pls2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pls</span> <span class='hs-layout'>{</span> <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_gce</span><span class='hs-layout'>,</span>
<a name="line-23"></a>                     <span class='hs-varid'>itbl_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ie</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls2</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>--hvals)</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>free_names</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSetToList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>bcoFreeNames</span><span class='hs-layout'>)</span> <span class='hs-varid'>unlinkedBCOs</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-varid'>needed_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>    <span class='hs-varid'>needed_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>free_names</span><span class='hs-layout'>,</span>
<a name="line-30"></a>                    <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Names from other modules</span>
<a name="line-31"></a>                    <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Exclude wired-in names</span>
<a name="line-32"></a>                  <span class='hs-keyglyph'>]</span>                         <span class='hs-comment'>-- (see note below)</span>
<a name="line-33"></a>    <span class='hs-comment'>-- Exclude wired-in names because we may not have read</span>
<a name="line-34"></a>    <span class='hs-comment'>-- their interface files, so getLinkDeps will fail</span>
<a name="line-35"></a>    <span class='hs-comment'>-- All wired-in names are in the base package, which we link</span>
<a name="line-36"></a>    <span class='hs-comment'>-- by default, so we can safely ignore them here.</span>
</pre>\end{code}



%************************************************************************
%*                                                                      *
              Loading a single module
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="linkModule"></a><span class='hs-definition'>linkModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>linkModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>  <span class='hs-varid'>initDynLinker</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-varid'>modifyPLS_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-5"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>pls'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkDependencies</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mod</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>    <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>failed</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"could not link module"</span><span class='hs-layout'>)</span>
<a name="line-7"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pls'</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Link some linkables
        The linkables may consist of a mixture of
        byte-code modules and object modules
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="linkModules"></a><span class='hs-definition'>linkModules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>linkModules</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>linkables</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>  <span class='hs-comment'>-- don't want to be interrupted by ^C in here</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>objs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bcos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isObjectLinkable</span>
<a name="line-7"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>partitionLinkable</span> <span class='hs-varid'>linkables</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>                <span class='hs-comment'>-- Load objects first; they can't depend on BCOs</span>
<a name="line-10"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>pls1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ok_flag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dynLinkObjs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>objs</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>failed</span> <span class='hs-varid'>ok_flag</span> <span class='hs-keyword'>then</span>
<a name="line-13"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Failed</span><span class='hs-layout'>)</span>
<a name="line-14"></a>          <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-15"></a>                <span class='hs-varid'>pls2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dynLinkBCOs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pls1</span> <span class='hs-varid'>bcos</span>
<a name="line-16"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Succeeded</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a>
<a name="line-19"></a><a name="partitionLinkable"></a><span class='hs-comment'>-- HACK to support f-x-dynamic in the interpreter; no other purpose</span>
<a name="line-20"></a><span class='hs-definition'>partitionLinkable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Linkable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a><span class='hs-definition'>partitionLinkable</span> <span class='hs-varid'>li</span>
<a name="line-22"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>li_uls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>li</span>
<a name="line-23"></a>         <span class='hs-varid'>li_uls_obj</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isObject</span> <span class='hs-varid'>li_uls</span>
<a name="line-24"></a>         <span class='hs-varid'>li_uls_bco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isInterpretable</span> <span class='hs-varid'>li_uls</span>
<a name="line-25"></a>     <span class='hs-keyword'>in</span>
<a name="line-26"></a>         <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>li_uls_obj</span><span class='hs-layout'>,</span> <span class='hs-varid'>li_uls_bco</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-27"></a>            <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>li</span> <span class='hs-layout'>{</span><span class='hs-varid'>linkableUnlinked</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>li_uls_obj</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-28"></a>                           <span class='hs-varid'>li</span> <span class='hs-layout'>{</span><span class='hs-varid'>linkableUnlinked</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>li_uls_bco</span><span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>li</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="findModuleLinkable_maybe"></a><span class='hs-definition'>findModuleLinkable_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Linkable</span>
<a name="line-32"></a><span class='hs-definition'>findModuleLinkable_maybe</span> <span class='hs-varid'>lis</span> <span class='hs-varid'>mod</span>
<a name="line-33"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LM</span> <span class='hs-varid'>time</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LM</span> <span class='hs-varid'>time</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lis</span><span class='hs-layout'>,</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mod</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>        <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-35"></a>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>li</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>li</span>
<a name="line-36"></a>        <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"findModuleLinkable"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="linkableInSet"></a><span class='hs-definition'>linkableInSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Linkable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-39"></a><span class='hs-definition'>linkableInSet</span> <span class='hs-varid'>l</span> <span class='hs-varid'>objs_loaded</span> <span class='hs-keyglyph'>=</span>
<a name="line-40"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>findModuleLinkable_maybe</span> <span class='hs-varid'>objs_loaded</span> <span class='hs-layout'>(</span><span class='hs-varid'>linkableModule</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-41"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-42"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>linkableTime</span> <span class='hs-varid'>l</span> <span class='hs-varop'>==</span> <span class='hs-varid'>linkableTime</span> <span class='hs-varid'>m</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{The object-code linker}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dynLinkObjs"></a><span class='hs-definition'>dynLinkObjs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>dynLinkObjs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>objs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>        <span class='hs-comment'>-- Load the object files and link them</span>
<a name="line-5"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>objs_loaded'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_objs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rmDupLinkables</span> <span class='hs-layout'>(</span><span class='hs-varid'>objs_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>objs</span>
<a name="line-6"></a>            <span class='hs-varid'>pls1</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pls</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objs_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>objs_loaded'</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>            <span class='hs-varid'>unlinkeds</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>new_objs</span>
<a name="line-8"></a>            <span class='hs-varid'>wanted_objs</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>nameOfObject</span> <span class='hs-varid'>unlinkeds</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>dynamicGhc</span>
<a name="line-11"></a>            <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dynLoadObjs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>wanted_objs</span>
<a name="line-12"></a>                    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Succeeded</span><span class='hs-layout'>)</span>
<a name="line-13"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>loadObj</span> <span class='hs-varid'>wanted_objs</span>
<a name="line-14"></a>
<a name="line-15"></a>                    <span class='hs-comment'>-- Link them all together</span>
<a name="line-16"></a>                    <span class='hs-varid'>ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resolveObjs</span>
<a name="line-17"></a>
<a name="line-18"></a>                    <span class='hs-comment'>-- If resolving failed, unload all our</span>
<a name="line-19"></a>                    <span class='hs-comment'>-- object modules and carry on</span>
<a name="line-20"></a>                    <span class='hs-keyword'>if</span> <span class='hs-varid'>succeeded</span> <span class='hs-varid'>ok</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-21"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Succeeded</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-23"></a>                            <span class='hs-varid'>pls2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unload_wkr</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>pls1</span>
<a name="line-24"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Failed</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="dynLoadObjs"></a><span class='hs-definition'>dynLoadObjs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-27"></a><span class='hs-definition'>dynLoadObjs</span> <span class='hs-keyword'>_</span>      <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-28"></a><span class='hs-definition'>dynLoadObjs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>objs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-29"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-30"></a>    <span class='hs-varid'>soFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempName</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>soExt</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>-- When running TH for a non-dynamic way, we still need to make</span>
<a name="line-32"></a>        <span class='hs-comment'>-- -l flags to link against the dynamic libraries, so we turn</span>
<a name="line-33"></a>        <span class='hs-comment'>-- Opt_Static off</span>
<a name="line-34"></a>        <span class='hs-varid'>dflags1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt_unset</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_Static</span>
<a name="line-35"></a>        <span class='hs-varid'>dflags2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags1</span> <span class='hs-layout'>{</span>
<a name="line-36"></a>                      <span class='hs-comment'>-- We don't want to link the ldInputs in; we'll</span>
<a name="line-37"></a>                      <span class='hs-comment'>-- be calling dynLoadObjs with any objects that</span>
<a name="line-38"></a>                      <span class='hs-comment'>-- need to be linked.</span>
<a name="line-39"></a>                      <span class='hs-varid'>ldInputs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-40"></a>                      <span class='hs-comment'>-- Even if we're e.g. profiling, we still want</span>
<a name="line-41"></a>                      <span class='hs-comment'>-- the vanilla dynamic libraries, so we set the</span>
<a name="line-42"></a>                      <span class='hs-comment'>-- ways / build tag to be just WayDyn.</span>
<a name="line-43"></a>                      <span class='hs-varid'>ways</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WayDyn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-44"></a>                      <span class='hs-varid'>buildTag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBuildTag</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WayDyn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-45"></a>                      <span class='hs-varid'>outputFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>soFile</span>
<a name="line-46"></a>                  <span class='hs-layout'>}</span>
<a name="line-47"></a>    <span class='hs-varid'>linkDynLib</span> <span class='hs-varid'>dflags2</span> <span class='hs-varid'>objs</span> <span class='hs-conid'>[]</span>
<a name="line-48"></a>    <span class='hs-varid'>consIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>filesToNotIntermediateClean</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>soFile</span>
<a name="line-49"></a>    <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadDLL</span> <span class='hs-varid'>soFile</span>
<a name="line-50"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-51"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-52"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Loading temp shared object failed: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="rmDupLinkables"></a><span class='hs-definition'>rmDupLinkables</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Already loaded</span>
<a name="line-55"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- New linkables</span>
<a name="line-56"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- New loaded set (including new ones)</span>
<a name="line-57"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- New linkables (excluding dups)</span>
<a name="line-58"></a><span class='hs-definition'>rmDupLinkables</span> <span class='hs-varid'>already</span> <span class='hs-varid'>ls</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>already</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ls</span>
<a name="line-60"></a>  <span class='hs-keyword'>where</span>
<a name="line-61"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>already</span> <span class='hs-varid'>extras</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>already</span><span class='hs-layout'>,</span> <span class='hs-varid'>extras</span><span class='hs-layout'>)</span>
<a name="line-62"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>already</span> <span class='hs-varid'>extras</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-varid'>ls</span><span class='hs-layout'>)</span>
<a name="line-63"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>linkableInSet</span> <span class='hs-varid'>l</span> <span class='hs-varid'>already</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>already</span>     <span class='hs-varid'>extras</span>     <span class='hs-varid'>ls</span>
<a name="line-64"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-varid'>already</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-varid'>extras</span><span class='hs-layout'>)</span> <span class='hs-varid'>ls</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{The byte-code linker}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dynLinkBCOs"></a><span class='hs-definition'>dynLinkBCOs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-3"></a><span class='hs-definition'>dynLinkBCOs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pls</span> <span class='hs-varid'>bcos</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>
<a name="line-5"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bcos_loaded'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_bcos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rmDupLinkables</span> <span class='hs-layout'>(</span><span class='hs-varid'>bcos_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>bcos</span>
<a name="line-6"></a>            <span class='hs-varid'>pls1</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pls</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bcos_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bcos_loaded'</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>            <span class='hs-varid'>unlinkeds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Unlinked</span><span class='hs-keyglyph'>]</span>
<a name="line-8"></a>            <span class='hs-varid'>unlinkeds</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>new_bcos</span>
<a name="line-9"></a>
<a name="line-10"></a>            <span class='hs-varid'>cbcs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CompiledByteCode</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a>            <span class='hs-varid'>cbcs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>byteCodeOfObject</span> <span class='hs-varid'>unlinkeds</span>
<a name="line-12"></a>
<a name="line-13"></a>
<a name="line-14"></a>            <span class='hs-varid'>ul_bcos</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ByteCode</span> <span class='hs-varid'>bs</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cbcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a>            <span class='hs-varid'>ies</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ie</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ByteCode</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ie</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cbcs</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>            <span class='hs-varid'>gce</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span>
<a name="line-17"></a>            <span class='hs-varid'>final_ie</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>plusNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>itbl_env</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>ies</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>final_gce</span><span class='hs-layout'>,</span> <span class='hs-sel'>_linked_bcos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkSomeBCOs</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>True</span> <span class='hs-varid'>final_ie</span> <span class='hs-varid'>gce</span> <span class='hs-varid'>ul_bcos</span>
<a name="line-20"></a>                <span class='hs-comment'>-- XXX What happens to these linked_bcos?</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>pls2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pls1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_gce</span><span class='hs-layout'>,</span>
<a name="line-23"></a>                          <span class='hs-varid'>itbl_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_ie</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>pls2</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="linkSomeBCOs"></a><span class='hs-comment'>-- Link a bunch of BCOs and return them + updated closure env.</span>
<a name="line-28"></a><span class='hs-definition'>linkSomeBCOs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-29"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- False &lt;=&gt; add _all_ BCOs to returned closure env</span>
<a name="line-30"></a>                        <span class='hs-comment'>-- True  &lt;=&gt; add only toplevel BCOs to closure env</span>
<a name="line-31"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ItblEnv</span>
<a name="line-32"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClosureEnv</span>
<a name="line-33"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnlinkedBCO</span><span class='hs-keyglyph'>]</span>
<a name="line-34"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosureEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HValue</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-35"></a>                        <span class='hs-comment'>-- The returned HValues are associated 1-1 with</span>
<a name="line-36"></a>                        <span class='hs-comment'>-- the incoming unlinked BCOs.  Each gives the</span>
<a name="line-37"></a>                        <span class='hs-comment'>-- value of the corresponding unlinked BCO</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>linkSomeBCOs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>toplevs_only</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>ce_in</span> <span class='hs-varid'>ul_bcos</span>
<a name="line-40"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>unlinkedBCOName</span> <span class='hs-varid'>ul_bcos</span>
<a name="line-41"></a>        <span class='hs-varid'>hvals</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixIO</span>
<a name="line-42"></a>                    <span class='hs-layout'>(</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>hvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ce_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendClosureEnv</span> <span class='hs-varid'>ce_in</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipLazy</span> <span class='hs-varid'>nms</span> <span class='hs-varid'>hvs</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                               <span class='hs-keyword'>in</span>  <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>linkBCO</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>ce_out</span><span class='hs-layout'>)</span> <span class='hs-varid'>ul_bcos</span> <span class='hs-layout'>)</span>
<a name="line-44"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ce_all_additions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>nms</span> <span class='hs-varid'>hvals</span>
<a name="line-45"></a>            <span class='hs-varid'>ce_top_additions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExternalName</span><span class='hs-varop'>.</span><span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>ce_all_additions</span>
<a name="line-46"></a>            <span class='hs-varid'>ce_additions</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>toplevs_only</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ce_top_additions</span>
<a name="line-47"></a>                                               <span class='hs-keyword'>else</span> <span class='hs-varid'>ce_all_additions</span>
<a name="line-48"></a>            <span class='hs-varid'>ce_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- make sure we're not inserting duplicate names into the</span>
<a name="line-49"></a>                     <span class='hs-comment'>-- closure environment, which leads to trouble.</span>
<a name="line-50"></a>                     <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemNameEnv`</span> <span class='hs-varid'>ce_in</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>ce_additions</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                     <span class='hs-varid'>extendClosureEnv</span> <span class='hs-varid'>ce_in</span> <span class='hs-varid'>ce_additions</span>
<a name="line-52"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ce_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>hvals</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Unload some object modules
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="unload"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- | Unloading old objects ready for a new compilation sweep.</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- The compilation manager provides us with a list of linkables that it</span>
<a name="line-5"></a><span class='hs-comment'>-- considers \"stable\", i.e. won't be recompiled this time around.  For</span>
<a name="line-6"></a><span class='hs-comment'>-- each of the modules current linked in memory,</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>--   * if the linkable is stable (and it's the same one -- the user may have</span>
<a name="line-9"></a><span class='hs-comment'>--     recompiled the module on the side), we keep it,</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>--   * otherwise, we unload it.</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>--   * we also implicitly unload all temporary bindings at this point.</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><span class='hs-definition'>unload</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-16"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ The linkables to *keep*.</span>
<a name="line-17"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-18"></a><span class='hs-definition'>unload</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>linkables</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- mask, so we're safe from Ctrl-C in here</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-comment'>-- Initialise the linker (if it's not been done already)</span>
<a name="line-22"></a>        <span class='hs-varid'>initDynLinker</span> <span class='hs-varid'>dflags</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-varid'>new_pls</span>
<a name="line-25"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modifyPLS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-26"></a>                 <span class='hs-varid'>pls1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unload_wkr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>linkables</span> <span class='hs-varid'>pls</span>
<a name="line-27"></a>                 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pls1</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"unload: retaining objs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>objs_loaded</span> <span class='hs-varid'>new_pls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>        <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"unload: retaining bcos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bcos_loaded</span> <span class='hs-varid'>new_pls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>        <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="unload_wkr"></a><span class='hs-definition'>unload_wkr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-34"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span>                <span class='hs-comment'>-- stable linkables</span>
<a name="line-35"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-36"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-37"></a><span class='hs-comment'>-- Does the core unload business</span>
<a name="line-38"></a><span class='hs-comment'>-- (the wrapper blocks exceptions and deals with the PLS get and put)</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>unload_wkr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>linkables</span> <span class='hs-varid'>pls</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>objs_to_keep</span><span class='hs-layout'>,</span> <span class='hs-varid'>bcos_to_keep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isObjectLinkable</span> <span class='hs-varid'>linkables</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-varid'>objs_loaded'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterM</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeUnload</span> <span class='hs-varid'>objs_to_keep</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>objs_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span>
<a name="line-44"></a>        <span class='hs-varid'>bcos_loaded'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterM</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeUnload</span> <span class='hs-varid'>bcos_to_keep</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bcos_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>bcos_retained</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>linkableModule</span> <span class='hs-varid'>bcos_loaded'</span>
<a name="line-47"></a>            <span class='hs-varid'>itbl_env'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameMap</span> <span class='hs-varid'>bcos_retained</span> <span class='hs-layout'>(</span><span class='hs-varid'>itbl_env</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span>
<a name="line-48"></a>            <span class='hs-varid'>closure_env'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameMap</span> <span class='hs-varid'>bcos_retained</span> <span class='hs-layout'>(</span><span class='hs-varid'>closure_env</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span>
<a name="line-49"></a>            <span class='hs-varid'>new_pls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pls</span> <span class='hs-layout'>{</span> <span class='hs-varid'>itbl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>itbl_env'</span><span class='hs-layout'>,</span>
<a name="line-50"></a>                            <span class='hs-varid'>closure_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closure_env'</span><span class='hs-layout'>,</span>
<a name="line-51"></a>                            <span class='hs-varid'>bcos_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bcos_loaded'</span><span class='hs-layout'>,</span>
<a name="line-52"></a>                            <span class='hs-varid'>objs_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>objs_loaded'</span> <span class='hs-layout'>}</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>new_pls</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>maybeUnload</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Linkable</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Linkable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-57"></a>    <span class='hs-varid'>maybeUnload</span> <span class='hs-varid'>keep_linkables</span> <span class='hs-varid'>lnk</span>
<a name="line-58"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>linkableInSet</span> <span class='hs-varid'>lnk</span> <span class='hs-varid'>keep_linkables</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-59"></a>      <span class='hs-comment'>-- We don't do any cleanup when linking objects with the dynamic linker.</span>
<a name="line-60"></a>      <span class='hs-comment'>-- Doing so introduces extra complexity for not much benefit.</span>
<a name="line-61"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dynamicGhc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-62"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-63"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>unloadObj</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DotO</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>lnk</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a>                <span class='hs-comment'>-- The components of a BCO linkable may contain</span>
<a name="line-65"></a>                <span class='hs-comment'>-- dot-o files.  Which is very confusing.</span>
<a name="line-66"></a>                <span class='hs-comment'>--</span>
<a name="line-67"></a>                <span class='hs-comment'>-- But the BCO parts can be unlinked just by</span>
<a name="line-68"></a>                <span class='hs-comment'>-- letting go of them (plus of course depopulating</span>
<a name="line-69"></a>                <span class='hs-comment'>-- the symbol table which is done in the main body)</span>
<a name="line-70"></a>           <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Loading packages
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="LibrarySpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LibrarySpec</span>
<a name="line-2"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Object</span> <span class='hs-conid'>FilePath</span>    <span class='hs-comment'>-- Full path name of a .o file, including trailing .o</span>
<a name="line-3"></a>                        <span class='hs-comment'>-- For dynamic objects only, try to find the object</span>
<a name="line-4"></a>                        <span class='hs-comment'>-- file in all the directories specified in</span>
<a name="line-5"></a>                        <span class='hs-comment'>-- v_Library_paths before giving up.</span>
<a name="line-6"></a>
<a name="line-7"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Archive</span> <span class='hs-conid'>FilePath</span>   <span class='hs-comment'>-- Full path name of a .a file, including trailing .a</span>
<a name="line-8"></a>
<a name="line-9"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DLL</span> <span class='hs-conid'>String</span>         <span class='hs-comment'>-- "Unadorned" name of a .DLL/.so</span>
<a name="line-10"></a>                        <span class='hs-comment'>--  e.g.    On unix     "qt"  denotes "libqt.so"</span>
<a name="line-11"></a>                        <span class='hs-comment'>--          On WinDoze  "burble"  denotes "burble.DLL"</span>
<a name="line-12"></a>                        <span class='hs-comment'>--  loadDLL is platform-specific and adds the lib/.so/.DLL</span>
<a name="line-13"></a>                        <span class='hs-comment'>--  suffixes platform-dependently</span>
<a name="line-14"></a>
<a name="line-15"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DLLPath</span> <span class='hs-conid'>FilePath</span>   <span class='hs-comment'>-- Absolute or relative pathname to a dynamic library</span>
<a name="line-16"></a>                        <span class='hs-comment'>-- (ends with .dll or .so).</span>
<a name="line-17"></a>
<a name="line-18"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Framework</span> <span class='hs-conid'>String</span>   <span class='hs-comment'>-- Only used for darwin, but does no harm</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="partOfGHCi"></a><span class='hs-comment'>-- If this package is already part of the GHCi binary, we'll already</span>
<a name="line-21"></a><span class='hs-comment'>-- have the right DLLs for this package loaded, so don't try to</span>
<a name="line-22"></a><span class='hs-comment'>-- load them again.</span>
<a name="line-23"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><span class='hs-comment'>-- But on Win32 we must load them 'again'; doing so is a harmless no-op</span>
<a name="line-25"></a><span class='hs-comment'>-- as far as the loader is concerned, but it does initialise the list</span>
<a name="line-26"></a><span class='hs-comment'>-- of DLL handles that rts/Linker.c maintains, and that in turn is</span>
<a name="line-27"></a><span class='hs-comment'>-- used by lookupSymbol.  So we must call addDLL for each library</span>
<a name="line-28"></a><span class='hs-comment'>-- just to get the DLL handle into the list.</span>
<a name="line-29"></a><span class='hs-definition'>partOfGHCi</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageName</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a><span class='hs-definition'>partOfGHCi</span>
<a name="line-31"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWindowsHost</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isDarwinHost</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-32"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>PackageName</span>
<a name="line-33"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-str'>"base"</span><span class='hs-layout'>,</span> <span class='hs-str'>"template-haskell"</span><span class='hs-layout'>,</span> <span class='hs-str'>"editline"</span><span class='hs-keyglyph'>]</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="showLS"></a><span class='hs-definition'>showLS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LibrarySpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-36"></a><span class='hs-definition'>showLS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Object</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-str'>"(static) "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nm</span>
<a name="line-37"></a><span class='hs-definition'>showLS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Archive</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-str'>"(static archive) "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nm</span>
<a name="line-38"></a><span class='hs-definition'>showLS</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLL</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-str'>"(dynamic) "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nm</span>
<a name="line-39"></a><span class='hs-definition'>showLS</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLLPath</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-str'>"(dynamic) "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nm</span>
<a name="line-40"></a><span class='hs-definition'>showLS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Framework</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"(framework) "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nm</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="linkPackages"></a><span class='hs-comment'>-- | Link exactly the specified packages, and their dependents (unless of</span>
<a name="line-43"></a><span class='hs-comment'>-- course they are already linked).  The dependents are linked</span>
<a name="line-44"></a><span class='hs-comment'>-- automatically, and it doesn't matter what order you specify the input</span>
<a name="line-45"></a><span class='hs-comment'>-- packages.</span>
<a name="line-46"></a><span class='hs-comment'>--</span>
<a name="line-47"></a><span class='hs-definition'>linkPackages</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-48"></a><span class='hs-comment'>-- NOTE: in fact, since each module tracks all the packages it depends on,</span>
<a name="line-49"></a><span class='hs-comment'>--       we don't really need to use the package-config dependencies.</span>
<a name="line-50"></a><span class='hs-comment'>--</span>
<a name="line-51"></a><span class='hs-comment'>-- However we do need the package-config stuff (to find aux libs etc),</span>
<a name="line-52"></a><span class='hs-comment'>-- and following them lets us load libraries in the right order, which</span>
<a name="line-53"></a><span class='hs-comment'>-- perhaps makes the error message a bit more localised if we get a link</span>
<a name="line-54"></a><span class='hs-comment'>-- failure.  So the dependency walking code is still here.</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-definition'>linkPackages</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>new_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-57"></a>  <span class='hs-comment'>-- It's probably not safe to try to load packages concurrently, so we take</span>
<a name="line-58"></a>  <span class='hs-comment'>-- a lock.</span>
<a name="line-59"></a>  <span class='hs-varid'>initDynLinker</span> <span class='hs-varid'>dflags</span>
<a name="line-60"></a>  <span class='hs-varid'>modifyPLS_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-61"></a>    <span class='hs-varid'>linkPackages'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>new_pkgs</span> <span class='hs-varid'>pls</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="linkPackages'"></a><span class='hs-definition'>linkPackages'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-64"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>PersistentLinkerState</span>
<a name="line-65"></a><span class='hs-definition'>linkPackages'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>new_pks</span> <span class='hs-varid'>pls</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-66"></a>    <span class='hs-varid'>pkgs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>link</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgs_loaded</span> <span class='hs-varid'>pls</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_pks</span>
<a name="line-67"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>pls</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pkgs_loaded</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgs'</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>     <span class='hs-varid'>pkg_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgIdMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgState</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-70"></a>     <span class='hs-varid'>ipid_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installedPackageIdMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgState</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a>     <span class='hs-varid'>link</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span>
<a name="line-73"></a>     <span class='hs-varid'>link</span> <span class='hs-varid'>pkgs</span> <span class='hs-varid'>new_pkgs</span> <span class='hs-keyglyph'>=</span>
<a name="line-74"></a>         <span class='hs-varid'>foldM</span> <span class='hs-varid'>link_one</span> <span class='hs-varid'>pkgs</span> <span class='hs-varid'>new_pkgs</span>
<a name="line-75"></a>
<a name="line-76"></a>     <span class='hs-varid'>link_one</span> <span class='hs-varid'>pkgs</span> <span class='hs-varid'>new_pkg</span>
<a name="line-77"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_pkg</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>pkgs</span>   <span class='hs-comment'>-- Already linked</span>
<a name="line-78"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pkgs</span>
<a name="line-79"></a>
<a name="line-80"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pkg_cfg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupPackage</span> <span class='hs-varid'>pkg_map</span> <span class='hs-varid'>new_pkg</span>
<a name="line-81"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Link dependents first</span>
<a name="line-82"></a>               <span class='hs-varid'>pkgs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>link</span> <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Maybes</span><span class='hs-varop'>.</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"link_one"</span> <span class='hs-varop'>$</span>
<a name="line-83"></a>                                    <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>ipid</span> <span class='hs-varid'>ipid_map</span>
<a name="line-84"></a>                                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ipid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>depends</span> <span class='hs-varid'>pkg_cfg</span> <span class='hs-keyglyph'>]</span>
<a name="line-85"></a>                <span class='hs-comment'>-- Now link the package itself</span>
<a name="line-86"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>linkPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pkg_cfg</span>
<a name="line-87"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_pkg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pkgs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>
<a name="line-89"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-90"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdLineError</span> <span class='hs-layout'>(</span><span class='hs-str'>"unknown package: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>packageIdString</span> <span class='hs-varid'>new_pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a>
<a name="line-93"></a><a name="linkPackage"></a><span class='hs-definition'>linkPackage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-94"></a><span class='hs-definition'>linkPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pkg</span>
<a name="line-95"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-96"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-97"></a>            <span class='hs-varid'>dirs</span>      <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>libraryDirs</span> <span class='hs-varid'>pkg</span>
<a name="line-98"></a>
<a name="line-99"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>hs_libs</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>hsLibraries</span> <span class='hs-varid'>pkg</span>
<a name="line-100"></a>            <span class='hs-comment'>-- The FFI GHCi import lib isn't needed as</span>
<a name="line-101"></a>            <span class='hs-comment'>-- compiler/ghci/Linker.lhs + rts/Linker.c link the</span>
<a name="line-102"></a>            <span class='hs-comment'>-- interpreted references to FFI to the compiled FFI.</span>
<a name="line-103"></a>            <span class='hs-comment'>-- We therefore filter it out so that we don't get</span>
<a name="line-104"></a>            <span class='hs-comment'>-- duplicate symbol errors.</span>
<a name="line-105"></a>            <span class='hs-varid'>hs_libs'</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-str'>"HSffi"</span> <span class='hs-varop'>/=</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_libs</span>
<a name="line-106"></a>
<a name="line-107"></a>        <span class='hs-comment'>-- Because of slight differences between the GHC dynamic linker and</span>
<a name="line-108"></a>        <span class='hs-comment'>-- the native system linker some packages have to link with a</span>
<a name="line-109"></a>        <span class='hs-comment'>-- different list of libraries when using GHCi. Examples include: libs</span>
<a name="line-110"></a>        <span class='hs-comment'>-- that are actually gnu ld scripts, and the possability that the .a</span>
<a name="line-111"></a>        <span class='hs-comment'>-- libs do not exactly match the .so/.dll equivalents. So if the</span>
<a name="line-112"></a>        <span class='hs-comment'>-- package file provides an "extra-ghci-libraries" field then we use</span>
<a name="line-113"></a>        <span class='hs-comment'>-- that instead of the "extra-libraries" field.</span>
<a name="line-114"></a>            <span class='hs-varid'>extra_libs</span> <span class='hs-keyglyph'>=</span>
<a name="line-115"></a>                      <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>extraGHCiLibraries</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-116"></a>                            <span class='hs-keyword'>then</span> <span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>extraLibraries</span> <span class='hs-varid'>pkg</span>
<a name="line-117"></a>                            <span class='hs-keyword'>else</span> <span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>extraGHCiLibraries</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-118"></a>                      <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>lib</span> <span class='hs-keyglyph'>|</span> <span class='hs-chr'>'-'</span><span class='hs-conop'>:</span><span class='hs-chr'>'l'</span><span class='hs-conop'>:</span><span class='hs-varid'>lib</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>ldOptions</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>]</span>
<a name="line-119"></a>
<a name="line-120"></a>        <span class='hs-varid'>hs_classifieds</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>locateLib</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>dirs</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_libs'</span>
<a name="line-121"></a>        <span class='hs-varid'>extra_classifieds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>locateLib</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-varid'>dirs</span><span class='hs-layout'>)</span> <span class='hs-varid'>extra_libs</span>
<a name="line-122"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>classifieds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_classifieds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_classifieds</span>
<a name="line-123"></a>
<a name="line-124"></a>        <span class='hs-comment'>-- Complication: all the .so's must be loaded before any of the .o's.</span>
<a name="line-125"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>known_dlls</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>dll</span>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DLLPath</span> <span class='hs-varid'>dll</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifieds</span> <span class='hs-keyglyph'>]</span>
<a name="line-126"></a>            <span class='hs-varid'>dlls</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>dll</span>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DLL</span> <span class='hs-varid'>dll</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifieds</span> <span class='hs-keyglyph'>]</span>
<a name="line-127"></a>            <span class='hs-varid'>objs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>obj</span>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Object</span> <span class='hs-varid'>obj</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifieds</span> <span class='hs-keyglyph'>]</span>
<a name="line-128"></a>            <span class='hs-varid'>archs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>arch</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Archive</span> <span class='hs-varid'>arch</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifieds</span> <span class='hs-keyglyph'>]</span>
<a name="line-129"></a>
<a name="line-130"></a>        <span class='hs-varid'>maybePutStr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-str'>"Loading package "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>display</span> <span class='hs-layout'>(</span><span class='hs-varid'>sourcePackageId</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" ... "</span><span class='hs-layout'>)</span>
<a name="line-131"></a>
<a name="line-132"></a>        <span class='hs-comment'>-- See comments with partOfGHCi</span>
<a name="line-133"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageName</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>partOfGHCi</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-134"></a>            <span class='hs-varid'>loadFrameworks</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>pkg</span>
<a name="line-135"></a>            <span class='hs-varid'>mapM_</span> <span class='hs-varid'>load_dyn</span> <span class='hs-layout'>(</span><span class='hs-varid'>known_dlls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSOName</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>dlls</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a>        <span class='hs-comment'>-- After loading all the DLLs, we can load the static objects.</span>
<a name="line-138"></a>        <span class='hs-comment'>-- Ordering isn't important here, because we do one final link</span>
<a name="line-139"></a>        <span class='hs-comment'>-- step to resolve everything.</span>
<a name="line-140"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-varid'>loadObj</span> <span class='hs-varid'>objs</span>
<a name="line-141"></a>        <span class='hs-varid'>mapM_</span> <span class='hs-varid'>loadArchive</span> <span class='hs-varid'>archs</span>
<a name="line-142"></a>
<a name="line-143"></a>        <span class='hs-varid'>maybePutStr</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"linking ... "</span>
<a name="line-144"></a>        <span class='hs-varid'>ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>resolveObjs</span>
<a name="line-145"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>succeeded</span> <span class='hs-varid'>ok</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"done."</span>
<a name="line-146"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstallationError</span> <span class='hs-layout'>(</span><span class='hs-str'>"unable to load package `"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>display</span> <span class='hs-layout'>(</span><span class='hs-varid'>sourcePackageId</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>"'"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="load_dyn"></a><span class='hs-comment'>-- we have already searched the filesystem; the strings passed to load_dyn</span>
<a name="line-149"></a><span class='hs-comment'>-- can be passed directly to loadDLL.  They are either fully-qualified</span>
<a name="line-150"></a><span class='hs-comment'>-- ("/usr/lib/libfoo.so"), or unqualified ("libfoo.so").  In the latter case,</span>
<a name="line-151"></a><span class='hs-comment'>-- loadDLL is going to search the system paths to find the library.</span>
<a name="line-152"></a><span class='hs-comment'>--</span>
<a name="line-153"></a><span class='hs-definition'>load_dyn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-154"></a><span class='hs-definition'>load_dyn</span> <span class='hs-varid'>dll</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadDLL</span> <span class='hs-varid'>dll</span>
<a name="line-155"></a>                  <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-156"></a>                    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-157"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdLineError</span> <span class='hs-layout'>(</span><span class='hs-str'>"can't load .so/.DLL for: "</span>
<a name="line-158"></a>                                                              <span class='hs-varop'>++</span> <span class='hs-varid'>dll</span> <span class='hs-varop'>++</span> <span class='hs-str'>" ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>err</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="loadFrameworks"></a><span class='hs-definition'>loadFrameworks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstalledPackageInfo_</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-161"></a><span class='hs-definition'>loadFrameworks</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>pkg</span>
<a name="line-162"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>platformUsesFrameworks</span> <span class='hs-varid'>platform</span>
<a name="line-163"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>load</span> <span class='hs-varid'>frameworks</span>
<a name="line-164"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-165"></a>  <span class='hs-keyword'>where</span>
<a name="line-166"></a>    <span class='hs-varid'>fw_dirs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>frameworkDirs</span> <span class='hs-varid'>pkg</span>
<a name="line-167"></a>    <span class='hs-varid'>frameworks</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Packages</span><span class='hs-varop'>.</span><span class='hs-varid'>frameworks</span> <span class='hs-varid'>pkg</span>
<a name="line-168"></a>
<a name="line-169"></a>    <span class='hs-varid'>load</span> <span class='hs-varid'>fw</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadFramework</span> <span class='hs-varid'>fw_dirs</span> <span class='hs-varid'>fw</span>
<a name="line-170"></a>                  <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-171"></a>                    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-172"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdLineError</span> <span class='hs-layout'>(</span><span class='hs-str'>"can't load framework: "</span>
<a name="line-173"></a>                                                        <span class='hs-varop'>++</span> <span class='hs-varid'>fw</span> <span class='hs-varop'>++</span> <span class='hs-str'>" ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>err</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a><span class='hs-comment'>-- Try to find an object file for a given library in the given paths.</span>
<a name="line-176"></a><span class='hs-comment'>-- If it isn't present, we assume that addDLL in the RTS can find it,</span>
<a name="line-177"></a><span class='hs-comment'>-- which generally means that it should be a dynamic library in the</span>
<a name="line-178"></a><span class='hs-comment'>-- standard system search path.</span>
<a name="line-179"></a>
<a name="line-180"></a><a name="locateLib"></a><span class='hs-definition'>locateLib</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>LibrarySpec</span>
<a name="line-181"></a><span class='hs-definition'>locateLib</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_hs</span> <span class='hs-varid'>dirs</span> <span class='hs-varid'>lib</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_hs</span>
<a name="line-183"></a>    <span class='hs-comment'>-- For non-Haskell libraries (e.g. gmp, iconv):</span>
<a name="line-184"></a>    <span class='hs-comment'>--   first look in library-dirs for a dynamic library (libfoo.so)</span>
<a name="line-185"></a>    <span class='hs-comment'>--   then  look in library-dirs for a static library (libfoo.a)</span>
<a name="line-186"></a>    <span class='hs-comment'>--   then  try "gcc --print-file-name" to search gcc's search path</span>
<a name="line-187"></a>    <span class='hs-comment'>--       for a dynamic library (#5289)</span>
<a name="line-188"></a>    <span class='hs-comment'>--   otherwise, assume loadDLL can find it</span>
<a name="line-189"></a>    <span class='hs-comment'>--</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDll</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>findArchive</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>tryGcc</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>assumeDll</span>
<a name="line-191"></a>
<a name="line-192"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>dynamicGhc</span>
<a name="line-193"></a>    <span class='hs-comment'>-- When the GHC package was not compiled as dynamic library</span>
<a name="line-194"></a>    <span class='hs-comment'>-- (=DYNAMIC not set), we search for .o libraries or, if they</span>
<a name="line-195"></a>    <span class='hs-comment'>-- don't exist, .a libraries.</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findObject</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>findArchive</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>assumeDll</span>
<a name="line-197"></a>
<a name="line-198"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-199"></a>    <span class='hs-comment'>-- When the GHC package was compiled as dynamic library (=DYNAMIC set),</span>
<a name="line-200"></a>    <span class='hs-comment'>-- we search for .so libraries first.</span>
<a name="line-201"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findHSDll</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>findDynObject</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>assumeDll</span>
<a name="line-202"></a>   <span class='hs-keyword'>where</span>
<a name="line-203"></a>     <span class='hs-varid'>mk_obj_path</span>      <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lib</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"o"</span><span class='hs-layout'>)</span>
<a name="line-204"></a>     <span class='hs-varid'>mk_dyn_obj_path</span>  <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lib</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"dyn_o"</span><span class='hs-layout'>)</span>
<a name="line-205"></a>     <span class='hs-varid'>mk_arch_path</span>     <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-layout'>(</span><span class='hs-str'>"lib"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>lib</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"a"</span><span class='hs-layout'>)</span>
<a name="line-206"></a>
<a name="line-207"></a>     <span class='hs-varid'>hs_dyn_lib_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lib</span> <span class='hs-varop'>++</span> <span class='hs-str'>"-ghc"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cProjectVersion</span>
<a name="line-208"></a>     <span class='hs-varid'>mk_hs_dyn_lib_path</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>mkHsSOName</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>hs_dyn_lib_name</span>
<a name="line-209"></a>
<a name="line-210"></a>     <span class='hs-varid'>so_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSOName</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>lib</span>
<a name="line-211"></a>     <span class='hs-varid'>mk_dyn_lib_path</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>so_name</span>
<a name="line-212"></a>
<a name="line-213"></a>     <span class='hs-varid'>findObject</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>Object</span><span class='hs-layout'>)</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>findFile</span> <span class='hs-varid'>mk_obj_path</span>        <span class='hs-varid'>dirs</span>
<a name="line-214"></a>     <span class='hs-varid'>findDynObject</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>Object</span><span class='hs-layout'>)</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>findFile</span> <span class='hs-varid'>mk_dyn_obj_path</span>    <span class='hs-varid'>dirs</span>
<a name="line-215"></a>     <span class='hs-varid'>findArchive</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>Archive</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findFile</span> <span class='hs-varid'>mk_arch_path</span>       <span class='hs-varid'>dirs</span>
<a name="line-216"></a>     <span class='hs-varid'>findHSDll</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>DLLPath</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findFile</span> <span class='hs-varid'>mk_hs_dyn_lib_path</span> <span class='hs-varid'>dirs</span>
<a name="line-217"></a>     <span class='hs-varid'>findDll</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>DLLPath</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findFile</span> <span class='hs-varid'>mk_dyn_lib_path</span>    <span class='hs-varid'>dirs</span>
<a name="line-218"></a>     <span class='hs-varid'>tryGcc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>DLLPath</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>searchForLibUsingGcc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>so_name</span> <span class='hs-varid'>dirs</span>
<a name="line-219"></a>
<a name="line-220"></a>     <span class='hs-varid'>assumeDll</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLL</span> <span class='hs-varid'>lib</span><span class='hs-layout'>)</span>
<a name="line-221"></a>     <span class='hs-keyword'>infixr</span> <span class='hs-varop'>`orElse`</span>
<a name="line-222"></a>     <span class='hs-varid'>f</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span>
<a name="line-223"></a>                       <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-224"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>
<a name="line-225"></a>                           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>g</span>
<a name="line-226"></a>
<a name="line-227"></a>     <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-228"></a>
<a name="line-229"></a><a name="searchForLibUsingGcc"></a><span class='hs-definition'>searchForLibUsingGcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-230"></a><span class='hs-definition'>searchForLibUsingGcc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>so</span> <span class='hs-varid'>dirs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-231"></a>   <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>askCc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>FileOption</span> <span class='hs-str'>"-L"</span><span class='hs-layout'>)</span> <span class='hs-varid'>dirs</span>
<a name="line-232"></a>                          <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"--print-file-name"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>so</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-233"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lines</span> <span class='hs-varid'>str</span> <span class='hs-keyword'>of</span>
<a name="line-234"></a>                <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<a name="line-235"></a>                <span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>l</span>
<a name="line-236"></a>   <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>file</span> <span class='hs-varop'>==</span> <span class='hs-varid'>so</span><span class='hs-layout'>)</span>
<a name="line-237"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-238"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-239"></a>
<a name="line-240"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-241"></a><span class='hs-comment'>-- Loading a dynamic library (dlopen()-ish on Unix, LoadLibrary-ish on Win32)</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="loadFramework"></a><span class='hs-comment'>-- Darwin / MacOS X only: load a framework</span>
<a name="line-244"></a><span class='hs-comment'>-- a framework is a dynamic library packaged inside a directory of the same</span>
<a name="line-245"></a><span class='hs-comment'>-- name. They are searched for in different paths than normal libraries.</span>
<a name="line-246"></a><span class='hs-definition'>loadFramework</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-247"></a><span class='hs-definition'>loadFramework</span> <span class='hs-varid'>extraPaths</span> <span class='hs-varid'>rootname</span>
<a name="line-248"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>either_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryIO</span> <span class='hs-varid'>getHomeDirectory</span>
<a name="line-249"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>homeFrameworkPath</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_dir</span> <span class='hs-keyword'>of</span>
<a name="line-250"></a>                                  <span class='hs-conid'>Left</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-251"></a>                                  <span class='hs-conid'>Right</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dir</span> <span class='hs-varop'>++</span> <span class='hs-str'>"/Library/Frameworks"</span><span class='hs-keyglyph'>]</span>
<a name="line-252"></a>              <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extraPaths</span> <span class='hs-varop'>++</span> <span class='hs-varid'>homeFrameworkPath</span> <span class='hs-varop'>++</span> <span class='hs-varid'>defaultFrameworkPaths</span>
<a name="line-253"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mb_fwk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findFile</span> <span class='hs-varid'>mk_fwk</span> <span class='hs-varid'>ps</span>
<a name="line-254"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_fwk</span> <span class='hs-keyword'>of</span>
<a name="line-255"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>fwk_path</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loadDLL</span> <span class='hs-varid'>fwk_path</span>
<a name="line-256"></a>            <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-str'>"not found"</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-257"></a>                <span class='hs-comment'>-- Tried all our known library paths, but dlopen()</span>
<a name="line-258"></a>                <span class='hs-comment'>-- has no built-in paths for frameworks: give up</span>
<a name="line-259"></a>   <span class='hs-keyword'>where</span>
<a name="line-260"></a>     <span class='hs-varid'>mk_fwk</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rootname</span> <span class='hs-varop'>++</span> <span class='hs-str'>".framework/"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rootname</span><span class='hs-layout'>)</span>
<a name="line-261"></a>        <span class='hs-comment'>-- sorry for the hardcoded paths, I hope they won't change anytime soon:</span>
<a name="line-262"></a>     <span class='hs-varid'>defaultFrameworkPaths</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"/Library/Frameworks"</span><span class='hs-layout'>,</span> <span class='hs-str'>"/System/Library/Frameworks"</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Helper functions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="findFile"></a><span class='hs-definition'>findFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Maps a directory path to a file path</span>
<a name="line-2"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>                  <span class='hs-comment'>-- Directories to look in</span>
<a name="line-3"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- The first file path to match</span>
<a name="line-4"></a><span class='hs-definition'>findFile</span> <span class='hs-keyword'>_</span>            <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-5"></a><span class='hs-definition'>findFile</span> <span class='hs-varid'>mk_file_path</span> <span class='hs-layout'>(</span><span class='hs-varid'>dir</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dirs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>file_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_file_path</span> <span class='hs-varid'>dir</span>
<a name="line-7"></a>       <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>file_path</span>
<a name="line-8"></a>       <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>file_path</span><span class='hs-layout'>)</span>
<a name="line-9"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>findFile</span> <span class='hs-varid'>mk_file_path</span> <span class='hs-varid'>dirs</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="maybePutStr"></a><span class='hs-definition'>maybePutStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>maybePutStr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>s</span>
<a name="line-3"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>          <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span>
<a name="line-5"></a>             <span class='hs-varid'>act</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>SevInteractive</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultUserStyle</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="maybePutStrLn"></a><span class='hs-definition'>maybePutStrLn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-8"></a><span class='hs-definition'>maybePutStrLn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybePutStr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n"</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Tunneling global variables into new instance of GHC library
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="saveLinkerGlobals"></a><span class='hs-definition'>saveLinkerGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>saveLinkerGlobals</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM2</span> <span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_PersistentLinkerState</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_InitLinkerDone</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="restoreLinkerGlobals"></a><span class='hs-definition'>restoreLinkerGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-5"></a><span class='hs-definition'>restoreLinkerGlobals</span> <span class='hs-layout'>(</span><span class='hs-varid'>pls</span><span class='hs-layout'>,</span> <span class='hs-varid'>ild</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-6"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_PersistentLinkerState</span> <span class='hs-varid'>pls</span>
<a name="line-7"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_InitLinkerDone</span> <span class='hs-varid'>ild</span>
</pre>\end{code}
</body>
</html>
