<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CoreLint.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>

%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1993-1998
%

A ``lint'' pass to check for Core correctness

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-2"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-3"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-4"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-5"></a><span class='hs-comment'>-- for details</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# OPTIONS_GHC -fprof-auto #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreLint</span> <span class='hs-layout'>(</span> <span class='hs-varid'>lintCoreBindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>lintUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>lintExpr</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OptCoercion</span> <span class='hs-layout'>(</span> <span class='hs-varid'>checkAxInstCo</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
</pre>\end{code}

Note [GHC Formalism]
~~~~~~~~~~~~~~~~~~~~
This file implements the type-checking algorithm for System FC, the "official"
name of the Core language. Type safety of FC is heart of the claim that
executables produced by GHC do not have segmentation faults. Thus, it is
useful to be able to reason about System FC independently of reading the code.
To this purpose, there is a document ghc.pdf built in docs/core-spec that
contains a formalism of the types and functions dealt with here. If you change
just about anything in this file or you change other types/functions throughout
the Core language (all signposted to this note), you should update that
formalism. See docs/core-spec/README for more info about how to do so.

%************************************************************************
%*                                                                      *
\subsection[lintCoreBindings]{@lintCoreBindings@: Top-level interface}
%*                                                                      *
%************************************************************************

Checks that a set of core bindings is well-formed.  The PprStyle and String
just control what we print in the event of an error.  The Bool value
indicates whether we have done any specialisation yet (in which case we do
some extra checks).

We check for
        (a) type errors
        (b) Out-of-scope type variables
        (c) Out-of-scope local variables
        (d) Ill-kinded types

If we have done specialisation the we check that there are
        (a) No top-level bindings of primitive (unboxed type)

Outstanding issues:

    --
    -- Things are *not* OK if:
    --
    --  * Unsaturated type app before specialisation has been done;
    --
    --  * Oversaturated type app after specialisation (eta reduction
    --   may well be happening...);


Note [Linting type lets]
~~~~~~~~~~~~~~~~~~~~~~~~
In the desugarer, it's very very convenient to be able to say (in effect)
        let a = Type Int in <body>
That is, use a type let.   See Note [Type let] in CoreSyn.

However, when linting <body> we need to remember that a=Int, else we might
reject a correct program.  So we carry a type substitution (in this example
[a -> Int]) and apply this substitution before comparing types.  The functin
        lintInTy :: Type -> LintM Type
returns a substituted type; that's the only reason it returns anything.

When we encounter a binder (like x::a) we must apply the substitution
to the type of the binding variable.  lintBinders does this.

For Ids, the type-substituted Id is added to the in_scope set (which
itself is part of the TvSubst we are carrying down), and when we
find an occurrence of an Id, we fetch it from the in-scope set.


\begin{code}
<pre><a name="line-1"></a><a name="lintCoreBindings"></a><span class='hs-definition'>lintCoreBindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>--   Returns (warnings, errors)</span>
<a name="line-3"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-4"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-5"></a><span class='hs-definition'>lintCoreBindings</span> <span class='hs-varid'>local_in_scope</span> <span class='hs-varid'>binds</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initL</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-varid'>addLoc</span> <span class='hs-conid'>TopLevelBindings</span>        <span class='hs-varop'>$</span>
<a name="line-8"></a>    <span class='hs-varid'>addInScopeVars</span> <span class='hs-varid'>local_in_scope</span>  <span class='hs-varop'>$</span>
<a name="line-9"></a>    <span class='hs-varid'>addInScopeVars</span> <span class='hs-varid'>binders</span>         <span class='hs-varop'>$</span>
<a name="line-10"></a>        <span class='hs-comment'>-- Put all the top-level binders in scope at the start</span>
<a name="line-11"></a>        <span class='hs-comment'>-- This is because transformation rules can bring something</span>
<a name="line-12"></a>        <span class='hs-comment'>-- into use 'unexpectedly'</span>
<a name="line-13"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupVars</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ext_dups</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupExtVars</span> <span class='hs-varid'>ext_dups</span><span class='hs-layout'>)</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lint_bind</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-varid'>binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>binds</span>
<a name="line-18"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeDups</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>binders</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-comment'>-- dups_ext checks for names with different uniques</span>
<a name="line-21"></a>    <span class='hs-comment'>-- but but the same External name M.n.  We don't</span>
<a name="line-22"></a>    <span class='hs-comment'>-- allow this at top level:</span>
<a name="line-23"></a>    <span class='hs-comment'>--    M.n{r3}  = ...</span>
<a name="line-24"></a>    <span class='hs-comment'>--    M.n{r29} = ...</span>
<a name="line-25"></a>    <span class='hs-comment'>-- because they both get the same linker symbol</span>
<a name="line-26"></a>    <span class='hs-varid'>ext_dups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeDups</span> <span class='hs-varid'>ord_ext</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>    <span class='hs-varid'>ord_ext</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>n1</span>
<a name="line-28"></a>                  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>n2</span>
<a name="line-29"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-33"></a>    <span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-34"></a>    <span class='hs-varid'>lint_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintSingleBinding</span> <span class='hs-conid'>TopLevel</span> <span class='hs-conid'>Recursive</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span>
<a name="line-35"></a>    <span class='hs-varid'>lint_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintSingleBinding</span> <span class='hs-conid'>TopLevel</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[lintUnfolding]{lintUnfolding}
%*                                                                      *
%************************************************************************

We use this to check all unfoldings that come in from interfaces
(it is very painful to catch errors otherwise):

\begin{code}
<pre><a name="line-1"></a><a name="lintUnfolding"></a><span class='hs-definition'>lintUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-2"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Treat these as in scope</span>
<a name="line-3"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>MsgDoc</span>   <span class='hs-comment'>-- Nothing =&gt; OK</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>lintUnfolding</span> <span class='hs-varid'>locn</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>expr</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprMessageBag</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initL</span> <span class='hs-layout'>(</span><span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportedUnfolding</span> <span class='hs-varid'>locn</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-11"></a>                            <span class='hs-varid'>addInScopeVars</span> <span class='hs-varid'>vars</span>            <span class='hs-varop'>$</span>
<a name="line-12"></a>                            <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="lintExpr"></a><span class='hs-definition'>lintExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>               <span class='hs-comment'>-- Treat these as in scope</span>
<a name="line-15"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-16"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>MsgDoc</span>        <span class='hs-comment'>-- Nothing =&gt; OK</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>lintExpr</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>expr</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprMessageBag</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initL</span> <span class='hs-layout'>(</span><span class='hs-varid'>addLoc</span> <span class='hs-conid'>TopLevelBindings</span> <span class='hs-varop'>$</span>
<a name="line-23"></a>                            <span class='hs-varid'>addInScopeVars</span> <span class='hs-varid'>vars</span>     <span class='hs-varop'>$</span>
<a name="line-24"></a>                            <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[lintCoreBinding]{lintCoreBinding}
%*                                                                      *
%************************************************************************

Check a core binding, returning the list of variables bound.

\begin{code}
<pre><a name="line-1"></a><a name="lintSingleBinding"></a><span class='hs-definition'>lintSingleBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-4"></a><span class='hs-definition'>lintSingleBinding</span> <span class='hs-varid'>top_lvl_flag</span> <span class='hs-varid'>rec_flag</span> <span class='hs-layout'>(</span><span class='hs-varid'>binder</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>RhsOf</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-6"></a>         <span class='hs-comment'>-- Check the rhs</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintBinder</span> <span class='hs-varid'>binder</span> <span class='hs-comment'>-- Check match to RHS type</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>binder_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applySubstTy</span> <span class='hs-varid'>binder_ty</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>binder_ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRhsMsg</span> <span class='hs-varid'>binder</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"RHS"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-comment'>-- Check (not isUnLiftedType) (also checks for bogus unboxed tuples)</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>binder_ty</span><span class='hs-layout'>)</span>
<a name="line-14"></a>            <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNonRec</span> <span class='hs-varid'>rec_flag</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>exprOkForSpeculation</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>mkRhsPrimMsg</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-comment'>-- Check that if the binder is top-level or recursive, it's not demanded</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrictId</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span>
<a name="line-19"></a>            <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNonRec</span> <span class='hs-varid'>rec_flag</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl_flag</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>mkStrictMsg</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-comment'>-- Check that if the binder is local, it is not marked as exported</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExportedId</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl_flag</span><span class='hs-layout'>)</span>
<a name="line-24"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>mkNonTopExportedMsg</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-comment'>-- Check that if the binder is local, it does not have an external name</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl_flag</span><span class='hs-layout'>)</span>
<a name="line-27"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>mkNonTopExternalNameMsg</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- Check whether binder's specialisations contain any out-of-scope variables</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkBndrIdInScope</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr_vars</span>
<a name="line-31"></a>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrongLoopBreaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>idOccInfo</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isInlinePragma</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-33"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>addWarnL</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"INLINE binder is (non-rule) loop breaker:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>              <span class='hs-comment'>-- Only non-rule loop breakers inhibit inlining</span>
<a name="line-35"></a>
<a name="line-36"></a>      <span class='hs-comment'>-- Check whether arity and demand type are consistent (only if demand analysis</span>
<a name="line-37"></a>      <span class='hs-comment'>-- already happened)</span>
<a name="line-38"></a>      <span class='hs-comment'>--</span>
<a name="line-39"></a>      <span class='hs-comment'>-- Note (Apr 2014): this is actually ok.  See Note [Demand analysis for trivial right-hand sides]</span>
<a name="line-40"></a>      <span class='hs-comment'>--                  in DmdAnal.  After eta-expansion in CorePrep the rhs is no longer trivial.</span>
<a name="line-41"></a>      <span class='hs-comment'>--       ; let dmdTy = idStrictness binder</span>
<a name="line-42"></a>      <span class='hs-comment'>--       ; checkL (case dmdTy of</span>
<a name="line-43"></a>      <span class='hs-comment'>--                  StrictSig dmd_ty -&gt; idArity binder &gt;= dmdTypeDepth dmd_ty || exprIsTrivial rhs)</span>
<a name="line-44"></a>      <span class='hs-comment'>--           (mkArityMsg binder)</span>
<a name="line-45"></a>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintIdUnfolding</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>binder_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnfolding</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-comment'>-- We should check the unfolding, if any, but this is tricky because</span>
<a name="line-49"></a>        <span class='hs-comment'>-- the unfolding is a SimplifiableCoreExpr. Give up for now.</span>
<a name="line-50"></a>   <span class='hs-keyword'>where</span>
<a name="line-51"></a>    <span class='hs-varid'>binder_ty</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>binder</span>
<a name="line-52"></a>    <span class='hs-varid'>bndr_vars</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>idFreeVars</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-55"></a>    <span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-56"></a>    <span class='hs-varid'>lintBinder</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>var</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintIdBndr</span> <span class='hs-varid'>var</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-57"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="lintIdUnfolding"></a><span class='hs-definition'>lintIdUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-60"></a><span class='hs-definition'>lintIdUnfolding</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStableSource</span> <span class='hs-varid'>src</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>bndr_ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRhsMsg</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"unfolding"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-64"></a><span class='hs-definition'>lintIdUnfolding</span>  <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>       <span class='hs-comment'>-- We could check more</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[lintCoreExpr]{lintCoreExpr}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="InType"></a><span class='hs-comment'>--type InKind      = Kind       -- Substitution not yet applied</span>
<a name="line-2"></a><a name="InType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-3"></a><a name="InCoercion"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InCoercion</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>
<a name="line-4"></a><a name="InVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InVar</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span>
<a name="line-5"></a><a name="InTyVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InTyVar</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVar</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="OutKind"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutKind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Kind</span> <span class='hs-comment'>-- Substitution has been applied to this,</span>
<a name="line-8"></a>                        <span class='hs-comment'>-- but has not been linted yet</span>
<a name="line-9"></a><a name="LintedKind"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>LintedKind</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Kind</span> <span class='hs-comment'>-- Substitution applied, and type is linted</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="OutType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutType</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- Substitution has been applied to this,</span>
<a name="line-12"></a>                        <span class='hs-comment'>-- but has not been linted yet</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="LintedType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>LintedType</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- Substitution applied, and type is linted</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="OutCoercion"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>
<a name="line-17"></a><a name="OutVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutVar</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span>
<a name="line-18"></a><a name="OutTyVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutTyVar</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVar</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="lintCoreExpr"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>OutType</span>
<a name="line-21"></a><span class='hs-comment'>-- The returned type has the substitution from the monad</span>
<a name="line-22"></a><span class='hs-comment'>-- already applied to it:</span>
<a name="line-23"></a><span class='hs-comment'>--      lintCoreExpr e subst = exprType (subst e)</span>
<a name="line-24"></a><span class='hs-comment'>--</span>
<a name="line-25"></a><span class='hs-comment'>-- The returned "type" can be a kind, if the expression is (Type ty)</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-28"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-29"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>oneTupleDataConId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal one-tuple"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>isId</span> <span class='hs-varid'>var</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoVar</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non term variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkDeadIdOcc</span> <span class='hs-varid'>var</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>var'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIdInScope</span> <span class='hs-varid'>var</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>var'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>literalType</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>expr</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applySubstCo</span> <span class='hs-varid'>co</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>from_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>to_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co'</span>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co'</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>r</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>from_ty</span> <span class='hs-varid'>expr_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastErr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co'</span> <span class='hs-varid'>from_ty</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>)</span>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>to_ty</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-conid'>Breakpoint</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>forM_</span> <span class='hs-varid'>ids</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-53"></a>         <span class='hs-varid'>checkDeadIdOcc</span> <span class='hs-varid'>id</span>
<a name="line-54"></a>         <span class='hs-varid'>lookupIdInScope</span> <span class='hs-varid'>id</span>
<a name="line-55"></a>       <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>expr</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-sel'>_other_tickish</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>expr</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- See Note [Linting type lets]</span>
<a name="line-63"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applySubstTy</span> <span class='hs-varid'>ty</span>
<a name="line-64"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>lintTyBndr</span> <span class='hs-varid'>tv</span>              <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-65"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>RhsOf</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkTyKind</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>ty'</span>
<a name="line-66"></a>                <span class='hs-comment'>-- Now extend the substitution so we</span>
<a name="line-67"></a>                <span class='hs-comment'>-- take advantage of it in the body</span>
<a name="line-68"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>extendSubstL</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>ty'</span>       <span class='hs-varop'>$</span>
<a name="line-69"></a>          <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyOfLetRec</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-70"></a>          <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndr</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>lintSingleBinding</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyOfLetRec</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bndr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-76"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>lintAndScopeId</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-77"></a>
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLetErr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Not quite accurate</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintAndScopeIds</span> <span class='hs-varid'>bndrs</span>       <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-83"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupVars</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span>
<a name="line-84"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintSingleBinding</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-conid'>Recursive</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span>
<a name="line-85"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyOfLetRec</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>  <span class='hs-keyword'>where</span>
<a name="line-87"></a>    <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pairs</span>
<a name="line-88"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeDups</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>bndrs</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-91"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>fun</span>
<a name="line-92"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>lintCoreArg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-93"></a>  <span class='hs-keyword'>where</span>
<a name="line-94"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>e</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>var</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LambdaBodyOf</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-98"></a>    <span class='hs-varid'>lintBinder</span> <span class='hs-varid'>var</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>var'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-99"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>expr</span>
<a name="line-100"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>var'</span> <span class='hs-keyword'>then</span>
<a name="line-101"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>var'</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span>
<a name="line-102"></a>         <span class='hs-keyword'>else</span>
<a name="line-103"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>var'</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span>
<a name="line-104"></a>       <span class='hs-layout'>}</span>
<a name="line-105"></a>        <span class='hs-comment'>-- The applySubstTy is needed to apply the subst to var</span>
<a name="line-106"></a>
<a name="line-107"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>var</span> <span class='hs-varid'>alt_ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-108"></a>       <span class='hs-comment'>-- Check the scrutinee</span>
<a name="line-109"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>scrut</span>
<a name="line-110"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>alt_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintInTy</span> <span class='hs-varid'>alt_ty</span>
<a name="line-111"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>var_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintInTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a>     <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-114"></a>         <span class='hs-conid'>Just</span> <span class='hs-varid'>tycon</span>
<a name="line-115"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-116"></a>                <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-117"></a>                <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-118"></a>                <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-119"></a>                  <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"Lint warning: case binder's type has no constructors"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>var</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-120"></a>                        <span class='hs-comment'>-- This can legitimately happen for type families</span>
<a name="line-121"></a>                      <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-122"></a>         <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-123"></a>
<a name="line-124"></a>        <span class='hs-comment'>-- Don't use lintIdBndr on var, because unboxed tuple is legitimate</span>
<a name="line-125"></a>
<a name="line-126"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTvSubst</span>
<a name="line-127"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>var_ty</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkScrutMsg</span> <span class='hs-varid'>var</span> <span class='hs-varid'>var_ty</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-128"></a>
<a name="line-129"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>lintAndScopeId</span> <span class='hs-varid'>var</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-130"></a>       <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Check the alternatives</span>
<a name="line-131"></a>            <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintCoreAlt</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-132"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>checkCaseAlts</span> <span class='hs-varid'>e</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alts</span>
<a name="line-133"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>alt_ty</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-comment'>-- This case can't happen; linting types in expressions gets routed through</span>
<a name="line-136"></a><span class='hs-comment'>-- lintCoreArgs</span>
<a name="line-137"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"lintCoreExpr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-definition'>lintCoreExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-141"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-sel'>_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintInCo</span> <span class='hs-varid'>co</span>
<a name="line-142"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionType</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-143"></a>
</pre>\end{code}

Note [Kind instantiation in coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following coercion axiom:
  ax_co [(k_ag :: BOX), (f_aa :: k_ag -> Constraint)] :: T k_ag f_aa ~ f_aa

Consider the following instantiation:
  ax_co <* -> *> <Monad>

We need to split the co_ax_tvs into kind and type variables in order
to find out the coercion kind instantiations. Those can only be Refl
since we don't have kind coercions. This is just a way to represent
kind instantiation.

We use the number of kind variables to know how to split the coercions
instantiations between kind coercions and type coercions. We lint the
kind coercions and produce the following substitution which is to be
applied in the type variables:
  k_ag   ~~>   * -> *

%************************************************************************
%*                                                                      *
\subsection[lintCoreArgs]{lintCoreArgs}
%*                                                                      *
%************************************************************************

The basic version of these functions checks that the argument is a
subtype of the required type, as one would expect.

\begin{code}
<pre><a name="line-1"></a><a name="lintCoreArg"></a><span class='hs-definition'>lintCoreArg</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>OutType</span>
<a name="line-2"></a><span class='hs-definition'>lintCoreArg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applySubstTy</span> <span class='hs-varid'>arg_ty</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintTyApp</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty'</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>lintCoreArg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>arg</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintValApp</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="lintAltBinders"></a><span class='hs-comment'>-----------------</span>
<a name="line-11"></a><span class='hs-definition'>lintAltBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutType</span>     <span class='hs-comment'>-- Scrutinee type</span>
<a name="line-12"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span>     <span class='hs-comment'>-- Constructor type</span>
<a name="line-13"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OutVar</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Binders</span>
<a name="line-14"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-15"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-16"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-17"></a><span class='hs-definition'>lintAltBinders</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>con_ty</span> <span class='hs-conid'>[]</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>con_ty</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBadPatMsg</span> <span class='hs-varid'>con_ty</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>lintAltBinders</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>con_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-conop'>:</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>bndr</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintTyApp</span> <span class='hs-varid'>con_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintAltBinders</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>con_ty'</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintValApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>con_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintAltBinders</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>con_ty'</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="lintTyApp"></a><span class='hs-comment'>-----------------</span>
<a name="line-28"></a><span class='hs-definition'>lintTyApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>OutType</span>
<a name="line-29"></a><span class='hs-definition'>lintTyApp</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span><span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>fun_ty</span>
<a name="line-31"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tyvar</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTyKind</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>arg_ty</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tyvar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyAppMsg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="lintValApp"></a><span class='hs-comment'>-----------------</span>
<a name="line-39"></a><span class='hs-definition'>lintValApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>OutType</span>
<a name="line-40"></a><span class='hs-definition'>lintValApp</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>fun_ty</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>err1</span>
<a name="line-43"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-varid'>err2</span>
<a name="line-46"></a>  <span class='hs-keyword'>where</span>
<a name="line-47"></a>    <span class='hs-varid'>err1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppMsg</span>       <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>arg</span>
<a name="line-48"></a>    <span class='hs-varid'>err2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNonFunAppMsg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>arg</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="checkTyKind"></a><span class='hs-definition'>checkTyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- Both args have had substitution applied</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-5"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-6"></a><span class='hs-definition'>checkTyKind</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>arg_ty</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSuperKind</span> <span class='hs-varid'>tyvar_kind</span>  <span class='hs-comment'>-- kind forall</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintKind</span> <span class='hs-varid'>arg_ty</span>
<a name="line-9"></a>        <span class='hs-comment'>-- Arg type might be boxed for a function with an uncommitted</span>
<a name="line-10"></a>        <span class='hs-comment'>-- tyvar; notably this is used so that we can give</span>
<a name="line-11"></a>        <span class='hs-comment'>--      error :: forall a:*. String -&gt; a</span>
<a name="line-12"></a>        <span class='hs-comment'>-- and then apply it to both boxed and unboxed types.</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- type forall</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>arg_ty</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>tyvar_kind</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>addErrL</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkKindErrMsg</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"xx"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>    <span class='hs-varid'>tyvar_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="checkDeadIdOcc"></a><span class='hs-definition'>checkDeadIdOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-21"></a><span class='hs-comment'>-- Occurrences of an Id should never be dead....</span>
<a name="line-22"></a><span class='hs-comment'>-- except when we are checking a case pattern</span>
<a name="line-23"></a><span class='hs-definition'>checkDeadIdOcc</span> <span class='hs-varid'>id</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDeadOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>idOccInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>in_case</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inCasePat</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-varid'>in_case</span>
<a name="line-27"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Occurrence of a dead Id"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection[lintCoreAlts]{lintCoreAlts}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="checkCaseAlts"></a><span class='hs-definition'>checkCaseAlts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreAlt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- a) Check that the alts are non-empty</span>
<a name="line-3"></a><span class='hs-comment'>-- b1) Check that the DEFAULT comes first, if it exists</span>
<a name="line-4"></a><span class='hs-comment'>-- b2) Check that the others are in increasing order</span>
<a name="line-5"></a><span class='hs-comment'>-- c) Check that there's a default for infinite types</span>
<a name="line-6"></a><span class='hs-comment'>-- NB: Algebraic cases are not necessarily exhaustive, because</span>
<a name="line-7"></a><span class='hs-comment'>--     the simplifer correctly eliminates case that can't</span>
<a name="line-8"></a><span class='hs-comment'>--     possibly match.</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>checkCaseAlts</span> <span class='hs-varid'>e</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span> <span class='hs-keyglyph'>=</span>
<a name="line-11"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>non_deflt</span> <span class='hs-varid'>con_alts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonDefltMsg</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-12"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>increasing_tag</span> <span class='hs-varid'>con_alts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonIncreasingAltsMsg</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a>          <span class='hs-comment'>-- For types Int#, Word# with an infinite (well, large!) number of</span>
<a name="line-15"></a>          <span class='hs-comment'>-- possible values, there should usually be a DEFAULT case</span>
<a name="line-16"></a>          <span class='hs-comment'>-- But (see Note [Empty case alternatives] in CoreSyn) it's ok to</span>
<a name="line-17"></a>          <span class='hs-comment'>-- have *no* case alternatives.</span>
<a name="line-18"></a>          <span class='hs-comment'>-- In effect, this is a kind of partial test. I suppose it's possible</span>
<a name="line-19"></a>          <span class='hs-comment'>-- that we might *know* that 'x' was 1 or 2, in which case</span>
<a name="line-20"></a>          <span class='hs-comment'>--   case x of { 1 -&gt; e1; 2 -&gt; e2 }</span>
<a name="line-21"></a>          <span class='hs-comment'>-- would be fine.</span>
<a name="line-22"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>maybe_deflt</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_infinite_ty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>null</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-23"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>nonExhaustiveAltsMsg</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>  <span class='hs-keyword'>where</span>
<a name="line-25"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>con_alts</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_deflt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDefault</span> <span class='hs-varid'>alts</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-comment'>-- Check that successive alternatives have increasing tags</span>
<a name="line-28"></a>    <span class='hs-varid'>increasing_tag</span> <span class='hs-layout'>(</span><span class='hs-varid'>alt1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span> <span class='hs-varid'>alt2</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alt1</span> <span class='hs-varop'>`ltAlt`</span> <span class='hs-varid'>alt2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>increasing_tag</span> <span class='hs-varid'>rest</span>
<a name="line-29"></a>    <span class='hs-varid'>increasing_tag</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-30"></a>
<a name="line-31"></a>    <span class='hs-varid'>non_deflt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-32"></a>    <span class='hs-varid'>non_deflt</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-33"></a>
<a name="line-34"></a>    <span class='hs-varid'>is_infinite_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-35"></a>                        <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-36"></a>                        <span class='hs-conid'>Just</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tycon</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="checkAltExpr"></a><span class='hs-definition'>checkAltExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>checkAltExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>ann_ty</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>actual_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoreExpr</span> <span class='hs-varid'>expr</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>ann_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCaseAltMsg</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>ann_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="lintCoreAlt"></a><span class='hs-definition'>lintCoreAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutType</span>          <span class='hs-comment'>-- Type of scrutinee</span>
<a name="line-7"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span>          <span class='hs-comment'>-- Type of the alternative</span>
<a name="line-8"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreAlt</span>
<a name="line-9"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-10"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-11"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-12"></a><span class='hs-definition'>lintCoreAlt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alt_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-13"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDefaultArgsMsg</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-14"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>checkAltExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>alt_ty</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>lintCoreAlt</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alt_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitAlt</span> <span class='hs-varid'>lit</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>litIsLifted</span> <span class='hs-varid'>lit</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-varid'>integerScrutinisedMsg</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDefaultArgsMsg</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTys</span> <span class='hs-varid'>lit_ty</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBadPatMsg</span> <span class='hs-varid'>lit_ty</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>)</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkAltExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>alt_ty</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>  <span class='hs-keyword'>where</span>
<a name="line-24"></a>    <span class='hs-varid'>lit_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>literalType</span> <span class='hs-varid'>lit</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>lintCoreAlt</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alt_ty</span> <span class='hs-varid'>alt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrL</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNewTyDataConAltMsg</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alt</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tycon_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>scrut_ty</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>alt</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>  <span class='hs-keyword'>do</span>
<a name="line-31"></a>    <span class='hs-layout'>{</span>   <span class='hs-comment'>-- First instantiate the universally quantified</span>
<a name="line-32"></a>        <span class='hs-comment'>-- type variables of the data constructor</span>
<a name="line-33"></a>        <span class='hs-comment'>-- We've already check</span>
<a name="line-34"></a>      <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBadConMsg</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>con_payload_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConRepType</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>tycon_arg_tys</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-comment'>-- And now bring the new binders into scope</span>
<a name="line-38"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>lintBinders</span> <span class='hs-varid'>args</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-39"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CasePat</span> <span class='hs-varid'>alt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintAltBinders</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>con_payload_ty</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span>
<a name="line-40"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>checkAltExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>alt_ty</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Scrut-ty is wrong shape</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrL</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBadAltMsg</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alt</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[lint-types]{Types}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="lintBinders"></a><span class='hs-comment'>-- When we lint binders, we (one at a time and in order):</span>
<a name="line-2"></a><span class='hs-comment'>--  1. Lint var types or kinds (possibly substituting)</span>
<a name="line-3"></a><span class='hs-comment'>--  2. Add the binder to the in scope set, and if its a coercion var,</span>
<a name="line-4"></a><span class='hs-comment'>--     we may extend the substitution to reflect its (possibly) new kind</span>
<a name="line-5"></a><span class='hs-definition'>lintBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-6"></a><span class='hs-definition'>lintBinders</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>linterF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>linterF</span> <span class='hs-conid'>[]</span>
<a name="line-7"></a><span class='hs-definition'>lintBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>var</span><span class='hs-conop'>:</span><span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>linterF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintBinder</span> <span class='hs-varid'>var</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>var'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-8"></a>                                 <span class='hs-varid'>lintBinders</span> <span class='hs-varid'>vars</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>vars'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-9"></a>                                 <span class='hs-varid'>linterF</span> <span class='hs-layout'>(</span><span class='hs-varid'>var'</span><span class='hs-conop'>:</span><span class='hs-varid'>vars'</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="lintBinder"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-12"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-13"></a><span class='hs-definition'>lintBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-14"></a><span class='hs-definition'>lintBinder</span> <span class='hs-varid'>var</span> <span class='hs-varid'>linterF</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>var</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintIdBndr</span> <span class='hs-varid'>var</span> <span class='hs-varid'>linterF</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintTyBndr</span> <span class='hs-varid'>var</span> <span class='hs-varid'>linterF</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="lintTyBndr"></a><span class='hs-definition'>lintTyBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-19"></a><span class='hs-definition'>lintTyBndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>thing_inside</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTvSubst</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintTyBndrKind</span> <span class='hs-varid'>tv'</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updateTvSubst</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="lintIdBndr"></a><span class='hs-definition'>lintIdBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-26"></a><span class='hs-comment'>-- Do substitution on the type of a binder and add the var with this</span>
<a name="line-27"></a><span class='hs-comment'>-- new type to the in-scope set of the second argument</span>
<a name="line-28"></a><span class='hs-comment'>-- ToDo: lint its rules</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>lintIdBndr</span> <span class='hs-varid'>id</span> <span class='hs-varid'>linterF</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>lintAndScopeId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>id'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>linterF</span> <span class='hs-varid'>id'</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="lintAndScopeIds"></a><span class='hs-definition'>lintAndScopeIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-34"></a><span class='hs-definition'>lintAndScopeIds</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>linterF</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ids</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>linterF</span> <span class='hs-conid'>[]</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-conop'>:</span><span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintAndScopeId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-39"></a>                  <span class='hs-varid'>lintAndScopeIds</span> <span class='hs-varid'>ids</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ids</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-40"></a>                  <span class='hs-varid'>linterF</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-conop'>:</span><span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="lintAndScopeId"></a><span class='hs-definition'>lintAndScopeId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-43"></a><span class='hs-definition'>lintAndScopeId</span> <span class='hs-varid'>id</span> <span class='hs-varid'>linterF</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintInTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>id'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdType</span> <span class='hs-varid'>id</span> <span class='hs-varid'>ty</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addInScopeVar</span> <span class='hs-varid'>id'</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>linterF</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
             Types and kinds
%*                                                                      *
%************************************************************************

We have a single linter for types and kinds.  That is convenient
because sometimes it's not clear whether the thing we are looking
at is a type or a kind.

\begin{code}
<pre><a name="line-1"></a><a name="lintInTy"></a><span class='hs-definition'>lintInTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>LintedType</span>
<a name="line-2"></a><span class='hs-comment'>-- Types only, not kinds</span>
<a name="line-3"></a><span class='hs-comment'>-- Check the type, and apply the substitution to it</span>
<a name="line-4"></a><span class='hs-comment'>-- See Note [Linting type lets]</span>
<a name="line-5"></a><span class='hs-definition'>lintInTy</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applySubstTy</span> <span class='hs-varid'>ty</span>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-sel'>_k</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>ty'</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="lintTyBndrKind"></a><span class='hs-comment'>-------------------</span>
<a name="line-12"></a><span class='hs-definition'>lintTyBndrKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-13"></a><span class='hs-comment'>-- Handles both type and kind foralls.</span>
<a name="line-14"></a><span class='hs-definition'>lintTyBndrKind</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="lintType"></a><span class='hs-comment'>-------------------</span>
<a name="line-17"></a><span class='hs-definition'>lintType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>LintedKind</span>
<a name="line-18"></a><span class='hs-comment'>-- The returned Kind has itself been linted</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-21"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-22"></a><span class='hs-definition'>lintType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTyCoVarInScope</span> <span class='hs-varid'>tv</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>         <span class='hs-comment'>-- We checked its kind when we added it to the envt</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>lintType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>t1</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>t2</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lint_ty_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>t2</span><span class='hs-layout'>,</span><span class='hs-varid'>k2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-definition'>lintType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- (-&gt;) has two different rules, for types and kinds</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>t1</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>t2</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintArrow</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type or kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>lintType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-39"></a>       <span class='hs-comment'>-- Check that primitive types are saturated</span>
<a name="line-40"></a>       <span class='hs-comment'>-- See Note [The kind invariant] in TypeRep</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>tys</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lint_ty_app</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>lintType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lintTyBndrKind</span> <span class='hs-varid'>tv</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addInScopeVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-definition'>lintType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintTyLit</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="lintKind"></a><span class='hs-definition'>lintKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-4"></a><span class='hs-definition'>lintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>k</span>
<a name="line-5"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSuperKind</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span>
<a name="line-6"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>addErrL</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Ill-kinded kind:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-7"></a>                                      <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has kind:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="lintArrow"></a><span class='hs-definition'>lintArrow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintedKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintedKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>LintedKind</span>
<a name="line-2"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-4"></a><span class='hs-definition'>lintArrow</span> <span class='hs-varid'>what</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>   <span class='hs-comment'>-- Eg lintArrow "type or kind `blah'" k1 k2</span>
<a name="line-5"></a>                       <span class='hs-comment'>-- or lintarrow "coercion `blah'" k1 k2</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSuperKind</span> <span class='hs-varid'>k1</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>superKind</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>okArrowArgKind</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-varid'>addErrL</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>okArrowResultKind</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErrL</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"result"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-varid'>k2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>msg</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>k</span>
<a name="line-14"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Ill-kinded"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ar</span><span class='hs-layout'>)</span>
<a name="line-15"></a>                  <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span><span class='hs-layout'>)</span>
<a name="line-16"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>]</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="lint_ty_app"></a><span class='hs-definition'>lint_ty_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintedKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LintedType</span><span class='hs-layout'>,</span><span class='hs-conid'>LintedKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>LintedKind</span>
<a name="line-19"></a><span class='hs-definition'>lint_ty_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lint_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="lint_co_app"></a><span class='hs-comment'>----------------</span>
<a name="line-23"></a><span class='hs-definition'>lint_co_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintedKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LintedType</span><span class='hs-layout'>,</span><span class='hs-conid'>LintedKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>LintedKind</span>
<a name="line-24"></a><span class='hs-definition'>lint_co_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lint_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"coercion"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="lintTyLit"></a><span class='hs-comment'>----------------</span>
<a name="line-28"></a><span class='hs-definition'>lintTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-29"></a><span class='hs-definition'>lintTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-varid'>msg</span>
<a name="line-32"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Negative type literal:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>integer</span> <span class='hs-varid'>n</span>
<a name="line-33"></a><span class='hs-definition'>lintTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="lint_app"></a><span class='hs-definition'>lint_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintedKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LintedType</span><span class='hs-layout'>,</span><span class='hs-conid'>LintedKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>Kind</span>
<a name="line-36"></a><span class='hs-comment'>-- (lint_app d fun_kind arg_tys)</span>
<a name="line-37"></a><span class='hs-comment'>--    We have an application (f arg_ty1 .. arg_tyn),</span>
<a name="line-38"></a><span class='hs-comment'>--    where f :: fun_kind</span>
<a name="line-39"></a><span class='hs-comment'>-- Takes care of linting the OutTypes</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-42"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-43"></a><span class='hs-definition'>lint_app</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kfn</span> <span class='hs-varid'>kas</span>
<a name="line-44"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>kfn</span> <span class='hs-varid'>kas</span>
<a name="line-45"></a>  <span class='hs-keyword'>where</span>
<a name="line-46"></a>    <span class='hs-varid'>fail_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind application error in"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-varid'>doc</span>
<a name="line-47"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Function kind ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kfn</span><span class='hs-layout'>)</span>
<a name="line-48"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arg kinds ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kas</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-49"></a>
<a name="line-50"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>kfn</span> <span class='hs-varid'>ka</span>
<a name="line-51"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kfn'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>kfn</span>
<a name="line-52"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>kfn'</span> <span class='hs-varid'>ka</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>kfa</span> <span class='hs-varid'>kfb</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ka</span><span class='hs-layout'>)</span>
<a name="line-55"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>ka</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>kfa</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErrL</span> <span class='hs-varid'>fail_msg</span><span class='hs-layout'>)</span>
<a name="line-56"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kfb</span> <span class='hs-layout'>}</span>
<a name="line-57"></a>
<a name="line-58"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>kv</span> <span class='hs-varid'>kfn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ta</span><span class='hs-layout'>,</span><span class='hs-varid'>ka</span><span class='hs-layout'>)</span>
<a name="line-59"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>ka</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErrL</span> <span class='hs-varid'>fail_msg</span><span class='hs-layout'>)</span>
<a name="line-60"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>substKiWith</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ta</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>kfn</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-varid'>fail_msg</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
         Linting coercions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="lintInCo"></a><span class='hs-definition'>lintInCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LintedKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>LintedType</span><span class='hs-layout'>,</span> <span class='hs-conid'>LintedType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Check the coercion, and apply the substitution to it</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [Linting type lets]</span>
<a name="line-4"></a><span class='hs-definition'>lintInCo</span> <span class='hs-varid'>co</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-6"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applySubstCo</span> <span class='hs-varid'>co</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co'</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="lintCoercion"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LintedKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>LintedType</span><span class='hs-layout'>,</span> <span class='hs-conid'>LintedType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-comment'>-- Check the kind of a coercion term, returning the kind</span>
<a name="line-11"></a><span class='hs-comment'>-- Post-condition: the returned OutTypes are lint-free</span>
<a name="line-12"></a><span class='hs-comment'>--                 and have the same kind as each other</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-15"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-16"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span><span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cos</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co1</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k2</span><span class='hs-layout'>,</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co2</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintArrow</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"coercion"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>r</span> <span class='hs-varid'>r1</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>r</span> <span class='hs-varid'>r2</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rk</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConDefn_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Synonym in TyConAppCo:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ks</span><span class='hs-layout'>,</span><span class='hs-varid'>ss</span><span class='hs-layout'>,</span><span class='hs-varid'>ts</span><span class='hs-layout'>,</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzip4M</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>cos</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lint_co_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ss</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>rs</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rk</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co1</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k2</span><span class='hs-layout'>,</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co2</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lint_co_app</span> <span class='hs-varid'>co</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>k2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-43"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Phantom</span>
<a name="line-44"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Phantom</span> <span class='hs-varop'>||</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Second argument in AppCo cannot be R:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-46"></a>                      <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-47"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>r2</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>rk</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lintTyBndrKind</span> <span class='hs-varid'>tv</span>
<a name="line-52"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addInScopeVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad CoVarCo:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-58"></a>                  <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"With offending type:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTyCoVarInScope</span> <span class='hs-varid'>cv</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIdInScope</span> <span class='hs-varid'>cv</span>
<a name="line-62"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarKind</span> <span class='hs-varid'>cv'</span>
<a name="line-63"></a>             <span class='hs-varid'>k</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>s</span>
<a name="line-64"></a>             <span class='hs-varid'>r</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv'</span>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSuperKind</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-66"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non-nominal kind equality"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                                     <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-68"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non-refl kind equality"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-69"></a>                                     <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-70"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>ty1</span>
<a name="line-74"></a>       <span class='hs-layout'>;</span> <span class='hs-sel'>_k2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>ty2</span>
<a name="line-75"></a><span class='hs-comment'>--       ; unless (k1 `eqKind` k2) $</span>
<a name="line-76"></a><span class='hs-comment'>--         failWithL (hang (ptext (sLit "Unsafe coercion changes kind"))</span>
<a name="line-77"></a><span class='hs-comment'>--                       2 (ppr co))</span>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co1</span>
<a name="line-86"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>  <span class='hs-varid'>ty2a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>,</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co2</span>
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1b</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Trans coercion mis-match:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-89"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-90"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>the_co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co</span>
<a name="line-95"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-96"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys_s</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_t</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys_t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-97"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc_s</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc_t</span>
<a name="line-98"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>tys_s</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys_t</span>
<a name="line-99"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys_s</span>
<a name="line-100"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ks</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tr</span><span class='hs-layout'>)</span>
<a name="line-101"></a>             <span class='hs-keyword'>where</span>
<a name="line-102"></a>               <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getNth</span> <span class='hs-varid'>tys_s</span> <span class='hs-varid'>n</span>
<a name="line-103"></a>               <span class='hs-varid'>tt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getNth</span> <span class='hs-varid'>tys_t</span> <span class='hs-varid'>n</span>
<a name="line-104"></a>               <span class='hs-varid'>tr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc_s</span> <span class='hs-varid'>n</span>
<a name="line-105"></a>               <span class='hs-varid'>ks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ts</span>
<a name="line-106"></a>
<a name="line-107"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad getNth:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-108"></a>                              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_co</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>the_co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>r</span>
<a name="line-113"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-114"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>s_pr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t_pr</span><span class='hs-layout'>)</span>
<a name="line-115"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>s_pick</span><span class='hs-layout'>,</span> <span class='hs-varid'>t_pick</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-116"></a>             <span class='hs-keyword'>where</span>
<a name="line-117"></a>               <span class='hs-varid'>s_pick</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>s_pr</span>
<a name="line-118"></a>               <span class='hs-varid'>t_pick</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>t_pr</span>
<a name="line-119"></a>               <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>s_pick</span>
<a name="line-120"></a>
<a name="line-121"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad LRCo:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-122"></a>                              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_co</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co</span>
<a name="line-126"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_kind</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>arg_ty</span>
<a name="line-127"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-128"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-129"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span>
<a name="line-130"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWith</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span>
<a name="line-131"></a>                          <span class='hs-varid'>substTyWith</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-132"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-133"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind mis-match in inst coercion"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-134"></a>          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad argument of inst"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-135"></a>
<a name="line-136"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-137"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>brListLength</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-138"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>bad_ax</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"index out of range"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-139"></a>         <span class='hs-comment'>-- See Note [Kind instantiation in coercions]</span>
<a name="line-140"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ktvs</span>
<a name="line-141"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span>
<a name="line-142"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-143"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span>
<a name="line-144"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>equalLength</span> <span class='hs-varid'>ktvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bad_ax</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"lengths"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-145"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInScope</span>
<a name="line-146"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>empty_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyTvSubstEnv</span>
<a name="line-147"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_l</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst_r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>check_ki</span>
<a name="line-148"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>empty_subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty_subst</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>zip3</span> <span class='hs-varid'>ktvs</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-150"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lhs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>subst_l</span> <span class='hs-varid'>lhs</span>
<a name="line-151"></a>             <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst_r</span> <span class='hs-varid'>rhs</span>
<a name="line-152"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkAxInstCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-153"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>bad_branch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bad_ax</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inconsistent with"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCoAxBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>bad_branch</span><span class='hs-layout'>)</span>
<a name="line-154"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-155"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-156"></a>  <span class='hs-keyword'>where</span>
<a name="line-157"></a>    <span class='hs-varid'>bad_ax</span> <span class='hs-varid'>what</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrL</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad axiom application"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>what</span><span class='hs-layout'>)</span>
<a name="line-158"></a>                        <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-159"></a>
<a name="line-160"></a>    <span class='hs-varid'>check_ki</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_l</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst_r</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ktv</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-161"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co</span>
<a name="line-162"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co</span> <span class='hs-varid'>role</span> <span class='hs-varid'>r</span>
<a name="line-163"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ktv_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst_l</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>ktv</span><span class='hs-layout'>)</span>
<a name="line-164"></a>                  <span class='hs-comment'>-- Using subst_l is ok, because subst_l and subst_r</span>
<a name="line-165"></a>                  <span class='hs-comment'>-- must agree on kind equalities</span>
<a name="line-166"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>ktv_kind</span><span class='hs-layout'>)</span>
<a name="line-167"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>bad_ax</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"check_ki2"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ktv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ktv_kind</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-168"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst_l</span> <span class='hs-varid'>ktv</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span>
<a name="line-169"></a>                     <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst_r</span> <span class='hs-varid'>ktv</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span>
<a name="line-172"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>co'</span>
<a name="line-173"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkRole</span> <span class='hs-varid'>co</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>r</span>
<a name="line-174"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-conid'>Representational</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-175"></a>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-definition'>lintCoercion</span> <span class='hs-varid'>this</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-sel'>_ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>ts</span>
<a name="line-179"></a>       <span class='hs-varid'>eqs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lintCoercion</span> <span class='hs-varid'>cs</span>
<a name="line-180"></a>
<a name="line-181"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>tyNum</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ts</span>
<a name="line-182"></a>
<a name="line-183"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrTypeArity</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyNum</span> <span class='hs-keyword'>of</span>
<a name="line-184"></a>         <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-185"></a>         <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>err</span> <span class='hs-str'>"Too many type arguments"</span>
<a name="line-186"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"expected"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrTypeArity</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-187"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"provided"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>tyNum</span> <span class='hs-keyglyph'>]</span>
<a name="line-188"></a>         <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>err</span> <span class='hs-str'>"Not enough type arguments"</span>
<a name="line-189"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"expected"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrTypeArity</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-190"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"provided"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>tyNum</span> <span class='hs-keyglyph'>]</span>
<a name="line-191"></a>       <span class='hs-varid'>checkRoles</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrAsmpRoles</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqs</span>
<a name="line-192"></a>
<a name="line-193"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>coaxrProves</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>l</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqs</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-194"></a>         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>err</span> <span class='hs-str'>"Malformed use of AxiomRuleCo"</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>this</span> <span class='hs-keyglyph'>]</span>
<a name="line-195"></a>         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>l</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-196"></a>           <span class='hs-keyword'>do</span> <span class='hs-varid'>kL</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>l</span>
<a name="line-197"></a>              <span class='hs-varid'>kR</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintType</span> <span class='hs-varid'>r</span>
<a name="line-198"></a>              <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqKind</span> <span class='hs-varid'>kL</span> <span class='hs-varid'>kR</span><span class='hs-layout'>)</span>
<a name="line-199"></a>                <span class='hs-varop'>$</span> <span class='hs-varid'>err</span> <span class='hs-str'>"Kind error in CoAxiomRule"</span>
<a name="line-200"></a>                       <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kL</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"/="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kR</span><span class='hs-keyglyph'>]</span>
<a name="line-201"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>kL</span><span class='hs-layout'>,</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>coaxrRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-202"></a>  <span class='hs-keyword'>where</span>
<a name="line-203"></a>  <span class='hs-varid'>txt</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sLit</span>
<a name="line-204"></a>  <span class='hs-varid'>err</span> <span class='hs-varid'>m</span> <span class='hs-varid'>xs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-varop'>$</span>
<a name="line-205"></a>                <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>txt</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>txt</span> <span class='hs-str'>"Rule:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrName</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-206"></a>
<a name="line-207"></a>  <span class='hs-varid'>checkRoles</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-conop'>:</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span>
<a name="line-208"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>e</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRoles</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span> <span class='hs-varid'>rs</span>
<a name="line-209"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-str'>"Argument roles mismatch"</span>
<a name="line-210"></a>                      <span class='hs-keyglyph'>[</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"In argument:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-211"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"Expected:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span>
<a name="line-212"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"Found:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>]</span>
<a name="line-213"></a>  <span class='hs-varid'>checkRoles</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-214"></a>  <span class='hs-varid'>checkRoles</span> <span class='hs-varid'>n</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>rs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-str'>"Too many coercion arguments"</span>
<a name="line-215"></a>                          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"Expected:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-216"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"Provided:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-217"></a>
<a name="line-218"></a>  <span class='hs-varid'>checkRoles</span> <span class='hs-varid'>n</span> <span class='hs-varid'>es</span> <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-str'>"Not enough coercion arguments"</span>
<a name="line-219"></a>                          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"Expected:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-220"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>txt</span> <span class='hs-str'>"Provided:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span>
<a name="line-221"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[lint-monad]{The Lint monad}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="LintM"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-3"></a><a name="LintM"></a><span class='hs-comment'>-- See Note [GHC Formalism]</span>
<a name="line-4"></a><a name="LintM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span>
<a name="line-5"></a>   <span class='hs-conid'>LintM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unLintM</span> <span class='hs-keyglyph'>::</span>
<a name="line-6"></a>            <span class='hs-keyglyph'>[</span><span class='hs-conid'>LintLocInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span>         <span class='hs-comment'>-- Locations</span>
<a name="line-7"></a>            <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span>               <span class='hs-comment'>-- Current type substitution; we also use this</span>
<a name="line-8"></a>                                     <span class='hs-comment'>-- to keep track of all the variables in scope,</span>
<a name="line-9"></a>                                     <span class='hs-comment'>-- both Ids and TyVars</span>
<a name="line-10"></a>            <span class='hs-conid'>WarnsAndErrs</span> <span class='hs-keyglyph'>-&gt;</span>           <span class='hs-comment'>-- Error and warning messages so far</span>
<a name="line-11"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>WarnsAndErrs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- Result and messages (if any)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="WarnsAndErrs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>WarnsAndErrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-comment'>{-      Note [Type substitution]
<a name="line-16"></a>        ~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-17"></a>Why do we need a type substitution?  Consider
<a name="line-18"></a>        /\(a:*). \(x:a). /\(a:*). id a x
<a name="line-19"></a>This is ill typed, because (renaming variables) it is really
<a name="line-20"></a>        /\(a:*). \(x:a). /\(b:*). id b x
<a name="line-21"></a>Hence, when checking an application, we can't naively compare x's type
<a name="line-22"></a>(at its binding site) with its expected type (at a use site).  So we
<a name="line-23"></a>rename type binders as we go, maintaining a substitution.
<a name="line-24"></a>
<a name="line-25"></a>The same substitution also supports let-type, current expressed as
<a name="line-26"></a>        (/\(a:*). body) ty
<a name="line-27"></a>Here we substitute 'ty' for 'a' in 'body', on the fly.
<a name="line-28"></a>-}</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>LintM</span> <span class='hs-keyword'>where</span>
<a name="line-31"></a>      <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>LintM</span> <span class='hs-keyword'>where</span>
<a name="line-34"></a>      <span class='hs-varid'>pure</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-35"></a>      <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>LintM</span> <span class='hs-keyword'>where</span>
<a name="line-38"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>     <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-41"></a>                       <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLintM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyword'>in</span>
<a name="line-42"></a>                         <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-43"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLintM</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs'</span>
<a name="line-44"></a>                           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="LintLocInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LintLocInfo</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RhsOf</span> <span class='hs-conid'>Id</span>            <span class='hs-comment'>-- The variable bound</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LambdaBodyOf</span> <span class='hs-conid'>Id</span>     <span class='hs-comment'>-- The lambda-binder</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BodyOfLetRec</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- One of the binders</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-conid'>CoreAlt</span>     <span class='hs-comment'>-- Case alternative</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CasePat</span> <span class='hs-conid'>CoreAlt</span>     <span class='hs-comment'>-- The *pattern* of the case alternative</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnExpr</span> <span class='hs-conid'>CoreExpr</span>     <span class='hs-comment'>-- Some expression</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportedUnfolding</span> <span class='hs-conid'>SrcLoc</span> <span class='hs-comment'>-- Some imported unfolding (ToDo: say which)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TopLevelBindings</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InType</span> <span class='hs-conid'>Type</span>         <span class='hs-comment'>-- Inside a type</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InCo</span>   <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Inside a coercion</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="initL"></a><span class='hs-definition'>initL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WarnsAndErrs</span>    <span class='hs-comment'>-- Errors and warnings</span>
<a name="line-2"></a><span class='hs-definition'>initL</span> <span class='hs-varid'>m</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unLintM</span> <span class='hs-varid'>m</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>emptyTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>errs</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="checkL"></a><span class='hs-definition'>checkL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>checkL</span> <span class='hs-conid'>True</span>  <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>checkL</span> <span class='hs-conid'>False</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithL</span> <span class='hs-varid'>msg</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="failWithL"></a><span class='hs-definition'>failWithL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-6"></a><span class='hs-definition'>failWithL</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span><span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-7"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>addMsg</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="addErrL"></a><span class='hs-definition'>addErrL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-10"></a><span class='hs-definition'>addErrL</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span><span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-11"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>addMsg</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="addWarnL"></a><span class='hs-definition'>addWarnL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-14"></a><span class='hs-definition'>addWarnL</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span><span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-15"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>addMsg</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>warns</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="addMsg"></a><span class='hs-definition'>addMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Bag</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LintLocInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-18"></a><span class='hs-definition'>addMsg</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>msgs</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>locs</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>notNull</span> <span class='hs-varid'>locs</span> <span class='hs-layout'>)</span>
<a name="line-20"></a>    <span class='hs-varid'>msgs</span> <span class='hs-varop'>`snocBag`</span> <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>msg</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cxt1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>locs</span><span class='hs-layout'>)</span>
<a name="line-23"></a>   <span class='hs-varid'>cxts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>dumpLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>locs</span><span class='hs-keyglyph'>]</span>
<a name="line-24"></a>   <span class='hs-varid'>context</span>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>cxts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cxt1</span> <span class='hs-varop'>$$</span>
<a name="line-25"></a>                                      <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Substitution:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span>
<a name="line-26"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cxt1</span>
<a name="line-27"></a>
<a name="line-28"></a>   <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocMessage</span> <span class='hs-conid'>SevWarning</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>context</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="addLoc"></a><span class='hs-definition'>addLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LintLocInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-31"></a><span class='hs-definition'>addLoc</span> <span class='hs-varid'>extra_loc</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span>
<a name="line-32"></a>  <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLintM</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra_loc</span><span class='hs-conop'>:</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="inCasePat"></a><span class='hs-definition'>inCasePat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>Bool</span>         <span class='hs-comment'>-- A slight hack; see the unique call site</span>
<a name="line-35"></a><span class='hs-definition'>inCasePat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_case_pat</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>is_case_pat</span> <span class='hs-layout'>(</span><span class='hs-conid'>CasePat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-38"></a>    <span class='hs-varid'>is_case_pat</span> <span class='hs-sel'>_other</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="addInScopeVars"></a><span class='hs-definition'>addInScopeVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-41"></a><span class='hs-definition'>addInScopeVars</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>m</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLintM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvInScopeList</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="addInScopeVar"></a><span class='hs-definition'>addInScopeVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-45"></a><span class='hs-definition'>addInScopeVar</span> <span class='hs-varid'>var</span> <span class='hs-varid'>m</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLintM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="updateTvSubst"></a><span class='hs-definition'>updateTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-49"></a><span class='hs-definition'>updateTvSubst</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span>
<a name="line-50"></a>  <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLintM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="getTvSubst"></a><span class='hs-definition'>getTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>TvSubst</span>
<a name="line-53"></a><span class='hs-definition'>getTvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="getInScope"></a><span class='hs-definition'>getInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-56"></a><span class='hs-definition'>getInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="applySubstTy"></a><span class='hs-definition'>applySubstTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>OutType</span>
<a name="line-59"></a><span class='hs-definition'>applySubstTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTvSubst</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="applySubstCo"></a><span class='hs-definition'>applySubstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>OutCoercion</span>
<a name="line-62"></a><span class='hs-definition'>applySubstCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTvSubst</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="extendSubstL"></a><span class='hs-definition'>extendSubstL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-varid'>a</span>
<a name="line-65"></a><span class='hs-definition'>extendSubstL</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>m</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LintM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLintM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="lookupIdInScope"></a><span class='hs-definition'>lookupIdInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><span class='hs-definition'>lookupIdInScope</span> <span class='hs-varid'>id</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mustHaveLocalBinding</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span>   <span class='hs-comment'>-- An imported Id</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTvSubst</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupInScope</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-8"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-9"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErrL</span> <span class='hs-varid'>out_of_scope</span>
<a name="line-10"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>out_of_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LetBind</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is out of scope"</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a>
<a name="line-15"></a><a name="oneTupleDataConId"></a><span class='hs-definition'>oneTupleDataConId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-comment'>-- Should not happen</span>
<a name="line-16"></a><span class='hs-definition'>oneTupleDataConId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConWorkId</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="checkBndrIdInScope"></a><span class='hs-definition'>checkBndrIdInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-19"></a><span class='hs-definition'>checkBndrIdInScope</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>id</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkInScope</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>id</span>
<a name="line-21"></a>    <span class='hs-keyword'>where</span>
<a name="line-22"></a>     <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is out of scope inside info for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-23"></a>           <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="checkTyCoVarInScope"></a><span class='hs-definition'>checkTyCoVarInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-26"></a><span class='hs-definition'>checkTyCoVarInScope</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkInScope</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is out of scope"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="checkInScope"></a><span class='hs-definition'>checkInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-29"></a><span class='hs-definition'>checkInScope</span> <span class='hs-varid'>loc_msg</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span>
<a name="line-30"></a> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTvSubst</span>
<a name="line-31"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mustHaveLocalBinding</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>var</span> <span class='hs-varop'>`isInScope`</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-32"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LetBind</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>loc_msg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="checkTys"></a><span class='hs-definition'>checkTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-35"></a><span class='hs-comment'>-- check ty2 is subtype of ty1 (ie, has same structure but usage</span>
<a name="line-36"></a><span class='hs-comment'>-- annotations need only be consistent, not equal)</span>
<a name="line-37"></a><span class='hs-comment'>-- Assumes ty1,ty2 are have alrady had the substitution applied</span>
<a name="line-38"></a><span class='hs-definition'>checkTys</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="checkRole"></a><span class='hs-definition'>checkRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>
<a name="line-41"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>      <span class='hs-comment'>-- expected</span>
<a name="line-42"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>      <span class='hs-comment'>-- actual</span>
<a name="line-43"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LintM</span> <span class='hs-conid'>()</span>
<a name="line-44"></a><span class='hs-definition'>checkRole</span> <span class='hs-varid'>co</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkL</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-46"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Role incompatibility: expected"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-47"></a>            <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"got"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>$$</span>
<a name="line-48"></a>            <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Error messages}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dumpLoc"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LintLocInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>RhsOf</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"RHS of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_binders</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LambdaBodyOf</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in body of lambda with binder"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_binder</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyOfLetRec</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In body of a letrec with no binders"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyOfLetRec</span> <span class='hs-varid'>bs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>getSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in body of letrec with binders"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_binders</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the expression:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In a case alternative:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_binders</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CasePat</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the pattern of a case alternative:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_binders</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportedUnfolding</span> <span class='hs-varid'>locn</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>locn</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in an imported unfolding"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-conid'>TopLevelBindings</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-definition'>dumpLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the coercion"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="pp_binders"></a><span class='hs-definition'>pp_binders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-34"></a><span class='hs-definition'>pp_binders</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_binder</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="pp_binder"></a><span class='hs-definition'>pp_binder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-37"></a><span class='hs-definition'>pp_binder</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>b</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcolon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-38"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>dcolon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>--      Messages for case expressions</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="mkDefaultArgsMsg"></a><span class='hs-definition'>mkDefaultArgsMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-5"></a><span class='hs-definition'>mkDefaultArgsMsg</span> <span class='hs-varid'>args</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"DEFAULT case with binders"</span><span class='hs-layout'>)</span>
<a name="line-7"></a>         <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="mkCaseAltMsg"></a><span class='hs-definition'>mkCaseAltMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-10"></a><span class='hs-definition'>mkCaseAltMsg</span> <span class='hs-varid'>e</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Type of case alternatives not the same as the annotation on case:"</span><span class='hs-layout'>)</span>
<a name="line-12"></a>         <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="mkScrutMsg"></a><span class='hs-definition'>mkScrutMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-15"></a><span class='hs-definition'>mkScrutMsg</span> <span class='hs-varid'>var</span> <span class='hs-varid'>var_ty</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>subst</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Result binder in case doesn't match scrutinee:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span>
<a name="line-17"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"Result binder type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>var_ty</span><span class='hs-layout'>,</span><span class='hs-comment'>--(idType var),</span>
<a name="line-18"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"Scrutinee type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>,</span>
<a name="line-19"></a>     <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Current TV subst"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="mkNonDefltMsg"></a><span class='hs-definition'>mkNonDefltMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNonIncreasingAltsMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-22"></a><span class='hs-definition'>mkNonDefltMsg</span> <span class='hs-varid'>e</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Case expression with DEFAULT not at the beginnning"</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-24"></a><a name="mkNonIncreasingAltsMsg"></a><span class='hs-definition'>mkNonIncreasingAltsMsg</span> <span class='hs-varid'>e</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Case expression with badly-ordered alternatives"</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="nonExhaustiveAltsMsg"></a><span class='hs-definition'>nonExhaustiveAltsMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-28"></a><span class='hs-definition'>nonExhaustiveAltsMsg</span> <span class='hs-varid'>e</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Case expression with non-exhaustive alternatives"</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="mkBadConMsg"></a><span class='hs-definition'>mkBadConMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-32"></a><span class='hs-definition'>mkBadConMsg</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>datacon</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-34"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"In a case alternative, data constructor isn't in scrutinee type:"</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Scrutinee type constructor:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Data con:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>datacon</span>
<a name="line-37"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="mkBadPatMsg"></a><span class='hs-definition'>mkBadPatMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-40"></a><span class='hs-definition'>mkBadPatMsg</span> <span class='hs-varid'>con_result_ty</span> <span class='hs-varid'>scrut_ty</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-42"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"In a case alternative, pattern result type doesn't match scrutinee type:"</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Pattern result type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con_result_ty</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Scrutinee type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scrut_ty</span>
<a name="line-45"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="integerScrutinisedMsg"></a><span class='hs-definition'>integerScrutinisedMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-48"></a><span class='hs-definition'>integerScrutinisedMsg</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In a LitAlt, the literal is lifted (probably Integer)"</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="mkBadAltMsg"></a><span class='hs-definition'>mkBadAltMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreAlt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-52"></a><span class='hs-definition'>mkBadAltMsg</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alt</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Data alternative when scrutinee is not a tycon application"</span><span class='hs-layout'>,</span>
<a name="line-54"></a>           <span class='hs-varid'>text</span> <span class='hs-str'>"Scrutinee type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>,</span>
<a name="line-55"></a>           <span class='hs-varid'>text</span> <span class='hs-str'>"Alternative:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCoreAlt</span> <span class='hs-varid'>alt</span> <span class='hs-keyglyph'>]</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="mkNewTyDataConAltMsg"></a><span class='hs-definition'>mkNewTyDataConAltMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreAlt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-58"></a><span class='hs-definition'>mkNewTyDataConAltMsg</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>alt</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Data alternative for newtype datacon"</span><span class='hs-layout'>,</span>
<a name="line-60"></a>           <span class='hs-varid'>text</span> <span class='hs-str'>"Scrutinee type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>,</span>
<a name="line-61"></a>           <span class='hs-varid'>text</span> <span class='hs-str'>"Alternative:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCoreAlt</span> <span class='hs-varid'>alt</span> <span class='hs-keyglyph'>]</span>
<a name="line-62"></a>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-comment'>------------------------------------------------------</span>
<a name="line-65"></a><span class='hs-comment'>--      Other error messages</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="mkAppMsg"></a><span class='hs-definition'>mkAppMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-68"></a><span class='hs-definition'>mkAppMsg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>arg</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Argument value doesn't match argument type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-70"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Fun type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-71"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arg type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-72"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arg:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="mkNonFunAppMsg"></a><span class='hs-definition'>mkNonFunAppMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-75"></a><span class='hs-definition'>mkNonFunAppMsg</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>arg</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non-function type in function position"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-77"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Fun type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-78"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arg type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-79"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arg:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="mkLetErr"></a><span class='hs-definition'>mkLetErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-82"></a><span class='hs-definition'>mkLetErr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad `let' binding:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-84"></a>          <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Variable:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-86"></a>          <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Rhs:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-87"></a>                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="mkTyAppMsg"></a><span class='hs-definition'>mkTyAppMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-90"></a><span class='hs-definition'>mkTyAppMsg</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg_ty</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal type application:"</span><span class='hs-layout'>,</span>
<a name="line-92"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Exp type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-93"></a>                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-94"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arg type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-95"></a>                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="mkRhsMsg"></a><span class='hs-definition'>mkRhsMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-98"></a><span class='hs-definition'>mkRhsMsg</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>what</span> <span class='hs-varid'>ty</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span>
<a name="line-100"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The type of this binder doesn't match the type of its"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span>
<a name="line-101"></a>            <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-102"></a>     <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Binder's type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-103"></a>     <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Rhs type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="mkRhsPrimMsg"></a><span class='hs-definition'>mkRhsPrimMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-106"></a><span class='hs-definition'>mkRhsPrimMsg</span> <span class='hs-varid'>binder</span> <span class='hs-sel'>_rhs</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The type of this binder is primitive:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-108"></a>                     <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-109"></a>              <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Binder's type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="mkStrictMsg"></a><span class='hs-definition'>mkStrictMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-113"></a><span class='hs-definition'>mkStrictMsg</span> <span class='hs-varid'>binder</span>
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Recursive or top-level binder has strict demand info:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-115"></a>                     <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-116"></a>              <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Binder's demand info:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idDemandInfo</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="mkNonTopExportedMsg"></a><span class='hs-definition'>mkNonTopExportedMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-120"></a><span class='hs-definition'>mkNonTopExportedMsg</span> <span class='hs-varid'>binder</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non-top-level binder is marked as exported:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder</span><span class='hs-keyglyph'>]</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="mkNonTopExternalNameMsg"></a><span class='hs-definition'>mkNonTopExternalNameMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-124"></a><span class='hs-definition'>mkNonTopExternalNameMsg</span> <span class='hs-varid'>binder</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non-top-level binder has an external name:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder</span><span class='hs-keyglyph'>]</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="mkKindErrMsg"></a><span class='hs-definition'>mkKindErrMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-128"></a><span class='hs-definition'>mkKindErrMsg</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>arg_ty</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kinds don't match in type application:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-130"></a>          <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type variable:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-132"></a>          <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arg type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-133"></a>                 <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="mkCastErr"></a><span class='hs-comment'>{- Not needed now
<a name="line-136"></a>mkArityMsg :: Id -&gt; MsgDoc
<a name="line-137"></a>mkArityMsg binder
<a name="line-138"></a>  = vcat [hsep [ptext (sLit "Demand type has"),
<a name="line-139"></a>                ppr (dmdTypeDepth dmd_ty),
<a name="line-140"></a>                ptext (sLit "arguments, rhs has"),
<a name="line-141"></a>                ppr (idArity binder),
<a name="line-142"></a>                ptext (sLit "arguments,"),
<a name="line-143"></a>                ppr binder],
<a name="line-144"></a>              hsep [ptext (sLit "Binder's strictness signature:"), ppr dmd_ty]
<a name="line-145"></a>
<a name="line-146"></a>         ]
<a name="line-147"></a>           where (StrictSig dmd_ty) = idStrictness binder
<a name="line-148"></a>-}</span>
<a name="line-149"></a><span class='hs-definition'>mkCastErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-150"></a><span class='hs-definition'>mkCastErr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co</span> <span class='hs-varid'>from_ty</span> <span class='hs-varid'>expr_ty</span>
<a name="line-151"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"From-type of Cast differs from type of enclosed expression"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-152"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"From-type:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>from_ty</span><span class='hs-layout'>,</span>
<a name="line-153"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type of enclosed expr:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>,</span>
<a name="line-154"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Actual enclosed expr:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-155"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Coercion used in cast:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-156"></a>         <span class='hs-keyglyph'>]</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="dupVars"></a><span class='hs-definition'>dupVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-159"></a><span class='hs-definition'>dupVars</span> <span class='hs-varid'>vars</span>
<a name="line-160"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate variables brought into scope"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-161"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="dupExtVars"></a><span class='hs-definition'>dupExtVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-164"></a><span class='hs-definition'>dupExtVars</span> <span class='hs-varid'>vars</span>
<a name="line-165"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate top-level variables with the same qualified name"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-166"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
