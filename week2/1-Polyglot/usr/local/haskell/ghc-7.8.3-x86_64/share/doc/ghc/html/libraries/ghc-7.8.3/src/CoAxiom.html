<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/CoAxiom.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2012
%

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE GADTs, ScopedTypeVariables #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- | Module for coercion axioms, used to represent type family instances</span>
<a name="line-5"></a><span class='hs-comment'>-- and newtypes</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>(</span>
<a name="line-8"></a>       <span class='hs-conid'>Branched</span><span class='hs-layout'>,</span> <span class='hs-conid'>Unbranched</span><span class='hs-layout'>,</span> <span class='hs-conid'>BranchIndex</span><span class='hs-layout'>,</span> <span class='hs-conid'>BranchList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-9"></a>       <span class='hs-varid'>toBranchList</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromBranchList</span><span class='hs-layout'>,</span>
<a name="line-10"></a>       <span class='hs-varid'>toBranchedList</span><span class='hs-layout'>,</span> <span class='hs-varid'>toUnbranchedList</span><span class='hs-layout'>,</span>
<a name="line-11"></a>       <span class='hs-varid'>brListLength</span><span class='hs-layout'>,</span> <span class='hs-varid'>brListNth</span><span class='hs-layout'>,</span> <span class='hs-varid'>brListMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>brListFoldr</span><span class='hs-layout'>,</span> <span class='hs-varid'>brListMapM</span><span class='hs-layout'>,</span>
<a name="line-12"></a>       <span class='hs-varid'>brListFoldlM_</span><span class='hs-layout'>,</span> <span class='hs-varid'>brListZipWith</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>       <span class='hs-conid'>CoAxiom</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoAxBranch</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>
<a name="line-16"></a>       <span class='hs-varid'>toBranchedAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>toUnbranchedAxiom</span><span class='hs-layout'>,</span>
<a name="line-17"></a>       <span class='hs-varid'>coAxiomName</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomBranches</span><span class='hs-layout'>,</span>
<a name="line-18"></a>       <span class='hs-varid'>coAxiomTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isImplicitCoAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomNumPats</span><span class='hs-layout'>,</span>
<a name="line-19"></a>       <span class='hs-varid'>coAxiomNthBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomSingleBranch_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomRole</span><span class='hs-layout'>,</span>
<a name="line-20"></a>       <span class='hs-varid'>coAxiomSingleBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxBranchTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxBranchRoles</span><span class='hs-layout'>,</span>
<a name="line-21"></a>       <span class='hs-varid'>coAxBranchLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxBranchRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxBranchSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxBranchIncomps</span><span class='hs-layout'>,</span>
<a name="line-22"></a>       <span class='hs-varid'>placeHolderIncomps</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>       <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsFromRole</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>       <span class='hs-conid'>CoAxiomRule</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eqn</span><span class='hs-layout'>,</span>
<a name="line-27"></a>       <span class='hs-conid'>BuiltInSynFamily</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>trivialBuiltInFamily</span>
<a name="line-28"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> 
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TypeRep</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Binary</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-46"></a>
</pre>\end{code}

Note [Coercion axiom branches]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In order to allow type family instance groups, an axiom needs to contain an
ordered list of alternatives, called branches. The kind of the coercion built
from an axiom is determined by which index is used when building the coercion
from the axiom.

For example, consider the axiom derived from the following declaration:

type instance where
  F [Int] = Bool
  F [a]   = Double
  F (a b) = Char

This will give rise to this axiom:

axF :: {                                           F [Int] ~ Bool
       ; forall (a :: *).                          F [a]   ~ Double
       ; forall (k :: BOX) (a :: k -> *) (b :: k). F (a b) ~ Char
       }

The axiom is used with the AxiomInstCo constructor of Coercion. If we wish
to have a coercion showing that F (Maybe Int) ~ Char, it will look like

axF[2] <*> <Maybe> <Int> :: F (Maybe Int) ~ Char
-- or, written using concrete-ish syntax --
AxiomInstCo axF 2 [Refl *, Refl Maybe, Refl Int]

Note that the index is 0-based.

For type-checking, it is also necessary to check that no previous pattern
can unify with the supplied arguments. After all, it is possible that some
of the type arguments are lambda-bound type variables whose instantiation may
cause an earlier match among the branches. We wish to prohibit this behavior,
so the type checker rules out the choice of a branch where a previous branch
can unify. See also [Branched instance checking] in FamInstEnv.hs.

For example, the following is malformed, where 'a' is a lambda-bound type
variable:

axF[2] <*> <a> <Bool> :: F (a Bool) ~ Char

Why? Because a might be instantiated with [], meaning that branch 1 should
apply, not branch 2. This is a vital consistency check; without it, we could
derive Int ~ Bool, and that is a Bad Thing.

Note [Branched axioms]
~~~~~~~~~~~~~~~~~~~~~~~
Although a CoAxiom has the capacity to store many branches, in certain cases,
we want only one. These cases are in data/newtype family instances, newtype
coercions, and type family instances declared with "type instance ...", not
"type instance where". Furthermore, these unbranched axioms are used in a
variety of places throughout GHC, and it would difficult to generalize all of
that code to deal with branched axioms, especially when the code can be sure
of the fact that an axiom is indeed a singleton. At the same time, it seems
dangerous to assume singlehood in various places through GHC.

The solution to this is to label a CoAxiom with a phantom type variable
declaring whether it is known to be a singleton or not. The list of branches
is stored using a special form of list, declared below, that ensures that the
type variable is accurate.

As of this writing (Dec 2012), it would not be appropriate to use a promoted
type as the phantom type, so we use empty datatypes. We wish to have GHC
remain compilable with GHC 7.2.1. If you are revising this code and GHC no
longer needs to remain compatible with GHC 7.2.x, then please update this
code to use promoted types.


%************************************************************************
%*                                                                      *
                    Branch lists
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="BranchIndex"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>  <span class='hs-comment'>-- The index of the branch in the list of branches</span>
<a name="line-2"></a>                        <span class='hs-comment'>-- Counting from zero</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="Unbranched"></a><span class='hs-comment'>-- the phantom type labels</span>
<a name="line-5"></a><a name="Unbranched"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Typeable</span>
<a name="line-6"></a><a name="Branched"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Branched</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Typeable</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="BranchList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>  <span class='hs-conid'>FirstBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span>
<a name="line-10"></a>  <span class='hs-conid'>NextBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-conid'>Branched</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="toBranchList"></a><span class='hs-comment'>-- convert to/from lists</span>
<a name="line-13"></a><span class='hs-definition'>toBranchList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-conid'>Branched</span>
<a name="line-14"></a><span class='hs-definition'>toBranchList</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"toBranchList"</span> <span class='hs-varid'>empty</span>
<a name="line-15"></a><span class='hs-definition'>toBranchList</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span>
<a name="line-16"></a><span class='hs-definition'>toBranchList</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-layout'>(</span><span class='hs-varid'>toBranchList</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="fromBranchList"></a><span class='hs-definition'>fromBranchList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a><span class='hs-definition'>fromBranchList</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a><span class='hs-definition'>fromBranchList</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromBranchList</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="toBranchedList"></a><span class='hs-comment'>-- convert from any BranchList to a Branched BranchList</span>
<a name="line-23"></a><span class='hs-definition'>toBranchedList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-conid'>Branched</span>
<a name="line-24"></a><span class='hs-definition'>toBranchedList</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span>
<a name="line-25"></a><span class='hs-definition'>toBranchedList</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="toUnbranchedList"></a><span class='hs-comment'>-- convert from any BranchList to an Unbranched BranchList</span>
<a name="line-28"></a><span class='hs-definition'>toUnbranchedList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-conid'>Unbranched</span>
<a name="line-29"></a><span class='hs-definition'>toUnbranchedList</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span>
<a name="line-30"></a><span class='hs-definition'>toUnbranchedList</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"toUnbranchedList"</span> <span class='hs-varid'>empty</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="brListLength"></a><span class='hs-comment'>-- length</span>
<a name="line-33"></a><span class='hs-definition'>brListLength</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-34"></a><span class='hs-definition'>brListLength</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-35"></a><span class='hs-definition'>brListLength</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>brListLength</span> <span class='hs-varid'>t</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="brListNth"></a><span class='hs-comment'>-- lookup</span>
<a name="line-38"></a><span class='hs-definition'>brListNth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-39"></a><span class='hs-definition'>brListNth</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span>
<a name="line-40"></a><span class='hs-definition'>brListNth</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span>
<a name="line-41"></a><span class='hs-definition'>brListNth</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brListNth</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-definition'>brListNth</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"brListNth"</span> <span class='hs-varid'>empty</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="brListMap"></a><span class='hs-comment'>-- map, fold</span>
<a name="line-45"></a><span class='hs-definition'>brListMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-46"></a><span class='hs-definition'>brListMap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-47"></a><span class='hs-definition'>brListMap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>brListMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="brListFoldr"></a><span class='hs-definition'>brListFoldr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-50"></a><span class='hs-definition'>brListFoldr</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>b</span> <span class='hs-varid'>x</span>
<a name="line-51"></a><span class='hs-definition'>brListFoldr</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>h</span> <span class='hs-layout'>(</span><span class='hs-varid'>brListFoldr</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="brListMapM"></a><span class='hs-definition'>brListMapM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-54"></a><span class='hs-definition'>brListMapM</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>fb</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fb</span><span class='hs-keyglyph'>]</span>
<a name="line-55"></a><span class='hs-definition'>brListMapM</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fh</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>h</span>
<a name="line-56"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>ft</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>brListMapM</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t</span>
<a name="line-57"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fh</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ft</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="brListFoldlM_"></a><span class='hs-definition'>brListFoldlM_</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>m</span> <span class='hs-varid'>br</span><span class='hs-varop'>.</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-60"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>b</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-61"></a><span class='hs-definition'>brListFoldlM_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>z</span> <span class='hs-varid'>brs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>z</span> <span class='hs-varid'>brs</span>
<a name="line-62"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>br'</span><span class='hs-varop'>.</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>b</span> <span class='hs-varid'>br'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-64"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>b</span>
<a name="line-65"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fh</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>h</span>
<a name="line-66"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fh</span> <span class='hs-varid'>t</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="brListZipWith"></a><span class='hs-comment'>-- zipWith</span>
<a name="line-69"></a><span class='hs-definition'>brListZipWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-varid'>b</span> <span class='hs-varid'>br2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span>
<a name="line-70"></a><span class='hs-definition'>brListZipWith</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-71"></a><span class='hs-definition'>brListZipWith</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-72"></a><span class='hs-definition'>brListZipWith</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-73"></a><span class='hs-definition'>brListZipWith</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>a</span> <span class='hs-varid'>ta</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>b</span> <span class='hs-varid'>tb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-conop'>:</span> <span class='hs-varid'>brListZipWith</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ta</span> <span class='hs-varid'>tb</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-comment'>-- pretty-printing</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>BranchList</span> <span class='hs-varid'>a</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-78"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromBranchList</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                    Coercion axioms
%*                                                                      *
%************************************************************************

Note [Storing compatibility]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During axiom application, we need to be aware of which branches are compatible
with which others. The full explanation is in Note [Compatibility] in
FamInstEnv. (The code is placed there to avoid a dependency from CoAxiom on
the unification algorithm.) Although we could theoretically compute
compatibility on the fly, this is silly, so we store it in a CoAxiom.

Specifically, each branch refers to all other branches with which it is
incompatible. This list might well be empty, and it will always be for the
first branch of any axiom.

CoAxBranches that do not (yet) belong to a CoAxiom should have a panic thunk
stored in cab_incomps. The incompatibilities are properly a property of the
axiom as a whole, and they are computed only when the final axiom is built.

During serialization, the list is converted into a list of the indices
of the branches.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- | A 'CoAxiom' is a \"coercion constructor\", i.e. a named equality axiom.</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="CoAxiom"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-4"></a><a name="CoAxiom"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.lhs</span>
<a name="line-5"></a><a name="CoAxiom"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiom</span>                   <span class='hs-comment'>-- Type equality axiom.</span>
<a name="line-7"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_unique</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>        <span class='hs-comment'>-- unique identifier</span>
<a name="line-8"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>          <span class='hs-comment'>-- name for pretty-printing</span>
<a name="line-9"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>          <span class='hs-comment'>-- role of the axiom's equality</span>
<a name="line-10"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_tc</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>         <span class='hs-comment'>-- the head of the LHS patterns</span>
<a name="line-11"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BranchList</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-varid'>br</span>
<a name="line-12"></a>                                      <span class='hs-comment'>-- the branches that form this axiom</span>
<a name="line-13"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_implicit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>          <span class='hs-comment'>-- True &lt;=&gt; the axiom is "implicit"</span>
<a name="line-14"></a>                                      <span class='hs-comment'>-- See Note [Implicit axioms]</span>
<a name="line-15"></a>         <span class='hs-comment'>-- INVARIANT: co_ax_implicit == True implies length co_ax_branches == 1.</span>
<a name="line-16"></a>    <span class='hs-layout'>}</span>
<a name="line-17"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Typeable</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="CoAxBranch"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-21"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>cab_loc</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>       <span class='hs-comment'>-- Location of the defining equation</span>
<a name="line-22"></a>                                    <span class='hs-comment'>-- See Note [CoAxiom locations]</span>
<a name="line-23"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_tvs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Bound type variables; not necessarily fresh</span>
<a name="line-24"></a>                                    <span class='hs-comment'>-- See Note [CoAxBranch type variables]</span>
<a name="line-25"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- See Note [CoAxBranch roles]</span>
<a name="line-26"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Type patterns to match against</span>
<a name="line-27"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>          <span class='hs-comment'>-- Right-hand side of the equality</span>
<a name="line-28"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_incomps</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- The previous incompatible branches</span>
<a name="line-29"></a>                                    <span class='hs-comment'>-- See Note [Storing compatibility]</span>
<a name="line-30"></a>    <span class='hs-layout'>}</span>
<a name="line-31"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Typeable</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="toBranchedAxiom"></a><span class='hs-definition'>toBranchedAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span>
<a name="line-34"></a><span class='hs-definition'>toBranchedAxiom</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>unique</span> <span class='hs-varid'>name</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>branches</span> <span class='hs-varid'>implicit</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>unique</span> <span class='hs-varid'>name</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>toBranchedList</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span> <span class='hs-varid'>implicit</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="toUnbranchedAxiom"></a><span class='hs-definition'>toUnbranchedAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-38"></a><span class='hs-definition'>toUnbranchedAxiom</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>unique</span> <span class='hs-varid'>name</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>branches</span> <span class='hs-varid'>implicit</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>unique</span> <span class='hs-varid'>name</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>toUnbranchedList</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span> <span class='hs-varid'>implicit</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="coAxiomNumPats"></a><span class='hs-definition'>coAxiomNumPats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-42"></a><span class='hs-definition'>coAxiomNumPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="coAxiomNthBranch"></a><span class='hs-definition'>coAxiomNthBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-45"></a><span class='hs-definition'>coAxiomNthBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>index</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brListNth</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>index</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="coAxiomArity"></a><span class='hs-definition'>coAxiomArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-49"></a><span class='hs-definition'>coAxiomArity</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="coAxiomName"></a><span class='hs-definition'>coAxiomName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-53"></a><span class='hs-definition'>coAxiomName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_ax_name</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="coAxiomRole"></a><span class='hs-definition'>coAxiomRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-56"></a><span class='hs-definition'>coAxiomRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_ax_role</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="coAxiomBranches"></a><span class='hs-definition'>coAxiomBranches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-varid'>br</span>
<a name="line-59"></a><span class='hs-definition'>coAxiomBranches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_ax_branches</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="coAxiomSingleBranch_maybe"></a><span class='hs-definition'>coAxiomSingleBranch_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-62"></a><span class='hs-definition'>coAxiomSingleBranch_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>branches</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>br</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="coAxiomSingleBranch"></a><span class='hs-definition'>coAxiomSingleBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-69"></a><span class='hs-definition'>coAxiomSingleBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>br</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>br</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="coAxiomTyCon"></a><span class='hs-definition'>coAxiomTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-72"></a><span class='hs-definition'>coAxiomTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_ax_tc</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="coAxBranchTyVars"></a><span class='hs-definition'>coAxBranchTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a><span class='hs-definition'>coAxBranchTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cab_tvs</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="coAxBranchLHS"></a><span class='hs-definition'>coAxBranchLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-78"></a><span class='hs-definition'>coAxBranchLHS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cab_lhs</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="coAxBranchRHS"></a><span class='hs-definition'>coAxBranchRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-81"></a><span class='hs-definition'>coAxBranchRHS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cab_rhs</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="coAxBranchRoles"></a><span class='hs-definition'>coAxBranchRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-84"></a><span class='hs-definition'>coAxBranchRoles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cab_roles</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="coAxBranchSpan"></a><span class='hs-definition'>coAxBranchSpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-87"></a><span class='hs-definition'>coAxBranchSpan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cab_loc</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="isImplicitCoAxiom"></a><span class='hs-definition'>isImplicitCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-90"></a><span class='hs-definition'>isImplicitCoAxiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_ax_implicit</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="coAxBranchIncomps"></a><span class='hs-definition'>coAxBranchIncomps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span>
<a name="line-93"></a><span class='hs-definition'>coAxBranchIncomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cab_incomps</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="placeHolderIncomps"></a><span class='hs-definition'>placeHolderIncomps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span>
<a name="line-96"></a><span class='hs-definition'>placeHolderIncomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"placeHolderIncomps"</span>
<a name="line-97"></a>
</pre>\end{code}

Note [CoAxBranch type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the case of a CoAxBranch of an associated type-family instance, 
we use the *same* type variables (where possible) as the
enclosing class or instance.  Consider
   class C a b where
     type F x b 
     type F [y] b = ...     -- Second param must be b

   instance C Int [z] where
     type F Int [z] = ...   -- Second param must be [z]

In the CoAxBranch in the instance decl (F Int [z]) we use the
same 'z', so that it's easy to check that that type is the same
as that in the instance header.  

Similarly in the CoAxBranch for the default decl for F in the
class decl, we use the same 'b' to make the same check easy.

So, unlike FamInsts, there is no expectation that the cab_tvs
are fresh wrt each other, or any other CoAxBranch.

Note [CoAxBranch roles]
~~~~~~~~~~~~~~~~~~~~~~~
Consider this code:

  newtype Age = MkAge Int
  newtype Wrap a = MkWrap a

  convert :: Wrap Age -> Int
  convert (MkWrap (MkAge i)) = i

We want this to compile to:

  NTCo:Wrap :: forall a. Wrap a ~R a
  NTCo:Age  :: Age ~R Int
  convert = \x -> x |> (NTCo:Wrap[0] NTCo:Age[0])

But, note that NTCo:Age is at role R. Thus, we need to be able to pass
coercions at role R into axioms. However, we don't *always* want to be able to
do this, as it would be disastrous with type families. The solution is to
annotate the arguments to the axiom with roles, much like we annotate tycon
tyvars. Where do these roles get set? Newtype axioms inherit their roles from
the newtype tycon; family axioms are all at role N.

Note [CoAxiom locations]
~~~~~~~~~~~~~~~~~~~~~~~~
The source location of a CoAxiom is stored in two places in the
datatype tree. 
  * The first is in the location info buried in the Name of the
    CoAxiom. This span includes all of the branches of a branched
    CoAxiom.
  * The second is in the cab_loc fields of the CoAxBranches.  

In the case of a single branch, we can extract the source location of
the branch from the name of the CoAxiom. In other cases, we need an
explicit SrcSpan to correctly store the location of the equation
giving rise to the FamInstBranch.

Note [Implicit axioms]
~~~~~~~~~~~~~~~~~~~~~~
See also Note [Implicit TyThings] in HscTypes
* A CoAxiom arising from data/type family instances is not "implicit".
  That is, it has its own IfaceAxiom declaration in an interface file

* The CoAxiom arising from a newtype declaration *is* "implicit".
  That is, it does not have its own IfaceAxiom declaration in an
  interface file; instead the CoAxiom is generated by type-checking
  the newtype declaration

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-3"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;</span>  <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>}</span>
<a name="line-9"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;</span>  <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>}</span>
<a name="line-10"></a>    <span class='hs-varid'>compare</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>b</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>getUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_ax_unique</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getName</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>getName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_ax_name</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-comment'>-- don't traverse?</span>
<a name="line-23"></a>    <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"CoAxiom"</span>
<a name="line-24"></a>    <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-25"></a>    <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"CoAxiom"</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                    Roles
%*                                                                      *
%************************************************************************

Roles are defined here to avoid circular dependencies.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="Role"></a><span class='hs-comment'>-- See Note [Roles] in Coercion</span>
<a name="line-3"></a><a name="Role"></a><span class='hs-comment'>-- defined here to avoid cyclic dependency with Coercion</span>
<a name="line-4"></a><a name="Role"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Phantom</span>
<a name="line-5"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="fsFromRole"></a><span class='hs-comment'>-- These names are slurped into the parser code. Changing these strings</span>
<a name="line-8"></a><span class='hs-comment'>-- will change the **surface syntax** that GHC accepts! If you want to</span>
<a name="line-9"></a><span class='hs-comment'>-- change only the pretty-printing, do some replumbing. See</span>
<a name="line-10"></a><span class='hs-comment'>-- mkRoleAnnotDecl in RdrHsSyn</span>
<a name="line-11"></a><span class='hs-definition'>fsFromRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span>
<a name="line-12"></a><span class='hs-definition'>fsFromRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"nominal"</span>
<a name="line-13"></a><span class='hs-definition'>fsFromRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"representational"</span>
<a name="line-14"></a><span class='hs-definition'>fsFromRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"phantom"</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Role</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ftext</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fsFromRole</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>Role</span> <span class='hs-keyword'>where</span>
<a name="line-20"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-21"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-22"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span>
<a name="line-23"></a>
<a name="line-24"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-25"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>tag</span> <span class='hs-keyword'>of</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nominal</span>
<a name="line-26"></a>                          <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Representational</span>
<a name="line-27"></a>                          <span class='hs-num'>3</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Phantom</span>
<a name="line-28"></a>                          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"get Role "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>tag</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                    CoAxiomRule
              Rules for building Evidence
%*                                                                      *
%************************************************************************

Conditional axioms.  The general idea is that a `CoAxiomRule` looks like this:

    forall as. (r1 ~ r2, s1 ~ s2) => t1 ~ t2

My intention is to reuse these for both (~) and (~#).
The short-term plan is to use this datatype to represent the type-nat axioms.
In the longer run, it may be good to unify this and `CoAxiom`,
as `CoAxiom` is the special case when there are no assumptions.

\begin{code}
<pre><a name="line-1"></a><a name="Eqn"></a><span class='hs-comment'>-- | A more explicit representation for `t1 ~ t2`.</span>
<a name="line-2"></a><a name="Eqn"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Eqn</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="CoAxiomRule"></a><span class='hs-comment'>-- | For now, we work only with nominal equality.</span>
<a name="line-5"></a><a name="CoAxiomRule"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiomRule</span>
<a name="line-6"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>coaxrName</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span>
<a name="line-7"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>coaxrTypeArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>       <span class='hs-comment'>-- number of type argumentInts</span>
<a name="line-8"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>coaxrAsmpRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- roles of parameter equations</span>
<a name="line-9"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>coaxrRole</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>      <span class='hs-comment'>-- role of resulting equation</span>
<a name="line-10"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>coaxrProves</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Eqn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Eqn</span>
<a name="line-11"></a>        <span class='hs-comment'>-- ^ coaxrProves returns @Nothing@ when it doesn't like</span>
<a name="line-12"></a>        <span class='hs-comment'>-- the supplied arguments.  When this happens in a coercion</span>
<a name="line-13"></a>        <span class='hs-comment'>-- that means that the coercion is ill-formed, and Core Lint</span>
<a name="line-14"></a>        <span class='hs-comment'>-- checks for that.</span>
<a name="line-15"></a>  <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Typeable</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyword'>where</span>
<a name="line-18"></a>  <span class='hs-comment'>-- don't traverse?</span>
<a name="line-19"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"CoAxiomRule"</span>
<a name="line-20"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-21"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"CoAxiomRule"</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyword'>where</span>
<a name="line-24"></a>  <span class='hs-varid'>getUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coaxrName</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyword'>where</span>
<a name="line-27"></a>  <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coaxrName</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>coaxrName</span> <span class='hs-varid'>y</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyword'>where</span>
<a name="line-30"></a>  <span class='hs-varid'>compare</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrName</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrName</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coaxrName</span>
<a name="line-34"></a>
<a name="line-35"></a>
<a name="line-36"></a><a name="BuiltInSynFamily"></a><span class='hs-comment'>-- Type checking of built-in families</span>
<a name="line-37"></a><a name="BuiltInSynFamily"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BuiltInSynFamily</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuiltInSynFamily</span>
<a name="line-38"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>sfMatchFam</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiomRule</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>sfInteractTop</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Eqn</span><span class='hs-keyglyph'>]</span>
<a name="line-40"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>sfInteractInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-41"></a>                       <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Eqn</span><span class='hs-keyglyph'>]</span>
<a name="line-42"></a>  <span class='hs-layout'>}</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="trivialBuiltInFamily"></a><span class='hs-comment'>-- Provides default implementations that do nothing.</span>
<a name="line-45"></a><span class='hs-definition'>trivialBuiltInFamily</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BuiltInSynFamily</span>
<a name="line-46"></a><span class='hs-definition'>trivialBuiltInFamily</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuiltInSynFamily</span>
<a name="line-47"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>sfMatchFam</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-48"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>sfInteractTop</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-49"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>sfInteractInert</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-50"></a>  <span class='hs-layout'>}</span>
<a name="line-51"></a>
</pre>\end{code}

</body>
</html>
