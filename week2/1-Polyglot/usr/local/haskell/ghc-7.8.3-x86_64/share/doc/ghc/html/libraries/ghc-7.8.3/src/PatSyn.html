<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>basicTypes/PatSyn.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1998
%
\section[PatSyn]{@PatSyn@: Pattern synonyms}

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>PatSyn</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>        <span class='hs-comment'>-- * Main data types</span>
<a name="line-4"></a>        <span class='hs-conid'>PatSyn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPatSyn</span><span class='hs-layout'>,</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-comment'>-- ** Type deconstruction</span>
<a name="line-7"></a>        <span class='hs-varid'>patSynName</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynIsInfix</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-varid'>patSynArgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynTyDetails</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynType</span><span class='hs-layout'>,</span>
<a name="line-9"></a>        <span class='hs-varid'>patSynWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynMatcher</span><span class='hs-layout'>,</span>
<a name="line-10"></a>        <span class='hs-varid'>patSynExTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynSig</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>patSynInstArgTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynInstResTy</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>tidyPatSynIds</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynIds</span>
<a name="line-13"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>(</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsBinds</span><span class='hs-layout'>(</span> <span class='hs-conid'>HsPatSynDetails</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span>
</pre>\end{code}


Note [Pattern synonym representation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following pattern synonym declaration

        pattern P x = MkT [x] (Just 42)

where
        data T a where
              MkT :: (Show a, Ord b) => [b] -> a -> T a

so pattern P has type

        b -> T (Maybe t)

with the following typeclass constraints:

        provides: (Show (Maybe t), Ord b)
        requires: (Eq t, Num t)

In this case, the fields of MkPatSyn will be set as follows:

  psArgs       = [b]
  psArity      = 1
  psInfix      = False

  psUnivTyVars = [t]
  psExTyVars   = [b]
  psProvTheta  = (Show (Maybe t), Ord b)
  psReqTheta   = (Eq t, Num t)
  psOrigResTy  = T (Maybe t)

Note [Matchers and wrappers for pattern synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For each pattern synonym, we generate a single matcher function which
implements the actual matching. For the above example, the matcher
will have type:

        $mP :: forall r t. (Eq t, Num t)
            => T (Maybe t)
            -> (forall b. (Show (Maybe t), Ord b) => b -> r)
            -> r
            -> r

with the following implementation:

        $mP @r @t $dEq $dNum scrut cont fail = case scrut of
            MkT @b $dShow $dOrd [x] (Just 42) -> cont @b $dShow $dOrd x
            _                                 -> fail

For *bidirectional* pattern synonyms, we also generate a single wrapper
function which implements the pattern synonym in an expression
context. For our running example, it will be:

        $WP :: forall t b. (Show (Maybe t), Ord b, Eq t, Num t)
            => b -> T (Maybe t)
        $WP x = MkT [x] (Just 42)

NB: the existential/universal and required/provided split does not
apply to the wrapper since you are only putting stuff in, not getting
stuff out.

Injectivity of bidirectional pattern synonyms is checked in
tcPatToExpr which walks the pattern and returns its corresponding
expression when available.

%************************************************************************
%*                                                                      *
\subsection{Pattern synonyms}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="PatSyn"></a><span class='hs-comment'>-- | A pattern synonym</span>
<a name="line-2"></a><a name="PatSyn"></a><span class='hs-comment'>-- See Note [Pattern synonym representation]</span>
<a name="line-3"></a><a name="PatSyn"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PatSyn</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span>
<a name="line-5"></a>        <span class='hs-varid'>psName</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>psUnique</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Cached from Name</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-varid'>psArgs</span>        <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-9"></a>        <span class='hs-varid'>psArity</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- == length psArgs</span>
<a name="line-10"></a>        <span class='hs-varid'>psInfix</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- True &lt;=&gt; declared infix</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-varid'>psUnivTyVars</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Universially-quantified type variables</span>
<a name="line-13"></a>        <span class='hs-varid'>psExTyVars</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Existentially-quantified type vars</span>
<a name="line-14"></a>        <span class='hs-varid'>psProvTheta</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Provided dictionaries</span>
<a name="line-15"></a>        <span class='hs-varid'>psReqTheta</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Required dictionaries</span>
<a name="line-16"></a>        <span class='hs-varid'>psOrigResTy</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Mentions only psUnivTyVars</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-comment'>-- See Note [Matchers and wrappers for pattern synonyms]</span>
<a name="line-19"></a>        <span class='hs-varid'>psMatcher</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>
<a name="line-20"></a>             <span class='hs-comment'>-- Matcher function, of type</span>
<a name="line-21"></a>             <span class='hs-comment'>--   forall r univ_tvs. req_theta</span>
<a name="line-22"></a>             <span class='hs-comment'>--                   =&gt; res_ty</span>
<a name="line-23"></a>             <span class='hs-comment'>--                   -&gt; (forall ex_tvs. prov_theta -&gt; arg_tys -&gt; r)</span>
<a name="line-24"></a>             <span class='hs-comment'>--                   -&gt; r -&gt; r</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-varid'>psWrapper</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span>
<a name="line-27"></a>             <span class='hs-comment'>-- Nothing  =&gt; uni-directional pattern synonym</span>
<a name="line-28"></a>             <span class='hs-comment'>-- Just wid =&gt; bi-direcitonal</span>
<a name="line-29"></a>             <span class='hs-comment'>-- Wrapper function, of type</span>
<a name="line-30"></a>             <span class='hs-comment'>--  forall univ_tvs, ex_tvs. (prov_theta, req_theta)</span>
<a name="line-31"></a>             <span class='hs-comment'>--                       =&gt;  arg_tys -&gt; res_ty</span>
<a name="line-32"></a>  <span class='hs-layout'>}</span>
<a name="line-33"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Instances}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getUnique</span>
<a name="line-3"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>/=</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getUnique</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&lt;=</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;=</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getUnique</span>
<a name="line-7"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&lt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getUnique</span>
<a name="line-8"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&gt;=</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&gt;=</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getUnique</span>
<a name="line-9"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&gt;</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getUnique</span>
<a name="line-10"></a>    <span class='hs-varid'>compare</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getUnique</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Uniquable</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>getUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psUnique</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>getName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynName</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getName</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>OutputableBndr</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>pprInfixOcc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprInfixName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getName</span>
<a name="line-23"></a>    <span class='hs-varid'>pprPrefixOcc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getName</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-comment'>-- don't traverse?</span>
<a name="line-27"></a>    <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"PatSyn"</span>
<a name="line-28"></a>    <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-29"></a>    <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"PatSyn"</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Construction}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkPatSyn"></a><span class='hs-comment'>-- | Build a new pattern synonym</span>
<a name="line-2"></a><span class='hs-definition'>mkPatSyn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-3"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- ^ Is the pattern synonym declared infix?</span>
<a name="line-4"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- ^ Original arguments</span>
<a name="line-5"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ Universially-quantified type variables</span>
<a name="line-6"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ Existentially-quantified type variables</span>
<a name="line-7"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>  <span class='hs-comment'>-- ^ Wanted dicts</span>
<a name="line-8"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>  <span class='hs-comment'>-- ^ Given dicts</span>
<a name="line-9"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- ^ Original result type</span>
<a name="line-10"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- ^ Name of matcher</span>
<a name="line-11"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span>   <span class='hs-comment'>-- ^ Name of wrapper</span>
<a name="line-12"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatSyn</span>
<a name="line-13"></a><span class='hs-definition'>mkPatSyn</span> <span class='hs-varid'>name</span> <span class='hs-varid'>declared_infix</span> <span class='hs-varid'>orig_args</span>
<a name="line-14"></a>         <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-15"></a>         <span class='hs-varid'>prov_theta</span> <span class='hs-varid'>req_theta</span>
<a name="line-16"></a>         <span class='hs-varid'>orig_res_ty</span>
<a name="line-17"></a>         <span class='hs-varid'>matcher</span> <span class='hs-varid'>wrapper</span>
<a name="line-18"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span><span class='hs-varid'>psName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>psUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span>
<a name="line-19"></a>                <span class='hs-varid'>psUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>psExTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span>
<a name="line-20"></a>                <span class='hs-varid'>psProvTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>psReqTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req_theta</span><span class='hs-layout'>,</span>
<a name="line-21"></a>                <span class='hs-varid'>psInfix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>declared_infix</span><span class='hs-layout'>,</span>
<a name="line-22"></a>                <span class='hs-varid'>psArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>,</span>
<a name="line-23"></a>                <span class='hs-varid'>psArity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>,</span>
<a name="line-24"></a>                <span class='hs-varid'>psOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_res_ty</span><span class='hs-layout'>,</span>
<a name="line-25"></a>                <span class='hs-varid'>psMatcher</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matcher</span><span class='hs-layout'>,</span>
<a name="line-26"></a>                <span class='hs-varid'>psWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapper</span> <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="patSynName"></a><span class='hs-comment'>-- | The 'Name' of the 'PatSyn', giving it a unique, rooted identification</span>
<a name="line-2"></a><span class='hs-definition'>patSynName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-3"></a><span class='hs-definition'>patSynName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psName</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="patSynType"></a><span class='hs-definition'>patSynType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-6"></a><span class='hs-comment'>-- The full pattern type, used only in error messages</span>
<a name="line-7"></a><span class='hs-definition'>patSynType</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>psReqTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req_theta</span>
<a name="line-8"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>psExTyVars</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span>   <span class='hs-varid'>psProvTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov_theta</span>
<a name="line-9"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>psArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>psOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>req_theta</span> <span class='hs-varop'>$</span>
<a name="line-11"></a>    <span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>prov_theta</span> <span class='hs-varop'>$</span>
<a name="line-12"></a>    <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>orig_args</span> <span class='hs-varid'>orig_res_ty</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="patSynIsInfix"></a><span class='hs-comment'>-- | Should the 'PatSyn' be presented infix?</span>
<a name="line-15"></a><span class='hs-definition'>patSynIsInfix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-16"></a><span class='hs-definition'>patSynIsInfix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psInfix</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="patSynArity"></a><span class='hs-comment'>-- | Arity of the pattern synonym</span>
<a name="line-19"></a><span class='hs-definition'>patSynArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-20"></a><span class='hs-definition'>patSynArity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psArity</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="patSynArgs"></a><span class='hs-definition'>patSynArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a><span class='hs-definition'>patSynArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psArgs</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="patSynTyDetails"></a><span class='hs-definition'>patSynTyDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsPatSynDetails</span> <span class='hs-conid'>Type</span>
<a name="line-26"></a><span class='hs-definition'>patSynTyDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psInfix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_infix</span><span class='hs-layout'>,</span> <span class='hs-varid'>psArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_infix</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>left</span><span class='hs-layout'>,</span><span class='hs-varid'>right</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_tys</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InfixPatSyn</span> <span class='hs-varid'>left</span> <span class='hs-varid'>right</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrefixPatSyn</span> <span class='hs-varid'>arg_tys</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="patSynExTyVars"></a><span class='hs-definition'>patSynExTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-33"></a><span class='hs-definition'>patSynExTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psExTyVars</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="patSynSig"></a><span class='hs-definition'>patSynSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-definition'>patSynSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>psExTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-37"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>psProvTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>psReqTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req</span>
<a name="line-38"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>psArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>psOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov</span><span class='hs-layout'>,</span> <span class='hs-varid'>req</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="patSynWrapper"></a><span class='hs-definition'>patSynWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span>
<a name="line-42"></a><span class='hs-definition'>patSynWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psWrapper</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="patSynMatcher"></a><span class='hs-definition'>patSynMatcher</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-45"></a><span class='hs-definition'>patSynMatcher</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>psMatcher</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="patSynIds"></a><span class='hs-definition'>patSynIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a><span class='hs-definition'>patSynIds</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psMatcher</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>psWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_wrap_id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_wrap_id</span> <span class='hs-keyword'>of</span>
<a name="line-50"></a>      <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>match_id</span><span class='hs-keyglyph'>]</span>
<a name="line-51"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>wrap_id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>match_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap_id</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="tidyPatSynIds"></a><span class='hs-definition'>tidyPatSynIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PatSyn</span>
<a name="line-54"></a><span class='hs-definition'>tidyPatSynIds</span> <span class='hs-varid'>tidy_fn</span> <span class='hs-varid'>ps</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psMatcher</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>psWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_wrap_id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psMatcher</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_fn</span> <span class='hs-varid'>match_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>psWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tidy_fn</span> <span class='hs-varid'>mb_wrap_id</span> <span class='hs-layout'>}</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="patSynInstArgTys"></a><span class='hs-definition'>patSynInstArgTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-58"></a><span class='hs-comment'>-- Return the types of the argument patterns</span>
<a name="line-59"></a><span class='hs-comment'>-- e.g.  data D a = forall b. MkD a b (b-&gt;a)</span>
<a name="line-60"></a><span class='hs-comment'>--       pattern P f x y = MkD (x,True) y f</span>
<a name="line-61"></a><span class='hs-comment'>--          D :: forall a. forall b. a -&gt; b -&gt; (b-&gt;a) -&gt; D a</span>
<a name="line-62"></a><span class='hs-comment'>--          P :: forall c. forall b. (b-&gt;(c,Bool)) -&gt; c -&gt; b -&gt; P c</span>
<a name="line-63"></a><span class='hs-comment'>--   patSynInstArgTys P [Int,bb] = [bb-&gt;(Int,Bool), Int, bb]</span>
<a name="line-64"></a><span class='hs-comment'>-- NB: the inst_tys should be both universal and existential</span>
<a name="line-65"></a><span class='hs-definition'>patSynInstArgTys</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>psUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-66"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>psExTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>psArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                 <span class='hs-varid'>inst_tys</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>inst_tys</span>
<a name="line-69"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"patSynInstArgTys"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_tys</span> <span class='hs-layout'>)</span>
<a name="line-70"></a>    <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-71"></a>  <span class='hs-keyword'>where</span>
<a name="line-72"></a>    <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="patSynInstResTy"></a><span class='hs-definition'>patSynInstResTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-75"></a><span class='hs-comment'>-- Return the type of whole pattern</span>
<a name="line-76"></a><span class='hs-comment'>-- E.g.  pattern P x y = Just (x,x,y)</span>
<a name="line-77"></a><span class='hs-comment'>--         P :: a -&gt; b -&gt; Just (a,a,b)</span>
<a name="line-78"></a><span class='hs-comment'>--         (patSynInstResTy P [Int,Bool] = Maybe (Int,Int,Bool)</span>
<a name="line-79"></a><span class='hs-comment'>-- NB: unlikepatSynInstArgTys, the inst_tys should be just the *universal* tyvars</span>
<a name="line-80"></a><span class='hs-definition'>patSynInstResTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkPatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>psName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>psUnivTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-81"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>psOrigResTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-82"></a>                <span class='hs-varid'>inst_tys</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>inst_tys</span>
<a name="line-84"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"patSynInstResTy"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_tys</span> <span class='hs-layout'>)</span>
<a name="line-85"></a>    <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>res_ty</span>
</pre>\end{code}
</body>
</html>
