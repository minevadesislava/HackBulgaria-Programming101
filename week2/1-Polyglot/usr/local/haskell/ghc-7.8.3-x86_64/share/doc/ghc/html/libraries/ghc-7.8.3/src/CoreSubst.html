<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CoreSubst.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Utility functions on @Core@ syntax

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreSubst</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-comment'>-- * Main data types</span>
<a name="line-10"></a>	<span class='hs-conid'>Subst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Implementation exported for supercompiler's Renaming.hs only</span>
<a name="line-11"></a>	<span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>IdSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>InScopeSet</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-comment'>-- ** Substituting into expressions and related types</span>
<a name="line-14"></a>	<span class='hs-varid'>deShadowBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>substSpec</span><span class='hs-layout'>,</span> <span class='hs-varid'>substRulesForImportedIds</span><span class='hs-layout'>,</span>
<a name="line-15"></a>	<span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substExprSC</span><span class='hs-layout'>,</span> <span class='hs-varid'>substBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>substBindSC</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>substUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>substUnfoldingSC</span><span class='hs-layout'>,</span>
<a name="line-17"></a>	<span class='hs-varid'>lookupIdSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>substIdOcc</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>substTickish</span><span class='hs-layout'>,</span> <span class='hs-varid'>substVarSet</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-comment'>-- ** Operations on substitutions</span>
<a name="line-21"></a>	<span class='hs-varid'>emptySubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEmptySubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOpenSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>substInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptySubst</span><span class='hs-layout'>,</span> 
<a name="line-22"></a> 	<span class='hs-varid'>extendIdSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendIdSubstList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstList</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>extendCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCvSubstList</span><span class='hs-layout'>,</span>
<a name="line-24"></a>	<span class='hs-varid'>extendSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendSubstList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendSubstWithVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>addInScopeSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendInScopeList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendInScopeIds</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInScope</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>delBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>delBndrs</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>	<span class='hs-comment'>-- ** Substituting and cloning binders</span>
<a name="line-30"></a>	<span class='hs-varid'>substBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>substRecBndrs</span><span class='hs-layout'>,</span>
<a name="line-31"></a>	<span class='hs-varid'>cloneBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneIdBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneIdBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneRecIdBndrs</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>	<span class='hs-comment'>-- ** Simple expression optimiser</span>
<a name="line-34"></a>        <span class='hs-varid'>simpleOptPgm</span><span class='hs-layout'>,</span> <span class='hs-varid'>simpleOptExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>simpleOptExprWith</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>exprIsConApp_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprIsLiteral_maybe</span>
<a name="line-36"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Literal</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccurAnal</span><span class='hs-layout'>(</span> <span class='hs-varid'>occurAnalyseExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>occurAnalysePgm</span> <span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Type</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Coercion</span>
<a name="line-48"></a>
<a name="line-49"></a>	<span class='hs-comment'>-- We are defining local versions</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>     <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstList</span>
<a name="line-51"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneTyVarBndr</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVarBndr</span> <span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>tyConArity</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>eqBoxDataConKey</span> <span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OptCoercion</span> <span class='hs-layout'>(</span> <span class='hs-varid'>optCoercion</span> <span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>pprCoreBindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprRules</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>	   <span class='hs-layout'>(</span> <span class='hs-conid'>Module</span> <span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>	<span class='hs-layout'>(</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isAlwaysActive</span> <span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>		<span class='hs-conid'>()</span>		<span class='hs-comment'>-- Instances</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Substitutions}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Subst"></a><span class='hs-comment'>-- | A substitution environment, containing both 'Id' and 'TyVar' substitutions.</span>
<a name="line-2"></a><a name="Subst"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><a name="Subst"></a><span class='hs-comment'>-- Some invariants apply to how you use the substitution:</span>
<a name="line-4"></a><a name="Subst"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><a name="Subst"></a><span class='hs-comment'>-- 1. #in_scope_invariant# The in-scope set contains at least those 'Id's and 'TyVar's that will be in scope /after/</span>
<a name="line-6"></a><a name="Subst"></a><span class='hs-comment'>-- applying the substitution to a term. Precisely, the in-scope set must be a superset of the free vars of the</span>
<a name="line-7"></a><a name="Subst"></a><span class='hs-comment'>-- substitution range that might possibly clash with locally-bound variables in the thing being substituted in.</span>
<a name="line-8"></a><a name="Subst"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><a name="Subst"></a><span class='hs-comment'>-- 2. #apply_once# You may apply the substitution only /once/</span>
<a name="line-10"></a><a name="Subst"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><a name="Subst"></a><span class='hs-comment'>-- There are various ways of setting up the in-scope set such that the first of these invariants hold:</span>
<a name="line-12"></a><a name="Subst"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><a name="Subst"></a><span class='hs-comment'>-- * Arrange that the in-scope set really is all the things in scope</span>
<a name="line-14"></a><a name="Subst"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><a name="Subst"></a><span class='hs-comment'>-- * Arrange that it's the free vars of the range of the substitution</span>
<a name="line-16"></a><a name="Subst"></a><span class='hs-comment'>--</span>
<a name="line-17"></a><a name="Subst"></a><span class='hs-comment'>-- * Make it empty, if you know that all the free vars of the substitution are fresh, and hence can't possibly clash</span>
<a name="line-18"></a><a name="Subst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Subst</span> 
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-conid'>InScopeSet</span>  <span class='hs-comment'>-- Variables in in scope (both Ids and TyVars) /after/</span>
<a name="line-20"></a>                      <span class='hs-comment'>-- applying the substitution</span>
<a name="line-21"></a>          <span class='hs-conid'>IdSubstEnv</span>  <span class='hs-comment'>-- Substitution for Ids</span>
<a name="line-22"></a>          <span class='hs-conid'>TvSubstEnv</span>  <span class='hs-comment'>-- Substitution from TyVars to Types</span>
<a name="line-23"></a>          <span class='hs-conid'>CvSubstEnv</span>  <span class='hs-comment'>-- Substitution from CoVars to Coercions</span>
<a name="line-24"></a>
<a name="line-25"></a>	<span class='hs-comment'>-- INVARIANT 1: See #in_scope_invariant#</span>
<a name="line-26"></a>	<span class='hs-comment'>-- This is what lets us deal with name capture properly</span>
<a name="line-27"></a>	<span class='hs-comment'>-- It's a hard invariant to check...</span>
<a name="line-28"></a>	<span class='hs-comment'>--</span>
<a name="line-29"></a>	<span class='hs-comment'>-- INVARIANT 2: The substitution is apply-once; see Note [Apply once] with</span>
<a name="line-30"></a>	<span class='hs-comment'>--		Types.TvSubstEnv</span>
<a name="line-31"></a>	<span class='hs-comment'>--</span>
<a name="line-32"></a>	<span class='hs-comment'>-- INVARIANT 3: See Note [Extending the Subst]</span>
</pre>\end{code}

Note [Extending the Subst]
~~~~~~~~~~~~~~~~~~~~~~~~~~
For a core Subst, which binds Ids as well, we make a different choice for Ids
than we do for TyVars.  

For TyVars, see Note [Extending the TvSubst] with Type.TvSubstEnv

For Ids, we have a different invariant
	The IdSubstEnv is extended *only* when the Unique on an Id changes
	Otherwise, we just extend the InScopeSet

In consequence:

* If the TvSubstEnv and IdSubstEnv are both empty, substExpr would be a
  no-op, so substExprSC ("short cut") does nothing.

  However, substExpr still goes ahead and substitutes.  Reason: we may
  want to replace existing Ids with new ones from the in-scope set, to
  avoid space leaks.

* In substIdBndr, we extend the IdSubstEnv only when the unique changes

* If the CvSubstEnv, TvSubstEnv and IdSubstEnv are all empty,
  substExpr does nothing (Note that the above rule for substIdBndr
  maintains this property.  If the incoming envts are both empty, then
  substituting the type and IdInfo can't change anything.)

* In lookupIdSubst, we *must* look up the Id in the in-scope set, because
  it may contain non-trivial changes.  Example:
	(/\a. \x:a. ...x...) Int
  We extend the TvSubstEnv with [a |-> Int]; but x's unique does not change
  so we only extend the in-scope set.  Then we must look up in the in-scope
  set when we find the occurrence of x.

* The requirement to look up the Id in the in-scope set means that we
  must NOT take no-op short cut when the IdSubst is empty.
  We must still look up every Id in the in-scope set.

* (However, we don't need to do so for expressions found in the IdSubst
  itself, whose range is assumed to be correct wrt the in-scope set.)

Why do we make a different choice for the IdSubstEnv than the
TvSubstEnv and CvSubstEnv?

* For Ids, we change the IdInfo all the time (e.g. deleting the
  unfolding), and adding it back later, so using the TyVar convention
  would entail extending the substitution almost all the time

* The simplifier wants to look up in the in-scope set anyway, in case it 
  can see a better unfolding from an enclosing case expression

* For TyVars, only coercion variables can possibly change, and they are 
  easy to spot

\begin{code}
<pre><a name="line-1"></a><a name="IdSubstEnv"></a><span class='hs-comment'>-- | An environment for substituting for 'Id's</span>
<a name="line-2"></a><a name="IdSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IdSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="isEmptySubst"></a><span class='hs-comment'>----------------------------</span>
<a name="line-5"></a><span class='hs-definition'>isEmptySubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-6"></a><span class='hs-definition'>isEmptySubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>id_env</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tv_env</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>cv_env</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="emptySubst"></a><span class='hs-definition'>emptySubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span>
<a name="line-10"></a><span class='hs-definition'>emptySubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="mkEmptySubst"></a><span class='hs-definition'>mkEmptySubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-13"></a><span class='hs-definition'>mkEmptySubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="mkSubst"></a><span class='hs-definition'>mkSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-16"></a><span class='hs-definition'>mkSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="substInScope"></a><span class='hs-comment'>-- | Find the in-scope set: see "CoreSubst#in_scope_invariant"</span>
<a name="line-19"></a><span class='hs-definition'>substInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-20"></a><span class='hs-definition'>substInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="zapSubstEnv"></a><span class='hs-comment'>-- | Remove all substitutions for 'Id's and 'Var's that might have been built up</span>
<a name="line-23"></a><span class='hs-comment'>-- while preserving the in-scope set</span>
<a name="line-24"></a><span class='hs-definition'>zapSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-25"></a><span class='hs-definition'>zapSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="extendIdSubst"></a><span class='hs-comment'>-- | Add a substitution for an 'Id' to the 'Subst': you must ensure that the in-scope set is</span>
<a name="line-28"></a><span class='hs-comment'>-- such that the "CoreSubst#in_scope_invariant" is true after extending the substitution like this</span>
<a name="line-29"></a><span class='hs-definition'>extendIdSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-30"></a><span class='hs-comment'>-- ToDo: add an ASSERT that fvs(subst-result) is already in the in-scope set</span>
<a name="line-31"></a><span class='hs-definition'>extendIdSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="extendIdSubstList"></a><span class='hs-comment'>-- | Adds multiple 'Id' substitutions to the 'Subst': see also 'extendIdSubst'</span>
<a name="line-34"></a><span class='hs-definition'>extendIdSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-35"></a><span class='hs-definition'>extendIdSubstList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="extendTvSubst"></a><span class='hs-comment'>-- | Add a substitution for a 'TyVar' to the 'Subst': you must ensure that the in-scope set is</span>
<a name="line-38"></a><span class='hs-comment'>-- such that the "CoreSubst#in_scope_invariant" is true after extending the substitution like this</span>
<a name="line-39"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-40"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="extendTvSubstList"></a><span class='hs-comment'>-- | Adds multiple 'TyVar' substitutions to the 'Subst': see also 'extendTvSubst'</span>
<a name="line-43"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-44"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="extendCvSubst"></a><span class='hs-comment'>-- | Add a substitution from a 'CoVar' to a 'Coercion' to the 'Subst': you must ensure that the in-scope set is</span>
<a name="line-47"></a><span class='hs-comment'>-- such that the "CoreSubst#in_scope_invariant" is true after extending the substitution like this</span>
<a name="line-48"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-49"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="extendCvSubstList"></a><span class='hs-comment'>-- | Adds multiple 'CoVar' -&gt; 'Coercion' substitutions to the</span>
<a name="line-52"></a><span class='hs-comment'>-- 'Subst': see also 'extendCvSubst'</span>
<a name="line-53"></a><span class='hs-definition'>extendCvSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-54"></a><span class='hs-definition'>extendCvSubstList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="extendSubst"></a><span class='hs-comment'>-- | Add a substitution appropriate to the thing being substituted</span>
<a name="line-57"></a><span class='hs-comment'>--   (whether an expression, type, or coercion). See also</span>
<a name="line-58"></a><span class='hs-comment'>--   'extendIdSubst', 'extendTvSubst', and 'extendCvSubst'.</span>
<a name="line-59"></a><span class='hs-definition'>extendSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-60"></a><span class='hs-definition'>extendSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span> <span class='hs-varid'>arg</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>of</span>
<a name="line-62"></a>      <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>var</span> <span class='hs-layout'>)</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span> <span class='hs-varid'>ty</span>
<a name="line-63"></a>      <span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>var</span> <span class='hs-layout'>)</span> <span class='hs-varid'>extendCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span> <span class='hs-varid'>co</span>
<a name="line-64"></a>      <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isId</span>    <span class='hs-varid'>var</span> <span class='hs-layout'>)</span> <span class='hs-varid'>extendIdSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span> <span class='hs-varid'>arg</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="extendSubstWithVar"></a><span class='hs-definition'>extendSubstWithVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-67"></a><span class='hs-definition'>extendSubstWithVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v2</span> <span class='hs-layout'>)</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>v1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>v2</span> <span class='hs-layout'>)</span> <span class='hs-varid'>extendCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isId</span>    <span class='hs-varid'>v2</span> <span class='hs-layout'>)</span> <span class='hs-varid'>extendIdSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="extendSubstList"></a><span class='hs-comment'>-- | Add a substitution as appropriate to each of the terms being</span>
<a name="line-73"></a><span class='hs-comment'>--   substituted (whether expressions, types, or coercions). See also</span>
<a name="line-74"></a><span class='hs-comment'>--   'extendSubst'.</span>
<a name="line-75"></a><span class='hs-definition'>extendSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreArg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-76"></a><span class='hs-definition'>extendSubstList</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst</span>
<a name="line-77"></a><span class='hs-definition'>extendSubstList</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>var</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendSubstList</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="lookupIdSubst"></a><span class='hs-comment'>-- | Find the substitution for an 'Id' in the 'Subst'</span>
<a name="line-80"></a><span class='hs-definition'>lookupIdSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-81"></a><span class='hs-definition'>lookupIdSubst</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLocalId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>v</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>ids</span>       <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInScope</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>v'</span>
<a name="line-85"></a>	<span class='hs-comment'>-- Vital! See Note [Extending the Subst]</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CoreSubst.lookupIdSubst"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> 
<a name="line-87"></a>                            <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> 
<a name="line-88"></a>		<span class='hs-conid'>Var</span> <span class='hs-varid'>v</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="lookupTvSubst"></a><span class='hs-comment'>-- | Find the substitution for a 'TyVar' in the 'Subst'</span>
<a name="line-91"></a><span class='hs-definition'>lookupTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-92"></a><span class='hs-definition'>lookupTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tvs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>v</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="lookupCvSubst"></a><span class='hs-comment'>-- | Find the coercion substitution for a 'CoVar' in the 'Subst'</span>
<a name="line-95"></a><span class='hs-definition'>lookupCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-96"></a><span class='hs-definition'>lookupCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>v</span> <span class='hs-layout'>)</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>v</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="delBndr"></a><span class='hs-definition'>delBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-99"></a><span class='hs-definition'>delBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-layout'>(</span><span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="delBndrs"></a><span class='hs-definition'>delBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-105"></a><span class='hs-definition'>delBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>delVarEnvList</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>delVarEnvList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>delVarEnvList</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-107"></a>      <span class='hs-comment'>-- Easiest thing is just delete all from all!</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="mkOpenSubst"></a><span class='hs-comment'>-- | Simultaneously substitute for a bunch of variables</span>
<a name="line-110"></a><span class='hs-comment'>--   No left-right shadowing</span>
<a name="line-111"></a><span class='hs-comment'>--   ie the substitution for   (\x \y. e) a1 a2</span>
<a name="line-112"></a><span class='hs-comment'>--      so neither x nor y scope over a1 a2</span>
<a name="line-113"></a><span class='hs-definition'>mkOpenSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreArg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-114"></a><span class='hs-definition'>mkOpenSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span>
<a name="line-115"></a>	    	          	   <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-116"></a>			  	   <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pairs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-117"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pairs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="isInScope"></a><span class='hs-comment'>------------------------------</span>
<a name="line-120"></a><span class='hs-definition'>isInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-121"></a><span class='hs-definition'>isInScope</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemInScopeSet`</span> <span class='hs-varid'>in_scope</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="addInScopeSet"></a><span class='hs-comment'>-- | Add the 'Var' to the in-scope set, but do not remove</span>
<a name="line-124"></a><span class='hs-comment'>-- any existing substitutions for it</span>
<a name="line-125"></a><span class='hs-definition'>addInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-126"></a><span class='hs-definition'>addInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="extendInScope"></a><span class='hs-comment'>-- | Add the 'Var' to the in-scope set: as a side effect,</span>
<a name="line-130"></a><span class='hs-comment'>-- and remove any existing substitutions for it</span>
<a name="line-131"></a><span class='hs-definition'>extendInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-132"></a><span class='hs-definition'>extendInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> 
<a name="line-134"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>ids</span> <span class='hs-varop'>`delVarEnv`</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>`delVarEnv`</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvs</span> <span class='hs-varop'>`delVarEnv`</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="extendInScopeList"></a><span class='hs-comment'>-- | Add the 'Var's to the in-scope set: see also 'extendInScope'</span>
<a name="line-137"></a><span class='hs-definition'>extendInScopeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-138"></a><span class='hs-definition'>extendInScopeList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetList`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> 
<a name="line-140"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>ids</span> <span class='hs-varop'>`delVarEnvList`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>`delVarEnvList`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvs</span> <span class='hs-varop'>`delVarEnvList`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="extendInScopeIds"></a><span class='hs-comment'>-- | Optimized version of 'extendInScopeList' that can be used if you are certain </span>
<a name="line-143"></a><span class='hs-comment'>-- all the things being added are 'Id's and hence none are 'TyVar's or 'CoVar's</span>
<a name="line-144"></a><span class='hs-definition'>extendInScopeIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-145"></a><span class='hs-definition'>extendInScopeIds</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span> 
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetList`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> 
<a name="line-147"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>ids</span> <span class='hs-varop'>`delVarEnvList`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="setInScope"></a><span class='hs-definition'>setInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-150"></a><span class='hs-definition'>setInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span>
</pre>\end{code}

Pretty printing, for debugging only

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Subst</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> 
<a name="line-3"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"&lt;InScope ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>getInScopeVars</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>	<span class='hs-varop'>$$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>" IdSubst   ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ids</span>
<a name="line-5"></a>	<span class='hs-varop'>$$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>" TvSubst   ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span>
<a name="line-6"></a>        <span class='hs-varop'>$$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>" CvSubst   ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cvs</span>   
<a name="line-7"></a> 	 <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'&gt;'</span>
</pre>\end{code}


%************************************************************************
%*									*
	Substituting expressions
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="substExprSC"></a><span class='hs-comment'>-- | Apply a substititon to an entire 'CoreExpr'. Rememeber, you may only </span>
<a name="line-2"></a><span class='hs-comment'>-- apply the substitution /once/: see "CoreSubst#apply_once"</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- Do *not* attempt to short-cut in the case of an empty substitution!</span>
<a name="line-5"></a><span class='hs-comment'>-- See Note [Extending the Subst]</span>
<a name="line-6"></a><span class='hs-definition'>substExprSC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-7"></a><span class='hs-definition'>substExprSC</span> <span class='hs-sel'>_doc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>orig_expr</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptySubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_expr</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "enter subst-expr" (doc $$ ppr orig_expr) $</span>
<a name="line-10"></a>                         <span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>orig_expr</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="substExpr"></a><span class='hs-definition'>substExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-13"></a><span class='hs-definition'>substExpr</span> <span class='hs-sel'>_doc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>orig_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>orig_expr</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="subst_expr"></a><span class='hs-definition'>subst_expr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-16"></a><span class='hs-definition'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>expr</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>	       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"subst_expr"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> 
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-24"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTickish</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-25"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-26"></a>       <span class='hs-comment'>-- Do not optimise even identity coercions</span>
<a name="line-27"></a>       <span class='hs-comment'>-- Reason: substitution applies to the LHS of RULES, and</span>
<a name="line-28"></a>       <span class='hs-comment'>--         if you "optimise" an identity coercion, you may</span>
<a name="line-29"></a>       <span class='hs-comment'>--         lose a binder. We optimise the LHS of rules at</span>
<a name="line-30"></a>       <span class='hs-comment'>--         construction time</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>bndr'</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-33"></a>		       <span class='hs-keyword'>where</span>
<a name="line-34"></a>			 <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>bind'</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-37"></a>		       <span class='hs-keyword'>where</span>
<a name="line-38"></a>			 <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bind</span>
<a name="line-39"></a>
<a name="line-40"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>scrut</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr'</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_alt</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-41"></a>			         <span class='hs-keyword'>where</span>
<a name="line-42"></a>			  	 <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-43"></a>
<a name="line-44"></a>    <span class='hs-varid'>go_alt</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-45"></a>				 <span class='hs-keyword'>where</span>
<a name="line-46"></a>				   <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="substBind"></a><span class='hs-comment'>-- | Apply a substititon to an entire 'CoreBind', additionally returning an updated 'Subst'</span>
<a name="line-49"></a><span class='hs-comment'>-- that should be used by subsequent substitutons.</span>
<a name="line-50"></a><span class='hs-definition'>substBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>substBindSC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="substBindSC"></a><span class='hs-definition'>substBindSC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bind</span> 	  <span class='hs-comment'>-- Short-cut if the substitution is empty</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptySubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bind</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind</span> <span class='hs-keyword'>of</span>
<a name="line-57"></a>       <span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-58"></a>          <span class='hs-keyword'>where</span>
<a name="line-59"></a>      	    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-60"></a>       <span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rhss'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-61"></a>          <span class='hs-keyword'>where</span>
<a name="line-62"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-63"></a>      	    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substRecBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-64"></a>      	    <span class='hs-varid'>rhss'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptySubst</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhss</span>
<a name="line-65"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhss</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-definition'>substBind</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr'</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-68"></a>				  <span class='hs-keyword'>where</span>
<a name="line-69"></a>				    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-definition'>substBind</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rhss'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-72"></a>			    <span class='hs-keyword'>where</span>
<a name="line-73"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-74"></a>				<span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substRecBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-75"></a>				<span class='hs-varid'>rhss'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhss</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="deShadowBinds"></a><span class='hs-comment'>-- | De-shadowing the program is sometimes a useful pre-pass. It can be done simply</span>
<a name="line-2"></a><span class='hs-comment'>-- by running over the bindings with an empty substitution, because substitution</span>
<a name="line-3"></a><span class='hs-comment'>-- returns a result that has no-shadowing guaranteed.</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- (Actually, within a single /type/ there might still be shadowing, because </span>
<a name="line-6"></a><span class='hs-comment'>-- 'substTy' is a no-op for the empty substitution, but that's probably OK.)</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- [Aug 09] This function is not used in GHC at the moment, but seems so </span>
<a name="line-9"></a><span class='hs-comment'>--          short and simple that I'm going to leave it here</span>
<a name="line-10"></a><span class='hs-definition'>deShadowBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-11"></a><span class='hs-definition'>deShadowBinds</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>substBind</span> <span class='hs-varid'>emptySubst</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
	Substituting binders
%*									*
%************************************************************************

Remember that substBndr and friends are used when doing expression
substitution only.  Their only business is substitution, so they
preserve all IdInfo (suitably substituted).  For example, we *want* to
preserve occ info in rules.

\begin{code}
<pre><a name="line-1"></a><a name="substBndr"></a><span class='hs-comment'>-- | Substitutes a 'Var' for another one according to the 'Subst' given, returning</span>
<a name="line-2"></a><span class='hs-comment'>-- the result and an updated 'Subst' that should be used by subsequent substitutons.</span>
<a name="line-3"></a><span class='hs-comment'>-- 'IdInfo' is preserved by this process, although it is substituted into appropriately.</span>
<a name="line-4"></a><span class='hs-definition'>substBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>bndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>bndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substIdBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"var-bndr"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="substBndrs"></a><span class='hs-comment'>-- | Applies 'substBndr' to a number of 'Var's, accumulating a new 'Subst' left-to-right</span>
<a name="line-11"></a><span class='hs-definition'>substBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>substBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>substBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="substRecBndrs"></a><span class='hs-comment'>-- | Substitute in a mutually recursive group of 'Id's</span>
<a name="line-15"></a><span class='hs-definition'>substRecBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-definition'>substRecBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span> 
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_bndrs</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>		<span class='hs-comment'>-- Here's the reason we need to pass rec_subst to subst_id</span>
<a name="line-19"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>(</span><span class='hs-varid'>substIdBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rec-bndr"</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="substIdBndr"></a><span class='hs-definition'>substIdBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> 
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>		<span class='hs-comment'>-- ^ Substitution to use for the IdInfo</span>
<a name="line-3"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> 	<span class='hs-comment'>-- ^ Substitition and Id to transform</span>
<a name="line-4"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- ^ Transformed pair</span>
<a name="line-5"></a>				<span class='hs-comment'>-- NB: unfolding may be zapped</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>substIdBndr</span> <span class='hs-sel'>_doc</span> <span class='hs-varid'>rec_subst</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_id</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "substIdBndr" (doc $$ ppr old_id $$ ppr in_scope) $</span>
<a name="line-9"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>id1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_id</span>	<span class='hs-comment'>-- id1 is cloned if necessary</span>
<a name="line-12"></a>    <span class='hs-varid'>id2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_type_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id1</span>
<a name="line-13"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdType</span> <span class='hs-varid'>id1</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ty</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-varid'>old_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>old_id</span>
<a name="line-16"></a>    <span class='hs-varid'>no_type_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>||</span> 
<a name="line-17"></a>                     <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>old_ty</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a>	<span class='hs-comment'>-- new_id has the right IdInfo</span>
<a name="line-20"></a>	<span class='hs-comment'>-- The lazy-set is because we're in a loop here, with </span>
<a name="line-21"></a>	<span class='hs-comment'>-- rec_subst, when dealing with a mutually-recursive group</span>
<a name="line-22"></a>    <span class='hs-varid'>new_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeModifyIdInfo</span> <span class='hs-varid'>mb_new_info</span> <span class='hs-varid'>id2</span>
<a name="line-23"></a>    <span class='hs-varid'>mb_new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substIdInfo</span> <span class='hs-varid'>rec_subst</span> <span class='hs-varid'>id2</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id2</span><span class='hs-layout'>)</span>
<a name="line-24"></a>	<span class='hs-comment'>-- NB: unfolding info may be zapped</span>
<a name="line-25"></a>
<a name="line-26"></a>	<span class='hs-comment'>-- Extend the substitution if the unique has changed</span>
<a name="line-27"></a>	<span class='hs-comment'>-- See the notes with substTyVarBndr for the delVarEnv</span>
<a name="line-28"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>old_id</span>
<a name="line-29"></a>	    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>old_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_id</span>
<a name="line-32"></a>	<span class='hs-comment'>-- See Note [Extending the Subst]</span>
<a name="line-33"></a>	<span class='hs-comment'>-- it's /not/ necessary to check mb_new_info and no_type_change</span>
</pre>\end{code}

Now a variant that unconditionally allocates a new unique.
It also unconditionally zaps the OccInfo.

\begin{code}
<pre><a name="line-1"></a><a name="cloneIdBndr"></a><span class='hs-comment'>-- | Very similar to 'substBndr', but it always allocates a new 'Unique' for</span>
<a name="line-2"></a><span class='hs-comment'>-- each variable in its output.  It substitutes the IdInfo though.</span>
<a name="line-3"></a><span class='hs-definition'>cloneIdBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>cloneIdBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>us</span> <span class='hs-varid'>old_id</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clone_id</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>uniqFromSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="cloneIdBndrs"></a><span class='hs-comment'>-- | Applies 'cloneIdBndr' to a number of 'Id's, accumulating a final</span>
<a name="line-8"></a><span class='hs-comment'>-- substitution from left to right</span>
<a name="line-9"></a><span class='hs-definition'>cloneIdBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>cloneIdBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>us</span> <span class='hs-varid'>ids</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>(</span><span class='hs-varid'>clone_id</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="cloneBndrs"></a><span class='hs-definition'>cloneBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-comment'>-- Works for all kinds of variables (typically case binders)</span>
<a name="line-15"></a><span class='hs-comment'>-- not just Ids</span>
<a name="line-16"></a><span class='hs-definition'>cloneBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>us</span> <span class='hs-varid'>vs</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cloneBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>u</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>vs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="cloneBndr"></a><span class='hs-definition'>cloneBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>cloneBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>v</span>
<a name="line-21"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cloneTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>uniq</span>
<a name="line-22"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clone_id</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>uniq</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Works for coercion variables too</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="cloneRecIdBndrs"></a><span class='hs-comment'>-- | Clone a mutually recursive group of 'Id's</span>
<a name="line-25"></a><span class='hs-definition'>cloneRecIdBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-definition'>cloneRecIdBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>us</span> <span class='hs-varid'>ids</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids'</span><span class='hs-layout'>)</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>(</span><span class='hs-varid'>clone_id</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-30"></a>			       <span class='hs-layout'>(</span><span class='hs-varid'>ids</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="clone_id"></a><span class='hs-comment'>-- Just like substIdBndr, except that it always makes a new unique</span>
<a name="line-33"></a><span class='hs-comment'>-- It is given the unique to use</span>
<a name="line-34"></a><span class='hs-definition'>clone_id</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span>			<span class='hs-comment'>-- Substitution for the IdInfo</span>
<a name="line-35"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Substitition and Id to transform</span>
<a name="line-36"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Transformed pair</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-definition'>clone_id</span> <span class='hs-varid'>rec_subst</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>idvs</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_idvs</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>new_cvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyword'>where</span>
<a name="line-41"></a>    <span class='hs-varid'>id1</span>	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span> <span class='hs-varid'>old_id</span> <span class='hs-varid'>uniq</span>
<a name="line-42"></a>    <span class='hs-varid'>id2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substIdType</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>id1</span>
<a name="line-43"></a>    <span class='hs-varid'>new_id</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeModifyIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>substIdInfo</span> <span class='hs-varid'>rec_subst</span> <span class='hs-varid'>id2</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>old_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>id2</span>
<a name="line-44"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_idvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_cvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>idvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>old_id</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>idvs</span> <span class='hs-varid'>old_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
		Types and Coercions
%*									*
%************************************************************************

For types and coercions we just call the corresponding functions in
Type and Coercion, but we have to repackage the substitution, from a
Subst to a TvSubst.

\begin{code}
<pre><a name="line-1"></a><a name="substTyVarBndr"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>	<span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>tv_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> 
<a name="line-5"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>tv_env'</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="cloneTyVarBndr"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-8"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>uniq</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>cloneTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>uniq</span> <span class='hs-keyword'>of</span>
<a name="line-10"></a>	<span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>tv_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> 
<a name="line-11"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>tv_env'</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="substCoVarBndr"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>substCoVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-16"></a>	<span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>tv_env'</span> <span class='hs-varid'>cv_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span> 
<a name="line-17"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>tv_env'</span> <span class='hs-varid'>cv_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="substTy"></a><span class='hs-comment'>-- | See 'Type.substTy'</span>
<a name="line-20"></a><span class='hs-definition'>substTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> 
<a name="line-21"></a><span class='hs-definition'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="getTvSubst"></a><span class='hs-definition'>getTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-24"></a><span class='hs-definition'>getTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="getCvSubst"></a><span class='hs-definition'>getCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-27"></a><span class='hs-definition'>getCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="substCo"></a><span class='hs-comment'>-- | See 'Coercion.substCo'</span>
<a name="line-30"></a><span class='hs-definition'>substCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-31"></a><span class='hs-definition'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
</pre>\end{code}


%************************************************************************
%*									*
\section{IdInfo substitution}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="substIdType"></a><span class='hs-definition'>substIdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><span class='hs-definition'>substIdType</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tv_env</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>old_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdType</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ty</span><span class='hs-layout'>)</span>
<a name="line-5"></a>		<span class='hs-comment'>-- The tyVarsOfType is cheaper than it looks</span>
<a name="line-6"></a>		<span class='hs-comment'>-- because we cache the free tyvars of the type</span>
<a name="line-7"></a>		<span class='hs-comment'>-- in a Note in the id's type itself</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>old_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>id</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="substIdInfo"></a><span class='hs-comment'>------------------</span>
<a name="line-12"></a><span class='hs-comment'>-- | Substitute into some 'IdInfo' with regard to the supplied new 'Id'.</span>
<a name="line-13"></a><span class='hs-definition'>substIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>IdInfo</span>
<a name="line-14"></a><span class='hs-definition'>substIdInfo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>new_id</span> <span class='hs-varid'>info</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nothing_to_do</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span> <span class='hs-varop'>`setSpecInfo`</span>      <span class='hs-varid'>substSpec</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>new_id</span> <span class='hs-varid'>old_rules</span>
<a name="line-17"></a>			       <span class='hs-varop'>`setUnfoldingInfo`</span> <span class='hs-varid'>substUnfolding</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_unf</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>old_rules</span> 	  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>specInfo</span> <span class='hs-varid'>info</span>
<a name="line-20"></a>    <span class='hs-varid'>old_unf</span>	  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>info</span>
<a name="line-21"></a>    <span class='hs-varid'>nothing_to_do</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptySpecInfo</span> <span class='hs-varid'>old_rules</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isClosedUnfolding</span> <span class='hs-varid'>old_unf</span>
<a name="line-22"></a>    
<a name="line-23"></a>
<a name="line-24"></a><a name="substUnfolding"></a><span class='hs-comment'>------------------</span>
<a name="line-25"></a><span class='hs-comment'>-- | Substitutes for the 'Id's within an unfolding</span>
<a name="line-26"></a><span class='hs-definition'>substUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>substUnfoldingSC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-27"></a>	<span class='hs-comment'>-- Seq'ing on the returned Unfolding is enough to cause</span>
<a name="line-28"></a>	<span class='hs-comment'>-- all the substitutions to happen completely</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="substUnfoldingSC"></a><span class='hs-definition'>substUnfoldingSC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>unf</span> 	 <span class='hs-comment'>-- Short-cut version</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptySubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substUnfolding</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>unf</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>substUnfolding</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>df</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>df</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args'</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span><span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-38"></a>    <span class='hs-varid'>args'</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"subst-unf:dfun"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>substUnfolding</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>unf</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpl</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-41"></a>	<span class='hs-comment'>-- Retain an InlineRule!</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStableSource</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Zap an unstable unfolding, to save substitution work</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoUnfolding</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-comment'>-- But keep a stable one!</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqExpr</span> <span class='hs-varid'>new_tmpl</span> <span class='hs-varop'>`seq`</span>
<a name="line-46"></a>    <span class='hs-varid'>unf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tmpl</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>  <span class='hs-keyword'>where</span>
<a name="line-48"></a>    <span class='hs-varid'>new_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"subst-unf"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tmpl</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-definition'>substUnfolding</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf</span>	<span class='hs-comment'>-- NoUnfolding, OtherCon</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="substIdOcc"></a><span class='hs-comment'>------------------</span>
<a name="line-53"></a><span class='hs-definition'>substIdOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-54"></a><span class='hs-comment'>-- These Ids should not be substituted to non-Ids</span>
<a name="line-55"></a><span class='hs-definition'>substIdOcc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"substIdOcc"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>of</span>
<a name="line-56"></a>	   	        <span class='hs-conid'>Var</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v'</span>
<a name="line-57"></a>			<span class='hs-varid'>other</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"substIdOcc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="substSpec"></a><span class='hs-comment'>------------------</span>
<a name="line-60"></a><span class='hs-comment'>-- | Substitutes for the 'Id's within the 'WorkerInfo' given the new function 'Id'</span>
<a name="line-61"></a><span class='hs-definition'>substSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SpecInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SpecInfo</span>
<a name="line-62"></a><span class='hs-definition'>substSpec</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>new_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecInfo</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqSpecInfo</span> <span class='hs-varid'>new_spec</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>new_spec</span>
<a name="line-64"></a>  <span class='hs-keyword'>where</span>
<a name="line-65"></a>    <span class='hs-varid'>subst_ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span>
<a name="line-66"></a>    <span class='hs-varid'>new_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substRule</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>subst_ru_fn</span><span class='hs-layout'>)</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>substVarSet</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="substRulesForImportedIds"></a><span class='hs-comment'>------------------</span>
<a name="line-70"></a><span class='hs-definition'>substRulesForImportedIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>
<a name="line-71"></a><span class='hs-definition'>substRulesForImportedIds</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rules</span> 
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substRule</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>not_needed</span><span class='hs-layout'>)</span> <span class='hs-varid'>rules</span>
<a name="line-73"></a>  <span class='hs-keyword'>where</span>
<a name="line-74"></a>    <span class='hs-varid'>not_needed</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"substRulesForImportedIds"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="substRule"></a><span class='hs-comment'>------------------</span>
<a name="line-77"></a><span class='hs-definition'>substRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-comment'>-- The subst_ru_fn argument is applied to substitute the ru_fn field</span>
<a name="line-80"></a><span class='hs-comment'>-- of the rule:</span>
<a name="line-81"></a><span class='hs-comment'>--    - Rules for *imported* Ids never change ru_fn</span>
<a name="line-82"></a><span class='hs-comment'>--    - Rules for *local* Ids are in the IdInfo for that Id,</span>
<a name="line-83"></a><span class='hs-comment'>--      and the ru_fn field is simply replaced by the new name </span>
<a name="line-84"></a><span class='hs-comment'>--      of the Id</span>
<a name="line-85"></a><span class='hs-definition'>substRule</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule</span>
<a name="line-86"></a><span class='hs-definition'>substRule</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>subst_ru_fn</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span>
<a name="line-87"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span>
<a name="line-88"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ru_local</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_local</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> 
<a name="line-90"></a>           <span class='hs-varid'>ru_fn</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>is_local</span> 
<a name="line-91"></a>                        <span class='hs-keyword'>then</span> <span class='hs-varid'>subst_ru_fn</span> <span class='hs-varid'>fn_name</span> 
<a name="line-92"></a>                        <span class='hs-keyword'>else</span> <span class='hs-varid'>fn_name</span><span class='hs-layout'>,</span>
<a name="line-93"></a>           <span class='hs-varid'>ru_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"subst-rule"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fn_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span>
<a name="line-94"></a>           <span class='hs-varid'>ru_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExprWith</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>           <span class='hs-comment'>-- Do simple optimisation on RHS, in case substitution lets</span>
<a name="line-96"></a>           <span class='hs-comment'>-- you improve it.  The real simplifier never gets to look at it.</span>
<a name="line-97"></a>  <span class='hs-keyword'>where</span>
<a name="line-98"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="substVects"></a><span class='hs-comment'>------------------</span>
<a name="line-101"></a><span class='hs-definition'>substVects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreVect</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreVect</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a><span class='hs-definition'>substVects</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substVect</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="substVect"></a><span class='hs-comment'>------------------</span>
<a name="line-105"></a><span class='hs-definition'>substVect</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreVect</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreVect</span>
<a name="line-106"></a><span class='hs-definition'>substVect</span> <span class='hs-varid'>subst</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Vect</span> <span class='hs-varid'>v</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Vect</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>simpleOptExprWith</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-definition'>substVect</span> <span class='hs-sel'>_subst</span> <span class='hs-varid'>vd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NoVect</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vd</span>
<a name="line-108"></a><span class='hs-definition'>substVect</span> <span class='hs-sel'>_subst</span> <span class='hs-varid'>vd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>VectType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vd</span>
<a name="line-109"></a><span class='hs-definition'>substVect</span> <span class='hs-sel'>_subst</span> <span class='hs-varid'>vd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>VectClass</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vd</span>
<a name="line-110"></a><span class='hs-definition'>substVect</span> <span class='hs-sel'>_subst</span> <span class='hs-varid'>vd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>VectInst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vd</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="substVarSet"></a><span class='hs-comment'>------------------</span>
<a name="line-113"></a><span class='hs-definition'>substVarSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-114"></a><span class='hs-definition'>substVarSet</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fvs</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>subst_fv</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>fvs</span>
<a name="line-116"></a>  <span class='hs-keyword'>where</span>
<a name="line-117"></a>    <span class='hs-varid'>subst_fv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fv</span> 
<a name="line-118"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>fv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprFreeVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"substVarSet"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span>
<a name="line-119"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="substTickish"></a><span class='hs-comment'>------------------</span>
<a name="line-122"></a><span class='hs-definition'>substTickish</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span>
<a name="line-123"></a><span class='hs-definition'>substTickish</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-124"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>do_one</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getIdFromTrivialExpr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"subst_tickish"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-125"></a><span class='hs-definition'>substTickish</span> <span class='hs-sel'>_subst</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-comment'>{- Note [substTickish]
<a name="line-128"></a>
<a name="line-129"></a>A Breakpoint contains a list of Ids.  What happens if we ever want to
<a name="line-130"></a>substitute an expression for one of these Ids?
<a name="line-131"></a>
<a name="line-132"></a>First, we ensure that we only ever substitute trivial expressions for
<a name="line-133"></a>these Ids, by marking them as NoOccInfo in the occurrence analyser.
<a name="line-134"></a>Then, when substituting for the Id, we unwrap any type applications
<a name="line-135"></a>and abstractions to get back to an Id, with getIdFromTrivialExpr.
<a name="line-136"></a>
<a name="line-137"></a>Second, we have to ensure that we never try to substitute a literal
<a name="line-138"></a>for an Id in a breakpoint.  We ensure this by never storing an Id with
<a name="line-139"></a>an unlifted type in a Breakpoint - see Coverage.mkTickish.
<a name="line-140"></a>Breakpoints can't handle free variables with unlifted types anyway.
<a name="line-141"></a>-}</span>
</pre>\end{code}

Note [Worker inlining]
~~~~~~~~~~~~~~~~~~~~~~
A worker can get sustituted away entirely.
	- it might be trivial
	- it might simply be very small
We do not treat an InlWrapper as an 'occurrence' in the occurrence 
analyser, so it's possible that the worker is not even in scope any more.

In all all these cases we simply drop the special case, returning to
InlVanilla.  The WARN is just so I can see if it happens a lot.


%************************************************************************
%*									*
	The Very Simple Optimiser
%*									*
%************************************************************************

Note [Optimise coercion boxes agressively]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The simple expression optimiser needs to deal with Eq# boxes as follows:
 1. If the result of optimising the RHS of a non-recursive binding is an
    Eq# box, that box is substituted rather than turned into a let, just as
    if it were trivial.
       let eqv = Eq# co in e ==> e[Eq# co/eqv]

 2. If the result of optimising a case scrutinee is a Eq# box and the case
    deconstructs it in a trivial way, we evaluate the case then and there.
      case Eq# co of Eq# cov -> e ==> e[co/cov]

We do this for two reasons:

 1. Bindings/case scrutinisation of this form is often created by the
    evidence-binding mechanism and we need them to be inlined to be able
    desugar RULE LHSes that involve equalities (see e.g. T2291)

 2. The test T4356 fails Lint because it creates a coercion between types
    of kind (* -> * -> *) and (?? -> ? -> *), which differ. If we do this
    inlining agressively we can collapse away the intermediate coercion between
    these two types and hence pass Lint again. (This is a sort of a hack.)

In fact, our implementation uses slightly liberalised versions of the second rule
rule so that the optimisations are a bit more generally applicable. Precisely:
 2a. We reduce any situation where we can spot a case-of-known-constructor

As a result, the only time we should get residual coercion boxes in the code is
when the type checker generates something like:

  \eqv -> let eqv' = Eq# (case eqv of Eq# cov -> ... cov ...)

However, the case of lambda-bound equality evidence is fairly rare, so these two
rules should suffice for solving the rule LHS problem for now.

Annoyingly, we cannot use this modified rule 1a instead of 1:

 1a. If we come across a let-bound constructor application with trivial arguments,
     add an appropriate unfolding to the let binder.  We spot constructor applications
     by using exprIsConApp_maybe, so this would actually let rule 2a reduce more.

The reason is that we REALLY NEED coercion boxes to be substituted away. With rule 1a
we wouldn't simplify this expression at all:

  let eqv = Eq# co
  in foo eqv (bar eqv)

The rule LHS desugarer can't deal with Let at all, so we need to push that box into
the use sites.

\begin{code}
<pre><a name="line-1"></a><a name="simpleOptExpr"></a><span class='hs-definition'>simpleOptExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a><span class='hs-comment'>-- Do simple optimisation on an expression</span>
<a name="line-3"></a><span class='hs-comment'>-- The optimisation is very straightforward: just</span>
<a name="line-4"></a><span class='hs-comment'>-- inline non-recursive bindings that are used only once, </span>
<a name="line-5"></a><span class='hs-comment'>-- or where the RHS is trivial</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-- We also inline bindings that bind a Eq# box: see</span>
<a name="line-8"></a><span class='hs-comment'>-- See Note [Optimise coercion boxes agressively].</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-- The result is NOT guaranteed occurrence-analysed, because</span>
<a name="line-11"></a><span class='hs-comment'>-- in  (let x = y in ....) we substitute for x; so y's occ-info</span>
<a name="line-12"></a><span class='hs-comment'>-- may change radically</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>simpleOptExpr</span> <span class='hs-varid'>expr</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "simpleOptExpr" (ppr init_subst $$ ppr expr)</span>
<a name="line-16"></a>    <span class='hs-varid'>simpleOptExprWith</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>expr</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>    <span class='hs-varid'>init_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptySubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>	<span class='hs-comment'>-- It's potentially important to make a proper in-scope set</span>
<a name="line-20"></a>	<span class='hs-comment'>-- Consider  let x = ..y.. in \y. ...x...</span>
<a name="line-21"></a>	<span class='hs-comment'>-- Then we should remember to clone y before substituting</span>
<a name="line-22"></a>	<span class='hs-comment'>-- for x.  It's very unlikely to occur, because we probably</span>
<a name="line-23"></a>	<span class='hs-comment'>-- won't *be* substituting for x if it occurs inside a</span>
<a name="line-24"></a>	<span class='hs-comment'>-- lambda.  </span>
<a name="line-25"></a>	<span class='hs-comment'>--</span>
<a name="line-26"></a>        <span class='hs-comment'>-- It's a bit painful to call exprFreeVars, because it makes</span>
<a name="line-27"></a>	<span class='hs-comment'>-- three passes instead of two (occ-anal, and go)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="simpleOptExprWith"></a><span class='hs-definition'>simpleOptExprWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span>
<a name="line-30"></a><span class='hs-definition'>simpleOptExprWith</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="simpleOptPgm"></a><span class='hs-comment'>----------------------</span>
<a name="line-33"></a><span class='hs-definition'>simpleOptPgm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> 
<a name="line-34"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreVect</span><span class='hs-keyglyph'>]</span> 
<a name="line-35"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreProgram</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreVect</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-definition'>simpleOptPgm</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>vects</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_occur_anal</span> <span class='hs-str'>"Occurrence analysis"</span>
<a name="line-38"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>pprCoreBindings</span> <span class='hs-varid'>occ_anald_binds</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprRules</span> <span class='hs-varid'>rules</span> <span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-39"></a>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>substRulesForImportedIds</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>rules</span><span class='hs-layout'>,</span> <span class='hs-varid'>substVects</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>vects</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>  <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>occ_anald_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurAnalysePgm</span> <span class='hs-varid'>this_mod</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-comment'>{- No rules active -}</span>
<a name="line-43"></a>                                       <span class='hs-varid'>rules</span> <span class='hs-varid'>vects</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>binds</span>
<a name="line-44"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptySubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ_anald_binds</span>
<a name="line-45"></a>                       
<a name="line-46"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-varid'>bind</span> 
<a name="line-47"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>simple_opt_bind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bind</span> <span class='hs-keyword'>of</span>
<a name="line-48"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span>
<a name="line-49"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-conop'>:</span><span class='hs-varid'>binds'</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="InVar"></a><span class='hs-comment'>----------------------</span>
<a name="line-52"></a><a name="InVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InVar</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span>
<a name="line-53"></a><a name="OutVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutVar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span>
<a name="line-54"></a><a name="InId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InId</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span>
<a name="line-55"></a><a name="OutId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutId</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span>
<a name="line-56"></a><a name="InExpr"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InExpr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-57"></a><a name="OutExpr"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-comment'>-- In these functions the substitution maps InVar -&gt; OutExpr</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="simple_opt_expr"></a><span class='hs-comment'>----------------------</span>
<a name="line-62"></a><span class='hs-definition'>simple_opt_expr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span>
<a name="line-63"></a><span class='hs-definition'>simple_opt_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>expr</span>
<a name="line-65"></a>  <span class='hs-keyword'>where</span>
<a name="line-66"></a>    <span class='hs-varid'>in_scope_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>substInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>simpleUnfoldingFun</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"simpleOptExpr"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-69"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple_app</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>go</span> <span class='hs-varid'>e2</span><span class='hs-keyglyph'>]</span>
<a name="line-70"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>     <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-71"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>optCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-72"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span>
<a name="line-73"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTickish</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tickish</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-74"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-75"></a>       	                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>co'</span> 
<a name="line-76"></a>                        <span class='hs-keyword'>where</span>
<a name="line-77"></a>                          <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>optCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>simple_opt_bind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bind</span> <span class='hs-keyword'>of</span>
<a name="line-80"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>body</span>
<a name="line-81"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>lam</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_lam</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lam</span>
<a name="line-84"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-85"></a>       <span class='hs-comment'>-- See Note [Optimise coercion boxes agressively]</span>
<a name="line-86"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDeadBinder</span> <span class='hs-varid'>b</span>
<a name="line-87"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-sel'>_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>exprIsConApp_maybe</span> <span class='hs-varid'>in_scope_env</span> <span class='hs-varid'>e'</span>
<a name="line-88"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>altcon</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findAlt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-89"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>altcon</span> <span class='hs-keyword'>of</span>
<a name="line-90"></a>          <span class='hs-conid'>DEFAULT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rhs</span>
<a name="line-91"></a>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkLets</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>mb_binds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>rhs</span>
<a name="line-92"></a>            <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>simple_opt_out_bind</span> <span class='hs-varid'>subst</span> 
<a name="line-93"></a>                                                 <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"simpleOptExpr"</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-96"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-97"></a>       		   <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_alt</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-98"></a>        <span class='hs-keyword'>where</span>
<a name="line-99"></a>          <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span>
<a name="line-100"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_opt_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span>
<a name="line-101"></a>
<a name="line-102"></a>    <span class='hs-comment'>----------------------</span>
<a name="line-103"></a>    <span class='hs-varid'>go_alt</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> 
<a name="line-104"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-105"></a>      <span class='hs-keyword'>where</span>
<a name="line-106"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_opt_bndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-107"></a>
<a name="line-108"></a>    <span class='hs-comment'>----------------------</span>
<a name="line-109"></a>    <span class='hs-comment'>-- go_lam tries eta reduction</span>
<a name="line-110"></a>    <span class='hs-varid'>go_lam</span> <span class='hs-varid'>bs'</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-111"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_lam</span> <span class='hs-layout'>(</span><span class='hs-varid'>b'</span><span class='hs-conop'>:</span><span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>e</span>
<a name="line-112"></a>       <span class='hs-keyword'>where</span>
<a name="line-113"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_opt_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span>
<a name="line-114"></a>    <span class='hs-varid'>go_lam</span> <span class='hs-varid'>bs'</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span> 
<a name="line-115"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>etad_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryEtaReduce</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etad_e</span>
<a name="line-116"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>e'</span>
<a name="line-117"></a>       <span class='hs-keyword'>where</span>
<a name="line-118"></a>         <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>bs'</span>
<a name="line-119"></a>         <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="simple_app"></a><span class='hs-comment'>----------------------</span>
<a name="line-122"></a><span class='hs-comment'>-- simple_app collects arguments for beta reduction</span>
<a name="line-123"></a><span class='hs-definition'>simple_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OutExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-124"></a><span class='hs-definition'>simple_app</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>   
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple_app</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e1</span> <span class='hs-layout'>(</span><span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e2</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-126"></a><span class='hs-definition'>simple_app</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> 
<a name="line-127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_substitute</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>of</span>
<a name="line-128"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ext_subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simple_app</span> <span class='hs-varid'>ext_subst</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>as</span>
<a name="line-129"></a>      <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b2</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>simple_app</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-130"></a>  <span class='hs-keyword'>where</span>
<a name="line-131"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_opt_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span>
<a name="line-132"></a>    <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_info</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>b</span> <span class='hs-varid'>b'</span>
<a name="line-133"></a><span class='hs-definition'>simple_app</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>as</span>
<a name="line-134"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="simple_opt_bind"></a><span class='hs-comment'>----------------------</span>
<a name="line-137"></a><span class='hs-definition'>simple_opt_bind</span><span class='hs-layout'>,</span><span class='hs-varid'>simple_opt_bind'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-definition'>simple_opt_bind</span> <span class='hs-varid'>s</span> <span class='hs-varid'>b</span> 		  <span class='hs-comment'>-- Can add trace stuff here</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple_opt_bind'</span> <span class='hs-varid'>s</span> <span class='hs-varid'>b</span>
<a name="line-140"></a>
<a name="line-141"></a><a name="simple_opt_bind'"></a><span class='hs-definition'>simple_opt_bind'</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_bind</span><span class='hs-layout'>)</span>
<a name="line-143"></a>  <span class='hs-keyword'>where</span>
<a name="line-144"></a>    <span class='hs-varid'>res_bind</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rev_prs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-145"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_opt_bndrs</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-146"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>rev_prs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>do_pr</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>prs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span>
<a name="line-147"></a>    <span class='hs-varid'>do_pr</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> 
<a name="line-148"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_substitute</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r2</span> <span class='hs-keyword'>of</span>
<a name="line-149"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-150"></a>           <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span>  <span class='hs-layout'>(</span><span class='hs-varid'>b2</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-151"></a>       <span class='hs-keyword'>where</span>
<a name="line-152"></a>         <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_info</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>b'</span>
<a name="line-153"></a>         <span class='hs-varid'>r2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>r</span>
<a name="line-154"></a>
<a name="line-155"></a><span class='hs-definition'>simple_opt_bind'</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simple_opt_out_bind</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>simple_opt_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="simple_opt_out_bind"></a><span class='hs-comment'>----------------------</span>
<a name="line-159"></a><span class='hs-definition'>simple_opt_out_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>InVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-160"></a><span class='hs-definition'>simple_opt_out_bind</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>r'</span><span class='hs-layout'>)</span> 
<a name="line-161"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ext_subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_substitute</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r'</span>
<a name="line-162"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ext_subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-164"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b2</span> <span class='hs-varid'>r'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-165"></a>  <span class='hs-keyword'>where</span>
<a name="line-166"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_opt_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span>
<a name="line-167"></a>    <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_info</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>b</span> <span class='hs-varid'>b'</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="maybe_substitute"></a><span class='hs-comment'>----------------------</span>
<a name="line-170"></a><span class='hs-definition'>maybe_substitute</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Subst</span>
<a name="line-171"></a>    <span class='hs-comment'>-- (maybe_substitute subst in_var out_rhs)  </span>
<a name="line-172"></a>    <span class='hs-comment'>--   either extends subst with (in_var -&gt; out_rhs)</span>
<a name="line-173"></a>    <span class='hs-comment'>--   or     returns Nothing</span>
<a name="line-174"></a><span class='hs-definition'>maybe_substitute</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span>
<a name="line-175"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>r</span> 	<span class='hs-comment'>-- let a::* = TYPE ty in &lt;body&gt;</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>b</span> <span class='hs-layout'>)</span>
<a name="line-177"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>r</span>
<a name="line-180"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>b</span> <span class='hs-layout'>)</span>
<a name="line-181"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-182"></a>
<a name="line-183"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>b</span>              <span class='hs-comment'>-- let x = e in &lt;body&gt;</span>
<a name="line-184"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoVar</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- See Note [Do not inline CoVars unconditionally]</span>
<a name="line-185"></a>    		 	<span class='hs-comment'>-- in SimplUtils</span>
<a name="line-186"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>safe_to_inline</span> <span class='hs-layout'>(</span><span class='hs-varid'>idOccInfo</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> 
<a name="line-187"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isAlwaysActive</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlineActivation</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Note [Inline prag in simplOpt]</span>
<a name="line-188"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStableUnfolding</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnfolding</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-189"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExportedId</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-190"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>exprOkForSpeculation</span> <span class='hs-varid'>r</span>
<a name="line-191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-192"></a>  
<a name="line-193"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-194"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-195"></a>  <span class='hs-keyword'>where</span>
<a name="line-196"></a>	<span class='hs-comment'>-- Unconditionally safe to inline</span>
<a name="line-197"></a>    <span class='hs-varid'>safe_to_inline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-198"></a>    <span class='hs-varid'>safe_to_inline</span> <span class='hs-layout'>(</span><span class='hs-conid'>IAmALoopBreaker</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-199"></a>    <span class='hs-varid'>safe_to_inline</span> <span class='hs-conid'>IAmDead</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-200"></a>    <span class='hs-varid'>safe_to_inline</span> <span class='hs-layout'>(</span><span class='hs-conid'>OneOcc</span> <span class='hs-varid'>in_lam</span> <span class='hs-varid'>one_br</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>in_lam</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>one_br</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>trivial</span>
<a name="line-201"></a>    <span class='hs-varid'>safe_to_inline</span> <span class='hs-conid'>NoOccInfo</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trivial</span>
<a name="line-202"></a>
<a name="line-203"></a>    <span class='hs-varid'>trivial</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-204"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>r</span>
<a name="line-205"></a>            <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isDataConWorkId_maybe</span> <span class='hs-varid'>fun</span>
<a name="line-206"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqBoxDataConKey</span>
<a name="line-207"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- See Note [Optimise coercion boxes agressively]</span>
<a name="line-208"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-209"></a>
<a name="line-210"></a><a name="subst_opt_bndr"></a><span class='hs-comment'>----------------------</span>
<a name="line-211"></a><span class='hs-definition'>subst_opt_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutVar</span><span class='hs-layout'>)</span>
<a name="line-212"></a><span class='hs-definition'>subst_opt_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-213"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>bndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-214"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>bndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_opt_id_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="subst_opt_id_bndr"></a><span class='hs-definition'>subst_opt_id_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutId</span><span class='hs-layout'>)</span>
<a name="line-218"></a><span class='hs-comment'>-- Nuke all fragile IdInfo, unfolding, and RULES; </span>
<a name="line-219"></a><span class='hs-comment'>--    it gets added back later by add_info</span>
<a name="line-220"></a><span class='hs-comment'>-- Rather like SimplEnv.substIdBndr</span>
<a name="line-221"></a><span class='hs-comment'>--</span>
<a name="line-222"></a><span class='hs-comment'>-- It's important to zap fragile OccInfo (which CoreSubst.substIdBndr </span>
<a name="line-223"></a><span class='hs-comment'>-- carefully does not do) because simplOptExpr invalidates it</span>
<a name="line-224"></a>
<a name="line-225"></a><span class='hs-definition'>subst_opt_id_bndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>id_subst</span> <span class='hs-varid'>tv_subst</span> <span class='hs-varid'>cv_subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_id</span>
<a name="line-226"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span> <span class='hs-varid'>new_in_scope</span> <span class='hs-varid'>new_id_subst</span> <span class='hs-varid'>tv_subst</span> <span class='hs-varid'>cv_subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span>
<a name="line-227"></a>  <span class='hs-keyword'>where</span>
<a name="line-228"></a>    <span class='hs-varid'>id1</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_id</span>
<a name="line-229"></a>    <span class='hs-varid'>id2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdType</span> <span class='hs-varid'>id1</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>old_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-230"></a>    <span class='hs-varid'>new_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapFragileIdInfo</span> <span class='hs-varid'>id2</span>	<span class='hs-comment'>-- Zaps rules, worker-info, unfolding</span>
<a name="line-231"></a>					<span class='hs-comment'>-- and fragile OccInfo</span>
<a name="line-232"></a>    <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_id</span>
<a name="line-233"></a>
<a name="line-234"></a>	<span class='hs-comment'>-- Extend the substitution if the unique has changed,</span>
<a name="line-235"></a>	<span class='hs-comment'>-- or there's some useful occurrence information</span>
<a name="line-236"></a>	<span class='hs-comment'>-- See the notes with substTyVarBndr for the delSubstEnv</span>
<a name="line-237"></a>    <span class='hs-varid'>new_id_subst</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_id</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>old_id</span>
<a name="line-238"></a>	         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>id_subst</span> <span class='hs-varid'>old_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span>
<a name="line-239"></a>	         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-240"></a>	         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>id_subst</span> <span class='hs-varid'>old_id</span>
<a name="line-241"></a>
<a name="line-242"></a><a name="subst_opt_bndrs"></a><span class='hs-comment'>----------------------</span>
<a name="line-243"></a><span class='hs-definition'>subst_opt_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OutVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-244"></a><span class='hs-definition'>subst_opt_bndrs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-245"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>subst_opt_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndrs</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="add_info"></a><span class='hs-comment'>----------------------</span>
<a name="line-248"></a><span class='hs-definition'>add_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutVar</span>
<a name="line-249"></a><span class='hs-definition'>add_info</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_bndr</span> <span class='hs-varid'>new_bndr</span>
<a name="line-250"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_bndr</span>
<a name="line-251"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeModifyIdInfo</span> <span class='hs-varid'>mb_new_info</span> <span class='hs-varid'>new_bndr</span>
<a name="line-252"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>mb_new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substIdInfo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>new_bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>old_bndr</span><span class='hs-layout'>)</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="simpleUnfoldingFun"></a><span class='hs-definition'>simpleUnfoldingFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdUnfoldingFun</span>
<a name="line-255"></a><span class='hs-definition'>simpleUnfoldingFun</span> <span class='hs-varid'>id</span> 
<a name="line-256"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlwaysActive</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlineActivation</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idUnfolding</span> <span class='hs-varid'>id</span>
<a name="line-257"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUnfolding</span>
</pre>\end{code}

Note [Inline prag in simplOpt]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If there's an INLINE/NOINLINE pragma that restricts the phase in 
which the binder can be inlined, we don't inline here; after all,
we don't know what phase we're in.  Here's an example

  foo :: Int -> Int -> Int
  {-# INLINE foo #-}
  foo m n = inner m
     where
       {-# INLINE [1] inner #-}
       inner m = m+n

  bar :: Int -> Int
  bar n = foo n 1

When inlining 'foo' in 'bar' we want the let-binding for 'inner' 
to remain visible until Phase 1


%************************************************************************
%*                                                                      *
         exprIsConApp_maybe
%*                                                                      *
%************************************************************************

Note [exprIsConApp_maybe]
~~~~~~~~~~~~~~~~~~~~~~~~~
exprIsConApp_maybe is a very important function.  There are two principal
uses:
  * case e of { .... }
  * cls_op e, where cls_op is a class operation

In both cases you want to know if e is of form (C e1..en) where C is
a data constructor.

However e might not *look* as if 

\begin{code}
<pre><a name="line-1"></a><a name="ConCont"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ConCont</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CC</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Coercion</span>   
<a name="line-2"></a>                  <span class='hs-comment'>-- Substitution already applied</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="exprIsConApp_maybe"></a><span class='hs-comment'>-- | Returns @Just (dc, [t1..tk], [x1..xn])@ if the argument expression is </span>
<a name="line-5"></a><span class='hs-comment'>-- a *saturated* constructor application of the form @dc t1..tk x1 .. xn@,</span>
<a name="line-6"></a><span class='hs-comment'>-- where t1..tk are the *universally-qantified* type args of 'dc'</span>
<a name="line-7"></a><span class='hs-definition'>exprIsConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-8"></a><span class='hs-definition'>exprIsConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span><span class='hs-layout'>,</span> <span class='hs-varid'>id_unf</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-conid'>Subst</span> 
<a name="line-12"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConCont</span> 
<a name="line-13"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-14"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>cont</span>
<a name="line-15"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishIsCode</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>cont</span>
<a name="line-16"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-17"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-varid'>args</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-19"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_arg</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>var</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-21"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>arg</span>          <span class='hs-comment'>-- Don't duplicate stuff!</span>
<a name="line-22"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>extend</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-varid'>args</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>sub</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>cont</span>
<a name="line-24"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>substInScope</span> <span class='hs-varid'>sub</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-25"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"exprIsConApp"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>sub</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> 
<a name="line-26"></a>            <span class='hs-varid'>cont</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>cont</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CC</span> <span class='hs-varid'>args</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-29"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isDataConWorkId_maybe</span> <span class='hs-varid'>fun</span>
<a name="line-30"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isValArg</span> <span class='hs-varid'>args</span> <span class='hs-varop'>==</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>fun</span>
<a name="line-31"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dealWithCoercion</span> <span class='hs-varid'>co</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- Look through dictionary functions; see Note [Unfolding DFuns]</span>
<a name="line-34"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_args</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unfolding</span>
<a name="line-35"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>args</span>    <span class='hs-comment'>-- See Note [DFun arity check]</span>
<a name="line-36"></a>        <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOpenSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-37"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dealWithCoercion</span> <span class='hs-varid'>co</span> <span class='hs-varid'>con</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"exprIsConApp1"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>dfun_args</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-comment'>-- Look through unfoldings, but only arity-zero one; </span>
<a name="line-40"></a>	<span class='hs-comment'>-- if arity &gt; 0 we are effectively inlining a function call,</span>
<a name="line-41"></a>	<span class='hs-comment'>-- and that is the business of callSiteInline.</span>
<a name="line-42"></a>	<span class='hs-comment'>-- In practice, without this test, most of the "hits" were</span>
<a name="line-43"></a>	<span class='hs-comment'>-- CPR'd workers getting inlined back into their wrappers,</span>
<a name="line-44"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandUnfolding_maybe</span> <span class='hs-varid'>unfolding</span>
<a name="line-45"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>unfoldingArity</span> <span class='hs-varid'>unfolding</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> 
<a name="line-46"></a>        <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>in_scope'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-47"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>in_scope'</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>cont</span>
<a name="line-48"></a>        <span class='hs-keyword'>where</span>
<a name="line-49"></a>          <span class='hs-varid'>unfolding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_unf</span> <span class='hs-varid'>fun</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-comment'>----------------------------</span>
<a name="line-54"></a>    <span class='hs-comment'>-- Operations on the (Either InScopeSet CoreSubst)</span>
<a name="line-55"></a>    <span class='hs-comment'>-- The Left case is wildly dominant</span>
<a name="line-56"></a>    <span class='hs-varid'>subst_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-57"></a>    <span class='hs-varid'>subst_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreSubst</span><span class='hs-varop'>.</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>co</span>
<a name="line-58"></a>
<a name="line-59"></a>    <span class='hs-varid'>subst_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span>
<a name="line-60"></a>    <span class='hs-varid'>subst_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"exprIsConApp2"</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-varid'>e</span>
<a name="line-61"></a>
<a name="line-62"></a>    <span class='hs-varid'>extend</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmptySubst</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-63"></a>    <span class='hs-varid'>extend</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>       <span class='hs-varid'>v</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendSubst</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="dealWithCoercion"></a><span class='hs-definition'>dealWithCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span>
<a name="line-66"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-67"></a><span class='hs-definition'>dealWithCoercion</span> <span class='hs-varid'>co</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>dc_args</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span> 
<a name="line-69"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_ty_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUnivTyVars</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varid'>dc_args</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>dc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stripTypeArgs</span> <span class='hs-varid'>univ_ty_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest_args</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-sel'>_from_ty</span> <span class='hs-varid'>to_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-73"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>to_tc_arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>to_ty</span>
<a name="line-74"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>to_tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span>
<a name="line-75"></a>        <span class='hs-comment'>-- These two tests can fail; we might see </span>
<a name="line-76"></a>        <span class='hs-comment'>--      (C x y) `cast` (g :: T a ~ S [a]),</span>
<a name="line-77"></a>        <span class='hs-comment'>-- where S is a type function.  In fact, exprIsConApp</span>
<a name="line-78"></a>        <span class='hs-comment'>-- will probably not be called in such circumstances,</span>
<a name="line-79"></a>        <span class='hs-comment'>-- but there't nothing wrong with it </span>
<a name="line-80"></a>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- Here we do the KPush reduction rule as described in the FC paper</span>
<a name="line-82"></a>        <span class='hs-comment'>-- The transformation applies iff we have</span>
<a name="line-83"></a>        <span class='hs-comment'>--      (C e1 ... en) `cast` co</span>
<a name="line-84"></a>        <span class='hs-comment'>-- where co :: (T t1 .. tn) ~ to_ty</span>
<a name="line-85"></a>        <span class='hs-comment'>-- The left-hand one must be a T, because exprIsConApp returned True</span>
<a name="line-86"></a>        <span class='hs-comment'>-- but the right-hand one might not be.  (Though it usually will.)</span>
<a name="line-87"></a>    <span class='hs-keyword'>let</span>
<a name="line-88"></a>        <span class='hs-varid'>tc_arity</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>to_tc</span>
<a name="line-89"></a>        <span class='hs-varid'>dc_univ_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUnivTyVars</span> <span class='hs-varid'>dc</span>
<a name="line-90"></a>        <span class='hs-varid'>dc_ex_tyvars</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConExTyVars</span> <span class='hs-varid'>dc</span>
<a name="line-91"></a>        <span class='hs-varid'>arg_tys</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConRepArgTys</span> <span class='hs-varid'>dc</span>
<a name="line-92"></a>
<a name="line-93"></a>        <span class='hs-varid'>non_univ_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>dc_univ_tyvars</span> <span class='hs-varid'>dc_args</span>
<a name="line-94"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>ex_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>dc_ex_tyvars</span> <span class='hs-varid'>non_univ_args</span>
<a name="line-95"></a>
<a name="line-96"></a>        <span class='hs-comment'>-- Make the "theta" from Fig 3 of the paper</span>
<a name="line-97"></a>        <span class='hs-varid'>gammas</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposeCo</span> <span class='hs-varid'>tc_arity</span> <span class='hs-varid'>co</span>
<a name="line-98"></a>        <span class='hs-varid'>theta_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstWith</span> <span class='hs-conid'>Representational</span>
<a name="line-99"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>dc_univ_tyvars</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dc_ex_tyvars</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                                                <span class='hs-comment'>-- existentials are at role N</span>
<a name="line-101"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>gammas</span>         <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-102"></a>                                                <span class='hs-layout'>(</span><span class='hs-varid'>stripTypeArgs</span> <span class='hs-varid'>ex_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a>          <span class='hs-comment'>-- Cast the value arguments (which include dictionaries)</span>
<a name="line-105"></a>        <span class='hs-varid'>new_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>cast_arg</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>val_args</span>
<a name="line-106"></a>        <span class='hs-varid'>cast_arg</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCast</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta_subst</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-107"></a>
<a name="line-108"></a>        <span class='hs-varid'>dump_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>,</span>      <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc_univ_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc_ex_tyvars</span><span class='hs-layout'>,</span>
<a name="line-109"></a>                         <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc_args</span><span class='hs-layout'>,</span>        
<a name="line-110"></a>                         <span class='hs-varid'>ppr</span> <span class='hs-varid'>ex_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-sel'>_from_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>to_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>to_tc</span> <span class='hs-keyglyph'>]</span>
<a name="line-111"></a>    <span class='hs-keyword'>in</span>
<a name="line-112"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>eqType</span> <span class='hs-sel'>_from_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>to_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>stripTypeArgs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeList</span> <span class='hs-varid'>dc_univ_tyvars</span> <span class='hs-varid'>dc_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-113"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>dump_doc</span> <span class='hs-layout'>)</span>
<a name="line-114"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTypeArg</span> <span class='hs-varid'>ex_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>dump_doc</span> <span class='hs-layout'>)</span>
<a name="line-115"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>val_args</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>dump_doc</span> <span class='hs-layout'>)</span>
<a name="line-116"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>dc</span><span class='hs-layout'>,</span> <span class='hs-varid'>to_tc_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>new_val_args</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="stripTypeArgs"></a><span class='hs-definition'>stripTypeArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-122"></a><span class='hs-definition'>stripTypeArgs</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTypeArg</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span>
<a name="line-123"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>args</span><span class='hs-keyglyph'>]</span>
<a name="line-124"></a>  <span class='hs-comment'>-- We really do want isTypeArg here, not isTyCoArg!</span>
</pre>\end{code}

Note [Unfolding DFuns]
~~~~~~~~~~~~~~~~~~~~~~
DFuns look like

  df :: forall a b. (Eq a, Eq b) -> Eq (a,b)
  df a b d_a d_b = MkEqD (a,b) ($c1 a b d_a d_b)
                               ($c2 a b d_a d_b)

So to split it up we just need to apply the ops $c1, $c2 etc
to the very same args as the dfun.  It takes a little more work
to compute the type arguments to the dictionary constructor.

Note [DFun arity check]
~~~~~~~~~~~~~~~~~~~~~~~
Here we check that the total number of supplied arguments (inclding 
type args) matches what the dfun is expecting.  This may be *less*
than the ordinary arity of the dfun: see Note [DFun unfoldings] in CoreSyn

\begin{code}
<pre><a name="line-1"></a><a name="exprIsLiteral_maybe"></a><span class='hs-definition'>exprIsLiteral_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Literal</span>
<a name="line-2"></a><span class='hs-comment'>-- Same deal as exprIsConApp_maybe, but much simpler</span>
<a name="line-3"></a><span class='hs-comment'>-- Nevertheless we do need to look through unfoldings for</span>
<a name="line-4"></a><span class='hs-comment'>-- Integer literals, which are vigorously hoisted to top level</span>
<a name="line-5"></a><span class='hs-comment'>-- and not subsequently inlined</span>
<a name="line-6"></a><span class='hs-definition'>exprIsLiteral_maybe</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>id_unf</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-8"></a>      <span class='hs-conid'>Lit</span> <span class='hs-varid'>l</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>l</span>
<a name="line-9"></a>      <span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>exprIsLiteral_maybe</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e'</span> <span class='hs-comment'>-- dubious?</span>
<a name="line-10"></a>      <span class='hs-conid'>Var</span> <span class='hs-varid'>v</span>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandUnfolding_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>id_unf</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>exprIsLiteral_maybe</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs</span>
<a name="line-12"></a>      <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}       
</body>
</html>
