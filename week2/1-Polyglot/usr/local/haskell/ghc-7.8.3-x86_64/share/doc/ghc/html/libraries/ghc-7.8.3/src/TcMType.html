<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcMType.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
o%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Monadic type operations

This module contains monadic operations over types that contain
mutable type variables

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcMType</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>  <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTauType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVarSet</span><span class='hs-layout'>,</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-12"></a>  <span class='hs-comment'>-- Creating new mutable type variables</span>
<a name="line-13"></a>  <span class='hs-varid'>newFlexiTyVar</span><span class='hs-layout'>,</span>
<a name="line-14"></a>  <span class='hs-varid'>newFlexiTyVarTy</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Kind -&gt; TcM TcType</span>
<a name="line-15"></a>  <span class='hs-varid'>newFlexiTyVarTys</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Int -&gt; Kind -&gt; TcM [TcType]</span>
<a name="line-16"></a>  <span class='hs-varid'>newPolyFlexiTyVarTy</span><span class='hs-layout'>,</span>
<a name="line-17"></a>  <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newMetaKindVars</span><span class='hs-layout'>,</span>
<a name="line-18"></a>  <span class='hs-varid'>mkTcTyVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneMetaTyVar</span><span class='hs-layout'>,</span> 
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-varid'>newMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>readMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeMetaTyVarRef</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>newMetaDetails</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFilledMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFlexiMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-24"></a>  <span class='hs-comment'>-- Creating new evidence variables</span>
<a name="line-25"></a>  <span class='hs-varid'>newEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newEvVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>newEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>newDict</span><span class='hs-layout'>,</span>
<a name="line-26"></a>  <span class='hs-varid'>newWantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVars</span><span class='hs-layout'>,</span>
<a name="line-27"></a>  <span class='hs-varid'>newTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>addTcEvBind</span><span class='hs-layout'>,</span>
<a name="line-28"></a>  <span class='hs-varid'>newFlatWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>newFlatWanteds</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-31"></a>  <span class='hs-comment'>-- Instantiation</span>
<a name="line-32"></a>  <span class='hs-varid'>tcInstTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>newSigTyVar</span><span class='hs-layout'>,</span>
<a name="line-33"></a>  <span class='hs-varid'>tcInstType</span><span class='hs-layout'>,</span>
<a name="line-34"></a>  <span class='hs-varid'>tcInstSkolTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSuperSkolTyVars</span><span class='hs-layout'>,</span><span class='hs-varid'>tcInstSuperSkolTyVarsX</span><span class='hs-layout'>,</span>
<a name="line-35"></a>  <span class='hs-varid'>tcInstSigTyVarsLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSigTyVars</span><span class='hs-layout'>,</span>
<a name="line-36"></a>  <span class='hs-varid'>tcInstSkolTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSkolType</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>tcSkolDFunType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSuperSkolTyVars</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-40"></a>  <span class='hs-comment'>-- Zonking</span>
<a name="line-41"></a>  <span class='hs-varid'>zonkTcPredType</span><span class='hs-layout'>,</span> 
<a name="line-42"></a>  <span class='hs-varid'>skolemiseUnboundMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-43"></a>  <span class='hs-varid'>zonkTcTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTyVarsAndFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTypeAndFV</span><span class='hs-layout'>,</span>
<a name="line-44"></a>  <span class='hs-varid'>zonkQuantifiedTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>quantifyTyVars</span><span class='hs-layout'>,</span>
<a name="line-45"></a>  <span class='hs-varid'>zonkTcTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcThetaType</span><span class='hs-layout'>,</span> 
<a name="line-46"></a>
<a name="line-47"></a>  <span class='hs-varid'>zonkTcKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>defaultKindVarToStar</span><span class='hs-layout'>,</span>
<a name="line-48"></a>  <span class='hs-varid'>zonkEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkFlats</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkId</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkSkolemInfo</span><span class='hs-layout'>,</span>
<a name="line-49"></a>
<a name="line-50"></a>  <span class='hs-varid'>tcGetGlobalTyVars</span><span class='hs-layout'>,</span> 
<a name="line-51"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-comment'>-- friends:</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-comment'>-- others:</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>        <span class='hs-comment'>-- TcType, amongst others</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
	Kind variables
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkKindName"></a><span class='hs-definition'>mkKindName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-definition'>mkKindName</span> <span class='hs-varid'>unique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSystemName</span> <span class='hs-varid'>unique</span> <span class='hs-varid'>kind_var_occ</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="kind_var_occ"></a><span class='hs-definition'>kind_var_occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span>	<span class='hs-comment'>-- Just one for all MetaKindVars</span>
<a name="line-5"></a>			<span class='hs-comment'>-- They may be jiggled by tidying</span>
<a name="line-6"></a><span class='hs-definition'>kind_var_occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tvName</span> <span class='hs-str'>"k"</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="newMetaKindVar"></a><span class='hs-definition'>newMetaKindVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-9"></a><span class='hs-definition'>newMetaKindVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-10"></a>		    <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-11"></a>                    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkKindName</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-varid'>superKind</span> <span class='hs-varid'>details</span>
<a name="line-12"></a>		    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="newMetaKindVars"></a><span class='hs-definition'>newMetaKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcKind</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a><span class='hs-definition'>newMetaKindVars</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>n</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
     Evidence variables; range over constraints we can abstract over
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newEvVars"></a><span class='hs-definition'>newEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>newEvVars</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>theta</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="newWantedEvVar"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span> 
<a name="line-5"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newEvVar</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="newWantedEvVars"></a><span class='hs-definition'>newWantedEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> 
<a name="line-8"></a><span class='hs-definition'>newWantedEvVars</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>theta</span> 
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>--------------</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="newEvVar"></a><span class='hs-definition'>newEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-13"></a><span class='hs-comment'>-- Creates new *rigid* variables for predicates</span>
<a name="line-14"></a><span class='hs-definition'>newEvVar</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysName</span> <span class='hs-layout'>(</span><span class='hs-varid'>predTypeOccName</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-15"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="newEq"></a><span class='hs-definition'>newEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-18"></a><span class='hs-definition'>newEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"cobox"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="newDict"></a><span class='hs-definition'>newDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>DictId</span>
<a name="line-23"></a><span class='hs-definition'>newDict</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> 
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDictOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="predTypeOccName"></a><span class='hs-definition'>predTypeOccName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-28"></a><span class='hs-definition'>predTypeOccName</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-29"></a>    <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkDictOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-30"></a>    <span class='hs-conid'>EqPred</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"cobox"</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-conid'>TuplePred</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"tup"</span><span class='hs-layout'>)</span>
<a name="line-32"></a>    <span class='hs-conid'>IrredPred</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"irred"</span><span class='hs-layout'>)</span>
</pre>\end{code}

*********************************************************************************
*                                                                               * 
*                   Wanted constraints
*                                                                               *
*********************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newFlatWanted"></a><span class='hs-definition'>newFlatWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Ct</span>
<a name="line-2"></a><span class='hs-definition'>newFlatWanted</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>pty</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLoc</span> <span class='hs-varid'>orig</span>
<a name="line-4"></a>       <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-5"></a>       <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varop'>$</span>
<a name="line-6"></a>            <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span>
<a name="line-7"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span>
<a name="line-8"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="newFlatWanteds"></a><span class='hs-definition'>newFlatWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a><span class='hs-definition'>newFlatWanteds</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newFlatWanted</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
	SkolemTvs (immutable)
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcInstType"></a><span class='hs-definition'>tcInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- How to instantiate the type variables</span>
<a name="line-2"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> 					<span class='hs-comment'>-- Type to instantiate</span>
<a name="line-3"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Result</span>
<a name="line-4"></a>		<span class='hs-comment'>-- (type vars (excl coercion vars), preds (incl equalities), rho)</span>
<a name="line-5"></a><span class='hs-definition'>tcInstType</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>	<span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span>	<span class='hs-comment'>-- There may be overloading despite no type variables;</span>
<a name="line-8"></a>				<span class='hs-comment'>-- 	(?x :: Int) =&gt; Int -&gt; Int</span>
<a name="line-9"></a>			   <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPhiTy</span> <span class='hs-varid'>rho</span>
<a name="line-10"></a>			 <span class='hs-keyword'>in</span>
<a name="line-11"></a>			 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvars'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>tyvars</span>
<a name="line-14"></a>			    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPhiTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-15"></a>			    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars'</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="tcSkolDFunType"></a><span class='hs-definition'>tcSkolDFunType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-comment'>-- Instantiate a type signature with skolem constants, but </span>
<a name="line-19"></a><span class='hs-comment'>-- do *not* give them fresh names, because we want the name to</span>
<a name="line-20"></a><span class='hs-comment'>-- be in the type environment: it is lexically scoped.</span>
<a name="line-21"></a><span class='hs-definition'>tcSkolDFunType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstType</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSuperSkolTyVars</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="tcSuperSkolTyVars"></a><span class='hs-definition'>tcSuperSkolTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-comment'>-- Make skolem constants, but do *not* give them new names, as above</span>
<a name="line-25"></a><span class='hs-comment'>-- Moreover, make them "super skolems"; see comments with superSkolemTv</span>
<a name="line-26"></a><span class='hs-comment'>-- see Note [Kind substitution when instantiating]</span>
<a name="line-27"></a><span class='hs-comment'>-- Precondition: tyvars should be ordered (kind vars first)</span>
<a name="line-28"></a><span class='hs-definition'>tcSuperSkolTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tcSuperSkolTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="tcSuperSkolTyVar"></a><span class='hs-definition'>tcSuperSkolTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-definition'>tcSuperSkolTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span>
<a name="line-33"></a>  <span class='hs-keyword'>where</span>
<a name="line-34"></a>    <span class='hs-varid'>kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>superSkolemTv</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="tcInstSkolTyVar"></a><span class='hs-definition'>tcInstSkolTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-38"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-comment'>-- Instantiate the tyvar, using </span>
<a name="line-40"></a><span class='hs-comment'>--      * the occ-name and kind of the supplied tyvar, </span>
<a name="line-41"></a><span class='hs-comment'>--      * the unique from the monad,</span>
<a name="line-42"></a><span class='hs-comment'>--      * the location either from the tyvar (skol_info = SigSkol)</span>
<a name="line-43"></a><span class='hs-comment'>--                     or from the monad (otherwise)</span>
<a name="line-44"></a><span class='hs-definition'>tcInstSkolTyVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>overlappable</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-46"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-47"></a>              <span class='hs-varid'>new_tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>new_name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-varid'>overlappable</span><span class='hs-layout'>)</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>old_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tyvar</span>
<a name="line-51"></a>    <span class='hs-varid'>occ</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>old_name</span>
<a name="line-52"></a>    <span class='hs-varid'>kind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="tcInstSkolTyVars"></a><span class='hs-comment'>-- Wrappers</span>
<a name="line-55"></a><span class='hs-comment'>-- we need to be able to do this from outside the TcM monad:</span>
<a name="line-56"></a><span class='hs-definition'>tcInstSkolTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-definition'>tcInstSkolTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstSkolTyVarsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="tcInstSuperSkolTyVars"></a><span class='hs-definition'>tcInstSuperSkolTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-60"></a><span class='hs-definition'>tcInstSuperSkolTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcInstSkolTyVars'</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="tcInstSkolTyVarsX"></a><span class='hs-definition'>tcInstSkolTyVarsX</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSuperSkolTyVarsX</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-definition'>tcInstSkolTyVarsX</span>      <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstSkolTyVars'</span> <span class='hs-conid'>False</span> <span class='hs-varid'>subst</span>
<a name="line-65"></a><a name="tcInstSuperSkolTyVarsX"></a><span class='hs-definition'>tcInstSuperSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstSkolTyVars'</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>subst</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="tcInstSkolTyVars'"></a><span class='hs-definition'>tcInstSkolTyVars'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-comment'>-- Precondition: tyvars should be ordered (kind vars first)</span>
<a name="line-69"></a><span class='hs-comment'>-- see Note [Kind substitution when instantiating]</span>
<a name="line-70"></a><span class='hs-comment'>-- Get the location from the monad; this is a complete freshening operation</span>
<a name="line-71"></a><span class='hs-definition'>tcInstSkolTyVars'</span> <span class='hs-varid'>isSuperSkol</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-73"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInstSkolTyVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>isSuperSkol</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="tcInstSigTyVarsLoc"></a><span class='hs-definition'>tcInstSigTyVarsLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-comment'>-- We specify the location</span>
<a name="line-77"></a><span class='hs-definition'>tcInstSigTyVarsLoc</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInstSkolTyVar</span> <span class='hs-varid'>loc</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="tcInstSigTyVars"></a><span class='hs-definition'>tcInstSigTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-comment'>-- Get the location from the TyVar itself, not the monad</span>
<a name="line-81"></a><span class='hs-definition'>tcInstSigTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>inst_tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span>
<a name="line-83"></a>    <span class='hs-varid'>inst_tv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstSkolTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="tcInstSkolType"></a><span class='hs-definition'>tcInstSkolType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-comment'>-- Instantiate a type with fresh skolem constants</span>
<a name="line-87"></a><span class='hs-comment'>-- Binding location comes from the monad</span>
<a name="line-88"></a><span class='hs-definition'>tcInstSkolType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstType</span> <span class='hs-varid'>tcInstSkolTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="newSigTyVar"></a><span class='hs-definition'>newSigTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-91"></a><span class='hs-definition'>newSigTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-varid'>name</span> <span class='hs-varid'>uniq</span>
<a name="line-94"></a>                      <span class='hs-comment'>-- Use the same OccName so that the tidy-er</span>
<a name="line-95"></a>                      <span class='hs-comment'>-- doesn't gratuitously rename 'a' to 'a0' etc</span>
<a name="line-96"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>SigTv</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name'</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="newMetaDetails"></a><span class='hs-definition'>newMetaDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVarDetails</span>
<a name="line-100"></a><span class='hs-definition'>newMetaDetails</span> <span class='hs-varid'>info</span> 
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>Flexi</span>
<a name="line-102"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>untch</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUntouchables</span>
<a name="line-103"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span><span class='hs-layout'>,</span> <span class='hs-varid'>mtv_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>untch</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Kind substitution when instantiating]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we instantiate a bunch of kind and type variables, first we
expect them to be sorted (kind variables first, then type variables).
Then we have to instantiate the kind variables, build a substitution
from old variables to the new variables, then instantiate the type
variables substituting the original kind.

Exemple: If we want to instantiate
  [(k1 :: BOX), (k2 :: BOX), (a :: k1 -> k2), (b :: k1)]
we want
  [(?k1 :: BOX), (?k2 :: BOX), (?a :: ?k1 -> ?k2), (?b :: ?k1)]
instead of the buggous
  [(?k1 :: BOX), (?k2 :: BOX), (?a :: k1 -> k2), (?b :: k1)]


%************************************************************************
%*									*
	MetaTvs (meta type variables; mutable)
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newMetaTyVar"></a><span class='hs-definition'>newMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2"></a><span class='hs-comment'>-- Make a new meta tyvar out of thin air</span>
<a name="line-3"></a><span class='hs-definition'>newMetaTyVar</span> <span class='hs-varid'>meta_info</span> <span class='hs-varid'>kind</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-5"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>s</span>
<a name="line-6"></a>              <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>meta_info</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>                        <span class='hs-conid'>PolyTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"s"</span>
<a name="line-8"></a>                        <span class='hs-conid'>TauTv</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"t"</span>
<a name="line-9"></a>                        <span class='hs-conid'>SigTv</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"a"</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-varid'>meta_info</span>
<a name="line-11"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="cloneMetaTyVar"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-14"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-16"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ref</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>Flexi</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span>
<a name="line-19"></a>              <span class='hs-varid'>details'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span> 
<a name="line-20"></a>                           <span class='hs-varid'>details</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>details</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>                           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"cloneMetaTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>details'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="mkTcTyVarName"></a><span class='hs-definition'>mkTcTyVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-25"></a><span class='hs-comment'>-- Make sure that fresh TcTyVar names finish with a digit</span>
<a name="line-26"></a><span class='hs-comment'>-- leaving the un-cluttered names free for user names</span>
<a name="line-27"></a><span class='hs-definition'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysTvName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="readMetaTyVar"></a><span class='hs-comment'>-- Works for both type and kind variables</span>
<a name="line-30"></a><span class='hs-definition'>readMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>MetaDetails</span>
<a name="line-31"></a><span class='hs-definition'>readMetaTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span>
<a name="line-32"></a>		      <span class='hs-varid'>readMutVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>metaTvRef</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="isFilledMetaTyVar"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-35"></a><span class='hs-comment'>-- True of a filled-in (Indirect) meta type variable</span>
<a name="line-36"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-40"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>isIndirect</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="isFlexiMetaTyVar"></a><span class='hs-definition'>isFlexiMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-44"></a><span class='hs-comment'>-- True of a un-filled-in (Flexi) meta type variable</span>
<a name="line-45"></a><span class='hs-definition'>isFlexiMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-49"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFlexi</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="writeMetaTyVar"></a><span class='hs-comment'>--------------------</span>
<a name="line-53"></a><span class='hs-comment'>-- Works with both type and kind variables</span>
<a name="line-54"></a><span class='hs-definition'>writeMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-55"></a><span class='hs-comment'>-- Write into a currently-empty MetaTyVar</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>writeMetaTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>debugIsOn</span> 
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeMetaTyVarRef</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>metaTvRef</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-comment'>-- Everything from here on only happens if DEBUG is on</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Writing to non-tc tyvar"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span>
<a name="line-64"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-65"></a>
<a name="line-66"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tyvar</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeMetaTyVarRef</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>ty</span>
<a name="line-68"></a>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Writing to non-meta tyvar"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span>
<a name="line-71"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="writeMetaTyVarRef"></a><span class='hs-comment'>--------------------</span>
<a name="line-74"></a><span class='hs-definition'>writeMetaTyVarRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>MetaDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-75"></a><span class='hs-comment'>-- Here the tyvar is for error checking only; </span>
<a name="line-76"></a><span class='hs-comment'>-- the ref cell must be for the same tyvar</span>
<a name="line-77"></a><span class='hs-definition'>writeMetaTyVarRef</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>ty</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>debugIsOn</span> 
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"writeMetaTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-80"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-comment'>-- Everything from here on only happens if DEBUG is on</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>meta_details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span><span class='hs-layout'>;</span> 
<a name="line-85"></a>       <span class='hs-comment'>-- Zonk kinds to allow the error check to work</span>
<a name="line-86"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_tv_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>tv_kind</span> 
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_ty_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ty_kind</span>
<a name="line-88"></a>
<a name="line-89"></a>       <span class='hs-comment'>-- Check for double updates</span>
<a name="line-90"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isFlexi</span> <span class='hs-varid'>meta_details</span><span class='hs-layout'>,</span> 
<a name="line-91"></a>                  <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Double update of meta tyvar"</span><span class='hs-layout'>)</span>
<a name="line-92"></a>                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>meta_details</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a>         <span class='hs-varid'>traceTc</span> <span class='hs-str'>"writeMetaTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-95"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-96"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span>   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>tv_kind</span><span class='hs-layout'>)</span> 
<a name="line-97"></a>                    <span class='hs-comment'>-- Don't check kinds for updates to coercion variables</span>
<a name="line-98"></a>               <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonked_ty_kind</span> <span class='hs-varop'>`tcIsSubKind`</span> <span class='hs-varid'>zonked_tv_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-99"></a>       <span class='hs-varop'>$</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Ill-kinded update to meta tyvar"</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                        <span class='hs-num'>2</span> <span class='hs-layout'>(</span>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"::"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_kind</span> 
<a name="line-101"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> 
<a name="line-102"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"::"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-103"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>  <span class='hs-keyword'>where</span>
<a name="line-105"></a>    <span class='hs-varid'>tv_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-106"></a>    <span class='hs-varid'>ty_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span>
</pre>\end{code}


%************************************************************************
%*									*
	MetaTvs: TauTvs
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newFlexiTyVar"></a><span class='hs-definition'>newFlexiTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2"></a><span class='hs-definition'>newFlexiTyVar</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newMetaTyVar</span> <span class='hs-conid'>TauTv</span> <span class='hs-varid'>kind</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="newFlexiTyVarTy"></a><span class='hs-definition'>newFlexiTyVarTy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-5"></a><span class='hs-definition'>newFlexiTyVarTy</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-6"></a>    <span class='hs-varid'>tc_tyvar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVar</span> <span class='hs-varid'>kind</span>
<a name="line-7"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tc_tyvar</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="newFlexiTyVarTys"></a><span class='hs-definition'>newFlexiTyVarTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a><span class='hs-definition'>newFlexiTyVarTys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="newPolyFlexiTyVarTy"></a><span class='hs-definition'>newPolyFlexiTyVarTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-13"></a><span class='hs-definition'>newPolyFlexiTyVarTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVar</span> <span class='hs-conid'>PolyTv</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-14"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="tcInstTyVars"></a><span class='hs-definition'>tcInstTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvSubst</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-comment'>-- Instantiate with META type variables</span>
<a name="line-18"></a><span class='hs-comment'>-- Note that this works for a sequence of kind and type</span>
<a name="line-19"></a><span class='hs-comment'>-- variables.  Eg    [ (k:BOX), (a:k-&gt;k) ]</span>
<a name="line-20"></a><span class='hs-comment'>--             Gives [ (k7:BOX), (a8:k7-&gt;k7) ]</span>
<a name="line-21"></a><span class='hs-definition'>tcInstTyVars</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstTyVarsX</span> <span class='hs-varid'>emptyTvSubst</span> <span class='hs-varid'>tyvars</span>
<a name="line-22"></a>    <span class='hs-comment'>-- emptyTvSubst has an empty in-scope set, but that's fine here</span>
<a name="line-23"></a>    <span class='hs-comment'>-- Since the tyvars are freshly made, they cannot possibly be</span>
<a name="line-24"></a>    <span class='hs-comment'>-- captured by any existing for-alls.</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="tcInstTyVarsX"></a><span class='hs-definition'>tcInstTyVarsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvSubst</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-comment'>-- The "X" part is because of extending the substitution</span>
<a name="line-28"></a><span class='hs-definition'>tcInstTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span>
<a name="line-29"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvars'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>tcInstTyVarX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvars</span>
<a name="line-30"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tyvars'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="tcInstTyVarX"></a><span class='hs-definition'>tcInstTyVarX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TKVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-comment'>-- Make a new unification variable tyvar whose Name and Kind come from</span>
<a name="line-34"></a><span class='hs-comment'>-- an existing TyVar. We substitute kind variables in the kind.</span>
<a name="line-35"></a><span class='hs-definition'>tcInstTyVarX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSystemName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-39"></a>              <span class='hs-varid'>kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-40"></a>              <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span> 
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
             Quantification
%*									*
%************************************************************************

Note [quantifyTyVars]
~~~~~~~~~~~~~~~~~~~~~
quantifyTyVars is give the free vars of a type that we
are about to wrap in a forall.

It takes these free type/kind variables and 
  1. Zonks them and remove globals
  2. Partitions into type and kind variables (kvs1, tvs)
  3. Extends kvs1 with free kind vars in the kinds of tvs (removing globals)
  4. Calls zonkQuantifiedTyVar on each

Step (3) is often unimportant, because the kind variable is often
also free in the type.  Eg
     Typeable k (a::k)
has free vars {k,a}.  But the type (see Trac #7916)
    (f::k->*) (a::k)
has free vars {f,a}, but we must add 'k' as well! Hence step (3).

\begin{code}
<pre><a name="line-1"></a><a name="quantifyTyVars"></a><span class='hs-definition'>quantifyTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [quantifyTyVars]</span>
<a name="line-3"></a><span class='hs-comment'>-- The input is a mixture of type and kind variables; a kind variable k </span>
<a name="line-4"></a><span class='hs-comment'>--   may occur *after* a tyvar mentioning k in its kind</span>
<a name="line-5"></a><span class='hs-comment'>-- Can be given a mixture of TcTyVars and TyVars, in the case of</span>
<a name="line-6"></a><span class='hs-comment'>--   associated type declarations</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>quantifyTyVars</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-varid'>tkvs</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tkvs</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarsAndFV</span> <span class='hs-varid'>tkvs</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarsAndFV</span> <span class='hs-varid'>gbl_tvs</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionVarSet</span> <span class='hs-varid'>isKindVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>closeOverKinds</span> <span class='hs-varid'>tkvs</span> <span class='hs-varop'>`minusVarSet`</span> <span class='hs-varid'>gbl_tvs</span><span class='hs-layout'>)</span>
<a name="line-12"></a>                              <span class='hs-comment'>-- NB kinds of tvs are zonked by zonkTyVarsAndFV</span>
<a name="line-13"></a>             <span class='hs-varid'>kvs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>kvs</span>
<a name="line-14"></a>             <span class='hs-varid'>qtvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>tvs</span>                       
<a name="line-15"></a>
<a name="line-16"></a>             <span class='hs-comment'>-- In the non-PolyKinds case, default the kind variables</span>
<a name="line-17"></a>             <span class='hs-comment'>-- to *, and zonk the tyvars as usual.  Notice that this</span>
<a name="line-18"></a>             <span class='hs-comment'>-- may make quantifyTyVars return a shorter list</span>
<a name="line-19"></a>             <span class='hs-comment'>-- than it was passed, but that's ok</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>poly_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PolyKinds</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>qkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>poly_kinds</span>
<a name="line-22"></a>                 <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kvs2</span>
<a name="line-23"></a>                 <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>meta_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>skolem_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>is_meta</span> <span class='hs-varid'>kvs2</span>
<a name="line-24"></a>                               <span class='hs-varid'>is_meta</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>kv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv</span>
<a name="line-25"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>defaultKindVarToStar</span> <span class='hs-varid'>meta_kvs</span>
<a name="line-26"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>skolem_kvs</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- should be empty</span>
<a name="line-27"></a>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonk_quant</span> <span class='hs-layout'>(</span><span class='hs-varid'>qkvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>qtvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-29"></a>           <span class='hs-comment'>-- Because of the order, any kind variables</span>
<a name="line-30"></a>           <span class='hs-comment'>-- mentioned in the kinds of the type variables refer to</span>
<a name="line-31"></a>           <span class='hs-comment'>-- the now-quantified versions</span>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>zonk_quant</span> <span class='hs-varid'>tkv</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tkv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkQuantifiedTyVar</span> <span class='hs-varid'>tkv</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tkv</span>
<a name="line-36"></a>      <span class='hs-comment'>-- For associated types, we have the class variables </span>
<a name="line-37"></a>      <span class='hs-comment'>-- in scope, and they are TyVars not TcTyVars</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="zonkQuantifiedTyVar"></a><span class='hs-definition'>zonkQuantifiedTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-40"></a><span class='hs-comment'>-- The quantified type variables often include meta type variables</span>
<a name="line-41"></a><span class='hs-comment'>-- we want to freeze them into ordinary type variables, and</span>
<a name="line-42"></a><span class='hs-comment'>-- default their kind (e.g. from OpenTypeKind to TypeKind)</span>
<a name="line-43"></a><span class='hs-comment'>-- 			-- see notes with Kind.defaultKind</span>
<a name="line-44"></a><span class='hs-comment'>-- The meta tyvar is updated to point to the new skolem TyVar.  Now any </span>
<a name="line-45"></a><span class='hs-comment'>-- bound occurrences of the original type variable will get zonked to </span>
<a name="line-46"></a><span class='hs-comment'>-- the immutable version.</span>
<a name="line-47"></a><span class='hs-comment'>--</span>
<a name="line-48"></a><span class='hs-comment'>-- We leave skolem TyVars alone; they are immutable.</span>
<a name="line-49"></a><span class='hs-comment'>--</span>
<a name="line-50"></a><span class='hs-comment'>-- This function is called on both kind and type variables,</span>
<a name="line-51"></a><span class='hs-comment'>-- but kind variables *only* if PolyKinds is on.</span>
<a name="line-52"></a><span class='hs-definition'>zonkQuantifiedTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> 
<a name="line-54"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>      <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-56"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-57"></a>	<span class='hs-comment'>-- It might be a skolem type variable, </span>
<a name="line-58"></a>	<span class='hs-comment'>-- for example from a user type signature</span>
<a name="line-59"></a>
<a name="line-60"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-61"></a>          <span class='hs-keyword'>do</span> <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-62"></a>                 <span class='hs-comment'>-- [Sept 04] Check for non-empty.</span>
<a name="line-63"></a>                 <span class='hs-comment'>-- See note [Silly Type Synonym]</span>
<a name="line-64"></a>                 <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-65"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a>                     <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-67"></a>                     <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span>
<a name="line-68"></a>                                    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-69"></a>             <span class='hs-varid'>skolemiseUnboundMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vanillaSkolemTv</span>
<a name="line-70"></a>      <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zonkQuantifiedTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- FlatSkol, RuntimeUnk</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="defaultKindVarToStar"></a><span class='hs-definition'>defaultKindVarToStar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-73"></a><span class='hs-comment'>-- We have a meta-kind: unify it with '*'</span>
<a name="line-74"></a><span class='hs-definition'>defaultKindVarToStar</span> <span class='hs-varid'>kv</span> 
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>kv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv</span> <span class='hs-layout'>)</span>
<a name="line-76"></a>         <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>kv</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-77"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-layout'>}</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="skolemiseUnboundMetaTyVar"></a><span class='hs-definition'>skolemiseUnboundMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-80"></a><span class='hs-comment'>-- We have a Meta tyvar with a ref-cell inside it</span>
<a name="line-81"></a><span class='hs-comment'>-- Skolemise it, including giving it a new Name, so that</span>
<a name="line-82"></a><span class='hs-comment'>--   we are totally out of Meta-tyvar-land</span>
<a name="line-83"></a><span class='hs-comment'>-- We create a skolem TyVar, not a regular TyVar</span>
<a name="line-84"></a><span class='hs-comment'>--   See Note [Zonking to Skolem]</span>
<a name="line-85"></a><span class='hs-definition'>skolemiseUnboundMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>details</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> 
<a name="line-87"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>    <span class='hs-comment'>-- Get the location from "here"</span>
<a name="line-88"></a>                                 <span class='hs-comment'>-- ie where we are generalising</span>
<a name="line-89"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>      <span class='hs-comment'>-- Remove it from TcMetaTyVar unique land</span>
<a name="line-90"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-91"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultKind</span> <span class='hs-varid'>kind</span>
<a name="line-92"></a>              <span class='hs-varid'>final_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>span</span>
<a name="line-93"></a>              <span class='hs-varid'>final_tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>final_name</span> <span class='hs-varid'>final_kind</span> <span class='hs-varid'>details</span>
<a name="line-94"></a>
<a name="line-95"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>final_tv</span><span class='hs-layout'>)</span>
<a name="line-96"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>final_tv</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Zonking to Skolem]
~~~~~~~~~~~~~~~~~~~~~~~~
We used to zonk quantified type variables to regular TyVars.  However, this
leads to problems.  Consider this program from the regression test suite:

  eval :: Int -> String -> String -> String
  eval 0 root actual = evalRHS 0 root actual

  evalRHS :: Int -> a
  evalRHS 0 root actual = eval 0 root actual

It leads to the deferral of an equality (wrapped in an implication constraint)

  forall a. () => ((String -> String -> String) ~ a)

which is propagated up to the toplevel (see TcSimplify.tcSimplifyInferCheck).
In the meantime `a' is zonked and quantified to form `evalRHS's signature.
This has the *side effect* of also zonking the `a' in the deferred equality
(which at this point is being handed around wrapped in an implication
constraint).

Finally, the equality (with the zonked `a') will be handed back to the
simplifier by TcRnDriver.tcRnSrcDecls calling TcSimplify.tcSimplifyTop.
If we zonk `a' with a regular type variable, we will have this regular type
variable now floating around in the simplifier, which in many places assumes to
only see proper TcTyVars.

We can avoid this problem by zonking with a skolem.  The skolem is rigid
(which we require for a quantified variable), but is still a TcTyVar that the
simplifier knows how to deal with.

Note [Silly Type Synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:
	type C u a = u	-- Note 'a' unused

	foo :: (forall a. C u a -> C u a) -> u
	foo x = ...

	bar :: Num u => u
	bar = foo (\t -> t + t)

* From the (\t -> t+t) we get type  {Num d} =>  d -> d
  where d is fresh.

* Now unify with type of foo's arg, and we get:
	{Num (C d a)} =>  C d a -> C d a
  where a is fresh.

* Now abstract over the 'a', but float out the Num (C d a) constraint
  because it does not 'really' mention a.  (see exactTyVarsOfType)
  The arg to foo becomes
	\/\a -> \t -> t+t

* So we get a dict binding for Num (C d a), which is zonked to give
	a = ()
  [Note Sept 04: now that we are zonking quantified type variables
  on construction, the 'a' will be frozen as a regular tyvar on
  quantification, so the floated dict will still have type (C d a).
  Which renders this whole note moot; happily!]

* Then the \/\a abstraction has a zonked 'a' in it.

All very silly.   I think its harmless to ignore the problem.  We'll end up with
a \/\a in the final result but all the occurrences of a will be zonked to ()

%************************************************************************
%*									*
              Zonking
%*									*
%************************************************************************

@tcGetGlobalTyVars@ returns a fully-zonked set of tyvars free in the environment.
To improve subsequent calls to the same function it writes the zonked set back into
the environment.

\begin{code}
<pre><a name="line-1"></a><a name="tcGetGlobalTyVars"></a><span class='hs-definition'>tcGetGlobalTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-2"></a><span class='hs-definition'>tcGetGlobalTyVars</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLclEnv</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcl_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gtv_var</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>gtv_var</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarsAndFV</span> <span class='hs-varid'>gbl_tvs</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>gtv_var</span> <span class='hs-varid'>gbl_tvs'</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>gbl_tvs'</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
</pre>\end{code}

-----------------  Type variables

\begin{code}
<pre><a name="line-1"></a><a name="zonkTcTypeAndFV"></a><span class='hs-definition'>zonkTcTypeAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-2"></a><span class='hs-comment'>-- Zonk a type and take its free variables</span>
<a name="line-3"></a><span class='hs-comment'>-- With kind polymorphism it can be essential to zonk *first*</span>
<a name="line-4"></a><span class='hs-comment'>-- so that we find the right set of free variables.  Eg</span>
<a name="line-5"></a><span class='hs-comment'>--    forall k1. forall (a:k2). a</span>
<a name="line-6"></a><span class='hs-comment'>-- where k2:=k1 is in the substitution.  We don't want</span>
<a name="line-7"></a><span class='hs-comment'>-- k2 to look free in this type!</span>
<a name="line-8"></a><span class='hs-definition'>zonkTcTypeAndFV</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="zonkTyVar"></a><span class='hs-definition'>zonkTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-11"></a><span class='hs-comment'>-- Works on TyVars and TcTyVars</span>
<a name="line-12"></a><span class='hs-definition'>zonkTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-13"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-14"></a>   <span class='hs-comment'>-- Hackily, when typechecking type and class decls</span>
<a name="line-15"></a>   <span class='hs-comment'>-- we have TyVars in scopeadded (only) in </span>
<a name="line-16"></a>   <span class='hs-comment'>-- TcHsType.tcTyClTyVars, but it seems</span>
<a name="line-17"></a>   <span class='hs-comment'>-- painful to make them into TcTyVars there</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="zonkTyVarsAndFV"></a><span class='hs-definition'>zonkTyVarsAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-20"></a><span class='hs-definition'>zonkTyVarsAndFV</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="zonkTcTyVars"></a><span class='hs-definition'>zonkTcTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a><span class='hs-definition'>zonkTcTyVars</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tyvars</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="zonkTyVarKind"></a><span class='hs-comment'>-----------------  Types</span>
<a name="line-26"></a><span class='hs-definition'>zonkTyVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-27"></a><span class='hs-definition'>zonkTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-28"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="zonkTcTypes"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>tys</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="zonkTcThetaType"></a><span class='hs-definition'>zonkTcThetaType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcThetaType</span>
<a name="line-34"></a><span class='hs-definition'>zonkTcThetaType</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcPredType</span> <span class='hs-varid'>theta</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="zonkTcPredType"></a><span class='hs-definition'>zonkTcPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcPredType</span>
<a name="line-37"></a><span class='hs-definition'>zonkTcPredType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcType</span>
</pre>\end{code}

---------------  Constraints

\begin{code}
<pre><a name="line-1"></a><a name="zonkImplication"></a><span class='hs-definition'>zonkImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>zonkImplication</span> <span class='hs-varid'>implic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_untch</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>untch</span>
<a name="line-3"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds_var</span>
<a name="line-4"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span>
<a name="line-5"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span>
<a name="line-6"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span>
<a name="line-7"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>skols'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarBndr</span> <span class='hs-varid'>skols</span>  <span class='hs-comment'>-- Need to zonk their kinds!</span>
<a name="line-9"></a>                                                <span class='hs-comment'>-- as Trac #7230 showed</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>given'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkEvVar</span> <span class='hs-varid'>given</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>info'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSkolemInfo</span> <span class='hs-varid'>info</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wanted'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkWCRec</span> <span class='hs-varid'>binds_var</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>wanted</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted'</span> 
<a name="line-14"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>emptyBag</span>
<a name="line-15"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span>
<a name="line-16"></a>              <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_fsks</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>  <span class='hs-comment'>-- Zonking removes all FlatSkol tyvars</span>
<a name="line-17"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols'</span>
<a name="line-18"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given'</span>
<a name="line-19"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted'</span>
<a name="line-20"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="zonkEvVar"></a><span class='hs-definition'>zonkEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-23"></a><span class='hs-definition'>zonkEvVar</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>var</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a>
<a name="line-27"></a><a name="zonkWC"></a><span class='hs-definition'>zonkWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-comment'>-- May add new bindings for wanted family equalities in here</span>
<a name="line-28"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-29"></a><span class='hs-definition'>zonkWC</span> <span class='hs-varid'>binds_var</span> <span class='hs-varid'>wc</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>untch</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUntouchables</span>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonkWCRec</span> <span class='hs-varid'>binds_var</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="zonkWCRec"></a><span class='hs-definition'>zonkWCRec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-34"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span>
<a name="line-35"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-36"></a><span class='hs-definition'>zonkWCRec</span> <span class='hs-varid'>binds_var</span> <span class='hs-varid'>untch</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>flat'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkFlats</span> <span class='hs-varid'>binds_var</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>flat</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implic'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatMapBagM</span> <span class='hs-varid'>zonkImplication</span> <span class='hs-varid'>implic</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>insol'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCts</span> <span class='hs-varid'>insol</span> <span class='hs-comment'>-- No need to do the more elaborate zonkFlats thing</span>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic'</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="zonkFlats"></a><span class='hs-definition'>zonkFlats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Cts</span>
<a name="line-43"></a><span class='hs-comment'>-- This zonks and unflattens a bunch of flat constraints</span>
<a name="line-44"></a><span class='hs-comment'>-- See Note [Unflattening while zonking]</span>
<a name="line-45"></a><span class='hs-definition'>zonkFlats</span> <span class='hs-varid'>binds_var</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>cts</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- See Note [How to unflatten]</span>
<a name="line-47"></a>         <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldrBagM</span> <span class='hs-varid'>unflatten_one</span> <span class='hs-varid'>emptyCts</span> <span class='hs-varid'>cts</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonkCts</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>unflatten_one</span> <span class='hs-varid'>orig_ct</span> <span class='hs-varid'>cts</span>
<a name="line-51"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>zct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCt</span> <span class='hs-varid'>orig_ct</span>                <span class='hs-comment'>-- First we need to fully zonk </span>
<a name="line-52"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>try_zonk_fun_eq</span> <span class='hs-varid'>orig_ct</span> <span class='hs-varid'>zct</span>   <span class='hs-comment'>-- Then try to solve if family equation</span>
<a name="line-53"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>maybe</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>(</span><span class='hs-varop'>`consBag`</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-varid'>mct</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-varid'>try_zonk_fun_eq</span> <span class='hs-varid'>orig_ct</span> <span class='hs-varid'>zct</span>   <span class='hs-comment'>-- See Note [How to unflatten]</span>
<a name="line-56"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty_lhs</span> <span class='hs-varid'>ty_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>zct</span><span class='hs-layout'>)</span>
<a name="line-57"></a>          <span class='hs-comment'>-- NB: zonking de-classifies the constraint,</span>
<a name="line-58"></a>          <span class='hs-comment'>--     so we can't look for CFunEqCan</span>
<a name="line-59"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty_rhs</span>
<a name="line-60"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFloatedTouchableMetaTyVar</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-61"></a>        <span class='hs-varid'>isTouchableMetaTyVar</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>tv</span>
<a name="line-62"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>ty_lhs</span>     <span class='hs-comment'>-- Never unify a SigTyVar with a non-tyvar</span>
<a name="line-63"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty_lhs</span> <span class='hs-varop'>`tcIsSubKind`</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>  <span class='hs-comment'>-- c.f. TcInteract.trySpontaneousEqOneWay</span>
<a name="line-64"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty_lhs</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Do not construct an infinite type</span>
<a name="line-65"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty_lhs</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ct</span> <span class='hs-layout'>)</span>
<a name="line-66"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty_lhs</span>
<a name="line-67"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>evterm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty_lhs</span><span class='hs-layout'>)</span>
<a name="line-68"></a>                 <span class='hs-varid'>evvar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>zct</span><span class='hs-layout'>)</span>
<a name="line-69"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>orig_ct</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>         <span class='hs-comment'>-- Can be derived (Trac #8129)</span>
<a name="line-70"></a>             <span class='hs-varid'>addTcEvBind</span> <span class='hs-varid'>binds_var</span> <span class='hs-varid'>evvar</span> <span class='hs-varid'>evterm</span>
<a name="line-71"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"zonkFlats/unflattening"</span> <span class='hs-varop'>$</span>
<a name="line-72"></a>             <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"zct = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>zct</span><span class='hs-layout'>,</span>
<a name="line-73"></a>                    <span class='hs-varid'>text</span> <span class='hs-str'>"binds_var = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds_var</span> <span class='hs-keyglyph'>]</span>
<a name="line-74"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-76"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>zct</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Unflattening while zonking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A bunch of wanted constraints could contain wanted equations of the form
(F taus ~ alpha) where alpha is either an ordinary unification variable, or
a flatten unification variable.

These are ordinary wanted constraints and can/should be solved by
ordinary unification alpha := F taus. However the constraint solving
algorithm does not do that, as their 'inert' form is F taus ~ alpha.

Hence, we need an extra step to 'unflatten' these equations by
performing unification. This unification, if it happens at the end of
constraint solving, cannot produce any more interactions in the
constraint solver so it is safe to do it as the very very last step.

We choose therefore to do it during zonking, in the function
zonkFlats. This is in analogy to the zonking of given "flatten skolems"
which are eliminated in favor of the underlying type that they are
equal to.

Note that, because we now have to affect *evidence* while zonking
(setting some evidence binds to identities), we have to pass to the
zonkWC function an evidence variable to collect all the extra
variables.

Note [How to unflatten]
~~~~~~~~~~~~~~~~~~~~~~~
How do we unflatten during zonking.  Consider a bunch of flat constraints.
Consider them one by one.  For each such constraint C
  * Zonk C (to apply current substitution)
  * If C is of form F tys ~ alpha, 
       where alpha is touchable
       and   alpha is not mentioned in tys
    then unify alpha := F tys
         and discard C

After processing all the flat constraints, zonk them again to propagate
the inforamtion from later ones to earlier ones.  Eg
  Start:  (F alpha ~ beta, G Int ~ alpha)
  Then we get beta := F alpha
              alpha := G Int
  but we must apply the second unification to the first constraint.


\begin{code}
<pre><a name="line-1"></a><a name="zonkCts"></a><span class='hs-definition'>zonkCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Cts</span>
<a name="line-2"></a><span class='hs-definition'>zonkCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>zonkCt</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="zonkCt"></a><span class='hs-definition'>zonkCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Ct</span>
<a name="line-5"></a><span class='hs-definition'>zonkCt</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCtEvidence</span> <span class='hs-varid'>ev</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-8"></a><span class='hs-definition'>zonkCt</span> <span class='hs-varid'>ct</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCtEvidence</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>fl'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="zonkCtEvidence"></a><span class='hs-definition'>zonkCtEvidence</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-13"></a><span class='hs-definition'>zonkCtEvidence</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pred'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>pred</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred'</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a><span class='hs-definition'>zonkCtEvidence</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pred'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>pred</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a><span class='hs-definition'>zonkCtEvidence</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pred'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>pred</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="zonkSkolemInfo"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-24"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ntys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>ntys</span>
<a name="line-27"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ntys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>skol_info</span>
</pre>\end{code}



%************************************************************************
%*									*
\subsection{Zonking -- the main work-horses: zonkTcType, zonkTcTyVar}
%*									*
%*		For internal use only!					*
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkId"></a><span class='hs-comment'>-- zonkId is used *during* typechecking just to zonk the Id's type</span>
<a name="line-2"></a><span class='hs-definition'>zonkId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcId</span>
<a name="line-3"></a><span class='hs-definition'>zonkId</span> <span class='hs-varid'>id</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>setIdType</span> <span class='hs-varid'>id</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>-- For unbound, mutable tyvars, zonkType uses the function given to it</span>
<a name="line-8"></a><span class='hs-comment'>-- For tyvars bound at a for-all, zonkType zonks them to an immutable</span>
<a name="line-9"></a><span class='hs-comment'>--	type variable and zonks the kind too</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="zonkTcType"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-12"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-16"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                <span class='hs-comment'>-- Do NOT establish Type invariants, because</span>
<a name="line-18"></a>                <span class='hs-comment'>-- doing so is strict in the TyCOn.</span>
<a name="line-19"></a>                <span class='hs-comment'>-- See Note [Zonking inside the knot] in TcHsType</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-24"></a>                              <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-25"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>
<a name="line-28"></a>                              <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-29"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-30"></a>		<span class='hs-comment'>-- NB the mkAppTy; we might have instantiated a</span>
<a name="line-31"></a>		<span class='hs-comment'>-- type variable to a type constructor, so we need</span>
<a name="line-32"></a>		<span class='hs-comment'>-- to pull the TyConApp to the top.</span>
<a name="line-33"></a>                <span class='hs-comment'>-- OK to do this because only strict in the structure</span>
<a name="line-34"></a>                <span class='hs-comment'>-- not in the TyCon.</span>
<a name="line-35"></a>                <span class='hs-comment'>-- See Note [Zonking inside the knot] in TcHsType</span>
<a name="line-36"></a>
<a name="line-37"></a>	<span class='hs-comment'>-- The two interesting cases!</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tyvar</span>
<a name="line-39"></a>		       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tyvar</span>
<a name="line-40"></a>		<span class='hs-comment'>-- Ordinary (non Tc) tyvars occur inside quantified types</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVarBndr</span> <span class='hs-varid'>tv</span>
<a name="line-43"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-44"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="zonkTcTyVarBndr"></a><span class='hs-definition'>zonkTcTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-47"></a><span class='hs-comment'>-- A tyvar binder is never a unification variable (MetaTv),</span>
<a name="line-48"></a><span class='hs-comment'>-- rather it is always a skolems.  BUT it may have a kind </span>
<a name="line-49"></a><span class='hs-comment'>-- that has not yet been zonked, and may include kind</span>
<a name="line-50"></a><span class='hs-comment'>-- unification variables.</span>
<a name="line-51"></a><span class='hs-definition'>zonkTcTyVarBndr</span> <span class='hs-varid'>tyvar</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-53"></a>    <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>tyvar</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="zonkTcTyVar"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-56"></a><span class='hs-comment'>-- Simply look through all Flexis</span>
<a name="line-57"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-59"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-60"></a>      <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonk_kind_and_return</span>
<a name="line-61"></a>      <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonk_kind_and_return</span>
<a name="line-62"></a>      <span class='hs-conid'>FlatSkol</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-63"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span>
<a name="line-64"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-65"></a>               <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a>	            <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonk_kind_and_return</span>
<a name="line-67"></a>	            <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-varid'>zonk_kind_and_return</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>z_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-70"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>z_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}



%************************************************************************
%*									*
			Zonking kinds
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkTcKind"></a><span class='hs-definition'>zonkTcKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-2"></a><span class='hs-definition'>zonkTcKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>k</span>
</pre>\end{code}
    


</body>
</html>
