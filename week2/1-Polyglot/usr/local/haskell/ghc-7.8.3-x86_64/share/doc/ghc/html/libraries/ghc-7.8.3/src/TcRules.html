<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcRules.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The AQUA Project, Glasgow University, 1993-1998
%

TcRules: Typechecking transformation rules

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcRules</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcRules</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcExpr</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-layout'>(</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>)</span>
</pre>\end{code}

Note [Typechecking rules]
~~~~~~~~~~~~~~~~~~~~~~~~~
We *infer* the typ of the LHS, and use that type to *check* the type of 
the RHS.  That means that higher-rank rules work reasonably well. Here's
an example (test simplCore/should_compile/rule2.hs) produced by Roman:

   foo :: (forall m. m a -> m b) -> m a -> m b
   foo f = ...

   bar :: (forall m. m a -> m a) -> m a -> m a
   bar f = ...

   {-# RULES "foo/bar" foo = bar #-}

He wanted the rule to typecheck.

Note [Simplifying RULE constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
On the LHS of transformation rules we only simplify only equalities,
but not dictionaries.  We want to keep dictionaries unsimplified, to
serve as the available stuff for the RHS of the rule.  We *do* want to
simplify equalities, however, to detect ill-typed rules that cannot be
applied.

Implementation: the TcSFlags carried by the TcSMonad controls the
amount of simplification, so simplifyRuleLhs just sets the flag
appropriately.

Example.  Consider the following left-hand side of a rule
	f (x == y) (y > z) = ...
If we typecheck this expression we get constraints
	d1 :: Ord a, d2 :: Eq a
We do NOT want to "simplify" to the LHS
	forall x::a, y::a, z::a, d1::Ord a.
	  f ((==) (eqFromOrd d1) x y) ((>) d1 y z) = ...
Instead we want	
	forall x::a, y::a, z::a, d1::Ord a, d2::Eq a.
	  f ((==) d2 x y) ((>) d1 y z) = ...

Here is another example:
	fromIntegral :: (Integral a, Num b) => a -> b
	{-# RULES "foo"  fromIntegral = id :: Int -> Int #-}
In the rule, a=b=Int, and Num Int is a superclass of Integral Int. But
we *dont* want to get
	forall dIntegralInt.
	   fromIntegral Int Int dIntegralInt (scsel dIntegralInt) = id Int
because the scsel will mess up RULE matching.  Instead we want
	forall dIntegralInt, dNumInt.
	  fromIntegral Int Int dIntegralInt dNumInt = id Int

Even if we have 
	g (x == y) (y == z) = ..
where the two dictionaries are *identical*, we do NOT WANT
	forall x::a, y::a, z::a, d1::Eq a
	  f ((==) d1 x y) ((>) d1 y z) = ...
because that will only match if the dict args are (visibly) equal.
Instead we want to quantify over the dictionaries separately.

In short, simplifyRuleLhs must *only* squash equalities, leaving
all dicts unchanged, with absolutely no sharing.  

Also note that we can't solve the LHS constraints in isolation:
Example   foo :: Ord a => a -> a
	  foo_spec :: Int -> Int
          {-# RULE "foo"  foo = foo_spec #-}
Here, it's the RHS that fixes the type variable

HOWEVER, under a nested implication things are different
Consider
  f :: (forall a. Eq a => a->a) -> Bool -> ...
  {-# RULES "foo" forall (v::forall b. Eq b => b->b).
       f b True = ...
    #-}
Here we *must* solve the wanted (Eq a) from the given (Eq a)
resulting from skolemising the agument type of g.  So we 
revert to SimplCheck when going under an implication.  


------------------------ So the plan is this -----------------------

* Step 1: Simplify the LHS and RHS constraints all together in one bag
          We do this to discover all unification equalities

* Step 2: Zonk the ORIGINAL lhs constraints, and partition them into
          the ones we will quantify over, and the others

* Step 3: Decide on the type variables to quantify over

* Step 4: Simplify the LHS and RHS constraints separately, using the
          quantified constraints as givens


\begin{code}
<pre><a name="line-1"></a><a name="tcRules"></a><span class='hs-definition'>tcRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>tcRules</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcRule</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="tcRule"></a><span class='hs-definition'>tcRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RuleDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleDecl</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>tcRule</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>act</span> <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>fv_lhs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>fv_rhs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ruleCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>	<span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"---- Rule ------"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>    	<span class='hs-comment'>-- Note [Typechecking rules]</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRuleBndrs</span> <span class='hs-varid'>hs_bndrs</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>id_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>vars</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs_wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>rule_ty</span><span class='hs-layout'>)</span>
<a name="line-13"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tv_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-14"></a>               <span class='hs-varid'>tcExtendIdEnv</span>    <span class='hs-varid'>id_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-15"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>lhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rule_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs_wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInferRho</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                  <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rule_ty</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs_wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>rule_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs_evs</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_lhs_wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>lhs_wanted</span> <span class='hs-varid'>rhs_wanted</span>
<a name="line-20"></a>
<a name="line-21"></a>	<span class='hs-comment'>-- Now figure out what to quantify over</span>
<a name="line-22"></a>	<span class='hs-comment'>-- c.f. TcSimplify.simplifyInfer</span>
<a name="line-23"></a>	<span class='hs-comment'>-- We quantify over any tyvars free in *either* the rule</span>
<a name="line-24"></a>	<span class='hs-comment'>--  *or* the bound variables.  The latter is important.  Consider</span>
<a name="line-25"></a>	<span class='hs-comment'>--	ss (x,(y,z)) = (x,z)</span>
<a name="line-26"></a>	<span class='hs-comment'>--	RULE:  forall v. fst (ss v) = fst v</span>
<a name="line-27"></a>	<span class='hs-comment'>-- The type of the rhs of the rule is just a, but v::(a,(b,c))</span>
<a name="line-28"></a>	<span class='hs-comment'>--</span>
<a name="line-29"></a>	<span class='hs-comment'>-- We also need to get the completely-uconstrained tyvars of</span>
<a name="line-30"></a>	<span class='hs-comment'>-- the LHS, lest they otherwise get defaulted to Any; but we do that</span>
<a name="line-31"></a>	<span class='hs-comment'>-- during zonking (see TcHsSyn.zonkRule)</span>
<a name="line-32"></a>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tpl_ids</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs_evs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>id_bndrs</span>
<a name="line-34"></a>             <span class='hs-varid'>forall_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>rule_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>tpl_ids</span><span class='hs-layout'>)</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbls</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyVars</span>   <span class='hs-comment'>-- Even though top level, there might be top-level</span>
<a name="line-36"></a>                                      <span class='hs-comment'>-- monomorphic bindings from the MR; test tc111</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>qtkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>gbls</span> <span class='hs-varid'>forall_tvs</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcRule"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ftext</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>forall_tvs</span>
<a name="line-40"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>qtkvs</span>
<a name="line-41"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rule_ty</span>
<a name="line-42"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tpl_ids</span> <span class='hs-keyglyph'>]</span> 
<a name="line-43"></a>                  <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-44"></a>
<a name="line-45"></a>           <span class='hs-comment'>-- Simplify the RHS constraints</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rhs_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_untch</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUntouchables</span>
<a name="line-49"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qtkvs</span>
<a name="line-50"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_fsks</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-51"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-52"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs_evs</span>
<a name="line-53"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_wanted</span>
<a name="line-54"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>rhs_wanted</span>
<a name="line-55"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_binds_var</span>
<a name="line-56"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RuleSkol</span> <span class='hs-varid'>name</span>
<a name="line-57"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env</span> <span class='hs-layout'>}</span> 
<a name="line-58"></a>
<a name="line-59"></a>           <span class='hs-comment'>-- For the LHS constraints we must solve the remaining constraints</span>
<a name="line-60"></a>           <span class='hs-comment'>-- (a) so that we report insoluble ones</span>
<a name="line-61"></a>           <span class='hs-comment'>-- (b) so that we bind any soluble ones</span>
<a name="line-62"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lhs_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_untch</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUntouchables</span>
<a name="line-64"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qtkvs</span>
<a name="line-65"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_fsks</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-66"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-67"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs_evs</span>
<a name="line-68"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_lhs_wanted</span>
<a name="line-69"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>other_lhs_wanted</span>
<a name="line-70"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs_binds_var</span>
<a name="line-71"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RuleSkol</span> <span class='hs-varid'>name</span>
<a name="line-72"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env</span> <span class='hs-layout'>}</span> 
<a name="line-73"></a>
<a name="line-74"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>act</span>
<a name="line-75"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>noLoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>qtkvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tpl_ids</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>mkHsDictLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>lhs_binds_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_lhs</span>
<a name="line-77"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>mkHsDictLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>rhs_binds_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_rhs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="tcRuleBndrs"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RuleBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>
<a name="line-80"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-conid'>[]</span> 
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-82"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rule_bndrs</span><span class='hs-layout'>)</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-84"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRuleBndrs</span> <span class='hs-varid'>rule_bndrs</span>
<a name="line-85"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-86"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndrSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>rn_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rule_bndrs</span><span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-comment'>--  e.g 	x :: a-&gt;a</span>
<a name="line-88"></a><span class='hs-comment'>--  The tyvar 'a' is brought into scope first, just as if you'd written</span>
<a name="line-89"></a><span class='hs-comment'>--		a::*, x :: a-&gt;a</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RuleSigCtxt</span> <span class='hs-varid'>name</span>
<a name="line-91"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>id_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rn_ty</span>
<a name="line-92"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>id</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>id_ty</span>
<a name="line-93"></a>              <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>tv_prs</span>   
<a name="line-94"></a>                    <span class='hs-comment'>-- tcHsPatSigType returns (Name,TyVar) pairs</span>
<a name="line-95"></a>                    <span class='hs-comment'>-- for for RuleSigCtxt their Names are not</span>
<a name="line-96"></a>                    <span class='hs-comment'>-- cloned, so we get (n, tv-with-name-n) pairs</span>
<a name="line-97"></a>                    <span class='hs-comment'>-- See Note [Pattern signature binders] in TcHsType</span>
<a name="line-98"></a>
<a name="line-99"></a>	      <span class='hs-comment'>-- The type variables scope over subsequent bindings; yuk</span>
<a name="line-100"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> 
<a name="line-101"></a>                  <span class='hs-varid'>tcRuleBndrs</span> <span class='hs-varid'>rule_bndrs</span> 
<a name="line-102"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>id</span> <span class='hs-conop'>:</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="ruleCtxt"></a><span class='hs-definition'>ruleCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-105"></a><span class='hs-definition'>ruleCtxt</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking the transformation rule"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-106"></a>		<span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ftext</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
