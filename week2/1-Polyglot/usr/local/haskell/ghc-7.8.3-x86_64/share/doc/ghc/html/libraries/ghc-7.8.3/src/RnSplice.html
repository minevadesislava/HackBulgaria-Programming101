<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>rename/RnSplice.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RnSplice</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-varid'>rnTopSpliceDecls</span><span class='hs-layout'>,</span>
<a name="line-3"></a>        <span class='hs-varid'>rnSpliceType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnSplicePat</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnSpliceDecl</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>rnBracket</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>checkThLocalName</span>
<a name="line-6"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>when</span> <span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMeta</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>decsQTyConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>expQTyConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>patQTyConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeQTyConName</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>loadInterfaceForName</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnPat</span>            <span class='hs-layout'>(</span> <span class='hs-varid'>rnPat</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnSource</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>rnSrcDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>findSplice</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnTypes</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>            <span class='hs-layout'>(</span> <span class='hs-varid'>checkWellStaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hooks</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>RnExpr</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcExpr</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcSplice</span> <span class='hs-layout'>(</span> <span class='hs-varid'>runMetaD</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaE</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaP</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaT</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-cpp'>#</span><span class='hs-varid'>ifndef</span> <span class='hs-conid'>GHCI</span>
<a name="line-2"></a><a name="rnBracket"></a><span class='hs-definition'>rnBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>rnBracket</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell bracket"</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="rnTopSpliceDecls"></a><span class='hs-definition'>rnTopSpliceDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>rnTopSpliceDecls</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell top splice"</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="rnSpliceType"></a><span class='hs-definition'>rnSpliceType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PostTcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>rnSpliceType</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell type splice"</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="rnSpliceExpr"></a><span class='hs-definition'>rnSpliceExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>rnSpliceExpr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell splice"</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="rnSplicePat"></a><span class='hs-definition'>rnSplicePat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>rnSplicePat</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell pattern splice"</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="rnSpliceDecl"></a><span class='hs-definition'>rnSpliceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SpliceDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>rnSpliceDecl</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell declaration splice"</span>
<a name="line-19"></a><span class='hs-cpp'>#else</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
                Splices
%*                                                      *
%*********************************************************

Note [Splices]
~~~~~~~~~~~~~~
Consider
        f = ...
        h = ...$(thing "f")...

The splice can expand into literally anything, so when we do dependency
analysis we must assume that it might mention 'f'.  So we simply treat
all locally-defined names as mentioned by any splice.  This is terribly
brutal, but I don't see what else to do.  For example, it'll mean
that every locally-defined thing will appear to be used, so no unused-binding
warnings.  But if we miss the dependency, then we might typecheck 'h' before 'f',
and that will crash the type checker because 'f' isn't in scope.

Currently, I'm not treating a splice as also mentioning every import,
which is a bit inconsistent -- but there are a lot of them.  We might
thereby get some bogus unused-import warnings, but we won't crash the
type checker.  Not very satisfactory really.

\begin{code}
<pre><a name="line-1"></a><a name="rnSpliceGen"></a><span class='hs-definition'>rnSpliceGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                                     <span class='hs-comment'>-- Typed splice?</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Outside brackets, run splice</span>
<a name="line-3"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Inside brackets, make it pending</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span>
<a name="line-5"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>rnSpliceGen</span> <span class='hs-varid'>is_typed_splice</span> <span class='hs-varid'>run_splice</span> <span class='hs-varid'>pend_splice</span> <span class='hs-varid'>splice</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliceCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>is_typed_splice</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-9"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-10"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stage</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>        <span class='hs-conid'>Brack</span> <span class='hs-varid'>pop_stage</span> <span class='hs-conid'>RnPendingTyped</span>
<a name="line-12"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-varid'>is_typed_splice</span> <span class='hs-varid'>illegalUntypedSplice</span>
<a name="line-13"></a>                <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>splice'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varop'>$</span>
<a name="line-14"></a>                                    <span class='hs-varid'>rnSplice</span> <span class='hs-varid'>splice</span>
<a name="line-15"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-sel'>_pending_splice</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pend_splice</span> <span class='hs-varid'>splice'</span>
<a name="line-16"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-conid'>Brack</span> <span class='hs-varid'>pop_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RnPendingUntyped</span> <span class='hs-varid'>ps_var</span><span class='hs-layout'>)</span>
<a name="line-19"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>is_typed_splice</span><span class='hs-layout'>)</span> <span class='hs-varid'>illegalTypedSplice</span>
<a name="line-20"></a>                <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>splice'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varop'>$</span>
<a name="line-21"></a>                                    <span class='hs-varid'>rnSplice</span> <span class='hs-varid'>splice</span>
<a name="line-22"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pending_splice</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pend_splice</span> <span class='hs-varid'>splice'</span>
<a name="line-23"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_var</span>
<a name="line-24"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ps_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>pending_splice</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>splice'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-varid'>is_typed_splice</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-28"></a>                                      <span class='hs-varid'>rnSplice</span> <span class='hs-varid'>splice</span>
<a name="line-29"></a>
<a name="line-30"></a>                 <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run_splice</span> <span class='hs-varid'>splice'</span>
<a name="line-31"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="rnSplice"></a><span class='hs-comment'>---------------------</span>
<a name="line-34"></a><span class='hs-definition'>rnSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-comment'>-- Not exported...used for all</span>
<a name="line-36"></a><span class='hs-definition'>rnSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTH</span> <span class='hs-varid'>expr</span> <span class='hs-str'>"Template Haskell splice"</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-39"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalBndrRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a>
<a name="line-44"></a><a name="rnSpliceExpr"></a><span class='hs-comment'>---------------------</span>
<a name="line-45"></a><span class='hs-definition'>rnSpliceExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-definition'>rnSpliceExpr</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>splice</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnSpliceGen</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>run_expr_splice</span> <span class='hs-varid'>pend_expr_splice</span> <span class='hs-varid'>splice</span>
<a name="line-48"></a>  <span class='hs-keyword'>where</span>
<a name="line-49"></a>    <span class='hs-varid'>pend_expr_splice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-50"></a>    <span class='hs-varid'>pend_expr_splice</span> <span class='hs-varid'>rn_splice</span>
<a name="line-51"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnExpSplice</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>run_expr_splice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-varid'>run_expr_splice</span> <span class='hs-varid'>rn_splice</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-55"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_typed</span>   <span class='hs-comment'>-- Run it later, in the type checker</span>
<a name="line-56"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Ugh!  See Note [Splices] above</span>
<a name="line-57"></a>              <span class='hs-varid'>lcl_rdr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-58"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_rdr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGlobalRdrEnv</span>
<a name="line-59"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>gbl_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-varid'>gbl_rdr</span>
<a name="line-60"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>isLocalGRE</span> <span class='hs-varid'>gre</span><span class='hs-keyglyph'>]</span>
<a name="line-61"></a>                 <span class='hs-varid'>lcl_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRdrEnvElts</span> <span class='hs-varid'>lcl_rdr</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_names</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>gbl_names</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-64"></a>
<a name="line-65"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Run it here</span>
<a name="line-66"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooked</span> <span class='hs-varid'>runRnSpliceHook</span> <span class='hs-varid'>return</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-67"></a>      
<a name="line-68"></a>             <span class='hs-comment'>-- The splice must have type ExpQ</span>
<a name="line-69"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>expQTyConName</span>
<a name="line-70"></a>
<a name="line-71"></a>             <span class='hs-comment'>-- Typecheck the expression</span>
<a name="line-72"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>False</span> <span class='hs-varop'>$</span>
<a name="line-73"></a>                              <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span>
<a name="line-74"></a>
<a name="line-75"></a>             <span class='hs-comment'>-- Run the expression</span>
<a name="line-76"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>expr2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaE</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-77"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>showSplice</span> <span class='hs-str'>"expression"</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lexpr3</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-80"></a>                              <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>
<a name="line-81"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>lexpr3</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>  <span class='hs-layout'>}</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="rnSpliceType"></a><span class='hs-comment'>----------------------</span>
<a name="line-84"></a><span class='hs-definition'>rnSpliceType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PostTcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-definition'>rnSpliceType</span> <span class='hs-varid'>splice</span> <span class='hs-varid'>k</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnSpliceGen</span> <span class='hs-conid'>False</span> <span class='hs-varid'>run_type_splice</span> <span class='hs-varid'>pend_type_splice</span> <span class='hs-varid'>splice</span>
<a name="line-87"></a>  <span class='hs-keyword'>where</span>
<a name="line-88"></a>    <span class='hs-varid'>pend_type_splice</span> <span class='hs-varid'>rn_splice</span>
<a name="line-89"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnTypeSplice</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsSpliceTy</span> <span class='hs-varid'>rn_splice</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-varid'>run_type_splice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> 
<a name="line-92"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooked</span> <span class='hs-varid'>runRnSpliceHook</span> <span class='hs-varid'>return</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-93"></a>              
<a name="line-94"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>typeQTyConName</span>
<a name="line-95"></a>
<a name="line-96"></a>              <span class='hs-comment'>-- Typecheck the expression</span>
<a name="line-97"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>False</span> <span class='hs-varop'>$</span>
<a name="line-98"></a>                               <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span>
<a name="line-99"></a>
<a name="line-100"></a>              <span class='hs-comment'>-- Run the expression</span>
<a name="line-101"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>hs_ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaT</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-102"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>showSplice</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty2</span><span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_ty3</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpliceTypeCtx</span> <span class='hs-varid'>hs_ty2</span>
<a name="line-105"></a>                                  <span class='hs-layout'>;</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>hs_ty2</span>
<a name="line-106"></a>                                    <span class='hs-comment'>-- checkNoErrs: see Note [Renamer errors]</span>
<a name="line-107"></a>                                  <span class='hs-layout'>}</span>
<a name="line-108"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>hs_ty3</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="rnSplicePat"></a><span class='hs-comment'>----------------------</span>
<a name="line-111"></a><span class='hs-definition'>rnSplicePat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-112"></a><span class='hs-definition'>rnSplicePat</span> <span class='hs-varid'>splice</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnSpliceGen</span> <span class='hs-conid'>False</span> <span class='hs-varid'>run_pat_splice</span> <span class='hs-varid'>pend_pat_splice</span> <span class='hs-varid'>splice</span>
<a name="line-114"></a>  <span class='hs-keyword'>where</span>
<a name="line-115"></a>    <span class='hs-varid'>pend_pat_splice</span> <span class='hs-varid'>rn_splice</span>
<a name="line-116"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnPatSplice</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>,</span> <span class='hs-conid'>SplicePat</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class='hs-varid'>run_pat_splice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-119"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooked</span> <span class='hs-varid'>runRnSpliceHook</span> <span class='hs-varid'>return</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-120"></a>      
<a name="line-121"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>patQTyConName</span>
<a name="line-122"></a>
<a name="line-123"></a>             <span class='hs-comment'>-- Typecheck the expression</span>
<a name="line-124"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>False</span> <span class='hs-varop'>$</span>
<a name="line-125"></a>                              <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span>
<a name="line-126"></a>
<a name="line-127"></a>             <span class='hs-comment'>-- Run the expression</span>
<a name="line-128"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaP</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-129"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>showSplice</span> <span class='hs-str'>"pattern"</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-130"></a>
<a name="line-131"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-132"></a>                            <span class='hs-varid'>rnPat</span> <span class='hs-conid'>ThPatSplice</span> <span class='hs-varid'>pat</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-133"></a>
<a name="line-134"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="rnSpliceDecl"></a><span class='hs-comment'>----------------------</span>
<a name="line-137"></a><span class='hs-definition'>rnSpliceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SpliceDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-definition'>rnSpliceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-varid'>flg</span><span class='hs-layout'>)</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnSpliceGen</span> <span class='hs-conid'>False</span> <span class='hs-varid'>run_decl_splice</span> <span class='hs-varid'>pend_decl_splice</span> <span class='hs-varid'>splice</span>
<a name="line-140"></a>  <span class='hs-keyword'>where</span>
<a name="line-141"></a>    <span class='hs-varid'>pend_decl_splice</span> <span class='hs-varid'>rn_splice</span>
<a name="line-142"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnDeclSplice</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>,</span> <span class='hs-conid'>SpliceDecl</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>)</span> <span class='hs-varid'>flg</span><span class='hs-layout'>)</span>
<a name="line-143"></a>
<a name="line-144"></a>    <span class='hs-varid'>run_decl_splice</span> <span class='hs-varid'>rn_splice</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnSpliceDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_splice</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="rnTopSpliceDecls"></a><span class='hs-definition'>rnTopSpliceDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Declaration splice at the very top level of the module</span>
<a name="line-3"></a><span class='hs-definition'>rnTopSpliceDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr''</span><span class='hs-layout'>)</span>
<a name="line-4"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-5"></a>                           <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr''</span>
<a name="line-6"></a>
<a name="line-7"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooked</span> <span class='hs-varid'>runRnSpliceHook</span> <span class='hs-varid'>return</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>list_q</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>decsQTyConName</span>     <span class='hs-comment'>-- Q [Dec]</span>
<a name="line-10"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>list_q</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a>                <span class='hs-comment'>-- Run the expression</span>
<a name="line-13"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaD</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-14"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>showSplice</span> <span class='hs-str'>"declarations"</span> <span class='hs-varid'>expr'</span>
<a name="line-15"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>decls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>decls</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Template Haskell brackets
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnBracket"></a><span class='hs-definition'>rnBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>rnBracket</span> <span class='hs-varid'>e</span> <span class='hs-varid'>br_body</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotationCtxtDoc</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Check that Template Haskell is enabled and available</span>
<a name="line-5"></a>         <span class='hs-varid'>thEnabled</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_TemplateHaskell</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>thEnabled</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>           <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Syntax error on"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span>
<a name="line-8"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use TemplateHaskell"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell bracket"</span>
<a name="line-10"></a>
<a name="line-11"></a>         <span class='hs-comment'>-- Check for nested brackets</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cur_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cur_stage</span> <span class='hs-keyword'>of</span>
<a name="line-14"></a>           <span class='hs-layout'>{</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypedBracket</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span> <span class='hs-varid'>illegalUntypedBracket</span>
<a name="line-15"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypedBracket</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>illegalTypedBracket</span>
<a name="line-16"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>Comp</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-17"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>Brack</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>illegalBracket</span>
<a name="line-18"></a>           <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a>         <span class='hs-comment'>-- Brackets are desugared to code that mentions the TH package</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>recordThUse</span>
<a name="line-22"></a>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isTypedBracket</span> <span class='hs-varid'>br_body</span> <span class='hs-keyword'>of</span>
<a name="line-24"></a>            <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>cur_stage</span> <span class='hs-conid'>RnPendingTyped</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-25"></a>                                            <span class='hs-varid'>rn_bracket</span> <span class='hs-varid'>cur_stage</span> <span class='hs-varid'>br_body</span>
<a name="line-26"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBracket</span> <span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a>            <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ps_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>[]</span>
<a name="line-29"></a>                        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>cur_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>RnPendingUntyped</span> <span class='hs-varid'>ps_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-30"></a>                                            <span class='hs-varid'>rn_bracket</span> <span class='hs-varid'>cur_stage</span> <span class='hs-varid'>br_body</span>
<a name="line-31"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>pendings</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_var</span>
<a name="line-32"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRnBracketOut</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>pendings</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>       <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="rn_bracket"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-varid'>outer_stage</span> <span class='hs-varid'>br</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>VarBr</span> <span class='hs-varid'>flg</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccRn</span> <span class='hs-varid'>rdr_name</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-39"></a>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flg</span> <span class='hs-keyword'>of</span>
<a name="line-41"></a>           <span class='hs-layout'>{</span> <span class='hs-comment'>-- Type variables can be quoted in TH. See #5721.</span>
<a name="line-42"></a>             <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-43"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-44"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_bind_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocalOccThLvl_maybe</span> <span class='hs-varid'>name</span>
<a name="line-45"></a>                    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_bind_lvl</span> <span class='hs-keyword'>of</span>
<a name="line-46"></a>                        <span class='hs-layout'>{</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>      <span class='hs-comment'>-- Can happen for data constructors,</span>
<a name="line-47"></a>                                                    <span class='hs-comment'>-- but nothing needs to be done for them</span>
<a name="line-48"></a>
<a name="line-49"></a>                        <span class='hs-layout'>;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>top_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lvl</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Quoting names]</span>
<a name="line-50"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span>
<a name="line-51"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>keepAlive</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-52"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-53"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rn_bracket VarBr"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>outer_stage</span><span class='hs-layout'>)</span>
<a name="line-54"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>thLevel</span> <span class='hs-varid'>outer_stage</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bind_lvl</span><span class='hs-layout'>)</span>
<a name="line-55"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>quotedNameStageErr</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-56"></a>                        <span class='hs-layout'>}</span>
<a name="line-57"></a>                    <span class='hs-layout'>}</span>
<a name="line-58"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-comment'>-- Imported thing</span>
<a name="line-59"></a>                 <span class='hs-varid'>discardResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadInterfaceForName</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-60"></a>                     <span class='hs-comment'>-- Reason for loadInterface: deprecation checking</span>
<a name="line-61"></a>                     <span class='hs-comment'>-- assumes that the home interface is loaded, and</span>
<a name="line-62"></a>                     <span class='hs-comment'>-- this is the only way that is going to happen</span>
<a name="line-63"></a>           <span class='hs-layout'>}</span>
<a name="line-64"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBr</span> <span class='hs-varid'>flg</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>  <span class='hs-keyword'>where</span>
<a name="line-66"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Need interface for Template Haskell quoted Name"</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExpBr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span>
<a name="line-69"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExpBr</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBr</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnPat</span> <span class='hs-conid'>ThPatQuote</span> <span class='hs-varid'>p</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBr</span> <span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypBr</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>t'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-conid'>TypBrCtx</span> <span class='hs-varid'>t</span>
<a name="line-74"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypBr</span> <span class='hs-varid'>t'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DecBrL</span> <span class='hs-varid'>decls</span><span class='hs-layout'>)</span>
<a name="line-77"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>group</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>groupDecls</span> <span class='hs-varid'>decls</span>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_env</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-79"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_gbl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbl_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_dus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDUs</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>                          <span class='hs-comment'>-- The emptyDUs is so that we just collect uses for this</span>
<a name="line-81"></a>                          <span class='hs-comment'>-- group alone in the call to rnSrcDecls below</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>group'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>new_gbl_env</span> <span class='hs-varop'>$</span>
<a name="line-83"></a>                              <span class='hs-varid'>rnSrcDecls</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>group</span>
<a name="line-84"></a>   <span class='hs-comment'>-- The empty list is for extra dependencies coming from .hs-boot files</span>
<a name="line-85"></a>   <span class='hs-comment'>-- See Note [Extra dependencies from .hs-boot files] in RnSource</span>
<a name="line-86"></a>
<a name="line-87"></a>              <span class='hs-comment'>-- Discard the tcg_env; it contains only extra info about fixity</span>
<a name="line-88"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rn_bracket dec"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-89"></a>                   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>duUses</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-90"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DecBrG</span> <span class='hs-varid'>group'</span><span class='hs-layout'>,</span> <span class='hs-varid'>duUses</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-91"></a>  <span class='hs-keyword'>where</span>
<a name="line-92"></a>    <span class='hs-varid'>groupDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-93"></a>    <span class='hs-varid'>groupDecls</span> <span class='hs-varid'>decls</span>
<a name="line-94"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>group</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_splice</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findSplice</span> <span class='hs-varid'>decls</span>
<a name="line-95"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_splice</span> <span class='hs-keyword'>of</span>
<a name="line-96"></a>           <span class='hs-layout'>{</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>group</span>
<a name="line-97"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>splice</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-98"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>group'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>groupDecls</span> <span class='hs-varid'>rest</span>
<a name="line-99"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>group''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appendGroups</span> <span class='hs-varid'>group</span> <span class='hs-varid'>group'</span>
<a name="line-100"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>group''</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hs_splcds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varid'>splice</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hs_splcds</span> <span class='hs-varid'>group'</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>                  <span class='hs-layout'>}</span>
<a name="line-102"></a>           <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-103"></a>
<a name="line-104"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DecBrG</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rn_bracket: unexpected DecBrG"</span>
<a name="line-105"></a>
<a name="line-106"></a><span class='hs-definition'>rn_bracket</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span>
<a name="line-107"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="spliceCtxt"></a><span class='hs-definition'>spliceCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>spliceCtxt</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the splice:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="showSplice"></a><span class='hs-definition'>showSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-5"></a><span class='hs-comment'>-- Note that 'before' is *renamed* but not *typechecked*</span>
<a name="line-6"></a><span class='hs-comment'>-- Reason (a) less typechecking crap</span>
<a name="line-7"></a><span class='hs-comment'>--        (b) data constructors after type checking have been</span>
<a name="line-8"></a><span class='hs-comment'>--            changed to their *wrappers*, and that makes them</span>
<a name="line-9"></a><span class='hs-comment'>--            print always fully qualified</span>
<a name="line-10"></a><span class='hs-definition'>showSplice</span> <span class='hs-varid'>what</span> <span class='hs-varid'>before</span> <span class='hs-varid'>after</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceSplice</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Splicing"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>what</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                            <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>before</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                                         <span class='hs-varid'>text</span> <span class='hs-str'>"======&gt;"</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                                         <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>after</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="illegalBracket"></a><span class='hs-definition'>illegalBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-18"></a><span class='hs-definition'>illegalBracket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Template Haskell brackets cannot be nested (without intervening splices)"</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="illegalTypedBracket"></a><span class='hs-definition'>illegalTypedBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-21"></a><span class='hs-definition'>illegalTypedBracket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Typed brackets may only appear in typed slices."</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="illegalUntypedBracket"></a><span class='hs-definition'>illegalUntypedBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-24"></a><span class='hs-definition'>illegalUntypedBracket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Untyped brackets may only appear in untyped slices."</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="illegalTypedSplice"></a><span class='hs-definition'>illegalTypedSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-27"></a><span class='hs-definition'>illegalTypedSplice</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Typed splices may not appear in untyped brackets"</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="illegalUntypedSplice"></a><span class='hs-definition'>illegalUntypedSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-30"></a><span class='hs-definition'>illegalUntypedSplice</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Untyped splices may not appear in typed brackets"</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="quotedNameStageErr"></a><span class='hs-definition'>quotedNameStageErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-33"></a><span class='hs-definition'>quotedNameStageErr</span> <span class='hs-varid'>br</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Stage error: the non-top-level quoted name"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>br</span>
<a name="line-35"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must be used at the same stage at which is is bound"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="quotationCtxtDoc"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-38"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-varid'>br_body</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the Template Haskell quotation"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>-- spliceResultDoc :: OutputableBndr id =&gt; LHsExpr id -&gt; SDoc</span>
<a name="line-43"></a><span class='hs-comment'>-- spliceResultDoc expr</span>
<a name="line-44"></a><span class='hs-comment'>--  = vcat [ hang (ptext (sLit "In the splice:"))</span>
<a name="line-45"></a><span class='hs-comment'>--              2 (char '$' &lt;&gt; pprParendExpr expr)</span>
<a name="line-46"></a><span class='hs-comment'>--        , ptext (sLit "To see what the splice expanded to, use -ddump-splices") ]</span>
<a name="line-47"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="checkThLocalName"></a><span class='hs-definition'>checkThLocalName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-cpp'>#ifndef GHCI  /* GHCI and TH is off */</span>
<a name="line-3"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-4"></a><span class='hs-comment'>-- Check for cross-stage lifting</span>
<a name="line-5"></a><span class='hs-definition'>checkThLocalName</span> <span class='hs-sel'>_name</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-cpp'>#else         /* GHCI and TH is on */</span>
<a name="line-9"></a><span class='hs-definition'>checkThLocalName</span> <span class='hs-varid'>name</span> 
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"checkThLocalName"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mb_local_use</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStageAndBindLevel</span> <span class='hs-varid'>name</span>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_local_use</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-13"></a>             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>;</span>  <span class='hs-comment'>-- Not a locally-bound thing</span>
<a name="line-14"></a>             <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>top_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-15"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>use_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkWellStaged</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varid'>use_lvl</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"checkThLocalName"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>use_stage</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>use_lvl</span><span class='hs-layout'>)</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>use_lvl</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>bind_lvl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>          <span class='hs-varid'>checkCrossStageLifting</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>name</span> <span class='hs-varid'>use_stage</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="checkCrossStageLifting"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-22"></a><span class='hs-definition'>checkCrossStageLifting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-23"></a><span class='hs-comment'>-- We are inside brackets, and (use_lvl &gt; bind_lvl)</span>
<a name="line-24"></a><span class='hs-comment'>-- Now we must check whether there's a cross-stage lift to do</span>
<a name="line-25"></a><span class='hs-comment'>-- Examples   \x -&gt; [| x |]</span>
<a name="line-26"></a><span class='hs-comment'>--            [| map |]</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>checkCrossStageLifting</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>RnPendingUntyped</span> <span class='hs-varid'>ps_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span>
<a name="line-30"></a>        <span class='hs-comment'>-- Top-level identifiers in this module,</span>
<a name="line-31"></a>        <span class='hs-comment'>-- (which have External Names)</span>
<a name="line-32"></a>        <span class='hs-comment'>-- are just like the imported case:</span>
<a name="line-33"></a>        <span class='hs-comment'>-- no need for the 'lifting' treatment</span>
<a name="line-34"></a>        <span class='hs-comment'>-- E.g.  this is fine:</span>
<a name="line-35"></a>        <span class='hs-comment'>--   f x = x</span>
<a name="line-36"></a>        <span class='hs-comment'>--   g y = [| f 3 |]</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>keepAlive</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-comment'>-- See Note [Keeping things alive for Template Haskell]</span>
<a name="line-39"></a>
<a name="line-40"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- Nested identifiers, such as 'x' in</span>
<a name="line-42"></a>        <span class='hs-comment'>-- E.g. \x -&gt; [| h x |]</span>
<a name="line-43"></a>        <span class='hs-comment'>-- We must behave as if the reference to x was</span>
<a name="line-44"></a>        <span class='hs-comment'>--      h $(lift x)</span>
<a name="line-45"></a>        <span class='hs-comment'>-- We use 'x' itself as the splice proxy, used by</span>
<a name="line-46"></a>        <span class='hs-comment'>-- the desugarer to stitch it all back together.</span>
<a name="line-47"></a>        <span class='hs-comment'>-- If 'x' occurs many times we may get many identical</span>
<a name="line-48"></a>        <span class='hs-comment'>-- bindings of the same splice proxy, but that doesn't</span>
<a name="line-49"></a>        <span class='hs-comment'>-- matter, although it's a mite untidy.</span>
<a name="line-50"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"checkCrossStageLifting"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-51"></a>        <span class='hs-layout'>;</span> <span class='hs-comment'>-- Update the pending splices</span>
<a name="line-52"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_var</span>
<a name="line-53"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ps_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnCrossStageSplice</span> <span class='hs-varid'>name</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>checkCrossStageLifting</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-56"></a><span class='hs-cpp'>#endif /* GHCI */</span>
</pre>\end{code}

Note [Keeping things alive for Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f x = x+1
  g y = [| f 3 |]

Here 'f' is referred to from inside the bracket, which turns into data
and mentions only f's *name*, not 'f' itself. So we need some other
way to keep 'f' alive, lest it get dropped as dead code.  That's what
keepAlive does. It puts it in the keep-alive set, which subsequently
ensures that 'f' stays as a top level binding.

This must be done by the renamer, not the type checker (as of old),
because the type checker doesn't typecheck the body of untyped
brackets (Trac #8540).

A thing can have a bind_lvl of outerLevel, but have an internal name:
   foo = [d| op = 3
             bop = op + 1 |]
Here the bind_lvl of 'op' is (bogusly) outerLevel, even though it is
bound inside a bracket.  That is because we don't even even record
binding levels for top-level things; the binding levels are in the
LocalRdrEnv.

So the occurrence of 'op' in the rhs of 'bop' looks a bit like a
cross-stage thing, but it isn't really.  And in fact we never need
to do anything here for top-level bound things, so all is fine, if
a bit hacky.

For these chaps (which have Internal Names) we don't want to put
them in the keep-alive set.

Note [Quoting names]
~~~~~~~~~~~~~~~~~~~~
A quoted name 'n is a bit like a quoted expression [| n |], except that we
have no cross-stage lifting (c.f. TcExpr.thBrackId).  So, after incrementing
the use-level to account for the brackets, the cases are:

        bind > use                      Error
        bind = use+1                    OK
        bind < use
                Imported things         OK
                Top-level things        OK
                Non-top-level           Error

where 'use' is the binding level of the 'n quote. (So inside the implied
bracket the level would be use+1.)

Examples:

  f 'map        -- OK; also for top-level defns of this module

  \x. f 'x      -- Not ok (bind = 1, use = 1)
                -- (whereas \x. f [| x |] might have been ok, by
                --                               cross-stage lifting

  \y. [| \x. $(f 'y) |] -- Not ok (bind =1, use = 1)

  [| \x. $(f 'x) |]     -- OK (bind = 2, use = 1)

</body>
</html>
