<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>simplStg/UnariseStg.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-2012
%

Note [Unarisation]
~~~~~~~~~~~~~~~~~~

The idea of this pass is to translate away *all* unboxed-tuple binders. So for example:

f (x :: (# Int, Bool #)) = f x + f (# 1, True #)
 ==>
f (x1 :: Int) (x2 :: Bool) = f x1 x2 + f 1 True

It is important that we do this at the STG level and NOT at the core level
because it would be very hard to make this pass Core-type-preserving.

STG fed to the code generators *must* be unarised because the code generators do
not support unboxed tuple binders natively.


Note [Unarisation and arity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Because of unarisation, the arity that will be recorded in the generated info table
for an Id may be larger than the idArity. Instead we record what we call the RepArity,
which is the Arity taking into account any expanded arguments, and corresponds to
the number of (possibly-void) *registers* arguments will arrive in.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>UnariseStg</span> <span class='hs-layout'>(</span><span class='hs-varid'>unarise</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-6"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span> <span class='hs-layout'>(</span><span class='hs-varid'>realWorldPrimId</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-20"></a>
<a name="line-21"></a>
<a name="line-22"></a><a name="UnariseEnv"></a><span class='hs-comment'>-- | A mapping from unboxed-tuple binders to the Ids they were expanded to.</span>
<a name="line-23"></a><a name="UnariseEnv"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><a name="UnariseEnv"></a><span class='hs-comment'>-- INVARIANT: Ids in the range don't have unboxed tuple types.</span>
<a name="line-25"></a><a name="UnariseEnv"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><a name="UnariseEnv"></a><span class='hs-comment'>-- Those in-scope variables without unboxed-tuple types are not present in</span>
<a name="line-27"></a><a name="UnariseEnv"></a><span class='hs-comment'>-- the domain of the mapping at all.</span>
<a name="line-28"></a><a name="UnariseEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="ubxTupleId0"></a><span class='hs-definition'>ubxTupleId0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-31"></a><span class='hs-definition'>ubxTupleId0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConWorkId</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="unarise"></a><span class='hs-definition'>unarise</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgBinding</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgBinding</span><span class='hs-keyglyph'>]</span>
<a name="line-34"></a><span class='hs-definition'>unarise</span> <span class='hs-varid'>us</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>us</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unariseBinding</span> <span class='hs-varid'>us</span> <span class='hs-varid'>init_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>listSplitUniqSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span> <span class='hs-comment'>-- See Note [Nullary unboxed tuple] in Type.lhs</span>
<a name="line-36"></a>        <span class='hs-varid'>init_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarEnv</span> <span class='hs-varid'>ubxTupleId0</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>realWorldPrimId</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="unariseBinding"></a><span class='hs-definition'>unariseBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinding</span>
<a name="line-39"></a><span class='hs-definition'>unariseBinding</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bind</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>  <span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>x</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseRhs</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-conid'>StgRec</span> <span class='hs-varid'>xrhss</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRec</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>us</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>unariseRhs</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-42"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>listSplitUniqSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-varid'>xrhss</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="unariseRhs"></a><span class='hs-definition'>unariseRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhs</span>
<a name="line-45"></a><span class='hs-definition'>unariseRhs</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>of</span>
<a name="line-46"></a>  <span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>b_info</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>update_flag</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>args</span> <span class='hs-varid'>expr</span>
<a name="line-47"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>b_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseIds</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>update_flag</span> 
<a name="line-48"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>unariseSRT</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>srt</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us'</span> <span class='hs-varid'>rho'</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-49"></a>    <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>us'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unariseIdBinders</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>args</span>
<a name="line-50"></a>  <span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-51"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>con</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseArgs</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="unariseExpr"></a><span class='hs-comment'>------------------------</span>
<a name="line-54"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-55"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span>
<a name="line-57"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>UbxTupleRep</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-comment'>-- Particularly important where (##) is concerned </span>
<a name="line-59"></a>     <span class='hs-comment'>-- See Note [Nullary unboxed tuple]</span>
<a name="line-60"></a>    <span class='hs-conid'>StgConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-61"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>StgVarArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseId</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgApp</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseArgs</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> 
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgLit</span> <span class='hs-varid'>l</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgConApp</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>args'</span>
<a name="line-72"></a>  <span class='hs-keyword'>where</span> 
<a name="line-73"></a>    <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unariseArgs</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>args</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgOpApp</span> <span class='hs-varid'>op</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgOpApp</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseArgs</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLam</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgLam</span> <span class='hs-varid'>xs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us'</span> <span class='hs-varid'>rho'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-80"></a>  <span class='hs-keyword'>where</span> 
<a name="line-81"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>us'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unariseIdBinders</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>xs</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>case_lives</span> <span class='hs-varid'>alts_lives</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>alt_ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us1</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseLives</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>case_lives</span><span class='hs-layout'>)</span> 
<a name="line-85"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>unariseLives</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>alts_lives</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseSRT</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>srt</span><span class='hs-layout'>)</span> 
<a name="line-86"></a>            <span class='hs-varid'>alt_ty'</span> <span class='hs-varid'>alts'</span>
<a name="line-87"></a> <span class='hs-keyword'>where</span> 
<a name="line-88"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-89"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>alt_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unariseAlts</span> <span class='hs-varid'>us2</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>alt_ty</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>repType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-90"></a>
<a name="line-91"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLet</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgLet</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseBinding</span> <span class='hs-varid'>us1</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us2</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-93"></a>  <span class='hs-keyword'>where</span> 
<a name="line-94"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLetNoEscape</span> <span class='hs-varid'>live_in_let</span> <span class='hs-varid'>live_in_bind</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgLetNoEscape</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseLives</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>live_in_let</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseLives</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>live_in_bind</span><span class='hs-layout'>)</span> 
<a name="line-98"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>unariseBinding</span> <span class='hs-varid'>us1</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us2</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-99"></a>  <span class='hs-keyword'>where</span> 
<a name="line-100"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-101"></a>
<a name="line-102"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgSCC</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>bump_entry</span> <span class='hs-varid'>push_cc</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgSCC</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>bump_entry</span> <span class='hs-varid'>push_cc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-104"></a><span class='hs-definition'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>tick_n</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgTick</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>tick_n</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="unariseAlts"></a><span class='hs-comment'>------------------------</span>
<a name="line-108"></a><span class='hs-definition'>unariseAlts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RepType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgAlt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgAlt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-109"></a><span class='hs-definition'>unariseAlts</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>alt_ty</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnaryRep</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span> 
<a name="line-110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>alt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>us</span> <span class='hs-varid'>alt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unariseAlt</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>alt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>listSplitUniqSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-definition'>unariseAlts</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupleRep</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupAlt</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us2'</span> <span class='hs-varid'>rho'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-114"></a>  <span class='hs-keyword'>where</span> 
<a name="line-115"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>us2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unariseIdBinder</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>bndr</span>
<a name="line-116"></a>    <span class='hs-varid'>uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDeadBinder</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-117"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-definition'>unariseAlts</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupleRep</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> 
<a name="line-120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupAlt</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses'</span><span class='hs-layout'>,</span> <span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us2'</span> <span class='hs-varid'>rho''</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-121"></a>  <span class='hs-keyword'>where</span> 
<a name="line-122"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>us2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unariseUsedIdBinders</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>ys</span> <span class='hs-varid'>uses</span>
<a name="line-123"></a>    <span class='hs-varid'>rho''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>rho'</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ys'</span>
<a name="line-124"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ys'</span>
<a name="line-125"></a>
<a name="line-126"></a><span class='hs-definition'>unariseAlts</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupleRep</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"unariseExpr: strange unboxed tuple alts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="unariseAlt"></a><span class='hs-comment'>--------------------------</span>
<a name="line-130"></a><span class='hs-definition'>unariseAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgAlt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgAlt</span>
<a name="line-131"></a><span class='hs-definition'>unariseAlt</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-132"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses'</span><span class='hs-layout'>,</span> <span class='hs-varid'>unariseExpr</span> <span class='hs-varid'>us'</span> <span class='hs-varid'>rho'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-133"></a>  <span class='hs-keyword'>where</span> 
<a name="line-134"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>us'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unariseUsedIdBinders</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>uses</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="unariseSRT"></a><span class='hs-comment'>------------------------</span>
<a name="line-137"></a><span class='hs-definition'>unariseSRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SRT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SRT</span>
<a name="line-138"></a><span class='hs-definition'>unariseSRT</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>NoSRT</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoSRT</span>
<a name="line-139"></a><span class='hs-definition'>unariseSRT</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>SRTEntries</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SRTEntries</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMapVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseId</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-definition'>unariseSRT</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>SRT</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"unariseSRT"</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="unariseLives"></a><span class='hs-definition'>unariseLives</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgLiveVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgLiveVars</span>
<a name="line-143"></a><span class='hs-definition'>unariseLives</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseId</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="unariseArgs"></a><span class='hs-definition'>unariseArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span>
<a name="line-146"></a><span class='hs-definition'>unariseArgs</span> <span class='hs-varid'>rho</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseArg</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="unariseArg"></a><span class='hs-definition'>unariseArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span>
<a name="line-149"></a><span class='hs-definition'>unariseArg</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>StgVarArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseId</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-150"></a><span class='hs-definition'>unariseArg</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>StgLitArg</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgLitArg</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="unariseIds"></a><span class='hs-definition'>unariseIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-153"></a><span class='hs-definition'>unariseIds</span> <span class='hs-varid'>rho</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseId</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="unariseId"></a><span class='hs-definition'>unariseId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-156"></a><span class='hs-definition'>unariseId</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>x</span> 
<a name="line-157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>x</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>repType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>UbxTupleRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ubxTupleId0</span> 
<a name="line-159"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"unariseId: not unboxed tuple"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span> <span class='hs-layout'>)</span>
<a name="line-160"></a>    <span class='hs-varid'>ys</span>
<a name="line-161"></a>
<a name="line-162"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>repType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>UbxTupleRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-164"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"unariseId: was unboxed tuple"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span> <span class='hs-layout'>)</span>
<a name="line-165"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="unariseUsedIdBinders"></a><span class='hs-definition'>unariseUsedIdBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span> 
<a name="line-168"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqSupply</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnariseEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-169"></a><span class='hs-definition'>unariseUsedIdBinders</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>uses</span> 
<a name="line-170"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mapAccumL2</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"unariseUsedIdBinders"</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-171"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>us'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs_usess</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,,,)</span> <span class='hs-varid'>us'</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>xs_usess</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-172"></a>  <span class='hs-keyword'>where</span>
<a name="line-173"></a>    <span class='hs-varid'>do_one</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>use</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>third3</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-conid'>(,)</span> <span class='hs-varid'>use</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unariseIdBinder</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="unariseIdBinders"></a><span class='hs-definition'>unariseIdBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqSupply</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnariseEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-176"></a><span class='hs-definition'>unariseIdBinders</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>third3</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapAccumL2</span> <span class='hs-varid'>unariseIdBinder</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>xs</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="unariseIdBinder"></a><span class='hs-definition'>unariseIdBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnariseEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqSupply</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnariseEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-179"></a><span class='hs-definition'>unariseIdBinder</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>repType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-180"></a>    <span class='hs-conid'>UnaryRep</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>us</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-181"></a>    <span class='hs-conid'>UbxTupleRep</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>us0</span><span class='hs-layout'>,</span> <span class='hs-varid'>us1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-182"></a>                           <span class='hs-varid'>ys</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unboxedTupleBindersFrom</span> <span class='hs-varid'>us0</span> <span class='hs-varid'>x</span> <span class='hs-varid'>tys</span>
<a name="line-183"></a>                           <span class='hs-varid'>rho'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ys</span>
<a name="line-184"></a>                       <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-185"></a>
<a name="line-186"></a><a name="unboxedTupleBindersFrom"></a><span class='hs-definition'>unboxedTupleBindersFrom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnaryType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-187"></a><span class='hs-definition'>unboxedTupleBindersFrom</span> <span class='hs-varid'>us</span> <span class='hs-varid'>x</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSysLocal</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-188"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="concatMapVarSet"></a><span class='hs-definition'>concatMapVarSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-191"></a><span class='hs-definition'>concatMapVarSet</span> <span class='hs-varid'>f</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}</body>
</html>
