<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcBinds.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[TcBinds]{TcBinds}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcBinds</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcLocalBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTopBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcRecSelBinds</span><span class='hs-layout'>,</span>
<a name="line-2"></a>                 <span class='hs-varid'>tcHsBootSigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPolyCheck</span><span class='hs-layout'>,</span>
<a name="line-3"></a>                 <span class='hs-conid'>PragFun</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSpecPrags</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcVectDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPragFun</span><span class='hs-layout'>,</span> 
<a name="line-4"></a>                 <span class='hs-conid'>TcSigInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>,</span> 
<a name="line-5"></a>                 <span class='hs-varid'>instTcTySig</span><span class='hs-layout'>,</span> <span class='hs-varid'>instTcTySigFromId</span><span class='hs-layout'>,</span> <span class='hs-varid'>findScopedTyVars</span><span class='hs-layout'>,</span>
<a name="line-6"></a>                 <span class='hs-varid'>badBootDeclErr</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcMatches</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcGRHSsPat</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMatchesFun</span> <span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcExpr</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcPatSyn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcPatSynDecl</span> <span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span><span class='hs-layout'>(</span> <span class='hs-varid'>isHsBoot</span> <span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcPat</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FunDeps</span><span class='hs-layout'>(</span> <span class='hs-varid'>growThetaTyVars</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span><span class='hs-varid'>mkStrLitTy</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span><span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span><span class='hs-layout'>(</span><span class='hs-varid'>ipClassName</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Type-checking bindings}
%*                                                                      *
%************************************************************************

@tcBindsAndThen@ typechecks a @HsBinds@.  The "and then" part is because
it needs to know something about the {\em usage} of the things bound,
so that it can create specialisations of them.  So @tcBindsAndThen@
takes a function which, given an extended environment, E, typechecks
the scope of the bindings returning a typechecked thing and (most
important) an LIE.  It is this LIE which is then used as the basis for
specialising the things bound.

@tcBindsAndThen@ also takes a "combiner" which glues together the
bindings and the "thing" to make a new "thing".

The real work is done by @tcBindWithSigsAndThen@.

Recursive and non-recursive binds are handled in essentially the same
way: because of uniques there are no scoping issues left.  The only
difference is that non-recursive bindings can bind primitive values.

Even for non-recursive binding groups we add typings for each binder
to the LVE for the following reason.  When each individual binding is
checked the type of its LHS is unified with that of its RHS; and
type-checking the LHS of course requires that the binder is in scope.

At the top-level the LIE is sure to contain nothing but constant
dictionaries, which we resolve at the module level.

Note [Polymorphic recursion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The game plan for polymorphic recursion in the code above is 

        * Bind any variable for which we have a type signature
          to an Id with a polymorphic type.  Then when type-checking 
          the RHSs we'll make a full polymorphic call.

This fine, but if you aren't a bit careful you end up with a horrendous
amount of partial application and (worse) a huge space leak. For example:

        f :: Eq a => [a] -> [a]
        f xs = ...f...

If we don't take care, after typechecking we get

        f = /\a -> \d::Eq a -> let f' = f a d
                               in
                               \ys:[a] -> ...f'...

Notice the the stupid construction of (f a d), which is of course
identical to the function we're executing.  In this case, the
polymorphic recursion isn't being used (but that's a very common case).
This can lead to a massive space leak, from the following top-level defn
(post-typechecking)

        ff :: [Int] -> [Int]
        ff = f Int dEqInt

Now (f dEqInt) evaluates to a lambda that has f' as a free variable; but
f' is another thunk which evaluates to the same thing... and you end
up with a chain of identical values all hung onto by the CAF ff.

        ff = f Int dEqInt

           = let f' = f Int dEqInt in \ys. ...f'...

           = let f' = let f' = f Int dEqInt in \ys. ...f'...
                      in \ys. ...f'...

Etc.

NOTE: a bit of arity anaysis would push the (f a d) inside the (\ys...),
which would make the space leak go away in this case

Solution: when typechecking the RHSs we always have in hand the
*monomorphic* Ids for each binding.  So we just need to make sure that
if (Method f a d) shows up in the constraints emerging from (...f...)
we just use the monomorphic Id.  We achieve this by adding monomorphic Ids
to the "givens" when simplifying constraints.  That's what the "lies_avail"
is doing.

Then we get

        f = /\a -> \d::Eq a -> letrec
                                 fm = \ys:[a] -> ...fm...
                               in
                               fm

\begin{code}
<pre><a name="line-1"></a><a name="tcTopBinds"></a><span class='hs-definition'>tcTopBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- The TcGblEnv contains the new tcg_binds and tcg_spects</span>
<a name="line-3"></a><span class='hs-comment'>-- The TcLclEnv has an extended type envt for the new bindings</span>
<a name="line-4"></a><span class='hs-definition'>tcTopBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-comment'>-- Pattern synonym bindings populate the global environment</span>
<a name="line-6"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcValBinds</span> <span class='hs-conid'>TopLevel</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>            <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gbl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-8"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>lcl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-9"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>specs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcImpPrags</span> <span class='hs-varid'>sigs</span>   <span class='hs-comment'>-- SPECIALISE prags for imported Ids</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionBags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                                                       <span class='hs-layout'>(</span><span class='hs-varid'>tcg_binds</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span>
<a name="line-14"></a>                                                       <span class='hs-varid'>binds'</span>
<a name="line-15"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>specs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>        <span class='hs-comment'>-- The top level bindings are flattened into a giant </span>
<a name="line-19"></a>        <span class='hs-comment'>-- implicitly-mutually-recursive LHsBinds</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-definition'>tcTopBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcTopBinds"</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="tcRecSelBinds"></a><span class='hs-definition'>tcRecSelBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-24"></a><span class='hs-definition'>tcRecSelBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendGlobalValEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sel_id</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sigs</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-26"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rec_sel_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>discardWarnings</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcValBinds</span> <span class='hs-conid'>TopLevel</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>)</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tcg_env'</span> 
<a name="line-28"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHsBoot</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_src</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span>
<a name="line-29"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionBags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                                                        <span class='hs-layout'>(</span><span class='hs-varid'>tcg_binds</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                                                        <span class='hs-varid'>rec_sel_binds</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>              <span class='hs-comment'>-- Do not add the code for record-selector bindings when </span>
<a name="line-33"></a>              <span class='hs-comment'>-- compiling hs-boot files</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-layout'>}</span>
<a name="line-35"></a><span class='hs-definition'>tcRecSelBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcRecSelBinds"</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="tcHsBootSigs"></a><span class='hs-definition'>tcHsBootSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-38"></a><span class='hs-comment'>-- A hs-boot file has only one BindGroup, and it only has type</span>
<a name="line-39"></a><span class='hs-comment'>-- signatures in it.  The renamer checked all this</span>
<a name="line-40"></a><span class='hs-definition'>tcHsBootSigs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>badBootDeclErr</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>addLocM</span> <span class='hs-varid'>tc_boot_sig</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>isTypeLSig</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>tc_boot_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>lnames</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>f</span> <span class='hs-varid'>lnames</span>
<a name="line-45"></a>      <span class='hs-keyword'>where</span>
<a name="line-46"></a>        <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>sigma_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-47"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVanillaGlobal</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sigma_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>        <span class='hs-comment'>-- Notice that we make GlobalIds, not LocalIds</span>
<a name="line-49"></a>    <span class='hs-varid'>tc_boot_sig</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcHsBootSigs/tc_boot_sig"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-definition'>tcHsBootSigs</span> <span class='hs-varid'>groups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcHsBootSigs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>groups</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="badBootDeclErr"></a><span class='hs-definition'>badBootDeclErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-53"></a><span class='hs-definition'>badBootDeclErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal declarations in an hs-boot file"</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="tcLocalBinds"></a><span class='hs-comment'>------------------------</span>
<a name="line-56"></a><span class='hs-definition'>tcLocalBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>thing</span>
<a name="line-57"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-definition'>tcLocalBinds</span> <span class='hs-conid'>EmptyLocalBinds</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-61"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EmptyLocalBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-definition'>tcLocalBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcValBinds</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-65"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>binds'</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-66"></a><span class='hs-definition'>tcLocalBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcLocalBinds"</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>tcLocalBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>ip_binds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ipClassName</span>
<a name="line-70"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>given_ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>ip_binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-71"></a>            <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocSndM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_ip_bind</span> <span class='hs-varid'>ipClass</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ip_binds</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-comment'>-- If the binding binds ?x = E, we  must now </span>
<a name="line-74"></a>        <span class='hs-comment'>-- discharge any ?x constraints in expr_lie</span>
<a name="line-75"></a>        <span class='hs-comment'>-- See Note [Implicit parameter untouchables]</span>
<a name="line-76"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPSkol</span> <span class='hs-varid'>ips</span><span class='hs-layout'>)</span> 
<a name="line-77"></a>                                  <span class='hs-conid'>[]</span> <span class='hs-varid'>given_ips</span> <span class='hs-varid'>thing_inside</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>ip_binds'</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>  <span class='hs-keyword'>where</span>
<a name="line-81"></a>    <span class='hs-varid'>ips</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ip</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>ip</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ip_binds</span><span class='hs-keyglyph'>]</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-comment'>-- I wonder if we should do these one at at time</span>
<a name="line-84"></a>        <span class='hs-comment'>-- Consider     ?x = 4</span>
<a name="line-85"></a>        <span class='hs-comment'>--              ?y = ?x + 1</span>
<a name="line-86"></a>    <span class='hs-varid'>tc_ip_bind</span> <span class='hs-varid'>ipClass</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>ip</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-87"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-88"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrLitTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsIPNameFS</span> <span class='hs-varid'>ip</span>
<a name="line-89"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>ip_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDict</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>]</span>
<a name="line-90"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>ty</span>
<a name="line-91"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toDict</span> <span class='hs-varid'>ipClass</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>expr'</span>
<a name="line-92"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ip_id</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>ip_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-93"></a>    <span class='hs-varid'>tc_ip_bind</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_ip_bind"</span>
<a name="line-94"></a>
<a name="line-95"></a>    <span class='hs-comment'>-- Coerces a `t` into a dictionry for `IP "x" t`.</span>
<a name="line-96"></a>    <span class='hs-comment'>-- co : t -&gt; IP "x" t</span>
<a name="line-97"></a>    <span class='hs-varid'>toDict</span> <span class='hs-varid'>ipClass</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-98"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>unwrapNewTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>ipClass</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-99"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkWpCast</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-100"></a>        <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"The dictionary for `IP` is not a newtype?"</span>
<a name="line-101"></a>
<a name="line-102"></a>
</pre>\end{code}

Note [Implicit parameter untouchables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We add the type variables in the types of the implicit parameters
as untouchables, not so much because we really must not unify them,
but rather because we otherwise end up with constraints like this
    Num alpha, Implic { wanted = alpha ~ Int }
The constraint solver solves alpha~Int by unification, but then
doesn't float that solved constraint out (it's not an unsolved 
wanted).  Result disaster: the (Num alpha) is again solved, this
time by defaulting.  No no no.

However [Oct 10] this is all handled automatically by the 
untouchable-range idea.

Note [Placeholder PatSyn kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (Trac #9161)

  {-# LANGUAGE PatternSynonyms, DataKinds #-}
  pattern A = ()
  b :: A
  b = undefined

Here, the type signature for b mentions A.  But A is a pattern
synonym, which is typechecked (for very good reasons; a view pattern
in the RHS may mention a value binding) as part of a group of
bindings.  It is entirely resonable to reject this, but to do so
we need A to be in the kind environment when kind-checking the signature for B.

Hence the tcExtendKindEnv2 patsyn_placeholder_kinds, which adds a binding
    A -> AGlobal (AConLike (PatSynCon _|_))
to the environment. Then TcHsType.tcTyVar will find A in the kind environment,
and will give a 'wrongThingErr' as a result.  But the lookup of A won't fail.

The _|_ (= panic "fakePatSynCon") works because the wrongThingErr call, in
tcTyVar, doesn't look inside the TcTyThing.


\begin{code}
<pre><a name="line-1"></a><a name="tcValBinds"></a><span class='hs-definition'>tcValBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> 
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>thing</span>
<a name="line-4"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> 
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>tcValBinds</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Typecheck the signature</span>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendKindEnv2</span> <span class='hs-varid'>patsyn_placeholder_kinds</span> <span class='hs-varop'>$</span>
<a name="line-9"></a>                                     <span class='hs-comment'>-- See Note [Placeholder PatSyn kinds]</span>
<a name="line-10"></a>                                <span class='hs-varid'>tcTySigs</span> <span class='hs-varid'>sigs</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>prag_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPragFun</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionBags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a>                <span class='hs-comment'>-- Extend the envt right away with all </span>
<a name="line-15"></a>                <span class='hs-comment'>-- the Ids declared with type signatures</span>
<a name="line-16"></a>                <span class='hs-comment'>-- Use tcExtendIdEnv2 to avoid extending the TcIdBinder stack</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendIdEnv2</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>poly_ids</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-18"></a>            <span class='hs-varid'>tcBindGroups</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span>
<a name="line-19"></a>                         <span class='hs-varid'>binds</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-varid'>patsyn_placeholder_kinds</span> <span class='hs-comment'>-- See Note [Placeholder PatSyn kinds]</span>
<a name="line-22"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>placeholder_patsyn_tything</span><span class='hs-layout'>)</span>
<a name="line-23"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>lbinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds</span>
<a name="line-24"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span><span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>lbinds</span> <span class='hs-keyglyph'>]</span>
<a name="line-25"></a>    <span class='hs-varid'>placeholder_patsyn_tything</span>
<a name="line-26"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AGlobal</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AConLike</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PatSynCon</span> <span class='hs-varop'>$</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"fakePatSynCon"</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="tcBindGroups"></a><span class='hs-comment'>------------------------</span>
<a name="line-29"></a><span class='hs-definition'>tcBindGroups</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span>
<a name="line-30"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>thing</span>
<a name="line-31"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-comment'>-- Typecheck a whole lot of value bindings,</span>
<a name="line-33"></a><span class='hs-comment'>-- one strongly-connected component at a time</span>
<a name="line-34"></a><span class='hs-comment'>-- Here a "strongly connected component" has the strightforward</span>
<a name="line-35"></a><span class='hs-comment'>-- meaning of a group of bindings that mention each other, </span>
<a name="line-36"></a><span class='hs-comment'>-- ignoring type signatures (that part comes later)</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-definition'>tcBindGroups</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>thing_inside</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-definition'>tcBindGroups</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>group</span> <span class='hs-conop'>:</span> <span class='hs-varid'>groups</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>group'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>groups'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_group</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>group</span> <span class='hs-varop'>$</span> 
<a name="line-45"></a>                   <span class='hs-varid'>tcBindGroups</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>groups</span> <span class='hs-varid'>thing_inside</span>
<a name="line-46"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>group'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>groups'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="tc_group"></a><span class='hs-comment'>------------------------</span>
<a name="line-49"></a><span class='hs-definition'>tc_group</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>thing</span><span class='hs-varop'>.</span> 
<a name="line-50"></a>            <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span>
<a name="line-51"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>thing</span>
<a name="line-52"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-comment'>-- Typecheck one strongly-connected component of the original program.</span>
<a name="line-55"></a><span class='hs-comment'>-- We get a list of groups back, because there may </span>
<a name="line-56"></a><span class='hs-comment'>-- be specialisations etc as well</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>tc_group</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRecursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-59"></a>        <span class='hs-comment'>-- A single non-recursive binding</span>
<a name="line-60"></a>        <span class='hs-comment'>-- We want to keep non-recursive things non-recursive</span>
<a name="line-61"></a>        <span class='hs-comment'>-- so that we desugar unlifted bindings correctly</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>binds</span> <span class='hs-keyword'>of</span>
<a name="line-63"></a>                 <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_group: empty list of binds"</span>
<a name="line-64"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-varid'>bind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bind</span>
<a name="line-65"></a>                 <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_group: NonRecursive binds is not a singleton bag"</span>
<a name="line-66"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_single</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>thing_inside</span>
<a name="line-67"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>NonRecursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>tc_group</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Recursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- To maximise polymorphism, we do a new </span>
<a name="line-71"></a>        <span class='hs-comment'>-- strongly-connected-component analysis, this time omitting </span>
<a name="line-72"></a>        <span class='hs-comment'>-- any references to variables with type signatures.</span>
<a name="line-73"></a>        <span class='hs-comment'>-- (This used to be optional, but isn't now.)</span>
<a name="line-74"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_group rec"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprLHsBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>hasPatSyn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>recursivePatSynErr</span> <span class='hs-varid'>binds</span>
<a name="line-76"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds1</span><span class='hs-layout'>,</span> <span class='hs-sel'>_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>sccs</span>
<a name="line-77"></a>             <span class='hs-comment'>-- Here is where we should do bindInstsOfLocalFuns</span>
<a name="line-78"></a>             <span class='hs-comment'>-- if we start having Methods again</span>
<a name="line-79"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Recursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>                <span class='hs-comment'>-- Rec them all together</span>
<a name="line-81"></a>  <span class='hs-keyword'>where</span>
<a name="line-82"></a>    <span class='hs-varid'>hasPatSyn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPatSyn</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-83"></a>    <span class='hs-varid'>isPatSyn</span> <span class='hs-conid'>PatSynBind</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-84"></a>    <span class='hs-varid'>isPatSyn</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-85"></a>
<a name="line-86"></a>    <span class='hs-varid'>sccs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-87"></a>    <span class='hs-varid'>sccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stronglyConnCompFromEdgedVertices</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEdges</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-90"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>scc</span><span class='hs-conop'>:</span><span class='hs-varid'>sccs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids1</span><span class='hs-layout'>,</span> <span class='hs-varid'>closed</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_scc</span> <span class='hs-varid'>scc</span>
<a name="line-91"></a>                        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids2</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendLetEnv</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>closed</span> <span class='hs-varid'>ids1</span> <span class='hs-varop'>$</span> 
<a name="line-92"></a>                                                    <span class='hs-varid'>go</span> <span class='hs-varid'>sccs</span>
<a name="line-93"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>binds2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ids2</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-94"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-varid'>tc_scc</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_sub_group</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bind</span><span class='hs-keyglyph'>]</span>
<a name="line-97"></a>    <span class='hs-varid'>tc_scc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_sub_group</span> <span class='hs-conid'>Recursive</span>    <span class='hs-varid'>binds</span>
<a name="line-98"></a>
<a name="line-99"></a>    <span class='hs-varid'>tc_sub_group</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcPolyBinds</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-conid'>Recursive</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="recursivePatSynErr"></a><span class='hs-definition'>recursivePatSynErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-102"></a><span class='hs-definition'>recursivePatSynErr</span> <span class='hs-varid'>binds</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span>
<a name="line-104"></a>    <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Recursive pattern synonym definition with following bindings:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-105"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>pprLBind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-106"></a>  <span class='hs-keyword'>where</span>
<a name="line-107"></a>    <span class='hs-varid'>pprLoc</span> <span class='hs-varid'>loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"defined at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-108"></a>    <span class='hs-varid'>pprLBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsBindBinders</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-109"></a>                            <span class='hs-varid'>pprLoc</span> <span class='hs-varid'>loc</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="tc_single"></a><span class='hs-definition'>tc_single</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>thing</span><span class='hs-varop'>.</span>
<a name="line-112"></a>            <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span>
<a name="line-113"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>thing</span>
<a name="line-114"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-115"></a><span class='hs-definition'>tc_single</span> <span class='hs-sel'>_top_lvl</span> <span class='hs-sel'>_sig_fn</span> <span class='hs-sel'>_prag_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ps</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>PatSynBind</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat_syn</span><span class='hs-layout'>,</span> <span class='hs-varid'>aux_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-117"></a>              <span class='hs-varid'>tcPatSynDecl</span> <span class='hs-layout'>(</span><span class='hs-varid'>patsyn_id</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>patsyn_args</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>patsyn_def</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>patsyn_dir</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-118"></a>
<a name="line-119"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tything</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>pat_syn</span><span class='hs-layout'>)</span>
<a name="line-120"></a>             <span class='hs-varid'>implicit_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynMatcher</span> <span class='hs-varid'>pat_syn</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span>
<a name="line-121"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>maybeToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynWrapper</span> <span class='hs-varid'>pat_syn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-122"></a>
<a name="line-123"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendGlobalEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tything</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-124"></a>                  <span class='hs-varid'>tcExtendGlobalEnvImplicit</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>AnId</span> <span class='hs-varid'>implicit_ids</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-125"></a>                  <span class='hs-varid'>thing_inside</span>
<a name="line-126"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>aux_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-127"></a>       <span class='hs-layout'>}</span>
<a name="line-128"></a><span class='hs-definition'>tc_single</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>lbind</span> <span class='hs-varid'>thing_inside</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>closed</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyBinds</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span>
<a name="line-130"></a>                                    <span class='hs-conid'>NonRecursive</span> <span class='hs-conid'>NonRecursive</span>
<a name="line-131"></a>                                    <span class='hs-keyglyph'>[</span><span class='hs-varid'>lbind</span><span class='hs-keyglyph'>]</span>
<a name="line-132"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendLetEnv</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>closed</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>thing_inside</span>
<a name="line-133"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds1</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-134"></a>          
<a name="line-135"></a><a name="mkEdges"></a><span class='hs-comment'>------------------------</span>
<a name="line-136"></a><span class='hs-definition'>mkEdges</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span>
<a name="line-137"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>BKey</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BKey</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="BKey"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>BKey</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- Just number off the bindings</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-definition'>mkEdges</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>binds</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>key</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_fvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-143"></a>                         <span class='hs-conid'>Just</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>key_map</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_sig</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-144"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>keyd_binds</span>
<a name="line-145"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-146"></a>  <span class='hs-keyword'>where</span>
<a name="line-147"></a>    <span class='hs-varid'>no_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-148"></a>    <span class='hs-varid'>no_sig</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-149"></a>
<a name="line-150"></a>    <span class='hs-varid'>keyd_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>`zip`</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>BKey</span> <span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-151"></a>
<a name="line-152"></a>    <span class='hs-varid'>key_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>BKey</span>     <span class='hs-comment'>-- Which binding it comes from</span>
<a name="line-153"></a>    <span class='hs-varid'>key_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>keyd_binds</span>
<a name="line-154"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindersOfHsBind</span> <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>]</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="bindersOfHsBind"></a><span class='hs-definition'>bindersOfHsBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-157"></a><span class='hs-definition'>bindersOfHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat</span>
<a name="line-158"></a><span class='hs-definition'>bindersOfHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span><span class='hs-keyglyph'>]</span>
<a name="line-159"></a><span class='hs-definition'>bindersOfHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>psyn</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>psyn</span><span class='hs-keyglyph'>]</span>
<a name="line-160"></a><span class='hs-definition'>bindersOfHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"bindersOfHsBind AbsBinds"</span>
<a name="line-161"></a><span class='hs-definition'>bindersOfHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBind</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"bindersOfHsBind VarBind"</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="tcPolyBinds"></a><span class='hs-comment'>------------------------</span>
<a name="line-164"></a><span class='hs-definition'>tcPolyBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span>
<a name="line-165"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span>       <span class='hs-comment'>-- Whether the group is really recursive</span>
<a name="line-166"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span>       <span class='hs-comment'>-- Whether it's recursive after breaking</span>
<a name="line-167"></a>                             <span class='hs-comment'>-- dependencies based on type signatures</span>
<a name="line-168"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-169"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-comment'>-- Typechecks a single bunch of bindings all together, </span>
<a name="line-172"></a><span class='hs-comment'>-- and generalises them.  The bunch may be only part of a recursive</span>
<a name="line-173"></a><span class='hs-comment'>-- group, because we use type signatures to maximise polymorphism</span>
<a name="line-174"></a><span class='hs-comment'>--</span>
<a name="line-175"></a><span class='hs-comment'>-- Returns a list because the input may be a single non-recursive binding,</span>
<a name="line-176"></a><span class='hs-comment'>-- in which case the dependency order of the resulting bindings is</span>
<a name="line-177"></a><span class='hs-comment'>-- important.  </span>
<a name="line-178"></a><span class='hs-comment'>-- </span>
<a name="line-179"></a><span class='hs-comment'>-- Knows nothing about the scope of the bindings</span>
<a name="line-180"></a>
<a name="line-181"></a><span class='hs-definition'>tcPolyBinds</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>rec_group</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>bind_list</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>                              <span class='hs-varop'>$</span>
<a name="line-183"></a>    <span class='hs-varid'>recoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>recoveryCode</span> <span class='hs-varid'>binder_names</span> <span class='hs-varid'>sig_fn</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> 
<a name="line-184"></a>        <span class='hs-comment'>-- Set up main recover; take advantage of any type sigs</span>
<a name="line-185"></a>
<a name="line-186"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"------------------------------------------------"</span> <span class='hs-varid'>empty</span>
<a name="line-187"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Bindings for {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binder_names</span><span class='hs-layout'>)</span>
<a name="line-188"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-189"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>type_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclTypeEnv</span>
<a name="line-190"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>plan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decideGeneralisationPlan</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>type_env</span> 
<a name="line-191"></a>                         <span class='hs-varid'>binder_names</span> <span class='hs-varid'>bind_list</span> <span class='hs-varid'>sig_fn</span>
<a name="line-192"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Generalisation plan"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>plan</span><span class='hs-layout'>)</span>
<a name="line-193"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>result</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>tc_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly_ids</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>plan</span> <span class='hs-keyword'>of</span>
<a name="line-194"></a>         <span class='hs-conid'>NoGen</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcPolyNoGen</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind_list</span>
<a name="line-195"></a>         <span class='hs-conid'>InferGen</span> <span class='hs-varid'>mn</span> <span class='hs-varid'>cl</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcPolyInfer</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>mn</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>bind_list</span>
<a name="line-196"></a>         <span class='hs-conid'>CheckGen</span> <span class='hs-varid'>lbind</span> <span class='hs-varid'>sig</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcPolyCheck</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>lbind</span>
<a name="line-197"></a>
<a name="line-198"></a>        <span class='hs-comment'>-- Check whether strict bindings are ok</span>
<a name="line-199"></a>        <span class='hs-comment'>-- These must be non-recursive etc, and are not generalised</span>
<a name="line-200"></a>        <span class='hs-comment'>-- They desugar to a case expression in the end</span>
<a name="line-201"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>checkStrictBinds</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>rec_group</span> <span class='hs-varid'>bind_list</span> <span class='hs-varid'>tc_binds</span> <span class='hs-varid'>poly_ids</span>
<a name="line-202"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"} End of bindings for"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binder_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rec_group</span>
<a name="line-203"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>poly_ids</span><span class='hs-keyglyph'>]</span>
<a name="line-204"></a>                                          <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-205"></a>
<a name="line-206"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-207"></a>  <span class='hs-keyword'>where</span>
<a name="line-208"></a>    <span class='hs-varid'>binder_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHsBindListBinders</span> <span class='hs-varid'>bind_list</span>
<a name="line-209"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr1</span> <span class='hs-varid'>combineSrcSpans</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getLoc</span> <span class='hs-varid'>bind_list</span><span class='hs-layout'>)</span>
<a name="line-210"></a>         <span class='hs-comment'>-- The mbinds have been dependency analysed and </span>
<a name="line-211"></a>         <span class='hs-comment'>-- may no longer be adjacent; so find the narrowest</span>
<a name="line-212"></a>         <span class='hs-comment'>-- span that includes them all</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="tcPolyNoGen"></a><span class='hs-comment'>------------------</span>
<a name="line-215"></a><span class='hs-definition'>tcPolyNoGen</span>     <span class='hs-comment'>-- No generalisation whatsoever</span>
<a name="line-216"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span>       <span class='hs-comment'>-- Whether it's recursive after breaking</span>
<a name="line-217"></a>                   <span class='hs-comment'>-- dependencies based on type signatures</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span>
<a name="line-219"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-220"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>)</span>
<a name="line-221"></a>
<a name="line-222"></a><span class='hs-definition'>tcPolyNoGen</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>tc_sig_fn</span> <span class='hs-varid'>bind_list</span>
<a name="line-223"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_infos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoBinds</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>tc_sig_fn</span>
<a name="line-224"></a>                                             <span class='hs-layout'>(</span><span class='hs-conid'>LetGblBndr</span> <span class='hs-varid'>prag_fn</span><span class='hs-layout'>)</span> 
<a name="line-225"></a>                                             <span class='hs-varid'>bind_list</span>
<a name="line-226"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mono_ids'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_mono_info</span> <span class='hs-varid'>mono_infos</span>
<a name="line-227"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_ids'</span><span class='hs-layout'>,</span> <span class='hs-conid'>NotTopLevel</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-228"></a>  <span class='hs-keyword'>where</span>
<a name="line-229"></a>    <span class='hs-varid'>tc_mono_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span>
<a name="line-230"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mono_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span>
<a name="line-231"></a>             <span class='hs-comment'>-- Zonk, mainly to expose unboxed types to checkStrictBinds</span>
<a name="line-232"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mono_id'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdType</span> <span class='hs-varid'>mono_id</span> <span class='hs-varid'>mono_ty'</span>
<a name="line-233"></a>           <span class='hs-layout'>;</span> <span class='hs-sel'>_specs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSpecPrags</span> <span class='hs-varid'>mono_id'</span> <span class='hs-layout'>(</span><span class='hs-varid'>prag_fn</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-234"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>mono_id'</span> <span class='hs-layout'>}</span>
<a name="line-235"></a>           <span class='hs-comment'>-- NB: tcPrags generates error messages for</span>
<a name="line-236"></a>           <span class='hs-comment'>--     specialisation pragmas for non-overloaded sigs</span>
<a name="line-237"></a>           <span class='hs-comment'>-- Indeed that is why we call it here!</span>
<a name="line-238"></a>           <span class='hs-comment'>-- So we can safely ignore _specs</span>
<a name="line-239"></a>
<a name="line-240"></a><a name="tcPolyCheck"></a><span class='hs-comment'>------------------</span>
<a name="line-241"></a><span class='hs-definition'>tcPolyCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span>       <span class='hs-comment'>-- Whether it's recursive after breaking</span>
<a name="line-242"></a>                             <span class='hs-comment'>-- dependencies based on type signatures</span>
<a name="line-243"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigInfo</span> 
<a name="line-244"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span>
<a name="line-245"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>)</span>
<a name="line-246"></a><span class='hs-comment'>-- There is just one binding, </span>
<a name="line-247"></a><span class='hs-comment'>--   it binds a single variable,</span>
<a name="line-248"></a><span class='hs-comment'>--   it has a signature,</span>
<a name="line-249"></a><span class='hs-definition'>tcPolyCheck</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>prag_fn</span>
<a name="line-250"></a>            <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcSigInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs_w_scoped</span> 
<a name="line-251"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sig_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-252"></a>            <span class='hs-varid'>bind</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVars</span> <span class='hs-varid'>theta</span>
<a name="line-254"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-255"></a>             <span class='hs-varid'>prag_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prag_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-256"></a>             <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>tvs_w_scoped</span>
<a name="line-257"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mono_info</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-258"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>  
<a name="line-259"></a>               <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ev_vars</span> <span class='hs-varop'>$</span>
<a name="line-260"></a>               <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs_w_scoped</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-261"></a>               <span class='hs-varid'>tcMonoBinds</span> <span class='hs-varid'>rec_tc</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-conid'>LetLclBndr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bind</span><span class='hs-keyglyph'>]</span>
<a name="line-262"></a>
<a name="line-263"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>spec_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSpecPrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-264"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>poly_id</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addInlinePrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-265"></a>
<a name="line-266"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mono_info</span>
<a name="line-267"></a>             <span class='hs-varid'>export</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span>
<a name="line-268"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly_id</span>
<a name="line-269"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mono_id</span>
<a name="line-270"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecPrags</span> <span class='hs-varid'>spec_prags</span> <span class='hs-layout'>}</span>
<a name="line-271"></a>             <span class='hs-varid'>abs_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AbsBinds</span> 
<a name="line-272"></a>                        <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-273"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span>
<a name="line-274"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>export</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>}</span>
<a name="line-275"></a>             <span class='hs-varid'>closed</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TopLevel</span>
<a name="line-276"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotTopLevel</span>
<a name="line-277"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>abs_bind</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>poly_id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>closed</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="tcPolyInfer"></a><span class='hs-comment'>------------------</span>
<a name="line-280"></a><span class='hs-definition'>tcPolyInfer</span> 
<a name="line-281"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span>       <span class='hs-comment'>-- Whether it's recursive after breaking</span>
<a name="line-282"></a>                   <span class='hs-comment'>-- dependencies based on type signatures</span>
<a name="line-283"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> 
<a name="line-284"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>         <span class='hs-comment'>-- True &lt;=&gt; apply the monomorphism restriction</span>
<a name="line-285"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>         <span class='hs-comment'>-- True &lt;=&gt; free vars have closed types</span>
<a name="line-286"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-287"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>)</span>
<a name="line-288"></a><span class='hs-definition'>tcPolyInfer</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>tc_sig_fn</span> <span class='hs-varid'>mono</span> <span class='hs-varid'>closed</span> <span class='hs-varid'>bind_list</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_infos</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-290"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span>
<a name="line-291"></a>                <span class='hs-varid'>tcMonoBinds</span> <span class='hs-varid'>rec_tc</span> <span class='hs-varid'>tc_sig_fn</span> <span class='hs-conid'>LetLclBndr</span> <span class='hs-varid'>bind_list</span>
<a name="line-292"></a>
<a name="line-293"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name_taus</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mono_infos</span><span class='hs-keyglyph'>]</span>
<a name="line-294"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyInfer call"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name_taus</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-295"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>mr_bites</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> 
<a name="line-296"></a>                          <span class='hs-varid'>simplifyInfer</span> <span class='hs-varid'>closed</span> <span class='hs-varid'>mono</span> <span class='hs-varid'>name_taus</span> <span class='hs-varid'>wanted</span>
<a name="line-297"></a>
<a name="line-298"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcThetaType</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span>
<a name="line-299"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>exports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkExport</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>qtvs</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span> <span class='hs-varid'>mono_infos</span>
<a name="line-300"></a>
<a name="line-301"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-302"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>poly_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>abe_poly</span> <span class='hs-varid'>exports</span>
<a name="line-303"></a>             <span class='hs-varid'>final_closed</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>closed</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>mr_bites</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TopLevel</span>
<a name="line-304"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotTopLevel</span>
<a name="line-305"></a>             <span class='hs-varid'>abs_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-306"></a>                        <span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qtvs</span>
<a name="line-307"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span>
<a name="line-308"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>}</span>
<a name="line-309"></a>
<a name="line-310"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Binding:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>final_closed</span> <span class='hs-varop'>$$</span>
<a name="line-311"></a>                             <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_ids</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>poly_ids</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-312"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>abs_bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>final_closed</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-313"></a>         <span class='hs-comment'>-- poly_ids are guaranteed zonked by mkExport</span>
<a name="line-314"></a>
<a name="line-315"></a><a name="mkExport"></a><span class='hs-comment'>--------------</span>
<a name="line-316"></a><span class='hs-definition'>mkExport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PragFun</span>
<a name="line-317"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span>      <span class='hs-comment'>-- Both already zonked</span>
<a name="line-318"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MonoBindInfo</span>
<a name="line-319"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABExport</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-320"></a><span class='hs-comment'>-- Only called for generalisation plan IferGen, not by CheckGen or NoGen</span>
<a name="line-321"></a><span class='hs-comment'>--</span>
<a name="line-322"></a><span class='hs-comment'>-- mkExport generates exports with</span>
<a name="line-323"></a><span class='hs-comment'>--      zonked type variables,</span>
<a name="line-324"></a><span class='hs-comment'>--      zonked poly_ids</span>
<a name="line-325"></a><span class='hs-comment'>-- The former is just because no further unifications will change</span>
<a name="line-326"></a><span class='hs-comment'>-- the quantified type variables, so we can fix their final form</span>
<a name="line-327"></a><span class='hs-comment'>-- right now.</span>
<a name="line-328"></a><span class='hs-comment'>-- The latter is needed because the poly_ids are used to extend the</span>
<a name="line-329"></a><span class='hs-comment'>-- type environment; see the invariant on TcEnv.tcExtendIdEnv</span>
<a name="line-330"></a>
<a name="line-331"></a><span class='hs-comment'>-- Pre-condition: the qtvs and theta are already zonked</span>
<a name="line-332"></a>
<a name="line-333"></a><span class='hs-definition'>mkExport</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>qtvs</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span>
<a name="line-334"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mono_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span>
<a name="line-335"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>poly_id</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_sig</span> <span class='hs-keyword'>of</span>
<a name="line-336"></a>                           <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>poly_name</span> <span class='hs-varid'>inferred_poly_ty</span>
<a name="line-337"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sig_id</span> <span class='hs-varid'>sig</span>
<a name="line-338"></a>                <span class='hs-comment'>-- poly_id has a zonked type</span>
<a name="line-339"></a>
<a name="line-340"></a>              <span class='hs-comment'>-- In the inference case (no signature) this stuff figures out</span>
<a name="line-341"></a>              <span class='hs-comment'>-- the right type variables and theta to quantify over</span>
<a name="line-342"></a>              <span class='hs-comment'>-- See Note [Impedence matching]</span>
<a name="line-343"></a>              <span class='hs-varid'>my_tvs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closeOverKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>growThetaTyVars</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>mono_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-344"></a>                            <span class='hs-comment'>-- Include kind variables!  Trac #7916</span>
<a name="line-345"></a>              <span class='hs-varid'>my_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>my_tvs2</span><span class='hs-layout'>)</span> <span class='hs-varid'>qtvs</span>   <span class='hs-comment'>-- Maintain original order</span>
<a name="line-346"></a>              <span class='hs-varid'>my_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>quantifyPred</span> <span class='hs-varid'>my_tvs2</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span>
<a name="line-347"></a>              <span class='hs-varid'>inferred_poly_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>my_tvs</span> <span class='hs-varid'>my_theta</span> <span class='hs-varid'>mono_ty</span>
<a name="line-348"></a>
<a name="line-349"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>poly_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addInlinePrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-350"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>spec_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSpecPrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-351"></a>                <span class='hs-comment'>-- tcPrags requires a zonked poly_id</span>
<a name="line-352"></a>
<a name="line-353"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sel_poly_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>qtvs</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>mono_ty</span>
<a name="line-354"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"mkExport: check sig"</span>
<a name="line-355"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_name</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_poly_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-356"></a>
<a name="line-357"></a>        <span class='hs-comment'>-- Perform the impedence-matching and ambiguity check</span>
<a name="line-358"></a>        <span class='hs-comment'>-- right away.  If it fails, we want to fail now (and recover</span>
<a name="line-359"></a>        <span class='hs-comment'>-- in tcPolyBinds).  If we delay checking, we get an error cascade.</span>
<a name="line-360"></a>        <span class='hs-comment'>-- Remember we are in the tcPolyInfer case, so the type envt is</span>
<a name="line-361"></a>        <span class='hs-comment'>-- closed (unless we are doing NoMonoLocalBinds in which case all bets</span>
<a name="line-362"></a>        <span class='hs-comment'>-- are off)</span>
<a name="line-363"></a>        <span class='hs-comment'>-- See Note [Impedence matching]</span>
<a name="line-364"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_msg</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-365"></a>                            <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span>
<a name="line-366"></a>                            <span class='hs-varid'>tcSubType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-varid'>sel_poly_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-367"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>wanted</span>
<a name="line-368"></a>
<a name="line-369"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span>
<a name="line-370"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly_id</span>
<a name="line-371"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mono_id</span>
<a name="line-372"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecPrags</span> <span class='hs-varid'>spec_prags</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-373"></a>  <span class='hs-keyword'>where</span>
<a name="line-374"></a>    <span class='hs-varid'>inferred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_sig</span>
<a name="line-375"></a>
<a name="line-376"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>tidy_env</span>
<a name="line-377"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-378"></a>      <span class='hs-keyword'>where</span>
<a name="line-379"></a>        <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inferred</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking that"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_name</span><span class='hs-layout'>)</span>
<a name="line-380"></a>                             <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has the inferred type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_ty</span><span class='hs-layout'>)</span>
<a name="line-381"></a>                          <span class='hs-varop'>$$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable cause: the inferred type is ambiguous"</span><span class='hs-layout'>)</span>
<a name="line-382"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking that"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_name</span><span class='hs-layout'>)</span>
<a name="line-383"></a>                             <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has the specified type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_ty</span><span class='hs-layout'>)</span>
<a name="line-384"></a>        <span class='hs-varid'>pp_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_name</span><span class='hs-layout'>)</span>
<a name="line-385"></a>        <span class='hs-varid'>pp_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span>
<a name="line-386"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-387"></a>
<a name="line-388"></a>    <span class='hs-varid'>prag_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prag_fn</span> <span class='hs-varid'>poly_name</span>
<a name="line-389"></a>    <span class='hs-varid'>origin</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AmbigOrigin</span> <span class='hs-varid'>sig_ctxt</span>
<a name="line-390"></a>    <span class='hs-varid'>sig_ctxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InfSigCtxt</span> <span class='hs-varid'>poly_name</span>
</pre>\end{code}

Note [Impedence matching]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f 0 x = x
   f n x = g [] (not x)

   g [] y = f 10 y
   g _  y = f 9  y

After typechecking we'll get
  f_mono_ty :: a -> Bool -> Bool   
  g_mono_ty :: [b] -> Bool -> Bool 
with constraints
  (Eq a, Num a)

Note that f is polymorphic in 'a' and g in 'b'; and these are not linked.
The types we really want for f and g are
   f :: forall a. (Eq a, Num a) => a -> Bool -> Bool
   g :: forall b. [b] -> Bool -> Bool

We can get these by "impedence matching":
   tuple :: forall a b. (Eq a, Num a) => (a -> Bool -> Bool, [b] -> Bool -> Bool)
   tuple a b d1 d1 = let ...bind f_mono, g_mono in (f_mono, g_mono)

   f a d1 d2 = case tuple a Any d1 d2 of (f, g) -> f
   g b = case tuple Integer b dEqInteger dNumInteger of (f,g) -> g

Suppose the shared quantified tyvars are qtvs and constraints theta.
Then we want to check that 
   f's polytype  is more polymorphic than   forall qtvs. theta => f_mono_ty
and the proof is the impedence matcher.  

Notice that the impedence matcher may do defaulting.  See Trac #7173.

It also cleverly does an ambiguity check; for example, rejecting
   f :: F a -> a
where F is a non-injective type function.


\begin{code}
<pre><a name="line-1"></a><a name="PragFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PragFun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="mkPragFun"></a><span class='hs-definition'>mkPragFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PragFun</span>
<a name="line-4"></a><span class='hs-definition'>mkPragFun</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>prag_env</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-5"></a>  <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>get_sig</span> <span class='hs-varid'>sigs</span>
<a name="line-7"></a>
<a name="line-8"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-9"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SpecSig</span>  <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_arity</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InlineSig</span> <span class='hs-varid'>nm</span>   <span class='hs-layout'>(</span><span class='hs-varid'>add_arity</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>    <span class='hs-varid'>get_sig</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-varid'>add_arity</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>inl_prag</span>   <span class='hs-comment'>-- Adjust inl_sat field to match visible arity of function</span>
<a name="line-14"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>ar_env</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-conid'>Inline</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inl_inline</span> <span class='hs-varid'>inl_prag</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl_prag</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inl_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>        <span class='hs-comment'>-- add arity only for real INLINE pragmas, not INLINABLE</span>
<a name="line-17"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl_prag</span>
<a name="line-18"></a>
<a name="line-19"></a>    <span class='hs-varid'>prag_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>    <span class='hs-varid'>prag_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>prs</span>
<a name="line-21"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv_Acc</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>singleton</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-varid'>p</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-comment'>-- ar_env maps a local to the arity of its definition</span>
<a name="line-24"></a>    <span class='hs-varid'>ar_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span>
<a name="line-25"></a>    <span class='hs-varid'>ar_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>lhsBindArity</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>binds</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="lhsBindArity"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Arity</span>
<a name="line-28"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>matchGroupArity</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-definition'>lhsBindArity</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>        <span class='hs-comment'>-- PatBind/VarBind</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="tcSpecPrags"></a><span class='hs-comment'>------------------</span>
<a name="line-33"></a><span class='hs-definition'>tcSpecPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-34"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-35"></a><span class='hs-comment'>-- Add INLINE and SPECIALSE pragmas</span>
<a name="line-36"></a><span class='hs-comment'>--    INLINE prags are added to the (polymorphic) Id directly</span>
<a name="line-37"></a><span class='hs-comment'>--    SPECIALISE prags are passed to the desugarer via TcSpecPrags</span>
<a name="line-38"></a><span class='hs-comment'>-- Pre-condition: the poly_id is zonked</span>
<a name="line-39"></a><span class='hs-comment'>-- Reason: required by tcSubExp</span>
<a name="line-40"></a><span class='hs-definition'>tcSpecPrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>warn_discarded_sigs</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSpec</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>spec_sigs</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>spec_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isSpecLSig</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-45"></a>    <span class='hs-varid'>bad_sigs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_bad_sig</span> <span class='hs-varid'>prag_sigs</span>
<a name="line-46"></a>    <span class='hs-varid'>is_bad_sig</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSpecLSig</span> <span class='hs-varid'>s</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isInlineLSig</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-varid'>warn_discarded_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnPrags</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>bad_sigs</span> <span class='hs-varop'>$</span>
<a name="line-49"></a>                          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Discarding unexpected pragmas for"</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>
<a name="line-52"></a><a name="tcSpec"></a><span class='hs-comment'>--------------</span>
<a name="line-53"></a><span class='hs-definition'>tcSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcSpecPrag</span>
<a name="line-54"></a><span class='hs-definition'>tcSpec</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span> 
<a name="line-55"></a>  <span class='hs-comment'>-- The Name fun_name in the SpecSig may not be the same as that of the poly_id</span>
<a name="line-56"></a>  <span class='hs-comment'>-- Example: SPECIALISE for a class method: the Name in the SpecSig is</span>
<a name="line-57"></a>  <span class='hs-comment'>--          for the selector Id, but the poly_id is something like $cop</span>
<a name="line-58"></a>  <span class='hs-comment'>-- However we want to use fun_name in the error message, since that is</span>
<a name="line-59"></a>  <span class='hs-comment'>-- what the user wrote (Trac #8537)</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-61"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>spec_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-62"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warnIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOverloadedTy</span> <span class='hs-varid'>poly_ty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isInlinePragma</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-63"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SPECIALISE pragma for non-overloaded function"</span><span class='hs-layout'>)</span> 
<a name="line-64"></a>                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-65"></a>                  <span class='hs-comment'>-- Note [SPECIALISE pragmas]</span>
<a name="line-66"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>spec_ty</span>
<a name="line-67"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-varid'>name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>poly_id</span>
<a name="line-70"></a>    <span class='hs-varid'>poly_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span>
<a name="line-71"></a>    <span class='hs-varid'>origin</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecPragOrigin</span> <span class='hs-varid'>name</span>
<a name="line-72"></a>    <span class='hs-varid'>sig_ctxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name</span>
<a name="line-73"></a>    <span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the SPECIALISE pragma"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-definition'>tcSpec</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSpec"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="tcImpPrags"></a><span class='hs-comment'>--------------</span>
<a name="line-78"></a><span class='hs-definition'>tcImpPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-79"></a><span class='hs-comment'>-- SPECIALISE pragamas for imported things</span>
<a name="line-80"></a><span class='hs-definition'>tcImpPrags</span> <span class='hs-varid'>prags</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>not_specialising</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-84"></a>            <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-85"></a>         <span class='hs-keyword'>else</span>
<a name="line-86"></a>            <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcImpSpec</span><span class='hs-layout'>)</span> 
<a name="line-87"></a>            <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prags</span>
<a name="line-88"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-89"></a>  <span class='hs-keyword'>where</span>
<a name="line-90"></a>    <span class='hs-comment'>-- Ignore SPECIALISE pragmas for imported things</span>
<a name="line-91"></a>    <span class='hs-comment'>-- when we aren't specialising, or when we aren't generating</span>
<a name="line-92"></a>    <span class='hs-comment'>-- code.  The latter happens when Haddocking the base library;</span>
<a name="line-93"></a>    <span class='hs-comment'>-- we don't wnat complaints about lack of INLINABLE pragmas </span>
<a name="line-94"></a>    <span class='hs-varid'>not_specialising</span> <span class='hs-varid'>dflags</span>
<a name="line-95"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Specialise</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-96"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hscTarget</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-97"></a>                      <span class='hs-conid'>HscNothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-98"></a>                      <span class='hs-conid'>HscInterpreted</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-99"></a>                      <span class='hs-sel'>_other</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="tcImpSpec"></a><span class='hs-definition'>tcImpSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcSpecPrag</span>
<a name="line-102"></a><span class='hs-definition'>tcImpSpec</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-103"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>
<a name="line-104"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isAnyInlinePragma</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-105"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>addWarnTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>impSpecErr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-106"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>tcSpec</span> <span class='hs-varid'>id</span> <span class='hs-varid'>prag</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="impSpecErr"></a><span class='hs-definition'>impSpecErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-109"></a><span class='hs-definition'>impSpecErr</span> <span class='hs-varid'>name</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"You cannot SPECIALISE"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-111"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"because its definition has no INLINE/INLINABLE pragma"</span><span class='hs-layout'>)</span>
<a name="line-112"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> 
<a name="line-113"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or its defining module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-114"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"was compiled without -O"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-115"></a>  <span class='hs-keyword'>where</span>
<a name="line-116"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="tcVectDecls"></a><span class='hs-comment'>--------------</span>
<a name="line-119"></a><span class='hs-definition'>tcVectDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-120"></a><span class='hs-definition'>tcVectDecls</span> <span class='hs-varid'>decls</span> 
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>decls'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcVect</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls</span>
<a name="line-122"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ids</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lvectDeclName</span> <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decls'</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lvectInstDecl</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>]</span>
<a name="line-123"></a>             <span class='hs-varid'>dups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDupsEq</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-124"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>reportVectDups</span> <span class='hs-varid'>dups</span>
<a name="line-125"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcConstraints</span> <span class='hs-str'>"End of tcVectDecls"</span>
<a name="line-126"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>decls'</span>
<a name="line-127"></a>       <span class='hs-layout'>}</span>
<a name="line-128"></a>  <span class='hs-keyword'>where</span>
<a name="line-129"></a>    <span class='hs-varid'>reportVectDups</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span><span class='hs-conop'>:</span><span class='hs-sel'>_second</span><span class='hs-conop'>:</span><span class='hs-sel'>_more</span><span class='hs-layout'>)</span> 
<a name="line-130"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>first</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-131"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate vectorisation declarations for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>first</span>
<a name="line-132"></a>    <span class='hs-varid'>reportVectDups</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="tcVect"></a><span class='hs-comment'>--------------</span>
<a name="line-135"></a><span class='hs-definition'>tcVect</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VectDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>VectDecl</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-comment'>-- FIXME: We can't typecheck the expression of a vectorisation declaration against the vectorised</span>
<a name="line-137"></a><span class='hs-comment'>--   type of the original definition as this requires internals of the vectoriser not available</span>
<a name="line-138"></a><span class='hs-comment'>--   during type checking.  Instead, constrain the rhs of a vectorisation declaration to be a single</span>
<a name="line-139"></a><span class='hs-comment'>--   identifier (this is checked in 'rnHsVectDecl').  Fix this by enabling the use of 'vectType'</span>
<a name="line-140"></a><span class='hs-comment'>--   from the vectoriser here.</span>
<a name="line-141"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVect</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-143"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>
<a name="line-144"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>L</span> <span class='hs-varid'>rhs_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>rhs_var_name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span>
<a name="line-145"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rhs_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>rhs_var_name</span>
<a name="line-146"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVect</span> <span class='hs-varid'>var</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>rhs_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>rhs_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-147"></a>       <span class='hs-layout'>}</span>
<a name="line-148"></a>
<a name="line-149"></a><span class='hs-comment'>{- OLD CODE:
<a name="line-150"></a>         -- turn the vectorisation declaration into a single non-recursive binding
<a name="line-151"></a>       ; let bind    = L loc $ mkTopFunBind name [mkSimpleMatch [] rhs] 
<a name="line-152"></a>             sigFun  = const Nothing
<a name="line-153"></a>             pragFun = mkPragFun [] (unitBag bind)
<a name="line-154"></a>
<a name="line-155"></a>         -- perform type inference (including generalisation)
<a name="line-156"></a>       ; (binds, [id'], _) &lt;- tcPolyInfer False True sigFun pragFun NonRecursive [bind]
<a name="line-157"></a>       
<a name="line-158"></a>       ; traceTc "tcVect inferred type" $ ppr (varType id')
<a name="line-159"></a>       ; traceTc "tcVect bindings"      $ ppr binds
<a name="line-160"></a>       
<a name="line-161"></a>         -- add all bindings, including the type variable and dictionary bindings produced by type
<a name="line-162"></a>         -- generalisation to the right-hand side of the vectorisation declaration
<a name="line-163"></a>       ; let [AbsBinds tvs evs _ evBinds actualBinds] = (map unLoc . bagToList) binds
<a name="line-164"></a>       ; let [bind']                                  = bagToList actualBinds
<a name="line-165"></a>             MatchGroup 
<a name="line-166"></a>               [L _ (Match _ _ (GRHSs [L _ (GRHS _ rhs')] _))]
<a name="line-167"></a>               _                                      = (fun_matches . unLoc) bind'
<a name="line-168"></a>             rhsWrapped                               = mkHsLams tvs evs (mkHsDictLet evBinds rhs')
<a name="line-169"></a>        
<a name="line-170"></a>        -- We return the type-checked 'Id', to propagate the inferred signature
<a name="line-171"></a>        -- to the vectoriser - see "Note [Typechecked vectorisation pragmas]" in HsDecls
<a name="line-172"></a>       ; return $ HsVect (L loc id') (Just rhsWrapped)
<a name="line-173"></a>       }
<a name="line-174"></a> -}</span>
<a name="line-175"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNoVect</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-177"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>
<a name="line-178"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsNoVect</span> <span class='hs-varid'>var</span>
<a name="line-179"></a>       <span class='hs-layout'>}</span>
<a name="line-180"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectTypeIn</span> <span class='hs-varid'>isScalar</span> <span class='hs-varid'>lname</span> <span class='hs-varid'>rhs_name</span><span class='hs-layout'>)</span>
<a name="line-181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectCtxt</span> <span class='hs-varid'>lname</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-182"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocatedTyCon</span> <span class='hs-varid'>lname</span>
<a name="line-183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span>   <span class='hs-varid'>not</span> <span class='hs-varid'>isScalar</span>             <span class='hs-comment'>-- either    we have a non-SCALAR declaration</span>
<a name="line-184"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>rhs_name</span>           <span class='hs-comment'>-- or        we explicitly provide a vectorised type</span>
<a name="line-185"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>     <span class='hs-comment'>-- otherwise the type constructor must be nullary</span>
<a name="line-186"></a>                 <span class='hs-layout'>)</span>
<a name="line-187"></a>                 <span class='hs-varid'>scalarTyConMustBeNullary</span>
<a name="line-188"></a>
<a name="line-189"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rhs_tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmapMaybeM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_name</span>
<a name="line-190"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVectTypeOut</span> <span class='hs-varid'>isScalar</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>rhs_tycon</span>
<a name="line-191"></a>       <span class='hs-layout'>}</span>
<a name="line-192"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectTypeOut</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcBinds.tcVect: Unexpected 'HsVectTypeOut'"</span>
<a name="line-194"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectClassIn</span> <span class='hs-varid'>lname</span><span class='hs-layout'>)</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectCtxt</span> <span class='hs-varid'>lname</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-196"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocatedClass</span> <span class='hs-varid'>lname</span>
<a name="line-197"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVectClassOut</span> <span class='hs-varid'>cls</span>
<a name="line-198"></a>       <span class='hs-layout'>}</span>
<a name="line-199"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectClassOut</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcBinds.tcVect: Unexpected 'HsVectClassOut'"</span>
<a name="line-201"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectInstIn</span> <span class='hs-varid'>linstTy</span><span class='hs-layout'>)</span>
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectCtxt</span> <span class='hs-varid'>linstTy</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-203"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsVectInst</span> <span class='hs-varid'>linstTy</span>
<a name="line-204"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inst</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupInstance</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-205"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVectInstOut</span> <span class='hs-varid'>inst</span>
<a name="line-206"></a>       <span class='hs-layout'>}</span>
<a name="line-207"></a><span class='hs-definition'>tcVect</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectInstOut</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-208"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcBinds.tcVect: Unexpected 'HsVectInstOut'"</span>
<a name="line-209"></a>
<a name="line-210"></a><a name="vectCtxt"></a><span class='hs-definition'>vectCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-211"></a><span class='hs-definition'>vectCtxt</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking the vectorisation declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="scalarTyConMustBeNullary"></a><span class='hs-definition'>scalarTyConMustBeNullary</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-214"></a><span class='hs-definition'>scalarTyConMustBeNullary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"VECTORISE SCALAR type constructor must be nullary"</span><span class='hs-layout'>)</span>
<a name="line-215"></a>
<a name="line-216"></a><a name="recoveryCode"></a><span class='hs-comment'>--------------</span>
<a name="line-217"></a><span class='hs-comment'>-- If typechecking the binds fails, then return with each</span>
<a name="line-218"></a><span class='hs-comment'>-- signature-less binder given type (forall a.a), to minimise </span>
<a name="line-219"></a><span class='hs-comment'>-- subsequent error messages</span>
<a name="line-220"></a><span class='hs-definition'>recoveryCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>)</span>
<a name="line-221"></a><span class='hs-definition'>recoveryCode</span> <span class='hs-varid'>binder_names</span> <span class='hs-varid'>sig_fn</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcBindsWithSigs: error recovery"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binder_names</span><span class='hs-layout'>)</span>
<a name="line-223"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>poly_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mk_dummy</span> <span class='hs-varid'>binder_names</span>
<a name="line-224"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly_ids</span><span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>all</span> <span class='hs-varid'>is_closed</span> <span class='hs-varid'>poly_ids</span>
<a name="line-225"></a>                                      <span class='hs-keyword'>then</span> <span class='hs-conid'>TopLevel</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>NotTopLevel</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-226"></a>  <span class='hs-keyword'>where</span>
<a name="line-227"></a>    <span class='hs-varid'>mk_dummy</span> <span class='hs-varid'>name</span> 
<a name="line-228"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>        <span class='hs-comment'>-- Had signature; look it up</span>
<a name="line-229"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>forall_a_a</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- No signature</span>
<a name="line-230"></a>
<a name="line-231"></a>    <span class='hs-varid'>is_closed</span> <span class='hs-varid'>poly_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="forall_a_a"></a><span class='hs-definition'>forall_a_a</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>
<a name="line-234"></a><span class='hs-definition'>forall_a_a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>openAlphaTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>openAlphaTyVar</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [SPECIALISE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~
There is no point in a SPECIALISE pragma for a non-overloaded function:
   reverse :: [a] -> [a]
   {-# SPECIALISE reverse :: [Int] -> [Int] #-}

But SPECIALISE INLINE *can* make sense for GADTS:
   data Arr e where
     ArrInt :: !Int -> ByteArray# -> Arr Int
     ArrPair :: !Int -> Arr e1 -> Arr e2 -> Arr (e1, e2)

   (!:) :: Arr e -> Int -> e
   {-# SPECIALISE INLINE (!:) :: Arr Int -> Int -> Int #-}  
   {-# SPECIALISE INLINE (!:) :: Arr (a, b) -> Int -> (a, b) #-}
   (ArrInt _ ba)     !: (I# i) = I# (indexIntArray# ba i)
   (ArrPair _ a1 a2) !: i      = (a1 !: i, a2 !: i)

When (!:) is specialised it becomes non-recursive, and can usefully
be inlined.  Scary!  So we only warn for SPECIALISE *without* INLINE
for a non-overloaded function.

%************************************************************************
%*                                                                      *
\subsection{tcMonoBind}
%*                                                                      *
%************************************************************************

@tcMonoBinds@ deals with a perhaps-recursive group of HsBinds.
The signatures have been dealt with already.

Note [Pattern bindings]
~~~~~~~~~~~~~~~~~~~~~~~
The rule for typing pattern bindings is this:

    ..sigs..
    p = e

where 'p' binds v1..vn, and 'e' may mention v1..vn, 
typechecks exactly like

    ..sigs..
    x = e       -- Inferred type
    v1 = case x of p -> v1
    ..
    vn = case x of p -> vn

Note that  
    (f :: forall a. a -> a) = id
should not typecheck because
       case id of { (f :: forall a. a->a) -> f }
will not typecheck.

\begin{code}
<pre><a name="line-1"></a><a name="tcMonoBinds"></a><span class='hs-definition'>tcMonoBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span>  <span class='hs-comment'>-- Whether the binding is recursive for typechecking purposes</span>
<a name="line-2"></a>                        <span class='hs-comment'>-- i.e. the binders are mentioned in their RHSs, and</span>
<a name="line-3"></a>                        <span class='hs-comment'>--      we are not rescued by a type signature</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LetBndrSpec</span> 
<a name="line-5"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MonoBindInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>tcMonoBinds</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span>
<a name="line-9"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-varid'>b_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inf</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                                <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a>                             <span class='hs-comment'>-- Single function binding, </span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>is_rec</span>   <span class='hs-comment'>-- ...binder isn't mentioned in RHS</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span>   <span class='hs-comment'>-- ...with no type signature</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- In this very special case we infer the type of the</span>
<a name="line-15"></a>        <span class='hs-comment'>-- right hand side first (it may have a higher-rank type)</span>
<a name="line-16"></a>        <span class='hs-comment'>-- and *then* make the monomorphic Id for the LHS</span>
<a name="line-17"></a>        <span class='hs-comment'>-- e.g.         f = \(x::forall a. a-&gt;a) -&gt; &lt;body&gt;</span>
<a name="line-18"></a>        <span class='hs-comment'>--      We want to infer a higher-rank type for f</span>
<a name="line-19"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>b_loc</span>    <span class='hs-varop'>$</span>
<a name="line-20"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>rhs_ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mono_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newNoSigLetBndr</span> <span class='hs-varid'>no_gen</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendIdBndrs</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>mono_id</span> <span class='hs-conid'>NotTopLevel</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-23"></a>                                 <span class='hs-comment'>-- We extend the error context even for a non-recursive </span>
<a name="line-24"></a>                                 <span class='hs-comment'>-- function so that in type error messages we show the </span>
<a name="line-25"></a>                                 <span class='hs-comment'>-- type of the thing whose rhs we are type checking</span>
<a name="line-26"></a>                               <span class='hs-varid'>tcMatchesFun</span> <span class='hs-varid'>name</span> <span class='hs-varid'>inf</span> <span class='hs-varid'>matches</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>b_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inf</span><span class='hs-layout'>,</span>
<a name="line-29"></a>                                               <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span>
<a name="line-30"></a>                                               <span class='hs-varid'>fun_co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_tick</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-31"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-definition'>tcMonoBinds</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span> <span class='hs-varid'>binds</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>tc_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLhs</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-comment'>-- Bring the monomorphic Ids, into scope for the RHSs</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mono_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getMonoBindInfo</span> <span class='hs-varid'>tc_binds</span>
<a name="line-38"></a>              <span class='hs-varid'>rhs_id_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mono_info</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a>                    <span class='hs-comment'>-- A monomorphic binding for each term variable that lacks </span>
<a name="line-40"></a>                    <span class='hs-comment'>-- a type sig.  (Ones with a sig are already in scope.)</span>
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcMonoBinds"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> 
<a name="line-43"></a>                                       <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhs_id_env</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendIdEnv2</span> <span class='hs-varid'>rhs_id_env</span> <span class='hs-varop'>$</span> 
<a name="line-45"></a>                    <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcRhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_binds</span>
<a name="line-46"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToBag</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-comment'>------------------------</span>
<a name="line-49"></a><span class='hs-comment'>-- tcLhs typechecks the LHS of the bindings, to construct the environment in which</span>
<a name="line-50"></a><span class='hs-comment'>-- we typecheck the RHSs.  Basically what we are doing is this: for each binder:</span>
<a name="line-51"></a><span class='hs-comment'>--      if there's a signature for it, use the instantiated signature type</span>
<a name="line-52"></a><span class='hs-comment'>--      otherwise invent a type variable</span>
<a name="line-53"></a><span class='hs-comment'>-- You see that quite directly in the FunBind case.</span>
<a name="line-54"></a><span class='hs-comment'>-- </span>
<a name="line-55"></a><span class='hs-comment'>-- But there's a complication for pattern bindings:</span>
<a name="line-56"></a><span class='hs-comment'>--      data T = MkT (forall a. a-&gt;a)</span>
<a name="line-57"></a><span class='hs-comment'>--      MkT f = e</span>
<a name="line-58"></a><span class='hs-comment'>-- Here we can guess a type variable for the entire LHS (which will be refined to T)</span>
<a name="line-59"></a><span class='hs-comment'>-- but we want to get (f::forall a. a-&gt;a) as the RHS environment.</span>
<a name="line-60"></a><span class='hs-comment'>-- The simplest way to do this is to typecheck the pattern, and then look up the</span>
<a name="line-61"></a><span class='hs-comment'>-- bound mono-ids.  Then we want to retain the typechecked pattern to avoid re-doing</span>
<a name="line-62"></a><span class='hs-comment'>-- it; hence the TcMonoBind data type in which the LHS is done but the RHS isn't</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="TcMonoBind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcMonoBind</span>         <span class='hs-comment'>-- Half completed; LHS done, RHS not done</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcFunBind</span>  <span class='hs-conid'>MonoBindInfo</span>  <span class='hs-conid'>SrcSpan</span> <span class='hs-conid'>Bool</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-66"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPatBind</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MonoBindInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="MonoBindInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MonoBindInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcSigInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-69"></a>        <span class='hs-comment'>-- Type signature (if any), and</span>
<a name="line-70"></a>        <span class='hs-comment'>-- the monomorphic bound things</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="tcLhs"></a><span class='hs-definition'>tcLhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LetBndrSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcMonoBind</span>
<a name="line-73"></a><span class='hs-definition'>tcLhs</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inf</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>no_gen</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LetLclBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-conid'>LetGblBndr</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-76"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- { f :: ty; f x = e } is always done via CheckGen</span>
<a name="line-77"></a>                         <span class='hs-comment'>-- which gives rise to LetLclBndr.  It wouldn't make</span>
<a name="line-78"></a>                         <span class='hs-comment'>-- sense to have a *polymorphic* function Id at this point</span>
<a name="line-79"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mono_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalName</span> <span class='hs-varid'>name</span>
<a name="line-80"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mono_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>mono_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_tau</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-81"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcFunBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>inf</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mono_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-84"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mono_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newNoSigLetBndr</span> <span class='hs-varid'>no_gen</span> <span class='hs-varid'>name</span> <span class='hs-varid'>mono_ty</span>
<a name="line-85"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcFunBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>nm_loc</span> <span class='hs-varid'>inf</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-definition'>tcLhs</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_pat</span> <span class='hs-varid'>exp_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcLetPat</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>no_gen</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>exp_ty</span> <span class='hs-varop'>$</span>
<a name="line-89"></a>                              <span class='hs-varid'>mapM</span> <span class='hs-varid'>lookup_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a>                <span class='hs-comment'>-- After typechecking the pattern, look up the binder</span>
<a name="line-92"></a>                <span class='hs-comment'>-- names, which the pattern has brought into scope.</span>
<a name="line-93"></a>              <span class='hs-varid'>lookup_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>MonoBindInfo</span>
<a name="line-94"></a>              <span class='hs-varid'>lookup_info</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mono_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>
<a name="line-95"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>
<a name="line-97"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>infos</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patMonoBindsCtxt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-98"></a>                                     <span class='hs-varid'>tcInfer</span> <span class='hs-varid'>tc_pat</span>
<a name="line-99"></a>
<a name="line-100"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPatBind</span> <span class='hs-varid'>infos</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>
<a name="line-102"></a><span class='hs-definition'>tcLhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcLhs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other_bind</span><span class='hs-layout'>)</span>
<a name="line-103"></a>        <span class='hs-comment'>-- AbsBind, VarBind impossible</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="tcRhs"></a><span class='hs-comment'>-------------------</span>
<a name="line-106"></a><span class='hs-definition'>tcRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcMonoBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBind</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-comment'>-- When we are doing pattern bindings, or multiple function bindings at a time</span>
<a name="line-108"></a><span class='hs-comment'>-- we *don't* bring any scoped type variables into scope</span>
<a name="line-109"></a><span class='hs-comment'>-- Wny not?  They are not completely rigid.</span>
<a name="line-110"></a><span class='hs-comment'>-- That's why we have the special case for a single FunBind in tcMonoBinds</span>
<a name="line-111"></a><span class='hs-definition'>tcRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcFunBind</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>inf</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendIdBndrs</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>mono_id</span> <span class='hs-conid'>NotTopLevel</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-113"></a>            <span class='hs-comment'>-- NotTopLevel: it's a monomorphic binding</span>
<a name="line-114"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcRhs: fun bind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mono_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-115"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMatchesFun</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>inf</span> 
<a name="line-116"></a>                                            <span class='hs-varid'>matches</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span>
<a name="line-117"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inf</span>
<a name="line-118"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches'</span>
<a name="line-119"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>fun_co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_fn</span> 
<a name="line-120"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_tick</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-121"></a>
<a name="line-122"></a><span class='hs-definition'>tcRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPatBind</span> <span class='hs-varid'>infos</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendIdBndrs</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>mono_id</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>mono_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>infos</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-124"></a>            <span class='hs-comment'>-- NotTopLevel: it's a monomorphic binding</span>
<a name="line-125"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcRhs: pat bind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat'</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pat_ty</span><span class='hs-layout'>)</span>
<a name="line-126"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>grhss'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>patMonoBindsCtxt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-127"></a>                    <span class='hs-varid'>tcGRHSsPat</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>pat_ty</span>
<a name="line-128"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat_ty</span> 
<a name="line-129"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span>
<a name="line-130"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>pat_ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-131"></a>
<a name="line-132"></a>
<a name="line-133"></a><a name="getMonoBindInfo"></a><span class='hs-comment'>---------------------</span>
<a name="line-134"></a><span class='hs-definition'>getMonoBindInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>TcMonoBind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MonoBindInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-135"></a><span class='hs-definition'>getMonoBindInfo</span> <span class='hs-varid'>tc_binds</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_info</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tc_binds</span>
<a name="line-137"></a>  <span class='hs-keyword'>where</span>
<a name="line-138"></a>    <span class='hs-varid'>get_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcFunBind</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span>
<a name="line-139"></a>    <span class='hs-varid'>get_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPatBind</span> <span class='hs-varid'>infos</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>infos</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rest</span>
</pre>\end{code}



%************************************************************************
%*                                                                      *
                Signatures
%*                                                                      *
%************************************************************************

Type signatures are tricky.  See Note [Signature skolems] in TcType

@tcSigs@ checks the signatures for validity, and returns a list of
{\em freshly-instantiated} signatures.  That is, the types are already
split up, and have fresh type variables installed.  All non-type-signature
"RenamedSigs" are ignored.

The @TcSigInfo@ contains @TcTypes@ because they are unified with
the variable's type, and after that checked to see whether they've
been instantiated.

Note [Scoped tyvars]
~~~~~~~~~~~~~~~~~~~~
The -XScopedTypeVariables flag brings lexically-scoped type variables
into scope for any explicitly forall-quantified type variables:
        f :: forall a. a -> a
        f x = e
Then 'a' is in scope inside 'e'.

However, we do *not* support this 
  - For pattern bindings e.g
        f :: forall a. a->a
        (f,g) = e

Note [Signature skolems]
~~~~~~~~~~~~~~~~~~~~~~~~
When instantiating a type signature, we do so with either skolems or
SigTv meta-type variables depending on the use_skols boolean.  This
variable is set True when we are typechecking a single function
binding; and False for pattern bindings and a group of several
function bindings.

Reason: in the latter cases, the "skolems" can be unified together, 
        so they aren't properly rigid in the type-refinement sense.
NB: unless we are doing H98, each function with a sig will be done
    separately, even if it's mutually recursive, so use_skols will be True


Note [Only scoped tyvars are in the TyVarEnv]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We are careful to keep only the *lexically scoped* type variables in
the type environment.  Why?  After all, the renamer has ensured
that only legal occurrences occur, so we could put all type variables
into the type env.

But we want to check that two distinct lexically scoped type variables
do not map to the same internal type variable.  So we need to know which
the lexically-scoped ones are... and at the moment we do that by putting
only the lexically scoped ones into the environment.

Note [Instantiate sig with fresh variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's vital to instantiate a type signature with fresh variables.
For example:
      type T = forall a. [a] -> [a]
      f :: T; 
      f = g where { g :: T; g = <rhs> }

 We must not use the same 'a' from the defn of T at both places!!
(Instantiation is only necessary because of type synonyms.  Otherwise,
it's all cool; each signature has distinct type variables from the renamer.)

Note [Fail eagerly on bad signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a type signaure is wrong, fail immediately:

 * the type sigs may bind type variables, so proceeding without them
   can lead to a cascade of errors

 * the type signature might be ambiguous, in which case checking
   the code against the signature will give a very similar error
   to the ambiguity error.

ToDo: this means we fall over if any type sig
is wrong (eg at the top level of the module), 
which is over-conservative

\begin{code}
<pre><a name="line-1"></a><a name="tcTySigs"></a><span class='hs-definition'>tcTySigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigFun</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tcTySigs</span> <span class='hs-varid'>hs_sigs</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>   <span class='hs-comment'>-- See Note [Fail eagerly on bad signatures]</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty_sigs_s</span><span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-varid'>tcTySig</span> <span class='hs-varid'>hs_sigs</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>ty_sigs_s</span>
<a name="line-6"></a>             <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_id</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty_sigs</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>sig_id</span> <span class='hs-varid'>ty_sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="tcTySig"></a><span class='hs-definition'>tcTySig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instTcTySigFromId</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>id</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sig</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-13"></a><span class='hs-definition'>tcTySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>names</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name1</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-15"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sigma_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name1</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_ty</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>instTcTySig</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>sigma_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a><span class='hs-definition'>tcTySig</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="instTcTySigFromId"></a><span class='hs-definition'>instTcTySigFromId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcSigInfo</span>
<a name="line-20"></a><span class='hs-definition'>instTcTySigFromId</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>id</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInstSigTyVarsLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSigInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-24"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sig_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>  <span class='hs-keyword'>where</span>
<a name="line-27"></a>    <span class='hs-comment'>-- Hack: in an instance decl we use the selector id as</span>
<a name="line-28"></a>    <span class='hs-comment'>-- the template; but we do *not* want the SrcSpan on the Name of</span>
<a name="line-29"></a>    <span class='hs-comment'>-- those type variables to refer to the class decl, rather to</span>
<a name="line-30"></a>    <span class='hs-comment'>-- the instance decl</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="instTcTySig"></a><span class='hs-definition'>instTcTySig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- HsType and corresponding TcType</span>
<a name="line-33"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcSigInfo</span>
<a name="line-34"></a><span class='hs-definition'>instTcTySig</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigma_ty</span> <span class='hs-varid'>name</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstType</span> <span class='hs-varid'>tcInstSigTyVars</span> <span class='hs-varid'>sigma_ty</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSigInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>sigma_ty</span>
<a name="line-37"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sig_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-38"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findScopedTyVars</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>sigma_ty</span> <span class='hs-varid'>inst_tvs</span>
<a name="line-39"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sig_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="GeneralisationPlan"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-42"></a><a name="GeneralisationPlan"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GeneralisationPlan</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoGen</span>               <span class='hs-comment'>-- No generalisation, no AbsBinds</span>
<a name="line-44"></a>
<a name="line-45"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InferGen</span>            <span class='hs-comment'>-- Implicit generalisation; there is an AbsBinds</span>
<a name="line-46"></a>       <span class='hs-conid'>Bool</span>             <span class='hs-comment'>--   True &lt;=&gt; apply the MR; generalise only unconstrained type vars</span>
<a name="line-47"></a>       <span class='hs-conid'>Bool</span>             <span class='hs-comment'>--   True &lt;=&gt; bindings mention only variables with closed types</span>
<a name="line-48"></a>                        <span class='hs-comment'>--            See Note [Bindings with closed types] in TcRnTypes</span>
<a name="line-49"></a>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CheckGen</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-conid'>TcSigInfo</span>
<a name="line-51"></a>                        <span class='hs-comment'>-- One binding with a signature</span>
<a name="line-52"></a>                        <span class='hs-comment'>-- Explicit generalisation; there is an AbsBinds</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-comment'>-- A consequence of the no-AbsBinds choice (NoGen) is that there is</span>
<a name="line-55"></a><span class='hs-comment'>-- no "polymorphic Id" and "monmomorphic Id"; there is just the one</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>GeneralisationPlan</span> <span class='hs-keyword'>where</span>
<a name="line-58"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoGen</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"NoGen"</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferGen</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"InferGen"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span>
<a name="line-60"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CheckGen</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CheckGen"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="decideGeneralisationPlan"></a><span class='hs-definition'>decideGeneralisationPlan</span>
<a name="line-63"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTypeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigFun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GeneralisationPlan</span>
<a name="line-65"></a><span class='hs-definition'>decideGeneralisationPlan</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>type_env</span> <span class='hs-varid'>bndr_names</span> <span class='hs-varid'>lbinds</span> <span class='hs-varid'>sig_fn</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>strict_pat_binds</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoGen</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lbind</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>one_funbind_with_sig</span> <span class='hs-varid'>lbinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CheckGen</span> <span class='hs-varid'>lbind</span> <span class='hs-varid'>sig</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mono_local_binds</span>                                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoGen</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InferGen</span> <span class='hs-varid'>mono_restriction</span> <span class='hs-varid'>closed_flag</span>
<a name="line-70"></a>
<a name="line-71"></a>  <span class='hs-keyword'>where</span>
<a name="line-72"></a>    <span class='hs-varid'>bndr_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>bndr_names</span>
<a name="line-73"></a>    <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>lbinds</span>
<a name="line-74"></a>
<a name="line-75"></a>    <span class='hs-varid'>strict_pat_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isStrictHsBind</span> <span class='hs-varid'>binds</span>
<a name="line-76"></a>       <span class='hs-comment'>-- Strict patterns (top level bang or unboxed tuple) must not</span>
<a name="line-77"></a>       <span class='hs-comment'>-- be polymorphic, because we are going to force them</span>
<a name="line-78"></a>       <span class='hs-comment'>-- See Trac #4498, #8762</span>
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-varid'>mono_restriction</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_MonomorphismRestriction</span> <span class='hs-varid'>dflags</span>
<a name="line-81"></a>                     <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>restricted</span> <span class='hs-varid'>binds</span>
<a name="line-82"></a>
<a name="line-83"></a>    <span class='hs-varid'>is_closed_ns</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-84"></a>    <span class='hs-varid'>is_closed_ns</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldNameSet</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&amp;&amp;</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>is_closed_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ns</span>
<a name="line-85"></a>        <span class='hs-comment'>-- ns are the Names referred to from the RHS of this bind</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-varid'>is_closed_id</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-88"></a>    <span class='hs-comment'>-- See Note [Bindings with closed types] in TcRnTypes</span>
<a name="line-89"></a>    <span class='hs-varid'>is_closed_id</span> <span class='hs-varid'>name</span>
<a name="line-90"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>bndr_set</span>
<a name="line-91"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>              <span class='hs-comment'>-- Ignore binders in this groups, of course</span>
<a name="line-92"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>type_env</span> <span class='hs-varid'>name</span>
<a name="line-93"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-94"></a>          <span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tct_closed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cl</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>cl</span>  <span class='hs-comment'>-- This is the key line</span>
<a name="line-95"></a>          <span class='hs-conid'>ATyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>          <span class='hs-comment'>-- In-scope type variables</span>
<a name="line-96"></a>          <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>           <span class='hs-comment'>--    are not closed!</span>
<a name="line-97"></a>          <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"is_closed_id"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-98"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-99"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>isInternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-100"></a>        <span class='hs-comment'>-- The free-var set for a top level binding mentions</span>
<a name="line-101"></a>        <span class='hs-comment'>-- imported things too, so that we can report unused imports</span>
<a name="line-102"></a>        <span class='hs-comment'>-- These won't be in the local type env.</span>
<a name="line-103"></a>        <span class='hs-comment'>-- Ditto class method etc from the current module</span>
<a name="line-104"></a>
<a name="line-105"></a>    <span class='hs-varid'>closed_flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_closed_ns</span> <span class='hs-varop'>.</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span> <span class='hs-varid'>binds</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-varid'>mono_local_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_MonoLocalBinds</span> <span class='hs-varid'>dflags</span>
<a name="line-108"></a>                    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>closed_flag</span>
<a name="line-109"></a>
<a name="line-110"></a>    <span class='hs-varid'>no_sig</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-comment'>-- With OutsideIn, all nested bindings are monomorphic</span>
<a name="line-113"></a>    <span class='hs-comment'>-- except a single function binding with a signature</span>
<a name="line-114"></a>    <span class='hs-varid'>one_funbind_with_sig</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lbind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sig_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-116"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-117"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lbind</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-118"></a>    <span class='hs-varid'>one_funbind_with_sig</span> <span class='hs-keyword'>_</span>
<a name="line-119"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-120"></a>
<a name="line-121"></a>    <span class='hs-comment'>-- The Haskell 98 monomorphism resetriction</span>
<a name="line-122"></a>    <span class='hs-varid'>restricted</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-123"></a>    <span class='hs-varid'>restricted</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_sig</span> <span class='hs-varid'>v</span>
<a name="line-124"></a>    <span class='hs-varid'>restricted</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>restricted_match</span> <span class='hs-varid'>m</span>
<a name="line-125"></a>                                                           <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>no_sig</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-126"></a>    <span class='hs-varid'>restricted</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"isRestrictedGroup/unrestricted PatSynBind"</span>
<a name="line-127"></a>    <span class='hs-varid'>restricted</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"isRestrictedGroup/unrestricted AbsBinds"</span>
<a name="line-128"></a>
<a name="line-129"></a>    <span class='hs-varid'>restricted_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-130"></a>    <span class='hs-varid'>restricted_match</span> <span class='hs-keyword'>_</span>                                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-131"></a>        <span class='hs-comment'>-- No args =&gt; like a pattern binding</span>
<a name="line-132"></a>        <span class='hs-comment'>-- Some args =&gt; a function binding</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="checkStrictBinds"></a><span class='hs-comment'>-------------------</span>
<a name="line-135"></a><span class='hs-definition'>checkStrictBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span>
<a name="line-136"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-137"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-139"></a><span class='hs-comment'>-- Check that non-overloaded unlifted bindings are</span>
<a name="line-140"></a><span class='hs-comment'>--      a) non-recursive,</span>
<a name="line-141"></a><span class='hs-comment'>--      b) not top level,</span>
<a name="line-142"></a><span class='hs-comment'>--      c) not a multiple-binding group (more or less implied by (a))</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-definition'>checkStrictBinds</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>rec_group</span> <span class='hs-varid'>orig_binds</span> <span class='hs-varid'>tc_binds</span> <span class='hs-varid'>poly_ids</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>unlifted_bndrs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>any_strict_pat</span>   <span class='hs-comment'>-- This binding group must be matched strictly</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNotTopLevel</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>
<a name="line-147"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>strictBindErr</span> <span class='hs-str'>"Top-level"</span> <span class='hs-varid'>unlifted_bndrs</span> <span class='hs-varid'>orig_binds</span><span class='hs-layout'>)</span>
<a name="line-148"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNonRec</span> <span class='hs-varid'>rec_group</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>strictBindErr</span> <span class='hs-str'>"Recursive"</span> <span class='hs-varid'>unlifted_bndrs</span> <span class='hs-varid'>orig_binds</span><span class='hs-layout'>)</span>
<a name="line-150"></a>
<a name="line-151"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>is_monomorphic</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>tc_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-152"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>polyBindErr</span> <span class='hs-varid'>orig_binds</span><span class='hs-layout'>)</span>
<a name="line-153"></a>            <span class='hs-comment'>-- data Ptr a = Ptr Addr#</span>
<a name="line-154"></a>            <span class='hs-comment'>-- f x = let p@(Ptr y) = ... in ...</span>
<a name="line-155"></a>            <span class='hs-comment'>-- Here the binding for 'p' is polymorphic, but does</span>
<a name="line-156"></a>            <span class='hs-comment'>-- not mix with an unlifted binding for 'y'.  You should</span>
<a name="line-157"></a>            <span class='hs-comment'>-- use a bang pattern.  Trac #6078.</span>
<a name="line-158"></a>
<a name="line-159"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSingleton</span> <span class='hs-varid'>orig_binds</span><span class='hs-layout'>)</span>
<a name="line-160"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>strictBindErr</span> <span class='hs-str'>"Multiple"</span> <span class='hs-varid'>unlifted_bndrs</span> <span class='hs-varid'>orig_binds</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a>        <span class='hs-comment'>-- Complain about a binding that looks lazy</span>
<a name="line-163"></a>        <span class='hs-comment'>--    e.g.    let I# y = x in ...</span>
<a name="line-164"></a>        <span class='hs-comment'>-- Remember, in checkStrictBinds we are going to do strict</span>
<a name="line-165"></a>        <span class='hs-comment'>-- matching, so (for software engineering reasons) we insist</span>
<a name="line-166"></a>        <span class='hs-comment'>-- that the strictness is manifest on each binding</span>
<a name="line-167"></a>        <span class='hs-comment'>-- However, lone (unboxed) variables are ok</span>
<a name="line-168"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>any_pat_looks_lazy</span><span class='hs-layout'>)</span>
<a name="line-169"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>unliftedMustBeBang</span> <span class='hs-varid'>orig_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-170"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"csb2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_ids</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-172"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-173"></a>  <span class='hs-keyword'>where</span>
<a name="line-174"></a>    <span class='hs-varid'>unlifted_bndrs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>poly_ids</span>
<a name="line-175"></a>    <span class='hs-varid'>any_strict_pat</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrictHsBind</span>   <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_binds</span>
<a name="line-176"></a>    <span class='hs-varid'>any_pat_looks_lazy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>looksLazyPatBind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_binds</span>
<a name="line-177"></a>
<a name="line-178"></a>    <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-179"></a>                       <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>rho</span>
<a name="line-180"></a>
<a name="line-181"></a>    <span class='hs-varid'>is_monomorphic</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-182"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>evs</span>
<a name="line-183"></a>    <span class='hs-varid'>is_monomorphic</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="unliftedMustBeBang"></a><span class='hs-definition'>unliftedMustBeBang</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-186"></a><span class='hs-definition'>unliftedMustBeBang</span> <span class='hs-varid'>binds</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Pattern bindings containing unlifted types should use an outermost bang pattern:"</span><span class='hs-layout'>)</span>
<a name="line-188"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="polyBindErr"></a><span class='hs-definition'>polyBindErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-191"></a><span class='hs-definition'>polyBindErr</span> <span class='hs-varid'>binds</span>
<a name="line-192"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"You can't mix polymorphic and unlifted bindings"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-193"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-194"></a>                <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable fix: use a bang pattern"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-195"></a>
<a name="line-196"></a><a name="strictBindErr"></a><span class='hs-definition'>strictBindErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-197"></a><span class='hs-definition'>strictBindErr</span> <span class='hs-varid'>flavour</span> <span class='hs-varid'>unlifted_bndrs</span> <span class='hs-varid'>binds</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>flavour</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"aren't allowed:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-199"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-200"></a>  <span class='hs-keyword'>where</span>
<a name="line-201"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>unlifted_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bindings for unlifted types"</span><span class='hs-layout'>)</span>
<a name="line-202"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bang-pattern or unboxed-tuple bindings"</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Binding scoped type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

%************************************************************************
%*                                                                      *
\subsection[TcBinds-errors]{Error contexts and messages}
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="patMonoBindsCtxt"></a><span class='hs-comment'>-- This one is called on LHS, when pat and grhss are both Name </span>
<a name="line-2"></a><span class='hs-comment'>-- and on RHS, when pat is TcId and grhss is still Name</span>
<a name="line-3"></a><span class='hs-definition'>patMonoBindsCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LPat</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-4"></a><span class='hs-definition'>patMonoBindsCtxt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>grhss</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In a pattern binding:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPatBind</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
