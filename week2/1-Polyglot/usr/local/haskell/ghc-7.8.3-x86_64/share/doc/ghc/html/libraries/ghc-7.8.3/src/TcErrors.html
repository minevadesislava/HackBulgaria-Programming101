<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcErrors.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-3"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-4"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-5"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-6"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-7"></a><span class='hs-comment'>-- for details</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcErrors</span><span class='hs-layout'>(</span> 
<a name="line-10"></a>       <span class='hs-varid'>reportUnsolved</span><span class='hs-layout'>,</span> <span class='hs-varid'>reportAllUnsolved</span><span class='hs-layout'>,</span>
<a name="line-11"></a>       <span class='hs-varid'>warnDefaulting</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>       <span class='hs-varid'>solverDepthErrorTcS</span>
<a name="line-14"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isKind</span> <span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>            <span class='hs-layout'>(</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>coercibleClass</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>lookupGRE_Name</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span> 
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>         <span class='hs-layout'>(</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>makeIntoWarning</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprLocErrMsg</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> 
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>equivClasses</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapAccumL</span><span class='hs-layout'>,</span> <span class='hs-varid'>zip4</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\section{Errors and contexts}
%*									*
%************************************************************************

ToDo: for these error messages, should we note the location as coming
from the insts, or just whatever seems to be around in the monad just
now?

Note [Deferring coercion errors to runtime]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
While developing, sometimes it is desirable to allow compilation to succeed even
if there are type errors in the code. Consider the following case:

  module Main where

  a :: Int
  a = 'a'

  main = print "b"

Even though `a` is ill-typed, it is not used in the end, so if all that we're
interested in is `main` it is handy to be able to ignore the problems in `a`.

Since we treat type equalities as evidence, this is relatively simple. Whenever
we run into a type mismatch in TcUnify, we normally just emit an error. But it
is always safe to defer the mismatch to the main constraint solver. If we do
that, `a` will get transformed into

  co :: Int ~ Char
  co = ...

  a :: Int
  a = 'a' `cast` co

The constraint solver would realize that `co` is an insoluble constraint, and
emit an error with `reportUnsolved`. But we can also replace the right-hand side
of `co` with `error "Deferred type error: Int ~ Char"`. This allows the program
to compile, and it will run fine unless we evaluate `a`. This is what
`deferErrorsToRuntime` does.

It does this by keeping track of which errors correspond to which coercion
in TcErrors. TcErrors.reportTidyWanteds does not print the errors
and does not fail if -fdefer-type-errors is on, so that we can continue
compilation. The errors are turned into warnings in `reportUnsolved`.

\begin{code}
<pre><a name="line-1"></a><a name="reportUnsolved"></a><span class='hs-definition'>reportUnsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>reportUnsolved</span> <span class='hs-varid'>wanted</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>defer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_DeferTypeErrors</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>report_unsolved</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>binds_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>wanted</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>binds_var</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="reportAllUnsolved"></a><span class='hs-definition'>reportAllUnsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-9"></a><span class='hs-comment'>-- Report all unsolved goals, even if -fdefer-type-errors is on</span>
<a name="line-10"></a><span class='hs-comment'>-- See Note [Deferring coercion errors to runtime]</span>
<a name="line-11"></a><span class='hs-definition'>reportAllUnsolved</span> <span class='hs-varid'>wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>report_unsolved</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>False</span> <span class='hs-varid'>wanted</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="report_unsolved"></a><span class='hs-definition'>report_unsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EvBindsVar</span>  <span class='hs-comment'>-- cec_binds</span>
<a name="line-14"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>              <span class='hs-comment'>-- cec_defer</span>
<a name="line-15"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-16"></a><span class='hs-comment'>-- Important precondition:</span>
<a name="line-17"></a><span class='hs-comment'>-- WantedConstraints are fully zonked and unflattened, that is,</span>
<a name="line-18"></a><span class='hs-comment'>-- zonkWC has already been applied to these constraints.</span>
<a name="line-19"></a><span class='hs-definition'>report_unsolved</span> <span class='hs-varid'>mb_binds_var</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>wanted</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved (before unflattening)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-26"></a>                 
<a name="line-27"></a>            <span class='hs-comment'>-- If we are deferring we are going to need /all/ evidence around,</span>
<a name="line-28"></a>            <span class='hs-comment'>-- including the evidence produced by unflattening (zonkWC)</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>free_tvs</span>
<a name="line-30"></a>             <span class='hs-varid'>free_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfWC</span> <span class='hs-varid'>wanted</span>
<a name="line-31"></a>             <span class='hs-varid'>err_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_encl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-32"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_env</span>
<a name="line-33"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_defer</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span>
<a name="line-34"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- See Note [Suppressing error messages]</span>
<a name="line-35"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_binds_var</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved (after unflattening):"</span> <span class='hs-varop'>$</span> 
<a name="line-38"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprTvBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>free_tvs</span><span class='hs-layout'>)</span>
<a name="line-39"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span> <span class='hs-keyglyph'>]</span>
<a name="line-40"></a>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportWanteds</span> <span class='hs-varid'>err_ctxt</span> <span class='hs-varid'>wanted</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-44"></a><span class='hs-comment'>--      Internal functions</span>
<a name="line-45"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="ReportErrCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ReportErrCtxt</span> 
<a name="line-48"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_encl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Enclosing implications</span>
<a name="line-49"></a>                	       	       <span class='hs-comment'>--   (innermost first)</span>
<a name="line-50"></a>                                       <span class='hs-comment'>-- ic_skols and givens are tidied, rest are not</span>
<a name="line-51"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-52"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EvBindsVar</span> 
<a name="line-53"></a>                         <span class='hs-comment'>-- Nothinng &lt;=&gt; Report all errors, including holes; no bindings</span>
<a name="line-54"></a>                         <span class='hs-comment'>-- Just ev  &lt;=&gt; make some errors (depending on cec_defer)</span>
<a name="line-55"></a>                         <span class='hs-comment'>--              into warnings, and emit evidence bindings</span>
<a name="line-56"></a>                         <span class='hs-comment'>--              into 'ev' for unsolved constraints</span>
<a name="line-57"></a>
<a name="line-58"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_defer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- True &lt;=&gt; -fdefer-type-errors</span>
<a name="line-59"></a>                                    <span class='hs-comment'>-- Irrelevant if cec_binds = Nothing</span>
<a name="line-60"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- True &lt;=&gt; More important errors have occurred,</span>
<a name="line-61"></a>                                    <span class='hs-comment'>--          so create bindings if need be, but</span>
<a name="line-62"></a>                                    <span class='hs-comment'>--          don't issue any more errors/warnings</span>
<a name="line-63"></a>                                    <span class='hs-comment'>-- See Note [Suppressing error messages]</span>
<a name="line-64"></a>      <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Suppressing error messages]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The cec_suppress flag says "don't report any errors.  Instead, just create
evidence bindings (as usual).  It's used when more important errors have occurred.
Specifically (see reportWanteds)
  * If there are insoluble Givens, then we are in unreachable code and all bets
    are off.  So don't report any further errors.
  * If there are any insolubles (eg Int~Bool), here or in a nested implication, 
    then suppress errors from the flat constraints here.  Sometimes the
    flat-constraint errors are a knock-on effect of the insolubles.


\begin{code}
<pre><a name="line-1"></a><a name="reportImplic"></a><span class='hs-definition'>reportImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>reportImplic</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>implic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span>
<a name="line-3"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evb</span>
<a name="line-4"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_insoluble</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BracketSkol</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>info</span>
<a name="line-6"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varid'>ic_insoluble</span> <span class='hs-comment'>-- For Template Haskell brackets report only</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>        <span class='hs-comment'>-- definite errors. The whole thing will be re-checked</span>
<a name="line-8"></a>                     <span class='hs-comment'>-- later when we plug it in, and meanwhile there may</span>
<a name="line-9"></a>                     <span class='hs-comment'>-- certainly be un-satisfied constraints</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportWanteds</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>wanted</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-15"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>info'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidySkolemInfo</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>info</span>
<a name="line-16"></a>    <span class='hs-varid'>implic'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span>
<a name="line-17"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyEvVar</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>given</span>
<a name="line-18"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info'</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>    <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env2</span>
<a name="line-20"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>cec_encl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>
<a name="line-21"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>cec_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cec_binds</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-22"></a>                                 <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-23"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>evb</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="reportWanteds"></a><span class='hs-definition'>reportWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-26"></a><span class='hs-definition'>reportWanteds</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>wanted</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flats</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>reportFlats</span> <span class='hs-varid'>ctxt</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>insol_given</span><span class='hs-layout'>)</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportFlats</span> <span class='hs-varid'>ctxt1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>insol_wanted</span><span class='hs-layout'>)</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportFlats</span> <span class='hs-varid'>ctxt2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>flats</span><span class='hs-layout'>)</span>
<a name="line-30"></a>            <span class='hs-comment'>-- All the Derived ones have been filtered out of flats </span>
<a name="line-31"></a>            <span class='hs-comment'>-- by the constraint solver. This is ok; we don't want</span>
<a name="line-32"></a>            <span class='hs-comment'>-- to report unsolved Derived goals as errors</span>
<a name="line-33"></a>            <span class='hs-comment'>-- See Note [Do not report derived but soluble errors]</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportImplic</span> <span class='hs-varid'>ctxt1</span><span class='hs-layout'>)</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>            <span class='hs-comment'>-- NB ctxt1: don't suppress inner insolubles if there's only a</span>
<a name="line-36"></a>            <span class='hs-comment'>-- wanted insoluble here; but do suppress inner insolubles</span>
<a name="line-37"></a>            <span class='hs-comment'>-- if there's a given insoluble here (= inaccessible code)</span>
<a name="line-38"></a> <span class='hs-keyword'>where</span>
<a name="line-39"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>insol_given</span><span class='hs-layout'>,</span> <span class='hs-varid'>insol_wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>insols</span>
<a name="line-40"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span>
<a name="line-41"></a>
<a name="line-42"></a>      <span class='hs-comment'>-- See Note [Suppressing error messages]</span>
<a name="line-43"></a>    <span class='hs-varid'>suppress0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-varid'>ctxt</span>
<a name="line-44"></a>    <span class='hs-varid'>suppress1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>suppress0</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>insol_given</span><span class='hs-layout'>)</span>
<a name="line-45"></a>    <span class='hs-varid'>suppress2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>suppress0</span> <span class='hs-varop'>||</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>wanted</span>
<a name="line-46"></a>    <span class='hs-varid'>ctxt1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>suppress1</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>    <span class='hs-varid'>ctxt2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>suppress2</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="reportFlats"></a><span class='hs-definition'>reportFlats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-50"></a><span class='hs-definition'>reportFlats</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>flats</span>    <span class='hs-comment'>-- Here 'flats' includes insolble goals</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportFlats"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Flats ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>flats</span>
<a name="line-52"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Suppress ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_suppress</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>tryReporters</span>
<a name="line-54"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- First deal with things that are utterly wrong</span>
<a name="line-55"></a>        <span class='hs-comment'>-- Like Int ~ Bool (incl nullary TyCons)</span>
<a name="line-56"></a>        <span class='hs-comment'>-- or  Int ~ t a   (AppTy on one side)</span>
<a name="line-57"></a>        <span class='hs-layout'>(</span><span class='hs-str'>"Utterly wrong"</span><span class='hs-layout'>,</span>  <span class='hs-varid'>utterly_wrong</span><span class='hs-layout'>,</span>   <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGroupReporter</span> <span class='hs-varid'>mkEqErr</span><span class='hs-layout'>)</span>
<a name="line-58"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Holes"</span><span class='hs-layout'>,</span>          <span class='hs-varid'>is_hole</span><span class='hs-layout'>,</span>         <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUniReporter</span> <span class='hs-varid'>mkHoleError</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-comment'>-- Report equalities of form (a~ty).  They are usually</span>
<a name="line-61"></a>        <span class='hs-comment'>-- skolem-equalities, and they cause confusing knock-on</span>
<a name="line-62"></a>        <span class='hs-comment'>-- effects in other errors; see test T4093b.</span>
<a name="line-63"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Skolem equalities"</span><span class='hs-layout'>,</span> <span class='hs-varid'>skolem_eq</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-varid'>mkSkolReporter</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a>        <span class='hs-comment'>-- Other equalities; also confusing knock on effects</span>
<a name="line-66"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Equalities"</span><span class='hs-layout'>,</span>      <span class='hs-varid'>is_equality</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-varid'>mkGroupReporter</span> <span class='hs-varid'>mkEqErr</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Implicit params"</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_ip</span><span class='hs-layout'>,</span>       <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGroupReporter</span> <span class='hs-varid'>mkIPErr</span><span class='hs-layout'>)</span>
<a name="line-69"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Irreds"</span><span class='hs-layout'>,</span>          <span class='hs-varid'>is_irred</span><span class='hs-layout'>,</span>    <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGroupReporter</span> <span class='hs-varid'>mkIrredErr</span><span class='hs-layout'>)</span>
<a name="line-70"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Dicts"</span><span class='hs-layout'>,</span>           <span class='hs-varid'>is_dict</span><span class='hs-layout'>,</span>     <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGroupReporter</span> <span class='hs-varid'>mkDictErr</span><span class='hs-layout'>)</span>
<a name="line-71"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-72"></a>      <span class='hs-varid'>panicReporter</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>flats</span><span class='hs-layout'>)</span>
<a name="line-73"></a>          <span class='hs-comment'>-- TuplePreds should have been expanded away by the constraint</span>
<a name="line-74"></a>          <span class='hs-comment'>-- simplifier, so they shouldn't show up at this point</span>
<a name="line-75"></a>  <span class='hs-keyword'>where</span>
<a name="line-76"></a>    <span class='hs-varid'>utterly_wrong</span><span class='hs-layout'>,</span> <span class='hs-varid'>skolem_eq</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_hole</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_dict</span><span class='hs-layout'>,</span>
<a name="line-77"></a>      <span class='hs-varid'>is_equality</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_ip</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_irred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredTree</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-varid'>utterly_wrong</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty2</span>
<a name="line-80"></a>    <span class='hs-varid'>utterly_wrong</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-varid'>is_hole</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isHoleCt</span> <span class='hs-varid'>ct</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-varid'>skolem_eq</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRigidOrSkol</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isRigidOrSkol</span> <span class='hs-varid'>ty2</span>
<a name="line-85"></a>    <span class='hs-varid'>skolem_eq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-varid'>is_equality</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-88"></a>    <span class='hs-varid'>is_equality</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-89"></a>
<a name="line-90"></a>    <span class='hs-varid'>is_dict</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-91"></a>    <span class='hs-varid'>is_dict</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-92"></a>
<a name="line-93"></a>    <span class='hs-varid'>is_ip</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isIPClass</span> <span class='hs-varid'>cls</span>
<a name="line-94"></a>    <span class='hs-varid'>is_ip</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-varid'>is_irred</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IrredPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-97"></a>    <span class='hs-varid'>is_irred</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-98"></a>
<a name="line-99"></a>
<a name="line-100"></a><a name="isRigid"></a><span class='hs-comment'>---------------</span>
<a name="line-101"></a><span class='hs-definition'>isRigid</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRigidOrSkol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-102"></a><span class='hs-definition'>isRigid</span> <span class='hs-varid'>ty</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForAllTy</span> <span class='hs-varid'>ty</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="isRigidOrSkol"></a><span class='hs-definition'>isRigidOrSkol</span> <span class='hs-varid'>ty</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="isTyFun_maybe"></a><span class='hs-definition'>isTyFun_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCon</span>
<a name="line-113"></a><span class='hs-definition'>isTyFun_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-114"></a>                      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span>
<a name="line-115"></a>                      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-116"></a>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-119"></a><span class='hs-comment'>--      Reporters</span>
<a name="line-120"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="Reporter"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Reporter</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-124"></a><a name="ReporterSpec"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ReporterSpec</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>String</span>                     <span class='hs-comment'>-- Name</span>
<a name="line-126"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredTree</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- Pick these ones</span>
<a name="line-127"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span>                       <span class='hs-comment'>-- True &lt;=&gt; suppress subsequent reporters</span>
<a name="line-128"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Reporter</span><span class='hs-layout'>)</span>                  <span class='hs-comment'>-- The reporter itself</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="panicReporter"></a><span class='hs-definition'>panicReporter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Reporter</span>
<a name="line-131"></a><span class='hs-definition'>panicReporter</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cts</span>
<a name="line-132"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reportFlats"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="mkSkolReporter"></a><span class='hs-definition'>mkSkolReporter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Reporter</span>
<a name="line-136"></a><span class='hs-comment'>-- Suppress duplicates with the same LHS</span>
<a name="line-137"></a><span class='hs-definition'>mkSkolReporter</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportGroup</span> <span class='hs-varid'>mkEqErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>equivClasses</span> <span class='hs-varid'>cmp_lhs_type</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-139"></a>  <span class='hs-keyword'>where</span>
<a name="line-140"></a>    <span class='hs-varid'>cmp_lhs_type</span> <span class='hs-varid'>ct1</span> <span class='hs-varid'>ct2</span>
<a name="line-141"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-142"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`cmpType`</span> <span class='hs-varid'>ty2</span>
<a name="line-143"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkSkolReporter"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct2</span><span class='hs-layout'>)</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="mkUniReporter"></a><span class='hs-definition'>mkUniReporter</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span>
<a name="line-146"></a><span class='hs-comment'>-- Reports errors one at a time</span>
<a name="line-147"></a><span class='hs-definition'>mkUniReporter</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt</span>
<a name="line-148"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-149"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-150"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>maybeReportError</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>err</span>
<a name="line-151"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>maybeAddDeferredBinding</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>err</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span>
<a name="line-152"></a>
<a name="line-153"></a><a name="mkGroupReporter"></a><span class='hs-definition'>mkGroupReporter</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>)</span>
<a name="line-154"></a>                             <span class='hs-comment'>-- Make error message for a group</span>
<a name="line-155"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span>  <span class='hs-comment'>-- Deal with lots of constraints</span>
<a name="line-156"></a><span class='hs-comment'>-- Group together errors from same location,</span>
<a name="line-157"></a><span class='hs-comment'>-- and report only the first (to avoid a cascade)</span>
<a name="line-158"></a><span class='hs-definition'>mkGroupReporter</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportGroup</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>equivClasses</span> <span class='hs-varid'>cmp_loc</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-160"></a>  <span class='hs-keyword'>where</span>
<a name="line-161"></a>    <span class='hs-varid'>cmp_loc</span> <span class='hs-varid'>ct1</span> <span class='hs-varid'>ct2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>ctLocSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct2</span><span class='hs-layout'>)</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="reportGroup"></a><span class='hs-definition'>reportGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReportErrCtxt</span>
<a name="line-164"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-165"></a><span class='hs-definition'>reportGroup</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-167"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>maybeReportError</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>err</span>
<a name="line-168"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeAddDeferredBinding</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-169"></a>               <span class='hs-comment'>-- Add deferred bindings for all</span>
<a name="line-170"></a>               <span class='hs-comment'>-- But see Note [Always warn with -fdefer-type-errors]</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="maybeReportError"></a><span class='hs-definition'>maybeReportError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrMsg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-173"></a><span class='hs-comment'>-- Report the error and/or make a deferred binding for it</span>
<a name="line-174"></a><span class='hs-definition'>maybeReportError</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>err</span>
<a name="line-175"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cec_defer</span> <span class='hs-varid'>ctxt</span>  <span class='hs-comment'>-- See Note [Always warn with -fdefer-type-errors]</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportWarning</span> <span class='hs-layout'>(</span><span class='hs-varid'>makeIntoWarning</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-177"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-varid'>ctxt</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-179"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-180"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportError</span> <span class='hs-varid'>err</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="maybeAddDeferredBinding"></a><span class='hs-definition'>maybeAddDeferredBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrMsg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-183"></a><span class='hs-comment'>-- See Note [Deferring coercion errors to runtime]</span>
<a name="line-184"></a><span class='hs-definition'>maybeAddDeferredBinding</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>err</span> <span class='hs-varid'>ct</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-186"></a>    <span class='hs-comment'>-- Only add deferred bindings for Wanted constraints</span>
<a name="line-187"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isHoleCt</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>||</span> <span class='hs-varid'>cec_defer</span> <span class='hs-varid'>ctxt</span>  <span class='hs-comment'>-- And it's a hole or we have -fdefer-type-errors</span>
<a name="line-188"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_binds</span> <span class='hs-varid'>ctxt</span>  <span class='hs-comment'>-- We have somewhere to put the bindings</span>
<a name="line-189"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-190"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>err_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprLocErrMsg</span> <span class='hs-varid'>err</span>
<a name="line-191"></a>             <span class='hs-varid'>err_fs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-192"></a>                       <span class='hs-varid'>err_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(deferred type error)"</span>
<a name="line-193"></a>
<a name="line-194"></a>         <span class='hs-comment'>-- Create the binding</span>
<a name="line-195"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addTcEvBind</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>ev_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>err_fs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-196"></a>
<a name="line-197"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Do not set any evidence for Given/Derived</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="tryReporters"></a><span class='hs-definition'>tryReporters</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ReporterSpec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span>
<a name="line-201"></a><span class='hs-comment'>-- Use the first reporter in the list whose predicate says True</span>
<a name="line-202"></a><span class='hs-definition'>tryReporters</span> <span class='hs-varid'>reporters</span> <span class='hs-varid'>deflt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-204"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>reporters</span> <span class='hs-varid'>cts</span>
<a name="line-205"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters }"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-206"></a>  <span class='hs-keyword'>where</span>
<a name="line-207"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ctxt</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deflt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-208"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>suppress_after</span><span class='hs-layout'>,</span> <span class='hs-varid'>reporter</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-209"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>yeses</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters: no"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>
<a name="line-210"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rs</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-211"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters: yes"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>)</span>
<a name="line-212"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>reporter</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-213"></a>                         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>suppress_after</span> <span class='hs-varop'>||</span> <span class='hs-varid'>cec_suppress</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>}</span>
<a name="line-214"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>rs</span> <span class='hs-varid'>nos</span> <span class='hs-layout'>}</span>
<a name="line-215"></a>                         <span class='hs-comment'>-- Carry on with the rest, because we must make</span>
<a name="line-216"></a>                         <span class='hs-comment'>-- deferred bindings for them if we have</span>
<a name="line-217"></a>                         <span class='hs-comment'>-- -fdefer-type-errors</span>
<a name="line-218"></a>                         <span class='hs-comment'>-- But suppress their error messages</span>
<a name="line-219"></a>      <span class='hs-keyword'>where</span>
<a name="line-220"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>nos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>keep_me</span> <span class='hs-varid'>cts</span>
<a name="line-221"></a>       <span class='hs-varid'>keep_me</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="addArising"></a><span class='hs-comment'>-- Add the "arising from..." part to a message about bunch of dicts</span>
<a name="line-224"></a><span class='hs-definition'>addArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-225"></a><span class='hs-definition'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-varid'>msg</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArising</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="pprWithArising"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-228"></a><span class='hs-comment'>-- Print something like</span>
<a name="line-229"></a><span class='hs-comment'>--    (Eq a) arising from a use of x at y</span>
<a name="line-230"></a><span class='hs-comment'>--    (Show a) arising from a use of p at q</span>
<a name="line-231"></a><span class='hs-comment'>-- Also return a location for the error message</span>
<a name="line-232"></a><span class='hs-comment'>-- Works for Wanted/Derived only</span>
<a name="line-233"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-conid'>[]</span> 
<a name="line-234"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprWithArising"</span>
<a name="line-235"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-236"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cts</span>
<a name="line-237"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>addArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> 
<a name="line-238"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-239"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-240"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-241"></a>  <span class='hs-keyword'>where</span>
<a name="line-242"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span>
<a name="line-243"></a>    <span class='hs-varid'>ppr_one</span> <span class='hs-varid'>ct'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-244"></a>                     <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArisingAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-245"></a>
<a name="line-246"></a><a name="mkErrorMsg"></a><span class='hs-definition'>mkErrorMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-247"></a><span class='hs-definition'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>msg</span> 
<a name="line-248"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tcl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-249"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>err_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkErrInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span>
<a name="line-250"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkLongErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>err_info</span> <span class='hs-layout'>}</span>
<a name="line-251"></a>
<a name="line-252"></a><a name="UserGiven"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UserGiven</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>)</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="getUserGivens"></a><span class='hs-definition'>getUserGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UserGiven</span><span class='hs-keyglyph'>]</span>
<a name="line-255"></a><span class='hs-comment'>-- One item for each enclosing implication</span>
<a name="line-256"></a><span class='hs-definition'>getUserGivens</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span><span class='hs-varid'>cec_encl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-257"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span>
<a name="line-258"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> 
<a name="line-259"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span><span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span>
<a name="line-260"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Always warn with -fdefer-type-errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When -fdefer-type-errors is on we warn about *all* type errors, even
if cec_suppress is on.  This can lead to a lot more warnings than you
would get errors without -fdefer-type-errors, but if we suppress any of
them you might get a runtime error that wasn't warned about at compile
time. 

This is an easy design choice to change; just flip the order of the
first two equations for maybeReportError

To be consistent, we should also report multiple warnings from a single
location in mkGroupReporter, when -fdefer-type-errors is on.  But that 
is perhaps a bit *over*-consistent! Again, an easy choice to change.


Note [Do not report derived but soluble errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The wc_flats include Derived constraints that have not been solved, but are
not insoluble (in that case they'd be in wc_insols).  We do not want to report
these as errors:

* Superclass constraints. If we have an unsolved [W] Ord a, we'll also have
  an unsolved [D] Eq a, and we do not want to report that; it's just noise.

* Functional dependencies.  For givens, consider
      class C a b | a -> b
      data T a where
         MkT :: C a d => [d] -> T a
      f :: C a b => T a -> F Int
      f (MkT xs) = length xs
  Then we get a [D] b~d.  But there *is* a legitimate call to
  f, namely   f (MkT [True]) :: T Bool, in which b=d.  So we should
  not reject the program.

  For wanteds, something similar
      data T a where
        MkT :: C Int b => a -> b -> T a 
      g :: C Int c => c -> ()
      f :: T a -> ()
      f (MkT x y) = g x
  Here we get [G] C Int b, [W] C Int a, hence [D] a~b.
  But again f (MkT True True) is a legitimate call.

(We leave the Deriveds in wc_flat until reportErrors, so that we don't lose
derived superclasses between iterations of the solver.)

For functional dependencies, here is a real example, 
stripped off from libraries/utf8-string/Codec/Binary/UTF8/Generic.hs

  class C a b | a -> b
  g :: C a b => a -> b -> () 
  f :: C a b => a -> b -> () 
  f xa xb = 
      let loop = g xa 
      in loop xb

We will first try to infer a type for loop, and we will succeed:
    C a b' => b' -> ()
Subsequently, we will type check (loop xb) and all is good. But, 
recall that we have to solve a final implication constraint: 
    C a b => (C a b' => .... cts from body of loop .... )) 
And now we have a problem as we will generate an equality b ~ b' and fail to 
solve it. 


%************************************************************************
%*                  *
                Irreducible predicate errors
%*                  *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkIrredErr"></a><span class='hs-definition'>mkIrredErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-2"></a><span class='hs-definition'>mkIrredErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>relevantBindings</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct1</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct1</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>  <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ct1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-7"></a>    <span class='hs-varid'>orig</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct1</span><span class='hs-layout'>)</span>
<a name="line-8"></a>    <span class='hs-varid'>givens</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-9"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="mkHoleError"></a><span class='hs-comment'>----------------</span>
<a name="line-12"></a><span class='hs-definition'>mkHoleError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-13"></a><span class='hs-definition'>mkHoleError</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-15"></a>             <span class='hs-varid'>tyvars_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>loc_msg</span> <span class='hs-varid'>tyvars</span>
<a name="line-16"></a>             <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Found hole"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                             <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with type:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tyvars_msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Where:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-varid'>tyvars_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_doc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>relevantBindings</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-20"></a>               <span class='hs-comment'>-- The 'False' means "don't filter the bindings; see Trac #8191</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>binds_doc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>  <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>loc_msg</span> <span class='hs-varid'>tv</span> 
<a name="line-24"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>          <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>skol_msg</span>
<a name="line-26"></a>          <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an ambiguous type variable"</span><span class='hs-layout'>)</span>
<a name="line-27"></a>          <span class='hs-varid'>det</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprTcTyVarDetails</span> <span class='hs-varid'>det</span>
<a name="line-28"></a>       <span class='hs-keyword'>where</span> 
<a name="line-29"></a>          <span class='hs-varid'>skol_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprSkol</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>mkHoleError</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkHoleError"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="mkIPErr"></a><span class='hs-comment'>----------------</span>
<a name="line-34"></a><span class='hs-definition'>mkIPErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-35"></a><span class='hs-definition'>mkIPErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>relevantBindings</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct1</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct1</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>bind_msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>  <span class='hs-keyword'>where</span>
<a name="line-39"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ct1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-40"></a>    <span class='hs-varid'>orig</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct1</span><span class='hs-layout'>)</span>
<a name="line-41"></a>    <span class='hs-varid'>preds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>cts</span>
<a name="line-42"></a>    <span class='hs-varid'>givens</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-43"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span>
<a name="line-44"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-varop'>$</span>
<a name="line-45"></a>          <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unbound implicit parameter"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>cts</span>
<a name="line-46"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-varid'>preds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> 
<a name="line-47"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-48"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>preds</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
                Equality errors
%*									*
%************************************************************************

Note [Inaccessible code]
~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   data T a where
     T1 :: T a
     T2 :: T Bool

   f :: (a ~ Int) => T a -> Int
   f T1 = 3
   f T2 = 4   -- Unreachable code

Here the second equation is unreachable. The original constraint
(a~Int) from the signature gets rewritten by the pattern-match to
(Bool~Int), so the danger is that we report the error as coming from
the *signature* (Trac #7293).  So, for Given errors we replace the
env (and hence src-loc) on its CtLoc with that from the immediately
enclosing implication.

\begin{code}
<pre><a name="line-1"></a><a name="mkEqErr"></a><span class='hs-definition'>mkEqErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-2"></a><span class='hs-comment'>-- Don't have multiple equality errors from the same location</span>
<a name="line-3"></a><span class='hs-comment'>-- E.g.   (Int,Bool) ~ (Bool,Int)   one error will do!</span>
<a name="line-4"></a><span class='hs-definition'>mkEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqErr1</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-5"></a><span class='hs-definition'>mkEqErr</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkEqErr"</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mkEqErr1"></a><span class='hs-definition'>mkEqErr1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-8"></a><span class='hs-comment'>-- Wanted constraints only!</span>
<a name="line-9"></a><span class='hs-definition'>mkEqErr1</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGiven</span> <span class='hs-varid'>ev</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>relevantBindings</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>given_loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>given_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkEqErr_help</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>given_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>)</span> 
<a name="line-15"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>{</span><span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_loc</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Note [Inaccessible code]</span>
<a name="line-16"></a>                      <span class='hs-conid'>Nothing</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Wanted or derived</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>relevantBindings</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_orig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_oriented</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_wanted_extra</span> <span class='hs-varid'>tidy_orig</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkEqErr_help</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>wanted_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>)</span> 
<a name="line-24"></a>                      <span class='hs-varid'>ct</span> <span class='hs-varid'>is_oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>ev</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-27"></a>    <span class='hs-varid'>loc</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-varid'>ev</span>
<a name="line-28"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEqPredTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a>    <span class='hs-varid'>mk_given</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-comment'>-- For given constraints we overwrite the env (and hence src-loc)</span>
<a name="line-32"></a>    <span class='hs-comment'>-- with one from the implication.  See Note [Inaccessible code]</span>
<a name="line-33"></a>    <span class='hs-varid'>mk_given</span> <span class='hs-conid'>[]</span>           <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-34"></a>    <span class='hs-varid'>mk_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>setCtLocEnv</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_env</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-35"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Inaccessible code in"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_info</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a>       <span class='hs-comment'>-- If the types in the error message are the same as the types</span>
<a name="line-39"></a>       <span class='hs-comment'>-- we are unifying, don't add the extra expected/actual message</span>
<a name="line-40"></a>    <span class='hs-varid'>mk_wanted_extra</span> <span class='hs-varid'>orig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-41"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExpectedActualMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>orig</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>mk_wanted_extra</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>cty1</span> <span class='hs-varid'>cty2</span> <span class='hs-varid'>sub_o</span><span class='hs-layout'>)</span>
<a name="line-44"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>msg2</span><span class='hs-layout'>)</span>
<a name="line-45"></a>      <span class='hs-keyword'>where</span>
<a name="line-46"></a>        <span class='hs-varid'>msg1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When matching types"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                  <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>cty1</span><span class='hs-layout'>)</span>
<a name="line-48"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>cty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-49"></a>        <span class='hs-varid'>msg2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sub_o</span> <span class='hs-keyword'>of</span>
<a name="line-50"></a>                 <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkExpectedActualMsg</span> <span class='hs-varid'>cty1</span> <span class='hs-varid'>cty2</span> <span class='hs-varid'>sub_o</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                 <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>mk_wanted_extra</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="mkEqErr_help"></a><span class='hs-definition'>mkEqErr_help</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-56"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>          
<a name="line-57"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SwapFlag</span>   <span class='hs-comment'>-- Nothing &lt;=&gt; not sure</span>
<a name="line-58"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-59"></a><span class='hs-definition'>mkEqErr_help</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarEqErr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarEqErr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>swapped</span>  <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportEqErr</span>  <span class='hs-varid'>ctxt</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-63"></a>  <span class='hs-keyword'>where</span>
<a name="line-64"></a>    <span class='hs-varid'>swapped</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>flipSwap</span> <span class='hs-varid'>oriented</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="reportEqErr"></a><span class='hs-definition'>reportEqErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-67"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>    
<a name="line-68"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SwapFlag</span>   <span class='hs-comment'>-- Nothing &lt;=&gt; not sure</span>
<a name="line-69"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-70"></a><span class='hs-definition'>reportEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>extra1</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>extra2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqInfoMsg</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-73"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>extra2</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra1</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="mkTyVarEqErr"></a><span class='hs-definition'>mkTyVarEqErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> 
<a name="line-76"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SwapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-77"></a><span class='hs-comment'>-- tv1 and ty2 are already tidied</span>
<a name="line-78"></a><span class='hs-definition'>mkTyVarEqErr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUserSkolem</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tv1</span>   <span class='hs-comment'>-- ty2 won't be a meta-tyvar, or else the thing would</span>
<a name="line-80"></a>                            <span class='hs-comment'>-- be oriented the other way round; see TcCanonical.reOrient</span>
<a name="line-81"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-83"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>extraTyVarInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-84"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a>  <span class='hs-comment'>-- So tv is a meta tyvar (or started that way before we </span>
<a name="line-87"></a>  <span class='hs-comment'>-- generalised it).  So presumably it is an *untouchable* </span>
<a name="line-88"></a>  <span class='hs-comment'>-- meta tyvar or a SigTv, else it'd have been unified</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>k2</span> <span class='hs-varop'>`tcIsSubKind`</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>   	 <span class='hs-comment'>-- Kind error</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindErrorMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OC_Occurs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>occ_check_expand</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occCheckMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Occurs check: cannot construct the infinite type:"</span><span class='hs-layout'>)</span>
<a name="line-94"></a>                              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-95"></a>             <span class='hs-varid'>extra2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqInfoMsg</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-96"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>occCheckMsg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra2</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-97"></a>
<a name="line-98"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OC_Forall</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>occ_check_expand</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot instantiate unification variable"</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-101"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with a type involving foralls:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-102"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you want ImpredicativeTypes"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-103"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a>  <span class='hs-comment'>-- If the immediately-enclosing implication has 'tv' a skolem, and</span>
<a name="line-106"></a>  <span class='hs-comment'>-- we know by now its an InferSkol kind of skolem, then presumably</span>
<a name="line-107"></a>  <span class='hs-comment'>-- it started life as a SigTv, else it'd have been unified, given</span>
<a name="line-108"></a>  <span class='hs-comment'>-- that there's no occurs-check or forall problem</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>
<a name="line-110"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>implic</span>
<a name="line-111"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>skols</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-113"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>extraTyVarInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-114"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-115"></a>
<a name="line-116"></a>  <span class='hs-comment'>-- Check for skolem escape</span>
<a name="line-117"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>   <span class='hs-comment'>-- Get the innermost context</span>
<a name="line-118"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>implic</span>
<a name="line-119"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>esc_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>skols</span>
<a name="line-120"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>esc_skols</span><span class='hs-layout'>)</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-122"></a>             <span class='hs-varid'>esc_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"because type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>esc_skols</span>
<a name="line-123"></a>                             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>esc_skols</span>
<a name="line-124"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"would escape"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-125"></a>                             <span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>esc_skols</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"its scope"</span><span class='hs-layout'>)</span>
<a name="line-126"></a>                                                      <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"their scope"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-127"></a>             <span class='hs-varid'>tv_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>esc_doc</span>
<a name="line-128"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>esc_skols</span> 
<a name="line-129"></a>                                      <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"This (rigid, skolem) type variable is"</span><span class='hs-layout'>)</span>
<a name="line-130"></a>                                      <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"These (rigid, skolem) type variables are"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span>
<a name="line-132"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span>
<a name="line-133"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-134"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>tv_extra</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-135"></a>
<a name="line-136"></a>  <span class='hs-comment'>-- Nastiest case: attempt to unify an untouchable variable</span>
<a name="line-137"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>   <span class='hs-comment'>-- Get the innermost context</span>
<a name="line-138"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>implic</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-140"></a>             <span class='hs-varid'>untch_extra</span> 
<a name="line-141"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span>
<a name="line-142"></a>                  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is untouchable"</span><span class='hs-layout'>)</span>
<a name="line-143"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inside the constraints"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVarTheta</span> <span class='hs-varid'>given</span>
<a name="line-144"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span>
<a name="line-145"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-146"></a>             <span class='hs-varid'>tv_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extraTyVarInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-147"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>untch_extra</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_extra</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-148"></a>
<a name="line-149"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-151"></a>        <span class='hs-comment'>-- This *can* happen (Trac #6123, and test T2627b)</span>
<a name="line-152"></a>        <span class='hs-comment'>-- Consider an ambiguous top-level constraint (a ~ F a)</span>
<a name="line-153"></a>        <span class='hs-comment'>-- Not an occurs check, because F is a type function.</span>
<a name="line-154"></a>  <span class='hs-keyword'>where</span>         
<a name="line-155"></a>    <span class='hs-varid'>occ_check_expand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurCheckExpand</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-156"></a>    <span class='hs-varid'>k1</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span>
<a name="line-157"></a>    <span class='hs-varid'>k2</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-158"></a>    <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="mkEqInfoMsg"></a><span class='hs-definition'>mkEqInfoMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-161"></a><span class='hs-comment'>-- Report (a) ambiguity if either side is a type function application</span>
<a name="line-162"></a><span class='hs-comment'>--            e.g. F a0 ~ Int    </span>
<a name="line-163"></a><span class='hs-comment'>--        (b) warning about injectivity if both sides are the same</span>
<a name="line-164"></a><span class='hs-comment'>--            type function application   F a ~ F b</span>
<a name="line-165"></a><span class='hs-comment'>--            See Note [Non-injective type functions]</span>
<a name="line-166"></a><span class='hs-definition'>mkEqInfoMsg</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyfun_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ambig_msg</span>
<a name="line-168"></a>  <span class='hs-keyword'>where</span>
<a name="line-169"></a>    <span class='hs-varid'>mb_fun1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTyFun_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-170"></a>    <span class='hs-varid'>mb_fun2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTyFun_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-171"></a>
<a name="line-172"></a>    <span class='hs-varid'>ambig_msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_fun1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_fun2</span> 
<a name="line-173"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAmbigMsg</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-174"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-175"></a>
<a name="line-176"></a>    <span class='hs-varid'>tyfun_msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_fun1</span>
<a name="line-177"></a>              <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_fun2</span>
<a name="line-178"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> 
<a name="line-179"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"NB:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> 
<a name="line-180"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a type function, and may not be injective"</span><span class='hs-layout'>)</span>
<a name="line-181"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="isUserSkolem"></a><span class='hs-definition'>isUserSkolem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-184"></a><span class='hs-comment'>-- See Note [Reporting occurs-check errors]</span>
<a name="line-185"></a><span class='hs-definition'>isUserSkolem</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tv</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_user_skol_tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-187"></a>  <span class='hs-keyword'>where</span>
<a name="line-188"></a>    <span class='hs-varid'>is_user_skol_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sks</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-189"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>sks</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_user_skol_info</span> <span class='hs-varid'>skol_info</span>
<a name="line-190"></a>
<a name="line-191"></a>    <span class='hs-varid'>is_user_skol_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-192"></a>    <span class='hs-varid'>is_user_skol_info</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="misMatchOrCND"></a><span class='hs-definition'>misMatchOrCND</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SwapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-195"></a><span class='hs-comment'>-- If oriented then ty1 is actual, ty2 is expected</span>
<a name="line-196"></a><span class='hs-definition'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-197"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span> <span class='hs-varop'>||</span> 
<a name="line-198"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> 
<a name="line-199"></a>    <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span>
<a name="line-200"></a>       <span class='hs-comment'>-- If the equality is unconditionally insoluble</span>
<a name="line-201"></a>       <span class='hs-comment'>-- or there is no context, don't report the context</span>
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-203"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      
<a name="line-204"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>mkEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-205"></a>  <span class='hs-keyword'>where</span>
<a name="line-206"></a>    <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-207"></a>    <span class='hs-varid'>orig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-208"></a>
<a name="line-209"></a><a name="couldNotDeduce"></a><span class='hs-definition'>couldNotDeduce</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UserGiven</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-210"></a><span class='hs-definition'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>wanteds</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-211"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Could not deduce"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-212"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="pp_givens"></a><span class='hs-definition'>pp_givens</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UserGiven</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-215"></a><span class='hs-definition'>pp_givens</span> <span class='hs-varid'>givens</span> 
<a name="line-216"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>givens</span> <span class='hs-keyword'>of</span>
<a name="line-217"></a>         <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-218"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>g</span><span class='hs-conop'>:</span><span class='hs-varid'>gs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>      <span class='hs-varid'>ppr_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"from the context"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span>
<a name="line-219"></a>                 <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or from"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-220"></a>    <span class='hs-keyword'>where</span> 
<a name="line-221"></a>       <span class='hs-varid'>ppr_given</span> <span class='hs-varid'>herald</span> <span class='hs-layout'>(</span><span class='hs-varid'>gs</span><span class='hs-layout'>,</span> <span class='hs-varid'>skol_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-222"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVarTheta</span> <span class='hs-varid'>gs</span><span class='hs-layout'>)</span>
<a name="line-223"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span>
<a name="line-224"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="extraTyVarInfo"></a><span class='hs-definition'>extraTyVarInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-227"></a><span class='hs-comment'>-- Add on extra info about the types themselves</span>
<a name="line-228"></a><span class='hs-comment'>-- NB: The types themselves are already tidied</span>
<a name="line-229"></a><span class='hs-definition'>extraTyVarInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra2</span><span class='hs-layout'>)</span>
<a name="line-231"></a>  <span class='hs-keyword'>where</span>
<a name="line-232"></a>    <span class='hs-varid'>extra1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarExtraInfoMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span>
<a name="line-233"></a>    <span class='hs-varid'>extra2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarExtraInfoMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="tyVarExtraInfoMsg"></a><span class='hs-definition'>tyVarExtraInfoMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-236"></a><span class='hs-comment'>-- Shows a bit of extra info about skolem constants</span>
<a name="line-237"></a><span class='hs-definition'>tyVarExtraInfoMsg</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>ty</span>
<a name="line-238"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-239"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-240"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pp_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-241"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-242"></a>    <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprSkol</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSkolemInfo</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-243"></a>    <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a flattening type variable"</span><span class='hs-layout'>)</span>
<a name="line-244"></a>    <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an interactive-debugger skolem"</span><span class='hs-layout'>)</span>
<a name="line-245"></a>    <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span>
<a name="line-246"></a>
<a name="line-247"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-comment'>-- Normal case</span>
<a name="line-248"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-249"></a> 
<a name="line-250"></a><a name="kindErrorMsg"></a><span class='hs-definition'>kindErrorMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>   <span class='hs-comment'>-- Types are already tidy</span>
<a name="line-251"></a><span class='hs-definition'>kindErrorMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind incompatibility when matching types:"</span><span class='hs-layout'>)</span>
<a name="line-253"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k1</span>
<a name="line-254"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-255"></a>  <span class='hs-keyword'>where</span>
<a name="line-256"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-257"></a>    <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-258"></a>
<a name="line-259"></a><a name="misMatchMsg"></a><span class='hs-comment'>--------------------</span>
<a name="line-260"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SwapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>	   <span class='hs-comment'>-- Types are already tidy</span>
<a name="line-261"></a><span class='hs-comment'>-- If oriented then ty1 is actual, ty2 is expected</span>
<a name="line-262"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-263"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>IsSwapped</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>oriented</span>
<a name="line-264"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>NotSwapped</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty1</span>
<a name="line-265"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>NotSwapped</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>oriented</span>
<a name="line-266"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match expected"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-267"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>12</span> <span class='hs-varop'>$</span>   <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with actual"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-268"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>sameOccExtra</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>]</span>
<a name="line-269"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-270"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-271"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>14</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-272"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>sameOccExtra</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>]</span>
<a name="line-273"></a>  <span class='hs-keyword'>where</span>
<a name="line-274"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind"</span><span class='hs-layout'>)</span>
<a name="line-275"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-276"></a>
<a name="line-277"></a><a name="mkExpectedActualMsg"></a><span class='hs-definition'>mkExpectedActualMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>SwapFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-278"></a><span class='hs-comment'>-- NotSwapped means (actual, expected), IsSwapped is the reverse</span>
<a name="line-279"></a><span class='hs-definition'>mkExpectedActualMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-280"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>act</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>NotSwapped</span><span class='hs-layout'>,</span>  <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-281"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>act</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>IsSwapped</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-282"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-283"></a>  <span class='hs-keyword'>where</span>
<a name="line-284"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Expected type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp</span>
<a name="line-285"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"  Actual type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>]</span>
<a name="line-286"></a>
<a name="line-287"></a><span class='hs-definition'>mkExpectedActualMsg</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkExprectedAcutalMsg"</span>
<a name="line-288"></a>
<a name="line-289"></a><a name="sameOccExtra"></a><span class='hs-definition'>sameOccExtra</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-290"></a><span class='hs-comment'>-- See Note [Disambiguating (X ~ X) errors]</span>
<a name="line-291"></a><span class='hs-definition'>sameOccExtra</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-292"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-293"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-294"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc1</span>
<a name="line-295"></a>        <span class='hs-varid'>n2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc2</span>
<a name="line-296"></a>        <span class='hs-varid'>same_occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n1</span>                  <span class='hs-varop'>==</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n2</span>
<a name="line-297"></a>        <span class='hs-varid'>same_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>
<a name="line-298"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n2</span>   <span class='hs-comment'>-- Different Names</span>
<a name="line-299"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>same_occ</span>   <span class='hs-comment'>-- but same OccName</span>
<a name="line-300"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"NB:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_from</span> <span class='hs-varid'>same_pkg</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr_from</span> <span class='hs-varid'>same_pkg</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>
<a name="line-301"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-302"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-303"></a>  <span class='hs-keyword'>where</span>
<a name="line-304"></a>    <span class='hs-varid'>ppr_from</span> <span class='hs-varid'>same_pkg</span> <span class='hs-varid'>nm</span>
<a name="line-305"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGoodSrcSpan</span> <span class='hs-varid'>loc</span>
<a name="line-306"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is defined at"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-307"></a>           <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-308"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Imported things have an UnhelpfulSrcSpan</span>
<a name="line-309"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-310"></a>           <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is defined in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-311"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>same_pkg</span> <span class='hs-varop'>||</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mainPackageId</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-312"></a>                    <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in package"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-313"></a>       <span class='hs-keyword'>where</span>
<a name="line-314"></a>         <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span>
<a name="line-315"></a>         <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>nm</span>
<a name="line-316"></a>         <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>nm</span>
</pre>\end{code}

Note [Disambiguating (X ~ X) errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See Trac #8278

Note [Reporting occurs-check errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given (a ~ [a]), if 'a' is a rigid type variable bound by a user-supplied
type signature, then the best thing is to report that we can't unify
a with [a], because a is a skolem variable.  That avoids the confusing
"occur-check" error message.

But nowadays when inferring the type of a function with no type signature,
even if there are errors inside, we still generalise its signature and
carry on. For example
   f x = x:x
Here we will infer somethiing like
   f :: forall a. a -> [a]
with a suspended error of (a ~ [a]).  So 'a' is now a skolem, but not
one bound by the programmer!  Here we really should report an occurs check.

So isUserSkolem distinguishes the two.

Note [Non-injective type functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very confusing to get a message like
     Couldn't match expected type `Depend s'
            against inferred type `Depend s1'
so mkTyFunInfoMsg adds:
       NB: `Depend' is type function, and hence may not be injective

Warn of loopy local equalities that were dropped.


%************************************************************************
%*									*
                 Type-class errors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkDictErr"></a><span class='hs-definition'>mkDictErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-2"></a><span class='hs-definition'>mkDictErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lookups</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_cls_inst</span> <span class='hs-varid'>inst_envs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_inst_cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>overlap_cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>is_no_inst</span> <span class='hs-varid'>lookups</span>
<a name="line-7"></a>
<a name="line-8"></a>       <span class='hs-comment'>-- Report definite no-instance errors, </span>
<a name="line-9"></a>       <span class='hs-comment'>-- or (iff there are none) overlap errors</span>
<a name="line-10"></a>       <span class='hs-comment'>-- But we report only one of them (hence 'head') because they all</span>
<a name="line-11"></a>       <span class='hs-comment'>-- have the same source-location origin, to try avoid a cascade</span>
<a name="line-12"></a>       <span class='hs-comment'>-- of error from one location</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_dict_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_inst_cts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>overlap_cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct1</span> <span class='hs-varid'>err</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>ct1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elim_superclasses</span> <span class='hs-varid'>cts</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>no_givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>is_no_inst</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>no_givens</span>
<a name="line-22"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matches</span>
<a name="line-23"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span> <span class='hs-varop'>||</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isAmbiguousTyVar</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>lookup_cls_inst</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>ct</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_flat</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>tys</span>
<a name="line-27"></a>                <span class='hs-comment'>-- Note [Flattening in error message generation]</span>
<a name="line-28"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys_flat</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>      <span class='hs-keyword'>where</span>
<a name="line-30"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getClassPredTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-comment'>-- When simplifying [W] Ord (Set a), we need</span>
<a name="line-34"></a>    <span class='hs-comment'>--    [W] Eq a, [W] Ord a</span>
<a name="line-35"></a>    <span class='hs-comment'>-- but we really only want to report the latter</span>
<a name="line-36"></a>    <span class='hs-varid'>elim_superclasses</span> <span class='hs-varid'>cts</span>
<a name="line-37"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>min_preds</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-38"></a>      <span class='hs-keyword'>where</span>
<a name="line-39"></a>        <span class='hs-varid'>min_preds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMinimalBySCs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="mk_dict_err"></a><span class='hs-definition'>mk_dict_err</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsInstLookupResult</span><span class='hs-layout'>)</span>
<a name="line-42"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-comment'>-- Report an overlap error if this class constraint results</span>
<a name="line-44"></a><span class='hs-comment'>-- from an overlap (returning Left clas), otherwise return (Right pred)</span>
<a name="line-45"></a><span class='hs-definition'>mk_dict_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>,</span> <span class='hs-varid'>safe_haskell</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matches</span>  <span class='hs-comment'>-- No matches but perhaps several unifiers</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_ambig</span><span class='hs-layout'>,</span> <span class='hs-varid'>ambig_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAmbigMsg</span> <span class='hs-varid'>ct</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>relevantBindings</span> <span class='hs-conid'>True</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"mk_dict_err"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>is_ambig</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ambig_msg</span><span class='hs-layout'>)</span>
<a name="line-50"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGlobalRdrEnv</span>
<a name="line-51"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>cannot_resolve_msg</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>is_ambig</span> <span class='hs-varid'>binds_msg</span> <span class='hs-varid'>ambig_msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>safe_haskell</span>   <span class='hs-comment'>-- Some matches =&gt; overlap errors</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>overlap_msg</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>safe_haskell_msg</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>orig</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-60"></a>    <span class='hs-varid'>pred</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span>
<a name="line-61"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getClassPredTys</span> <span class='hs-varid'>pred</span>
<a name="line-62"></a>    <span class='hs-varid'>ispecs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a>    <span class='hs-varid'>givens</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-64"></a>    <span class='hs-varid'>all_tyvars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>tys</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>cannot_resolve_msg</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>has_ambig_tvs</span> <span class='hs-varid'>binds_msg</span> <span class='hs-varid'>ambig_msg</span>
<a name="line-67"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_inst_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>coercible_explanation</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span>
<a name="line-68"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span>
<a name="line-69"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>has_ambig_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ambig_msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds_msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>potential_msg</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-71"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>show_fixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_to_ctxt_fixes</span> <span class='hs-varid'>has_ambig_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>drv_fixes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-varid'>potential_msg</span>
<a name="line-74"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>want_potential</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-75"></a>        <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>unifiers</span> 
<a name="line-76"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Note: there is a potential instance available:"</span><span class='hs-layout'>)</span>
<a name="line-77"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Note: there are several potential instances:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-78"></a>    	   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_insts</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-comment'>-- Report "potential instances" only when the constraint arises</span>
<a name="line-81"></a>    <span class='hs-comment'>-- directly from the user's use of an overloaded function</span>
<a name="line-82"></a>    <span class='hs-varid'>want_potential</span> <span class='hs-layout'>(</span><span class='hs-conid'>AmbigOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-83"></a>    <span class='hs-varid'>want_potential</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-84"></a>
<a name="line-85"></a>    <span class='hs-varid'>add_to_ctxt_fixes</span> <span class='hs-varid'>has_ambig_tvs</span>
<a name="line-86"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>has_ambig_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all_tyvars</span>
<a name="line-87"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>orig</span><span class='hs-conop'>:</span><span class='hs-varid'>origs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>get_good_orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-88"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"add"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>pred</span>
<a name="line-89"></a>               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to the context of"</span><span class='hs-layout'>)</span>
<a name="line-90"></a>	     <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>orig</span> <span class='hs-varop'>$$</span> 
<a name="line-91"></a>                        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>orig</span> 
<a name="line-92"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>origs</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-93"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-94"></a>
<a name="line-95"></a>    <span class='hs-varid'>ppr_skol</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSkol</span> <span class='hs-varid'>dc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-96"></a>    <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>skol_info</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span>
<a name="line-97"></a>
<a name="line-98"></a>	<span class='hs-comment'>-- Do not suggest adding constraints to an *inferred* type signature!</span>
<a name="line-99"></a>    <span class='hs-varid'>get_good_orig</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ic_info</span> <span class='hs-varid'>ic</span> <span class='hs-keyword'>of</span> 
<a name="line-100"></a>                         <span class='hs-conid'>SigSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-101"></a>                         <span class='hs-varid'>origin</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>origin</span>
<a name="line-102"></a>
<a name="line-103"></a>    <span class='hs-varid'>no_inst_msg</span>
<a name="line-104"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>==</span> <span class='hs-varid'>coercibleClass</span>
<a name="line-105"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEqPredTys</span> <span class='hs-varid'>pred</span>
<a name="line-106"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Could not coerce from"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-107"></a>           <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-108"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matches</span>
<a name="line-109"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No instance for"</span><span class='hs-layout'>)</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>pred</span>
<a name="line-110"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-111"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Could not deduce"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>pred</span>
<a name="line-112"></a>
<a name="line-113"></a>    <span class='hs-varid'>drv_fixes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>orig</span> <span class='hs-keyword'>of</span>
<a name="line-114"></a>                   <span class='hs-conid'>DerivOrigin</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>drv_fix</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a>                   <span class='hs-conid'>DerivOriginDC</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>drv_fix</span><span class='hs-keyglyph'>]</span>
<a name="line-116"></a>                   <span class='hs-conid'>DerivOriginCoerce</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>drv_fix</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a>                   <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-118"></a>
<a name="line-119"></a>    <span class='hs-varid'>drv_fix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"use a standalone 'deriving instance' declaration,"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-120"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"so you can specify the instance context yourself"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a>    <span class='hs-comment'>-- Normal overlap error</span>
<a name="line-123"></a>    <span class='hs-varid'>overlap_msg</span>
<a name="line-124"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-125"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>	<span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Overlapping instances for"</span><span class='hs-layout'>)</span> 
<a name="line-126"></a>				<span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-127"></a>
<a name="line-128"></a>             <span class='hs-layout'>,</span>  <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-129"></a>                  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Matching givens (or their superclasses):"</span><span class='hs-layout'>)</span> 
<a name="line-130"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-131"></a>
<a name="line-132"></a>    	     <span class='hs-layout'>,</span>	<span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Matching instances:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-133"></a>    		     <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprInstances</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprInstances</span> <span class='hs-varid'>unifiers</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-134"></a>
<a name="line-135"></a>             <span class='hs-layout'>,</span>  <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matching_givens</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-136"></a>                <span class='hs-comment'>-- Intuitively, some given matched the wanted in their</span>
<a name="line-137"></a>                <span class='hs-comment'>-- flattened or rewritten (from given equalities) form</span>
<a name="line-138"></a>                <span class='hs-comment'>-- but the matcher can't figure that out because the</span>
<a name="line-139"></a>                <span class='hs-comment'>-- constraints are non-flat and non-rewritten so we</span>
<a name="line-140"></a>                <span class='hs-comment'>-- simply report back the whole given</span>
<a name="line-141"></a>                <span class='hs-comment'>-- context. Accelerate Smart.hs showed this problem.</span>
<a name="line-142"></a>                  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"There exists a (perhaps superclass) match:"</span><span class='hs-layout'>)</span> 
<a name="line-143"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-144"></a>
<a name="line-145"></a>	     <span class='hs-layout'>,</span>	<span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSingleton</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-146"></a>		<span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The choice depends on the instantiation of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-147"></a>	    		          <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-148"></a>			     <span class='hs-layout'>,</span> <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-149"></a>                               <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To pick the first instance above, use IncoherentInstances"</span><span class='hs-layout'>)</span>
<a name="line-150"></a>			            <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"when compiling the other instance declarations"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-151"></a>                        <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-152"></a>        <span class='hs-keyword'>where</span>
<a name="line-153"></a>            <span class='hs-varid'>ispecs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span><span class='hs-keyglyph'>]</span>
<a name="line-154"></a>
<a name="line-155"></a>            <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-156"></a>            <span class='hs-varid'>matching_givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>matchable</span> <span class='hs-varid'>givens</span>
<a name="line-157"></a>
<a name="line-158"></a>            <span class='hs-varid'>matchable</span> <span class='hs-layout'>(</span><span class='hs-varid'>evvars</span><span class='hs-layout'>,</span><span class='hs-varid'>skol_info</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span> 
<a name="line-159"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ev_vars_matching</span> <span class='hs-keyword'>of</span>
<a name="line-160"></a>                     <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-161"></a>                     <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-varid'>ev_vars_matching</span><span class='hs-layout'>)</span>
<a name="line-162"></a>                                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span>
<a name="line-163"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-164"></a>                <span class='hs-keyword'>where</span> <span class='hs-varid'>ev_vars_matching</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>ev_var_matches</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>evvars</span><span class='hs-layout'>)</span>
<a name="line-165"></a>                      <span class='hs-varid'>ev_var_matches</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-166"></a>                         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-167"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>clas'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>clas</span>
<a name="line-168"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys'</span>
<a name="line-169"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> 
<a name="line-170"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-171"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>ev_var_matches</span> <span class='hs-layout'>(</span><span class='hs-varid'>immSuperClasses</span> <span class='hs-varid'>clas'</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-172"></a>                         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-173"></a>
<a name="line-174"></a>    <span class='hs-comment'>-- Overlap error because of Safe Haskell (first </span>
<a name="line-175"></a>    <span class='hs-comment'>-- match should be the most specific match)</span>
<a name="line-176"></a>    <span class='hs-varid'>safe_haskell_msg</span>
<a name="line-177"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>1</span> <span class='hs-layout'>)</span>
<a name="line-178"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unsafe overlapping instances for"</span><span class='hs-layout'>)</span> 
<a name="line-179"></a>                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-180"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The matching instance is:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-181"></a>                    <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprInstance</span> <span class='hs-varop'>$</span> <span class='hs-varid'>head</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-182"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"It is compiled in a Safe module and as such can only"</span>
<a name="line-183"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"overlap instances from the same module, however it"</span>
<a name="line-184"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"overlaps the following instances from different modules:"</span>
<a name="line-185"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprInstances</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>ispecs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-186"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-187"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-188"></a>
<a name="line-189"></a>    <span class='hs-comment'>-- This function tries to reconstruct why a "Coercible ty1 ty2" constraint</span>
<a name="line-190"></a>    <span class='hs-comment'>-- is left over. Therefore its logic has to stay in sync with</span>
<a name="line-191"></a>    <span class='hs-comment'>-- getCoericbleInst in TcInteract. See Note [Coercible Instances]</span>
<a name="line-192"></a>    <span class='hs-varid'>coercible_explanation</span> <span class='hs-varid'>rdr_env</span>
<a name="line-193"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>coercibleClass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-194"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span><span class='hs-varid'>tyArgs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span>
<a name="line-195"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span><span class='hs-varid'>tyArgs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span>
<a name="line-196"></a>        <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-197"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-varop'>$</span>
<a name="line-198"></a>          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"because the"</span><span class='hs-layout'>,</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"type argument"</span><span class='hs-keyglyph'>]</span>
<a name="line-199"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"of"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"has role Nominal,"</span><span class='hs-keyglyph'>]</span>
<a name="line-200"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"but the arguments"</span>
<a name="line-201"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>
<a name="line-202"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span>
<a name="line-203"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-204"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"differ"</span> <span class='hs-keyglyph'>]</span>
<a name="line-205"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip4</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyArgs1</span> <span class='hs-varid'>tyArgs2</span>
<a name="line-206"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-207"></a>          <span class='hs-keyglyph'>]</span>
<a name="line-208"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span>
<a name="line-209"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercible_msg_for_tycon</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span>
<a name="line-210"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span>
<a name="line-211"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span>
<a name="line-212"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercible_msg_for_tycon</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span>
<a name="line-213"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span>
<a name="line-214"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-215"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"because"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-216"></a>                        <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-217"></a>                        <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"are different types."</span> <span class='hs-keyglyph'>]</span>
<a name="line-218"></a>      <span class='hs-keyword'>where</span>
<a name="line-219"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEqPredTys</span> <span class='hs-varid'>pred</span>
<a name="line-220"></a>
<a name="line-221"></a>    <span class='hs-varid'>dataConMissing</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span>
<a name="line-222"></a>        <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookupGRE_Name</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>dataConName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-223"></a>
<a name="line-224"></a>    <span class='hs-varid'>coercible_msg_for_tycon</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span>
<a name="line-225"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-226"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAbstractMsg</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>empty</span>
<a name="line-227"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-228"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-229"></a>
<a name="line-230"></a>    <span class='hs-varid'>tyConAbstractMsg</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>occExpl</span>
<a name="line-231"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>dataConMissing</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-varop'>$</span>
<a name="line-232"></a>            <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"because the type constructor"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>occExpl</span>
<a name="line-233"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"is abstract"</span> <span class='hs-keyglyph'>]</span>
<a name="line-234"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-235"></a>            <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-236"></a>            <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"because the constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-237"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>occExpl</span>
<a name="line-238"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>isOrAre</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"not imported"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-239"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dataConMissing</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>tc</span>
<a name="line-240"></a>            <span class='hs-keyglyph'>]</span>
<a name="line-241"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="show_fixes"></a><span class='hs-definition'>show_fixes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-244"></a><span class='hs-definition'>show_fixes</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-245"></a><span class='hs-definition'>show_fixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-conop'>:</span><span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible fix:"</span><span class='hs-layout'>)</span>
<a name="line-246"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="ppr_insts"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-249"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-varid'>insts</span>
<a name="line-250"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprInstances</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-num'>3</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>dot_dot_message</span>
<a name="line-251"></a>  <span class='hs-keyword'>where</span>
<a name="line-252"></a>    <span class='hs-varid'>n_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>insts</span> <span class='hs-comment'>-</span> <span class='hs-num'>3</span>
<a name="line-253"></a>    <span class='hs-varid'>dot_dot_message</span> 
<a name="line-254"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_extra</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-255"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"...plus"</span><span class='hs-layout'>)</span> 
<a name="line-256"></a>                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNOf</span> <span class='hs-varid'>n_extra</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"other"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-257"></a>
<a name="line-258"></a><a name="quickFlattenTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-259"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-260"></a><span class='hs-comment'>-- See Note [Flattening in error message generation]</span>
<a name="line-261"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty'</span>
<a name="line-262"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-263"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>     <span class='hs-comment'>-- See</span>
<a name="line-264"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-265"></a>  <span class='hs-comment'>-- Don't flatten because of the danger or removing a bound variable</span>
<a name="line-266"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fy1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty1</span>
<a name="line-267"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>fy2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty2</span>
<a name="line-268"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fy1</span> <span class='hs-varid'>fy2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-269"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fy1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty1</span>
<a name="line-270"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>fy2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty2</span>
<a name="line-271"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>fy1</span> <span class='hs-varid'>fy2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-272"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-273"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-274"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>tys</span> 
<a name="line-275"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>fys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-276"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-277"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>funtys</span><span class='hs-layout'>,</span><span class='hs-varid'>resttys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-278"></a>                <span class='hs-comment'>-- Ignore the arguments of the type family funtys</span>
<a name="line-279"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVar</span> <span class='hs-conid'>TauTv</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>funtys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-280"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>flat_resttys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>resttys</span>
<a name="line-281"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-conid'>AppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>flat_resttys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Flattening in error message generation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (C (Maybe (F x))), where F is a type function, and we have
instances
                C (Maybe Int) and C (Maybe a)
Since (F x) might turn into Int, this is an overlap situation, and
indeed (because of flattening) the main solver will have refrained
from solving.  But by the time we get to error message generation, we've
un-flattened the constraint.  So we must *re*-flatten it before looking
up in the instance environment, lest we only report one matching
instance when in fact there are two.

Re-flattening is pretty easy, because we don't need to keep track of
evidence.  We don't re-use the code in TcCanonical because that's in
the TcS monad, and we are in TcM here.

Note [Quick-flatten polytypes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see C (Ix a => blah) or C (forall a. blah) we simply refrain from
flattening any further.  After all, there can be no instance declarations
that match such things.  And flattening under a for-all is problematic
anyway; consider C (forall a. F a)

\begin{code}
<pre><a name="line-1"></a><a name="mkAmbigMsg"></a><span class='hs-definition'>mkAmbigMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>mkAmbigMsg</span> <span class='hs-varid'>ct</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varid'>ambig_tv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-varid'>ambig_tv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isAmbiguousTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-7"></a>    <span class='hs-varid'>ambig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>ambig_tv_set</span>
<a name="line-8"></a>    
<a name="line-9"></a>    <span class='hs-varid'>is_or_are</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>ambig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is"</span>
<a name="line-10"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"are"</span>
<a name="line-11"></a>                 
<a name="line-12"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isRuntimeUnkSkol</span> <span class='hs-varid'>ambig_tvs</span>  <span class='hs-comment'>-- See Note [Runtime skolems]</span>
<a name="line-13"></a>        <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot resolve unknown runtime type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-14"></a>                     <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-15"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use :print or :force to determine these types"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-17"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The type variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-18"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-19"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>is_or_are</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ambiguous"</span> <span class='hs-keyglyph'>]</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="pprSkol"></a><span class='hs-definition'>pprSkol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-22"></a><span class='hs-definition'>pprSkol</span> <span class='hs-conid'>UnkSkol</span>   <span class='hs-keyword'>_</span> 
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an unknown type variable"</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>pprSkol</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>tv_loc</span> 
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a rigid type variable bound by"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-26"></a>          <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_loc</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="getSkolemInfo"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-29"></a><span class='hs-comment'>-- Get the skolem info for a type variable </span>
<a name="line-30"></a><span class='hs-comment'>-- from the implication constraint that binds it</span>
<a name="line-31"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tv</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"No skolem info:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>ic_skols</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_info</span> <span class='hs-varid'>implic</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSkolemInfo</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>tv</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-comment'>-----------------------</span>
<a name="line-39"></a><span class='hs-comment'>-- relevantBindings looks at the value environment and finds values whose</span>
<a name="line-40"></a><span class='hs-comment'>-- types mention any of the offending type variables.  It has to be</span>
<a name="line-41"></a><span class='hs-comment'>-- careful to zonk the Id's type first, so it has to be in the monad.</span>
<a name="line-42"></a><span class='hs-comment'>-- We must be careful to pass it a zonked type variable, too.</span>
<a name="line-43"></a><span class='hs-comment'>--</span>
<a name="line-44"></a><span class='hs-comment'>-- We always remove closed top-level bindings, though, </span>
<a name="line-45"></a><span class='hs-comment'>-- since they are never relevant (cf Trac #8233)</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="relevantBindings"></a><span class='hs-definition'>relevantBindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- True &lt;=&gt; filter by tyvar; False &lt;=&gt; no filtering</span>
<a name="line-48"></a>                          <span class='hs-comment'>-- See Trac #8191</span>
<a name="line-49"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-50"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-definition'>relevantBindings</span> <span class='hs-varid'>want_filtering</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>,</span> <span class='hs-varid'>discards</span><span class='hs-layout'>)</span> 
<a name="line-54"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>maxRelevantBinds</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> 
<a name="line-55"></a>                    <span class='hs-varid'>emptyVarSet</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>False</span>
<a name="line-56"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>tcl_bndrs</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span>
<a name="line-57"></a>         <span class='hs-comment'>-- tcl_bndrs has the innermost bindings first, </span>
<a name="line-58"></a>         <span class='hs-comment'>-- which are probably the most relevant ones</span>
<a name="line-59"></a>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"relevantBindings"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcl_bndrs</span> <span class='hs-varid'>lcl_env</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Relevant bindings include"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-62"></a>                      <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>docs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>max_msg</span><span class='hs-layout'>)</span>
<a name="line-63"></a>             <span class='hs-varid'>max_msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>discards</span> 
<a name="line-64"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(Some bindings suppressed; use -fmax-relevant-binds=N or -fno-max-relevant-binds)"</span><span class='hs-layout'>)</span>
<a name="line-65"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-66"></a>
<a name="line-67"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>docs</span> 
<a name="line-68"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-69"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"rb"</span> <span class='hs-varid'>doc</span>
<a name="line-70"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_env'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> 
<a name="line-71"></a>  <span class='hs-keyword'>where</span>
<a name="line-72"></a>    <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-73"></a>    <span class='hs-varid'>ct_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfCt</span> <span class='hs-varid'>ct</span>
<a name="line-74"></a>
<a name="line-75"></a>    <span class='hs-varid'>run_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-76"></a>    <span class='hs-varid'>run_out</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-77"></a>    <span class='hs-varid'>run_out</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-varid'>dec_max</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span>
<a name="line-80"></a>    <span class='hs-varid'>dec_max</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> 
<a name="line-83"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                          <span class='hs-comment'>-- True &lt;=&gt; some filtered out due to lack of fuel</span>
<a name="line-84"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdBinder</span><span class='hs-keyglyph'>]</span> 
<a name="line-85"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- The bool says if we filtered any out</span>
<a name="line-86"></a>                                        <span class='hs-comment'>-- because of lack of fuel</span>
<a name="line-87"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>docs</span> <span class='hs-varid'>discards</span> <span class='hs-conid'>[]</span>
<a name="line-88"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>docs</span><span class='hs-layout'>,</span> <span class='hs-varid'>discards</span><span class='hs-layout'>)</span>
<a name="line-89"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>n_left</span> <span class='hs-varid'>tvs_seen</span> <span class='hs-varid'>docs</span> <span class='hs-varid'>discards</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcIdBndr</span> <span class='hs-varid'>id</span> <span class='hs-varid'>top_lvl</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tc_bndrs</span><span class='hs-layout'>)</span>
<a name="line-90"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-91"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>id_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-92"></a>                  <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-93"></a>		            <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound at"</span><span class='hs-layout'>)</span>
<a name="line-94"></a>			    	 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-95"></a>                  <span class='hs-varid'>new_seen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs_seen</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>id_tvs</span>
<a name="line-96"></a>
<a name="line-97"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>want_filtering</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>id_tvs</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>ct_tvs</span><span class='hs-layout'>)</span>
<a name="line-98"></a>                       <span class='hs-comment'>-- We want to filter out this binding anyway</span>
<a name="line-99"></a>                       <span class='hs-comment'>-- so discard it silently</span>
<a name="line-100"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>n_left</span> <span class='hs-varid'>tvs_seen</span> <span class='hs-varid'>docs</span> <span class='hs-varid'>discards</span> <span class='hs-varid'>tc_bndrs</span>
<a name="line-101"></a>
<a name="line-102"></a>              <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNothing</span> <span class='hs-varid'>n_left</span><span class='hs-layout'>)</span>
<a name="line-103"></a>                       <span class='hs-comment'>-- It's a top-level binding and we have not specified</span>
<a name="line-104"></a>                       <span class='hs-comment'>-- -fno-max-relevant-bindings, so discard it silently</span>
<a name="line-105"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>n_left</span> <span class='hs-varid'>tvs_seen</span> <span class='hs-varid'>docs</span> <span class='hs-varid'>discards</span> <span class='hs-varid'>tc_bndrs</span>
<a name="line-106"></a>
<a name="line-107"></a>              <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>run_out</span> <span class='hs-varid'>n_left</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>id_tvs</span> <span class='hs-varop'>`subVarSet`</span> <span class='hs-varid'>tvs_seen</span>
<a name="line-108"></a>                       <span class='hs-comment'>-- We've run out of n_left fuel and this binding only</span>
<a name="line-109"></a>                       <span class='hs-comment'>-- mentions aleady-seen type variables, so discard it</span>
<a name="line-110"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>n_left</span> <span class='hs-varid'>tvs_seen</span> <span class='hs-varid'>docs</span> <span class='hs-conid'>True</span> <span class='hs-varid'>tc_bndrs</span>
<a name="line-111"></a>
<a name="line-112"></a>                       <span class='hs-comment'>-- Keep this binding, decrement fuel</span>
<a name="line-113"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env'</span> <span class='hs-layout'>(</span><span class='hs-varid'>dec_max</span> <span class='hs-varid'>n_left</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_seen</span> <span class='hs-layout'>(</span><span class='hs-varid'>doc</span><span class='hs-conop'>:</span><span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-varid'>discards</span> <span class='hs-varid'>tc_bndrs</span> <span class='hs-layout'>}</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="warnDefaulting"></a><span class='hs-comment'>-----------------------</span>
<a name="line-116"></a><span class='hs-definition'>warnDefaulting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-117"></a><span class='hs-definition'>warnDefaulting</span> <span class='hs-varid'>wanteds</span> <span class='hs-varid'>default_ty</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warn_default</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnTypeDefaults</span>
<a name="line-119"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-120"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-varop'>$</span>
<a name="line-121"></a>                        <span class='hs-varid'>tyVarsOfCts</span> <span class='hs-varid'>wanteds</span>
<a name="line-122"></a>             <span class='hs-varid'>tidy_wanteds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>wanteds</span>
<a name="line-123"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_wanteds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprWithArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>tidy_wanteds</span><span class='hs-layout'>)</span>
<a name="line-124"></a>             <span class='hs-varid'>warn_msg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Defaulting the following constraint(s) to type"</span><span class='hs-layout'>)</span>
<a name="line-125"></a>                                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>default_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-126"></a>                            <span class='hs-num'>2</span> <span class='hs-varid'>ppr_wanteds</span>
<a name="line-127"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>warnTc</span> <span class='hs-varid'>warn_default</span> <span class='hs-varid'>warn_msg</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Runtime skolems]
~~~~~~~~~~~~~~~~~~~~~~
We want to give a reasonably helpful error message for ambiguity
arising from *runtime* skolems in the debugger.  These
are created by in RtClosureInspect.zonkRTTIType.  

%************************************************************************
%*									*
                 Error from the canonicaliser
	 These ones are called *during* constraint simplification
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="solverDepthErrorTcS"></a><span class='hs-definition'>solverDepthErrorTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>solverDepthErrorTcS</span> <span class='hs-varid'>cnt</span> <span class='hs-varid'>ev</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-7"></a>             <span class='hs-varid'>tidy_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>pred</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varid'>cnt</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_pred</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>loc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-varid'>ev</span>
<a name="line-11"></a>    <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocDepth</span> <span class='hs-varid'>loc</span>
<a name="line-12"></a>    <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subGoalCounterValue</span> <span class='hs-varid'>cnt</span> <span class='hs-varid'>depth</span>
<a name="line-13"></a>    <span class='hs-varid'>msg</span> <span class='hs-conid'>CountConstraints</span> <span class='hs-keyglyph'>=</span>
<a name="line-14"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Context reduction stack overflow; size ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>value</span>
<a name="line-15"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -fcontext-stack=N to increase stack size to N"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-16"></a>    <span class='hs-varid'>msg</span> <span class='hs-conid'>CountTyFunApps</span> <span class='hs-keyglyph'>=</span>
<a name="line-17"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type function application stack overflow; size ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>value</span>
<a name="line-18"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -ftype-function-depth=N to increase stack size to N"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*									*
                 Tidying
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkTidyTcType"></a><span class='hs-definition'>zonkTidyTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>zonkTidyTcType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="zonkTidyOrigin"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>skol_info</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>skol_info1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSkolemInfo</span> <span class='hs-varid'>skol_info</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>skol_info2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidySkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>skol_info1</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env1</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>skol_info2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>act'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env1</span>            <span class='hs-varid'>exp</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env2</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>                <span class='hs-layout'>,</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act'</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-15"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env1</span>            <span class='hs-varid'>ty2</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt2</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt2</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span> <span class='hs-varid'>orig'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
