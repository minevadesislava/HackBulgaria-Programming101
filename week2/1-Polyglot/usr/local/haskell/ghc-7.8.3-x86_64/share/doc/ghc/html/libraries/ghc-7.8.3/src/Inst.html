<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/Inst.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

The @Inst@ type: dictionaries or method instances

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Inst</span> <span class='hs-layout'>(</span> 
<a name="line-9"></a>       <span class='hs-varid'>deeplySkolemise</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>       <span class='hs-varid'>deeplyInstantiate</span><span class='hs-layout'>,</span> <span class='hs-varid'>instCall</span><span class='hs-layout'>,</span> <span class='hs-varid'>instStupidTheta</span><span class='hs-layout'>,</span>
<a name="line-11"></a>       <span class='hs-varid'>emitWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitWanteds</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>       <span class='hs-varid'>newOverloadedLit</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOverLit</span><span class='hs-layout'>,</span> 
<a name="line-14"></a>     
<a name="line-15"></a>       <span class='hs-varid'>tcGetInsts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getOverlapFlag</span><span class='hs-layout'>,</span>
<a name="line-16"></a>       <span class='hs-varid'>tcExtendLocalInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>instCallConstraints</span><span class='hs-layout'>,</span> <span class='hs-varid'>newMethodFromName</span><span class='hs-layout'>,</span>
<a name="line-17"></a>       <span class='hs-varid'>tcSyntaxName</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>       <span class='hs-comment'>-- Simple functions over evidence variables</span>
<a name="line-20"></a>       <span class='hs-varid'>tyVarsOfWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfBag</span><span class='hs-layout'>,</span> 
<a name="line-21"></a>       <span class='hs-varid'>tyVarsOfCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfCts</span><span class='hs-layout'>,</span> 
<a name="line-22"></a>
<a name="line-23"></a>       <span class='hs-varid'>tidyEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidySkolemInfo</span>
<a name="line-24"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>	<span class='hs-conid'>TcExpr</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcPolyExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>	<span class='hs-conid'>TcUnify</span><span class='hs-layout'>(</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FunDeps</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>varType</span><span class='hs-layout'>,</span> <span class='hs-varid'>setVarType</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-layout'>(</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
</pre>\end{code}



%************************************************************************
%*									*
		Emitting constraints
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="emitWanteds"></a><span class='hs-definition'>emitWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>emitWanteds</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>emitWanted</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="emitWanted"></a><span class='hs-definition'>emitWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-5"></a><span class='hs-definition'>emitWanted</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>pred</span> 
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLoc</span> <span class='hs-varid'>origin</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>pred</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitFlat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varop'>$</span>
<a name="line-9"></a>             <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="newMethodFromName"></a><span class='hs-definition'>newMethodFromName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-comment'>-- Used when Name is the wired-in name for a wired-in class method,</span>
<a name="line-14"></a><span class='hs-comment'>-- so the caller knows its type for sure, which should be of form</span>
<a name="line-15"></a><span class='hs-comment'>--    forall a. C a =&gt; &lt;blah&gt;</span>
<a name="line-16"></a><span class='hs-comment'>-- newMethodFromName is supposed to instantiate just the outer </span>
<a name="line-17"></a><span class='hs-comment'>-- type variable and constraint</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>newMethodFromName</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>name</span> <span class='hs-varid'>inst_ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>name</span>
<a name="line-21"></a> 	      <span class='hs-comment'>-- Use tcLookupId not tcLookupGlobalId; the method is almost</span>
<a name="line-22"></a>	      <span class='hs-comment'>-- always a class op, but with -XRebindableSyntax GHC is</span>
<a name="line-23"></a>	      <span class='hs-comment'>-- meant to find whatever thing is in scope, and that may</span>
<a name="line-24"></a>	      <span class='hs-comment'>-- be an ordinary function. </span>
<a name="line-25"></a>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-sel'>_caller_knows_this</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-27"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>the_tv</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-28"></a>             <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipOpenTvSubst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>the_tv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>rest</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>)</span>
<a name="line-31"></a>                 <span class='hs-varid'>instCall</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>wrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
	Deep instantiation and skolemisation
%*									*
%************************************************************************

Note [Deep skolemisation]
~~~~~~~~~~~~~~~~~~~~~~~~~
deeplySkolemise decomposes and skolemises a type, returning a type
with all its arrows visible (ie not buried under foralls)

Examples:

  deeplySkolemise (Int -> forall a. Ord a => blah)  
    =  ( wp, [a], [d:Ord a], Int -> blah )
    where wp = \x:Int. /\a. \(d:Ord a). <hole> x

  deeplySkolemise  (forall a. Ord a => Maybe a -> forall b. Eq b => blah)  
    =  ( wp, [a,b], [d1:Ord a,d2:Eq b], Maybe a -> blah )
    where wp = /\a.\(d1:Ord a).\(x:Maybe a)./\b.\(d2:Ord b). <hole> x

In general,
  if      deeplySkolemise ty = (wrap, tvs, evs, rho)
    and   e :: rho
  then    wrap e :: ty
    and   'wrap' binds tvs, evs

ToDo: this eta-abstraction plays fast and loose with termination,
      because it can introduce extra lambdas.  Maybe add a `seq` to
      fix this


\begin{code}
<pre><a name="line-1"></a><a name="deeplySkolemise"></a><span class='hs-definition'>deeplySkolemise</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>deeplySkolemise</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ids1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"dk"</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstSkolTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_vars1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_vars2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplySkolemise</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>ids1</span>
<a name="line-12"></a>                   <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpTyLams</span> <span class='hs-varid'>tvs1</span>
<a name="line-13"></a>                   <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>ev_vars1</span>
<a name="line-14"></a>                   <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span>
<a name="line-15"></a>                   <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>ids1</span>
<a name="line-16"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>tvs1</span>     <span class='hs-varop'>++</span> <span class='hs-varid'>tvs2</span>
<a name="line-17"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ev_vars1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ev_vars2</span>
<a name="line-18"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>rho</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="deeplyInstantiate"></a><span class='hs-definition'>deeplyInstantiate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-comment'>--   Int -&gt; forall a. a -&gt; a  ==&gt;  (\x:Int. [] x alpha) :: Int -&gt; alpha</span>
<a name="line-25"></a><span class='hs-comment'>-- In general if</span>
<a name="line-26"></a><span class='hs-comment'>-- if    deeplyInstantiate ty = (wrap, rho)</span>
<a name="line-27"></a><span class='hs-comment'>-- and   e :: ty</span>
<a name="line-28"></a><span class='hs-comment'>-- then  wrap e :: rho</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>deeplyInstantiate</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ids1</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"di"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrap1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplyInstantiate</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>ids1</span> 
<a name="line-37"></a>                    <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap2</span>
<a name="line-38"></a>                    <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap1</span> 
<a name="line-39"></a>                    <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>ids1</span><span class='hs-layout'>,</span>
<a name="line-40"></a>                 <span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>rho2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
            Instantiating a call
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="instCall"></a><span class='hs-comment'>----------------</span>
<a name="line-2"></a><span class='hs-definition'>instCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-3"></a><span class='hs-comment'>-- Instantiate the constraints of a call</span>
<a name="line-4"></a><span class='hs-comment'>--	(instCall o tys theta)</span>
<a name="line-5"></a><span class='hs-comment'>-- (a) Makes fresh dictionaries as necessary for the constraints (theta)</span>
<a name="line-6"></a><span class='hs-comment'>-- (b) Throws these dictionaries into the LIE</span>
<a name="line-7"></a><span class='hs-comment'>-- (c) Returns an HsWrapper ([.] tys dicts)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>instCall</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>theta</span> 
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>dict_app</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCallConstraints</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>theta</span>
<a name="line-11"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>dict_app</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpTyApps</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="instCallConstraints"></a><span class='hs-comment'>----------------</span>
<a name="line-14"></a><span class='hs-definition'>instCallConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-15"></a><span class='hs-comment'>-- Instantiates the TcTheta, puts all constraints thereby generated</span>
<a name="line-16"></a><span class='hs-comment'>-- into the LIE, and returns a HsWrapper to enclose the call site.</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>instCallConstraints</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>preds</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>preds</span> 
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>idHsWrapper</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>preds</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"instCallConstraints"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpEvApps</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>pred</span> 
<a name="line-27"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pred</span> <span class='hs-comment'>-- Try short-cut</span>
<a name="line-28"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-29"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-31"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitWanted</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>pred</span>
<a name="line-32"></a>     	  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>ev_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="instStupidTheta"></a><span class='hs-comment'>----------------</span>
<a name="line-35"></a><span class='hs-definition'>instStupidTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-36"></a><span class='hs-comment'>-- Similar to instCall, but only emit the constraints in the LIE</span>
<a name="line-37"></a><span class='hs-comment'>-- Used exclusively for the 'stupid theta' of a data constructor</span>
<a name="line-38"></a><span class='hs-definition'>instStupidTheta</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>theta</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-sel'>_co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCallConstraints</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>theta</span> <span class='hs-comment'>-- Discard the coercion</span>
<a name="line-40"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
		Literals
%*									*
%************************************************************************

In newOverloadedLit we convert directly to an Int or Integer if we
know that's what we want.  This may save some time, by not
temporarily generating overloaded literals, but it won't catch all
cases (the rest are caught in lookupInst).

\begin{code}
<pre><a name="line-1"></a><a name="newOverloadedLit"></a><span class='hs-definition'>newOverloadedLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>Name</span>
<a name="line-3"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-4"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>newOverloadedLit</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>lit</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-7"></a>         <span class='hs-varid'>newOverloadedLit'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>lit</span> <span class='hs-varid'>res_ty</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="newOverloadedLit'"></a><span class='hs-definition'>newOverloadedLit'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-10"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-11"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>Name</span>
<a name="line-12"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-13"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>newOverloadedLit'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>orig</span>
<a name="line-15"></a>  <span class='hs-varid'>lit</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>OverLit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ol_val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>val</span><span class='hs-layout'>,</span> <span class='hs-varid'>ol_rebindable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rebindable</span>
<a name="line-16"></a>	       <span class='hs-layout'>,</span> <span class='hs-varid'>ol_witness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>meth_name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>rebindable</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>shortCutLit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>val</span> <span class='hs-varid'>res_ty</span> 
<a name="line-20"></a>	<span class='hs-comment'>-- Do not generate a LitInst for rebindable syntax.  </span>
<a name="line-21"></a>	<span class='hs-comment'>-- Reason: If we do, tcSimplify will call lookupInst, which</span>
<a name="line-22"></a>	<span class='hs-comment'>--	   will call tcSyntaxName, which does unification, </span>
<a name="line-23"></a>	<span class='hs-comment'>--	   which tcSimplify doesn't like</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ol_witness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ol_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>hs_lit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOverLit</span> <span class='hs-varid'>val</span>
<a name="line-28"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lit_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLitType</span> <span class='hs-varid'>hs_lit</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>fi'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>meth_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>lit_ty</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-30"></a>	 	<span class='hs-comment'>-- Overloaded literals must have liftedTypeKind, because</span>
<a name="line-31"></a>	 	<span class='hs-comment'>-- we're instantiating an overloaded function here,</span>
<a name="line-32"></a>	 	<span class='hs-comment'>-- whereas res_ty might be openTypeKind. This was a bug in 6.2.2</span>
<a name="line-33"></a>		<span class='hs-comment'>-- However this'll be picked up by tcSyntaxOp if necessary</span>
<a name="line-34"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>witness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>fi'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>hs_lit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ol_witness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>witness</span><span class='hs-layout'>,</span> <span class='hs-varid'>ol_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="mkOverLit"></a><span class='hs-comment'>------------</span>
<a name="line-38"></a><span class='hs-definition'>mkOverLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OverLitVal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsLit</span>
<a name="line-39"></a><span class='hs-definition'>mkOverLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIntegral</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> 
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>integer_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>integerTyConName</span>
<a name="line-41"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsInteger</span> <span class='hs-varid'>i</span> <span class='hs-varid'>integer_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-definition'>mkOverLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFractional</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>rat_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>rationalTyConName</span>
<a name="line-45"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRat</span> <span class='hs-varid'>r</span> <span class='hs-varid'>rat_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-definition'>mkOverLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIsString</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsString</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
</pre>\end{code}




%************************************************************************
%*									*
		Re-mappable syntax
    
     Used only for arrow syntax -- find a way to nuke this
%*									*
%************************************************************************

Suppose we are doing the -XRebindableSyntax thing, and we encounter
a do-expression.  We have to find (>>) in the current environment, which is
done by the rename. Then we have to check that it has the same type as
Control.Monad.(>>).  Or, more precisely, a compatible type. One 'customer' had
this:

  (>>) :: HB m n mn => m a -> n b -> mn b

So the idea is to generate a local binding for (>>), thus:

	let then72 :: forall a b. m a -> m b -> m b
	    then72 = ...something involving the user's (>>)...
	in
	...the do-expression...

Now the do-expression can proceed using then72, which has exactly
the expected type.

In fact tcSyntaxName just generates the RHS for then72, because we only
want an actual binding in the do-expression case. For literals, we can 
just use the expression inline.

\begin{code}
<pre><a name="line-1"></a><a name="tcSyntaxName"></a><span class='hs-definition'>tcSyntaxName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>			<span class='hs-comment'>-- Type to instantiate it at</span>
<a name="line-3"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- (Standard name, user name)</span>
<a name="line-4"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- (Standard name, suitable expression)</span>
<a name="line-5"></a><span class='hs-comment'>-- USED ONLY FOR CmdTop (sigh) ***</span>
<a name="line-6"></a><span class='hs-comment'>-- See Note [CmdSyntaxTable] in HsExpr</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>tcSyntaxName</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>std_nm</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsVar</span> <span class='hs-varid'>user_nm</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>std_nm</span> <span class='hs-varop'>==</span> <span class='hs-varid'>user_nm</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMethodFromName</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>std_nm</span> <span class='hs-varid'>ty</span>
<a name="line-11"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>std_nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>tcSyntaxName</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>std_nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>user_nm_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-14"></a>    <span class='hs-varid'>std_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>std_nm</span>
<a name="line-15"></a>    <span class='hs-keyword'>let</span>	
<a name="line-16"></a>	<span class='hs-comment'>-- C.f. newMethodAtLoc</span>
<a name="line-17"></a>	<span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>std_id</span><span class='hs-layout'>)</span>
<a name="line-18"></a> 	<span class='hs-varid'>sigma1</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tau</span>
<a name="line-19"></a>	<span class='hs-comment'>-- Actually, the "tau-type" might be a sigma-type in the</span>
<a name="line-20"></a>	<span class='hs-comment'>-- case of locally-polymorphic methods.</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>syntaxNameCtxt</span> <span class='hs-varid'>user_nm_expr</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>sigma1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-23"></a>
<a name="line-24"></a>	<span class='hs-comment'>-- Check that the user-supplied thing has the</span>
<a name="line-25"></a>	<span class='hs-comment'>-- same type as the standard one.  </span>
<a name="line-26"></a>	<span class='hs-comment'>-- Tiresome jiggling because tcCheckSigma takes a located expression</span>
<a name="line-27"></a>     <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-28"></a>     <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>user_nm_expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigma1</span>
<a name="line-29"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>std_nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="syntaxNameCtxt"></a><span class='hs-definition'>syntaxNameCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-32"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-definition'>syntaxNameCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tidy_env</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLoc</span> <span class='hs-varid'>orig</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking that"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-36"></a>			  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(needed by a syntactic construct)"</span><span class='hs-layout'>)</span>
<a name="line-37"></a>		        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has the required type:"</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-39"></a>		        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArisingAt</span> <span class='hs-varid'>inst_loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
		Instances
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="getOverlapFlag"></a><span class='hs-definition'>getOverlapFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>OverlapFlag</span>
<a name="line-2"></a><span class='hs-definition'>getOverlapFlag</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-4"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>overlap_ok</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_OverlappingInstances</span> <span class='hs-varid'>dflags</span>
<a name="line-5"></a>              <span class='hs-varid'>incoherent_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_IncoherentInstances</span>  <span class='hs-varid'>dflags</span>
<a name="line-6"></a>              <span class='hs-varid'>safeOverlap</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safeLanguageOn</span> <span class='hs-varid'>dflags</span>
<a name="line-7"></a>              <span class='hs-varid'>overlap_flag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>incoherent_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Incoherent</span> <span class='hs-varid'>safeOverlap</span>
<a name="line-8"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>overlap_ok</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OverlapOk</span> <span class='hs-varid'>safeOverlap</span>
<a name="line-9"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoOverlap</span> <span class='hs-varid'>safeOverlap</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>overlap_flag</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="tcGetInstEnvs"></a><span class='hs-definition'>tcGetInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstEnv</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-comment'>-- Gets both the external-package inst-env</span>
<a name="line-15"></a><span class='hs-comment'>-- and the home-pkg inst env (includes module being compiled)</span>
<a name="line-16"></a><span class='hs-definition'>tcGetInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEps</span><span class='hs-layout'>;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>;</span>
<a name="line-17"></a>		     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcg_inst_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="tcGetInsts"></a><span class='hs-definition'>tcGetInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a><span class='hs-comment'>-- Gets the local class instances.</span>
<a name="line-21"></a><span class='hs-definition'>tcGetInsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_insts</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="tcExtendLocalInstEnv"></a><span class='hs-definition'>tcExtendLocalInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-24"></a>  <span class='hs-comment'>-- Add new locally-defined instances</span>
<a name="line-25"></a><span class='hs-definition'>tcExtendLocalInstEnv</span> <span class='hs-varid'>dfuns</span> <span class='hs-varid'>thing_inside</span>
<a name="line-26"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceDFuns</span> <span class='hs-varid'>dfuns</span>
<a name="line-27"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-28"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>inst_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>addLocalInst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_inst_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>dfuns</span>
<a name="line-29"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfuns</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tcg_insts</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span>
<a name="line-30"></a>			 <span class='hs-varid'>tcg_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_env'</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="addLocalInst"></a><span class='hs-definition'>addLocalInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>InstEnv</span>
<a name="line-34"></a><span class='hs-comment'>-- Check that the proposed new instance is OK, </span>
<a name="line-35"></a><span class='hs-comment'>-- and then add it to the home inst env</span>
<a name="line-36"></a><span class='hs-comment'>-- If overwrite_inst, then we can overwrite a direct match</span>
<a name="line-37"></a><span class='hs-definition'>addLocalInst</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>ispec</span>
<a name="line-38"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-39"></a>         <span class='hs-comment'>-- Instantiate the dfun type so that we extend the instance</span>
<a name="line-40"></a>         <span class='hs-comment'>-- envt with completely fresh template variables</span>
<a name="line-41"></a>         <span class='hs-comment'>-- This is important because the template variables must</span>
<a name="line-42"></a>         <span class='hs-comment'>-- not overlap with anything in the things being looked up</span>
<a name="line-43"></a>         <span class='hs-comment'>-- (since we do unification).  </span>
<a name="line-44"></a>             <span class='hs-comment'>--</span>
<a name="line-45"></a>             <span class='hs-comment'>-- We use tcInstSkolType because we don't want to allocate fresh</span>
<a name="line-46"></a>             <span class='hs-comment'>--  *meta* type variables.</span>
<a name="line-47"></a>             <span class='hs-comment'>--</span>
<a name="line-48"></a>             <span class='hs-comment'>-- We use UnkSkol --- and *not* InstSkol or PatSkol --- because</span>
<a name="line-49"></a>             <span class='hs-comment'>-- these variables must be bindable by tcUnifyTys.  See</span>
<a name="line-50"></a>             <span class='hs-comment'>-- the call to tcUnifyTys in InstEnv, and the special</span>
<a name="line-51"></a>             <span class='hs-comment'>-- treatment that instanceBindFun gives to isOverlappableTyVar</span>
<a name="line-52"></a>             <span class='hs-comment'>-- This is absurdly delicate.</span>
<a name="line-53"></a>
<a name="line-54"></a>             <span class='hs-comment'>-- Load imported instances, so that we report</span>
<a name="line-55"></a>             <span class='hs-comment'>-- duplicates correctly</span>
<a name="line-56"></a>           <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEps</span>
<a name="line-57"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_ie</span><span class='hs-layout'>)</span>
<a name="line-58"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceHead</span> <span class='hs-varid'>ispec</span>
<a name="line-59"></a>
<a name="line-60"></a>             <span class='hs-comment'>-- Check functional dependencies</span>
<a name="line-61"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkFunDeps</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>ispec</span> <span class='hs-keyword'>of</span>
<a name="line-62"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>specs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>funDepErr</span> <span class='hs-varid'>ispec</span> <span class='hs-varid'>specs</span>
<a name="line-63"></a>             <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-64"></a>
<a name="line-65"></a>             <span class='hs-comment'>-- Check for duplicate instance decls</span>
<a name="line-66"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-67"></a>               <span class='hs-varid'>dup_ispecs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>dup_ispec</span> 
<a name="line-68"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>dup_ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span>
<a name="line-69"></a>                            <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dup_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tys</span> <span class='hs-varid'>dup_ispec</span>
<a name="line-70"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>dup_tys</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-71"></a>                             
<a name="line-72"></a>             <span class='hs-comment'>-- Find memebers of the match list which ispec itself matches.</span>
<a name="line-73"></a>             <span class='hs-comment'>-- If the match is 2-way, it's a duplicate</span>
<a name="line-74"></a>             <span class='hs-comment'>-- If it's a duplicate, but we can overwrite home package dups, then overwrite</span>
<a name="line-75"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>isGHCi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getIsGHCi</span>
<a name="line-76"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>overlapFlag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getOverlapFlag</span>
<a name="line-77"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isGHCi</span> <span class='hs-keyword'>of</span>
<a name="line-78"></a>             <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dup_ispecs</span> <span class='hs-keyword'>of</span>
<a name="line-79"></a>                 <span class='hs-varid'>dup</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dupInstErr</span> <span class='hs-varid'>ispec</span> <span class='hs-varid'>dup</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInstEnv</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-80"></a>                 <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInstEnv</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-81"></a>             <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>dup_ispecs</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_ie_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifs</span><span class='hs-layout'>,</span> <span class='hs-varid'>overlapFlag</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-82"></a>                 <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>overwriteInstEnv</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-83"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>dup</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dupInstErr</span> <span class='hs-varid'>ispec</span> <span class='hs-varid'>dup</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInstEnv</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-84"></a>                 <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>u</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoOverlap</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>overlappingInstErr</span> <span class='hs-varid'>ispec</span> <span class='hs-varid'>u</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInstEnv</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                 <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInstEnv</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-86"></a>               <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>homematches</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInstEnv'</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-87"></a>                     <span class='hs-varid'>home_ie_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>dup_ispec</span> 
<a name="line-88"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>dup_ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>homematches</span>
<a name="line-89"></a>                         <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dup_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tys</span> <span class='hs-varid'>dup_ispec</span>
<a name="line-90"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>dup_tys</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="traceDFuns"></a><span class='hs-definition'>traceDFuns</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-93"></a><span class='hs-definition'>traceDFuns</span> <span class='hs-varid'>ispecs</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Adding instances:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-95"></a>  <span class='hs-keyword'>where</span>
<a name="line-96"></a>    <span class='hs-varid'>pp</span> <span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ispec</span>
<a name="line-97"></a>	<span class='hs-comment'>-- Print the dfun name itself too</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="funDepErr"></a><span class='hs-definition'>funDepErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-100"></a><span class='hs-definition'>funDepErr</span> <span class='hs-varid'>ispec</span> <span class='hs-varid'>ispecs</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addClsInstsErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Functional dependencies conflict between instance declarations:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>ispec</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="dupInstErr"></a><span class='hs-definition'>dupInstErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-105"></a><span class='hs-definition'>dupInstErr</span> <span class='hs-varid'>ispec</span> <span class='hs-varid'>dup_ispec</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addClsInstsErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate instance declarations:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-107"></a>	            <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-varid'>dup_ispec</span><span class='hs-keyglyph'>]</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="overlappingInstErr"></a><span class='hs-definition'>overlappingInstErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-110"></a><span class='hs-definition'>overlappingInstErr</span> <span class='hs-varid'>ispec</span> <span class='hs-varid'>dup_ispec</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addClsInstsErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Overlapping instance declarations:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-112"></a>                    <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-varid'>dup_ispec</span><span class='hs-keyglyph'>]</span>
<a name="line-113"></a>
<a name="line-114"></a><a name="addClsInstsErr"></a><span class='hs-definition'>addClsInstsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-115"></a><span class='hs-definition'>addClsInstsErr</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>ispecs</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>sorted</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-117"></a>    <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-varid'>herald</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprInstances</span> <span class='hs-varid'>sorted</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-118"></a> <span class='hs-keyword'>where</span>
<a name="line-119"></a>   <span class='hs-varid'>sorted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortWith</span> <span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>ispecs</span>
<a name="line-120"></a>   <span class='hs-comment'>-- The sortWith just arranges that instances are dislayed in order</span>
<a name="line-121"></a>   <span class='hs-comment'>-- of source location, which reduced wobbling in error messages,</span>
<a name="line-122"></a>   <span class='hs-comment'>-- and is better for users</span>
</pre>\end{code}

%************************************************************************
%*									*
	Simple functions over evidence variables
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tyVarsOfCt"></a><span class='hs-comment'>---------------- Getting free tyvars -------------------------</span>
<a name="line-2"></a><span class='hs-definition'>tyVarsOfCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-3"></a><span class='hs-comment'>-- NB: the </span>
<a name="line-4"></a><span class='hs-definition'>tyVarsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>xi</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-5"></a><span class='hs-definition'>tyVarsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>tyVarsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 	        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a><span class='hs-definition'>tyVarsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-8"></a><span class='hs-definition'>tyVarsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>tyVarsOfCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="tyVarsOfCts"></a><span class='hs-definition'>tyVarsOfCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-12"></a><span class='hs-definition'>tyVarsOfCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarsOfCt</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="tyVarsOfWC"></a><span class='hs-definition'>tyVarsOfWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-15"></a><span class='hs-comment'>-- Only called on *zonked* things, hence no need to worry about flatten-skolems</span>
<a name="line-16"></a><span class='hs-definition'>tyVarsOfWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfCts</span> <span class='hs-varid'>flat</span> <span class='hs-varop'>`unionVarSet`</span>
<a name="line-18"></a>    <span class='hs-varid'>tyVarsOfBag</span> <span class='hs-varid'>tyVarsOfImplic</span> <span class='hs-varid'>implic</span> <span class='hs-varop'>`unionVarSet`</span>
<a name="line-19"></a>    <span class='hs-varid'>tyVarsOfCts</span> <span class='hs-varid'>insol</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="tyVarsOfImplic"></a><span class='hs-definition'>tyVarsOfImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-22"></a><span class='hs-comment'>-- Only called on *zonked* things, hence no need to worry about flatten-skolems</span>
<a name="line-23"></a><span class='hs-definition'>tyVarsOfImplic</span> <span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_fsks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsks</span>
<a name="line-24"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfWC</span> <span class='hs-varid'>wanted</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>skols</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>fsks</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="tyVarsOfBag"></a><span class='hs-definition'>tyVarsOfBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-29"></a><span class='hs-definition'>tyVarsOfBag</span> <span class='hs-varid'>tvs_of</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tvs_of</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-comment'>---------------- Tidying -------------------------</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="tidyCt"></a><span class='hs-definition'>tidyCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-34"></a><span class='hs-comment'>-- Used only in error reporting</span>
<a name="line-35"></a><span class='hs-comment'>-- Also converts it to non-canonical</span>
<a name="line-36"></a><span class='hs-definition'>tidyCt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ct</span> 
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>     <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_ev</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
<a name="line-40"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_ev</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-keyword'>where</span> 
<a name="line-42"></a>    <span class='hs-varid'>tidy_ev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-43"></a>     <span class='hs-comment'>-- NB: we do not tidy the ctev_evtm/var field because we don't </span>
<a name="line-44"></a>     <span class='hs-comment'>--     show it in error messages</span>
<a name="line-45"></a>    <span class='hs-varid'>tidy_ev</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-46"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>    <span class='hs-varid'>tidy_ev</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-48"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>    <span class='hs-varid'>tidy_ev</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-50"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pred</span> <span class='hs-layout'>}</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="tidyEvVar"></a><span class='hs-definition'>tidyEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span>
<a name="line-53"></a><span class='hs-definition'>tidyEvVar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarType</span> <span class='hs-varid'>var</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="tidySkolemInfo"></a><span class='hs-definition'>tidySkolemInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-definition'>tidySkolemInfo</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-definition'>tidySkolemInfo</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> 
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ids'</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyword'>where</span>
<a name="line-64"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ids</span>
<a name="line-65"></a>    <span class='hs-varid'>do_one</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-66"></a>       <span class='hs-keyword'>where</span>
<a name="line-67"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>tidySkolemInfo</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>skol_tvs'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-71"></a>  <span class='hs-keyword'>where</span>
<a name="line-72"></a>    <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span>
<a name="line-73"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>skol_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndrs</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-74"></a>    <span class='hs-varid'>ty'</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>ty</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-definition'>tidySkolemInfo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
