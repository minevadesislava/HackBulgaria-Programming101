<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/FamInst.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
The @FamInst@ type: family instance heads

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE GADTs #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-3"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-4"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-5"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-6"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-7"></a><span class='hs-comment'>-- for details</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>FamInst</span> <span class='hs-layout'>(</span> 
<a name="line-10"></a>        <span class='hs-varid'>checkFamInstConsistency</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcExtendLocalFamInstEnv</span><span class='hs-layout'>,</span>
<a name="line-11"></a>	<span class='hs-varid'>tcLookupFamInst</span><span class='hs-layout'>,</span> 
<a name="line-12"></a>        <span class='hs-varid'>tcGetFamInstEnvs</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>newFamInst</span>
<a name="line-14"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span><span class='hs-layout'>(</span> <span class='hs-varid'>roughMatchTcs</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span> <span class='hs-varid'>pprCoAxBranchHdr</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
</pre>\end{code}

%************************************************************************
%*									*
                 Making a FamInst
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- All type variables in a FamInst must be fresh. This function</span>
<a name="line-2"></a><span class='hs-comment'>-- creates the fresh variables and applies the necessary substitution</span>
<a name="line-3"></a><span class='hs-comment'>-- It is defined here to avoid a dependency from FamInstEnv on the monad</span>
<a name="line-4"></a><span class='hs-comment'>-- code.</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="newFamInst"></a><span class='hs-definition'>newFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span> <span class='hs-conid'>FamInst</span>
<a name="line-7"></a><span class='hs-comment'>-- Freshen the type variables of the FamInst branches</span>
<a name="line-8"></a><span class='hs-comment'>-- Called from the vectoriser monad too, hence the rather general type</span>
<a name="line-9"></a><span class='hs-definition'>newFamInst</span> <span class='hs-varid'>flavor</span> <span class='hs-varid'>axiom</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>branch</span>
<a name="line-10"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstSigTyVarsLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tvs</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_fam</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc_name</span>
<a name="line-13"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_flavor</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span>
<a name="line-14"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tcs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roughMatchTcs</span> <span class='hs-varid'>lhs</span>
<a name="line-15"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span>
<a name="line-16"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lhs</span>
<a name="line-17"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_rhs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span>  <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs</span>
<a name="line-18"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>fi_axiom</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>axiom</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>fam_tc_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>fam_tc</span>
<a name="line-21"></a>    <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-22"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-23"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-24"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branch</span>
<a name="line-25"></a>
</pre>\end{code}


%************************************************************************
%*									*
	Optimised overlap checking for family instances
%*									*
%************************************************************************

For any two family instance modules that we import directly or indirectly, we
check whether the instances in the two modules are consistent, *unless* we can
be certain that the instances of the two modules have already been checked for
consistency during the compilation of modules that we import.

Why do we need to check?  Consider 
   module X1 where	  	  module X2 where
    data T1			    data T2
    type instance F T1 b = Int	    type instance F a T2 = Char
    f1 :: F T1 a -> Int		    f2 :: Char -> F a T2
    f1 x = x			    f2 x = x

Now if we import both X1 and X2 we could make (f2 . f1) :: Int -> Char.
Notice that neither instance is an orphan.

How do we know which pairs of modules have already been checked?  Any pair of
modules where both modules occur in the `HscTypes.dep_finsts' set (of the
`HscTypes.Dependencies') of one of our directly imported modules must have
already been checked.  Everything else, we check now.  (So that we can be
certain that the modules in our `HscTypes.dep_finsts' are consistent.)

\begin{code}
<pre><a name="line-1"></a><a name="ModulePair"></a><span class='hs-comment'>-- The optimisation of overlap tests is based on determining pairs of modules</span>
<a name="line-2"></a><a name="ModulePair"></a><span class='hs-comment'>-- whose family instances need to be checked for consistency.</span>
<a name="line-3"></a><a name="ModulePair"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><a name="ModulePair"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ModulePair</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModulePair</span> <span class='hs-conid'>Module</span> <span class='hs-conid'>Module</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="canon"></a><span class='hs-comment'>-- canonical order of the components of a module pair</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-definition'>canon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModulePair</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>Module</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>canon</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModulePair</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>m2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span>
<a name="line-10"></a>			 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>m1</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>ModulePair</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>  <span class='hs-varid'>mp1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mp2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canon</span> <span class='hs-varid'>mp1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>canon</span> <span class='hs-varid'>mp2</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>ModulePair</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>  <span class='hs-varid'>mp1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>mp2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canon</span> <span class='hs-varid'>mp1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>canon</span> <span class='hs-varid'>mp2</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ModulePair</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModulePair</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="ModulePairSet"></a><span class='hs-comment'>-- Sets of module pairs</span>
<a name="line-22"></a><a name="ModulePairSet"></a><span class='hs-comment'>--</span>
<a name="line-23"></a><a name="ModulePairSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ModulePairSet</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>ModulePair</span> <span class='hs-conid'>()</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="listToSet"></a><span class='hs-definition'>listToSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModulePair</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModulePairSet</span>
<a name="line-26"></a><span class='hs-definition'>listToSet</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="checkFamInstConsistency"></a><span class='hs-definition'>checkFamInstConsistency</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-29"></a><span class='hs-definition'>checkFamInstConsistency</span> <span class='hs-varid'>famInstMods</span> <span class='hs-varid'>directlyImpMods</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps</span><span class='hs-layout'>,</span> <span class='hs-varid'>hpt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEpsAndHpt</span>
<a name="line-32"></a>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Fetch the iface of a given module.  Must succeed as</span>
<a name="line-34"></a> 	       <span class='hs-comment'>-- all directly imported modules must already have been loaded.</span>
<a name="line-35"></a>	       <span class='hs-varid'>modIface</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> 
<a name="line-36"></a>	         <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupIfaceByModule</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-37"></a>                   <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"FamInst.checkFamInstConsistency"</span>
<a name="line-38"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>iface</span>
<a name="line-39"></a>
<a name="line-40"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>hmiModule</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_module</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hm_iface</span>
<a name="line-41"></a>	     <span class='hs-layout'>;</span> <span class='hs-varid'>hmiFamInstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendFamInstEnvList</span> <span class='hs-varid'>emptyFamInstEnv</span> 
<a name="line-42"></a>                               <span class='hs-varop'>.</span> <span class='hs-varid'>md_fam_insts</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hm_details</span>
<a name="line-43"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>hpt_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>hmiModule</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>,</span> <span class='hs-varid'>hmiFamInstEnv</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>)</span> 
<a name="line-44"></a>			                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eltsUFM</span> <span class='hs-varid'>hpt</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>	     <span class='hs-layout'>;</span> <span class='hs-varid'>groups</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_finsts</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mi_deps</span> <span class='hs-varop'>.</span> <span class='hs-varid'>modIface</span><span class='hs-layout'>)</span> 
<a name="line-46"></a>				   <span class='hs-varid'>directlyImpMods</span>
<a name="line-47"></a>	     <span class='hs-layout'>;</span> <span class='hs-varid'>okPairs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>allPairs</span> <span class='hs-varid'>groups</span>
<a name="line-48"></a>	         <span class='hs-comment'>-- instances of okPairs are consistent</span>
<a name="line-49"></a>	     <span class='hs-layout'>;</span> <span class='hs-varid'>criticalPairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>allPairs</span> <span class='hs-varid'>famInstMods</span>
<a name="line-50"></a>	         <span class='hs-comment'>-- all pairs that we need to consider</span>
<a name="line-51"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>toCheckPairs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>keys</span> <span class='hs-varop'>$</span> <span class='hs-varid'>criticalPairs</span> <span class='hs-varop'>`</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>difference</span><span class='hs-varop'>`</span> <span class='hs-varid'>okPairs</span>
<a name="line-52"></a>	         <span class='hs-comment'>-- the difference gives us the pairs we need to check now</span>
<a name="line-53"></a>	     <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check</span> <span class='hs-varid'>hpt_fam_insts</span><span class='hs-layout'>)</span> <span class='hs-varid'>toCheckPairs</span>
<a name="line-56"></a>       <span class='hs-layout'>}</span>
<a name="line-57"></a>  <span class='hs-keyword'>where</span>
<a name="line-58"></a>    <span class='hs-varid'>allPairs</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-59"></a>    <span class='hs-varid'>allPairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModulePair</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>++</span> <span class='hs-varid'>allPairs</span> <span class='hs-varid'>ms</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-varid'>check</span> <span class='hs-varid'>hpt_fam_insts</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModulePair</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span>
<a name="line-62"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFamInsts</span> <span class='hs-varid'>hpt_fam_insts</span> <span class='hs-varid'>m1</span>
<a name="line-63"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>env2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFamInsts</span> <span class='hs-varid'>hpt_fam_insts</span> <span class='hs-varid'>m2</span>
<a name="line-64"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkForConflicts</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   
<a name="line-65"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>famInstEnvElts</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="getFamInsts"></a><span class='hs-definition'>getFamInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleEnv</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-68"></a><span class='hs-definition'>getFamInsts</span> <span class='hs-varid'>hpt_fam_insts</span> <span class='hs-varid'>mod</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupModuleEnv</span> <span class='hs-varid'>hpt_fam_insts</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>env</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initIfaceTcRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadSysInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-71"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEps</span>
<a name="line-72"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"checkFamInstConsistency"</span> <span class='hs-varop'>$</span>
<a name="line-73"></a>                             <span class='hs-varid'>lookupModuleEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_mod_fam_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>  <span class='hs-keyword'>where</span>
<a name="line-75"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a family-instance module"</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
	Lookup
%*									*
%************************************************************************

Look up the instance tycon of a family instance.

The match may be ambiguous (as we know that overlapping instances have
identical right-hand sides under overlapping substitutions - see
'FamInstEnv.lookupFamInstEnvConflicts').  However, the type arguments used
for matching must be equal to or be more specific than those of the family
instance declaration.  We pick one of the matches in case of ambiguity; as
the right-hand sides are identical under the match substitution, the choice
does not matter.

Return the instance tycon and its type instance.  For example, if we have

 tcLookupFamInst 'T' '[Int]' yields (':R42T', 'Int')

then we have a coercion (ie, type instance of family instance coercion)

 :Co:R42T Int :: T [Int] ~ :R42T Int

which implies that :R42T was declared as 'data instance T [a]'.

\begin{code}
<pre><a name="line-1"></a><a name="tcLookupFamInst"></a><span class='hs-definition'>tcLookupFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FamInstMatch</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tcLookupFamInst</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOpenFamilyTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>instEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_match</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFamInstEnv</span> <span class='hs-varid'>instEnv</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span> 
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lookupFamInst"</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> 
<a name="line-9"></a>                                  <span class='hs-varid'>pprTvBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> 
<a name="line-10"></a>                                  <span class='hs-varid'>ppr</span> <span class='hs-varid'>mb_match</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>instEnv</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_match</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>	   <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-13"></a>	   <span class='hs-layout'>(</span><span class='hs-varid'>match</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 
<a name="line-14"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>match</span>
<a name="line-15"></a>       <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
	Extending the family instance environment
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcExtendLocalFamInstEnv"></a><span class='hs-comment'>-- Add new locally-defined family instances</span>
<a name="line-2"></a><span class='hs-definition'>tcExtendLocalFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3"></a><span class='hs-definition'>tcExtendLocalFamInstEnv</span> <span class='hs-varid'>fam_insts</span> <span class='hs-varid'>thing_inside</span>
<a name="line-4"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-5"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_insts'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>addLocalFamInst</span>  
<a name="line-6"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-7"></a>                                          <span class='hs-varid'>fam_insts</span>
<a name="line-8"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_fam_insts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts'</span>
<a name="line-9"></a>		       <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_env'</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>thing_inside</span>
<a name="line-11"></a>      <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="addLocalFamInst"></a><span class='hs-comment'>-- Check that the proposed new instance is OK,</span>
<a name="line-14"></a><span class='hs-comment'>-- and then add it to the home inst env</span>
<a name="line-15"></a><span class='hs-comment'>-- This must be lazy in the fam_inst arguments, see Note [Lazy axiom match]</span>
<a name="line-16"></a><span class='hs-comment'>-- in FamInstEnv.lhs</span>
<a name="line-17"></a><span class='hs-definition'>addLocalFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>addLocalFamInst</span> <span class='hs-layout'>(</span><span class='hs-varid'>home_fie</span><span class='hs-layout'>,</span> <span class='hs-varid'>my_fis</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_inst</span>
<a name="line-19"></a>        <span class='hs-comment'>-- home_fie includes home package and this module</span>
<a name="line-20"></a>        <span class='hs-comment'>-- my_fies is just the ones from this module</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"addLocalFamInst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_inst</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>isGHCi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getIsGHCi</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"alfi"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>isGHCi</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a>           <span class='hs-comment'>-- In GHCi, we *override* any identical instances</span>
<a name="line-28"></a>           <span class='hs-comment'>-- that are also defined in the interactive context</span>
<a name="line-29"></a>           <span class='hs-comment'>-- Trac #7102</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>home_fie'</span><span class='hs-layout'>,</span> <span class='hs-varid'>my_fis'</span><span class='hs-layout'>)</span>
<a name="line-31"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGHCi</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>deleteFromFamInstEnv</span> <span class='hs-varid'>home_fie</span> <span class='hs-varid'>fam_inst</span>
<a name="line-32"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>identicalFamInst</span> <span class='hs-varid'>fam_inst</span><span class='hs-layout'>)</span> <span class='hs-varid'>my_fis</span><span class='hs-layout'>)</span>
<a name="line-33"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>home_fie</span><span class='hs-layout'>,</span> <span class='hs-varid'>my_fis</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>           <span class='hs-comment'>-- Load imported instances, so that we report</span>
<a name="line-36"></a>           <span class='hs-comment'>-- overlaps correctly</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEps</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inst_envs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_fie'</span><span class='hs-layout'>)</span>
<a name="line-39"></a>             <span class='hs-varid'>home_fie''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendFamInstEnv</span> <span class='hs-varid'>home_fie</span> <span class='hs-varid'>fam_inst</span>
<a name="line-40"></a>
<a name="line-41"></a>           <span class='hs-comment'>-- Check for conflicting instance decls</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>no_conflict</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkForConflicts</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>fam_inst</span>
<a name="line-43"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>no_conflict</span> <span class='hs-keyword'>then</span>
<a name="line-44"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>home_fie''</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_inst</span> <span class='hs-conop'>:</span> <span class='hs-varid'>my_fis'</span><span class='hs-layout'>)</span>
<a name="line-45"></a>         <span class='hs-keyword'>else</span>
<a name="line-46"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>home_fie</span><span class='hs-layout'>,</span>   <span class='hs-varid'>my_fis</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
	Checking an instance against conflicts with an instance env
%*									*
%************************************************************************

Check whether a single family instance conflicts with those in two instance
environments (one for the EPS and one for the HPT).

\begin{code}
<pre><a name="line-1"></a><a name="checkForConflicts"></a><span class='hs-definition'>checkForConflicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>checkForConflicts</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>fam_inst</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>conflicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFamInstEnvConflicts</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>fam_inst</span>
<a name="line-4"></a>             <span class='hs-varid'>no_conflicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>conflicts</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkForConflicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fim_instance</span> <span class='hs-varid'>conflicts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-6"></a>                                      <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_inst</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_envs</span><span class='hs-layout'>)</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>no_conflicts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>conflictInstErr</span> <span class='hs-varid'>fam_inst</span> <span class='hs-varid'>conflicts</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>no_conflicts</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="conflictInstErr"></a><span class='hs-definition'>conflictInstErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-11"></a><span class='hs-definition'>conflictInstErr</span> <span class='hs-varid'>fam_inst</span> <span class='hs-varid'>conflictingMatch</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstMatch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fim_instance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>confInst</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>conflictingMatch</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addFamInstsErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Conflicting family instance declarations:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-varid'>fam_inst</span><span class='hs-layout'>,</span> <span class='hs-varid'>confInst</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"conflictInstErr"</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="addFamInstsErr"></a><span class='hs-definition'>addFamInstsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-19"></a><span class='hs-definition'>addFamInstsErr</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>insts</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>srcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-22"></a>    <span class='hs-varid'>hang</span> <span class='hs-varid'>herald</span>
<a name="line-23"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprCoAxBranchHdr</span> <span class='hs-layout'>(</span><span class='hs-varid'>famInstAxiom</span> <span class='hs-varid'>fi</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span>
<a name="line-24"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sorted</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-25"></a> <span class='hs-keyword'>where</span>
<a name="line-26"></a>   <span class='hs-varid'>getSpan</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>famInstAxiom</span>
<a name="line-27"></a>   <span class='hs-varid'>sorted</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortWith</span> <span class='hs-varid'>getSpan</span> <span class='hs-varid'>insts</span>
<a name="line-28"></a>   <span class='hs-varid'>fi1</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>sorted</span>
<a name="line-29"></a>   <span class='hs-varid'>srcSpan</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomSingleBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>famInstAxiom</span> <span class='hs-varid'>fi1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>   <span class='hs-comment'>-- The sortWith just arranges that instances are dislayed in order</span>
<a name="line-31"></a>   <span class='hs-comment'>-- of source location, which reduced wobbling in error messages,</span>
<a name="line-32"></a>   <span class='hs-comment'>-- and is better for users</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="tcGetFamInstEnvs"></a><span class='hs-definition'>tcGetFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-35"></a><span class='hs-comment'>-- Gets both the external-package inst-env</span>
<a name="line-36"></a><span class='hs-comment'>-- and the home-pkg inst env (includes module being compiled)</span>
<a name="line-37"></a><span class='hs-definition'>tcGetFamInstEnvs</span> 
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEps</span><span class='hs-layout'>;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

</body>
</html>
