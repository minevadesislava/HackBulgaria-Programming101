<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>rename/RnBinds.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[RnBinds]{Renaming and dependency analysis of bindings}

This module does renaming and dependency analysis on value bindings in
the abstract syntax.  It does {\em not} do cycle-checks on class or
type-synonym declarations; those cannot be done at this stage because
they may be affected by renaming (which isn't fully worked out yet).

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RnBinds</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>   <span class='hs-comment'>-- Renaming top-level bindings</span>
<a name="line-10"></a>   <span class='hs-varid'>rnTopBindsLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnTopBindsRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnValBindsRHS</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>   <span class='hs-comment'>-- Renaming local bindings</span>
<a name="line-13"></a>   <span class='hs-varid'>rnLocalBindsAndThen</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsRHS</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>   <span class='hs-comment'>-- Other bindings</span>
<a name="line-16"></a>   <span class='hs-varid'>rnMethodBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>renameSigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSigTvFn</span><span class='hs-layout'>,</span>
<a name="line-17"></a>   <span class='hs-varid'>rnMatchGroup</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnGRHSs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnGRHS</span><span class='hs-layout'>,</span>
<a name="line-18"></a>   <span class='hs-varid'>makeMiniFixityEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MiniFixityEnv</span><span class='hs-layout'>,</span>
<a name="line-19"></a>   <span class='hs-conid'>HsSigCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-20"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>RnExpr</span><span class='hs-layout'>(</span> <span class='hs-varid'>rnLExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnStmts</span> <span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>emptyTcEvBinds</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnTypes</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>bindSigTyVarsFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkPrecMatch</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnContext</span> <span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnPat</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnNames</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdrNameOcc</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>findDupsEq</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>	<span class='hs-layout'>(</span> <span class='hs-conid'>RecFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>		<span class='hs-layout'>(</span> <span class='hs-conid'>SCC</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>sort</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-layout'>(</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>)</span>
</pre>\end{code}

-- ToDo: Put the annotations into the monad, so that they arrive in the proper
-- place and can be used when complaining.

The code tree received by the function @rnBinds@ contains definitions
in where-clauses which are all apparently mutually recursive, but which may
not really depend upon each other. For example, in the top level program
\begin{verbatim}
f x = y where a = x
	      y = x
\end{verbatim}
the definitions of @a@ and @y@ do not depend on each other at all.
Unfortunately, the typechecker cannot always check such definitions.
\footnote{Mycroft, A. 1984. Polymorphic type schemes and recursive
definitions. In Proceedings of the International Symposium on Programming,
Toulouse, pp. 217-39. LNCS 167. Springer Verlag.}
However, the typechecker usually can check definitions in which only the
strongly connected components have been collected into recursive bindings.
This is precisely what the function @rnBinds@ does.

ToDo: deal with case where a single monobinds binds the same variable
twice.

The vertag tag is a unique @Int@; the tags only need to be unique
within one @MonoBinds@, so that unique-Int plumbing is done explicitly
(heavy monad machinery not needed).


%************************************************************************
%*									*
%* naming conventions							*
%*									*
%************************************************************************

\subsection[name-conventions]{Name conventions}

The basic algorithm involves walking over the tree and returning a tuple
containing the new tree plus its free variables. Some functions, such
as those walking polymorphic bindings (HsBinds) and qualifier lists in
list comprehensions (@Quals@), return the variables bound in local
environments. These are then used to calculate the free variables of the
expression evaluated in these environments.

Conventions for variable names are as follows:
\begin{itemize}
\item
new code is given a prime to distinguish it from the old.

\item
a set of variables defined in @Exp@ is written @dvExp@

\item
a set of variables free in @Exp@ is written @fvExp@
\end{itemize}

%************************************************************************
%*									*
%* analysing polymorphic bindings (HsBindGroup, HsBind)
%*									*
%************************************************************************

\subsubsection[dep-HsBinds]{Polymorphic bindings}

Non-recursive expressions are reconstructed without any changes at top
level, although their component expressions may have to be altered.
However, non-recursive expressions are currently not expected as
\Haskell{} programs, and this code should not be executed.

Monomorphic bindings contain information that is returned in a tuple
(a @FlatMonoBinds@) containing:

\begin{enumerate}
\item
a unique @Int@ that serves as the ``vertex tag'' for this binding.

\item
the name of a function or the names in a pattern. These are a set
referred to as @dvLhs@, the defined variables of the left hand side.

\item
the free variables of the body. These are referred to as @fvBody@.

\item
the definition's actual code. This is referred to as just @code@.
\end{enumerate}

The function @nonRecDvFv@ returns two sets of variables. The first is
the set of variables defined in the set of monomorphic bindings, while the
second is the set of free variables in those bindings.

The set of variables defined in a non-recursive binding is just the
union of all of them, as @union@ removes duplicates. However, the
free variables in each successive set of cumulative bindings is the
union of those in the previous set plus those of the newest binding after
the defined variables of the previous set have been removed.

@rnMethodBinds@ deals only with the declarations in class and
instance declarations.	It expects only to see @FunMonoBind@s, and
it expects the global environment to contain bindings for the binders
(which are all class operations).

%************************************************************************
%*									*
\subsubsection{ Top-level bindings}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnTopBindsLHS"></a><span class='hs-comment'>-- for top-level bindings, we need to make top-level names,</span>
<a name="line-2"></a><span class='hs-comment'>-- so we have a different entry point than for local bindings</span>
<a name="line-3"></a><span class='hs-definition'>rnTopBindsLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>RdrName</span> 
<a name="line-5"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>rnTopBindsLHS</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>binds</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnValBindsLHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>topRecNameMaker</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="rnTopBindsRHS"></a><span class='hs-definition'>rnTopBindsRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span> 
<a name="line-10"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-definition'>rnTopBindsRHS</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>binds</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_boot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIsHsBoot</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>is_boot</span> 
<a name="line-14"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>rnTopBindsBoot</span> <span class='hs-varid'>binds</span>
<a name="line-15"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>rnValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopSigCtxt</span> <span class='hs-varid'>bound_names</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="rnTopBindsBoot"></a><span class='hs-definition'>rnTopBindsBoot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-comment'>-- A hs-boot file has no bindings. </span>
<a name="line-19"></a><span class='hs-comment'>-- Return a single HsBindGroup with empty binds and renamed signatures</span>
<a name="line-20"></a><span class='hs-definition'>rnTopBindsBoot</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-varid'>mbinds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyLHsBinds</span> <span class='hs-varid'>mbinds</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindsInHsBootFile</span> <span class='hs-varid'>mbinds</span><span class='hs-layout'>)</span>
<a name="line-22"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>renameSigs</span> <span class='hs-conid'>HsBootCtxt</span> <span class='hs-varid'>sigs</span>
<a name="line-23"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>usesOnly</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a><span class='hs-definition'>rnTopBindsBoot</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnTopBindsBoot"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
</pre>\end{code}


%*********************************************************
%*							*
		HsLocalBinds
%*							*
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnLocalBindsAndThen"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>RdrName</span>
<a name="line-2"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-comment'>-- This version (a) assumes that the binding vars are *not* already in scope</span>
<a name="line-5"></a><span class='hs-comment'>--		 (b) removes the binders from the free vars of the thing inside</span>
<a name="line-6"></a><span class='hs-comment'>-- The parser doesn't produce ThenBinds</span>
<a name="line-7"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-conid'>EmptyLocalBinds</span> <span class='hs-varid'>thing_inside</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing_inside</span> <span class='hs-conid'>EmptyLocalBinds</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>val_binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalValBindsAndThen</span> <span class='hs-varid'>val_binds</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>val_binds'</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-12"></a>      <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>val_binds'</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>rnLocalBindsAndThen</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-15"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnIPBinds</span> <span class='hs-varid'>binds</span>
<a name="line-16"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span>
<a name="line-17"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_thing</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_binds</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="rnIPBinds"></a><span class='hs-definition'>rnIPBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsIPBinds</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>rnIPBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>ip_binds</span> <span class='hs-sel'>_no_dict_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-21"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ip_binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>rnIPBind</span><span class='hs-layout'>)</span> <span class='hs-varid'>ip_binds</span>
<a name="line-22"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>ip_binds'</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvs_s</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="rnIPBind"></a><span class='hs-definition'>rnIPBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IPBind</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>rnIPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-26"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-27"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
		ValBinds
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnLocalValBindsLHS"></a><span class='hs-comment'>-- Renaming local binding gropus </span>
<a name="line-2"></a><span class='hs-comment'>-- Does duplicate/shadow check</span>
<a name="line-3"></a><span class='hs-definition'>rnLocalValBindsLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-4"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>RdrName</span>
<a name="line-5"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>rnLocalValBindsLHS</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>binds</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnValBindsLHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRecNameMaker</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span> 
<a name="line-8"></a>
<a name="line-9"></a>         <span class='hs-comment'>-- Check for duplicates and shadowing</span>
<a name="line-10"></a>	 <span class='hs-comment'>-- Must do this *after* renaming the patterns</span>
<a name="line-11"></a>	 <span class='hs-comment'>-- See Note [Collect binders only after renaming] in HsUtils</span>
<a name="line-12"></a>
<a name="line-13"></a>         <span class='hs-comment'>-- We need to check for dups here because we</span>
<a name="line-14"></a>     	 <span class='hs-comment'>-- don't don't bind all of the variables from the ValBinds at once</span>
<a name="line-15"></a>     	 <span class='hs-comment'>-- with bindLocatedLocals any more.</span>
<a name="line-16"></a>         <span class='hs-comment'>-- </span>
<a name="line-17"></a>     	 <span class='hs-comment'>-- Note that we don't want to do this at the top level, since</span>
<a name="line-18"></a>     	 <span class='hs-comment'>-- sorting out duplicates and shadowing there happens elsewhere.</span>
<a name="line-19"></a>     	 <span class='hs-comment'>-- The behavior is even different. For example,</span>
<a name="line-20"></a>     	 <span class='hs-comment'>--   import A(f)</span>
<a name="line-21"></a>     	 <span class='hs-comment'>--   f = ...</span>
<a name="line-22"></a>     	 <span class='hs-comment'>-- should not produce a shadowing warning (but it will produce</span>
<a name="line-23"></a>     	 <span class='hs-comment'>-- an ambiguity warning if you use f), but</span>
<a name="line-24"></a>     	 <span class='hs-comment'>--   import A(f)</span>
<a name="line-25"></a>     	 <span class='hs-comment'>--   g = let f = ... in f</span>
<a name="line-26"></a>     	 <span class='hs-comment'>-- should.</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bound_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHsValBinders</span> <span class='hs-varid'>binds'</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRdrEnvs</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkDupAndShadowedNames</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>bound_names</span>
<a name="line-30"></a>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bound_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="rnValBindsLHS"></a><span class='hs-comment'>-- renames the left-hand sides</span>
<a name="line-34"></a><span class='hs-comment'>-- generic version used both at the top level and for local binds</span>
<a name="line-35"></a><span class='hs-comment'>-- does some error checking, but not what gets done elsewhere at the top level</span>
<a name="line-36"></a><span class='hs-definition'>rnValBindsLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameMaker</span> 
<a name="line-37"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>RdrName</span>
<a name="line-38"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-definition'>rnValBindsLHS</span> <span class='hs-varid'>topP</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-varid'>mbinds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mbinds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBindLHS</span> <span class='hs-varid'>topP</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mbinds</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ValBindsIn</span> <span class='hs-varid'>mbinds'</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>  <span class='hs-keyword'>where</span>
<a name="line-43"></a>    <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHsBindsBinders</span> <span class='hs-varid'>mbinds</span>
<a name="line-44"></a>    <span class='hs-varid'>doc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the binding group for:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndrs</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>rnValBindsLHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnValBindsLHSFromDoc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="rnValBindsRHS"></a><span class='hs-comment'>-- General version used both from the top-level and for local things</span>
<a name="line-49"></a><span class='hs-comment'>-- Assumes the LHS vars are in scope</span>
<a name="line-50"></a><span class='hs-comment'>--</span>
<a name="line-51"></a><span class='hs-comment'>-- Does not bind the local fixity declarations</span>
<a name="line-52"></a><span class='hs-definition'>rnValBindsRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span> 
<a name="line-53"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span>
<a name="line-54"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-definition'>rnValBindsRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-varid'>mbinds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>renameSigs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sigs</span>
<a name="line-58"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>binds_w_dus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSigTvFn</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mbinds</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>depAnalBinds</span> <span class='hs-varid'>binds_w_dus</span> <span class='hs-keyword'>of</span>
<a name="line-60"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>anal_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>anal_dus</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>valbind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>valbind'_dus</span><span class='hs-layout'>)</span>
<a name="line-61"></a>              <span class='hs-keyword'>where</span>
<a name="line-62"></a>                <span class='hs-varid'>valbind'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>anal_binds</span> <span class='hs-varid'>sigs'</span>
<a name="line-63"></a>                <span class='hs-varid'>valbind'_dus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anal_dus</span> <span class='hs-varop'>`plusDU`</span> <span class='hs-varid'>usesOnly</span> <span class='hs-varid'>sig_fvs</span>
<a name="line-64"></a>			       <span class='hs-comment'>-- Put the sig uses *after* the bindings</span>
<a name="line-65"></a>			       <span class='hs-comment'>-- so that the binders are removed from </span>
<a name="line-66"></a>			       <span class='hs-comment'>-- the uses in the sigs</span>
<a name="line-67"></a>       <span class='hs-layout'>}</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>rnValBindsRHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnValBindsRHS"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="rnLocalValBindsRHS"></a><span class='hs-comment'>-- Wrapper for local binds</span>
<a name="line-72"></a><span class='hs-comment'>--</span>
<a name="line-73"></a><span class='hs-comment'>-- The *client* of this function is responsible for checking for unused binders;</span>
<a name="line-74"></a><span class='hs-comment'>-- it doesn't (and can't: we don't have the thing inside the binds) happen here</span>
<a name="line-75"></a><span class='hs-comment'>--</span>
<a name="line-76"></a><span class='hs-comment'>-- The client is also responsible for bringing the fixities into scope</span>
<a name="line-77"></a><span class='hs-definition'>rnLocalValBindsRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span>  <span class='hs-comment'>-- names bound by the LHSes</span>
<a name="line-78"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span>
<a name="line-79"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-definition'>rnLocalValBindsRHS</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>binds</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocalBindCtxt</span> <span class='hs-varid'>bound_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="rnLocalValBindsAndThen"></a><span class='hs-comment'>-- for local binds</span>
<a name="line-84"></a><span class='hs-comment'>-- wrapper that does both the left- and right-hand sides </span>
<a name="line-85"></a><span class='hs-comment'>--</span>
<a name="line-86"></a><span class='hs-comment'>-- here there are no local fixity decls passed in;</span>
<a name="line-87"></a><span class='hs-comment'>-- the local fixity decls come from the ValBinds sigs</span>
<a name="line-88"></a><span class='hs-definition'>rnLocalValBindsAndThen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>RdrName</span>
<a name="line-89"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-90"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-91"></a><span class='hs-definition'>rnLocalValBindsAndThen</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-92"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>     <span class='hs-comment'>-- (A) Create the local fixity environment </span>
<a name="line-93"></a>	  <span class='hs-varid'>new_fixities</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeMiniFixityEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sigs</span><span class='hs-keyglyph'>]</span>
<a name="line-94"></a>
<a name="line-95"></a>	      <span class='hs-comment'>-- (B) Rename the LHSes </span>
<a name="line-96"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bound_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_lhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLocalValBindsLHS</span> <span class='hs-varid'>new_fixities</span> <span class='hs-varid'>binds</span>
<a name="line-97"></a>
<a name="line-98"></a>	      <span class='hs-comment'>--     ...and bring them (and their fixities) into scope</span>
<a name="line-99"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>bound_names</span>              <span class='hs-varop'>$</span>
<a name="line-100"></a>          <span class='hs-varid'>addLocalFixities</span> <span class='hs-varid'>new_fixities</span> <span class='hs-varid'>bound_names</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-101"></a>
<a name="line-102"></a>	<span class='hs-layout'>{</span>      <span class='hs-comment'>-- (C) Do the RHS and thing inside</span>
<a name="line-103"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLocalValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>bound_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_lhs</span> 
<a name="line-104"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>binds'</span>
<a name="line-105"></a>
<a name="line-106"></a>		<span class='hs-comment'>-- Report unused bindings based on the (accurate) </span>
<a name="line-107"></a>		<span class='hs-comment'>-- findUses.  E.g.</span>
<a name="line-108"></a>		<span class='hs-comment'>-- 	let x = x in 3</span>
<a name="line-109"></a>		<span class='hs-comment'>-- should report 'x' unused</span>
<a name="line-110"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>real_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findUses</span> <span class='hs-varid'>dus</span> <span class='hs-varid'>result_fvs</span>
<a name="line-111"></a>	      <span class='hs-comment'>-- Insert fake uses for variables introduced implicitly by wildcards (#4404)</span>
<a name="line-112"></a>	      <span class='hs-varid'>implicit_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsValBindsImplicits</span> <span class='hs-varid'>binds'</span>
<a name="line-113"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedLocalBinds</span> <span class='hs-varid'>bound_names</span> <span class='hs-layout'>(</span><span class='hs-varid'>real_uses</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>implicit_uses</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-116"></a>            <span class='hs-comment'>-- The variables "used" in the val binds are: </span>
<a name="line-117"></a>            <span class='hs-comment'>--   (1) the uses of the binds (allUses)</span>
<a name="line-118"></a>            <span class='hs-comment'>--   (2) the FVs of the thing-inside</span>
<a name="line-119"></a>            <span class='hs-varid'>all_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allUses</span> <span class='hs-varid'>dus</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>result_fvs</span>
<a name="line-120"></a>		<span class='hs-comment'>-- Note [Unused binding hack]</span>
<a name="line-121"></a>		<span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-122"></a>		<span class='hs-comment'>-- Note that *in contrast* to the above reporting of</span>
<a name="line-123"></a>		<span class='hs-comment'>-- unused bindings, (1) above uses duUses to return *all* </span>
<a name="line-124"></a>		<span class='hs-comment'>-- the uses, even if the binding is unused.  Otherwise consider:</span>
<a name="line-125"></a>                <span class='hs-comment'>--	x = 3</span>
<a name="line-126"></a>                <span class='hs-comment'>--	y = let p = x in 'x'	-- NB: p not used</span>
<a name="line-127"></a>                <span class='hs-comment'>-- If we don't "see" the dependency of 'y' on 'x', we may put the</span>
<a name="line-128"></a>                <span class='hs-comment'>-- bindings in the wrong order, and the type checker will complain</span>
<a name="line-129"></a>                <span class='hs-comment'>-- that x isn't in scope</span>
<a name="line-130"></a>		<span class='hs-comment'>--</span>
<a name="line-131"></a>		<span class='hs-comment'>-- But note that this means we won't report 'x' as unused, </span>
<a name="line-132"></a>		<span class='hs-comment'>-- whereas we would if we had { x = 3; p = x; y = 'x' }</span>
<a name="line-133"></a>
<a name="line-134"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_uses</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-135"></a>         	<span class='hs-comment'>-- The bound names are pruned out of all_uses</span>
<a name="line-136"></a>	        <span class='hs-comment'>-- by the bindLocalNamesFV call above</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-definition'>rnLocalValBindsAndThen</span> <span class='hs-varid'>bs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnLocalValBindsAndThen"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-comment'>-- Process the fixity declarations, making a FastString -&gt; (Located Fixity) map</span>
<a name="line-142"></a><span class='hs-comment'>-- (We keep the location around for reporting duplicate fixity declarations.)</span>
<a name="line-143"></a><span class='hs-comment'>-- </span>
<a name="line-144"></a><span class='hs-comment'>-- Checks for duplicates, but not that only locally defined things are fixed.</span>
<a name="line-145"></a><span class='hs-comment'>-- Note: for local fixity declarations, duplicates would also be checked in</span>
<a name="line-146"></a><span class='hs-comment'>--       check_sigs below.  But we also use this function at the top level.</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="makeMiniFixityEnv"></a><span class='hs-definition'>makeMiniFixityEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFixitySig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-149"></a>
<a name="line-150"></a><span class='hs-definition'>makeMiniFixityEnv</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>add_one</span> <span class='hs-varid'>emptyFsEnv</span> <span class='hs-varid'>decls</span>
<a name="line-151"></a> <span class='hs-keyword'>where</span>
<a name="line-152"></a>   <span class='hs-varid'>add_one</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>name_loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-153"></a>     <span class='hs-layout'>{</span> <span class='hs-comment'>-- this fixity decl is a duplicate iff</span>
<a name="line-154"></a>       <span class='hs-comment'>-- the ReaderName's OccName's FastString is already in the env</span>
<a name="line-155"></a>       <span class='hs-comment'>-- (we only need to check the local fix_env because</span>
<a name="line-156"></a>       <span class='hs-comment'>--  definitions of non-local will be caught elsewhere)</span>
<a name="line-157"></a>       <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-158"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>fix_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fixity</span> <span class='hs-layout'>}</span><span class='hs-layout'>;</span>
<a name="line-159"></a>
<a name="line-160"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupFsEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fs</span> <span class='hs-keyword'>of</span>
<a name="line-161"></a>         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendFsEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>fix_item</span>
<a name="line-162"></a>         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-163"></a>           <span class='hs-layout'>{</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-164"></a>             <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>name_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupFixityDecl</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-165"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>env</span><span class='hs-layout'>}</span>
<a name="line-166"></a>     <span class='hs-layout'>}</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="dupFixityDecl"></a><span class='hs-definition'>dupFixityDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-169"></a><span class='hs-definition'>dupFixityDecl</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr_name</span>
<a name="line-170"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Multiple fixity declarations for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-171"></a>	  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"also at "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>]</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-comment'>---------------------</span>
<a name="line-174"></a>
<a name="line-175"></a><span class='hs-comment'>-- renaming a single bind</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="rnBindLHS"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameMaker</span>
<a name="line-178"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> 
<a name="line-179"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>RdrName</span>
<a name="line-180"></a>          <span class='hs-comment'>-- returns the renamed left-hand side,</span>
<a name="line-181"></a>          <span class='hs-comment'>-- and the FreeVars *of the LHS*</span>
<a name="line-182"></a>          <span class='hs-comment'>-- (i.e., any free variables of the pattern)</span>
<a name="line-183"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBindLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-varid'>name_maker</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-187"></a>      <span class='hs-comment'>-- we don't actually use the FV processing of rnPatsAndThen here</span>
<a name="line-188"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span><span class='hs-varid'>pat'_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBindPat</span> <span class='hs-varid'>name_maker</span> <span class='hs-varid'>pat</span>
<a name="line-189"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'_fvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-190"></a>                <span class='hs-comment'>-- We temporarily store the pat's FVs in bind_fvs;</span>
<a name="line-191"></a>                <span class='hs-comment'>-- gets updated to the FVs of the whole bind</span>
<a name="line-192"></a>                <span class='hs-comment'>-- when doing the RHS below</span>
<a name="line-193"></a>
<a name="line-194"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-varid'>name_maker</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nameLoc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>newname</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applyNameMaker</span> <span class='hs-varid'>name_maker</span> <span class='hs-varid'>name</span>
<a name="line-196"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>nameLoc</span> <span class='hs-varid'>newname</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-197"></a>
<a name="line-198"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-varid'>name_maker</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span><span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdrname</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nameLoc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-199"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTopRecNameMaker</span> <span class='hs-varid'>name_maker</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-200"></a>           <span class='hs-varid'>addErr</span> <span class='hs-varid'>localPatternSynonymErr</span>
<a name="line-201"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addLocM</span> <span class='hs-varid'>checkConName</span> <span class='hs-varid'>rdrname</span>
<a name="line-202"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applyNameMaker</span> <span class='hs-varid'>name_maker</span> <span class='hs-varid'>rdrname</span>
<a name="line-203"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>nameLoc</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-204"></a>  <span class='hs-keyword'>where</span>
<a name="line-205"></a>    <span class='hs-varid'>localPatternSynonymErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-206"></a>    <span class='hs-varid'>localPatternSynonymErr</span>
<a name="line-207"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal pattern synonym declaration"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-208"></a>           <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Pattern synonym declarations are only valid in the top-level scope"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-209"></a>
<a name="line-210"></a><span class='hs-definition'>rnBindLHS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnBindHS"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-211"></a>
<a name="line-212"></a><a name="rnLBind"></a><span class='hs-definition'>rnLBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Signature tyvar function</span>
<a name="line-213"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBindLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span>
<a name="line-214"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uses</span><span class='hs-layout'>)</span>
<a name="line-215"></a><span class='hs-definition'>rnLBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-216"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-217"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind</span>
<a name="line-218"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-219"></a>
<a name="line-220"></a><a name="rnBind"></a><span class='hs-comment'>-- assumes the left-hands-side vars are in scope</span>
<a name="line-221"></a><span class='hs-definition'>rnBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Signature tyvar function</span>
<a name="line-222"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBindLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span>
<a name="line-223"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uses</span><span class='hs-layout'>)</span>
<a name="line-224"></a><span class='hs-definition'>rnBind</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span>
<a name="line-225"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span> 
<a name="line-226"></a>                                   <span class='hs-comment'>-- pat fvs were stored in bind_fvs</span>
<a name="line-227"></a>                                   <span class='hs-comment'>-- after processing the LHS</span>
<a name="line-228"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat_fvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-229"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-230"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnGRHSs</span> <span class='hs-conid'>PatBindRhs</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>grhss</span>
<a name="line-231"></a>
<a name="line-232"></a>		<span class='hs-comment'>-- No scoped type variables for pattern bindings</span>
<a name="line-233"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-234"></a>              <span class='hs-varid'>fvs'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_fvs</span>
<a name="line-235"></a>	        <span class='hs-comment'>-- Keep locally-defined Names</span>
<a name="line-236"></a>		<span class='hs-comment'>-- As well as dependency analysis, we need these for the</span>
<a name="line-237"></a>		<span class='hs-comment'>-- MonoLocalBinds test in TcBinds.decideGeneralisationPlan</span>
<a name="line-238"></a>              <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat</span>
<a name="line-239"></a>              <span class='hs-varid'>bind'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_rhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs'</span> <span class='hs-layout'>}</span>
<a name="line-240"></a>              <span class='hs-varid'>is_wild_pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>pat</span> <span class='hs-keyword'>of</span>
<a name="line-241"></a>                              <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>WildPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-242"></a>                              <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-243"></a>
<a name="line-244"></a>        <span class='hs-comment'>-- Warn if the pattern binds no variables, except for the</span>
<a name="line-245"></a>        <span class='hs-comment'>-- entirely-explicit idiom    _ = rhs</span>
<a name="line-246"></a>        <span class='hs-comment'>-- which (a) is not that different from  _v = rhs</span>
<a name="line-247"></a>        <span class='hs-comment'>--       (b) is sometimes used to give a type sig for,</span>
<a name="line-248"></a>        <span class='hs-comment'>--           or an occurrence of, a variable on the RHS</span>
<a name="line-249"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnUnusedBinds</span> <span class='hs-varop'>$</span>
<a name="line-250"></a>          <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_wild_pat</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-251"></a>          <span class='hs-varid'>addWarn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unusedPatBindWarn</span> <span class='hs-varid'>bind'</span>
<a name="line-252"></a>
<a name="line-253"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`seq`</span> <span class='hs-comment'>-- See Note [Free-variable space leak]</span>
<a name="line-254"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-255"></a>
<a name="line-256"></a><span class='hs-definition'>rnBind</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> 
<a name="line-257"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_infix</span> 
<a name="line-258"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-259"></a>       <span class='hs-comment'>-- invariant: no free vars here when it's a FunBind</span>
<a name="line-260"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>plain_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>name</span>
<a name="line-261"></a>
<a name="line-262"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_fn</span> <span class='hs-varid'>plain_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-263"></a>				<span class='hs-comment'>-- bindSigTyVars tests for Opt_ScopedTyVars</span>
<a name="line-264"></a>			         <span class='hs-varid'>rnMatchGroup</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunRhs</span> <span class='hs-varid'>plain_name</span> <span class='hs-varid'>is_infix</span><span class='hs-layout'>)</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>
<a name="line-265"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>is_infix</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkPrecMatch</span> <span class='hs-varid'>plain_name</span> <span class='hs-varid'>matches'</span>
<a name="line-266"></a>
<a name="line-267"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-268"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-269"></a>	        <span class='hs-comment'>-- Keep locally-defined Names</span>
<a name="line-270"></a>		<span class='hs-comment'>-- As well as dependency analysis, we need these for the</span>
<a name="line-271"></a>		<span class='hs-comment'>-- MonoLocalBinds test in TcBinds.decideGeneralisationPlan</span>
<a name="line-272"></a>
<a name="line-273"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`seq`</span> <span class='hs-comment'>-- See Note [Free-variable space leak]</span>
<a name="line-274"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches'</span>
<a name="line-275"></a>	               <span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-276"></a>		  <span class='hs-keyglyph'>[</span><span class='hs-varid'>plain_name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-277"></a>      <span class='hs-layout'>}</span>
<a name="line-278"></a>
<a name="line-279"></a><span class='hs-definition'>rnBind</span> <span class='hs-sel'>_sig_fn</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span>
<a name="line-280"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span>
<a name="line-281"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_def</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span>
<a name="line-282"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-283"></a>       <span class='hs-comment'>-- invariant: no free vars here when it's a FunBind</span>
<a name="line-284"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>pattern_synonym_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PatternSynonyms</span>
<a name="line-285"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>pattern_synonym_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-varid'>patternSynonymErr</span><span class='hs-layout'>)</span>
<a name="line-286"></a>
<a name="line-287"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>details'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnPat</span> <span class='hs-conid'>PatSyn</span> <span class='hs-varid'>pat</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-288"></a>         <span class='hs-comment'>-- We check the 'RdrName's instead of the 'Name's</span>
<a name="line-289"></a>         <span class='hs-comment'>-- so that the binding locations are reported</span>
<a name="line-290"></a>         <span class='hs-comment'>-- from the left-hand side</span>
<a name="line-291"></a>        <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>details'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>details</span> <span class='hs-keyword'>of</span>
<a name="line-292"></a>               <span class='hs-conid'>PrefixPatSyn</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-293"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDupRdrNames</span> <span class='hs-varid'>vars</span>
<a name="line-294"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lookupVar</span> <span class='hs-varid'>vars</span>
<a name="line-295"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixPatSyn</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-296"></a>               <span class='hs-conid'>InfixPatSyn</span> <span class='hs-varid'>var1</span> <span class='hs-varid'>var2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-297"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDupRdrNames</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>var1</span><span class='hs-layout'>,</span> <span class='hs-varid'>var2</span><span class='hs-keyglyph'>]</span>
<a name="line-298"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>name1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVar</span> <span class='hs-varid'>var1</span>
<a name="line-299"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>name2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVar</span> <span class='hs-varid'>var2</span>
<a name="line-300"></a>                      <span class='hs-comment'>-- ; checkPrecMatch -- TODO</span>
<a name="line-301"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixPatSyn</span> <span class='hs-varid'>name1</span> <span class='hs-varid'>name2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name1</span><span class='hs-layout'>,</span> <span class='hs-varid'>name2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-302"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>details'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-303"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>dir'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dir</span> <span class='hs-keyword'>of</span>
<a name="line-304"></a>            <span class='hs-conid'>Unidirectional</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Unidirectional</span>
<a name="line-305"></a>            <span class='hs-conid'>ImplicitBidirectional</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>ImplicitBidirectional</span>
<a name="line-306"></a>
<a name="line-307"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-308"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span>
<a name="line-309"></a>	        <span class='hs-comment'>-- Keep locally-defined Names</span>
<a name="line-310"></a>		<span class='hs-comment'>-- As well as dependency analysis, we need these for the</span>
<a name="line-311"></a>		<span class='hs-comment'>-- MonoLocalBinds test in TcBinds.decideGeneralisationPlan</span>
<a name="line-312"></a>
<a name="line-313"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bind'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind</span><span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details'</span>
<a name="line-314"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_def</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'</span>
<a name="line-315"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir'</span>
<a name="line-316"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs'</span> <span class='hs-layout'>}</span>
<a name="line-317"></a>
<a name="line-318"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`seq`</span> <span class='hs-comment'>-- See Note [Free-variable space leak]</span>
<a name="line-319"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-320"></a>      <span class='hs-layout'>}</span>
<a name="line-321"></a>  <span class='hs-keyword'>where</span>
<a name="line-322"></a>    <span class='hs-varid'>lookupVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>lookupOccRn</span>
<a name="line-323"></a>
<a name="line-324"></a>    <span class='hs-varid'>patternSynonymErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-325"></a>    <span class='hs-varid'>patternSynonymErr</span>
<a name="line-326"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal pattern synonym declaration"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-327"></a>           <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XPatternSynonyms to enable this extension"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-328"></a>
<a name="line-329"></a>
<a name="line-330"></a><span class='hs-definition'>rnBind</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-331"></a>
<a name="line-332"></a><span class='hs-comment'>{-
<a name="line-333"></a>Note [Free-variable space leak]
<a name="line-334"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-335"></a>We have
<a name="line-336"></a>    fvs' = trim fvs
<a name="line-337"></a>and we seq fvs' before turning it as part of a record.
<a name="line-338"></a>
<a name="line-339"></a>The reason is that trim is sometimes something like
<a name="line-340"></a>    \xs -&gt; intersectNameSet (mkNameSet bound_names) xs
<a name="line-341"></a>and we don't want to retain the list bound_names. This showed up in
<a name="line-342"></a>trac ticket #1136.
<a name="line-343"></a>-}</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="depAnalBinds"></a><span class='hs-comment'>---------------------</span>
<a name="line-346"></a><span class='hs-definition'>depAnalBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Uses</span><span class='hs-layout'>)</span>
<a name="line-347"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-348"></a><span class='hs-comment'>-- Dependency analysis; this is important so that </span>
<a name="line-349"></a><span class='hs-comment'>-- unused-binding reporting is accurate</span>
<a name="line-350"></a><span class='hs-definition'>depAnalBinds</span> <span class='hs-varid'>binds_w_dus</span>
<a name="line-351"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>get_binds</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>get_du</span> <span class='hs-varid'>sccs</span><span class='hs-layout'>)</span>
<a name="line-352"></a>  <span class='hs-keyword'>where</span>
<a name="line-353"></a>    <span class='hs-varid'>sccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depAnal</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-354"></a>                   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-355"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>)</span>
<a name="line-356"></a>
<a name="line-357"></a>    <span class='hs-varid'>get_binds</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRecursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBag</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-358"></a>    <span class='hs-varid'>get_binds</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span>  <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Recursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>listToBag</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-359"></a>
<a name="line-360"></a>    <span class='hs-varid'>get_du</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-361"></a>    <span class='hs-varid'>get_du</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span>  <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-362"></a>	<span class='hs-keyword'>where</span>
<a name="line-363"></a>	  <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span><span class='hs-keyglyph'>]</span>
<a name="line-364"></a>	  <span class='hs-varid'>uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyNameSets</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>u</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds_w_dus</span><span class='hs-keyglyph'>]</span>
<a name="line-365"></a>
<a name="line-366"></a><span class='hs-comment'>---------------------</span>
<a name="line-367"></a><span class='hs-comment'>-- Bind the top-level forall'd type variables in the sigs.</span>
<a name="line-368"></a><span class='hs-comment'>-- E.g 	f :: a -&gt; a</span>
<a name="line-369"></a><span class='hs-comment'>--	f = rhs</span>
<a name="line-370"></a><span class='hs-comment'>--	The 'a' scopes over the rhs</span>
<a name="line-371"></a><span class='hs-comment'>--</span>
<a name="line-372"></a><span class='hs-comment'>-- NB: there'll usually be just one (for a function binding)</span>
<a name="line-373"></a><span class='hs-comment'>--     but if there are many, one may shadow the rest; too bad!</span>
<a name="line-374"></a><span class='hs-comment'>--	e.g  x :: [a] -&gt; [a]</span>
<a name="line-375"></a><span class='hs-comment'>--	     y :: [(a,a)] -&gt; a</span>
<a name="line-376"></a><span class='hs-comment'>--	     (x,y) = e</span>
<a name="line-377"></a><span class='hs-comment'>--      In e, 'a' will be in scope, and it'll be the one from 'y'!</span>
<a name="line-378"></a>
<a name="line-379"></a><a name="mkSigTvFn"></a><span class='hs-definition'>mkSigTvFn</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-380"></a><span class='hs-comment'>-- Return a lookup function that maps an Id Name to the names</span>
<a name="line-381"></a><span class='hs-comment'>-- of the type variables that should scope over its body..</span>
<a name="line-382"></a><span class='hs-definition'>mkSigTvFn</span> <span class='hs-varid'>sigs</span>
<a name="line-383"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-384"></a>  <span class='hs-keyword'>where</span>
<a name="line-385"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-386"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsLKiTyVarNames</span> <span class='hs-varid'>ltvs</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Kind variables and type variables</span>
<a name="line-387"></a>		    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>names</span>
<a name="line-388"></a>			           <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Explicit</span> <span class='hs-varid'>ltvs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sigs</span>
<a name="line-389"></a>                    <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span><span class='hs-keyglyph'>]</span>
<a name="line-390"></a>	<span class='hs-comment'>-- Note the pattern-match on "Explicit"; we only bind</span>
<a name="line-391"></a>	<span class='hs-comment'>-- type variables from signatures with an explicit top-level for-all</span>
</pre>\end{code}


@rnMethodBinds@ is used for the method bindings of a class and an instance
declaration.   Like @rnBinds@ but without dependency analysis.

NOTA BENE: we record each {\em binder} of a method-bind group as a free variable.
That's crucial when dealing with an instance decl:
\begin{verbatim}
	instance Foo (T a) where
	   op x = ...
\end{verbatim}
This might be the {\em sole} occurrence of @op@ for an imported class @Foo@,
and unless @op@ occurs we won't treat the type signature of @op@ in the class
decl for @Foo@ as a source of instance-decl gates.  But we should!  Indeed,
in many ways the @op@ in an instance decl is just like an occurrence, not
a binder.

\begin{code}
<pre><a name="line-1"></a><a name="rnMethodBinds"></a><span class='hs-definition'>rnMethodBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>			<span class='hs-comment'>-- Class name</span>
<a name="line-2"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Signature tyvar function</span>
<a name="line-3"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>RdrName</span>
<a name="line-4"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>rnMethodBinds</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>binds</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDupRdrNames</span> <span class='hs-varid'>meth_names</span>
<a name="line-8"></a>	     <span class='hs-comment'>-- Check that the same method is not given twice in the</span>
<a name="line-9"></a>	     <span class='hs-comment'>-- same instance decl	instance C T where</span>
<a name="line-10"></a>	     <span class='hs-comment'>--			      f x = ...</span>
<a name="line-11"></a>	     <span class='hs-comment'>--			      g y = ...</span>
<a name="line-12"></a>	     <span class='hs-comment'>--			      f x = ...</span>
<a name="line-13"></a>	     <span class='hs-comment'>-- We must use checkDupRdrNames because the Name of the</span>
<a name="line-14"></a>	     <span class='hs-comment'>-- method is the Name of the class selector, whose SrcSpan</span>
<a name="line-15"></a>	     <span class='hs-comment'>-- points to the class declaration; and we use rnMethodBinds</span>
<a name="line-16"></a>	     <span class='hs-comment'>-- for instance decls too</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span> 
<a name="line-20"></a>    <span class='hs-varid'>meth_names</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectMethodBinders</span> <span class='hs-varid'>binds</span>
<a name="line-21"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bind</span>
<a name="line-22"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_bind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMethodBind</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>sig_fn</span> <span class='hs-varid'>bind</span>
<a name="line-23"></a>	    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_bind</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="rnMethodBind"></a><span class='hs-definition'>rnMethodBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-26"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-27"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBindLR</span> <span class='hs-conid'>RdrName</span> <span class='hs-conid'>RdrName</span>
<a name="line-28"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBindLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-definition'>rnMethodBind</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>sig_fn</span> 
<a name="line-30"></a>             <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_infix</span> 
<a name="line-31"></a>				  <span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-33"></a>    <span class='hs-varid'>sel_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupInstDeclBndr</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"method"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-34"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>plain_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>sel_name</span>
<a name="line-35"></a>        <span class='hs-comment'>-- We use the selector name as the binder</span>
<a name="line-36"></a>
<a name="line-37"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_fn</span> <span class='hs-varid'>plain_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-38"></a>                          <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnMatch</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunRhs</span> <span class='hs-varid'>plain_name</span> <span class='hs-varid'>is_infix</span><span class='hs-layout'>)</span> <span class='hs-varid'>rnLExpr</span><span class='hs-layout'>)</span> <span class='hs-varid'>matches</span>
<a name="line-39"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>new_group</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMatchGroup</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>new_matches</span>
<a name="line-40"></a>
<a name="line-41"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>is_infix</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkPrecMatch</span> <span class='hs-varid'>plain_name</span> <span class='hs-varid'>new_group</span>
<a name="line-42"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sel_name</span> 
<a name="line-43"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_group</span>
<a name="line-44"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-45"></a>             <span class='hs-varid'>fvs</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>plain_name</span><span class='hs-layout'>)</span>
<a name="line-46"></a>        <span class='hs-comment'>-- The 'fvs' field isn't used for method binds</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-comment'>-- Can't handle method pattern-bindings which bind multiple methods.</span>
<a name="line-49"></a><span class='hs-definition'>rnMethodBind</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-50"></a>    <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>methodBindErr</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-51"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>rnMethodBind</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnMethodBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
</pre>\end{code}



%************************************************************************
%*									*
\subsubsection[dep-Sigs]{Signatures (and user-pragmas for values)}
%*									*
%************************************************************************

@renameSigs@ checks for:
\begin{enumerate}
\item more than one sig for one thing;
\item signatures given for things not bound here;
\end{enumerate}
%
At the moment we don't gather free-var info from the types in
signatures.  We'd only need this if we wanted to report unused tyvars.

\begin{code}
<pre><a name="line-1"></a><a name="renameSigs"></a><span class='hs-definition'>renameSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span> 
<a name="line-2"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-comment'>-- Renames the signatures and performs error checks</span>
<a name="line-5"></a><span class='hs-definition'>renameSigs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sigs</span> 
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>dupSigDeclErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>findDupSigs</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkDupMinimalSigs</span> <span class='hs-varid'>sigs</span>
<a name="line-9"></a>
<a name="line-10"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocFstM</span> <span class='hs-layout'>(</span><span class='hs-varid'>renameSig</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span>
<a name="line-11"></a>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>good_sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bad_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>okHsSig</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs'</span>
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>misplacedSigErr</span> <span class='hs-varid'>bad_sigs</span>		 <span class='hs-comment'>-- Misplaced</span>
<a name="line-14"></a>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>good_sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-comment'>----------------------</span>
<a name="line-18"></a><span class='hs-comment'>-- We use lookupSigOccRn in the signatures, which is a little bit unsatisfactory</span>
<a name="line-19"></a><span class='hs-comment'>-- because this won't work for:</span>
<a name="line-20"></a><span class='hs-comment'>--	instance Foo T where</span>
<a name="line-21"></a><span class='hs-comment'>--	  {-# INLINE op #-}</span>
<a name="line-22"></a><span class='hs-comment'>--	  Baz.op = ...</span>
<a name="line-23"></a><span class='hs-comment'>-- We'll just rename the INLINE prag to refer to whatever other 'op'</span>
<a name="line-24"></a><span class='hs-comment'>-- is in scope.  (I'm assuming that Baz.op isn't in scope unqualified.)</span>
<a name="line-25"></a><span class='hs-comment'>-- Doesn't seem worth much trouble to sort this.</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="renameSig"></a><span class='hs-definition'>renameSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Sig</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-comment'>-- FixitySig is renamed elsewhere.</span>
<a name="line-29"></a><span class='hs-definition'>renameSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>	  <span class='hs-comment'>-- Actually this never occurs</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>new_vs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSigOccRn</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-34"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_sig_bndrs</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-35"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>new_vs</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>defaultSigs_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DefaultSignatures</span>
<a name="line-39"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>defaultSigs_on</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultSigErr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSigOccRn</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-41"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_sig_bndrs</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-42"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-definition'>renameSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-conid'>SpecInstSigCtx</span> <span class='hs-varid'>ty</span>
<a name="line-46"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-comment'>-- {-# SPECIALISE #-} pragmas can refer to imported Ids</span>
<a name="line-49"></a><span class='hs-comment'>-- so, in the top-level case (when mb_names is Nothing)</span>
<a name="line-50"></a><span class='hs-comment'>-- we use lookupOccRn.  If there's both an imported and a local 'f'</span>
<a name="line-51"></a><span class='hs-comment'>-- then the SPECIALISE pragma is ambiguous, unlike all other signatures</span>
<a name="line-52"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span> 
<a name="line-54"></a>                     <span class='hs-conid'>TopSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupLocatedOccRn</span> <span class='hs-varid'>v</span>
<a name="line-55"></a>                     <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupSigOccRn</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>v</span>
<a name="line-56"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-57"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>inl</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>v</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSigOccRn</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>v</span>
<a name="line-61"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-varid'>v</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>new_v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSigOccRn</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>v</span>
<a name="line-65"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-varid'>new_v</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-varid'>bf</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_bf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSigOccRn</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>bf</span>
<a name="line-69"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-varid'>new_bf</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-definition'>renameSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-varid'>v</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>req</span><span class='hs-layout'>)</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSigOccRn</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>v</span>
<a name="line-73"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-74"></a>            <span class='hs-varid'>rn_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsSigType</span> <span class='hs-varid'>doc</span>
<a name="line-75"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_type</span> <span class='hs-varid'>ty</span>
<a name="line-76"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>of</span>
<a name="line-77"></a>            <span class='hs-conid'>PrefixPatSyn</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-78"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unzip</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>rn_type</span> <span class='hs-varid'>tys</span>
<a name="line-79"></a>                   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixPatSyn</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-80"></a>            <span class='hs-conid'>InfixPatSyn</span> <span class='hs-varid'>left</span> <span class='hs-varid'>right</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-81"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>left'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_type</span> <span class='hs-varid'>left</span>
<a name="line-82"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>right'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_type</span> <span class='hs-varid'>right</span>
<a name="line-83"></a>                   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixPatSyn</span> <span class='hs-varid'>left'</span> <span class='hs-varid'>right'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>
<a name="line-84"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>prov'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSigCtx</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>prov</span>
<a name="line-85"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>req'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSigCtx</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>req</span>
<a name="line-86"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs4</span><span class='hs-keyglyph'>]</span>
<a name="line-87"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>prov'</span> <span class='hs-varid'>req'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="ppr_sig_bndrs"></a><span class='hs-definition'>ppr_sig_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-90"></a><span class='hs-definition'>ppr_sig_bndrs</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="okHsSig"></a><span class='hs-definition'>okHsSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LSig</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-93"></a><span class='hs-definition'>okHsSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> 
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-95"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-96"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-97"></a>
<a name="line-98"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-99"></a>
<a name="line-100"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopSigCtxt</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-101"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>PatSynSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-102"></a>
<a name="line-103"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-104"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-105"></a>
<a name="line-106"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-107"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-108"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-109"></a>
<a name="line-110"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsBootCtxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-111"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-112"></a>
<a name="line-113"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-114"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>LocalBindCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-115"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-116"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-117"></a>
<a name="line-118"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-119"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-120"></a>
<a name="line-121"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-122"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>MinimalSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="findDupSigs"></a><span class='hs-comment'>-------------------</span>
<a name="line-125"></a><span class='hs-definition'>findDupSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-126"></a><span class='hs-comment'>-- Check for duplicates on RdrName version, </span>
<a name="line-127"></a><span class='hs-comment'>-- because renamed version has unboundName for</span>
<a name="line-128"></a><span class='hs-comment'>-- not-in-scope binders, which gives bogus dup-sig errors</span>
<a name="line-129"></a><span class='hs-comment'>-- NB: in a class decl, a 'generic' sig is not considered </span>
<a name="line-130"></a><span class='hs-comment'>--     equal to an ordinary sig, so we allow, say</span>
<a name="line-131"></a><span class='hs-comment'>--     	     class C a where</span>
<a name="line-132"></a><span class='hs-comment'>--	       op :: a -&gt; a</span>
<a name="line-133"></a><span class='hs-comment'>--             default op :: Eq a =&gt; a -&gt; a</span>
<a name="line-134"></a><span class='hs-definition'>findDupSigs</span> <span class='hs-varid'>sigs</span>
<a name="line-135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDupsEq</span> <span class='hs-varid'>matching_sig</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>expand_sig</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-136"></a>  <span class='hs-keyword'>where</span>
<a name="line-137"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixitySig</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-139"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span>  <span class='hs-varid'>ns</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-140"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-141"></a>    <span class='hs-varid'>expand_sig</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-142"></a>
<a name="line-143"></a>    <span class='hs-varid'>matching_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n1</span><span class='hs-layout'>,</span><span class='hs-varid'>sig1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n2</span><span class='hs-layout'>,</span><span class='hs-varid'>sig2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>mtch</span> <span class='hs-varid'>sig1</span> <span class='hs-varid'>sig2</span>
<a name="line-144"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-145"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>InlineSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-146"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-147"></a>    <span class='hs-varid'>mtch</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-148"></a>    <span class='hs-varid'>mtch</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="checkDupMinimalSigs"></a><span class='hs-comment'>-- Warn about multiple MINIMAL signatures</span>
<a name="line-151"></a><span class='hs-definition'>checkDupMinimalSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-152"></a><span class='hs-definition'>checkDupMinimalSigs</span> <span class='hs-varid'>sigs</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isMinimalLSig</span> <span class='hs-varid'>sigs</span> <span class='hs-keyword'>of</span>
<a name="line-154"></a>      <span class='hs-varid'>minSigs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dupMinimalSigErr</span> <span class='hs-varid'>minSigs</span>
<a name="line-155"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Match}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnMatchGroup"></a><span class='hs-definition'>rnMatchGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>rnMatchGroup</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>empty_case_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_EmptyCase</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ms</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>empty_case_ok</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyCaseErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnMatch</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMatchGroup</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>new_ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="rnMatch"></a><span class='hs-definition'>rnMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span>
<a name="line-12"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LMatch</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LMatch</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>rnMatch</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnMatch'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="rnMatch'"></a><span class='hs-definition'>rnMatch'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span> 
<a name="line-18"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Match</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-definition'>rnMatch'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>match</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>maybe_rhs_sig</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Result type signatures are no longer supported</span>
<a name="line-23"></a>	  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_rhs_sig</span> <span class='hs-keyword'>of</span>	
<a name="line-24"></a>	        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-25"></a>	        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>resSigErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>match</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a>	       <span class='hs-comment'>-- Now the main event</span>
<a name="line-28"></a>	       <span class='hs-comment'>-- note that there are no local ficity decls for matches</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>rnPats</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pats</span>	<span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pats'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-30"></a>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>grhss_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnGRHSs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>grhss</span>
<a name="line-31"></a>
<a name="line-32"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>pats'</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>grhss_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="emptyCaseErr"></a><span class='hs-definition'>emptyCaseErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-35"></a><span class='hs-definition'>emptyCaseErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Empty list of alternatives in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_ctxt</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use EmptyCase to allow this"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>pp_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-39"></a>                <span class='hs-conid'>CaseAlt</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"case expression"</span><span class='hs-layout'>)</span>
<a name="line-40"></a>                <span class='hs-conid'>LambdaExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"\\case expression"</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(unexpected)"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprMatchContextNoun</span> <span class='hs-varid'>ctxt</span>
<a name="line-42"></a> 
<a name="line-43"></a>
<a name="line-44"></a><a name="resSigErr"></a><span class='hs-definition'>resSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Match</span> <span class='hs-conid'>RdrName</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> 
<a name="line-45"></a><span class='hs-definition'>resSigErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>match</span> <span class='hs-varid'>ty</span>
<a name="line-46"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal result type signature"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-47"></a>	  <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Result signatures are no longer supported in pattern matches"</span><span class='hs-layout'>)</span>
<a name="line-48"></a> 	  <span class='hs-layout'>,</span> <span class='hs-varid'>pprMatchInCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>match</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsubsection{Guarded right-hand sides (GRHSs)}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnGRHSs"></a><span class='hs-definition'>rnGRHSs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span> 
<a name="line-2"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>rnGRHSs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span>	<span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-7"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>grhss'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvGRHSs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnGRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span> <span class='hs-varid'>grhss</span>
<a name="line-8"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss'</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvGRHSs</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="rnGRHS"></a><span class='hs-definition'>rnGRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span> 
<a name="line-11"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LGRHS</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LGRHS</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>rnGRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnGRHS'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="rnGRHS'"></a><span class='hs-definition'>rnGRHS'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span> 
<a name="line-17"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHS</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>rnGRHS'</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>guards</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>pattern_guards_allowed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PatternGuards</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>guards'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatGuard</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>guards</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-23"></a>				    <span class='hs-varid'>rnBody</span> <span class='hs-varid'>rhs</span>
<a name="line-24"></a>
<a name="line-25"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>pattern_guards_allowed</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_standard_guard</span> <span class='hs-varid'>guards'</span><span class='hs-layout'>)</span>
<a name="line-26"></a>	  	 <span class='hs-layout'>(</span><span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonStdGuardErr</span> <span class='hs-varid'>guards'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>guards'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>  <span class='hs-keyword'>where</span>
<a name="line-30"></a>	<span class='hs-comment'>-- Standard Haskell 1.4 guards are just a single boolean</span>
<a name="line-31"></a>	<span class='hs-comment'>-- expression, rather than a list of qualifiers as in the</span>
<a name="line-32"></a>	<span class='hs-comment'>-- Glasgow extension</span>
<a name="line-33"></a>    <span class='hs-varid'>is_standard_guard</span> <span class='hs-conid'>[]</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-34"></a>    <span class='hs-varid'>is_standard_guard</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-35"></a>    <span class='hs-varid'>is_standard_guard</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection{Error messages}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dupSigDeclErr"></a><span class='hs-definition'>dupSigDeclErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>dupSigDeclErr</span> <span class='hs-varid'>pairs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what_it_is</span> 
<a name="line-5"></a>           <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"s for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-6"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>what_it_is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsSigDoc</span> <span class='hs-varid'>sig</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>dupSigDeclErr</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dupSigDeclErr"</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="misplacedSigErr"></a><span class='hs-definition'>misplacedSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-13"></a><span class='hs-definition'>misplacedSigErr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-15"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Misplaced"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsSigDoc</span> <span class='hs-varid'>sig</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="defaultSigErr"></a><span class='hs-definition'>defaultSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-18"></a><span class='hs-definition'>defaultSigErr</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected default signature:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>                              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use DefaultSignatures to enable default signatures"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="methodBindErr"></a><span class='hs-definition'>methodBindErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBindLR</span> <span class='hs-conid'>RdrName</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-23"></a><span class='hs-definition'>methodBindErr</span> <span class='hs-varid'>mbind</span>
<a name="line-24"></a> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Pattern bindings (except simple variables) not allowed in instance declarations"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mbind</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="bindsInHsBootFile"></a><span class='hs-definition'>bindsInHsBootFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBindsLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-28"></a><span class='hs-definition'>bindsInHsBootFile</span> <span class='hs-varid'>mbinds</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bindings in hs-boot files are not allowed"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mbinds</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="nonStdGuardErr"></a><span class='hs-definition'>nonStdGuardErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-33"></a><span class='hs-definition'>nonStdGuardErr</span> <span class='hs-varid'>guards</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"accepting non-standard pattern guards (use PatternGuards to suppress this message)"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>       <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>interpp'SP</span> <span class='hs-varid'>guards</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="unusedPatBindWarn"></a><span class='hs-definition'>unusedPatBindWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-38"></a><span class='hs-definition'>unusedPatBindWarn</span> <span class='hs-varid'>bind</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"This pattern-binding binds no variables:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="dupMinimalSigErr"></a><span class='hs-definition'>dupMinimalSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-43"></a><span class='hs-definition'>dupMinimalSigErr</span> <span class='hs-varid'>sigs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-45"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Multiple minimal complete definitions"</span><span class='hs-layout'>)</span>
<a name="line-46"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getLoc</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-47"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Combine alternative minimal complete definitions with `|'"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-48"></a><span class='hs-definition'>dupMinimalSigErr</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dupMinimalSigErr"</span>
</pre>\end{code}
</body>
</html>
