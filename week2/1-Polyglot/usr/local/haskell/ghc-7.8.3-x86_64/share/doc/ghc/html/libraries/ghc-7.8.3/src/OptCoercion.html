<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/OptCoercion.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>OptCoercion</span> <span class='hs-layout'>(</span> <span class='hs-varid'>optCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkAxInstCo</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> 
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>exactTyVarsOfType</span> <span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>flattenTys</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>opt_NoOptCoercion</span> <span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                 Optimising coercions									
%*                                                                      *
%************************************************************************

Note [Subtle shadowing in coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Supose we optimising a coercion
    optCoercion (forall (co_X5:t1~t2). ...co_B1...)
The co_X5 is a wild-card; the bound variable of a coercion for-all
should never appear in the body of the forall. Indeed we often
write it like this
    optCoercion ( (t1~t2) => ...co_B1... )

Just because it's a wild-card doesn't mean we are free to choose
whatever variable we like.  For example it'd be wrong for optCoercion
to return
   forall (co_B1:t1~t2). ...co_B1...
because now the co_B1 (which is really free) has been captured, and
subsequent substitutions will go wrong.  That's why we can't use
mkCoPredTy in the ForAll case, where this note appears.  

\begin{code}
<pre><a name="line-1"></a><a name="optCoercion"></a><span class='hs-definition'>optCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span>
<a name="line-2"></a><span class='hs-comment'>-- ^ optCoercion applies a substitution to a coercion, </span>
<a name="line-3"></a><span class='hs-comment'>--   *and* optimises it to reduce its size</span>
<a name="line-4"></a><span class='hs-definition'>optCoercion</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span> 
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_NoOptCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-conid'>False</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>co</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="NormalCo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>NormalCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>
<a name="line-9"></a>  <span class='hs-comment'>-- Invariants: </span>
<a name="line-10"></a>  <span class='hs-comment'>--  * The substitution has been fully applied</span>
<a name="line-11"></a>  <span class='hs-comment'>--  * For trans coercions (co1 `trans` co2)</span>
<a name="line-12"></a>  <span class='hs-comment'>--       co1 is not a trans, and neither co1 nor co2 is identity</span>
<a name="line-13"></a>  <span class='hs-comment'>--  * If the coercion is the identity, it has no CoVars of CoTyCons in it (just types)</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="NormalNonIdCo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>NormalNonIdCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NormalCo</span>  <span class='hs-comment'>-- Extra invariant: not the identity</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="opt_co"></a><span class='hs-definition'>opt_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>opt_co'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span>
<a name="line-18"></a>       		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>	       <span class='hs-comment'>-- True &lt;=&gt; return (sym co)</span>
<a name="line-19"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- Nothing &lt;=&gt; don't change; otherwise, change</span>
<a name="line-20"></a>                               <span class='hs-comment'>-- INVARIANT: the change is always a *downgrade*</span>
<a name="line-21"></a>       		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-22"></a>       		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span>	
<a name="line-23"></a><span class='hs-definition'>opt_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co'</span> 
<a name="line-24"></a><span class='hs-comment'>{-
<a name="line-25"></a>opt_co env sym co
<a name="line-26"></a> = pprTrace "opt_co {" (ppr sym &lt;+&gt; ppr co $$ ppr env) $
<a name="line-27"></a>   co1 `seq`
<a name="line-28"></a>   pprTrace "opt_co done }" (ppr co1) $
<a name="line-29"></a>   (WARN( not same_co_kind, ppr co  &lt;+&gt; dcolon &lt;+&gt; pprEqPred (Pair s1 t1)
<a name="line-30"></a>                         $$ ppr co1 &lt;+&gt; dcolon &lt;+&gt; pprEqPred (Pair s2 t2) )
<a name="line-31"></a>    WARN( not (coreEqCoercion co1 simple_result),
<a name="line-32"></a>           (text "env=" &lt;+&gt; ppr env) $$
<a name="line-33"></a>           (text "input=" &lt;+&gt; ppr co) $$
<a name="line-34"></a>           (text "simple=" &lt;+&gt; ppr simple_result) $$
<a name="line-35"></a>           (text "opt=" &lt;+&gt; ppr co1) )
<a name="line-36"></a>   co1)
<a name="line-37"></a> where
<a name="line-38"></a>   co1 = opt_co' env sym co
<a name="line-39"></a>   same_co_kind = s1 `eqType` s2 &amp;&amp; t1 `eqType` t2
<a name="line-40"></a>   Pair s t = coercionKind (substCo env co)
<a name="line-41"></a>   (s1,t1) | sym = (t,s)
<a name="line-42"></a>           | otherwise = (s,t)
<a name="line-43"></a>   Pair s2 t2 = coercionKind co1
<a name="line-44"></a>
<a name="line-45"></a>   simple_result | sym = mkSymCo (substCo env co)
<a name="line-46"></a>                 | otherwise = substCo env co
<a name="line-47"></a>-}</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="opt_co'"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mrole</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>mrole</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Phantom</span> 
<a name="line-52"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Phantom</span>
<a name="line-53"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>sym</span>
<a name="line-55"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>opt_univ</span> <span class='hs-varid'>env</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty1</span>
<a name="line-56"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>opt_univ</span> <span class='hs-varid'>env</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>sym</span><span class='hs-layout'>)</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co</span>
<a name="line-59"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mrole</span> <span class='hs-keyword'>of</span>
<a name="line-61"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span>  <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-62"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r'</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span><span class='hs-layout'>)</span>
<a name="line-63"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r'</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span>   <span class='hs-varid'>co1</span><span class='hs-layout'>)</span>
<a name="line-65"></a>                                                <span class='hs-layout'>(</span><span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-68"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_co</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-69"></a>     <span class='hs-comment'>-- Use the "mk" functions to check for nested Refls</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupCoVar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cv</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapCvSubstEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co</span>
<a name="line-74"></a>
<a name="line-75"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInScope</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCvInScope</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv1</span> <span class='hs-layout'>)</span> <span class='hs-varid'>wrapRole</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>cv_role</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapSym</span> <span class='hs-varid'>sym</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv1</span><span class='hs-layout'>)</span>
<a name="line-77"></a>                <span class='hs-comment'>-- cv1 might have a substituted kind!</span>
<a name="line-78"></a>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"opt_co: not in scope:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-80"></a>                <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>)</span>
<a name="line-81"></a>                <span class='hs-varid'>wrapRole</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>cv_role</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapSym</span> <span class='hs-varid'>sym</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>cv_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-85"></a>    <span class='hs-comment'>-- Do *not* push sym inside top-level axioms</span>
<a name="line-86"></a>    <span class='hs-comment'>-- e.g. if g is a top-level axiom</span>
<a name="line-87"></a>    <span class='hs-comment'>--   g a : f a ~ a</span>
<a name="line-88"></a>    <span class='hs-comment'>-- then (sym (g ty)) /= g (sym ty) !!</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapRole</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-90"></a>    <span class='hs-varid'>wrapSym</span> <span class='hs-varid'>sym</span> <span class='hs-varop'>$</span>
<a name="line-91"></a>    <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-conid'>False</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-92"></a>      <span class='hs-comment'>-- Note that the_co does *not* have sym pushed into it</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>oty1</span> <span class='hs-varid'>oty2</span><span class='hs-layout'>)</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_univ</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-96"></a>  <span class='hs-keyword'>where</span>
<a name="line-97"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>sym</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>oty2</span><span class='hs-layout'>,</span><span class='hs-varid'>oty1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>oty1</span><span class='hs-layout'>,</span><span class='hs-varid'>oty2</span><span class='hs-layout'>)</span>
<a name="line-98"></a>    <span class='hs-varid'>role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mrole</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>r</span>
<a name="line-99"></a>
<a name="line-100"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sym</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_trans</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>opt_co2</span> <span class='hs-varid'>opt_co1</span>   <span class='hs-comment'>-- sym (g `o` h) = sym h `o` sym g</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_trans</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>opt_co1</span> <span class='hs-varid'>opt_co2</span>
<a name="line-103"></a>  <span class='hs-keyword'>where</span>
<a name="line-104"></a>    <span class='hs-varid'>opt_co1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co1</span>
<a name="line-105"></a>    <span class='hs-varid'>opt_co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co2</span>
<a name="line-106"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCvInScope</span> <span class='hs-varid'>env</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-comment'>-- NthCo roles are fiddly!</span>
<a name="line-109"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-varid'>getNth</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-111"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-sel'>_tc</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co'</span>
<a name="line-113"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span>   <span class='hs-comment'>-- Not synonym families</span>
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-115"></a>    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-sel'>_tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>)</span>
<a name="line-116"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>resultCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>n</span>
<a name="line-117"></a>        <span class='hs-varid'>resultRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>resultCo</span> <span class='hs-keyword'>in</span>
<a name="line-118"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>mrole</span><span class='hs-layout'>,</span> <span class='hs-varid'>resultRole</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-119"></a>        <span class='hs-comment'>-- if we just need an R coercion, try to propagate the SubCo again:</span>
<a name="line-120"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>opt_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapCvSubstEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>resultCo</span>
<a name="line-121"></a>      <span class='hs-keyword'>_</span>                                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>resultCo</span>
<a name="line-122"></a>
<a name="line-123"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-124"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap_role</span> <span class='hs-varop'>$</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co'</span>
<a name="line-125"></a>
<a name="line-126"></a>  <span class='hs-keyword'>where</span>
<a name="line-127"></a>    <span class='hs-varid'>wrap_role</span> <span class='hs-varid'>wrapped</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapRole</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>wrapped</span><span class='hs-layout'>)</span> <span class='hs-varid'>wrapped</span>
<a name="line-128"></a>
<a name="line-129"></a>    <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-130"></a>    <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole'</span> <span class='hs-varid'>co</span>
<a name="line-131"></a>    <span class='hs-varid'>mrole'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mrole</span> <span class='hs-keyword'>of</span>
<a name="line-132"></a>               <span class='hs-conid'>Just</span> <span class='hs-conid'>Representational</span>
<a name="line-133"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nthRole</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-134"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Representational</span>
<a name="line-135"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pr_co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>pr_co</span><span class='hs-layout'>)</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pr_co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppCo_maybe</span> <span class='hs-varid'>co'</span>
<a name="line-141"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>mrole</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Representational</span>
<a name="line-142"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>opt_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapCvSubstEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>pr_co</span><span class='hs-layout'>)</span>
<a name="line-143"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>pr_co</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapRole</span> <span class='hs-varid'>mrole</span> <span class='hs-conid'>Nominal</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co'</span>
<a name="line-146"></a>  <span class='hs-keyword'>where</span>
<a name="line-147"></a>    <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>co</span>
<a name="line-148"></a>
<a name="line-149"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-150"></a>    <span class='hs-comment'>-- See if the first arg is already a forall</span>
<a name="line-151"></a>    <span class='hs-comment'>-- ...then we can just extend the current substitution</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co_body</span>
<a name="line-154"></a>
<a name="line-155"></a>     <span class='hs-comment'>-- See if it is a forall after optimization</span>
<a name="line-156"></a>     <span class='hs-comment'>-- If so, do an inefficient one-variable substitution</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllCo_maybe</span> <span class='hs-varid'>co'</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoWithTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCvInScope</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co'_body</span>   
<a name="line-159"></a>
<a name="line-160"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varid'>co'</span> <span class='hs-varid'>ty'</span>
<a name="line-161"></a>  <span class='hs-keyword'>where</span>
<a name="line-162"></a>    <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-varid'>co</span>
<a name="line-163"></a>    <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-comment'>-- XXX: We could add another field to CoAxiomRule that</span>
<a name="line-168"></a><span class='hs-comment'>-- would allow us to do custom simplifications.</span>
<a name="line-169"></a><span class='hs-definition'>opt_co'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-170"></a>  <span class='hs-varid'>wrapRole</span> <span class='hs-varid'>mrole</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-171"></a>    <span class='hs-varid'>wrapSym</span> <span class='hs-varid'>sym</span> <span class='hs-varop'>$</span>
<a name="line-172"></a>    <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-173"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_co</span> <span class='hs-varid'>env</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrAsmpRoles</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a>
<a name="line-176"></a>
<a name="line-177"></a><a name="opt_univ"></a><span class='hs-comment'>-------------</span>
<a name="line-178"></a><span class='hs-definition'>opt_univ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-179"></a><span class='hs-definition'>opt_univ</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>oty1</span> <span class='hs-varid'>oty2</span>
<a name="line-180"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>oty1</span>
<a name="line-181"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>oty2</span>
<a name="line-182"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith3</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_univ</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>l1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>oty1</span>
<a name="line-186"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>l2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>oty2</span>
<a name="line-187"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>l1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>l2</span>   <span class='hs-comment'>-- kind(r1) == kind(r2) by consequence</span>
<a name="line-188"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>role'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>role</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyword'>in</span>
<a name="line-189"></a>       <span class='hs-comment'>-- role' is to comform to mkAppCo's precondition</span>
<a name="line-190"></a>    <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_univ</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_univ</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role'</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-191"></a>
<a name="line-192"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>oty1</span>
<a name="line-193"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>oty2</span>
<a name="line-194"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span>  <span class='hs-comment'>-- rule out a weird unsafeCo</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-196"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ty1</span>
<a name="line-197"></a>        <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>in</span>
<a name="line-198"></a>    <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_univ</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapCvSubstEnv2</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-199"></a>
<a name="line-200"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-201"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>env</span> <span class='hs-varid'>oty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>env</span> <span class='hs-varid'>oty2</span><span class='hs-layout'>)</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="opt_transList"></a><span class='hs-comment'>-------------</span>
<a name="line-204"></a><span class='hs-definition'>opt_transList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NormalCo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NormalCo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NormalCo</span><span class='hs-keyglyph'>]</span>
<a name="line-205"></a><span class='hs-definition'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-206"></a>
<a name="line-207"></a><a name="opt_trans"></a><span class='hs-definition'>opt_trans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span>
<a name="line-208"></a><span class='hs-definition'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-209"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span>
<a name="line-210"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_trans1</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-211"></a>
<a name="line-212"></a><a name="opt_trans1"></a><span class='hs-definition'>opt_trans1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalNonIdCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span>
<a name="line-213"></a><span class='hs-comment'>-- First arg is not the identity</span>
<a name="line-214"></a><span class='hs-definition'>opt_trans1</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co1</span>
<a name="line-216"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_trans2</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-217"></a>
<a name="line-218"></a><a name="opt_trans2"></a><span class='hs-definition'>opt_trans2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalNonIdCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalNonIdCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalCo</span>
<a name="line-219"></a><span class='hs-comment'>-- Neither arg is the identity</span>
<a name="line-220"></a><span class='hs-definition'>opt_trans2</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1a</span> <span class='hs-varid'>co1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span>
<a name="line-221"></a>    <span class='hs-comment'>-- Don't know whether the sub-coercions are the identity</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1a</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1b</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>  
<a name="line-223"></a>
<a name="line-224"></a><span class='hs-definition'>opt_trans2</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> 
<a name="line-225"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-226"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-227"></a>
<a name="line-228"></a><span class='hs-definition'>opt_trans2</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co2a</span> <span class='hs-varid'>co2b</span><span class='hs-layout'>)</span>
<a name="line-229"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co1_2a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2a</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co1_2a</span>
<a name="line-231"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>co2b</span>
<a name="line-232"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>opt_trans1</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1_2a</span> <span class='hs-varid'>co2b</span>
<a name="line-233"></a>
<a name="line-234"></a><span class='hs-definition'>opt_trans2</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-236"></a>
<a name="line-237"></a><a name="opt_trans_rule"></a><span class='hs-comment'>------</span>
<a name="line-238"></a><span class='hs-comment'>-- Optimize coercions with a top-level use of transitivity.</span>
<a name="line-239"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalNonIdCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormalNonIdCo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>NormalCo</span>
<a name="line-240"></a>
<a name="line-241"></a><span class='hs-comment'>-- Push transitivity through matching destructors</span>
<a name="line-242"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>in_co1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_co2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-243"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>d2</span>
<a name="line-244"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`compatible_co`</span> <span class='hs-varid'>co2</span>
<a name="line-245"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"PushNth"</span> <span class='hs-varid'>in_co1</span> <span class='hs-varid'>in_co2</span> <span class='hs-varop'>$</span>
<a name="line-246"></a>    <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>d1</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-247"></a>
<a name="line-248"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>in_co1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_co2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>d2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-249"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>d2</span>
<a name="line-250"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`compatible_co`</span> <span class='hs-varid'>co2</span>
<a name="line-251"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"PushLR"</span> <span class='hs-varid'>in_co1</span> <span class='hs-varid'>in_co2</span> <span class='hs-varop'>$</span>
<a name="line-252"></a>    <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>d1</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-253"></a>
<a name="line-254"></a><span class='hs-comment'>-- Push transitivity inside instantiation</span>
<a name="line-255"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>in_co1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_co2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-256"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span>
<a name="line-257"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`compatible_co`</span> <span class='hs-varid'>co2</span>
<a name="line-258"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"TrPushInst"</span> <span class='hs-varid'>in_co1</span> <span class='hs-varid'>in_co2</span> <span class='hs-varop'>$</span>
<a name="line-259"></a>    <span class='hs-varid'>mkInstCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span>
<a name="line-260"></a> 
<a name="line-261"></a><span class='hs-comment'>-- Push transitivity down through matching top-level constructors.</span>
<a name="line-262"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>in_co1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_co2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-263"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> 
<a name="line-264"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span> <span class='hs-layout'>)</span>
<a name="line-265"></a>    <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"PushTyConApp"</span> <span class='hs-varid'>in_co1</span> <span class='hs-varid'>in_co2</span> <span class='hs-varop'>$</span>
<a name="line-266"></a>    <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-267"></a>
<a name="line-268"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>in_co1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1a</span> <span class='hs-varid'>co1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_co2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co2a</span> <span class='hs-varid'>co2b</span><span class='hs-layout'>)</span>
<a name="line-269"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"TrPushApp"</span> <span class='hs-varid'>in_co1</span> <span class='hs-varid'>in_co2</span> <span class='hs-varop'>$</span>
<a name="line-270"></a>    <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1a</span> <span class='hs-varid'>co2a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1b</span> <span class='hs-varid'>co2b</span><span class='hs-layout'>)</span>
<a name="line-271"></a>
<a name="line-272"></a><span class='hs-comment'>-- Eta rules</span>
<a name="line-273"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span>
<a name="line-274"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cos2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaTyConAppCo_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>co2</span>
<a name="line-275"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos2</span> <span class='hs-layout'>)</span>
<a name="line-276"></a>    <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"EtaCompL"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-277"></a>    <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-278"></a>
<a name="line-279"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-280"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaTyConAppCo_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>co1</span>
<a name="line-281"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos2</span> <span class='hs-layout'>)</span>
<a name="line-282"></a>    <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"EtaCompR"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-283"></a>    <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-284"></a>
<a name="line-285"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1a</span> <span class='hs-varid'>co1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span>
<a name="line-286"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co2a</span><span class='hs-layout'>,</span><span class='hs-varid'>co2b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaAppCo_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-287"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"EtaAppL"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-288"></a>    <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1a</span> <span class='hs-varid'>co2a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1b</span> <span class='hs-varid'>co2b</span><span class='hs-layout'>)</span>
<a name="line-289"></a>
<a name="line-290"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co2a</span> <span class='hs-varid'>co2b</span><span class='hs-layout'>)</span>
<a name="line-291"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1a</span><span class='hs-layout'>,</span><span class='hs-varid'>co1b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaAppCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"EtaAppR"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-293"></a>    <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1a</span> <span class='hs-varid'>co2a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1b</span> <span class='hs-varid'>co2b</span><span class='hs-layout'>)</span>
<a name="line-294"></a>
<a name="line-295"></a><span class='hs-comment'>-- Push transitivity inside forall</span>
<a name="line-296"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-297"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span><span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-298"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaForAllCo_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-299"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>r2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoWithTy</span> <span class='hs-varid'>is'</span> <span class='hs-varid'>tv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>r2</span>
<a name="line-300"></a>        <span class='hs-varid'>is'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>tv1</span>
<a name="line-301"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"EtaAllL"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-302"></a>    <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans2</span> <span class='hs-varid'>is'</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2'</span><span class='hs-layout'>)</span>
<a name="line-303"></a>
<a name="line-304"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllCo_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-305"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span><span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>etaForAllCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-306"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>r1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoWithTy</span> <span class='hs-varid'>is'</span> <span class='hs-varid'>tv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>r1</span>
<a name="line-307"></a>        <span class='hs-varid'>is'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>tv2</span>
<a name="line-308"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"EtaAllR"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-309"></a>    <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_trans2</span> <span class='hs-varid'>is'</span> <span class='hs-varid'>r1'</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-310"></a>
<a name="line-311"></a><span class='hs-comment'>-- Push transitivity inside axioms</span>
<a name="line-312"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-varid'>is</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-313"></a>
<a name="line-314"></a>  <span class='hs-comment'>-- TrPushSymAxR</span>
<a name="line-315"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sym</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co1_is_axiom_maybe</span>
<a name="line-316"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cos2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchAxiom</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>co2</span>
<a name="line-317"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sym</span>
<a name="line-318"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>newAxInst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span>
<a name="line-319"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkAxInstCo</span> <span class='hs-varid'>newAxInst</span>
<a name="line-320"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"TrPushSymAxR"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SymCo</span> <span class='hs-varid'>newAxInst</span>
<a name="line-321"></a>
<a name="line-322"></a>  <span class='hs-comment'>-- TrPushAxR</span>
<a name="line-323"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sym</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co1_is_axiom_maybe</span>
<a name="line-324"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cos2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchAxiom</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>co2</span>
<a name="line-325"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sym</span>
<a name="line-326"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>newAxInst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-327"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkAxInstCo</span> <span class='hs-varid'>newAxInst</span>
<a name="line-328"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"TrPushAxR"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>newAxInst</span>
<a name="line-329"></a>
<a name="line-330"></a>  <span class='hs-comment'>-- TrPushSymAxL</span>
<a name="line-331"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sym</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co2_is_axiom_maybe</span>
<a name="line-332"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchAxiom</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>sym</span><span class='hs-layout'>)</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>co1</span>
<a name="line-333"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>True</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sym</span>
<a name="line-334"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>newAxInst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-varid'>cos2</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-335"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkAxInstCo</span> <span class='hs-varid'>newAxInst</span>
<a name="line-336"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"TrPushSymAxL"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SymCo</span> <span class='hs-varid'>newAxInst</span>
<a name="line-337"></a>
<a name="line-338"></a>  <span class='hs-comment'>-- TrPushAxL  </span>
<a name="line-339"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sym</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co2_is_axiom_maybe</span>
<a name="line-340"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchAxiom</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>sym</span><span class='hs-layout'>)</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>co1</span>
<a name="line-341"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sym</span>
<a name="line-342"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>newAxInst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-343"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkAxInstCo</span> <span class='hs-varid'>newAxInst</span>
<a name="line-344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"TrPushAxL"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>newAxInst</span>
<a name="line-345"></a>
<a name="line-346"></a>  <span class='hs-comment'>-- TrPushAxSym/TrPushSymAx</span>
<a name="line-347"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sym1</span><span class='hs-layout'>,</span> <span class='hs-varid'>con1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co1_is_axiom_maybe</span>
<a name="line-348"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sym2</span><span class='hs-layout'>,</span> <span class='hs-varid'>con2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>co2_is_axiom_maybe</span>
<a name="line-349"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>con1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>con2</span>
<a name="line-350"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ind1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ind2</span>
<a name="line-351"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>sym1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>not</span> <span class='hs-varid'>sym2</span>
<a name="line-352"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>ind1</span>
<a name="line-353"></a>        <span class='hs-varid'>qtvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-354"></a>        <span class='hs-varid'>lhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxNthLHS</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>ind1</span>
<a name="line-355"></a>        <span class='hs-varid'>rhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchRHS</span> <span class='hs-varid'>branch</span>
<a name="line-356"></a>        <span class='hs-varid'>pivot_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exactTyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>sym2</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-357"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>pivot_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>qtvs</span>
<a name="line-358"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"TrPushAxSym"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-359"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>sym2</span>
<a name="line-360"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>liftCoSubstWith</span> <span class='hs-varid'>role</span> <span class='hs-varid'>qtvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-varid'>cos1</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span>  <span class='hs-comment'>-- TrPushAxSym</span>
<a name="line-361"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>liftCoSubstWith</span> <span class='hs-varid'>role</span> <span class='hs-varid'>qtvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_transList</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>  <span class='hs-comment'>-- TrPushSymAx</span>
<a name="line-362"></a>  <span class='hs-keyword'>where</span>
<a name="line-363"></a>    <span class='hs-varid'>co1_is_axiom_maybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isAxiom_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-364"></a>    <span class='hs-varid'>co2_is_axiom_maybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isAxiom_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-365"></a>    <span class='hs-varid'>role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co1</span> <span class='hs-comment'>-- should be the same as coercionRole co2!</span>
<a name="line-366"></a>
<a name="line-367"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>	<span class='hs-comment'>-- Identity rule</span>
<a name="line-368"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co1</span>
<a name="line-369"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Pair</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co2</span>
<a name="line-370"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span>
<a name="line-371"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fireTransRule</span> <span class='hs-str'>"RedTypeDirRefl"</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>$</span>
<a name="line-372"></a>    <span class='hs-conid'>Refl</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-373"></a>
<a name="line-374"></a><span class='hs-definition'>opt_trans_rule</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-375"></a>
<a name="line-376"></a><a name="fireTransRule"></a><span class='hs-definition'>fireTransRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-377"></a><span class='hs-definition'>fireTransRule</span> <span class='hs-sel'>_rule</span> <span class='hs-sel'>_co1</span> <span class='hs-sel'>_co2</span> <span class='hs-varid'>res</span>
<a name="line-378"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace ("Trans rule fired: " ++ _rule) (vcat [ppr _co1, ppr _co2, ppr res]) $</span>
<a name="line-379"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>res</span>
<a name="line-380"></a>
</pre>\end{code}

Note [Conflict checking with AxiomInstCo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following type family and axiom:

type family Equal (a :: k) (b :: k) :: Bool
type instance where
  Equal a a = True
  Equal a b = False
--
Equal :: forall k::BOX. k -> k -> Bool
axEqual :: { forall k::BOX. forall a::k. Equal k a a ~ True
           ; forall k::BOX. forall a::k. forall b::k. Equal k a b ~ False }

We wish to disallow (axEqual[1] <*> <Int> <Int). (Recall that the index is 0-based,
so this is the second branch of the axiom.) The problem is that, on the surface, it
seems that (axEqual[1] <*> <Int> <Int>) :: (Equal * Int Int ~ False) and that all is
OK. But, all is not OK: we want to use the first branch of the axiom in this case,
not the second. The problem is that the parameters of the first branch can unify with
the supplied coercions, thus meaning that the first branch should be taken. See also
Note [Branched instance checking] in types/FamInstEnv.lhs.

\begin{code}
<pre><a name="line-1"></a><a name="checkAxInstCo"></a><span class='hs-comment'>-- | Check to make sure that an AxInstCo is internally consistent.</span>
<a name="line-2"></a><span class='hs-comment'>-- Returns the conflicting branch, if it exists</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [Conflict checking with AxiomInstCo]</span>
<a name="line-4"></a><span class='hs-definition'>checkAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-5"></a><span class='hs-comment'>-- defined here to avoid dependencies in Coercion</span>
<a name="line-6"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-7"></a><span class='hs-comment'>-- See Note [GHC Formalism] in CoreLint</span>
<a name="line-8"></a><span class='hs-definition'>checkAxInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span>
<a name="line-10"></a>        <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-11"></a>        <span class='hs-varid'>incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchIncomps</span> <span class='hs-varid'>branch</span>
<a name="line-12"></a>        <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span> 
<a name="line-13"></a>        <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipOpenTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-14"></a>        <span class='hs-varid'>target</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>branch</span><span class='hs-layout'>)</span>
<a name="line-15"></a>        <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span>
<a name="line-16"></a>                   <span class='hs-varid'>unionVarSets</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coAxBranchLHS</span><span class='hs-layout'>)</span> <span class='hs-varid'>incomps</span><span class='hs-layout'>)</span>
<a name="line-17"></a>        <span class='hs-varid'>flattened_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>target</span> <span class='hs-keyword'>in</span>
<a name="line-18"></a>    <span class='hs-varid'>check_no_conflict</span> <span class='hs-varid'>flattened_target</span> <span class='hs-varid'>incomps</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>check_no_conflict</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-21"></a>    <span class='hs-varid'>check_no_conflict</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-22"></a>    <span class='hs-varid'>check_no_conflict</span> <span class='hs-varid'>flat</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs_incomp</span> <span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-23"></a>         <span class='hs-comment'>-- See Note [Apartness] in FamInstEnv</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SurelyApart</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcUnifyTysFG</span> <span class='hs-varid'>instanceBindFun</span> <span class='hs-varid'>flat</span> <span class='hs-varid'>lhs_incomp</span>
<a name="line-25"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_no_conflict</span> <span class='hs-varid'>flat</span> <span class='hs-varid'>rest</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-27"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>b</span>
<a name="line-28"></a><span class='hs-definition'>checkAxInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="wrapSym"></a><span class='hs-comment'>-----------</span>
<a name="line-31"></a><span class='hs-definition'>wrapSym</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-32"></a><span class='hs-definition'>wrapSym</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sym</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span>
<a name="line-33"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="wrapRole"></a><span class='hs-definition'>wrapRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- desired</span>
<a name="line-36"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>         <span class='hs-comment'>-- current</span>
<a name="line-37"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-38"></a><span class='hs-definition'>wrapRole</span> <span class='hs-conid'>Nothing</span>        <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-39"></a><span class='hs-definition'>wrapRole</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>desired</span><span class='hs-layout'>)</span> <span class='hs-varid'>current</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeSubCo2</span> <span class='hs-varid'>desired</span> <span class='hs-varid'>current</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="substTyVarBndr2"></a><span class='hs-comment'>-----------</span>
<a name="line-42"></a><span class='hs-comment'>-- takes two tyvars and builds env'ts to map them to the same tyvar</span>
<a name="line-43"></a><span class='hs-definition'>substTyVarBndr2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-44"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-definition'>substTyVarBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-keyword'>of</span>
<a name="line-47"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstAndInScope</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv1'</span><span class='hs-layout'>)</span>
<a name="line-48"></a>    
<a name="line-49"></a><a name="zapCvSubstEnv2"></a><span class='hs-definition'>zapCvSubstEnv2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-50"></a><span class='hs-definition'>zapCvSubstEnv2</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>env2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>is1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>is2</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-51"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>is1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCvInScope</span> <span class='hs-varid'>env1</span>
<a name="line-52"></a>        <span class='hs-varid'>is2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCvInScope</span> <span class='hs-varid'>env2</span>
<a name="line-53"></a><a name="isAxiom_maybe"></a><span class='hs-comment'>-----------</span>
<a name="line-54"></a><span class='hs-definition'>isAxiom_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-definition'>isAxiom_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> 
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sym</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isAxiom_maybe</span> <span class='hs-varid'>co</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>sym</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-definition'>isAxiom_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-definition'>isAxiom_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="matchAxiom"></a><span class='hs-definition'>matchAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- True = match LHS, False = match RHS</span>
<a name="line-63"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a><span class='hs-comment'>-- If we succeed in matching, then *all the quantified type variables are bound*</span>
<a name="line-65"></a><span class='hs-comment'>-- E.g.   if tvs = [a,b], lhs/rhs = [b], we'll fail</span>
<a name="line-66"></a><span class='hs-definition'>matchAxiom</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>co</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qtvs</span>
<a name="line-68"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span>
<a name="line-69"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-70"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-keyword'>in</span>
<a name="line-71"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>liftCoMatch</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>qtvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>sym</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-72"></a>      <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-73"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>allMaybes</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubstTyVar</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>qtvs</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="compatible_co"></a><span class='hs-comment'>-------------</span>
<a name="line-76"></a><span class='hs-definition'>compatible_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-77"></a><span class='hs-comment'>-- Check whether (co1 . co2) will be well-kinded</span>
<a name="line-78"></a><span class='hs-definition'>compatible_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>x2</span>		
<a name="line-80"></a>  <span class='hs-keyword'>where</span>
<a name="line-81"></a>    <span class='hs-conid'>Pair</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>x1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co1</span>
<a name="line-82"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>x2</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co2</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="etaForAllCo_maybe"></a><span class='hs-comment'>-------------</span>
<a name="line-85"></a><span class='hs-definition'>etaForAllCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-comment'>-- Try to make the coercion be of form (forall tv. co)</span>
<a name="line-87"></a><span class='hs-definition'>etaForAllCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-92"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-93"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-94"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="etaAppCo_maybe"></a><span class='hs-definition'>etaAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-comment'>-- If possible, split a coercion</span>
<a name="line-102"></a><span class='hs-comment'>--   g :: t1a t1b ~ t2a t2b</span>
<a name="line-103"></a><span class='hs-comment'>-- into a pair of coercions (left g, right g)</span>
<a name="line-104"></a><span class='hs-definition'>etaAppCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span><span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span><span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span>
<a name="line-108"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-109"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-110"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-111"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>t2</span>      <span class='hs-comment'>-- Note [Eta for AppCo]</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-conid'>CLeft</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-conid'>LRCo</span> <span class='hs-conid'>CRight</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="etaTyConAppCo_maybe"></a><span class='hs-definition'>etaTyConAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a><span class='hs-comment'>-- If possible, split a coercion </span>
<a name="line-118"></a><span class='hs-comment'>--       g :: T s1 .. sn ~ T t1 .. tn</span>
<a name="line-119"></a><span class='hs-comment'>-- into [ Nth 0 g :: s1~t1, ..., Nth (n-1) g :: sn~tn ] </span>
<a name="line-120"></a><span class='hs-definition'>etaTyConAppCo_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> <span class='hs-layout'>)</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cos2</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-definition'>etaTyConAppCo_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>co</span>
<a name="line-124"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-125"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-126"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-127"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-128"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-129"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys1</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>)</span> 
<a name="line-131"></a>    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys2</span> <span class='hs-layout'>)</span>
<a name="line-132"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>decomposeCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-133"></a>    <span class='hs-comment'>-- NB: n might be &lt;&gt; tyConArity tc</span>
<a name="line-134"></a>    <span class='hs-comment'>-- e.g.   data family T a :: * -&gt; *</span>
<a name="line-135"></a>    <span class='hs-comment'>--        g :: T a b ~ T c d</span>
<a name="line-136"></a>
<a name="line-137"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}  

Note [Eta for AppCo]
~~~~~~~~~~~~~~~~~~~~
Suppose we have 
   g :: s1 t1 ~ s2 t2

Then we can't necessarily make
   left  g :: s1 ~ s2
   right g :: t1 ~ t2
because it's possible that
   s1 :: * -> *         t1 :: *
   s2 :: (*->*) -> *    t2 :: * -> *
and in that case (left g) does not have the same
kind on either side.

It's enough to check that 
  kind t1 = kind t2
because if g is well-kinded then
  kind (s1 t2) = kind (s2 t2)
and these two imply
  kind s1 = kind s2

</body>
</html>
