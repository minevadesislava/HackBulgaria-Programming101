<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcRnDriver.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[TcMovectle]{Typechecking a whole module}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcRnDriver</span> <span class='hs-layout'>(</span>
<a name="line-2"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-3"></a>        <span class='hs-varid'>tcRnStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcRnExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcRnType</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>tcRnImportDecls</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>tcRnLookupRdrName</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>getModuleInterface</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-varid'>tcRnDeclsi</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-varid'>isGHCiMonad</span><span class='hs-layout'>,</span>
<a name="line-9"></a>        <span class='hs-varid'>runTcInteractive</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Used by GHC API clients (Trac #8878)</span>
<a name="line-10"></a><span class='hs-cpp'>#endif</span>
<a name="line-11"></a>        <span class='hs-varid'>tcRnLookupName</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>tcRnGetInfo</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>tcRnModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcRnModuleTcRnM</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>tcTopSrcDecls</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>tcRnExtCore</span>
<a name="line-16"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcSplice</span> <span class='hs-layout'>(</span> <span class='hs-varid'>runQuasi</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnSplice</span> <span class='hs-layout'>(</span> <span class='hs-varid'>rnTopSpliceDecls</span> <span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-cpp'>#endif</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcExpr</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprTyThing</span><span class='hs-layout'>(</span> <span class='hs-varid'>pprTyThing</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span> <span class='hs-varid'>pprCoAxiom</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcAnnotations</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcBinds</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HeaderInfo</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>mkPrelImports</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcDefaults</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRules</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcForeign</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcInstDcls</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkIface</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcTyClsDecls</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnNames</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnSource</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span><span class='hs-layout'>(</span> <span class='hs-conid'>IdDetails</span><span class='hs-layout'>(</span> <span class='hs-conid'>VanillaId</span> <span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>tcGetInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetInsts</span> <span class='hs-layout'>)</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>)</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<a name="line-81"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>isUnitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTauTy</span> <span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMatches</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnTypes</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnExpr</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TidyPgm</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>globaliseAndTidyId</span> <span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>unitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkListTy</span> <span class='hs-layout'>)</span>
<a name="line-91"></a><span class='hs-cpp'>#endif</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-97"></a>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-99"></a>
<a name="line-100"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Typecheck and rename a module
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="tcRnModule"></a><span class='hs-comment'>-- | Top level entry point for typechecker and renamer</span>
<a name="line-2"></a><span class='hs-definition'>tcRnModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-3"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscSource</span>
<a name="line-4"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>              <span class='hs-comment'>-- True &lt;=&gt; save renamed syntax</span>
<a name="line-5"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsParsedModule</span>
<a name="line-6"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>tcRnModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varid'>save_rn_syntax</span>
<a name="line-9"></a>   <span class='hs-varid'>parsedModule</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>HsParsedModule</span> <span class='hs-layout'>{</span><span class='hs-varid'>hpm_module</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>this_module</span><span class='hs-layout'>}</span>
<a name="line-10"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>showPass</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-str'>"Renamer/typechecker"</span> <span class='hs-layout'>;</span>
<a name="line-11"></a>
<a name="line-12"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-13"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>pair</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-14"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hsmodName</span> <span class='hs-varid'>this_module</span> <span class='hs-keyword'>of</span>
<a name="line-15"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-comment'>-- 'module M where' is omitted</span>
<a name="line-16"></a>                        <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mAIN</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcLocSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStart</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a>                    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>mod_loc</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- The normal case</span>
<a name="line-19"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_loc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-20"></a>
<a name="line-21"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>initTc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varid'>save_rn_syntax</span> <span class='hs-varid'>this_mod</span> <span class='hs-varop'>$</span>
<a name="line-22"></a>        <span class='hs-varid'>tcRnModuleTcRnM</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varid'>parsedModule</span> <span class='hs-varid'>pair</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="tcRnModuleTcRnM"></a><span class='hs-definition'>tcRnModuleTcRnM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-25"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscSource</span>
<a name="line-26"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsParsedModule</span>
<a name="line-27"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>)</span>
<a name="line-28"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-29"></a><span class='hs-comment'>-- Factored out separately so that a Core plugin can</span>
<a name="line-30"></a><span class='hs-comment'>-- call the type checker directly</span>
<a name="line-31"></a><span class='hs-definition'>tcRnModuleTcRnM</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hsc_src</span>
<a name="line-32"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>HsParsedModule</span> <span class='hs-layout'>{</span>
<a name="line-33"></a>                   <span class='hs-varid'>hpm_module</span> <span class='hs-keyglyph'>=</span>
<a name="line-34"></a>                      <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsModule</span> <span class='hs-varid'>maybe_mod</span> <span class='hs-varid'>export_ies</span>
<a name="line-35"></a>                                       <span class='hs-varid'>import_decls</span> <span class='hs-varid'>local_decls</span> <span class='hs-varid'>mod_deprec</span>
<a name="line-36"></a>                                       <span class='hs-varid'>maybe_doc_hdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-37"></a>                   <span class='hs-varid'>hpm_src_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src_files</span>
<a name="line-38"></a>                <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>prel_imp_loc</span><span class='hs-layout'>)</span>
<a name="line-40"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-41"></a>   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>         <span class='hs-comment'>-- Deal with imports; first add implicit prelude</span>
<a name="line-42"></a>        <span class='hs-varid'>implicit_prelude</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ImplicitPrelude</span><span class='hs-layout'>;</span>
<a name="line-43"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>prel_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrelImports</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>prel_imp_loc</span>
<a name="line-44"></a>                                         <span class='hs-varid'>implicit_prelude</span> <span class='hs-varid'>import_decls</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnImplicitPrelude</span> <span class='hs-varop'>$</span>
<a name="line-47"></a>             <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>notNull</span> <span class='hs-varid'>prel_imports</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicitPreludeWarn</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "tcRnImports" #-}</span>
<a name="line-50"></a>                   <span class='hs-varid'>tcRnImports</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>prel_imports</span> <span class='hs-varop'>++</span> <span class='hs-varid'>import_decls</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-51"></a>
<a name="line-52"></a>          <span class='hs-comment'>-- If the whole module is warned about or deprecated </span>
<a name="line-53"></a>          <span class='hs-comment'>-- (via mod_deprec) record that in tcg_warns. If we do thereby add</span>
<a name="line-54"></a>          <span class='hs-comment'>-- a WarnAll, it will override any subseqent depracations added to tcg_warns</span>
<a name="line-55"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mod_deprec</span> <span class='hs-keyword'>of</span> 
<a name="line-56"></a>                         <span class='hs-conid'>Just</span> <span class='hs-varid'>txt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WarnAll</span> <span class='hs-varid'>txt</span> <span class='hs-layout'>}</span> 
<a name="line-57"></a>                         <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcg_env</span> 
<a name="line-58"></a>            <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-59"></a> 
<a name="line-60"></a>        <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env1</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-61"></a>
<a name="line-62"></a>                <span class='hs-comment'>-- Load the hi-boot interface for this module, if any</span>
<a name="line-63"></a>                <span class='hs-comment'>-- We do this now so that the boot_names can be passed</span>
<a name="line-64"></a>                <span class='hs-comment'>-- to tcTyAndClassDecls, because the boot_names are</span>
<a name="line-65"></a>                <span class='hs-comment'>-- automatically considered to be loop breakers</span>
<a name="line-66"></a>                <span class='hs-comment'>--</span>
<a name="line-67"></a>                <span class='hs-comment'>-- Do this *after* tcRnImports, so that we know whether</span>
<a name="line-68"></a>                <span class='hs-comment'>-- a module that we import imports us; and hence whether to</span>
<a name="line-69"></a>                <span class='hs-comment'>-- look for a hi-boot file</span>
<a name="line-70"></a>        <span class='hs-varid'>boot_iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHiBootIface</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varid'>this_mod</span> <span class='hs-layout'>;</span>
<a name="line-71"></a>
<a name="line-72"></a>                <span class='hs-comment'>-- Rename and type check the declarations</span>
<a name="line-73"></a>        <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rn1a"</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-74"></a>        <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isHsBoot</span> <span class='hs-varid'>hsc_src</span> <span class='hs-keyword'>then</span>
<a name="line-75"></a>                        <span class='hs-varid'>tcRnHsBootDecls</span> <span class='hs-varid'>local_decls</span>
<a name="line-76"></a>                   <span class='hs-keyword'>else</span>
<a name="line-77"></a>                        <span class='hs-comment'>{-# SCC "tcRnSrcDecls" #-}</span>
<a name="line-78"></a>                        <span class='hs-varid'>tcRnSrcDecls</span> <span class='hs-varid'>boot_iface</span> <span class='hs-varid'>local_decls</span> <span class='hs-layout'>;</span>
<a name="line-79"></a>        <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span>               <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-80"></a>
<a name="line-81"></a>                <span class='hs-comment'>-- Process the export list</span>
<a name="line-82"></a>        <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rn4a: before exports"</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-83"></a>        <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnExports</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>maybe_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>export_ies</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>;</span>
<a name="line-84"></a>        <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rn4b: after exports"</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-85"></a>
<a name="line-86"></a>                <span class='hs-comment'>-- Check that main is exported (must be after rnExports)</span>
<a name="line-87"></a>        <span class='hs-varid'>checkMainExported</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>;</span>
<a name="line-88"></a>
<a name="line-89"></a>        <span class='hs-comment'>-- Compare the hi-boot iface (if any) with the real thing</span>
<a name="line-90"></a>        <span class='hs-comment'>-- Must be done after processing the exports</span>
<a name="line-91"></a>        <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkHiBootIface</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varid'>boot_iface</span> <span class='hs-layout'>;</span>
<a name="line-92"></a>
<a name="line-93"></a>        <span class='hs-comment'>-- The new type env is already available to stuff slurped from</span>
<a name="line-94"></a>        <span class='hs-comment'>-- interface files, via TcEnv.updateGlobalTypeEnv</span>
<a name="line-95"></a>        <span class='hs-comment'>-- It's important that this includes the stuff in checkHiBootIface,</span>
<a name="line-96"></a>        <span class='hs-comment'>-- because the latter might add new bindings for boot_dfuns,</span>
<a name="line-97"></a>        <span class='hs-comment'>-- which may be mentioned in imported unfoldings</span>
<a name="line-98"></a>
<a name="line-99"></a>                <span class='hs-comment'>-- Don't need to rename the Haddock documentation,</span>
<a name="line-100"></a>                <span class='hs-comment'>-- it's not parsed by GHC anymore.</span>
<a name="line-101"></a>        <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_doc_hdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe_doc_hdr</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-102"></a>
<a name="line-103"></a>                <span class='hs-comment'>-- Report unused names</span>
<a name="line-104"></a>        <span class='hs-varid'>reportUnusedNames</span> <span class='hs-varid'>export_ies</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>;</span>
<a name="line-105"></a>
<a name="line-106"></a>                <span class='hs-comment'>-- add extra source files to tcg_dependent_files</span>
<a name="line-107"></a>        <span class='hs-varid'>addDependentFiles</span> <span class='hs-varid'>src_files</span> <span class='hs-layout'>;</span>
<a name="line-108"></a>
<a name="line-109"></a>                <span class='hs-comment'>-- Dump output and return</span>
<a name="line-110"></a>        <span class='hs-varid'>tcDump</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>;</span>
<a name="line-111"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env</span>
<a name="line-112"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-113"></a>
<a name="line-114"></a>
<a name="line-115"></a><a name="implicitPreludeWarn"></a><span class='hs-definition'>implicitPreludeWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-116"></a><span class='hs-definition'>implicitPreludeWarn</span>
<a name="line-117"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Module `Prelude' implicitly imported"</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Import declarations
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcRnImports"></a><span class='hs-definition'>tcRnImports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-2"></a><span class='hs-definition'>tcRnImports</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>import_decls</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_imports</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>imports</span><span class='hs-layout'>,</span> <span class='hs-varid'>hpc_info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnImports</span> <span class='hs-varid'>import_decls</span> <span class='hs-layout'>;</span>
<a name="line-4"></a>
<a name="line-5"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dep_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span>
<a name="line-7"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_dep_mods</span> <span class='hs-varid'>imports</span>
<a name="line-8"></a>
<a name="line-9"></a>                <span class='hs-comment'>-- We want instance declarations from all home-package</span>
<a name="line-10"></a>                <span class='hs-comment'>-- modules below this one, including boot modules, except</span>
<a name="line-11"></a>                <span class='hs-comment'>-- ourselves.  The 'except ourselves' is so that we don't</span>
<a name="line-12"></a>                <span class='hs-comment'>-- get the instances from this module's hs-boot file.  This</span>
<a name="line-13"></a>                <span class='hs-comment'>-- filtering also ensures that we don't see instances from</span>
<a name="line-14"></a>                <span class='hs-comment'>-- modules batch (@--make@) compiled before this one, but</span>
<a name="line-15"></a>                <span class='hs-comment'>-- which are not below this one.</span>
<a name="line-16"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>want_instances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-17"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>want_instances</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>`elemUFM`</span> <span class='hs-varid'>dep_mods</span>
<a name="line-18"></a>                                   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>this_mod</span>
<a name="line-19"></a>              <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>home_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_fam_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hptInstances</span> <span class='hs-varid'>hsc_env</span>
<a name="line-20"></a>                                                            <span class='hs-varid'>want_instances</span>
<a name="line-21"></a>              <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-22"></a>
<a name="line-23"></a>                <span class='hs-comment'>-- Record boot-file info in the EPS, so that it's</span>
<a name="line-24"></a>                <span class='hs-comment'>-- visible to loadHiBootInterface in tcRnSrcDecls,</span>
<a name="line-25"></a>                <span class='hs-comment'>-- and any other incrementally-performed imports</span>
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>updateEps_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>eps</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>eps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eps_is_boot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_mods</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-27"></a>
<a name="line-28"></a>                <span class='hs-comment'>-- Update the gbl env</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>updGblEnv</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>gbl</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-30"></a>            <span class='hs-varid'>gbl</span> <span class='hs-layout'>{</span>
<a name="line-31"></a>              <span class='hs-varid'>tcg_rdr_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-varid'>gbl</span> <span class='hs-varop'>`plusGlobalRdrEnv`</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span>
<a name="line-32"></a>              <span class='hs-varid'>tcg_imports</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_imports</span> <span class='hs-varid'>gbl</span> <span class='hs-varop'>`plusImportAvails`</span> <span class='hs-varid'>imports</span><span class='hs-layout'>,</span>
<a name="line-33"></a>              <span class='hs-varid'>tcg_rn_imports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rn_imports</span><span class='hs-layout'>,</span>
<a name="line-34"></a>              <span class='hs-varid'>tcg_inst_env</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInstEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_inst_env</span> <span class='hs-varid'>gbl</span><span class='hs-layout'>)</span> <span class='hs-varid'>home_insts</span><span class='hs-layout'>,</span>
<a name="line-35"></a>              <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendFamInstEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-varid'>gbl</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                                                      <span class='hs-varid'>home_fam_insts</span><span class='hs-layout'>,</span>
<a name="line-37"></a>              <span class='hs-varid'>tcg_hpc</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpc_info</span>
<a name="line-38"></a>            <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rn1"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_dep_mods</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                <span class='hs-comment'>-- Fail if there are any errors so far</span>
<a name="line-42"></a>                <span class='hs-comment'>-- The error printing (if needed) takes advantage</span>
<a name="line-43"></a>                <span class='hs-comment'>-- of the tcg_env we have now set</span>
<a name="line-44"></a><span class='hs-comment'>--      ; traceIf (text "rdr_env: " &lt;+&gt; ppr rdr_env)</span>
<a name="line-45"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>failIfErrsM</span>
<a name="line-46"></a>
<a name="line-47"></a>                <span class='hs-comment'>-- Load any orphan-module and family instance-module</span>
<a name="line-48"></a>                <span class='hs-comment'>-- interfaces, so that their rules and instance decls will be</span>
<a name="line-49"></a>                <span class='hs-comment'>-- found.</span>
<a name="line-50"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>loadModuleInterfaces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Loading orphan modules"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>imp_orphs</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a>                <span class='hs-comment'>-- Check type-family consistency</span>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rn1: checking family instance consistency"</span><span class='hs-layout'>)</span>
<a name="line-55"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dir_imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleEnvKeys</span>
<a name="line-56"></a>                             <span class='hs-varop'>.</span> <span class='hs-varid'>imp_mods</span>
<a name="line-57"></a>                             <span class='hs-varop'>$</span> <span class='hs-varid'>imports</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkFamInstConsistency</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_finsts</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span> <span class='hs-varid'>dir_imp_mods</span> <span class='hs-layout'>;</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>getGblEnv</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Type-checking external-core modules
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcRnExtCore"></a><span class='hs-definition'>tcRnExtCore</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExtCore</span> <span class='hs-conid'>RdrName</span>
<a name="line-3"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModGuts</span><span class='hs-layout'>)</span>
<a name="line-4"></a>        <span class='hs-comment'>-- Nothing =&gt; some error occurred</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>tcRnExtCore</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExtCore</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>decls</span> <span class='hs-varid'>src_binds</span><span class='hs-layout'>)</span>
<a name="line-7"></a>        <span class='hs-comment'>-- The decls are IfaceDecls; all names are original names</span>
<a name="line-8"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>showPass</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-str'>"Renamer/typechecker"</span> <span class='hs-layout'>;</span>
<a name="line-9"></a>
<a name="line-10"></a>   <span class='hs-varid'>initTc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>ExtCoreFile</span> <span class='hs-conid'>False</span> <span class='hs-varid'>this_mod</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-11"></a>
<a name="line-12"></a>   <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ldecls</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>noLoc</span> <span class='hs-varid'>decls</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-13"></a>
<a name="line-14"></a>       <span class='hs-comment'>-- Bring the type and class decls into scope</span>
<a name="line-15"></a>       <span class='hs-comment'>-- ToDo: check that this doesn't need to extract the val binds.</span>
<a name="line-16"></a>       <span class='hs-comment'>--       It seems that only the type and class decls need to be in scope below because</span>
<a name="line-17"></a>       <span class='hs-comment'>--          (a) tcTyAndClassDecls doesn't need the val binds, and</span>
<a name="line-18"></a>       <span class='hs-comment'>--          (b) tcExtCoreBindings doesn't need anything</span>
<a name="line-19"></a>       <span class='hs-comment'>--              (in fact, it might not even need to be in the scope of</span>
<a name="line-20"></a>       <span class='hs-comment'>--               this tcg_env at all)</span>
<a name="line-21"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>tc_envs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalNonValBinders</span> <span class='hs-varid'>emptyFsEnv</span> <span class='hs-comment'>{- no fixity decls -}</span>
<a name="line-22"></a>                                              <span class='hs-layout'>(</span><span class='hs-varid'>mkFakeGroup</span> <span class='hs-varid'>ldecls</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-23"></a>   <span class='hs-varid'>setEnvs</span> <span class='hs-varid'>tc_envs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-24"></a>
<a name="line-25"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>rn_decls</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rnTyClDecls</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyClGroup</span> <span class='hs-varid'>ldecls</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>;</span>
<a name="line-26"></a>   <span class='hs-comment'>-- The empty list is for extra dependencies coming from .hs-boot files</span>
<a name="line-27"></a>   <span class='hs-comment'>-- See Note [Extra dependencies from .hs-boot files] in RnSource</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- Dump trace of renaming part</span>
<a name="line-30"></a>   <span class='hs-varid'>rnDump</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-comment'>-- Typecheck them all together so that</span>
<a name="line-33"></a>        <span class='hs-comment'>-- any mutually recursive types are done right</span>
<a name="line-34"></a>        <span class='hs-comment'>-- Just discard the auxiliary bindings; they are generated</span>
<a name="line-35"></a>        <span class='hs-comment'>-- only for Haskell source code, and should already be in Core</span>
<a name="line-36"></a>   <span class='hs-varid'>tcg_env</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyAndClassDecls</span> <span class='hs-varid'>emptyModDetails</span> <span class='hs-varid'>rn_decls</span> <span class='hs-layout'>;</span>
<a name="line-37"></a>   <span class='hs-varid'>safe_mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>finalSafeMode</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>;</span>
<a name="line-38"></a>   <span class='hs-varid'>dep_files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_dependent_files</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-39"></a>
<a name="line-40"></a>   <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-41"></a>        <span class='hs-comment'>-- Make the new type env available to stuff slurped from interface files</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-comment'>-- Now the core bindings</span>
<a name="line-44"></a>   <span class='hs-varid'>core_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initIfaceExtCore</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcExtCoreBindings</span> <span class='hs-varid'>src_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-45"></a>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-comment'>-- Wrap up</span>
<a name="line-48"></a>   <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span>
<a name="line-49"></a>        <span class='hs-varid'>bndrs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>core_binds</span> <span class='hs-layout'>;</span>
<a name="line-50"></a>        <span class='hs-varid'>my_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idName</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>;</span>
<a name="line-51"></a>                <span class='hs-comment'>-- ToDo: export the data types also?</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-varid'>mod_guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModGuts</span> <span class='hs-layout'>{</span>    <span class='hs-varid'>mg_module</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-54"></a>                                <span class='hs-varid'>mg_boot</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-55"></a>                                <span class='hs-varid'>mg_used_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ToDo: compute usage</span>
<a name="line-56"></a>                                <span class='hs-varid'>mg_used_th</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-57"></a>                                <span class='hs-varid'>mg_dir_imps</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModuleEnv</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ??</span>
<a name="line-58"></a>                                <span class='hs-varid'>mg_deps</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noDependencies</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- ??</span>
<a name="line-59"></a>                                <span class='hs-varid'>mg_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>my_exports</span><span class='hs-layout'>,</span>
<a name="line-60"></a>                                <span class='hs-varid'>mg_tcs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_tcs</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span>
<a name="line-61"></a>                                <span class='hs-varid'>mg_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_insts</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span>
<a name="line-62"></a>                                <span class='hs-varid'>mg_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span>
<a name="line-63"></a>                                <span class='hs-varid'>mg_inst_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_inst_env</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span>
<a name="line-64"></a>                                <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span>
<a name="line-65"></a>                                <span class='hs-varid'>mg_patsyns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- TODO</span>
<a name="line-66"></a>                                <span class='hs-varid'>mg_rules</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-67"></a>                                <span class='hs-varid'>mg_vect_decls</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-68"></a>                                <span class='hs-varid'>mg_anns</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-69"></a>                                <span class='hs-varid'>mg_binds</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>core_binds</span><span class='hs-layout'>,</span>
<a name="line-70"></a>
<a name="line-71"></a>                                <span class='hs-comment'>-- Stubs</span>
<a name="line-72"></a>                                <span class='hs-varid'>mg_rdr_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyGlobalRdrEnv</span><span class='hs-layout'>,</span>
<a name="line-73"></a>                                <span class='hs-varid'>mg_fix_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFixityEnv</span><span class='hs-layout'>,</span>
<a name="line-74"></a>                                <span class='hs-varid'>mg_warns</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoWarnings</span><span class='hs-layout'>,</span>
<a name="line-75"></a>                                <span class='hs-varid'>mg_foreign</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoStubs</span><span class='hs-layout'>,</span>
<a name="line-76"></a>                                <span class='hs-varid'>mg_hpc_info</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyHpcInfo</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-77"></a>                                <span class='hs-varid'>mg_modBreaks</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModBreaks</span><span class='hs-layout'>,</span>
<a name="line-78"></a>                                <span class='hs-varid'>mg_vect_info</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noVectInfo</span><span class='hs-layout'>,</span>
<a name="line-79"></a>                                <span class='hs-varid'>mg_safe_haskell</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safe_mode</span><span class='hs-layout'>,</span>
<a name="line-80"></a>                                <span class='hs-varid'>mg_trust_pkg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-81"></a>                                <span class='hs-varid'>mg_dependent_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_files</span>
<a name="line-82"></a>                            <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-83"></a>
<a name="line-84"></a>   <span class='hs-varid'>tcCoreDump</span> <span class='hs-varid'>mod_guts</span> <span class='hs-layout'>;</span>
<a name="line-85"></a>
<a name="line-86"></a>   <span class='hs-varid'>return</span> <span class='hs-varid'>mod_guts</span>
<a name="line-87"></a>   <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="mkFakeGroup"></a><span class='hs-definition'>mkFakeGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsGroup</span> <span class='hs-varid'>a</span>
<a name="line-90"></a><span class='hs-definition'>mkFakeGroup</span> <span class='hs-varid'>decls</span> <span class='hs-comment'>-- Rather clumsy; lots of unused fields</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyRdrGroup</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hs_tyclds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyClGroup</span> <span class='hs-varid'>decls</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Type-checking the top level of a module
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcRnSrcDecls"></a><span class='hs-definition'>tcRnSrcDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-2"></a>        <span class='hs-comment'>-- Returns the variables free in the decls</span>
<a name="line-3"></a>        <span class='hs-comment'>-- Reason: solely to report unused imports and bindings</span>
<a name="line-4"></a><span class='hs-definition'>tcRnSrcDecls</span> <span class='hs-varid'>boot_iface</span> <span class='hs-varid'>decls</span>
<a name="line-5"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>         <span class='hs-comment'>-- Do all the declarations</span>
<a name="line-6"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tc_rn_src_decls</span> <span class='hs-varid'>boot_iface</span> <span class='hs-varid'>decls</span> <span class='hs-layout'>;</span>
<a name="line-7"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc8"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-8"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>setEnvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-9"></a>   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-10"></a>
<a name="line-11"></a>             <span class='hs-comment'>--         Finish simplifying class constraints</span>
<a name="line-12"></a>             <span class='hs-comment'>--</span>
<a name="line-13"></a>             <span class='hs-comment'>-- simplifyTop deals with constant or ambiguous InstIds.</span>
<a name="line-14"></a>             <span class='hs-comment'>-- How could there be ambiguous ones?  They can only arise if a</span>
<a name="line-15"></a>             <span class='hs-comment'>-- top-level decl falls under the monomorphism restriction</span>
<a name="line-16"></a>             <span class='hs-comment'>-- and no subsequent decl instantiates its type.</span>
<a name="line-17"></a>             <span class='hs-comment'>--</span>
<a name="line-18"></a>             <span class='hs-comment'>-- We do this after checkMain, so that we use the type info</span>
<a name="line-19"></a>             <span class='hs-comment'>-- that checkMain adds</span>
<a name="line-20"></a>             <span class='hs-comment'>--</span>
<a name="line-21"></a>             <span class='hs-comment'>-- We do it with both global and local env in scope:</span>
<a name="line-22"></a>             <span class='hs-comment'>--  * the global env exposes the instances to simplifyTop</span>
<a name="line-23"></a>             <span class='hs-comment'>--  * the local env exposes the local Ids to simplifyTop,</span>
<a name="line-24"></a>             <span class='hs-comment'>--    so that we get better error messages (monomorphism restriction)</span>
<a name="line-25"></a>        <span class='hs-varid'>new_ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "simplifyTop" #-}</span>
<a name="line-26"></a>                        <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>lie</span> <span class='hs-layout'>;</span>
<a name="line-27"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc9"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>failIfErrsM</span> <span class='hs-layout'>;</span>   <span class='hs-comment'>-- Don't zonk if there have been errors</span>
<a name="line-30"></a>                        <span class='hs-comment'>-- It's a waste of time; and we may get debug warnings</span>
<a name="line-31"></a>                        <span class='hs-comment'>-- about strangely-typed TyCons!</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- Zonk the final code.  This must be done last.</span>
<a name="line-34"></a>        <span class='hs-comment'>-- Even simplifyTop may do some unification.</span>
<a name="line-35"></a>        <span class='hs-comment'>-- This pass also warns about missing type signatures</span>
<a name="line-36"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span>
<a name="line-37"></a>                         <span class='hs-varid'>tcg_binds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span>
<a name="line-38"></a>                         <span class='hs-varid'>tcg_sigs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_ns</span><span class='hs-layout'>,</span>
<a name="line-39"></a>                         <span class='hs-varid'>tcg_ev_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cur_ev_binds</span><span class='hs-layout'>,</span>
<a name="line-40"></a>                         <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_specs</span><span class='hs-layout'>,</span>
<a name="line-41"></a>                         <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span><span class='hs-layout'>,</span>
<a name="line-42"></a>                         <span class='hs-varid'>tcg_vects</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vects</span><span class='hs-layout'>,</span>
<a name="line-43"></a>                         <span class='hs-varid'>tcg_fords</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fords</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span>
<a name="line-44"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>all_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cur_ev_binds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>new_ev_binds</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>bind_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fords'</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_specs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules'</span><span class='hs-layout'>,</span> <span class='hs-varid'>vects'</span><span class='hs-layout'>)</span>
<a name="line-47"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "zonkTopDecls" #-}</span>
<a name="line-48"></a>               <span class='hs-varid'>zonkTopDecls</span> <span class='hs-varid'>all_ev_binds</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sig_ns</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>vects</span> <span class='hs-varid'>imp_specs</span> <span class='hs-varid'>fords</span> <span class='hs-layout'>;</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>final_type_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>type_env</span> <span class='hs-varid'>bind_ids</span>
<a name="line-51"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span>
<a name="line-52"></a>                                   <span class='hs-varid'>tcg_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds'</span><span class='hs-layout'>,</span>
<a name="line-53"></a>                                   <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_specs'</span><span class='hs-layout'>,</span>
<a name="line-54"></a>                                   <span class='hs-varid'>tcg_rules</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules'</span><span class='hs-layout'>,</span>
<a name="line-55"></a>                                   <span class='hs-varid'>tcg_vects</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vects'</span><span class='hs-layout'>,</span>
<a name="line-56"></a>                                   <span class='hs-varid'>tcg_fords</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fords'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-57"></a>
<a name="line-58"></a>        <span class='hs-varid'>setGlobalTypeEnv</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-varid'>final_type_env</span>
<a name="line-59"></a>       
<a name="line-60"></a>   <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="tc_rn_src_decls"></a><span class='hs-definition'>tc_rn_src_decls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span>
<a name="line-63"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-comment'>-- Loops around dealing with each top level inter-splice group</span>
<a name="line-66"></a><span class='hs-comment'>-- in turn, until it's dealt with the entire module</span>
<a name="line-67"></a><span class='hs-definition'>tc_rn_src_decls</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>ds</span>
<a name="line-68"></a> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "tc_rn_src_decls" #-}</span>
<a name="line-69"></a>   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>first_group</span><span class='hs-layout'>,</span> <span class='hs-varid'>group_tail</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findSplice</span> <span class='hs-varid'>ds</span>
<a name="line-70"></a>                <span class='hs-comment'>-- If ds is [] we get ([], Nothing)</span>
<a name="line-71"></a>
<a name="line-72"></a>        <span class='hs-comment'>-- The extra_deps are needed while renaming type and class declarations</span>
<a name="line-73"></a>        <span class='hs-comment'>-- See Note [Extra dependencies from .hs-boot files] in RnSource</span>
<a name="line-74"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>extra_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tyConName</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeEnvTyCons</span> <span class='hs-layout'>(</span><span class='hs-varid'>md_types</span> <span class='hs-varid'>boot_details</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>        <span class='hs-comment'>-- Deal with decls up to, but not including, the first splice</span>
<a name="line-76"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnTopSrcDecls</span> <span class='hs-varid'>extra_deps</span> <span class='hs-varid'>first_group</span>
<a name="line-77"></a>                <span class='hs-comment'>-- rnTopSrcDecls fails if there are any errors</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-80"></a>        <span class='hs-comment'>-- Get TH-generated top-level declarations and make sure they don't</span>
<a name="line-81"></a>        <span class='hs-comment'>-- contain any splices since we don't handle that at the moment</span>
<a name="line-82"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>th_topdecls_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-83"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>th_ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>th_topdecls_var</span>
<a name="line-84"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>th_topdecls_var</span> <span class='hs-conid'>[]</span>
<a name="line-85"></a>
<a name="line-86"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-87"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>th_ds</span>
<a name="line-88"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span>
<a name="line-89"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>th_group</span><span class='hs-layout'>,</span> <span class='hs-varid'>th_group_tail</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findSplice</span> <span class='hs-varid'>th_ds</span>
<a name="line-90"></a>                    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>th_group_tail</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a>                        <span class='hs-layout'>{</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>;</span>
<a name="line-92"></a>                        <span class='hs-layout'>;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-93"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-94"></a>                               <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Declaration splices are not permitted inside top-level declarations added with addTopDecls"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-95"></a>                        <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-96"></a>                                         
<a name="line-97"></a>                    <span class='hs-comment'>-- Rename TH-generated top-level declarations</span>
<a name="line-98"></a>                    <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>th_rn_decls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>$</span>
<a name="line-99"></a>                      <span class='hs-varid'>rnTopSrcDecls</span> <span class='hs-varid'>extra_deps</span> <span class='hs-varid'>th_group</span>
<a name="line-100"></a>
<a name="line-101"></a>                    <span class='hs-comment'>-- Dump generated top-level declarations</span>
<a name="line-102"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-103"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>traceSplice</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Splicing top-level declarations added with addTopDecls "</span><span class='hs-layout'>,</span>
<a name="line-104"></a>                                   <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>th_rn_decls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-105"></a>
<a name="line-106"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>appendGroups</span> <span class='hs-varid'>rn_decls</span> <span class='hs-varid'>th_rn_decls</span><span class='hs-layout'>)</span>
<a name="line-107"></a>                    <span class='hs-layout'>}</span>
<a name="line-108"></a><span class='hs-cpp'>#endif /* GHCI */</span>
<a name="line-109"></a>
<a name="line-110"></a>      <span class='hs-comment'>-- Type check all declarations</span>
<a name="line-111"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>$</span>
<a name="line-112"></a>                              <span class='hs-varid'>tcTopSrcDecls</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>rn_decls</span>
<a name="line-113"></a>
<a name="line-114"></a>        <span class='hs-comment'>-- If there is no splice, we're nearly done</span>
<a name="line-115"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>setEnvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-116"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>group_tail</span> <span class='hs-keyword'>of</span>
<a name="line-117"></a>          <span class='hs-layout'>{</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkMain</span>       <span class='hs-comment'>-- Check for `main'</span>
<a name="line-118"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-119"></a>                            <span class='hs-comment'>-- Run all module finalizers</span>
<a name="line-120"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_modfinalizers</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-121"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>modfinalizers</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>th_modfinalizers_var</span>
<a name="line-122"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-conid'>[]</span>
<a name="line-123"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>runQuasi</span> <span class='hs-varid'>modfinalizers</span>
<a name="line-124"></a><span class='hs-cpp'>#endif /* GHCI */</span>
<a name="line-125"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span>
<a name="line-126"></a>                          <span class='hs-layout'>}</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-cpp'>#ifndef GHCI</span>
<a name="line-129"></a>            <span class='hs-comment'>-- There shouldn't be a splice</span>
<a name="line-130"></a>          <span class='hs-layout'>;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-131"></a>            <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Can't do a top-level splice; need a bootstrapped compiler"</span><span class='hs-layout'>)</span>
<a name="line-132"></a>          <span class='hs-layout'>}</span>
<a name="line-133"></a><span class='hs-cpp'>#else</span>
<a name="line-134"></a>            <span class='hs-comment'>-- If there's a splice, we must carry on</span>
<a name="line-135"></a>          <span class='hs-layout'>;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest_ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-136"></a>            <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Rename the splice expression, and get its supporting decls</span>
<a name="line-137"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>spliced_decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>splice_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnTopSpliceDecls</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-138"></a>
<a name="line-139"></a>                 <span class='hs-comment'>-- Glue them on the front of the remaining decls and loop</span>
<a name="line-140"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span> <span class='hs-varop'>`addTcgDUs`</span> <span class='hs-varid'>usesOnly</span> <span class='hs-varid'>splice_fvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-141"></a>                 <span class='hs-varid'>tc_rn_src_decls</span> <span class='hs-varid'>boot_details</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliced_decls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rest_ds</span><span class='hs-layout'>)</span>
<a name="line-142"></a>               <span class='hs-layout'>}</span>
<a name="line-143"></a>          <span class='hs-layout'>}</span>
<a name="line-144"></a><span class='hs-cpp'>#endif /* GHCI */</span>
<a name="line-145"></a>      <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Compiling hs-boot source files, and
        comparing the hi-boot interface with the real thing
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcRnHsBootDecls"></a><span class='hs-definition'>tcRnHsBootDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-2"></a><span class='hs-definition'>tcRnHsBootDecls</span> <span class='hs-varid'>decls</span>
<a name="line-3"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>first_group</span><span class='hs-layout'>,</span> <span class='hs-varid'>group_tail</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findSplice</span> <span class='hs-varid'>decls</span>
<a name="line-4"></a>
<a name="line-5"></a>                <span class='hs-comment'>-- Rename the declarations</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsGroup</span> <span class='hs-layout'>{</span>
<a name="line-7"></a>                   <span class='hs-varid'>hs_tyclds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycl_decls</span><span class='hs-layout'>,</span>
<a name="line-8"></a>                   <span class='hs-varid'>hs_instds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_decls</span><span class='hs-layout'>,</span>
<a name="line-9"></a>                   <span class='hs-varid'>hs_derivds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deriv_decls</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                   <span class='hs-varid'>hs_fords</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>for_decls</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                   <span class='hs-varid'>hs_defds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>def_decls</span><span class='hs-layout'>,</span>
<a name="line-12"></a>                   <span class='hs-varid'>hs_ruleds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule_decls</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                   <span class='hs-varid'>hs_vects</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vect_decls</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                   <span class='hs-varid'>hs_annds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                   <span class='hs-varid'>hs_valds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>val_binds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnTopSrcDecls</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>first_group</span>
<a name="line-16"></a>        <span class='hs-comment'>-- The empty list is for extra dependencies coming from .hs-boot files</span>
<a name="line-17"></a>        <span class='hs-comment'>-- See Note [Extra dependencies from .hs-boot files] in RnSource</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-19"></a>
<a name="line-20"></a>
<a name="line-21"></a>                <span class='hs-comment'>-- Check for illegal declarations</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>group_tail</span> <span class='hs-keyword'>of</span>
<a name="line-23"></a>             <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>badBootDecl</span> <span class='hs-str'>"splice"</span> <span class='hs-varid'>d</span>
<a name="line-24"></a>             <span class='hs-conid'>Nothing</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>badBootDecl</span> <span class='hs-str'>"foreign"</span><span class='hs-layout'>)</span> <span class='hs-varid'>for_decls</span>
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>badBootDecl</span> <span class='hs-str'>"default"</span><span class='hs-layout'>)</span> <span class='hs-varid'>def_decls</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>badBootDecl</span> <span class='hs-str'>"rule"</span><span class='hs-layout'>)</span>    <span class='hs-varid'>rule_decls</span>
<a name="line-28"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>badBootDecl</span> <span class='hs-str'>"vect"</span><span class='hs-layout'>)</span>    <span class='hs-varid'>vect_decls</span>
<a name="line-29"></a>
<a name="line-30"></a>                <span class='hs-comment'>-- Typecheck type/class/isntance decls</span>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc2 (boot)"</span> <span class='hs-varid'>empty</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_infos</span><span class='hs-layout'>,</span> <span class='hs-sel'>_deriv_binds</span><span class='hs-layout'>)</span>
<a name="line-33"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyClsInstDecls</span> <span class='hs-varid'>emptyModDetails</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span>     <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-35"></a>
<a name="line-36"></a>                <span class='hs-comment'>-- Typecheck value declarations</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc5"</span> <span class='hs-varid'>empty</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>val_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsBootSigs</span> <span class='hs-varid'>val_binds</span>
<a name="line-39"></a>
<a name="line-40"></a>                <span class='hs-comment'>-- Wrap up</span>
<a name="line-41"></a>                <span class='hs-comment'>-- No simplification or zonking to do</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc7a"</span> <span class='hs-varid'>empty</span>
<a name="line-43"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-44"></a>
<a name="line-45"></a>                <span class='hs-comment'>-- Make the final type-env</span>
<a name="line-46"></a>                <span class='hs-comment'>-- Include the dfun_ids so that their type sigs</span>
<a name="line-47"></a>                <span class='hs-comment'>-- are written into the interface file.</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>type_env0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>gbl_env</span>
<a name="line-49"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>type_env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>type_env0</span> <span class='hs-varid'>val_ids</span>
<a name="line-50"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>type_env2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>type_env1</span> <span class='hs-varid'>dfun_ids</span>
<a name="line-51"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>dfun_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>iDFunId</span> <span class='hs-varid'>inst_infos</span>
<a name="line-52"></a>              <span class='hs-layout'>}</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>setGlobalTypeEnv</span> <span class='hs-varid'>gbl_env</span> <span class='hs-varid'>type_env2</span>
<a name="line-55"></a>   <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-56"></a>   <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"boot"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>gbl_env</span> <span class='hs-layout'>}</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="badBootDecl"></a><span class='hs-definition'>badBootDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-59"></a><span class='hs-definition'>badBootDecl</span> <span class='hs-varid'>what</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'A'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>what</span>
<a name="line-61"></a>      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"declaration is not (currently) allowed in a hs-boot file"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

Once we've typechecked the body of the module, we want to compare what
we've found (gathered in a TypeEnv) with the hi-boot details (if any).

\begin{code}
<pre><a name="line-1"></a><a name="checkHiBootIface"></a><span class='hs-definition'>checkHiBootIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-2"></a><span class='hs-comment'>-- Compare the hi-boot file for this module (if there is one)</span>
<a name="line-3"></a><span class='hs-comment'>-- with the type environment we've just come up with</span>
<a name="line-4"></a><span class='hs-comment'>-- In the common case where there is no hi-boot file, the list</span>
<a name="line-5"></a><span class='hs-comment'>-- of boot_names is empty.</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-- The bindings we return give bindings for the dfuns defined in the</span>
<a name="line-8"></a><span class='hs-comment'>-- hs-boot file, such as        $fbEqT = $fEqT</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>checkHiBootIface</span>
<a name="line-11"></a>        <span class='hs-varid'>tcg_env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_src</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span>
<a name="line-12"></a>                            <span class='hs-varid'>tcg_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local_insts</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                            <span class='hs-varid'>tcg_type_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local_type_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcg_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local_exports</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-14"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>ModDetails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>md_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boot_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>md_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boot_fam_insts</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                      <span class='hs-varid'>md_types</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boot_type_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>md_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boot_exports</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHsBoot</span> <span class='hs-varid'>hs_src</span>     <span class='hs-comment'>-- Current module is already a hs-boot file!</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkHiBootIface"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-21"></a>             <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot_type_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot_exports</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>
<a name="line-23"></a>                <span class='hs-comment'>-- Check the exports of the boot module, one by one</span>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check_export</span> <span class='hs-varid'>boot_exports</span>
<a name="line-25"></a>
<a name="line-26"></a>                <span class='hs-comment'>-- Check for no family instances</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>boot_fam_insts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-28"></a>            <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"TcRnDriver.checkHiBootIface: Cannot handle family "</span> <span class='hs-varop'>++</span>
<a name="line-29"></a>                   <span class='hs-str'>"instances in boot files yet..."</span><span class='hs-layout'>)</span>
<a name="line-30"></a>            <span class='hs-comment'>-- FIXME: Why?  The actual comparison is not hard, but what would</span>
<a name="line-31"></a>            <span class='hs-comment'>--        be the equivalent to the dfun bindings returned for class</span>
<a name="line-32"></a>            <span class='hs-comment'>--        instances?  We can't easily equate tycons...</span>
<a name="line-33"></a>
<a name="line-34"></a>                <span class='hs-comment'>-- Check instance declarations</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mb_dfun_prs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>check_inst</span> <span class='hs-varid'>boot_insts</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dfun_prs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catMaybes</span> <span class='hs-varid'>mb_dfun_prs</span>
<a name="line-37"></a>              <span class='hs-varid'>boot_dfuns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>dfun_prs</span>
<a name="line-38"></a>              <span class='hs-varid'>dfun_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkVarBind</span> <span class='hs-varid'>boot_dfun</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>dfun</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                                     <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>boot_dfun</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dfun_prs</span> <span class='hs-keyglyph'>]</span>
<a name="line-40"></a>              <span class='hs-varid'>type_env'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>local_type_env</span> <span class='hs-varid'>boot_dfuns</span>
<a name="line-41"></a>              <span class='hs-varid'>tcg_env'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>dfun_binds</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>failIfErrsM</span>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>setGlobalTypeEnv</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-varid'>type_env'</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>             <span class='hs-comment'>-- Update the global type env *including* the knot-tied one</span>
<a name="line-46"></a>             <span class='hs-comment'>-- so that if the source module reads in an interface unfolding</span>
<a name="line-47"></a>             <span class='hs-comment'>-- mentioning one of the dfuns from the boot module, then it</span>
<a name="line-48"></a>             <span class='hs-comment'>-- can "see" that boot dfun.   See Trac #4003</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>check_export</span> <span class='hs-varid'>boot_avail</span>     <span class='hs-comment'>-- boot_avail is exported by the boot iface</span>
<a name="line-51"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>dfun_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-52"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>      <span class='hs-comment'>-- No checking for wired-in names.  In particular,</span>
<a name="line-53"></a>                                                <span class='hs-comment'>-- 'error' is handled by a rather gross hack</span>
<a name="line-54"></a>                                                <span class='hs-comment'>-- (see comments in GHC.Err.hs-boot)</span>
<a name="line-55"></a>
<a name="line-56"></a>        <span class='hs-comment'>-- Check that the actual module exports the same thing</span>
<a name="line-57"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>missing_names</span><span class='hs-layout'>)</span>
<a name="line-58"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>missing_names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>missingBootThing</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>missing_names</span><span class='hs-layout'>)</span> <span class='hs-str'>"exported by"</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-comment'>-- If the boot module does not *define* the thing, we are done</span>
<a name="line-62"></a>        <span class='hs-comment'>-- (it simply re-exports it, and names match, so nothing further to do)</span>
<a name="line-63"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_boot_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-64"></a>
<a name="line-65"></a>        <span class='hs-comment'>-- Check that the actual module also defines the thing, and</span>
<a name="line-66"></a>        <span class='hs-comment'>-- then compare the definitions</span>
<a name="line-67"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>real_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTypeEnv</span> <span class='hs-varid'>local_type_env</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span>
<a name="line-68"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>boot_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_boot_thing</span>
<a name="line-69"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkBootDecl</span> <span class='hs-varid'>boot_thing</span> <span class='hs-varid'>real_thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>boot_thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>bootMisMatch</span> <span class='hs-varid'>real_thing</span> <span class='hs-varid'>boot_thing</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-74"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>missingBootThing</span> <span class='hs-varid'>name</span> <span class='hs-str'>"defined in"</span><span class='hs-layout'>)</span>
<a name="line-75"></a>      <span class='hs-keyword'>where</span>
<a name="line-76"></a>        <span class='hs-varid'>name</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>availName</span> <span class='hs-varid'>boot_avail</span>
<a name="line-77"></a>        <span class='hs-varid'>mb_boot_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupTypeEnv</span> <span class='hs-varid'>boot_type_env</span> <span class='hs-varid'>name</span>
<a name="line-78"></a>        <span class='hs-varid'>missing_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>local_export_env</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-79"></a>                          <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span>
<a name="line-80"></a>                          <span class='hs-conid'>Just</span> <span class='hs-varid'>avail</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>boot_avail</span> <span class='hs-varop'>`minusList`</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>avail</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-varid'>dfun_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>boot_insts</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-varid'>local_export_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-85"></a>    <span class='hs-varid'>local_export_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>availsToNameEnv</span> <span class='hs-varid'>local_exports</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-varid'>check_inst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-88"></a>        <span class='hs-comment'>-- Returns a pair of the boot dfun in terms of the equivalent real dfun</span>
<a name="line-89"></a>    <span class='hs-varid'>check_inst</span> <span class='hs-varid'>boot_inst</span>
<a name="line-90"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dfun</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>local_insts</span><span class='hs-layout'>,</span>
<a name="line-91"></a>                       <span class='hs-keyword'>let</span> <span class='hs-varid'>dfun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>inst</span><span class='hs-layout'>,</span>
<a name="line-92"></a>                       <span class='hs-varid'>idType</span> <span class='hs-varid'>dfun</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>boot_inst_ty</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-93"></a>            <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"check_inst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"local_insts"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>instanceDFunId</span><span class='hs-layout'>)</span> <span class='hs-varid'>local_insts</span><span class='hs-layout'>)</span>
<a name="line-94"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"boot_inst"</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot_inst</span>
<a name="line-95"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"boot_inst_ty"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot_inst_ty</span>
<a name="line-96"></a>                                                  <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-97"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>instMisMatch</span> <span class='hs-varid'>boot_inst</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>dfun</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_boot_dfun</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-99"></a>        <span class='hs-keyword'>where</span>
<a name="line-100"></a>          <span class='hs-varid'>boot_dfun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>boot_inst</span>
<a name="line-101"></a>          <span class='hs-varid'>boot_inst_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>boot_dfun</span>
<a name="line-102"></a>          <span class='hs-varid'>local_boot_dfun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>mkExportedLocalId</span> <span class='hs-conid'>VanillaId</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>boot_dfun</span><span class='hs-layout'>)</span> <span class='hs-varid'>boot_inst_ty</span>
<a name="line-103"></a>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-comment'>-- This has to compare the TyThing from the .hi-boot file to the TyThing</span>
<a name="line-106"></a><span class='hs-comment'>-- in the current source file.  We must be careful to allow alpha-renaming</span>
<a name="line-107"></a><span class='hs-comment'>-- where appropriate, and also the boot declaration is allowed to omit</span>
<a name="line-108"></a><span class='hs-comment'>-- constructors and class methods.</span>
<a name="line-109"></a><span class='hs-comment'>--</span>
<a name="line-110"></a><span class='hs-comment'>-- See rnfail055 for a good test of this stuff.</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="checkBootDecl"></a><span class='hs-definition'>checkBootDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-definition'>checkBootDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id2</span><span class='hs-layout'>)</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>id1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>id2</span><span class='hs-layout'>)</span>
<a name="line-116"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>id2</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-definition'>checkBootDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkBootTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tc2</span>
<a name="line-120"></a>
<a name="line-121"></a><span class='hs-definition'>checkBootDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"checkBootDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc1</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-definition'>checkBootDecl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- probably shouldn't happen</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="checkBootTyCon"></a><span class='hs-comment'>----------------</span>
<a name="line-127"></a><span class='hs-definition'>checkBootTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-128"></a><span class='hs-definition'>checkBootTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tc2</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>       <span class='hs-comment'>-- First off, check the kind</span>
<a name="line-131"></a>
<a name="line-132"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>c1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc1</span>
<a name="line-133"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>c2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc2</span>
<a name="line-134"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas_tvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas_fds1</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_theta1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff1</span><span class='hs-layout'>)</span>
<a name="line-135"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>c1</span>
<a name="line-136"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>clas_tvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas_fds2</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_theta2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff2</span><span class='hs-layout'>)</span>
<a name="line-137"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>c2</span>
<a name="line-138"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqTyVarBndrs</span> <span class='hs-varid'>emptyRnEnv2</span> <span class='hs-varid'>clas_tvs1</span> <span class='hs-varid'>clas_tvs2</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-140"></a>       <span class='hs-varid'>eqSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>id1</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_meth1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>id2</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_meth2</span><span class='hs-layout'>)</span>
<a name="line-141"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-142"></a>           <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>op_ty1</span> <span class='hs-varid'>op_ty2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-143"></a>           <span class='hs-varid'>def_meth1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>def_meth2</span>
<a name="line-144"></a>         <span class='hs-keyword'>where</span>
<a name="line-145"></a>          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id1</span><span class='hs-layout'>)</span>
<a name="line-146"></a>          <span class='hs-varid'>op_ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funResultTy</span> <span class='hs-varid'>rho_ty1</span>
<a name="line-147"></a>          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id2</span><span class='hs-layout'>)</span>
<a name="line-148"></a>          <span class='hs-varid'>op_ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funResultTy</span> <span class='hs-varid'>rho_ty2</span>
<a name="line-149"></a>
<a name="line-150"></a>       <span class='hs-varid'>eqAT</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_ats1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_ats2</span><span class='hs-layout'>)</span>
<a name="line-151"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkBootTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tc2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-152"></a>           <span class='hs-varid'>eqListBy</span> <span class='hs-varid'>eqATDef</span> <span class='hs-varid'>def_ats1</span> <span class='hs-varid'>def_ats2</span>
<a name="line-153"></a>
<a name="line-154"></a>       <span class='hs-comment'>-- Ignore the location of the defaults</span>
<a name="line-155"></a>       <span class='hs-varid'>eqATDef</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>ty_pats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-156"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>ty_pats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-157"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqTyVarBndrs</span> <span class='hs-varid'>emptyRnEnv2</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>tvs2</span>
<a name="line-158"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_pats1</span> <span class='hs-varid'>ty_pats2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-159"></a>           <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-160"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-161"></a>
<a name="line-162"></a>       <span class='hs-varid'>eqFD</span> <span class='hs-layout'>(</span><span class='hs-varid'>as1</span><span class='hs-layout'>,</span><span class='hs-varid'>bs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>as2</span><span class='hs-layout'>,</span><span class='hs-varid'>bs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-163"></a>         <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>as1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>as2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-164"></a>         <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>bs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>bs2</span><span class='hs-layout'>)</span>
<a name="line-165"></a>    <span class='hs-keyword'>in</span>
<a name="line-166"></a>       <span class='hs-varid'>roles1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>roles2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-167"></a>             <span class='hs-comment'>-- Checks kind of class</span>
<a name="line-168"></a>       <span class='hs-varid'>eqListBy</span> <span class='hs-varid'>eqFD</span> <span class='hs-varid'>clas_fds1</span> <span class='hs-varid'>clas_fds2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-169"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>sc_theta1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>op_stuff1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ats1</span>
<a name="line-170"></a>        <span class='hs-varop'>||</span>   <span class='hs-comment'>-- Above tests for an "abstract" class</span>
<a name="line-171"></a>        <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqPredX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>sc_theta1</span> <span class='hs-varid'>sc_theta2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-172"></a>        <span class='hs-varid'>eqListBy</span> <span class='hs-varid'>eqSig</span> <span class='hs-varid'>op_stuff1</span> <span class='hs-varid'>op_stuff2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-173"></a>        <span class='hs-varid'>eqListBy</span> <span class='hs-varid'>eqAT</span> <span class='hs-varid'>ats1</span> <span class='hs-varid'>ats2</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>syn_rhs1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConRhs_maybe</span> <span class='hs-varid'>tc1</span>
<a name="line-176"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>syn_rhs2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConRhs_maybe</span> <span class='hs-varid'>tc2</span>
<a name="line-177"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqTyVarBndrs</span> <span class='hs-varid'>emptyRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-179"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>eqSynRhs</span> <span class='hs-conid'>OpenSynFamilyTyCon</span> <span class='hs-conid'>OpenSynFamilyTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-180"></a>        <span class='hs-varid'>eqSynRhs</span> <span class='hs-conid'>AbstractClosedSynFamilyTyCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosedSynFamilyTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-181"></a>        <span class='hs-varid'>eqSynRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosedSynFamilyTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conid'>AbstractClosedSynFamilyTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-182"></a>        <span class='hs-varid'>eqSynRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosedSynFamilyTyCon</span> <span class='hs-varid'>ax1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosedSynFamilyTyCon</span> <span class='hs-varid'>ax2</span><span class='hs-layout'>)</span>
<a name="line-183"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqClosedFamilyAx</span> <span class='hs-varid'>ax1</span> <span class='hs-varid'>ax2</span>
<a name="line-184"></a>        <span class='hs-varid'>eqSynRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>SynonymTyCon</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SynonymTyCon</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-185"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-186"></a>        <span class='hs-varid'>eqSynRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuiltInSynFamTyCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuiltInSynFamTyCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-187"></a>        <span class='hs-varid'>eqSynRhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-188"></a>    <span class='hs-keyword'>in</span>
<a name="line-189"></a>    <span class='hs-varid'>roles1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>roles2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-190"></a>    <span class='hs-varid'>eqSynRhs</span> <span class='hs-varid'>syn_rhs1</span> <span class='hs-varid'>syn_rhs2</span>
<a name="line-191"></a>
<a name="line-192"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc2</span>
<a name="line-193"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqTyVarBndrs</span> <span class='hs-varid'>emptyRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-194"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-195"></a>    <span class='hs-varid'>roles1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>roles2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-196"></a>    <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqPredX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-197"></a>    <span class='hs-varid'>eqAlgRhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>algTyConRhs</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>algTyConRhs</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-198"></a>
<a name="line-199"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForeignTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isForeignTyCon</span> <span class='hs-varid'>tc2</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-201"></a>    <span class='hs-varid'>tyConExtName</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tyConExtName</span> <span class='hs-varid'>tc2</span>
<a name="line-202"></a>
<a name="line-203"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-204"></a>  <span class='hs-keyword'>where</span>
<a name="line-205"></a>    <span class='hs-varid'>roles1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc1</span>
<a name="line-206"></a>    <span class='hs-varid'>roles2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc2</span>
<a name="line-207"></a>
<a name="line-208"></a>    <span class='hs-varid'>eqAlgRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbstractTyCon</span> <span class='hs-varid'>dis1</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs2</span>
<a name="line-209"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dis1</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDistinctAlgRhs</span> <span class='hs-varid'>rhs2</span>   <span class='hs-comment'>--Check compatibility</span>
<a name="line-210"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-211"></a>    <span class='hs-varid'>eqAlgRhs</span> <span class='hs-conid'>DataFamilyTyCon</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conid'>DataFamilyTyCon</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-212"></a>    <span class='hs-varid'>eqAlgRhs</span> <span class='hs-varid'>tc1</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>DataTyCon</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-varid'>tc2</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>DataTyCon</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-213"></a>        <span class='hs-varid'>eqListBy</span> <span class='hs-varid'>eqCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_cons</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_cons</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-214"></a>    <span class='hs-varid'>eqAlgRhs</span> <span class='hs-varid'>tc1</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>NewTyCon</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-varid'>tc2</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>NewTyCon</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-215"></a>        <span class='hs-varid'>eqCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_con</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_con</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span>
<a name="line-216"></a>    <span class='hs-varid'>eqAlgRhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-217"></a>
<a name="line-218"></a>    <span class='hs-varid'>eqCon</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span>
<a name="line-219"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>dataConName</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dataConName</span> <span class='hs-varid'>c2</span>
<a name="line-220"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dataConIsInfix</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dataConIsInfix</span> <span class='hs-varid'>c2</span>
<a name="line-221"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqListBy</span> <span class='hs-varid'>eqHsBang</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-222"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>c2</span>
<a name="line-223"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-224"></a>
<a name="line-225"></a>    <span class='hs-varid'>eqClosedFamilyAx</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-226"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-227"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>brListLength</span> <span class='hs-varid'>branches1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>brListLength</span> <span class='hs-varid'>branches2</span>
<a name="line-228"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>and</span> <span class='hs-varop'>$</span> <span class='hs-varid'>brListZipWith</span> <span class='hs-varid'>eqClosedFamilyBranch</span> <span class='hs-varid'>branches1</span> <span class='hs-varid'>branches2</span><span class='hs-layout'>)</span>
<a name="line-229"></a>
<a name="line-230"></a>    <span class='hs-varid'>eqClosedFamilyBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-231"></a>                         <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-232"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqTyVarBndrs</span> <span class='hs-varid'>emptyRnEnv2</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>tvs2</span>
<a name="line-233"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs1</span> <span class='hs-varid'>lhs2</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-234"></a>        <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs1</span> <span class='hs-varid'>rhs2</span>
<a name="line-235"></a>
<a name="line-236"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="emptyRnEnv2"></a><span class='hs-definition'>emptyRnEnv2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span>
<a name="line-239"></a><span class='hs-definition'>emptyRnEnv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>emptyInScopeSet</span>
<a name="line-240"></a>
<a name="line-241"></a><a name="missingBootThing"></a><span class='hs-comment'>----------------</span>
<a name="line-242"></a><span class='hs-definition'>missingBootThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-243"></a><span class='hs-definition'>missingBootThing</span> <span class='hs-varid'>name</span> <span class='hs-varid'>what</span>
<a name="line-244"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is exported by the hs-boot file, but not"</span><span class='hs-layout'>)</span>
<a name="line-245"></a>              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the module"</span><span class='hs-layout'>)</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="bootMisMatch"></a><span class='hs-definition'>bootMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-248"></a><span class='hs-definition'>bootMisMatch</span> <span class='hs-varid'>real_thing</span> <span class='hs-varid'>boot_thing</span>
<a name="line-249"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>real_thing</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-250"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has conflicting definitions in the module"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-251"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and its hs-boot file"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-252"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Main module:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-conid'>PprTyThing</span><span class='hs-varop'>.</span><span class='hs-varid'>pprTyThing</span> <span class='hs-varid'>real_thing</span><span class='hs-layout'>,</span>
<a name="line-253"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Boot file:  "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-conid'>PprTyThing</span><span class='hs-varop'>.</span><span class='hs-varid'>pprTyThing</span> <span class='hs-varid'>boot_thing</span><span class='hs-keyglyph'>]</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="instMisMatch"></a><span class='hs-definition'>instMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-256"></a><span class='hs-definition'>instMisMatch</span> <span class='hs-varid'>inst</span>
<a name="line-257"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>inst</span><span class='hs-layout'>)</span>
<a name="line-258"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is defined in the hs-boot file, but not in the module itself"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Type-checking the top level of a module
%*                                                                      *
%************************************************************************

tcRnGroup takes a bunch of top-level source-code declarations, and
 * renames them
 * gets supporting declarations from interface files
 * typechecks them
 * zonks them
 * and augments the TcGblEnv with the results

In Template Haskell it may be called repeatedly for each group of
declarations.  It expects there to be an incoming TcGblEnv in the
monad; it augments it and returns the new TcGblEnv.

\begin{code}
<pre><a name="line-1"></a><a name="rnTopSrcDecls"></a><span class='hs-comment'>------------------------------------------------</span>
<a name="line-2"></a><span class='hs-definition'>rnTopSrcDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsGroup</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsGroup</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-comment'>-- Fails if there are any errors</span>
<a name="line-4"></a><span class='hs-definition'>rnTopSrcDecls</span> <span class='hs-varid'>extra_deps</span> <span class='hs-varid'>group</span>
<a name="line-5"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Rename the source decls</span>
<a name="line-6"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"rn12"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-7"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rnSrcDecls</span> <span class='hs-varid'>extra_deps</span> <span class='hs-varid'>group</span> <span class='hs-layout'>;</span>
<a name="line-8"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"rn13"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-comment'>-- save the renamed syntax, if we want it</span>
<a name="line-11"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env'</span>
<a name="line-12"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>grp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcg_rn_decls</span> <span class='hs-varid'>tcg_env</span>
<a name="line-13"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>tcg_rn_decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>appendGroups</span> <span class='hs-varid'>grp</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-15"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>}</span><span class='hs-layout'>;</span>
<a name="line-16"></a>
<a name="line-17"></a>                <span class='hs-comment'>-- Dump trace of renaming part</span>
<a name="line-18"></a>        <span class='hs-varid'>rnDump</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_decls</span><span class='hs-layout'>)</span>
<a name="line-21"></a>   <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                AMP warnings
     The functions defined here issue warnings according to
     the 2013 Applicative-Monad proposal. (Trac #8004)
%*                                                                      *
%************************************************************************

Note [No AMP warning with NoImplicitPrelude]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If you have -XNoImplicitPrelude, then we suppress the AMP warnings.
The AMP warnings need access to Monad, Applicative, etc, and they
are defined in 'base'. If, when compiling package 'ghc-prim' (say),
you try to load Monad (from 'base'), chaos results because 'base'
depends on 'ghc-prim'.  See Note [Home module load error] in LoadIface,
and Trac #8320.

Using -XNoImplicitPrelude is a proxy for ensuring that all the
'base' modules are below the home module in the dependency tree.

\begin{code}
<pre><a name="line-1"></a><a name="tcAmpWarn"></a><span class='hs-comment'>-- | Main entry point for generating AMP warnings</span>
<a name="line-2"></a><span class='hs-definition'>tcAmpWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>tcAmpWarn</span> <span class='hs-keyglyph'>=</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>implicit_prel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ImplicitPrelude</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warnFlag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnAMP</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>warnFlag</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>implicit_prel</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-7"></a>              <span class='hs-comment'>-- See Note [No AMP warning with NoImplicitPrelude]</span>
<a name="line-8"></a>
<a name="line-9"></a>         <span class='hs-comment'>-- Monad without Applicative</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcAmpMissingParentClassWarn</span> <span class='hs-varid'>monadClassName</span>
<a name="line-11"></a>                                     <span class='hs-varid'>applicativeClassName</span>
<a name="line-12"></a>
<a name="line-13"></a>         <span class='hs-comment'>-- MonadPlus without Alternative</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcAmpMissingParentClassWarn</span> <span class='hs-varid'>monadPlusClassName</span>
<a name="line-15"></a>                                     <span class='hs-varid'>alternativeClassName</span>
<a name="line-16"></a>
<a name="line-17"></a>         <span class='hs-comment'>-- Custom local definitions of join/pure/&lt;*&gt;</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>tcAmpFunctionWarn</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>joinMName</span><span class='hs-layout'>,</span> <span class='hs-varid'>apAName</span><span class='hs-layout'>,</span> <span class='hs-varid'>pureAName</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a>
<a name="line-22"></a>
<a name="line-23"></a><a name="tcAmpFunctionWarn"></a><span class='hs-comment'>-- | Warn on local definitions of names that would clash with Prelude versions,</span>
<a name="line-24"></a><span class='hs-comment'>--   i.e. join/pure/&lt;*&gt;</span>
<a name="line-25"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><span class='hs-comment'>--   A name clashes if the following criteria are met:</span>
<a name="line-27"></a><span class='hs-comment'>--       1. It would is imported (unqualified) from Prelude</span>
<a name="line-28"></a><span class='hs-comment'>--       2. It is locally defined in the current module</span>
<a name="line-29"></a><span class='hs-comment'>--       3. It has the same literal name as the reference function</span>
<a name="line-30"></a><span class='hs-comment'>--       4. It is not identical to the reference function</span>
<a name="line-31"></a><span class='hs-definition'>tcAmpFunctionWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-comment'>-- ^ Name to check, e.g. joinMName for join</span>
<a name="line-32"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-33"></a><span class='hs-definition'>tcAmpFunctionWarn</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-34"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcAmpFunctionWarn/wouldBeImported"</span> <span class='hs-varid'>empty</span>
<a name="line-35"></a>    <span class='hs-comment'>-- Is the name imported (unqualified) from Prelude? (Point 4 above)</span>
<a name="line-36"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>rnImports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcg_rn_imports</span><span class='hs-layout'>)</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-37"></a>    <span class='hs-comment'>-- (Note that this automatically handles -XNoImplicitPrelude, as Prelude</span>
<a name="line-38"></a>    <span class='hs-comment'>-- will not appear in rnImports automatically if it is set.)</span>
<a name="line-39"></a>
<a name="line-40"></a>    <span class='hs-comment'>-- Continue only the name is imported from Prelude</span>
<a name="line-41"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcAmpImportViaPrelude</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rnImports</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-42"></a>      <span class='hs-comment'>-- Handle 2.-4.</span>
<a name="line-43"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>rdrElts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varop'>.</span> <span class='hs-varid'>occEnvElts</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcg_rdr_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>clashes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-46"></a>          <span class='hs-varid'>clashes</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>and</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>gre_prov</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-conid'>LocalDef</span>
<a name="line-47"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>nameOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-48"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>x</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>name</span>
<a name="line-49"></a>                          <span class='hs-keyglyph'>]</span>
<a name="line-50"></a>
<a name="line-51"></a>          <span class='hs-comment'>-- List of all offending definitions</span>
<a name="line-52"></a>          <span class='hs-varid'>clashingElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a>          <span class='hs-varid'>clashingElts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>clashes</span> <span class='hs-varid'>rdrElts</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcAmpFunctionWarn/amp_prelude_functions"</span>
<a name="line-56"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>clashingElts</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>warn_msg</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSrcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span>
<a name="line-59"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Local definition of"</span><span class='hs-layout'>)</span>
<a name="line-60"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>x</span>
<a name="line-61"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"clashes with a future Prelude name"</span><span class='hs-layout'>)</span>
<a name="line-62"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"- this will become an error in GHC 7.10,"</span><span class='hs-layout'>)</span>
<a name="line-63"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"under the Applicative-Monad Proposal."</span><span class='hs-layout'>)</span>
<a name="line-64"></a>              <span class='hs-keyglyph'>]</span>
<a name="line-65"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>warn_msg</span> <span class='hs-varid'>clashingElts</span>
<a name="line-66"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="tcAmpImportViaPrelude"></a><span class='hs-comment'>-- | Is the given name imported via Prelude?</span>
<a name="line-69"></a><span class='hs-comment'>--</span>
<a name="line-70"></a><span class='hs-comment'>--   This function makes sure that e.g. "import Prelude (map)" should silence</span>
<a name="line-71"></a><span class='hs-comment'>--   AMP warnings about "join" even when they are locally defined.</span>
<a name="line-72"></a><span class='hs-comment'>--</span>
<a name="line-73"></a><span class='hs-comment'>--   Possible scenarios:</span>
<a name="line-74"></a><span class='hs-comment'>--     a) Prelude is imported implicitly, issue warnings.</span>
<a name="line-75"></a><span class='hs-comment'>--     b) Prelude is imported explicitly, but without mentioning the name in</span>
<a name="line-76"></a><span class='hs-comment'>--        question. Issue no warnings.</span>
<a name="line-77"></a><span class='hs-comment'>--     c) Prelude is imported hiding the name in question. Issue no warnings.</span>
<a name="line-78"></a><span class='hs-comment'>--     d) Qualified import of Prelude, no warnings.</span>
<a name="line-79"></a><span class='hs-definition'>tcAmpImportViaPrelude</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-80"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-82"></a><span class='hs-definition'>tcAmpImportViaPrelude</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>importViaPrelude</span>
<a name="line-83"></a>  <span class='hs-keyword'>where</span>
<a name="line-84"></a>    <span class='hs-varid'>isPrelude</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-85"></a>    <span class='hs-varid'>isPrelude</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ideclName</span> <span class='hs-varid'>imp</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>pRELUDE_NAME</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-comment'>-- Implicit (Prelude) import?</span>
<a name="line-88"></a>    <span class='hs-varid'>isImplicit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-89"></a>    <span class='hs-varid'>isImplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ideclImplicit</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-comment'>-- Unqualified import?</span>
<a name="line-92"></a>    <span class='hs-varid'>isUnqualified</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-93"></a>    <span class='hs-varid'>isUnqualified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ideclQualified</span>
<a name="line-94"></a>
<a name="line-95"></a>    <span class='hs-varid'>second</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-96"></a>    <span class='hs-varid'>second</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a>    <span class='hs-comment'>-- List of explicitly imported (or hidden) Names from a single import.</span>
<a name="line-99"></a>    <span class='hs-comment'>--   Nothing -&gt; No explicit imports</span>
<a name="line-100"></a>    <span class='hs-comment'>--   Just (False, &lt;names&gt;) -&gt; Explicit import list of &lt;names&gt;</span>
<a name="line-101"></a>    <span class='hs-comment'>--   Just (True , &lt;names&gt;) -&gt; Explicit hiding of &lt;names&gt;</span>
<a name="line-102"></a>    <span class='hs-varid'>importList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-103"></a>    <span class='hs-varid'>importList</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>second</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ieName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ideclHiding</span>
<a name="line-104"></a>
<a name="line-105"></a>    <span class='hs-comment'>-- Check whether the given name would be imported (unqualified) from</span>
<a name="line-106"></a>    <span class='hs-comment'>-- an import declaration.</span>
<a name="line-107"></a>    <span class='hs-varid'>importViaPrelude</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-108"></a>    <span class='hs-varid'>importViaPrelude</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPrelude</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUnqualified</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>or</span> <span class='hs-keyglyph'>[</span>
<a name="line-109"></a>        <span class='hs-comment'>-- Whole Prelude imported -&gt; potential clash</span>
<a name="line-110"></a>          <span class='hs-varid'>isImplicit</span> <span class='hs-varid'>x</span>
<a name="line-111"></a>        <span class='hs-comment'>-- Explicit import/hiding list, if applicable</span>
<a name="line-112"></a>        <span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>importList</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>of</span>
<a name="line-113"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>explicit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span> <span class='hs-varop'>`elem`</span>    <span class='hs-varid'>map</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>explicit</span>
<a name="line-114"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span> <span class='hs-layout'>,</span> <span class='hs-varid'>hidden</span>  <span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>hidden</span>
<a name="line-115"></a>            <span class='hs-conid'>Nothing</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-116"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="tcAmpMissingParentClassWarn"></a><span class='hs-comment'>-- | Issue a warning for instance definitions lacking a should-be parent class.</span>
<a name="line-119"></a><span class='hs-comment'>--   Used for Monad without Applicative and MonadPlus without Alternative.</span>
<a name="line-120"></a><span class='hs-definition'>tcAmpMissingParentClassWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-comment'>-- ^ Class instance is defined for</span>
<a name="line-121"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-comment'>-- ^ Class it should also be instance of</span>
<a name="line-122"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-comment'>-- Notation: is* is for classes the type is an instance of, should* for those</span>
<a name="line-125"></a><span class='hs-comment'>--           that it should also be an instance of based on the corresponding</span>
<a name="line-126"></a><span class='hs-comment'>--           is*.</span>
<a name="line-127"></a><span class='hs-comment'>--           Example: in case of Applicative/Monad: is = Monad,</span>
<a name="line-128"></a><span class='hs-comment'>--                                                  should = Applicative</span>
<a name="line-129"></a><span class='hs-definition'>tcAmpMissingParentClassWarn</span> <span class='hs-varid'>isName</span> <span class='hs-varid'>shouldName</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>isClass'</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass_maybe</span> <span class='hs-varid'>isName</span>
<a name="line-131"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>shouldClass'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass_maybe</span> <span class='hs-varid'>shouldName</span>
<a name="line-132"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>isClass'</span><span class='hs-layout'>,</span> <span class='hs-varid'>shouldClass'</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-133"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>isClass</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>shouldClass</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-134"></a>                  <span class='hs-layout'>{</span> <span class='hs-varid'>localInstances</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInsts</span>
<a name="line-135"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>isInstance</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_cls</span> <span class='hs-varid'>m</span> <span class='hs-varop'>==</span> <span class='hs-varid'>isClass</span>
<a name="line-136"></a>                        <span class='hs-varid'>isInsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isInstance</span> <span class='hs-varid'>localInstances</span>
<a name="line-137"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcAmpMissingParentClassWarn/isInsts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>isInsts</span><span class='hs-layout'>)</span>
<a name="line-138"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>forM_</span> <span class='hs-varid'>isInsts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkShouldInst</span> <span class='hs-varid'>isClass</span> <span class='hs-varid'>shouldClass</span>
<a name="line-139"></a>                  <span class='hs-layout'>}</span>
<a name="line-140"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-141"></a>       <span class='hs-layout'>}</span>
<a name="line-142"></a>  <span class='hs-keyword'>where</span>
<a name="line-143"></a>    <span class='hs-comment'>-- Checks whether the desired superclass exists in a given environment.</span>
<a name="line-144"></a>    <span class='hs-varid'>checkShouldInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span>   <span class='hs-comment'>-- ^ Class of existing instance</span>
<a name="line-145"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span>   <span class='hs-comment'>-- ^ Class there should be an instance of</span>
<a name="line-146"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClsInst</span> <span class='hs-comment'>-- ^ Existing instance</span>
<a name="line-147"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-148"></a>    <span class='hs-varid'>checkShouldInst</span> <span class='hs-varid'>isClass</span> <span class='hs-varid'>shouldClass</span> <span class='hs-varid'>isInst</span>
<a name="line-149"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>instEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-150"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>instanceMatches</span><span class='hs-layout'>,</span> <span class='hs-varid'>shouldInsts</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-151"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-varid'>instEnv</span> <span class='hs-varid'>shouldClass</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_tys</span> <span class='hs-varid'>isInst</span><span class='hs-layout'>)</span>
<a name="line-152"></a>
<a name="line-153"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcAmpMissingParentClassWarn/checkShouldInst"</span>
<a name="line-154"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>isInst</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span>
<a name="line-155"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>instanceMatches</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>shouldInsts</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-156"></a>
<a name="line-157"></a>           <span class='hs-comment'>-- "&lt;location&gt;: Warning: &lt;type&gt; is an instance of &lt;is&gt; but not &lt;should&gt;"</span>
<a name="line-158"></a>           <span class='hs-comment'>-- e.g. "Foo is an instance of Monad but not Applicative"</span>
<a name="line-159"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>instLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcLocSpan</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nameSrcLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>isInst</span>
<a name="line-160"></a>                 <span class='hs-varid'>warnMsg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>name</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-161"></a>                      <span class='hs-varid'>addWarnAt</span> <span class='hs-varid'>instLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span>
<a name="line-162"></a>                           <span class='hs-keyglyph'>[</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-163"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an instance of"</span><span class='hs-layout'>)</span>
<a name="line-164"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>className</span> <span class='hs-varid'>isClass</span>
<a name="line-165"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but not"</span><span class='hs-layout'>)</span>
<a name="line-166"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>className</span> <span class='hs-varid'>shouldClass</span>
<a name="line-167"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"- this will become an error in GHC 7.10,"</span><span class='hs-layout'>)</span>
<a name="line-168"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"under the Applicative-Monad Proposal."</span><span class='hs-layout'>)</span>
<a name="line-169"></a>                           <span class='hs-keyglyph'>]</span>
<a name="line-170"></a>                 <span class='hs-varid'>warnMsg</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-171"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>shouldInsts</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>instanceMatches</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-172"></a>                  <span class='hs-varid'>warnMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_tcs</span> <span class='hs-varid'>isInst</span><span class='hs-layout'>)</span>
<a name="line-173"></a>           <span class='hs-layout'>}</span>
<a name="line-174"></a>
<a name="line-175"></a>
<a name="line-176"></a><a name="tcLookupClass_maybe"></a><span class='hs-comment'>-- | Looks up a class, returning Nothing on failure. Similar to</span>
<a name="line-177"></a><span class='hs-comment'>--   TcEnv.tcLookupClass, but does not issue any error messages.</span>
<a name="line-178"></a><span class='hs-comment'>--</span>
<a name="line-179"></a><span class='hs-comment'>-- In particular, it may be called by the AMP check on, say, </span>
<a name="line-180"></a><span class='hs-comment'>-- Control.Applicative.Applicative, well before Control.Applicative </span>
<a name="line-181"></a><span class='hs-comment'>-- has been compiled.  In this case we just return Nothing, and the</span>
<a name="line-182"></a><span class='hs-comment'>-- AMP test is silently dropped.</span>
<a name="line-183"></a><span class='hs-definition'>tcLookupClass_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Class</span><span class='hs-layout'>)</span>
<a name="line-184"></a><span class='hs-definition'>tcLookupClass_maybe</span> <span class='hs-varid'>name</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupImported_maybe</span> <span class='hs-varid'>name</span>
<a name="line-186"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-187"></a>            <span class='hs-conid'>Succeeded</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-188"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                tcTopSrcDecls
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="tcTopSrcDecls"></a><span class='hs-definition'>tcTopSrcDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsGroup</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tcTopSrcDecls</span> <span class='hs-varid'>boot_details</span>
<a name="line-3"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hs_tyclds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycl_decls</span><span class='hs-layout'>,</span>
<a name="line-4"></a>                   <span class='hs-varid'>hs_instds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_decls</span><span class='hs-layout'>,</span>
<a name="line-5"></a>                   <span class='hs-varid'>hs_derivds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deriv_decls</span><span class='hs-layout'>,</span>
<a name="line-6"></a>                   <span class='hs-varid'>hs_fords</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_decls</span><span class='hs-layout'>,</span>
<a name="line-7"></a>                   <span class='hs-varid'>hs_defds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>default_decls</span><span class='hs-layout'>,</span>
<a name="line-8"></a>                   <span class='hs-varid'>hs_annds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotation_decls</span><span class='hs-layout'>,</span>
<a name="line-9"></a>                   <span class='hs-varid'>hs_ruleds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule_decls</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                   <span class='hs-varid'>hs_vects</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vect_decls</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                   <span class='hs-varid'>hs_valds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>val_binds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-12"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>         <span class='hs-comment'>-- Type-check the type and class decls, and all imported decls</span>
<a name="line-13"></a>                <span class='hs-comment'>-- The latter come in via tycl_decls</span>
<a name="line-14"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc2 (src)"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-15"></a>
<a name="line-16"></a>                <span class='hs-comment'>-- Source-language instances, including derivings,</span>
<a name="line-17"></a>                <span class='hs-comment'>-- and import the supporting declarations</span>
<a name="line-18"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc3"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-19"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_infos</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_binds</span><span class='hs-layout'>)</span>
<a name="line-20"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyClsInstDecls</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span> <span class='hs-layout'>;</span>
<a name="line-21"></a>        <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span>       <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-22"></a>
<a name="line-23"></a>
<a name="line-24"></a>                <span class='hs-comment'>-- Generate Applicative/Monad proposal (AMP) warnings</span>
<a name="line-25"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc3b"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-26"></a>        <span class='hs-varid'>tcAmpWarn</span> <span class='hs-layout'>;</span>
<a name="line-27"></a>
<a name="line-28"></a>                <span class='hs-comment'>-- Foreign import declarations next.</span>
<a name="line-29"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc4"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-30"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fi_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_gres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcForeignImports</span> <span class='hs-varid'>foreign_decls</span> <span class='hs-layout'>;</span>
<a name="line-31"></a>        <span class='hs-varid'>tcExtendGlobalValEnv</span> <span class='hs-varid'>fi_ids</span>     <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-32"></a>
<a name="line-33"></a>                <span class='hs-comment'>-- Default declarations</span>
<a name="line-34"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc4a"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-35"></a>        <span class='hs-varid'>default_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDefaults</span> <span class='hs-varid'>default_decls</span> <span class='hs-layout'>;</span>
<a name="line-36"></a>        <span class='hs-varid'>updGblEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>gbl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gbl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_default</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>default_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-37"></a>
<a name="line-38"></a>                <span class='hs-comment'>-- Now GHC-generated derived bindings, generics, and selectors</span>
<a name="line-39"></a>                <span class='hs-comment'>-- Do not generate warnings from compiler-generated code;</span>
<a name="line-40"></a>                <span class='hs-comment'>-- hence the use of discardWarnings</span>
<a name="line-41"></a>        <span class='hs-varid'>tc_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>discardWarnings</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTopBinds</span> <span class='hs-varid'>deriv_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-42"></a>        <span class='hs-varid'>setEnvs</span> <span class='hs-varid'>tc_envs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-43"></a>
<a name="line-44"></a>                <span class='hs-comment'>-- Value declarations next</span>
<a name="line-45"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc5"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-46"></a>        <span class='hs-varid'>tc_envs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopBinds</span> <span class='hs-varid'>val_binds</span><span class='hs-layout'>;</span>
<a name="line-47"></a>        <span class='hs-varid'>setEnvs</span> <span class='hs-varid'>tc_envs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Environment doesn't change now</span>
<a name="line-48"></a>
<a name="line-49"></a>                <span class='hs-comment'>-- Second pass over class and instance declarations,</span>
<a name="line-50"></a>                <span class='hs-comment'>-- now using the kind-checked decls</span>
<a name="line-51"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc6"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-52"></a>        <span class='hs-varid'>inst_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstDecls2</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyClGroupConcat</span> <span class='hs-varid'>tycl_decls</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_infos</span> <span class='hs-layout'>;</span>
<a name="line-53"></a>
<a name="line-54"></a>                <span class='hs-comment'>-- Foreign exports</span>
<a name="line-55"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc7"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-56"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>foe_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>foe_decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>foe_gres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcForeignExports</span> <span class='hs-varid'>foreign_decls</span> <span class='hs-layout'>;</span>
<a name="line-57"></a>
<a name="line-58"></a>                <span class='hs-comment'>-- Annotations</span>
<a name="line-59"></a>        <span class='hs-varid'>annotations</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcAnnotations</span> <span class='hs-varid'>annotation_decls</span> <span class='hs-layout'>;</span>
<a name="line-60"></a>
<a name="line-61"></a>                <span class='hs-comment'>-- Rules</span>
<a name="line-62"></a>        <span class='hs-varid'>rules</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRules</span> <span class='hs-varid'>rule_decls</span> <span class='hs-layout'>;</span>
<a name="line-63"></a>
<a name="line-64"></a>                <span class='hs-comment'>-- Vectorisation declarations</span>
<a name="line-65"></a>        <span class='hs-varid'>vects</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcVectDecls</span> <span class='hs-varid'>vect_decls</span> <span class='hs-layout'>;</span>
<a name="line-66"></a>
<a name="line-67"></a>                <span class='hs-comment'>-- Wrap up</span>
<a name="line-68"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Tc7a"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-69"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>all_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_binds</span>     <span class='hs-varop'>`unionBags`</span>
<a name="line-70"></a>                          <span class='hs-varid'>foe_binds</span>
<a name="line-71"></a>
<a name="line-72"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>fo_gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fi_gres</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>foe_gres</span>
<a name="line-73"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>fo_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>gre</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span> 
<a name="line-74"></a>                                <span class='hs-varid'>emptyFVs</span> <span class='hs-varid'>fo_gres</span>
<a name="line-75"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>fo_rdr_names</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-76"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>fo_rdr_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>gre_to_rdr_name</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>fo_gres</span>
<a name="line-77"></a>
<a name="line-78"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>sig_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsValBinders</span> <span class='hs-varid'>val_binds</span><span class='hs-layout'>)</span>
<a name="line-79"></a>                          <span class='hs-varop'>`minusNameSet`</span> <span class='hs-varid'>getTypeSigNames</span> <span class='hs-varid'>val_binds</span>
<a name="line-80"></a>
<a name="line-81"></a>                <span class='hs-comment'>-- Extend the GblEnv with the (as yet un-zonked)</span>
<a name="line-82"></a>                <span class='hs-comment'>-- bindings, rules, foreign decls</span>
<a name="line-83"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_binds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_binds</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>all_binds</span>
<a name="line-84"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_sigs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_sigs</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>sig_names</span>
<a name="line-85"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_rules</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_rules</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rules</span>
<a name="line-86"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_vects</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_vects</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>++</span> <span class='hs-varid'>vects</span>
<a name="line-87"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_anns</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_anns</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>++</span> <span class='hs-varid'>annotations</span>
<a name="line-88"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_ann_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendAnnEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_ann_env</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>annotations</span>
<a name="line-89"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fords</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_fords</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>++</span> <span class='hs-varid'>foe_decls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fi_decls</span>
<a name="line-90"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_dus</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>`plusDU`</span> <span class='hs-varid'>usesOnly</span> <span class='hs-varid'>fo_fvs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-91"></a>                                 <span class='hs-comment'>-- tcg_dus: see Note [Newtype constructor usage in foreign declarations]</span>
<a name="line-92"></a>
<a name="line-93"></a>        <span class='hs-varid'>addUsedRdrNames</span> <span class='hs-varid'>fo_rdr_names</span> <span class='hs-layout'>;</span>
<a name="line-94"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcl_env</span><span class='hs-layout'>)</span>
<a name="line-95"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-96"></a>  <span class='hs-keyword'>where</span>
<a name="line-97"></a>    <span class='hs-varid'>gre_to_rdr_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-98"></a>        <span class='hs-comment'>-- For *imported* newtype data constructors, we want to</span>
<a name="line-99"></a>        <span class='hs-comment'>-- make sure that at least one of the imports for them is used</span>
<a name="line-100"></a>        <span class='hs-comment'>-- See Note [Newtype constructor usage in foreign declarations]</span>
<a name="line-101"></a>    <span class='hs-varid'>gre_to_rdr_name</span> <span class='hs-varid'>gre</span> <span class='hs-varid'>rdrs</span>
<a name="line-102"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>gre_prov</span> <span class='hs-varid'>gre</span> <span class='hs-keyword'>of</span>
<a name="line-103"></a>           <span class='hs-conid'>LocalDef</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rdrs</span>
<a name="line-104"></a>           <span class='hs-conid'>Imported</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"gre_to_rdr_name: Imported []"</span>
<a name="line-105"></a>           <span class='hs-conid'>Imported</span> <span class='hs-layout'>(</span><span class='hs-varid'>is</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrQual</span> <span class='hs-varid'>modName</span> <span class='hs-varid'>occName</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rdrs</span>
<a name="line-106"></a>              <span class='hs-keyword'>where</span>
<a name="line-107"></a>                <span class='hs-varid'>modName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_as</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-108"></a>                <span class='hs-varid'>occName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="tcTyClsInstDecls"></a><span class='hs-comment'>---------------------------</span>
<a name="line-111"></a><span class='hs-definition'>tcTyClsInstDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span> 
<a name="line-112"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyClGroup</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> 
<a name="line-113"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-114"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDerivDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- The full inst env</span>
<a name="line-116"></a>                         <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Source-code instance decls to process;</span>
<a name="line-117"></a>                                              <span class='hs-comment'>-- contains all dfuns for this module</span>
<a name="line-118"></a>                          <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Supporting bindings for derived instances</span>
<a name="line-119"></a>
<a name="line-120"></a><span class='hs-definition'>tcTyClsInstDecls</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-121"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendKindEnv2</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-conid'>APromotionErr</span> <span class='hs-conid'>FamDataConPE</span><span class='hs-layout'>)</span> 
<a name="line-122"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inst_decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_cons</span> <span class='hs-varid'>lid</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-123"></a>      <span class='hs-comment'>-- Note [AFamDataCon: not promoting data family constructors]</span>
<a name="line-124"></a>   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyAndClassDecls</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-layout'>;</span>
<a name="line-125"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>$</span>
<a name="line-126"></a>        <span class='hs-varid'>tcInstDecls1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyClGroupConcat</span> <span class='hs-varid'>tycl_decls</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span> <span class='hs-layout'>}</span>
<a name="line-127"></a>  <span class='hs-keyword'>where</span>
<a name="line-128"></a>    <span class='hs-comment'>-- get_cons extracts the *constructor* bindings of the declaration</span>
<a name="line-129"></a>    <span class='hs-varid'>get_cons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-130"></a>    <span class='hs-varid'>get_cons</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstD</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-131"></a>    <span class='hs-varid'>get_cons</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamInstD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fid</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_fi_cons</span> <span class='hs-varid'>fid</span>
<a name="line-132"></a>    <span class='hs-varid'>get_cons</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClsInstD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cid_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClsInstDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cid_datafam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fids</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-133"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_fi_cons</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>fids</span>
<a name="line-134"></a>
<a name="line-135"></a>    <span class='hs-varid'>get_fi_cons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataFamInstDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-136"></a>    <span class='hs-varid'>get_fi_cons</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamInstDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_defn</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsDataDefn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dd_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-137"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>con_name</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons</span>
</pre>\end{code}

Note [AFamDataCon: not promoting data family constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  data family T a
  data instance T Int = MkT
  data Proxy (a :: k)
  data S = MkS (Proxy 'MkT)

Is it ok to use the promoted data family instance constructor 'MkT' in
the data declaration for S?  No, we don't allow this. It *might* make
sense, but at least it would mean that we'd have to interleave
typechecking instances and data types, whereas at present we do data
types *then* instances.

So to check for this we put in the TcLclEnv a binding for all the family
constructors, bound to AFamDataCon, so that if we trip over 'MkT' when
type checking 'S' we'll produce a decent error message.


%************************************************************************
%*                                                                      *
        Checking for 'main'
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="checkMain"></a><span class='hs-definition'>checkMain</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-2"></a><span class='hs-comment'>-- If we are in module Main, check that 'main' is defined.</span>
<a name="line-3"></a><span class='hs-definition'>checkMain</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span> <span class='hs-layout'>;</span>
<a name="line-5"></a>         <span class='hs-varid'>dflags</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span> <span class='hs-layout'>;</span>
<a name="line-6"></a>         <span class='hs-varid'>check_main</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tcg_env</span>
<a name="line-7"></a>    <span class='hs-layout'>}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="check_main"></a><span class='hs-definition'>check_main</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-10"></a><span class='hs-definition'>check_main</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tcg_env</span>
<a name="line-11"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>main_mod</span>
<a name="line-12"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkMain not"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-13"></a>   <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env</span>
<a name="line-14"></a>
<a name="line-15"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-16"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>mb_main</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGlobalOccRn_maybe</span> <span class='hs-varid'>main_fn</span>
<a name="line-17"></a>                <span class='hs-comment'>-- Check that 'main' is in scope</span>
<a name="line-18"></a>                <span class='hs-comment'>-- It might be imported from another module!</span>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_main</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-20"></a>             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkMain fail"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>main_fn</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>complain_no_main</span>
<a name="line-22"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-23"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>main_name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkMain found"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>main_fn</span><span class='hs-layout'>)</span>
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcLocSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>main_name</span><span class='hs-layout'>)</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ioTyCon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>ioTyConName</span>
<a name="line-28"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>main_expr</span>
<a name="line-30"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>mainCtxt</span>    <span class='hs-varop'>$</span>
<a name="line-31"></a>                   <span class='hs-varid'>tcMonoExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>main_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ioTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>res_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a>                <span class='hs-comment'>-- See Note [Root-main Id]</span>
<a name="line-34"></a>                <span class='hs-comment'>-- Construct the binding</span>
<a name="line-35"></a>                <span class='hs-comment'>--      :Main.main :: IO res_ty = runMainIO res_ty main</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>run_main_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>runMainIOName</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>root_main_name</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mkExternalName</span> <span class='hs-varid'>rootMainKey</span> <span class='hs-varid'>rOOT_MAIN</span>
<a name="line-38"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"main"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>main_name</span><span class='hs-layout'>)</span>
<a name="line-40"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>root_main_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>mkExportedLocalId</span> <span class='hs-conid'>VanillaId</span> <span class='hs-varid'>root_main_name</span>
<a name="line-41"></a>                                                    <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ioTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>res_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-42"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpTyApps</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>res_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-43"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrap</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>run_main_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>main_expr</span>
<a name="line-44"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>main_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarBind</span> <span class='hs-varid'>root_main_id</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_main</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>main_name</span><span class='hs-layout'>,</span>
<a name="line-47"></a>                            <span class='hs-varid'>tcg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_binds</span> <span class='hs-varid'>tcg_env</span>
<a name="line-48"></a>                                        <span class='hs-varop'>`snocBag`</span> <span class='hs-varid'>main_bind</span><span class='hs-layout'>,</span>
<a name="line-49"></a>                            <span class='hs-varid'>tcg_dus</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>tcg_env</span>
<a name="line-50"></a>                                        <span class='hs-varop'>`plusDU`</span> <span class='hs-varid'>usesOnly</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>main_name</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                        <span class='hs-comment'>-- Record the use of 'main', so that we don't</span>
<a name="line-52"></a>                        <span class='hs-comment'>-- complain about it being defined but not used</span>
<a name="line-53"></a>                 <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>mod</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>tcg_env</span>
<a name="line-57"></a>    <span class='hs-varid'>main_mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mainModIs</span> <span class='hs-varid'>dflags</span>
<a name="line-58"></a>    <span class='hs-varid'>main_fn</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getMainFun</span> <span class='hs-varid'>dflags</span>
<a name="line-59"></a>
<a name="line-60"></a>    <span class='hs-varid'>complain_no_main</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>LinkInMemory</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-61"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>noMainMsg</span>
<a name="line-62"></a>        <span class='hs-comment'>-- In interactive mode, don't worry about the absence of 'main'</span>
<a name="line-63"></a>        <span class='hs-comment'>-- In other modes, fail altogether, so that we don't go on</span>
<a name="line-64"></a>        <span class='hs-comment'>-- and complain a second time when processing the export list.</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>mainCtxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking the type of the"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_main_fn</span>
<a name="line-67"></a>    <span class='hs-varid'>noMainMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_main_fn</span>
<a name="line-68"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not defined in module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_mod</span><span class='hs-layout'>)</span>
<a name="line-69"></a>    <span class='hs-varid'>pp_main_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppMainFn</span> <span class='hs-varid'>main_fn</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="getMainFun"></a><span class='hs-comment'>-- | Get the unqualified name of the function to use as the \"main\" for the main module.</span>
<a name="line-72"></a><span class='hs-comment'>-- Either returns the default name or the one configured on the command line with -main-is</span>
<a name="line-73"></a><span class='hs-definition'>getMainFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-74"></a><span class='hs-definition'>getMainFun</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mainFunIs</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-75"></a>                      <span class='hs-conid'>Just</span> <span class='hs-varid'>fn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrUnqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a>                      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>main_RDR_Unqual</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="checkMainExported"></a><span class='hs-definition'>checkMainExported</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-79"></a><span class='hs-definition'>checkMainExported</span> <span class='hs-varid'>tcg_env</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcg_main</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyword'>of</span>
<a name="line-81"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- not the main module</span>
<a name="line-82"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>main_name</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-83"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-84"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>main_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mainModIs</span> <span class='hs-varid'>dflags</span>
<a name="line-85"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>main_name</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>availNames</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_exports</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-86"></a>                <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppMainFn</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameRdrName</span> <span class='hs-varid'>main_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-87"></a>                <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not exported by module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_mod</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="ppMainFn"></a><span class='hs-definition'>ppMainFn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-90"></a><span class='hs-definition'>ppMainFn</span> <span class='hs-varid'>main_fn</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>main_fn</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mainOcc</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"IO action"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_fn</span><span class='hs-layout'>)</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"main IO action"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_fn</span><span class='hs-layout'>)</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="mainOcc"></a><span class='hs-definition'>mainOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span>
<a name="line-97"></a><span class='hs-definition'>mainOcc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"main"</span><span class='hs-layout'>)</span>
</pre>\end{code}


Note [Root-main Id]
~~~~~~~~~~~~~~~~~~~
The function that the RTS invokes is always :Main.main, which we call
root_main_id.  (Because GHC allows the user to have a module not
called Main as the main module, we can't rely on the main function
being called "Main.main".  That's why root_main_id has a fixed module
":Main".)

This is unusual: it's a LocalId whose Name has a Module from another
module.  Tiresomely, we must filter it out again in MkIface, les we
get two defns for 'main' in the interface file!


%*********************************************************
%*                                                       *
                GHCi stuff
%*                                                       *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="runTcInteractive"></a><span class='hs-definition'>runTcInteractive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Initialise the tcg_inst_env with instances from all home modules.</span>
<a name="line-3"></a><span class='hs-comment'>-- This mimics the more selective call to hptInstances in tcRnImports</span>
<a name="line-4"></a><span class='hs-definition'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>thing_inside</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-6"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"setInteractiveContext"</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>            <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ic_tythings:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>icxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ic_insts:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LetBind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>instanceDFunId</span><span class='hs-layout'>)</span> <span class='hs-varid'>ic_insts</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ic_rn_gbl_env (LocalDef)"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-10"></a>                      <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>local_gres</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>occEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-varid'>icxt</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                                                 <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>local_gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isLocalGRE</span> <span class='hs-varid'>gres</span>
<a name="line-12"></a>                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>local_gres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>gbl_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbl_env</span> <span class='hs-layout'>{</span>
<a name="line-15"></a>                           <span class='hs-varid'>tcg_rdr_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-varid'>icxt</span>
<a name="line-16"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_type_env</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env</span>
<a name="line-17"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_insts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_insts</span>
<a name="line-18"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fam_insts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_finsts</span>
<a name="line-19"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_inst_env</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInstEnvList</span>
<a name="line-20"></a>                                               <span class='hs-layout'>(</span><span class='hs-varid'>extendInstEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_inst_env</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ic_insts</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                                               <span class='hs-varid'>home_insts</span>
<a name="line-22"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendFamInstEnvList</span>
<a name="line-23"></a>                                               <span class='hs-layout'>(</span><span class='hs-varid'>extendFamInstEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                                                                     <span class='hs-varid'>ic_finsts</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                                               <span class='hs-varid'>home_fam_insts</span>
<a name="line-26"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_field_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecFields</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameEnv</span> <span class='hs-varid'>con_fields</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                                                        <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>con_fields</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-28"></a>                              <span class='hs-comment'>-- setting tcg_field_env is necessary</span>
<a name="line-29"></a>                              <span class='hs-comment'>-- to make RecordWildCards work (test: ghci049)</span>
<a name="line-30"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fix_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_fix_env</span> <span class='hs-varid'>icxt</span>
<a name="line-31"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>tcg_default</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_default</span> <span class='hs-varid'>icxt</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>gbl_env'</span> <span class='hs-varop'>$</span>
<a name="line-34"></a>         <span class='hs-varid'>tcExtendGhciIdEnv</span> <span class='hs-varid'>ty_things</span> <span class='hs-varop'>$</span>   <span class='hs-comment'>-- See Note [Initialising the type environment for GHCi]</span>
<a name="line-35"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>                  <span class='hs-comment'>-- in TcEnv</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>home_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_fam_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hptInstances</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>icxt</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-40"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ic_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_finsts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_instances</span> <span class='hs-varid'>icxt</span>
<a name="line-41"></a>    <span class='hs-varid'>ty_things</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>icxt</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>type_env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTypeEnvWithImplicits</span> <span class='hs-varid'>ty_things</span>
<a name="line-44"></a>    <span class='hs-varid'>type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>type_env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>ic_insts</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                <span class='hs-comment'>-- Putting the dfuns in the type_env</span>
<a name="line-46"></a>                <span class='hs-comment'>-- is just to keep Core Lint happy</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-varid'>con_fields</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-49"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty_things</span>
<a name="line-50"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>]</span>
<a name="line-51"></a>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-54"></a><a name="tcRnStmt"></a><span class='hs-comment'>-- | The returned [Id] is the list of new Ids bound by this statement. It can</span>
<a name="line-55"></a><span class='hs-comment'>-- be used to extend the InteractiveContext via extendInteractiveContext.</span>
<a name="line-56"></a><span class='hs-comment'>--</span>
<a name="line-57"></a><span class='hs-comment'>-- The returned TypecheckedHsExpr is of type IO [ () ], a list of the bound</span>
<a name="line-58"></a><span class='hs-comment'>-- values, coerced to ().</span>
<a name="line-59"></a><span class='hs-definition'>tcRnStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GhciLStmt</span> <span class='hs-conid'>RdrName</span>
<a name="line-60"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-definition'>tcRnStmt</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>rdr_stmt</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-comment'>-- The real work is done here</span>
<a name="line-65"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>bound_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_expr</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcUserStmt</span> <span class='hs-varid'>rdr_stmt</span> <span class='hs-layout'>;</span>
<a name="line-66"></a>    <span class='hs-varid'>zonked_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTopLExpr</span> <span class='hs-varid'>tc_expr</span> <span class='hs-layout'>;</span>
<a name="line-67"></a>    <span class='hs-varid'>zonked_ids</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTopBndrs</span> <span class='hs-varid'>bound_ids</span> <span class='hs-layout'>;</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-comment'>-- None of the Ids should be of unboxed type, because we</span>
<a name="line-70"></a>        <span class='hs-comment'>-- cast them all to HValues in the end!</span>
<a name="line-71"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-varid'>bad_unboxed</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span><span class='hs-layout'>)</span> <span class='hs-varid'>zonked_ids</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcs 1"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-74"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>global_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>globaliseAndTidyId</span> <span class='hs-varid'>zonked_ids</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-75"></a>        <span class='hs-comment'>-- Note [Interactively-bound Ids in GHCi] in HscTypes</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-comment'>{- ---------------------------------------------
<a name="line-78"></a>   At one stage I removed any shadowed bindings from the type_env;
<a name="line-79"></a>   they are inaccessible but might, I suppose, cause a space leak if we leave them there.
<a name="line-80"></a>   However, with Template Haskell they aren't necessarily inaccessible.  Consider this
<a name="line-81"></a>   GHCi session
<a name="line-82"></a>         Prelude&gt; let f n = n * 2 :: Int
<a name="line-83"></a>         Prelude&gt; fName &lt;- runQ [| f |]
<a name="line-84"></a>         Prelude&gt; $(return $ AppE fName (LitE (IntegerL 7)))
<a name="line-85"></a>         14
<a name="line-86"></a>         Prelude&gt; let f n = n * 3 :: Int
<a name="line-87"></a>         Prelude&gt; $(return $ AppE fName (LitE (IntegerL 7)))
<a name="line-88"></a>   In the last line we use 'fName', which resolves to the *first* 'f'
<a name="line-89"></a>   in scope. If we delete it from the type env, GHCi crashes because
<a name="line-90"></a>   it doesn't expect that.
<a name="line-91"></a>
<a name="line-92"></a>   Hence this code is commented out
<a name="line-93"></a>
<a name="line-94"></a>-------------------------------------------------- -}</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-varid'>dumpOptTcRn</span> <span class='hs-conid'>Opt_D_dump_tc</span>
<a name="line-97"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Bound Ids"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>global_ids</span><span class='hs-layout'>,</span>
<a name="line-98"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"Typechecked expr"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>zonked_expr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-99"></a>
<a name="line-100"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>global_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonked_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span>
<a name="line-101"></a>    <span class='hs-layout'>}</span>
<a name="line-102"></a>  <span class='hs-keyword'>where</span>
<a name="line-103"></a>    <span class='hs-varid'>bad_unboxed</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"GHCi can't bind a variable of unlifted type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-104"></a>                                  <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}


--------------------------------------------------------------------------
                Typechecking Stmts in GHCi

Here is the grand plan, implemented in tcUserStmt

        What you type                   The IO [HValue] that hscStmt returns
        -------------                   ------------------------------------
        let pat = expr          ==>     let pat = expr in return [coerce HVal x, coerce HVal y, ...]
                                        bindings: [x,y,...]

        pat <- expr             ==>     expr >>= \ pat -> return [coerce HVal x, coerce HVal y, ...]
                                        bindings: [x,y,...]

        expr (of IO type)       ==>     expr >>= \ it -> return [coerce HVal it]
          [NB: result not printed]      bindings: [it]

        expr (of non-IO type,   ==>     let it = expr in print it >> return [coerce HVal it]
          result showable)              bindings: [it]

        expr (of non-IO type,
          result not showable)  ==>     error

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="PlanResult"></a><span class='hs-comment'>-- | A plan is an attempt to lift some code into the IO monad.</span>
<a name="line-3"></a><a name="PlanResult"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PlanResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-4"></a><a name="Plan"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Plan</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PlanResult</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="runPlans"></a><span class='hs-comment'>-- | Try the plans in order. If one fails (by raising an exn), try the next.</span>
<a name="line-7"></a><span class='hs-comment'>-- If one succeeds, take it.</span>
<a name="line-8"></a><span class='hs-definition'>runPlans</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Plan</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PlanResult</span>
<a name="line-9"></a><span class='hs-definition'>runPlans</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"runPlans"</span>
<a name="line-10"></a><span class='hs-definition'>runPlans</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-11"></a><span class='hs-definition'>runPlans</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryTcLIE_</span> <span class='hs-layout'>(</span><span class='hs-varid'>runPlans</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="tcUserStmt"></a><span class='hs-comment'>-- | Typecheck (and 'lift') a stmt entered by the user in GHCi into the</span>
<a name="line-14"></a><span class='hs-comment'>-- GHCi 'environemnt'.</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- By 'lift' and 'environment we mean that the code is changed to</span>
<a name="line-17"></a><span class='hs-comment'>-- execute properly in an IO monad. See Note [Interactively-bound Ids</span>
<a name="line-18"></a><span class='hs-comment'>-- in GHCi] in HscTypes for more details. We do this lifting by trying</span>
<a name="line-19"></a><span class='hs-comment'>-- different ways ('plans') of lifting the code into the IO monad and</span>
<a name="line-20"></a><span class='hs-comment'>-- type checking each plan until one succeeds.</span>
<a name="line-21"></a><span class='hs-definition'>tcUserStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhciLStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>PlanResult</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-comment'>-- An expression typed at the prompt is treated very specially</span>
<a name="line-24"></a><span class='hs-definition'>tcUserStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-26"></a>               <span class='hs-comment'>-- Don't try to typecheck if the renamer fails!</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ghciStep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGhciStepIO</span>
<a name="line-28"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>interPrintName</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInteractivePrintName</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fresh_it</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>itName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>loc</span>
<a name="line-31"></a>              <span class='hs-varid'>matches</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkMatch</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>rn_expr</span> <span class='hs-varid'>emptyLocalBinds</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>              <span class='hs-comment'>-- [it = expr]</span>
<a name="line-33"></a>              <span class='hs-varid'>the_bind</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopFunBind</span> <span class='hs-conid'>FromSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fresh_it</span><span class='hs-layout'>)</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>                          <span class='hs-comment'>-- Care here!  In GHCi the expression might have</span>
<a name="line-35"></a>                          <span class='hs-comment'>-- free variables, and they in turn may have free type variables</span>
<a name="line-36"></a>                          <span class='hs-comment'>-- (if we are at a breakpoint, say).  We must put those free vars</span>
<a name="line-37"></a>
<a name="line-38"></a>              <span class='hs-comment'>-- [let it = expr]</span>
<a name="line-39"></a>              <span class='hs-varid'>let_stmt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LetStmt</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-varop'>$</span>
<a name="line-40"></a>                          <span class='hs-conid'>ValBindsOut</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>NonRecursive</span><span class='hs-layout'>,</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>the_bind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span>
<a name="line-41"></a>
<a name="line-42"></a>              <span class='hs-comment'>-- [it &lt;- e]</span>
<a name="line-43"></a>              <span class='hs-varid'>bind_stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarPat</span> <span class='hs-varid'>fresh_it</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>nlHsApp</span> <span class='hs-varid'>ghciStep</span> <span class='hs-varid'>rn_expr</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                                           <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>bindIOName</span><span class='hs-layout'>)</span> <span class='hs-varid'>noSyntaxExpr</span>
<a name="line-46"></a>
<a name="line-47"></a>              <span class='hs-comment'>-- [; print it]</span>
<a name="line-48"></a>              <span class='hs-varid'>print_it</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>interPrintName</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>fresh_it</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>                                           <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>thenIOName</span><span class='hs-layout'>)</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>placeHolderType</span>
<a name="line-50"></a>
<a name="line-51"></a>        <span class='hs-comment'>-- The plans are:</span>
<a name="line-52"></a>        <span class='hs-comment'>--   A. [it &lt;- e; print it]     but not if it::()</span>
<a name="line-53"></a>        <span class='hs-comment'>--   B. [it &lt;- e]</span>
<a name="line-54"></a>        <span class='hs-comment'>--   C. [let it = e; print it]</span>
<a name="line-55"></a>        <span class='hs-comment'>--</span>
<a name="line-56"></a>        <span class='hs-comment'>-- Ensure that type errors don't get deferred when type checking the</span>
<a name="line-57"></a>        <span class='hs-comment'>-- naked expression. Deferring type errors here is unhelpful because the</span>
<a name="line-58"></a>        <span class='hs-comment'>-- expression gets evaluated right away anyway. It also would potentially</span>
<a name="line-59"></a>        <span class='hs-comment'>-- emit two redundant type-error warnings, one from each plan.</span>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>plan</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsetGOptM</span> <span class='hs-conid'>Opt_DeferTypeErrors</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runPlans</span> <span class='hs-keyglyph'>[</span>
<a name="line-61"></a>                    <span class='hs-comment'>-- Plan A</span>
<a name="line-62"></a>                    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>it_id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGhciStmts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bind_stmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>print_it</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>it_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>it_id</span><span class='hs-layout'>)</span>
<a name="line-64"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnitTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>it_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>failM</span>
<a name="line-65"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-66"></a>
<a name="line-67"></a>                        <span class='hs-comment'>-- Plan B; a naked bind statment</span>
<a name="line-68"></a>                    <span class='hs-varid'>tcGhciStmts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bind_stmt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-69"></a>
<a name="line-70"></a>                        <span class='hs-comment'>-- Plan C; check that the let-binding is typeable all by itself.</span>
<a name="line-71"></a>                        <span class='hs-comment'>-- If not, fail; if so, try to print it.</span>
<a name="line-72"></a>                        <span class='hs-comment'>-- The two-step process avoids getting two errors: one from</span>
<a name="line-73"></a>                        <span class='hs-comment'>-- the expression itself, and one from the 'print it' part</span>
<a name="line-74"></a>                        <span class='hs-comment'>-- This two-step story is very clunky, alas</span>
<a name="line-75"></a>                    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGhciStmts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>let_stmt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-76"></a>                                <span class='hs-comment'>--- checkNoErrs defeats the error recovery of let-bindings</span>
<a name="line-77"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>tcGhciStmts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>let_stmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>print_it</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>]</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fix_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFixityEnv</span>
<a name="line-80"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>plan</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-definition'>tcUserStmt</span> <span class='hs-varid'>rdr_stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>rn_stmt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-84"></a>           <span class='hs-varid'>rnStmts</span> <span class='hs-conid'>GhciStmtCtxt</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rdr_stmt</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-85"></a>             <span class='hs-varid'>fix_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFixityEnv</span>
<a name="line-86"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fix_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-87"></a>            <span class='hs-comment'>-- Don't try to typecheck if the renamer fails!</span>
<a name="line-88"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"tcRnStmt"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_stmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_stmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fvs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-89"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rnDump</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_stmt</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-90"></a>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ghciStep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGhciStepIO</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>gi_stmt</span>
<a name="line-93"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>op2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_stmt</span>
<a name="line-94"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsApp</span> <span class='hs-varid'>ghciStep</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>op2</span>
<a name="line-95"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rn_stmt</span>
<a name="line-96"></a>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>opt_pr_flag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_PrintBindResult</span>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>print_result_plan</span>
<a name="line-99"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_pr_flag</span>                         <span class='hs-comment'>-- The flag says "print result"   </span>
<a name="line-100"></a>               <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collectLStmtBinders</span> <span class='hs-varid'>gi_stmt</span>  <span class='hs-comment'>-- One binder</span>
<a name="line-101"></a>                           <span class='hs-keyglyph'>=</span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>mk_print_result_plan</span> <span class='hs-varid'>gi_stmt</span> <span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-103"></a>
<a name="line-104"></a>        <span class='hs-comment'>-- The plans are:</span>
<a name="line-105"></a>        <span class='hs-comment'>--      [stmt; print v]         if one binder and not v::()</span>
<a name="line-106"></a>        <span class='hs-comment'>--      [stmt]                  otherwise</span>
<a name="line-107"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>plan</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runPlans</span> <span class='hs-layout'>(</span><span class='hs-varid'>print_result_plan</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tcGhciStmts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>gi_stmt</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-108"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>plan</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>  <span class='hs-keyword'>where</span>
<a name="line-110"></a>    <span class='hs-varid'>mk_print_result_plan</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>v</span>
<a name="line-111"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>v_id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGhciStmts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>stmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>print_v</span><span class='hs-keyglyph'>]</span>
<a name="line-112"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>v_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>v_id</span><span class='hs-layout'>)</span>
<a name="line-113"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnitTy</span> <span class='hs-varid'>v_ty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTauTy</span> <span class='hs-varid'>v_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>failM</span>
<a name="line-114"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>      <span class='hs-keyword'>where</span>
<a name="line-116"></a>        <span class='hs-varid'>print_v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>printName</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-117"></a>                                    <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>thenIOName</span><span class='hs-layout'>)</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>placeHolderType</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="tcGhciStmts"></a><span class='hs-comment'>-- | Typecheck the statements given and then return the results of the</span>
<a name="line-120"></a><span class='hs-comment'>-- statement in the form 'IO [()]'.</span>
<a name="line-121"></a><span class='hs-definition'>tcGhciStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GhciLStmt</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PlanResult</span>
<a name="line-122"></a><span class='hs-definition'>tcGhciStmts</span> <span class='hs-varid'>stmts</span>
<a name="line-123"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ioTyCon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>ioTyConName</span> <span class='hs-layout'>;</span>
<a name="line-124"></a>        <span class='hs-varid'>ret_id</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>returnIOName</span> <span class='hs-layout'>;</span>            <span class='hs-comment'>-- return @ IO</span>
<a name="line-125"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span>
<a name="line-126"></a>            <span class='hs-varid'>ret_ty</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkListTy</span> <span class='hs-varid'>unitTy</span> <span class='hs-layout'>;</span>
<a name="line-127"></a>            <span class='hs-varid'>io_ret_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ioTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ret_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>;</span>
<a name="line-128"></a>            <span class='hs-varid'>tc_io_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-conid'>GhciStmtCtxt</span> <span class='hs-varid'>tcDoStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>io_ret_ty</span> <span class='hs-layout'>;</span>
<a name="line-129"></a>            <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLStmtsBinders</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>;</span>
<a name="line-130"></a>         <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-131"></a>
<a name="line-132"></a>        <span class='hs-comment'>-- OK, we're ready to typecheck the stmts</span>
<a name="line-133"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"TcRnDriver.tcGhciStmts: tc stmts"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-134"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tc_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span>
<a name="line-135"></a>                                  <span class='hs-varid'>tc_io_stmts</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-136"></a>                                  <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>names</span>  <span class='hs-layout'>;</span>
<a name="line-137"></a>                        <span class='hs-comment'>-- Look up the names right in the middle,</span>
<a name="line-138"></a>                        <span class='hs-comment'>-- where they will all be in scope</span>
<a name="line-139"></a>
<a name="line-140"></a>        <span class='hs-comment'>-- Simplify the context</span>
<a name="line-141"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"TcRnDriver.tcGhciStmts: simplify ctxt"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-142"></a>        <span class='hs-varid'>const_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>simplifyInteractive</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-143"></a>                <span class='hs-comment'>-- checkNoErrs ensures that the plan fails if context redn fails</span>
<a name="line-144"></a>
<a name="line-145"></a>        <span class='hs-varid'>traceTc</span> <span class='hs-str'>"TcRnDriver.tcGhciStmts: done"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>;</span>
<a name="line-146"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- mk_return builds the expression</span>
<a name="line-147"></a>                <span class='hs-comment'>--      returnIO @ [()] [coerce () x, ..,  coerce () z]</span>
<a name="line-148"></a>                <span class='hs-comment'>--</span>
<a name="line-149"></a>                <span class='hs-comment'>-- Despite the inconvenience of building the type applications etc,</span>
<a name="line-150"></a>                <span class='hs-comment'>-- this *has* to be done in type-annotated post-typecheck form</span>
<a name="line-151"></a>                <span class='hs-comment'>-- because we are going to return a list of *polymorphic* values</span>
<a name="line-152"></a>                <span class='hs-comment'>-- coerced to type (). If we built a *source* stmt</span>
<a name="line-153"></a>                <span class='hs-comment'>--      return [coerce x, ..., coerce z]</span>
<a name="line-154"></a>                <span class='hs-comment'>-- then the type checker would instantiate x..z, and we wouldn't</span>
<a name="line-155"></a>                <span class='hs-comment'>-- get their *polymorphic* values.  (And we'd get ambiguity errs</span>
<a name="line-156"></a>                <span class='hs-comment'>-- if they were overloaded, since they aren't applied to anything.)</span>
<a name="line-157"></a>            <span class='hs-varid'>ret_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>ret_id</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ret_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-158"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>unitTy</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mk_item</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-159"></a>            <span class='hs-varid'>mk_item</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>unsafeCoerceId</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitTy</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-160"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-161"></a>            <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_stmts</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLastStmt</span> <span class='hs-varid'>ret_expr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a>        <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-163"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHsDictLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>const_binds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-164"></a>                     <span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>GhciStmtCtxt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>io_ret_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-165"></a>    <span class='hs-layout'>}</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="getGhciStepIO"></a><span class='hs-comment'>-- | Generate a typed ghciStepIO expression (ghciStep :: Ty a -&gt; IO a)</span>
<a name="line-168"></a><span class='hs-definition'>getGhciStepIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-169"></a><span class='hs-definition'>getGhciStepIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-170"></a>    <span class='hs-varid'>ghciTy</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGHCiMonad</span>
<a name="line-171"></a>    <span class='hs-varid'>fresh_a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-172"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>a_tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>fresh_a</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"a"</span><span class='hs-layout'>)</span>
<a name="line-173"></a>        <span class='hs-varid'>ghciM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyVar</span> <span class='hs-varid'>ghciTy</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyVar</span> <span class='hs-varid'>a_tv</span><span class='hs-layout'>)</span>
<a name="line-174"></a>        <span class='hs-varid'>ioM</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyVar</span> <span class='hs-varid'>ioTyConName</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyVar</span> <span class='hs-varid'>a_tv</span><span class='hs-layout'>)</span>
<a name="line-175"></a>
<a name="line-176"></a>        <span class='hs-varid'>stepTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span>    <span class='hs-comment'>-- Renamed, so needs all binders in place</span>
<a name="line-177"></a>        <span class='hs-varid'>stepTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Implicit</span>
<a name="line-178"></a>                            <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>a_tv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-179"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-180"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-181"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>nlHsFunTy</span> <span class='hs-varid'>ghciM</span> <span class='hs-varid'>ioM</span><span class='hs-layout'>)</span>
<a name="line-182"></a>        <span class='hs-varid'>step</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExprWithTySig</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>ghciStepIoMName</span><span class='hs-layout'>)</span> <span class='hs-varid'>stepTy</span>
<a name="line-183"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>step</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="isGHCiMonad"></a><span class='hs-definition'>isGHCiMonad</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-186"></a><span class='hs-definition'>isGHCiMonad</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>ty</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-188"></a>        <span class='hs-varid'>rdrEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGlobalRdrEnv</span>
<a name="line-189"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>occIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>rdrEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tcName</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-190"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>occIO</span> <span class='hs-keyword'>of</span>
<a name="line-191"></a>            <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-192"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>n</span>
<a name="line-193"></a>                <span class='hs-varid'>ghciClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ghciIoClassName</span> 
<a name="line-194"></a>                <span class='hs-varid'>userTyCon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>name</span>
<a name="line-195"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>userTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>userTyCon</span> <span class='hs-conid'>[]</span>
<a name="line-196"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupInstance</span> <span class='hs-varid'>ghciClass</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>userTy</span><span class='hs-keyglyph'>]</span>
<a name="line-197"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>name</span>
<a name="line-198"></a>
<a name="line-199"></a>            <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Ambigous type!"</span>
<a name="line-200"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Can't find type:"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-201"></a>
</pre>\end{code}

tcRnExpr just finds the type of an expression

\begin{code}
<pre><a name="line-1"></a><a name="tcRnExpr"></a><span class='hs-definition'>tcRnExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-3"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-comment'>-- Type checks the expression and returns its most general type</span>
<a name="line-5"></a><span class='hs-definition'>tcRnExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>rdr_expr</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-7"></a>
<a name="line-8"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>rn_expr</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>rdr_expr</span> <span class='hs-layout'>;</span>
<a name="line-9"></a>    <span class='hs-varid'>failIfErrsM</span> <span class='hs-layout'>;</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-comment'>-- Now typecheck the expression;</span>
<a name="line-12"></a>        <span class='hs-comment'>-- it might have a rank-2 type (e.g. :t runST)</span>
<a name="line-13"></a>    <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span> <span class='hs-layout'>;</span>
<a name="line-14"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fresh_it</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>itName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>rdr_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-15"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-sel'>_tc_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span> 
<a name="line-16"></a>                                 <span class='hs-varid'>tcInferRho</span> <span class='hs-varid'>rn_expr</span> <span class='hs-layout'>;</span>
<a name="line-17"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie_top</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span>
<a name="line-18"></a>                                      <span class='hs-comment'>{-# SCC "simplifyInfer" #-}</span>
<a name="line-19"></a>                                      <span class='hs-varid'>simplifyInfer</span> <span class='hs-conid'>True</span> <span class='hs-comment'>{- Free vars are closed -}</span>
<a name="line-20"></a>                                                    <span class='hs-conid'>False</span> <span class='hs-comment'>{- No MR for now -}</span>
<a name="line-21"></a>                                                    <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>fresh_it</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>                                                    <span class='hs-varid'>lie</span> <span class='hs-layout'>;</span>
<a name="line-23"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyInteractive</span> <span class='hs-varid'>lie_top</span> <span class='hs-layout'>;</span>       <span class='hs-comment'>-- Ignore the dicionary bindings</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>all_expr_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>qtvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiTypes</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-26"></a>    <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>all_expr_ty</span>
<a name="line-27"></a>    <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="tcRnImportDecls"></a><span class='hs-comment'>--------------------------</span>
<a name="line-30"></a><span class='hs-definition'>tcRnImportDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-31"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-comment'>-- Find the new chunk of GlobalRdrEnv created by this list of import</span>
<a name="line-34"></a><span class='hs-comment'>-- decls.  In contract tcRnImports *extends* the TcGblEnv.</span>
<a name="line-35"></a><span class='hs-definition'>tcRnImportDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>import_decls</span>
<a name="line-36"></a> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-37"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gbl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>updGblEnv</span> <span class='hs-varid'>zap_rdr_env</span> <span class='hs-varop'>$</span>
<a name="line-38"></a>                    <span class='hs-varid'>tcRnImports</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>import_decls</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_rdr_env</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-40"></a>  <span class='hs-keyword'>where</span>
<a name="line-41"></a>    <span class='hs-varid'>zap_rdr_env</span> <span class='hs-varid'>gbl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbl_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyGlobalRdrEnv</span> <span class='hs-layout'>}</span>
</pre>\end{code}

tcRnType just finds the kind of a type

\begin{code}
<pre><a name="line-1"></a><a name="tcRnType"></a><span class='hs-definition'>tcRnType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>        <span class='hs-comment'>-- Normalise the returned type</span>
<a name="line-3"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-4"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>tcRnType</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>rdr_type</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-varid'>setXOptM</span> <span class='hs-conid'>Opt_PolyKinds</span> <span class='hs-varop'>$</span>   <span class='hs-comment'>-- See Note [Kind-generalise in tcRnType]</span>
<a name="line-8"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_type</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-conid'>GHCiCtx</span> <span class='hs-varid'>rdr_type</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>failIfErrsM</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-comment'>-- Now kind-check the type</span>
<a name="line-12"></a>        <span class='hs-comment'>-- It can have any rank or kind</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-conid'>GhciCtxt</span> <span class='hs-varid'>rn_type</span> <span class='hs-layout'>;</span>
<a name="line-14"></a>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>normalise</span>
<a name="line-16"></a>                <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-17"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>normaliseType</span> <span class='hs-varid'>fam_envs</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>                        <span class='hs-comment'>-- normaliseType returns a coercion</span>
<a name="line-19"></a>                        <span class='hs-comment'>-- which we discard, so the Role is irrelevant</span>
<a name="line-20"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>;</span>
<a name="line-21"></a>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Kind-generalise in tcRnType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We switch on PolyKinds when kind-checking a user type, so that we will
kind-generalise the type.  This gives the right default behaviour at
the GHCi prompt, where if you say ":k T", and T has a polymorphic
kind, you'd like to see that polymorphism. Of course.  If T isn't
kind-polymorphic you won't get anything unexpected, but the apparent
*loss* of polymorphism, for types that you know are polymorphic, is
quite surprising.  See Trac #7688 for a discussion.


%************************************************************************
%*                                                                      *
                 tcRnDeclsi
%*                                                                      *
%************************************************************************

tcRnDeclsi exists to allow class, data, and other declarations in GHCi.

\begin{code}
<pre><a name="line-1"></a><a name="tcRnDeclsi"></a><span class='hs-definition'>tcRnDeclsi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>tcRnDeclsi</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>local_decls</span> <span class='hs-keyglyph'>=</span>
<a name="line-6"></a>  <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-7"></a>
<a name="line-8"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tclcl_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-9"></a>        <span class='hs-varid'>captureConstraints</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tc_rn_src_decls</span> <span class='hs-varid'>emptyModDetails</span> <span class='hs-varid'>local_decls</span>
<a name="line-10"></a>    <span class='hs-varid'>setEnvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tclcl_env</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-11"></a>
<a name="line-12"></a>    <span class='hs-varid'>new_ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>lie</span>
<a name="line-13"></a>    <span class='hs-varid'>failIfErrsM</span>
<a name="line-14"></a>    <span class='hs-keyword'>let</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                   <span class='hs-varid'>tcg_binds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                   <span class='hs-varid'>tcg_sigs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_ns</span><span class='hs-layout'>,</span>
<a name="line-17"></a>                   <span class='hs-varid'>tcg_ev_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cur_ev_binds</span><span class='hs-layout'>,</span>
<a name="line-18"></a>                   <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_specs</span><span class='hs-layout'>,</span>
<a name="line-19"></a>                   <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span><span class='hs-layout'>,</span>
<a name="line-20"></a>                   <span class='hs-varid'>tcg_vects</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vects</span><span class='hs-layout'>,</span>
<a name="line-21"></a>                   <span class='hs-varid'>tcg_fords</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fords</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span>
<a name="line-22"></a>        <span class='hs-varid'>all_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cur_ev_binds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>new_ev_binds</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bind_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fords'</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_specs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules'</span><span class='hs-layout'>,</span> <span class='hs-varid'>vects'</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTopDecls</span> <span class='hs-varid'>all_ev_binds</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sig_ns</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>vects</span> <span class='hs-varid'>imp_specs</span> <span class='hs-varid'>fords</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>--global_ids = map globaliseAndTidyId bind_ids</span>
<a name="line-28"></a>        <span class='hs-varid'>final_type_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>type_env</span> <span class='hs-varid'>bind_ids</span> <span class='hs-varop'>--global_ids</span>
<a name="line-29"></a>        <span class='hs-varid'>tcg_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_binds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span>
<a name="line-30"></a>                             <span class='hs-varid'>tcg_ev_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds'</span><span class='hs-layout'>,</span>
<a name="line-31"></a>                             <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_specs'</span><span class='hs-layout'>,</span>
<a name="line-32"></a>                             <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules'</span><span class='hs-layout'>,</span>
<a name="line-33"></a>                             <span class='hs-varid'>tcg_vects</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vects'</span><span class='hs-layout'>,</span>
<a name="line-34"></a>                             <span class='hs-varid'>tcg_fords</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fords'</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-varid'>setGlobalTypeEnv</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-varid'>final_type_env</span>
<a name="line-37"></a>    
<a name="line-38"></a><span class='hs-cpp'>#endif /* GHCi */</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        More GHCi stuff, to do with browsing and getting info
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-cpp'>#</span><span class='hs-varid'>ifdef</span> <span class='hs-conid'>GHCI</span>
<a name="line-2"></a><a name="getModuleInterface"></a><span class='hs-comment'>-- | ASSUMES that the module is either in the 'HomePackageTable' or is</span>
<a name="line-3"></a><span class='hs-comment'>-- a package module with an interface on disk.  If neither of these is</span>
<a name="line-4"></a><span class='hs-comment'>-- true, then the result will be an error indicating the interface</span>
<a name="line-5"></a><span class='hs-comment'>-- could not be found.</span>
<a name="line-6"></a><span class='hs-definition'>getModuleInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>getModuleInterface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-9"></a>    <span class='hs-varid'>loadModuleInterface</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"getModuleInterface"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="tcRnLookupRdrName"></a><span class='hs-definition'>tcRnLookupRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>tcRnLookupRdrName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>rdr_name</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-14"></a>    <span class='hs-varid'>lookup_rdr_name</span> <span class='hs-varid'>rdr_name</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="lookup_rdr_name"></a><span class='hs-definition'>lookup_rdr_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a><span class='hs-definition'>lookup_rdr_name</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-18"></a>        <span class='hs-comment'>-- If the identifier is a constructor (begins with an</span>
<a name="line-19"></a>        <span class='hs-comment'>-- upper-case letter), then we need to consider both</span>
<a name="line-20"></a>        <span class='hs-comment'>-- constructor and type class identifiers.</span>
<a name="line-21"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>rdr_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataTcOccs</span> <span class='hs-varid'>rdr_name</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- results :: [Either Messages Name]</span>
<a name="line-24"></a>    <span class='hs-varid'>results</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tryTcErrs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookupOccRn</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdr_names</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"xx"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>results</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-27"></a>        <span class='hs-comment'>-- The successful lookups will be (Just name)</span>
<a name="line-28"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>good_names</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                                      <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>results</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a>        <span class='hs-varid'>errs_s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>msgs</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>results</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-comment'>-- Fail if nothing good happened, else add warnings</span>
<a name="line-33"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>good_names</span>
<a name="line-34"></a>      <span class='hs-keyword'>then</span>  <span class='hs-varid'>addMessages</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>errs_s</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>failM</span>
<a name="line-35"></a>                <span class='hs-comment'>-- No lookup succeeded, so</span>
<a name="line-36"></a>                <span class='hs-comment'>-- pick the first error message and report it</span>
<a name="line-37"></a>                <span class='hs-comment'>-- ToDo: If one of the errors is "could be Foo.X or Baz.X",</span>
<a name="line-38"></a>                <span class='hs-comment'>--       while the other is "X is not in scope",</span>
<a name="line-39"></a>                <span class='hs-comment'>--       we definitely want the former; but we might pick the latter</span>
<a name="line-40"></a>      <span class='hs-keyword'>else</span>      <span class='hs-varid'>mapM_</span> <span class='hs-varid'>addMessages</span> <span class='hs-varid'>warns_s</span>
<a name="line-41"></a>                <span class='hs-comment'>-- Add deprecation warnings</span>
<a name="line-42"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>good_names</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-cpp'>#endif</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="tcRnLookupName"></a><span class='hs-definition'>tcRnLookupName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-definition'>tcRnLookupName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-49"></a>    <span class='hs-varid'>tcRnLookupName'</span> <span class='hs-varid'>name</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-comment'>-- To look up a name we have to look in the local environment (tcl_lcl)</span>
<a name="line-52"></a><span class='hs-comment'>-- as well as the global environment, which is what tcLookup does.</span>
<a name="line-53"></a><span class='hs-comment'>-- But we also want a TyThing, so we have to convert:</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="tcRnLookupName'"></a><span class='hs-definition'>tcRnLookupName'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>TyThing</span>
<a name="line-56"></a><span class='hs-definition'>tcRnLookupName'</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-57"></a>   <span class='hs-varid'>tcthing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-58"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>tcthing</span> <span class='hs-keyword'>of</span>
<a name="line-59"></a>     <span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>thing</span>
<a name="line-60"></a>     <span class='hs-conid'>ATcId</span><span class='hs-layout'>{</span><span class='hs-varid'>tct_id</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>id</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-61"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcRnLookupName'"</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="tcRnGetInfo"></a><span class='hs-definition'>tcRnGetInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-64"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-65"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyThing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-comment'>-- Used to implement :info in GHCi</span>
<a name="line-68"></a><span class='hs-comment'>--</span>
<a name="line-69"></a><span class='hs-comment'>-- Look up a RdrName and return all the TyThings it might be</span>
<a name="line-70"></a><span class='hs-comment'>-- A capitalised RdrName is given to us in the DataName namespace,</span>
<a name="line-71"></a><span class='hs-comment'>-- but we want to treat it as *both* a data constructor</span>
<a name="line-72"></a><span class='hs-comment'>--  *and* as a type or class constructor;</span>
<a name="line-73"></a><span class='hs-comment'>-- hence the call to dataTcOccs, and we return up to two results</span>
<a name="line-74"></a><span class='hs-definition'>tcRnGetInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runTcInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-76"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loadUnqualIfaces</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-77"></a>           <span class='hs-comment'>-- Load the interface for all unqualified types and classes</span>
<a name="line-78"></a>           <span class='hs-comment'>-- That way we will find all the instance declarations</span>
<a name="line-79"></a>           <span class='hs-comment'>-- (Packages have not orphan modules, and we assume that</span>
<a name="line-80"></a>           <span class='hs-comment'>--  in the home package all relevant modules are loaded.)</span>
<a name="line-81"></a>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRnLookupName'</span> <span class='hs-varid'>name</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fixity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>name</span>
<a name="line-84"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInsts</span> <span class='hs-varid'>thing</span>
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="lookupInsts"></a><span class='hs-definition'>lookupInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-definition'>lookupInsts</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_ie</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_ie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-90"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_fie</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_fie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-91"></a>                <span class='hs-comment'>-- Load all instances for all classes that are</span>
<a name="line-92"></a>                <span class='hs-comment'>-- in the type environment (which are all the ones</span>
<a name="line-93"></a>                <span class='hs-comment'>-- we've seen in any interface file so far)</span>
<a name="line-94"></a>
<a name="line-95"></a>          <span class='hs-comment'>-- Return only the instances relevant to the given thing, i.e.</span>
<a name="line-96"></a>          <span class='hs-comment'>-- the instances whose head contains the thing's name.</span>
<a name="line-97"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cls_insts</span> <span class='hs-keyglyph'>=</span>
<a name="line-98"></a>                 <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ispec</span>        <span class='hs-comment'>-- Search all</span>
<a name="line-99"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instEnvElts</span> <span class='hs-varid'>home_ie</span> <span class='hs-varop'>++</span> <span class='hs-varid'>instEnvElts</span> <span class='hs-varid'>pkg_ie</span>
<a name="line-100"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>tc_name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>orphNamesOfClsInst</span> <span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>]</span>
<a name="line-101"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_insts</span> <span class='hs-keyglyph'>=</span>
<a name="line-102"></a>                 <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fispec</span>
<a name="line-103"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fispec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>famInstEnvElts</span> <span class='hs-varid'>home_fie</span> <span class='hs-varop'>++</span> <span class='hs-varid'>famInstEnvElts</span> <span class='hs-varid'>pkg_fie</span>
<a name="line-104"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>tc_name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>orphNamesOfFamInst</span> <span class='hs-varid'>fispec</span> <span class='hs-keyglyph'>]</span>
<a name="line-105"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-106"></a>  <span class='hs-keyword'>where</span>
<a name="line-107"></a>    <span class='hs-varid'>tc_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-definition'>lookupInsts</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="loadUnqualIfaces"></a><span class='hs-definition'>loadUnqualIfaces</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InteractiveContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-112"></a><span class='hs-comment'>-- Load the interface for everything that is in scope unqualified</span>
<a name="line-113"></a><span class='hs-comment'>-- This is so that we can accurately report the instances for</span>
<a name="line-114"></a><span class='hs-comment'>-- something</span>
<a name="line-115"></a><span class='hs-definition'>loadUnqualIfaces</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>ictxt</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initIfaceTcRn</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-117"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadSysInterface</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleSetElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleSet</span> <span class='hs-varid'>unqual_mods</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-118"></a>  <span class='hs-keyword'>where</span>
<a name="line-119"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-120"></a>
<a name="line-121"></a>    <span class='hs-varid'>unqual_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mod</span>
<a name="line-122"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-varid'>ictxt</span><span class='hs-layout'>)</span>
<a name="line-123"></a>                  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span>
<a name="line-124"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isInternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-125"></a>                  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-126"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isInteractiveModule</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-127"></a>                      <span class='hs-comment'>-- Don't attempt to load an interface for stuff</span>
<a name="line-128"></a>                      <span class='hs-comment'>-- from the command line, or from the home package</span>
<a name="line-129"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>isTcOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Types and classes only</span>
<a name="line-130"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>unQualOK</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>]</span>               <span class='hs-comment'>-- In scope unqualified</span>
<a name="line-131"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Need interface for module whose export(s) are in scope unqualified"</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Degugging output
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnDump"></a><span class='hs-definition'>rnDump</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- Dump, with a banner, if -ddump-rn</span>
<a name="line-3"></a><span class='hs-definition'>rnDump</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dumpOptTcRn</span> <span class='hs-conid'>Opt_D_dump_rn</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDumpDoc</span> <span class='hs-str'>"Renamer"</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="tcDump"></a><span class='hs-definition'>tcDump</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-6"></a><span class='hs-definition'>tcDump</span> <span class='hs-varid'>env</span>
<a name="line-7"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span> <span class='hs-layout'>;</span>
<a name="line-8"></a>
<a name="line-9"></a>        <span class='hs-comment'>-- Dump short output if -ddump-types or -ddump-tc</span>
<a name="line-10"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_types</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_tc</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-11"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>dumpTcRn</span> <span class='hs-varid'>short_dump</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-comment'>-- Dump bindings if -ddump-tc</span>
<a name="line-14"></a>        <span class='hs-varid'>dumpOptTcRn</span> <span class='hs-conid'>Opt_D_dump_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDumpDoc</span> <span class='hs-str'>"Typechecker"</span> <span class='hs-varid'>full_dump</span><span class='hs-layout'>)</span>
<a name="line-15"></a>   <span class='hs-layout'>}</span>
<a name="line-16"></a>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-varid'>short_dump</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcGblEnv</span> <span class='hs-varid'>env</span>
<a name="line-18"></a>    <span class='hs-varid'>full_dump</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprLHsBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_binds</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-19"></a>        <span class='hs-comment'>-- NB: foreign x-d's have undefined's in their types;</span>
<a name="line-20"></a>        <span class='hs-comment'>--     hence can't show the tc_fords</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="tcCoreDump"></a><span class='hs-definition'>tcCoreDump</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-23"></a><span class='hs-definition'>tcCoreDump</span> <span class='hs-varid'>mod_guts</span>
<a name="line-24"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span> <span class='hs-layout'>;</span>
<a name="line-25"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_types</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_tc</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-26"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>dumpTcRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprModGuts</span> <span class='hs-varid'>mod_guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- Dump bindings if -ddump-tc</span>
<a name="line-29"></a>        <span class='hs-varid'>dumpOptTcRn</span> <span class='hs-conid'>Opt_D_dump_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDumpDoc</span> <span class='hs-str'>"Typechecker"</span> <span class='hs-varid'>full_dump</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>full_dump</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCoreBindings</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>mod_guts</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="pprTcGblEnv"></a><span class='hs-comment'>-- It's unpleasant having both pprModGuts and pprModDetails here</span>
<a name="line-34"></a><span class='hs-definition'>pprTcGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-35"></a><span class='hs-definition'>pprTcGblEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span>
<a name="line-36"></a>                        <span class='hs-varid'>tcg_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span><span class='hs-layout'>,</span>
<a name="line-37"></a>                        <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>,</span>
<a name="line-38"></a>                        <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span><span class='hs-layout'>,</span>
<a name="line-39"></a>                        <span class='hs-varid'>tcg_vects</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vects</span><span class='hs-layout'>,</span>
<a name="line-40"></a>                        <span class='hs-varid'>tcg_imports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imports</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr_types</span> <span class='hs-varid'>insts</span> <span class='hs-varid'>type_env</span>
<a name="line-42"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_tycons</span> <span class='hs-varid'>fam_insts</span> <span class='hs-varid'>type_env</span>
<a name="line-43"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_insts</span> <span class='hs-varid'>insts</span>
<a name="line-44"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_fam_insts</span> <span class='hs-varid'>fam_insts</span>
<a name="line-45"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span>
<a name="line-46"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>vects</span><span class='hs-layout'>)</span>
<a name="line-47"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Dependent modules:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-48"></a>                <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_mp</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eltsUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_dep_mods</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Dependent packages:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-50"></a>                <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortBy</span> <span class='hs-varid'>stablePackageIdCmp</span> <span class='hs-varop'>$</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-51"></a>  <span class='hs-keyword'>where</span>         <span class='hs-comment'>-- The two uses of sortBy are just to reduce unnecessary</span>
<a name="line-52"></a>                <span class='hs-comment'>-- wobbling in testsuite output</span>
<a name="line-53"></a>    <span class='hs-varid'>cmp_mp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_name1</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_boot1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_name2</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_boot2</span><span class='hs-layout'>)</span>
<a name="line-54"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_name1</span> <span class='hs-varop'>`stableModuleNameCmp`</span> <span class='hs-varid'>mod_name2</span><span class='hs-layout'>)</span>
<a name="line-55"></a>                  <span class='hs-varop'>`thenCmp`</span>
<a name="line-56"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>is_boot1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>is_boot2</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="pprModGuts"></a><span class='hs-definition'>pprModGuts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-59"></a><span class='hs-definition'>pprModGuts</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModGuts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs</span>
<a name="line-60"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr_types</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTypeEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tcs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-62"></a>           <span class='hs-varid'>ppr_rules</span> <span class='hs-varid'>rules</span> <span class='hs-keyglyph'>]</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="ppr_types"></a><span class='hs-definition'>ppr_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-65"></a><span class='hs-definition'>ppr_types</span> <span class='hs-varid'>insts</span> <span class='hs-varid'>type_env</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TYPE SIGNATURES"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_sigs</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-67"></a>  <span class='hs-keyword'>where</span>
<a name="line-68"></a>    <span class='hs-varid'>dfun_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>insts</span>
<a name="line-69"></a>    <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>typeEnvIds</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>want_sig</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span>
<a name="line-70"></a>    <span class='hs-varid'>want_sig</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-71"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-72"></a>                                       <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-73"></a>                                       <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>dfun_ids</span><span class='hs-layout'>)</span>
<a name="line-74"></a>        <span class='hs-comment'>-- isLocalId ignores data constructors, records selectors etc.</span>
<a name="line-75"></a>        <span class='hs-comment'>-- The isExternalName ignores local dictionary and method bindings</span>
<a name="line-76"></a>        <span class='hs-comment'>-- that the type checker has invented.  Top-level user-defined things</span>
<a name="line-77"></a>        <span class='hs-comment'>-- have External names.</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="ppr_tycons"></a><span class='hs-definition'>ppr_tycons</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-80"></a><span class='hs-definition'>ppr_tycons</span> <span class='hs-varid'>fam_insts</span> <span class='hs-varid'>type_env</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TYPE CONSTRUCTORS"</span>
<a name="line-82"></a>         <span class='hs-layout'>,</span>   <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_tydecls</span> <span class='hs-varid'>tycons</span><span class='hs-layout'>)</span>
<a name="line-83"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"COERCION AXIOMS"</span>
<a name="line-84"></a>         <span class='hs-layout'>,</span>   <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprCoAxiom</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeEnvCoAxioms</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-85"></a>  <span class='hs-keyword'>where</span>
<a name="line-86"></a>    <span class='hs-varid'>fi_tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstsRepTyCons</span> <span class='hs-varid'>fam_insts</span>
<a name="line-87"></a>    <span class='hs-varid'>tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>typeEnvTyCons</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>want_tycon</span> <span class='hs-varid'>tycon</span><span class='hs-keyglyph'>]</span>
<a name="line-88"></a>    <span class='hs-varid'>want_tycon</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-89"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isImplicitTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-90"></a>                                            <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-91"></a>                                            <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>fi_tycons</span><span class='hs-layout'>)</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="ppr_insts"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-94"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-95"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-varid'>ispecs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"INSTANCES"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprInstances</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="ppr_fam_insts"></a><span class='hs-definition'>ppr_fam_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-98"></a><span class='hs-definition'>ppr_fam_insts</span> <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-99"></a><span class='hs-definition'>ppr_fam_insts</span> <span class='hs-varid'>fam_insts</span> <span class='hs-keyglyph'>=</span>
<a name="line-100"></a>  <span class='hs-varid'>text</span> <span class='hs-str'>"FAMILY INSTANCES"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprFamInsts</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="ppr_sigs"></a><span class='hs-definition'>ppr_sigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-103"></a><span class='hs-definition'>ppr_sigs</span> <span class='hs-varid'>ids</span>
<a name="line-104"></a>        <span class='hs-comment'>-- Print type signatures; sort by OccName</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_sig</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>getOccName</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-106"></a>  <span class='hs-keyword'>where</span>
<a name="line-107"></a>    <span class='hs-varid'>ppr_sig</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTopType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="ppr_tydecls"></a><span class='hs-definition'>ppr_tydecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-110"></a><span class='hs-definition'>ppr_tydecls</span> <span class='hs-varid'>tycons</span>
<a name="line-111"></a>        <span class='hs-comment'>-- Print type constructor info; sort by OccName</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>getOccName</span><span class='hs-layout'>)</span> <span class='hs-varid'>tycons</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-113"></a>  <span class='hs-keyword'>where</span>
<a name="line-114"></a>    <span class='hs-varid'>ppr_tycon</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-115"></a>                              <span class='hs-comment'>-- Temporarily print the kind signature too</span>
<a name="line-116"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyThingToIfaceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="ppr_rules"></a><span class='hs-definition'>ppr_rules</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-119"></a><span class='hs-definition'>ppr_rules</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-120"></a><span class='hs-definition'>ppr_rules</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"{-# RULES"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-121"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprRules</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-122"></a>                      <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"#-}"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}
</body>
</html>
