<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>iface/IfaceEnv.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
(c) The University of Glasgow 2002-2006

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>IfaceEnv</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>newGlobalBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>newImplicitBinder</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>	<span class='hs-varid'>lookupIfaceTop</span><span class='hs-layout'>,</span>
<a name="line-11"></a>	<span class='hs-varid'>lookupOrig</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupOrigNameCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendNameCache</span><span class='hs-layout'>,</span>
<a name="line-12"></a>	<span class='hs-varid'>newIfaceName</span><span class='hs-layout'>,</span> <span class='hs-varid'>newIfaceNames</span><span class='hs-layout'>,</span>
<a name="line-13"></a>	<span class='hs-varid'>extendIfaceIdEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendIfaceTyVarEnv</span><span class='hs-layout'>,</span> 
<a name="line-14"></a>	<span class='hs-varid'>tcIfaceLclId</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIfaceTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupIfaceTyVar</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>	<span class='hs-varid'>ifaceExportNames</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>	<span class='hs-comment'>-- Name-cache stuff</span>
<a name="line-19"></a>	<span class='hs-varid'>allocateGlobalBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>initNameCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>updNameCache</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>getNameCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNameCacheUpdater</span><span class='hs-layout'>,</span> <span class='hs-conid'>NameCacheUpdater</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-21"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Exception</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>evaluate</span> <span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>atomicModifyIORef</span><span class='hs-layout'>,</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>)</span>
</pre>\end{code}


%*********************************************************
%*							*
	Allocating new Names in the Name Cache
%*							*
%*********************************************************

Note [The Name Cache]
~~~~~~~~~~~~~~~~~~~~~
The Name Cache makes sure that, during any invovcation of GHC, each
External Name "M.x" has one, and only one globally-agreed Unique.

* The first time we come across M.x we make up a Unique and record that
  association in the Name Cache.

* When we come across "M.x" again, we look it up in the Name Cache,
  and get a hit.

The functions newGlobalBinder, allocateGlobalBinder do the main work.
When you make an External name, you should probably be calling one
of them.


\begin{code}
<pre><a name="line-1"></a><a name="newGlobalBinder"></a><span class='hs-definition'>newGlobalBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-comment'>-- Used for source code and interface files, to make the</span>
<a name="line-3"></a><span class='hs-comment'>-- Name for a thing, given its Module and OccName</span>
<a name="line-4"></a><span class='hs-comment'>-- See Note [The Name Cache]</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- The cache may already already have a binding for this thing,</span>
<a name="line-7"></a><span class='hs-comment'>-- because we may have seen an occurrence before, but now is the</span>
<a name="line-8"></a><span class='hs-comment'>-- moment when we know its Module and SrcLoc in their full glory</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>newGlobalBinder</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>	<span class='hs-comment'>-- See notes with lookupOrig</span>
<a name="line-12"></a><span class='hs-comment'>--     traceIf (text "newGlobalBinder" &lt;+&gt; ppr mod &lt;+&gt; ppr occ &lt;+&gt; ppr loc)</span>
<a name="line-13"></a>       <span class='hs-varid'>updNameCache</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>name_cache</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-14"></a>         <span class='hs-varid'>allocateGlobalBinder</span> <span class='hs-varid'>name_cache</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="allocateGlobalBinder"></a><span class='hs-definition'>allocateGlobalBinder</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameCache</span> 
<a name="line-18"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameCache</span><span class='hs-layout'>,</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-comment'>-- See Note [The Name Cache]</span>
<a name="line-21"></a><span class='hs-definition'>allocateGlobalBinder</span> <span class='hs-varid'>name_supply</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupOrigNameCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsNames</span> <span class='hs-varid'>name_supply</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>of</span>
<a name="line-23"></a>        <span class='hs-comment'>-- A hit in the cache!  We are at the binding site of the name.</span>
<a name="line-24"></a>        <span class='hs-comment'>-- This is the moment when we know the SrcLoc</span>
<a name="line-25"></a>        <span class='hs-comment'>-- of the Name, so we set this field in the Name we return.</span>
<a name="line-26"></a>        <span class='hs-comment'>--</span>
<a name="line-27"></a>        <span class='hs-comment'>-- Then (bogus) multiple bindings of the same Name</span>
<a name="line-28"></a>        <span class='hs-comment'>-- get different SrcLocs can can be reported as such.</span>
<a name="line-29"></a>        <span class='hs-comment'>--</span>
<a name="line-30"></a>        <span class='hs-comment'>-- Possible other reason: it might be in the cache because we</span>
<a name="line-31"></a>        <span class='hs-comment'>-- 	encountered an occurrence before the binding site for an</span>
<a name="line-32"></a>        <span class='hs-comment'>--	implicitly-imported Name.  Perhaps the current SrcLoc is</span>
<a name="line-33"></a>        <span class='hs-comment'>--	better... but not really: it'll still just say 'imported'</span>
<a name="line-34"></a>        <span class='hs-comment'>--</span>
<a name="line-35"></a>        <span class='hs-comment'>-- IMPORTANT: Don't mess with wired-in names.</span>
<a name="line-36"></a>        <span class='hs-comment'>-- 	      Their wired-in-ness is in their NameSort</span>
<a name="line-37"></a>        <span class='hs-comment'>--	      and their Module is correct.</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>name</span>
<a name="line-40"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>name_supply</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-42"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_name_supply</span><span class='hs-layout'>,</span> <span class='hs-varid'>name'</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                  <span class='hs-keyword'>where</span>
<a name="line-44"></a>                    <span class='hs-varid'>uniq</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>name</span>
<a name="line-45"></a>                    <span class='hs-varid'>name'</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-46"></a>                                      <span class='hs-comment'>-- name' is like name, but with the right SrcSpan</span>
<a name="line-47"></a>                    <span class='hs-varid'>new_cache</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsNames</span> <span class='hs-varid'>name_supply</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name'</span>
<a name="line-48"></a>                    <span class='hs-varid'>new_name_supply</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name_supply</span> <span class='hs-layout'>{</span><span class='hs-varid'>nsNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_cache</span><span class='hs-layout'>}</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-comment'>-- Miss in the cache!</span>
<a name="line-51"></a>        <span class='hs-comment'>-- Build a completely new Name, and put it in the cache</span>
<a name="line-52"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_name_supply</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-53"></a>                  <span class='hs-keyword'>where</span>
<a name="line-54"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>us'</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeUniqFromSupply</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsUniqs</span> <span class='hs-varid'>name_supply</span><span class='hs-layout'>)</span>
<a name="line-55"></a>                    <span class='hs-varid'>name</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-56"></a>                    <span class='hs-varid'>new_cache</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsNames</span> <span class='hs-varid'>name_supply</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span>
<a name="line-57"></a>                    <span class='hs-varid'>new_name_supply</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name_supply</span> <span class='hs-layout'>{</span><span class='hs-varid'>nsUniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us'</span><span class='hs-layout'>,</span> <span class='hs-varid'>nsNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_cache</span><span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="newImplicitBinder"></a><span class='hs-definition'>newImplicitBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>			<span class='hs-comment'>-- Base name</span>
<a name="line-60"></a>	          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span><span class='hs-layout'>)</span> 	<span class='hs-comment'>-- Occurrence name modifier</span>
<a name="line-61"></a>	          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>m</span> <span class='hs-varid'>n</span> <span class='hs-conid'>Name</span>		<span class='hs-comment'>-- Implicit name</span>
<a name="line-62"></a><span class='hs-comment'>-- Called in BuildTyCl to allocate the implicit binders of type/class decls</span>
<a name="line-63"></a><span class='hs-comment'>-- For source type/class decls, this is the first occurrence</span>
<a name="line-64"></a><span class='hs-comment'>-- For iface ones, the LoadIface has alrady allocated a suitable name in the cache</span>
<a name="line-65"></a><span class='hs-definition'>newImplicitBinder</span> <span class='hs-varid'>base_name</span> <span class='hs-varid'>mk_sys_occ</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>base_name</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newGlobalBinder</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	  	<span class='hs-comment'>-- When typechecking a [d| decl bracket |], </span>
<a name="line-69"></a>    			<span class='hs-comment'>-- TH generates types, classes etc with Internal names,</span>
<a name="line-70"></a>			<span class='hs-comment'>-- so we follow suit for the implicit binders</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-72"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-73"></a>  <span class='hs-keyword'>where</span>
<a name="line-74"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_sys_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>base_name</span><span class='hs-layout'>)</span>
<a name="line-75"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>base_name</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="ifaceExportNames"></a><span class='hs-definition'>ifaceExportNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceExport</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-78"></a><span class='hs-definition'>ifaceExportNames</span> <span class='hs-varid'>exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>exports</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="lookupOrig"></a><span class='hs-definition'>lookupOrig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-conid'>Name</span>
<a name="line-81"></a><span class='hs-definition'>lookupOrig</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- First ensure that mod and occ are evaluated</span>
<a name="line-83"></a>		<span class='hs-comment'>-- If not, chaos can ensue:</span>
<a name="line-84"></a>		<span class='hs-comment'>-- 	we read the name-cache</span>
<a name="line-85"></a>		<span class='hs-comment'>-- 	then pull on mod (say)</span>
<a name="line-86"></a>		<span class='hs-comment'>--	which does some stuff that modifies the name cache</span>
<a name="line-87"></a>		<span class='hs-comment'>-- This did happen, with tycon_mod in TcIface.tcIfaceAlt (DataAlt..)</span>
<a name="line-88"></a>	  <span class='hs-varid'>mod</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>	
<a name="line-89"></a><span class='hs-comment'>--	; traceIf (text "lookup_orig" &lt;+&gt; ppr mod &lt;+&gt; ppr occ)</span>
<a name="line-90"></a>
<a name="line-91"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>updNameCache</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>name_cache</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-92"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupOrigNameCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsNames</span> <span class='hs-varid'>name_cache</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-93"></a>	      <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>name_cache</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-94"></a>	      <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span>
<a name="line-95"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>takeUniqFromSupply</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsUniqs</span> <span class='hs-varid'>name_cache</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-96"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-97"></a>                  <span class='hs-keyword'>let</span>
<a name="line-98"></a>                    <span class='hs-varid'>name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-99"></a>                    <span class='hs-varid'>new_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsNames</span> <span class='hs-varid'>name_cache</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span>
<a name="line-100"></a>                  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>name_cache</span><span class='hs-layout'>{</span> <span class='hs-varid'>nsUniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us</span><span class='hs-layout'>,</span> <span class='hs-varid'>nsNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_cache</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-101"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
		Name cache access
%*									*
%************************************************************************

See Note [The Name Cache] above.

Note [Built-in syntax and the OrigNameCache]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
You might think that usin isBuiltInOcc_maybe in lookupOrigNameCache is
unnecessary because tuple TyCon/DataCons are parsed as Exact RdrNames
and *don't* appear as original names in interface files (because
serialization gives them special treatment), so we will never look
them up in the original name cache.

However, there are two reasons why we might look up an Orig RdrName:

  * If you use setRdrNameSpace on an Exact RdrName it may be
    turned into an Orig RdrName. 

  * Template Haskell turns a BuiltInSyntax Name into a TH.NameG
    (DsMeta.globalVar), and parses a NameG into an Orig RdrName
    (Convert.thRdrName).  So, eg $(do { reify '(,); ... }) will
    go this route (Trac #8954).

\begin{code}
<pre><a name="line-1"></a><a name="lookupOrigNameCache"></a><span class='hs-definition'>lookupOrigNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrigNameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-definition'>lookupOrigNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isBuiltInOcc_maybe</span> <span class='hs-varid'>occ</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> 	<span class='hs-comment'>-- See Note [Known-key names], 3(c) in PrelNames</span>
<a name="line-5"></a>        <span class='hs-comment'>-- Special case for tuples; there are too many</span>
<a name="line-6"></a>	<span class='hs-comment'>-- of them to pre-populate the original-name cache</span>
<a name="line-7"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span>
<a name="line-8"></a>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupModuleEnv</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>	<span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-12"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>occ</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="extendOrigNameCache"></a><span class='hs-definition'>extendOrigNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrigNameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-15"></a><span class='hs-definition'>extendOrigNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>name</span> 
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> 
<a name="line-17"></a>    <span class='hs-varid'>extendNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="extendNameCache"></a><span class='hs-definition'>extendNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrigNameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-20"></a><span class='hs-definition'>extendNameCache</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendModuleEnvWith</span> <span class='hs-varid'>combine</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOccEnv</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendOccEnv</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>name</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="getNameCache"></a><span class='hs-definition'>getNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-conid'>NameCache</span>
<a name="line-26"></a><span class='hs-definition'>getNameCache</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>HscEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_NC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nc_var</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span><span class='hs-layout'>;</span> 
<a name="line-27"></a>		    <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>nc_var</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="updNameCache"></a><span class='hs-definition'>updNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span>
<a name="line-30"></a><span class='hs-definition'>updNameCache</span> <span class='hs-varid'>upd_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-31"></a>  <span class='hs-conid'>HscEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_NC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nc_var</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-32"></a>  <span class='hs-varid'>atomicUpdMutVar'</span> <span class='hs-varid'>nc_var</span> <span class='hs-varid'>upd_fn</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="NameCacheUpdater"></a><span class='hs-comment'>-- | A function that atomically updates the name cache given a modifier</span>
<a name="line-35"></a><a name="NameCacheUpdater"></a><span class='hs-comment'>-- function.  The second result of the modifier function will be the result</span>
<a name="line-36"></a><a name="NameCacheUpdater"></a><span class='hs-comment'>-- of the IO action.</span>
<a name="line-37"></a><a name="NameCacheUpdater"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>NameCacheUpdater</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NCU</span> <span class='hs-layout'>{</span> <span class='hs-varid'>updateNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>c</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>c</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="mkNameCacheUpdater"></a><span class='hs-comment'>-- | Return a function to atomically update the name cache.</span>
<a name="line-40"></a><span class='hs-definition'>mkNameCacheUpdater</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-conid'>NameCacheUpdater</span>
<a name="line-41"></a><span class='hs-definition'>mkNameCacheUpdater</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-42"></a>  <span class='hs-varid'>nc_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hsc_NC</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-43"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>update_nc</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>nc_var</span> <span class='hs-varid'>f</span>
<a name="line-44"></a>                       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evaluate</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>nc_var</span>
<a name="line-45"></a>                       <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-46"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NCU</span> <span class='hs-varid'>update_nc</span><span class='hs-layout'>)</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="initNameCache"></a><span class='hs-definition'>initNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameCache</span>
<a name="line-2"></a><span class='hs-definition'>initNameCache</span> <span class='hs-varid'>us</span> <span class='hs-varid'>names</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameCache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nsUniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us</span><span class='hs-layout'>,</span>
<a name="line-4"></a>		<span class='hs-varid'>nsNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initOrigNames</span> <span class='hs-varid'>names</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="initOrigNames"></a><span class='hs-definition'>initOrigNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-7"></a><span class='hs-definition'>initOrigNames</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>extendOrigNameCache</span> <span class='hs-varid'>emptyModuleEnv</span> <span class='hs-varid'>names</span>
</pre>\end{code}



%************************************************************************
%*									*
		Type variables and local Ids
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcIfaceLclId"></a><span class='hs-definition'>tcIfaceLclId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><span class='hs-definition'>tcIfaceLclId</span> <span class='hs-varid'>occ</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>lcl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>if_id_env</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-5"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty_var</span>
<a name="line-6"></a>            <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failIfM</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Iface id out of scope: "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-7"></a>        <span class='hs-layout'>}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="extendIfaceIdEnv"></a><span class='hs-definition'>extendIfaceIdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-varid'>a</span>
<a name="line-10"></a><span class='hs-definition'>extendIfaceIdEnv</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>thing_inside</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addListToUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>if_id_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span>
<a name="line-13"></a>	      <span class='hs-layout'>;</span>	<span class='hs-varid'>pairs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setLclEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>if_id_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_env'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a>
<a name="line-17"></a><a name="tcIfaceTyVar"></a><span class='hs-definition'>tcIfaceTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-conid'>TyVar</span>
<a name="line-18"></a><span class='hs-definition'>tcIfaceTyVar</span> <span class='hs-varid'>occ</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>lcl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-20"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>if_tv_env</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-21"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty_var</span>
<a name="line-22"></a>            <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failIfM</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Iface type variable out of scope: "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-23"></a>        <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="lookupIfaceTyVar"></a><span class='hs-definition'>lookupIfaceTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-definition'>lookupIfaceTyVar</span> <span class='hs-varid'>occ</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>lcl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-28"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>if_tv_env</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="extendIfaceTyVarEnv"></a><span class='hs-definition'>extendIfaceTyVarEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-varid'>a</span>
<a name="line-31"></a><span class='hs-definition'>extendIfaceTyVarEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>thing_inside</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-33"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addListToUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>if_tv_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span>
<a name="line-34"></a>	      <span class='hs-layout'>;</span>	<span class='hs-varid'>pairs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyvars</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setLclEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>if_tv_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_env'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
		Getting from RdrNames to Names
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="lookupIfaceTop"></a><span class='hs-definition'>lookupIfaceTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-comment'>-- Look up a top-level name from the current Iface module</span>
<a name="line-3"></a><span class='hs-definition'>lookupIfaceTop</span> <span class='hs-varid'>occ</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span><span class='hs-layout'>;</span> <span class='hs-varid'>lookupOrig</span> <span class='hs-layout'>(</span><span class='hs-varid'>if_mod</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="newIfaceName"></a><span class='hs-definition'>newIfaceName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-conid'>Name</span>
<a name="line-7"></a><span class='hs-definition'>newIfaceName</span> <span class='hs-varid'>occ</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="newIfaceNames"></a><span class='hs-definition'>newIfaceNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OccName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><span class='hs-definition'>newIfaceNames</span> <span class='hs-varid'>occs</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-15"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ</span><span class='hs-layout'>,</span><span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>occs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>uniqs</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
</pre>\end{code}
</body>
</html>
