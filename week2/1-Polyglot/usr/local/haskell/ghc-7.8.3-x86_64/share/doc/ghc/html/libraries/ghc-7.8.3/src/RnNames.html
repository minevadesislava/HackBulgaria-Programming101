<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>rename/RnNames.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[RnNames]{Extracting imported and top-level names in scope}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RnNames</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-varid'>rnImports</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLocalNonValBinders</span><span class='hs-layout'>,</span>
<a name="line-3"></a>        <span class='hs-varid'>rnExports</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendGlobalRdrEnvRn</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>gresFromAvails</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>reportUnusedNames</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>checkConName</span>
<a name="line-7"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>            <span class='hs-layout'>(</span> <span class='hs-varid'>isBrackStage</span> <span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnHsDoc</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>rnHsDoc</span> <span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>loadSrcInterface</span> <span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span>         <span class='hs-layout'>(</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>\\</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>find</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>  <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{rnImports}
%*                                                                      *
%************************************************************************

Note [Tracking Trust Transitively]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we import a package as well as checking that the direct imports are safe
according to the rules outlined in the Note [HscMain . Safe Haskell Trust Check]
we must also check that these rules hold transitively for all dependent modules
and packages. Doing this without caching any trust information would be very
slow as we would need to touch all packages and interface files a module depends
on. To avoid this we make use of the property that if a modules Safe Haskell
mode changes, this triggers a recompilation from that module in the dependcy
graph. So we can just worry mostly about direct imports.

There is one trust property that can change for a package though without
recompliation being triggered: package trust. So we must check that all
packages a module tranitively depends on to be trusted are still trusted when
we are compiling this module (as due to recompilation avoidance some modules
below may not be considered trusted any more without recompilation being
triggered).

We handle this by augmenting the existing transitive list of packages a module M
depends on with a bool for each package that says if it must be trusted when the
module M is being checked for trust. This list of trust required packages for a
single import is gathered in the rnImportDecl function and stored in an
ImportAvails data structure. The union of these trust required packages for all
imports is done by the rnImports function using the combine function which calls
the plusImportAvails function that is a union operation for the ImportAvails
type. This gives us in an ImportAvails structure all packages required to be
trusted for the module we are currently compiling. Checking that these packages
are still trusted (and that direct imports are trusted) is done in
HscMain.checkSafeImports.

See the note below, [Trust Own Package] for a corner case in this method and
how its handled.


Note [Trust Own Package]
~~~~~~~~~~~~~~~~~~~~~~~~
There is a corner case of package trust checking that the usual transitive check
doesn't cover. (For how the usual check operates see the Note [Tracking Trust
Transitively] below). The case is when you import a -XSafe module M and M
imports a -XTrustworthy module N. If N resides in a different package than M,
then the usual check works as M will record a package dependency on N's package
and mark it as required to be trusted. If N resides in the same package as M
though, then importing M should require its own package be trusted due to N
(since M is -XSafe so doesn't create this requirement by itself). The usual
check fails as a module doesn't record a package dependency of its own package.
So instead we now have a bool field in a modules interface file that simply
states if the module requires its own package to be trusted. This field avoids
us having to load all interface files that the module depends on to see if one
is trustworthy.


Note [Trust Transitive Property]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
So there is an interesting design question in regards to transitive trust
checking. Say I have a module B compiled with -XSafe. B is dependent on a bunch
of modules and packages, some packages it requires to be trusted as its using
-XTrustworthy modules from them. Now if I have a module A that doesn't use safe
haskell at all and simply imports B, should A inherit all the the trust
requirements from B? Should A now also require that a package p is trusted since
B required it?

We currently say no but saying yes also makes sense. The difference is, if a
module M that doesn't use Safe Haskell imports a module N that does, should all
the trusted package requirements be dropped since M didn't declare that it cares
about Safe Haskell (so -XSafe is more strongly associated with the module doing
the importing) or should it be done still since the author of the module N that
uses Safe Haskell said they cared (so -XSafe is more strongly associated with
the module that was compiled that used it).

Going with yes is a simpler semantics we think and harder for the user to stuff
up but it does mean that Safe Haskell will affect users who don't care about
Safe Haskell as they might grab a package from Cabal which uses safe haskell (say
network) and that packages imports -XTrustworthy modules from another package
(say bytestring), so requires that package is trusted. The user may now get
compilation errors in code that doesn't do anything with Safe Haskell simply
because they are using the network package. They will have to call 'ghc-pkg
trust network' to get everything working. Due to this invasive nature of going
with yes we have gone with no for now.


\begin{code}
<pre><a name="line-1"></a><a name="rnImports"></a><span class='hs-comment'>-- | Process Import Decls</span>
<a name="line-2"></a><span class='hs-comment'>-- Do the non SOURCE ones first, so that we get a helpful warning for SOURCE</span>
<a name="line-3"></a><span class='hs-comment'>-- ones that are unnecessary</span>
<a name="line-4"></a><span class='hs-definition'>rnImports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span> <span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>rnImports</span> <span class='hs-varid'>imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-7"></a>    <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-8"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>source</span><span class='hs-layout'>,</span> <span class='hs-varid'>ordinary</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>is_source_import</span> <span class='hs-varid'>imports</span>
<a name="line-9"></a>        <span class='hs-varid'>is_source_import</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ideclSource</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-10"></a>    <span class='hs-varid'>stuff1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndReportM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnImportDecl</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>ordinary</span>
<a name="line-11"></a>    <span class='hs-varid'>stuff2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndReportM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnImportDecl</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>source</span>
<a name="line-12"></a>    <span class='hs-comment'>-- Safe Haskell: See Note [Tracking Trust Transitively]</span>
<a name="line-13"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_avails</span><span class='hs-layout'>,</span> <span class='hs-varid'>hpc_usage</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combine</span> <span class='hs-layout'>(</span><span class='hs-varid'>stuff1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>stuff2</span><span class='hs-layout'>)</span>
<a name="line-14"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_avails</span><span class='hs-layout'>,</span> <span class='hs-varid'>hpc_usage</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-varid'>combine</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>  <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span> <span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span> <span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>)</span>
<a name="line-19"></a>    <span class='hs-varid'>combine</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>plus</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyGlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyImportAvails</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-varid'>plus</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span><span class='hs-layout'>,</span>  <span class='hs-varid'>gbl_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_avails1</span><span class='hs-layout'>,</span><span class='hs-varid'>hpc_usage1</span><span class='hs-layout'>)</span>
<a name="line-22"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>gbl_env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_avails2</span><span class='hs-layout'>,</span><span class='hs-varid'>hpc_usage2</span><span class='hs-layout'>)</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>decl</span><span class='hs-conop'>:</span><span class='hs-varid'>decls</span><span class='hs-layout'>,</span>
<a name="line-24"></a>          <span class='hs-varid'>gbl_env1</span> <span class='hs-varop'>`plusGlobalRdrEnv`</span> <span class='hs-varid'>gbl_env2</span><span class='hs-layout'>,</span>
<a name="line-25"></a>          <span class='hs-varid'>imp_avails1</span> <span class='hs-varop'>`plusImportAvails`</span> <span class='hs-varid'>imp_avails2</span><span class='hs-layout'>,</span>
<a name="line-26"></a>          <span class='hs-varid'>hpc_usage1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>hpc_usage2</span> <span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="rnImportDecl"></a><span class='hs-definition'>rnImportDecl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>RdrName</span>
<a name="line-29"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span> <span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-definition'>rnImportDecl</span> <span class='hs-varid'>this_mod</span>
<a name="line-31"></a>             <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ImportDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ideclName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc_imp_mod_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ideclPkgQual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_pkg</span>
<a name="line-32"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ideclSource</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>want_boot</span><span class='hs-layout'>,</span> <span class='hs-varid'>ideclSafe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_safe</span>
<a name="line-33"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ideclQualified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qual_only</span><span class='hs-layout'>,</span> <span class='hs-varid'>ideclImplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit</span>
<a name="line-34"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ideclAs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>as_mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>ideclHiding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_details</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-36"></a>
<a name="line-37"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_pkg</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-38"></a>        <span class='hs-varid'>pkg_imports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PackageImports</span>
<a name="line-39"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>pkg_imports</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-varid'>packageImportErr</span>
<a name="line-40"></a>
<a name="line-41"></a>    <span class='hs-comment'>-- If there's an error in loadInterface, (e.g. interface</span>
<a name="line-42"></a>    <span class='hs-comment'>-- file not found) we get lots of spurious errors from 'filterImports'</span>
<a name="line-43"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>imp_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>loc_imp_mod_name</span>
<a name="line-44"></a>        <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>imp_mod_name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is directly imported"</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a>    <span class='hs-comment'>-- Check for a missing import list (Opt_WarnMissingImportList also</span>
<a name="line-47"></a>    <span class='hs-comment'>-- checks for T(..) items but that is done in checkDodgyImport below)</span>
<a name="line-48"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>imp_details</span> <span class='hs-keyword'>of</span>
<a name="line-49"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- Explicit import list</span>
<a name="line-50"></a>        <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>implicit</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- Do not bleat for implicit imports</span>
<a name="line-51"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>qual_only</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-52"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnMissingImportList</span> <span class='hs-varop'>$</span>
<a name="line-53"></a>                           <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>missingImportListWarn</span> <span class='hs-varid'>imp_mod_name</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadSrcInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>imp_mod_name</span> <span class='hs-varid'>want_boot</span> <span class='hs-varid'>mb_pkg</span>
<a name="line-56"></a>
<a name="line-57"></a>    <span class='hs-comment'>-- Compiler sanity check: if the import didn't say</span>
<a name="line-58"></a>    <span class='hs-comment'>-- {-# SOURCE #-} we should not get a hi-boot file</span>
<a name="line-59"></a>    <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-varid'>want_boot</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>imp_mod_name</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-comment'>-- Issue a user warning for a redundant {- SOURCE -} import</span>
<a name="line-62"></a>    <span class='hs-comment'>-- NB that we arrange to read all the ordinary imports before</span>
<a name="line-63"></a>    <span class='hs-comment'>-- any of the {- SOURCE -} imports.</span>
<a name="line-64"></a>    <span class='hs-comment'>--</span>
<a name="line-65"></a>    <span class='hs-comment'>-- in --make and GHCi, the compilation manager checks for this,</span>
<a name="line-66"></a>    <span class='hs-comment'>-- and indeed we shouldn't do it here because the existence of</span>
<a name="line-67"></a>    <span class='hs-comment'>-- the non-boot module depends on the compilation order, which</span>
<a name="line-68"></a>    <span class='hs-comment'>-- is not deterministic.  The hs-boot test can show this up.</span>
<a name="line-69"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-70"></a>    <span class='hs-varid'>warnIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>want_boot</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isOneShot</span> <span class='hs-layout'>(</span><span class='hs-varid'>ghcMode</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>warnRedundantSourceImport</span> <span class='hs-varid'>imp_mod_name</span><span class='hs-layout'>)</span>
<a name="line-72"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_safe</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeImportsOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-73"></a>        <span class='hs-varid'>addErrAt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"safe import can't be used as Safe Haskell isn't on!"</span><span class='hs-layout'>)</span>
<a name="line-74"></a>                  <span class='hs-varop'>$+$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-varop'>$</span> <span class='hs-str'>"please enable Safe Haskell through either "</span>
<a name="line-75"></a>                                 <span class='hs-varop'>++</span> <span class='hs-str'>"Safe, Trustworthy or Unsafe"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>imp_mod</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span>
<a name="line-78"></a>        <span class='hs-varid'>warns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_warns</span> <span class='hs-varid'>iface</span>
<a name="line-79"></a>        <span class='hs-varid'>orph_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_orphan</span> <span class='hs-varid'>iface</span>
<a name="line-80"></a>        <span class='hs-varid'>has_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_finsts</span> <span class='hs-varid'>iface</span>
<a name="line-81"></a>        <span class='hs-varid'>deps</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface</span>
<a name="line-82"></a>        <span class='hs-varid'>trust</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSafeMode</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mi_trust</span> <span class='hs-varid'>iface</span>
<a name="line-83"></a>        <span class='hs-varid'>trust_pkg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_trust_pkg</span> <span class='hs-varid'>iface</span>
<a name="line-84"></a>
<a name="line-85"></a>        <span class='hs-varid'>qual_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>as_mod</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>imp_mod_name</span>
<a name="line-86"></a>        <span class='hs-varid'>imp_spec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_mod_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_qual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qual_only</span><span class='hs-layout'>,</span>
<a name="line-87"></a>                                  <span class='hs-varid'>is_dloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qual_mod_name</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>
<a name="line-89"></a>    <span class='hs-comment'>-- filter the imports according to the import declaration</span>
<a name="line-90"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_imp_details</span><span class='hs-layout'>,</span> <span class='hs-varid'>gres</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterImports</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>imp_spec</span> <span class='hs-varid'>imp_details</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>gbl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOut</span> <span class='hs-varid'>from_this_mod</span> <span class='hs-varid'>gres</span><span class='hs-layout'>)</span>
<a name="line-93"></a>        <span class='hs-varid'>from_this_mod</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_mod</span>
<a name="line-94"></a>        <span class='hs-comment'>-- If the module exports anything defined in this module, just</span>
<a name="line-95"></a>        <span class='hs-comment'>-- ignore it.  Reason: otherwise it looks as if there are two</span>
<a name="line-96"></a>        <span class='hs-comment'>-- local definition sites for the thing, and an error gets</span>
<a name="line-97"></a>        <span class='hs-comment'>-- reported.  Easiest thing is just to filter them out up</span>
<a name="line-98"></a>        <span class='hs-comment'>-- front. This situation only arises if a module imports</span>
<a name="line-99"></a>        <span class='hs-comment'>-- itself, or another module that imported it.  (Necessarily,</span>
<a name="line-100"></a>        <span class='hs-comment'>-- this invoves a loop.)</span>
<a name="line-101"></a>        <span class='hs-comment'>--</span>
<a name="line-102"></a>        <span class='hs-comment'>-- We do this *after* filterImports, so that if you say</span>
<a name="line-103"></a>        <span class='hs-comment'>--      module A where</span>
<a name="line-104"></a>        <span class='hs-comment'>--         import B( AType )</span>
<a name="line-105"></a>        <span class='hs-comment'>--         type AType = ...</span>
<a name="line-106"></a>        <span class='hs-comment'>--</span>
<a name="line-107"></a>        <span class='hs-comment'>--      module B( AType ) where</span>
<a name="line-108"></a>        <span class='hs-comment'>--         import {-# SOURCE #-} A( AType )</span>
<a name="line-109"></a>        <span class='hs-comment'>--</span>
<a name="line-110"></a>        <span class='hs-comment'>-- then you won't get a 'B does not export AType' message.</span>
<a name="line-111"></a>
<a name="line-112"></a>
<a name="line-113"></a>        <span class='hs-comment'>-- Compute new transitive dependencies</span>
<a name="line-114"></a>
<a name="line-115"></a>        <span class='hs-varid'>orphans</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>orph_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_mod</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>dep_orphs</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-116"></a>                               <span class='hs-varid'>imp_mod</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dep_orphs</span> <span class='hs-varid'>deps</span>
<a name="line-117"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_orphs</span> <span class='hs-varid'>deps</span>
<a name="line-118"></a>
<a name="line-119"></a>        <span class='hs-varid'>finsts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>has_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_mod</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>dep_finsts</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-120"></a>                              <span class='hs-varid'>imp_mod</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dep_finsts</span> <span class='hs-varid'>deps</span>
<a name="line-121"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_finsts</span> <span class='hs-varid'>deps</span>
<a name="line-122"></a>
<a name="line-123"></a>        <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-124"></a>
<a name="line-125"></a>        <span class='hs-comment'>-- Does this import mean we now require our own pkg</span>
<a name="line-126"></a>        <span class='hs-comment'>-- to be trusted? See Note [Trust Own Package]</span>
<a name="line-127"></a>        <span class='hs-varid'>ptrust</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trust</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Sf_Trustworthy</span> <span class='hs-varop'>||</span> <span class='hs-varid'>trust_pkg</span>
<a name="line-128"></a>
<a name="line-129"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>dependent_mods</span><span class='hs-layout'>,</span> <span class='hs-varid'>dependent_pkgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkg_trust_req</span><span class='hs-layout'>)</span>
<a name="line-130"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>==</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-131"></a>                <span class='hs-comment'>-- Imported module is from the home package</span>
<a name="line-132"></a>                <span class='hs-comment'>-- Take its dependent modules and add imp_mod itself</span>
<a name="line-133"></a>                <span class='hs-comment'>-- Take its dependent packages unchanged</span>
<a name="line-134"></a>                <span class='hs-comment'>--</span>
<a name="line-135"></a>                <span class='hs-comment'>-- NB: (dep_mods deps) might include a hi-boot file</span>
<a name="line-136"></a>                <span class='hs-comment'>-- for the module being compiled, CM. Do *not* filter</span>
<a name="line-137"></a>                <span class='hs-comment'>-- this out (as we used to), because when we've</span>
<a name="line-138"></a>                <span class='hs-comment'>-- finished dealing with the direct imports we want to</span>
<a name="line-139"></a>                <span class='hs-comment'>-- know if any of them depended on CM.hi-boot, in</span>
<a name="line-140"></a>                <span class='hs-comment'>-- which case we should do the hi-boot consistency</span>
<a name="line-141"></a>                <span class='hs-comment'>-- check.  See LoadIface.loadHiBootInterface</span>
<a name="line-142"></a>                <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>imp_mod_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>want_boot</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dep_mods</span> <span class='hs-varid'>deps</span><span class='hs-layout'>,</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-varid'>deps</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptrust</span><span class='hs-layout'>)</span>
<a name="line-143"></a>
<a name="line-144"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-145"></a>                <span class='hs-comment'>-- Imported module is from another package</span>
<a name="line-146"></a>                <span class='hs-comment'>-- Dump the dependent modules</span>
<a name="line-147"></a>                <span class='hs-comment'>-- Add the package imp_mod comes from to the dependent packages</span>
<a name="line-148"></a>                <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg</span> <span class='hs-varop'>`elem`</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_pkgs</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-150"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-varid'>deps</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a>        <span class='hs-comment'>-- True &lt;=&gt; import M ()</span>
<a name="line-153"></a>        <span class='hs-varid'>import_all</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>imp_details</span> <span class='hs-keyword'>of</span>
<a name="line-154"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_hiding</span><span class='hs-layout'>,</span> <span class='hs-varid'>ls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_hiding</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ls</span>
<a name="line-155"></a>                        <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-156"></a>
<a name="line-157"></a>        <span class='hs-comment'>-- should the import be safe?</span>
<a name="line-158"></a>        <span class='hs-varid'>mod_safe'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_safe</span>
<a name="line-159"></a>                    <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>implicit</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>safeDirectImpsReq</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-160"></a>                    <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>safeImplicitImpsReq</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a>        <span class='hs-varid'>imports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span>
<a name="line-163"></a>                        <span class='hs-varid'>imp_mods</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitModuleEnv</span> <span class='hs-varid'>imp_mod</span>
<a name="line-164"></a>                                        <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>qual_mod_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>import_all</span><span class='hs-layout'>,</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_safe'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-165"></a>                        <span class='hs-varid'>imp_orphs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphans</span><span class='hs-layout'>,</span>
<a name="line-166"></a>                        <span class='hs-varid'>imp_finsts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts</span><span class='hs-layout'>,</span>
<a name="line-167"></a>                        <span class='hs-varid'>imp_dep_mods</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModDeps</span> <span class='hs-varid'>dependent_mods</span><span class='hs-layout'>,</span>
<a name="line-168"></a>                        <span class='hs-varid'>imp_dep_pkgs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dependent_pkgs</span><span class='hs-layout'>,</span>
<a name="line-169"></a>                        <span class='hs-comment'>-- Add in the imported modules trusted package</span>
<a name="line-170"></a>                        <span class='hs-comment'>-- requirements. ONLY do this though if we import the</span>
<a name="line-171"></a>                        <span class='hs-comment'>-- module as a safe import.</span>
<a name="line-172"></a>                        <span class='hs-comment'>-- See Note [Tracking Trust Transitively]</span>
<a name="line-173"></a>                        <span class='hs-comment'>-- and Note [Trust Transitive Property]</span>
<a name="line-174"></a>                        <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>mod_safe'</span>
<a name="line-175"></a>                                             <span class='hs-keyword'>then</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>dependent_pkgs</span>
<a name="line-176"></a>                                             <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-177"></a>                        <span class='hs-comment'>-- Do we require our own pkg to be trusted?</span>
<a name="line-178"></a>                        <span class='hs-comment'>-- See Note [Trust Own Package]</span>
<a name="line-179"></a>                        <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkg_trust_req</span>
<a name="line-180"></a>                   <span class='hs-layout'>}</span>
<a name="line-181"></a>
<a name="line-182"></a>    <span class='hs-comment'>-- Complain if we import a deprecated module</span>
<a name="line-183"></a>    <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnWarningsDeprecations</span> <span class='hs-layout'>(</span>
<a name="line-184"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>warns</span> <span class='hs-keyword'>of</span>
<a name="line-185"></a>          <span class='hs-conid'>WarnAll</span> <span class='hs-varid'>txt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addWarn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleWarn</span> <span class='hs-varid'>imp_mod_name</span> <span class='hs-varid'>txt</span>
<a name="line-186"></a>          <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-187"></a>     <span class='hs-layout'>)</span>
<a name="line-188"></a>
<a name="line-189"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>new_imp_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ideclSafe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_safe'</span>
<a name="line-190"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>ideclHiding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_imp_details</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-191"></a>
<a name="line-192"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_imp_decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>imports</span><span class='hs-layout'>,</span> <span class='hs-varid'>mi_hpc</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="warnRedundantSourceImport"></a><span class='hs-definition'>warnRedundantSourceImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-195"></a><span class='hs-definition'>warnRedundantSourceImport</span> <span class='hs-varid'>mod_name</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unnecessary {-# SOURCE #-} in the import of module"</span><span class='hs-layout'>)</span>
<a name="line-197"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod_name</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{importsFromLocalDecls}
%*                                                                      *
%************************************************************************

From the top-level declarations of this module produce
        * the lexical environment
        * the ImportAvails
created by its bindings.

Note [Top-level Names in Template Haskell decl quotes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also: Note [Interactively-bound Ids in GHCi] in HscTypes

Consider a Template Haskell declaration quotation like this:
      module M where
        f x = h [d| f = 3 |]
When renaming the declarations inside [d| ...|], we treat the
top level binders specially in two ways

1.  We give them an Internal name, not (as usual) an External one.
    Otherwise the NameCache gets confused by a second allocation of
    M.f.  (We used to invent a fake module ThFake to avoid this, but
    that had other problems, notably in getting the correct answer for
    nameIsLocalOrFrom in lookupFixity. So we now leave tcg_module
    unaffected.)

2.  We make them *shadow* the outer bindings. If we don't do that,
    we'll get a complaint when extending the GlobalRdrEnv, saying that
    there are two bindings for 'f'.  There are several tricky points:

    * This shadowing applies even if the binding for 'f' is in a
      where-clause, and hence is in the *local* RdrEnv not the *global*
      RdrEnv.

    * The *qualified* name M.f from the enclosing module must certainly
      still be available.  So we don't nuke it entirely; we just make
      it seem like qualified import.

    * We only shadow *External* names (which come from the main module)
      Do not shadow *Inernal* names because in the bracket
          [d| class C a where f :: a
              f = 4 |]
      rnSrcDecls will first call extendGlobalRdrEnvRn with C[f] from the
      class decl, and *separately* extend the envt with the value binding.

3. We find out whether we are inside a [d| ... |] by testing the TH
   stage. This is a slight hack, because the stage field was really
   meant for the type checker, and here we are not interested in the
   fields of Brack, hence the error thunks in thRnBrack.

\begin{code}
<pre><a name="line-1"></a><a name="extendGlobalRdrEnvRn"></a><span class='hs-definition'>extendGlobalRdrEnvRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-3"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-comment'>-- Updates both the GlobalRdrEnv and the FixityEnv</span>
<a name="line-5"></a><span class='hs-comment'>-- We return a new TcLclEnv only because we might have to</span>
<a name="line-6"></a><span class='hs-comment'>-- delete some bindings from it;</span>
<a name="line-7"></a><span class='hs-comment'>-- see Note [Top-level Names in Template Haskell decl quotes]</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>extendGlobalRdrEnvRn</span> <span class='hs-varid'>avails</span> <span class='hs-varid'>new_fixities</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnvs</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>isGHCi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getIsGHCi</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rdr_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-varid'>gbl_env</span>
<a name="line-14"></a>              <span class='hs-varid'>fix_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_fix_env</span> <span class='hs-varid'>gbl_env</span>
<a name="line-15"></a>              <span class='hs-varid'>th_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcl_th_bndrs</span> <span class='hs-varid'>lcl_env</span>
<a name="line-16"></a>              <span class='hs-varid'>th_lvl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thLevel</span> <span class='hs-varid'>stage</span>
<a name="line-17"></a>
<a name="line-18"></a>              <span class='hs-comment'>-- Delete new_occs from global and local envs</span>
<a name="line-19"></a>              <span class='hs-comment'>-- If we are in a TemplateHaskell decl bracket,</span>
<a name="line-20"></a>              <span class='hs-comment'>--    we are going to shadow them</span>
<a name="line-21"></a>              <span class='hs-comment'>-- See Note [Top-level Names in Template Haskell decl quotes]</span>
<a name="line-22"></a>              <span class='hs-varid'>inBracket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBrackStage</span> <span class='hs-varid'>stage</span>
<a name="line-23"></a>              <span class='hs-varid'>lcl_env_TH</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_rdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delLocalRdrEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_rdr</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_occs</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a>              <span class='hs-varid'>lcl_env2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inBracket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env_TH</span>
<a name="line-26"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env</span>
<a name="line-27"></a>
<a name="line-28"></a>              <span class='hs-varid'>rdr_env2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendGlobalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGHCi</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>inBracket</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>avails</span>
<a name="line-29"></a>                 <span class='hs-comment'>-- Shadowing only applies for GHCi decls outside brackets</span>
<a name="line-30"></a>                 <span class='hs-comment'>-- e.g. (Trac #4127a)</span>
<a name="line-31"></a>                 <span class='hs-comment'>--   ghci&gt; runQ [d| class C a where f :: a</span>
<a name="line-32"></a>                 <span class='hs-comment'>--                  f = True</span>
<a name="line-33"></a>                 <span class='hs-comment'>--                  instance C Int where f = 2 |]</span>
<a name="line-34"></a>                 <span class='hs-comment'>--   We don't want the f=True to shadow the f class-op</span>
<a name="line-35"></a>
<a name="line-36"></a>              <span class='hs-varid'>lcl_env3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env2</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_th_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnvList</span> <span class='hs-varid'>th_bndrs</span>
<a name="line-37"></a>                                                       <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>th_lvl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                                                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_names</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>              <span class='hs-varid'>fix_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>extend_fix_env</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>new_names</span>
<a name="line-40"></a>              <span class='hs-varid'>dups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findLocalDupsRdrEnv</span> <span class='hs-varid'>rdr_env2</span> <span class='hs-varid'>new_names</span>
<a name="line-41"></a>
<a name="line-42"></a>              <span class='hs-varid'>gbl_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbl_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcg_fix_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix_env'</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"extendGlobalRdrEnvRn 1"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>avails</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>addDupDeclErr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>gre_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>dups</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"extendGlobalRdrEnvRn 2"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprGlobalRdrEnv</span> <span class='hs-conid'>True</span> <span class='hs-varid'>rdr_env2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_env3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>new_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>avails</span>
<a name="line-51"></a>    <span class='hs-varid'>new_occs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>new_names</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-comment'>-- If there is a fixity decl for the gre, add it to the fixity env</span>
<a name="line-54"></a>    <span class='hs-varid'>extend_fix_env</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>name</span>
<a name="line-55"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFsEnv</span> <span class='hs-varid'>new_fixities</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameFS</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-56"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixItem</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>fi</span><span class='hs-layout'>)</span>
<a name="line-57"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-58"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix_env</span>
<a name="line-59"></a>      <span class='hs-keyword'>where</span>
<a name="line-60"></a>        <span class='hs-varid'>occ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
</pre>\end{code}

@getLocalDeclBinders@ returns the names for an @HsDecl@.  It's
used for source code.

        *** See "THE NAMING STORY" in HsDecls ****

\begin{code}
<pre><a name="line-1"></a><a name="getLocalNonValBinders"></a><span class='hs-definition'>getLocalNonValBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MiniFixityEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsGroup</span> <span class='hs-conid'>RdrName</span>
<a name="line-2"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-comment'>-- Get all the top-level binders bound the group *except*</span>
<a name="line-4"></a><span class='hs-comment'>-- for value bindings, which are treated separately</span>
<a name="line-5"></a><span class='hs-comment'>-- Specifically we return AvailInfo for</span>
<a name="line-6"></a><span class='hs-comment'>--      type decls (incl constructors and record selectors)</span>
<a name="line-7"></a><span class='hs-comment'>--      class decls (including class ops)</span>
<a name="line-8"></a><span class='hs-comment'>--      associated types</span>
<a name="line-9"></a><span class='hs-comment'>--      foreign imports</span>
<a name="line-10"></a><span class='hs-comment'>--      (in hs-boot files) value signatures</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>getLocalNonValBinders</span> <span class='hs-varid'>fixity_env</span>
<a name="line-13"></a>     <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hs_valds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>val_binds</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                <span class='hs-varid'>hs_tyclds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycl_decls</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                <span class='hs-varid'>hs_instds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_decls</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                <span class='hs-varid'>hs_fords</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_decls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-comment'>-- Process all type/class decls *except* family instances</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tc_avails</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyClGroupConcat</span> <span class='hs-varid'>tycl_decls</span><span class='hs-layout'>)</span>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"getLocalNonValBinders 1"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_avails</span><span class='hs-layout'>)</span>
<a name="line-20"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extendGlobalRdrEnvRn</span> <span class='hs-varid'>tc_avails</span> <span class='hs-varid'>fixity_env</span>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>setEnvs</span> <span class='hs-varid'>envs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-22"></a>            <span class='hs-comment'>-- Bring these things into scope first</span>
<a name="line-23"></a>            <span class='hs-comment'>-- See Note [Looking up family names in family instances]</span>
<a name="line-24"></a>
<a name="line-25"></a>          <span class='hs-comment'>-- Process all family instances</span>
<a name="line-26"></a>          <span class='hs-comment'>-- to bring new data constructors into scope</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>nti_avails</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>new_assoc</span> <span class='hs-varid'>inst_decls</span>
<a name="line-28"></a>
<a name="line-29"></a>          <span class='hs-comment'>-- Finish off with value binders:</span>
<a name="line-30"></a>          <span class='hs-comment'>--    foreign decls for an ordinary module</span>
<a name="line-31"></a>          <span class='hs-comment'>--    type sigs in case of a hs-boot file only</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>is_boot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIsHsBoot</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>val_bndrs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_boot</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_boot_sig_bndrs</span>
<a name="line-34"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>for_hs_bndrs</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>val_avails</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_simple</span> <span class='hs-varid'>val_bndrs</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>avails</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nti_avails</span> <span class='hs-varop'>++</span> <span class='hs-varid'>val_avails</span>
<a name="line-38"></a>              <span class='hs-varid'>new_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>availsToNameSet</span> <span class='hs-varid'>avails</span> <span class='hs-varop'>`unionNameSets`</span>
<a name="line-39"></a>                          <span class='hs-varid'>availsToNameSet</span> <span class='hs-varid'>tc_avails</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"getLocalNonValBinders 2"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>avails</span><span class='hs-layout'>)</span>
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extendGlobalRdrEnvRn</span> <span class='hs-varid'>avails</span> <span class='hs-varid'>fixity_env</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>envs</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_bndrs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>for_hs_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>    <span class='hs-varid'>for_hs_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-varid'>decl_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span>
<a name="line-46"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>decl_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-varid'>nm</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foreign_decls</span><span class='hs-keyglyph'>]</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-comment'>-- In a hs-boot file, the value binders come from the</span>
<a name="line-49"></a>    <span class='hs-comment'>--  *signatures*, and there should be no foreign binders</span>
<a name="line-50"></a>    <span class='hs-varid'>hs_boot_sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-varid'>decl_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>decl_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>val_sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ns</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>    <span class='hs-conid'>ValBindsIn</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>val_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>val_binds</span>
<a name="line-53"></a>
<a name="line-54"></a>      <span class='hs-comment'>-- the SrcSpan attached to the input should be the span of the</span>
<a name="line-55"></a>      <span class='hs-comment'>-- declaration, not just the name</span>
<a name="line-56"></a>    <span class='hs-varid'>new_simple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-57"></a>    <span class='hs-varid'>new_simple</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span><span class='hs-layout'>{</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTopSrcBinder</span> <span class='hs-varid'>rdr_name</span>
<a name="line-58"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-59"></a>
<a name="line-60"></a>    <span class='hs-varid'>new_tc</span> <span class='hs-varid'>tc_decl</span>              <span class='hs-comment'>-- NOT for type/data instances</span>
<a name="line-61"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLTyClDeclBinders</span> <span class='hs-varid'>tc_decl</span>
<a name="line-62"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>names</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>main_name</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newTopSrcBinder</span> <span class='hs-varid'>bndrs</span>
<a name="line-63"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>main_name</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-64"></a>
<a name="line-65"></a>    <span class='hs-varid'>new_assoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-66"></a>    <span class='hs-varid'>new_assoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstD</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-67"></a>      <span class='hs-comment'>-- type instances don't bind new names</span>
<a name="line-68"></a>
<a name="line-69"></a>    <span class='hs-varid'>new_assoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamInstD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>avail</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_di</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>d</span>
<a name="line-71"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>avail</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-72"></a>    <span class='hs-varid'>new_assoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClsInstD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cid_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClsInstDecl</span>
<a name="line-73"></a>                             <span class='hs-layout'>{</span> <span class='hs-varid'>cid_poly_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_ty</span>
<a name="line-74"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>cid_datafam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>adts</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-75"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls_rdr</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsInstDeclTy_maybe</span> <span class='hs-varid'>inst_ty</span>
<a name="line-76"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cls_nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupGlobalOccRn</span> <span class='hs-varid'>cls_rdr</span>
<a name="line-77"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_di</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>cls_nm</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>adts</span> <span class='hs-layout'>}</span>
<a name="line-78"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-79"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>     <span class='hs-comment'>-- Do not crash on ill-formed instances</span>
<a name="line-80"></a>                      <span class='hs-comment'>-- Eg   instance !Show Int   Trac #3811c</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-varid'>new_di</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataFamInstDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-83"></a>    <span class='hs-varid'>new_di</span> <span class='hs-varid'>mb_cls</span> <span class='hs-varid'>ti_decl</span>
<a name="line-84"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>main_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFamInstName</span> <span class='hs-varid'>mb_cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>dfid_tycon</span> <span class='hs-varid'>ti_decl</span><span class='hs-layout'>)</span>
<a name="line-85"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>sub_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newTopSrcBinder</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsDataFamInstBinders</span> <span class='hs-varid'>ti_decl</span><span class='hs-layout'>)</span>
<a name="line-86"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>main_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>sub_names</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-87"></a>                        <span class='hs-comment'>-- main_name is not bound here!</span>
</pre>\end{code}

Note [Looking up family names in family instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  module M where
    type family T a :: *
    type instance M.T Int = Bool

We might think that we can simply use 'lookupOccRn' when processing the type
instance to look up 'M.T'.  Alas, we can't!  The type family declaration is in
the *same* HsGroup as the type instance declaration.  Hence, as we are
currently collecting the binders declared in that HsGroup, these binders will
not have been added to the global environment yet.

Solution is simple: process the type family declarations first, extend
the environment, and then process the type instances.


%************************************************************************
%*                                                                      *
\subsection{Filtering imports}
%*                                                                      *
%************************************************************************

@filterImports@ takes the @ExportEnv@ telling what the imported module makes
available, and filters it through the import spec (if any).

\begin{code}
<pre><a name="line-1"></a><a name="filterImports"></a><span class='hs-definition'>filterImports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModIface</span>
<a name="line-2"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImpDeclSpec</span>                    <span class='hs-comment'>-- The span for the entire import decl</span>
<a name="line-3"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Import spec; True =&gt; hiding</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Import spec w/ Names</span>
<a name="line-5"></a>                      <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- Same again, but in GRE form</span>
<a name="line-6"></a><span class='hs-definition'>filterImports</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-conid'>Nothing</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>gresFromAvails</span> <span class='hs-varid'>prov</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_exports</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpAll</span> <span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>filterImports</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>want_hiding</span><span class='hs-layout'>,</span> <span class='hs-varid'>import_items</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-comment'>-- check for errors, convert RdrNames to Names</span>
<a name="line-14"></a>        <span class='hs-varid'>items1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lookup_lie</span> <span class='hs-varid'>import_items</span>
<a name="line-15"></a>
<a name="line-16"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>items2</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>            <span class='hs-varid'>items2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>items1</span>
<a name="line-18"></a>                <span class='hs-comment'>-- NB the AvailInfo may have duplicates, and several items</span>
<a name="line-19"></a>                <span class='hs-comment'>--    for the same parent; e.g N(x) and N(y)</span>
<a name="line-20"></a>
<a name="line-21"></a>            <span class='hs-varid'>names</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>availsToNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>items2</span><span class='hs-layout'>)</span>
<a name="line-22"></a>            <span class='hs-varid'>keep</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-23"></a>            <span class='hs-varid'>pruned_avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterAvails</span> <span class='hs-varid'>keep</span> <span class='hs-varid'>all_avails</span>
<a name="line-24"></a>            <span class='hs-varid'>hiding_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpAll</span> <span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>
<a name="line-26"></a>            <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>want_hiding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gresFromAvails</span> <span class='hs-varid'>hiding_prov</span> <span class='hs-varid'>pruned_avails</span>
<a name="line-27"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>gresFromIE</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>)</span> <span class='hs-varid'>items2</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>want_hiding</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>items2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>gres</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>all_avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_exports</span> <span class='hs-varid'>iface</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- This environment is how we map names mentioned in the import</span>
<a name="line-34"></a>        <span class='hs-comment'>-- list to the actual Name they correspond to, and the name family</span>
<a name="line-35"></a>        <span class='hs-comment'>-- that the Name belongs to (the AvailInfo).  The situation is</span>
<a name="line-36"></a>        <span class='hs-comment'>-- complicated by associated families, which introduce a three-level</span>
<a name="line-37"></a>        <span class='hs-comment'>-- hierachy, where class = grand parent, assoc family = parent, and</span>
<a name="line-38"></a>        <span class='hs-comment'>-- data constructors = children.  The occ_env entries for associated</span>
<a name="line-39"></a>        <span class='hs-comment'>-- families needs to capture all this information; hence, we have the</span>
<a name="line-40"></a>        <span class='hs-comment'>-- third component of the environment that gives the class name (=</span>
<a name="line-41"></a>        <span class='hs-comment'>-- grand parent) in case of associated families.</span>
<a name="line-42"></a>        <span class='hs-comment'>--</span>
<a name="line-43"></a>        <span class='hs-comment'>-- This env will have entries for data constructors too,</span>
<a name="line-44"></a>        <span class='hs-comment'>-- they won't make any difference because naked entities like T</span>
<a name="line-45"></a>        <span class='hs-comment'>-- in an import list map to TcOccs, not VarOccs.</span>
<a name="line-46"></a>    <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- the name</span>
<a name="line-47"></a>                       <span class='hs-conid'>AvailInfo</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- the export item providing the name</span>
<a name="line-48"></a>                       <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- the parent of associated types</span>
<a name="line-49"></a>    <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccEnv_C</span> <span class='hs-varid'>combine</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-50"></a>                                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>all_avails</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-51"></a>      <span class='hs-keyword'>where</span>
<a name="line-52"></a>        <span class='hs-comment'>-- we know that (1) there are at most 2 entries for one name, (2) their</span>
<a name="line-53"></a>        <span class='hs-comment'>-- first component is identical, (3) they are for tys/cls, and (4) one</span>
<a name="line-54"></a>        <span class='hs-comment'>-- entry has the name in its parent position (the other doesn't)</span>
<a name="line-55"></a>        <span class='hs-varid'>combine</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>subs1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-56"></a>                <span class='hs-layout'>(</span><span class='hs-keyword'>_</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>p2</span> <span class='hs-varid'>subs2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-57"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-58"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>parent</span><span class='hs-layout'>,</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>p2</span><span class='hs-layout'>,</span> <span class='hs-varid'>subs1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>p1</span><span class='hs-layout'>,</span> <span class='hs-varid'>subs2</span><span class='hs-layout'>)</span>
<a name="line-59"></a>            <span class='hs-keyword'>in</span>
<a name="line-60"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name</span> <span class='hs-varid'>subs</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>parent</span><span class='hs-layout'>)</span>
<a name="line-61"></a>        <span class='hs-varid'>combine</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"filterImports/combine"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a>    <span class='hs-varid'>lookup_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IELookupM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-64"></a>    <span class='hs-varid'>lookup_name</span> <span class='hs-varid'>rdr</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isQual</span> <span class='hs-varid'>rdr</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failLookupWith</span> <span class='hs-layout'>(</span><span class='hs-conid'>QualImportError</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-65"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>succ</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_success</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>succ</span>
<a name="line-66"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failLookupWith</span> <span class='hs-conid'>BadImport</span>
<a name="line-67"></a>      <span class='hs-keyword'>where</span>
<a name="line-68"></a>        <span class='hs-varid'>mb_success</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>occ_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-varid'>lookup_lie</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LIE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-71"></a>    <span class='hs-varid'>lookup_lie</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ieRdr</span><span class='hs-layout'>)</span>
<a name="line-72"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>stuff</span><span class='hs-layout'>,</span> <span class='hs-varid'>warns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-73"></a>                               <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-74"></a>                               <span class='hs-varid'>run_lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_ie</span> <span class='hs-varid'>ieRdr</span><span class='hs-layout'>)</span>
<a name="line-75"></a>             <span class='hs-varid'>mapM_</span> <span class='hs-varid'>emit_warning</span> <span class='hs-varid'>warns</span>
<a name="line-76"></a>             <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ie</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ie</span><span class='hs-layout'>,</span><span class='hs-varid'>avail</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>]</span>
<a name="line-77"></a>        <span class='hs-keyword'>where</span>
<a name="line-78"></a>            <span class='hs-comment'>-- Warn when importing T(..) if T was exported abstractly</span>
<a name="line-79"></a>            <span class='hs-varid'>emit_warning</span> <span class='hs-layout'>(</span><span class='hs-conid'>DodgyImport</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnDodgyImports</span> <span class='hs-varop'>$</span>
<a name="line-80"></a>              <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>dodgyImportWarn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-81"></a>            <span class='hs-varid'>emit_warning</span> <span class='hs-conid'>MissingImportList</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnMissingImportList</span> <span class='hs-varop'>$</span>
<a name="line-82"></a>              <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>missingImportListItem</span> <span class='hs-varid'>ieRdr</span><span class='hs-layout'>)</span>
<a name="line-83"></a>            <span class='hs-varid'>emit_warning</span> <span class='hs-conid'>BadImportW</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnDodgyImports</span> <span class='hs-varop'>$</span>
<a name="line-84"></a>              <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_err_msg</span> <span class='hs-conid'>BadImport</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a>            <span class='hs-varid'>run_lookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IELookupM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-87"></a>            <span class='hs-varid'>run_lookup</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-88"></a>              <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_err_msg</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-89"></a>              <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a>            <span class='hs-varid'>lookup_err_msg</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>of</span>
<a name="line-92"></a>              <span class='hs-conid'>BadImport</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>badImportItemErr</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-varid'>ieRdr</span> <span class='hs-varid'>all_avails</span>
<a name="line-93"></a>              <span class='hs-conid'>IllegalImport</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>illegalImportItemErr</span>
<a name="line-94"></a>              <span class='hs-conid'>QualImportError</span> <span class='hs-varid'>rdr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>qualImportItemErr</span> <span class='hs-varid'>rdr</span>
<a name="line-95"></a>
<a name="line-96"></a>        <span class='hs-comment'>-- For each import item, we convert its RdrNames to Names,</span>
<a name="line-97"></a>        <span class='hs-comment'>-- and at the same time construct an AvailInfo corresponding</span>
<a name="line-98"></a>        <span class='hs-comment'>-- to what is actually imported by this item.</span>
<a name="line-99"></a>        <span class='hs-comment'>-- Returns Nothing on error.</span>
<a name="line-100"></a>        <span class='hs-comment'>-- We return a list here, because in the case of an import</span>
<a name="line-101"></a>        <span class='hs-comment'>-- item like C, if we are hiding, then C refers to *both* a</span>
<a name="line-102"></a>        <span class='hs-comment'>-- type/class and a data constructor.  Moreover, when we import</span>
<a name="line-103"></a>        <span class='hs-comment'>-- data constructors of an associated family, we need separate</span>
<a name="line-104"></a>        <span class='hs-comment'>-- AvailInfos for the data constructors and the family (as they have</span>
<a name="line-105"></a>        <span class='hs-comment'>-- different parents).  See the discussion at occ_env.</span>
<a name="line-106"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IELookupM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IELookupWarning</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-107"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-varid'>ie</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>handle_bad_import</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-108"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>ie</span> <span class='hs-keyword'>of</span>
<a name="line-109"></a>        <span class='hs-conid'>IEVar</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-110"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_name</span> <span class='hs-varid'>n</span>
<a name="line-111"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IEVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>trimAvail</span> <span class='hs-varid'>avail</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a>        <span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-114"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name2</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_parent</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_name</span> <span class='hs-varid'>tc</span>
<a name="line-115"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>warns</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-num'>1</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DodgyImport</span> <span class='hs-varid'>tc</span><span class='hs-keyglyph'>]</span>
<a name="line-116"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_qual</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MissingImportList</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-118"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_parent</span> <span class='hs-keyword'>of</span>
<a name="line-119"></a>              <span class='hs-comment'>-- non-associated ty/cls</span>
<a name="line-120"></a>              <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>warns</span><span class='hs-layout'>)</span>
<a name="line-121"></a>              <span class='hs-comment'>-- associated ty</span>
<a name="line-122"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>parent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span>
<a name="line-123"></a>                                       <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name2</span> <span class='hs-layout'>(</span><span class='hs-varid'>subs</span> <span class='hs-varop'>\\</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-124"></a>                                      <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>parent</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-125"></a>                                     <span class='hs-varid'>warns</span><span class='hs-layout'>)</span>
<a name="line-126"></a>
<a name="line-127"></a>        <span class='hs-conid'>IEThingAbs</span> <span class='hs-varid'>tc</span>
<a name="line-128"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>want_hiding</span>   <span class='hs-comment'>-- hiding ( C )</span>
<a name="line-129"></a>                       <span class='hs-comment'>-- Here the 'C' can be a data constructor</span>
<a name="line-130"></a>                       <span class='hs-comment'>--  *or* a type/class, or even both</span>
<a name="line-131"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_name</span> <span class='hs-varid'>tc</span>
<a name="line-132"></a>                   <span class='hs-varid'>dc_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>setRdrNameSpace</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>srcDataName</span><span class='hs-layout'>)</span>
<a name="line-133"></a>               <span class='hs-keyword'>in</span>
<a name="line-134"></a>               <span class='hs-keyword'>case</span> <span class='hs-varid'>catIELookupM</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>dc_name</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-135"></a>                 <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failLookupWith</span> <span class='hs-conid'>BadImport</span>
<a name="line-136"></a>                 <span class='hs-varid'>names</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>mkIEThingAbs</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-137"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-138"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>nameAvail</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_name</span> <span class='hs-varid'>tc</span>
<a name="line-139"></a>                  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>mkIEThingAbs</span> <span class='hs-varid'>nameAvail</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-140"></a>
<a name="line-141"></a>        <span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-142"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>subnames</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_parent</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_name</span> <span class='hs-varid'>tc</span>
<a name="line-143"></a>
<a name="line-144"></a>           <span class='hs-comment'>-- Look up the children in the sub-names of the parent</span>
<a name="line-145"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_children</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupChildren</span> <span class='hs-varid'>subnames</span> <span class='hs-varid'>ns</span>
<a name="line-146"></a>
<a name="line-147"></a>           <span class='hs-varid'>children</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_children</span>
<a name="line-148"></a>                       <span class='hs-keyword'>then</span> <span class='hs-varid'>failLookupWith</span> <span class='hs-conid'>BadImport</span>
<a name="line-149"></a>                       <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>mb_children</span><span class='hs-layout'>)</span>
<a name="line-150"></a>
<a name="line-151"></a>           <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_parent</span> <span class='hs-keyword'>of</span>
<a name="line-152"></a>             <span class='hs-comment'>-- non-associated ty/cls</span>
<a name="line-153"></a>             <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>name</span> <span class='hs-varid'>children</span><span class='hs-layout'>,</span>
<a name="line-154"></a>                                      <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-conop'>:</span><span class='hs-varid'>children</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-155"></a>                                    <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-156"></a>             <span class='hs-comment'>-- associated ty</span>
<a name="line-157"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>parent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>name</span> <span class='hs-varid'>children</span><span class='hs-layout'>,</span>
<a name="line-158"></a>                                      <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name</span> <span class='hs-varid'>children</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-159"></a>                                     <span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>name</span> <span class='hs-varid'>children</span><span class='hs-layout'>,</span>
<a name="line-160"></a>                                      <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>parent</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-161"></a>                                    <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-162"></a>
<a name="line-163"></a>        <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failLookupWith</span> <span class='hs-conid'>IllegalImport</span>
<a name="line-164"></a>        <span class='hs-comment'>-- could be IEModuleContents, IEGroup, IEDoc, IEDocNamed</span>
<a name="line-165"></a>        <span class='hs-comment'>-- all errors.</span>
<a name="line-166"></a>
<a name="line-167"></a>      <span class='hs-keyword'>where</span>
<a name="line-168"></a>        <span class='hs-varid'>mkIEThingAbs</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>av</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span>    <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAbs</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>trimAvail</span> <span class='hs-varid'>av</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-169"></a>        <span class='hs-varid'>mkIEThingAbs</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>  <span class='hs-conid'>Just</span> <span class='hs-varid'>parent</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAbs</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>parent</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a>        <span class='hs-varid'>handle_bad_import</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catchIELookup</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>of</span>
<a name="line-172"></a>          <span class='hs-conid'>BadImport</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>want_hiding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BadImportW</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-173"></a>          <span class='hs-keyword'>_</span>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failLookupWith</span> <span class='hs-varid'>err</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="IELookupM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IELookupM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>IELookupError</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="IELookupWarning"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IELookupWarning</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BadImportW</span>
<a name="line-179"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MissingImportList</span>
<a name="line-180"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DodgyImport</span> <span class='hs-conid'>RdrName</span>
<a name="line-181"></a>  <span class='hs-comment'>-- NB. use the RdrName for reporting a "dodgy" import</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="IELookupError"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IELookupError</span>
<a name="line-184"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>QualImportError</span> <span class='hs-conid'>RdrName</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BadImport</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IllegalImport</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="failLookupWith"></a><span class='hs-definition'>failLookupWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IELookupError</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IELookupM</span> <span class='hs-varid'>a</span>
<a name="line-189"></a><span class='hs-definition'>failLookupWith</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="catchIELookup"></a><span class='hs-definition'>catchIELookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IELookupM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>IELookupError</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IELookupM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IELookupM</span> <span class='hs-varid'>a</span>
<a name="line-192"></a><span class='hs-definition'>catchIELookup</span> <span class='hs-varid'>m</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-193"></a>  <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-194"></a>  <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span> <span class='hs-varid'>err</span>
<a name="line-195"></a>
<a name="line-196"></a><a name="catIELookupM"></a><span class='hs-definition'>catIELookupM</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IELookupM</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-197"></a><span class='hs-definition'>catIELookupM</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Import/Export Utils}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="greExportAvail"></a><span class='hs-definition'>greExportAvail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-2"></a><span class='hs-definition'>greExportAvail</span> <span class='hs-varid'>gre</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>gre_par</span> <span class='hs-varid'>gre</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>      <span class='hs-conid'>ParentIs</span> <span class='hs-varid'>p</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>me</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>      <span class='hs-conid'>NoParent</span>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyConName</span> <span class='hs-varid'>me</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>me</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>me</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Avail</span>   <span class='hs-varid'>me</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>me</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="plusAvail"></a><span class='hs-definition'>plusAvail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-11"></a><span class='hs-definition'>plusAvail</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>availName</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>availName</span> <span class='hs-varid'>a2</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"RnEnv.plusAvail names differ"</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>a1</span><span class='hs-layout'>,</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>plusAvail</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span>
<a name="line-15"></a><span class='hs-definition'>plusAvail</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>        <span class='hs-varid'>a2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a2</span>
<a name="line-16"></a><span class='hs-definition'>plusAvail</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span>
<a name="line-17"></a><span class='hs-definition'>plusAvail</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-conop'>:</span><span class='hs-varid'>ss1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n2</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-conop'>:</span><span class='hs-varid'>ss2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span><span class='hs-varop'>==</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>n2</span><span class='hs-varop'>==</span><span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>  <span class='hs-comment'>-- Maintain invariant the parent is first</span>
<a name="line-19"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span><span class='hs-conid'>True</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>ss2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span><span class='hs-conid'>False</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-conop'>:</span><span class='hs-varid'>ss2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span><span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-conop'>:</span><span class='hs-varid'>ss1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>ss2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-22"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span><span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-conop'>:</span><span class='hs-varid'>ss1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-conop'>:</span><span class='hs-varid'>ss2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-definition'>plusAvail</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"RnEnv.plusAvail"</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>a1</span><span class='hs-layout'>,</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="trimAvail"></a><span class='hs-definition'>trimAvail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-26"></a><span class='hs-definition'>trimAvail</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span>
<a name="line-27"></a><span class='hs-definition'>trimAvail</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>m</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="filterAvails"></a><span class='hs-comment'>-- | filters 'AvailInfo's by the given predicate</span>
<a name="line-30"></a><span class='hs-definition'>filterAvails</span>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a><span class='hs-definition'>filterAvails</span> <span class='hs-varid'>keep</span> <span class='hs-varid'>avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterAvail</span> <span class='hs-varid'>keep</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>avails</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="filterAvail"></a><span class='hs-comment'>-- | filters an 'AvailInfo' by the given predicate</span>
<a name="line-34"></a><span class='hs-definition'>filterAvail</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-35"></a><span class='hs-definition'>filterAvail</span> <span class='hs-varid'>keep</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span>
<a name="line-36"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ie</span> <span class='hs-keyword'>of</span>
<a name="line-37"></a>    <span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>keep</span> <span class='hs-varid'>n</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ie</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span>
<a name="line-38"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rest</span>
<a name="line-39"></a>    <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-40"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>left</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>keep</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>in</span>
<a name="line-41"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>left</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>rest</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>left</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="gresFromIE"></a><span class='hs-comment'>-- | Given an import\/export spec, construct the appropriate 'GlobalRdrElt's.</span>
<a name="line-44"></a><span class='hs-definition'>gresFromIE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailInfo</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a><span class='hs-definition'>gresFromIE</span> <span class='hs-varid'>decl_spec</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ie</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gresFromAvail</span> <span class='hs-varid'>prov_fn</span> <span class='hs-varid'>avail</span>
<a name="line-47"></a>  <span class='hs-keyword'>where</span>
<a name="line-48"></a>    <span class='hs-varid'>is_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ie</span> <span class='hs-keyword'>of</span>
<a name="line-49"></a>                    <span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name</span>
<a name="line-50"></a>                    <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-51"></a>    <span class='hs-varid'>prov_fn</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>imp_spec</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>        <span class='hs-keyword'>where</span>
<a name="line-53"></a>          <span class='hs-varid'>imp_spec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>item_spec</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>          <span class='hs-varid'>item_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpSome</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_explicit</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_iloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="mkChildEnv"></a><span class='hs-definition'>mkChildEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-57"></a><span class='hs-definition'>mkChildEnv</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>gres</span>
<a name="line-58"></a>    <span class='hs-keyword'>where</span>
<a name="line-59"></a>        <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_par</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParentIs</span> <span class='hs-varid'>p</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv_Acc</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>singleton</span> <span class='hs-varid'>env</span> <span class='hs-varid'>p</span> <span class='hs-varid'>n</span>
<a name="line-60"></a>        <span class='hs-varid'>add</span> <span class='hs-keyword'>_</span>                                            <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="findChildren"></a><span class='hs-definition'>findChildren</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a><span class='hs-definition'>findChildren</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="lookupChildren"></a><span class='hs-definition'>lookupChildren</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-66"></a><span class='hs-comment'>-- (lookupChildren all_kids rdr_items) maps each rdr_item to its</span>
<a name="line-67"></a><span class='hs-comment'>-- corresponding Name all_kids, if the former exists</span>
<a name="line-68"></a><span class='hs-comment'>-- The matching is done by FastString, not OccName, so that</span>
<a name="line-69"></a><span class='hs-comment'>--    Cls( meth, AssocTy )</span>
<a name="line-70"></a><span class='hs-comment'>-- will correctly find AssocTy among the all_kids of Cls, even though</span>
<a name="line-71"></a><span class='hs-comment'>-- the RdrName for AssocTy may have a (bogus) DataName namespace</span>
<a name="line-72"></a><span class='hs-comment'>-- (Really the rdr_items should be FastStrings in the first place.)</span>
<a name="line-73"></a><span class='hs-definition'>lookupChildren</span> <span class='hs-varid'>all_kids</span> <span class='hs-varid'>rdr_items</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupFsEnv</span> <span class='hs-varid'>kid_env</span> <span class='hs-varop'>.</span> <span class='hs-varid'>occNameFS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rdrNameOcc</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdr_items</span>
<a name="line-75"></a>  <span class='hs-keyword'>where</span>
<a name="line-76"></a>    <span class='hs-varid'>kid_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFsEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>all_kids</span><span class='hs-keyglyph'>]</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="nubAvails"></a><span class='hs-comment'>-- | Combines 'AvailInfo's from the same family</span>
<a name="line-79"></a><span class='hs-comment'>-- 'avails' may have several items with the same availName</span>
<a name="line-80"></a><span class='hs-comment'>-- E.g  import Ix( Ix(..), index )</span>
<a name="line-81"></a><span class='hs-comment'>-- will give Ix(Ix,index,range) and Ix(index)</span>
<a name="line-82"></a><span class='hs-comment'>-- We want to combine these; addAvail does that</span>
<a name="line-83"></a><span class='hs-definition'>nubAvails</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-84"></a><span class='hs-definition'>nubAvails</span> <span class='hs-varid'>avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>avails</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyword'>where</span>
<a name="line-86"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>env</span> <span class='hs-varid'>avail</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv_C</span> <span class='hs-varid'>plusAvail</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>availName</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span> <span class='hs-varid'>avail</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Export list processing}
%*                                                                      *
%************************************************************************

Processing the export list.

You might think that we should record things that appear in the export
list as ``occurrences'' (using @addOccurrenceName@), but you'd be
wrong.  We do check (here) that they are in scope, but there is no
need to slurp in their actual declaration (which is what
@addOccurrenceName@ forces).

Indeed, doing so would big trouble when compiling @PrelBase@, because
it re-exports @GHC@, which includes @takeMVar#@, whose type includes
@ConcBase.StateAndSynchVar#@, and so on...

Note [Exports of data families]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose you see (Trac #5306)
        module M where
          import X( F )
          data instance F Int = FInt
What does M export?  AvailTC F [FInt]
                  or AvailTC F [F,FInt]?
The former is strictly right because F isn't defined in this module.
But then you can never do an explicit import of M, thus
    import M( F( FInt ) )
because F isn't exported by M.  Nor can you import FInt alone from here
    import M( FInt )
because we don't have syntax to support that.  (It looks like an import of
the type FInt.)

At one point I implemented a compromise:
  * When constructing exports with no export list, or with module M(
    module M ), we add the parent to the exports as well.
  * But not when you see module M( f ), even if f is a
    class method with a parent.
  * Nor when you see module M( module N ), with N /= M.

But the compromise seemed too much of a hack, so we backed it out.
You just have to use an explicit export list:
    module M( F(..) ) where ...

\begin{code}
<pre><a name="line-1"></a><a name="ExportAccum"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ExportAccum</span>        <span class='hs-comment'>-- The type of the accumulating parameter of</span>
<a name="line-2"></a>                        <span class='hs-comment'>-- the main worker function in rnExports</span>
<a name="line-3"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>             <span class='hs-comment'>-- Export items with Names</span>
<a name="line-4"></a>        <span class='hs-conid'>ExportOccMap</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- Tracks exported occurrence names</span>
<a name="line-5"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>            <span class='hs-comment'>-- The accumulated exported stuff</span>
<a name="line-6"></a>                                <span class='hs-comment'>--   Not nub'd!</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="emptyExportAccum"></a><span class='hs-definition'>emptyExportAccum</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExportAccum</span>
<a name="line-9"></a><span class='hs-definition'>emptyExportAccum</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyOccEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="ExportOccMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ExportOccMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-12"></a>        <span class='hs-comment'>-- Tracks what a particular exported OccName</span>
<a name="line-13"></a>        <span class='hs-comment'>--   in an export list refers to, and which item</span>
<a name="line-14"></a>        <span class='hs-comment'>--   it came from.  It's illegal to export two distinct things</span>
<a name="line-15"></a>        <span class='hs-comment'>--   that have the same occurrence name</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="rnExports"></a><span class='hs-definition'>rnExports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- False =&gt; no 'module M(..) where' header at all</span>
<a name="line-18"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Nothing =&gt; no explicit export list</span>
<a name="line-19"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-20"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-comment'>-- Complains if two distinct exports have same OccName</span>
<a name="line-23"></a>        <span class='hs-comment'>-- Warns about identical exports.</span>
<a name="line-24"></a>        <span class='hs-comment'>-- Complains about exports items not in scope</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>rnExports</span> <span class='hs-varid'>explicit_mod</span> <span class='hs-varid'>exports</span>
<a name="line-27"></a>          <span class='hs-varid'>tcg_env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-28"></a>                              <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span>
<a name="line-29"></a>                              <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imports</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-30"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsetWOptM</span> <span class='hs-conid'>Opt_WarnWarningsDeprecations</span> <span class='hs-varop'>$</span>
<a name="line-31"></a>       <span class='hs-comment'>-- Do not report deprecations arising from the export</span>
<a name="line-32"></a>       <span class='hs-comment'>-- list, to avoid bleating about re-exporting a deprecated</span>
<a name="line-33"></a>       <span class='hs-comment'>-- thing (especially via 'module Foo' export item)</span>
<a name="line-34"></a>   <span class='hs-keyword'>do</span>   <span class='hs-layout'>{</span>
<a name="line-35"></a>        <span class='hs-comment'>-- If the module header is omitted altogether, then behave</span>
<a name="line-36"></a>        <span class='hs-comment'>-- as if the user had written "module Main(main) where..."</span>
<a name="line-37"></a>        <span class='hs-comment'>-- EXCEPT in interactive mode, when we behave as if he had</span>
<a name="line-38"></a>        <span class='hs-comment'>-- written "module Main where ..."</span>
<a name="line-39"></a>        <span class='hs-comment'>-- Reason: don't want to complain about 'main' not in scope</span>
<a name="line-40"></a>        <span class='hs-comment'>--         in interactive mode</span>
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>real_exports</span>
<a name="line-43"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>explicit_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span>
<a name="line-44"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ghcLink</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>LinkInMemory</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-45"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEVar</span> <span class='hs-varid'>main_RDR_Unqual</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-46"></a>                        <span class='hs-comment'>-- ToDo: the 'noLoc' here is unhelpful if 'main'</span>
<a name="line-47"></a>                        <span class='hs-comment'>--       turns out to be out of scope</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_exports</span><span class='hs-layout'>,</span> <span class='hs-varid'>avails</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>exports_from_avail</span> <span class='hs-varid'>real_exports</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>imports</span> <span class='hs-varid'>this_mod</span>
<a name="line-50"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nubAvails</span> <span class='hs-varid'>avails</span>    <span class='hs-comment'>-- Combine families</span>
<a name="line-51"></a>
<a name="line-52"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rnExports: Exports:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_avails</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_exports</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_avails</span><span class='hs-layout'>,</span>
<a name="line-55"></a>                            <span class='hs-varid'>tcg_rn_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcg_rn_exports</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyword'>of</span>
<a name="line-56"></a>                                                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-57"></a>                                                <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rn_exports</span><span class='hs-layout'>,</span>
<a name="line-58"></a>                            <span class='hs-varid'>tcg_dus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>`plusDU`</span>
<a name="line-59"></a>                                      <span class='hs-varid'>usesOnly</span> <span class='hs-layout'>(</span><span class='hs-varid'>availsToNameSet</span> <span class='hs-varid'>final_avails</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="exports_from_avail"></a><span class='hs-definition'>exports_from_avail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a>                         <span class='hs-comment'>-- Nothing =&gt; no explicit export list</span>
<a name="line-63"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-64"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-65"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-66"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>exports_from_avail</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>rdr_env</span> <span class='hs-sel'>_imports</span> <span class='hs-sel'>_this_mod</span>
<a name="line-69"></a> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- The same as (module M) where M is the current module name,</span>
<a name="line-70"></a>   <span class='hs-comment'>-- so that's how we handle it.</span>
<a name="line-71"></a>   <span class='hs-keyword'>let</span>
<a name="line-72"></a>       <span class='hs-varid'>avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>greExportAvail</span> <span class='hs-varid'>gre</span>
<a name="line-73"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-varid'>rdr_env</span>
<a name="line-74"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>isLocalGRE</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>]</span>
<a name="line-75"></a>   <span class='hs-keyword'>in</span>
<a name="line-76"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>avails</span><span class='hs-layout'>)</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-definition'>exports_from_avail</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>rdr_items</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>imports</span> <span class='hs-varid'>this_mod</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>ie_names</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>do_litem</span> <span class='hs-varid'>emptyExportAccum</span> <span class='hs-varid'>rdr_items</span>
<a name="line-80"></a>
<a name="line-81"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ie_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span>
<a name="line-83"></a>    <span class='hs-varid'>do_litem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExportAccum</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LIE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>ExportAccum</span>
<a name="line-84"></a>    <span class='hs-varid'>do_litem</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>lie</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>exports_from_item</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a>    <span class='hs-varid'>kids_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Maps a parent to its in-scope children</span>
<a name="line-87"></a>    <span class='hs-varid'>kids_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkChildEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>    <span class='hs-varid'>imported_modules</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>qual_name</span>
<a name="line-90"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>moduleEnvElts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>imp_mods</span> <span class='hs-varid'>imports</span><span class='hs-layout'>,</span>
<a name="line-91"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>qual_name</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>]</span>
<a name="line-92"></a>
<a name="line-93"></a>    <span class='hs-varid'>exports_from_item</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExportAccum</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LIE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>ExportAccum</span>
<a name="line-94"></a>    <span class='hs-varid'>exports_from_item</span> <span class='hs-varid'>acc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>ie_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>occs</span><span class='hs-layout'>,</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span>
<a name="line-95"></a>                      <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEModuleContents</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>earlier_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEModuleContents</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ie_names</span> <span class='hs-keyglyph'>]</span>
<a name="line-97"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>earlier_mods</span>    <span class='hs-comment'>-- Duplicate export of M</span>
<a name="line-98"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warn_dup_exports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnDuplicateExports</span> <span class='hs-layout'>;</span>
<a name="line-99"></a>               <span class='hs-varid'>warnIf</span> <span class='hs-varid'>warn_dup_exports</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupModuleExport</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-100"></a>               <span class='hs-varid'>return</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>
<a name="line-102"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-103"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>implicit_prelude</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ImplicitPrelude</span>
<a name="line-104"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>warnDodgyExports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnDodgyExports</span>
<a name="line-105"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>exportValid</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>imported_modules</span><span class='hs-layout'>)</span>
<a name="line-106"></a>                                <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>this_mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-107"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isModuleExported</span> <span class='hs-varid'>implicit_prelude</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-108"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span>
<a name="line-109"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>new_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>greExportAvail</span> <span class='hs-varid'>gres</span>
<a name="line-110"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>names</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>gres</span> <span class='hs-layout'>}</span>
<a name="line-111"></a>
<a name="line-112"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>checkErr</span> <span class='hs-varid'>exportValid</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleNotImported</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-113"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>warnIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>warnDodgyExports</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>exportValid</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-114"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>nullModuleExport</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-115"></a>
<a name="line-116"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>addUsedRdrNames</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkRdrQual</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRdrUnqual</span> <span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a>                                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-118"></a>                        <span class='hs-comment'>-- The qualified and unqualified version of all of</span>
<a name="line-119"></a>                        <span class='hs-comment'>-- these names are, in effect, used by this export</span>
<a name="line-120"></a>
<a name="line-121"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>occs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>check_occs</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEModuleContents</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>names</span>
<a name="line-122"></a>                      <span class='hs-comment'>-- This check_occs not only finds conflicts</span>
<a name="line-123"></a>                      <span class='hs-comment'>-- between this item and others, but also</span>
<a name="line-124"></a>                      <span class='hs-comment'>-- internally within this item.  That is, if</span>
<a name="line-125"></a>                      <span class='hs-comment'>-- 'M.x' is in scope in several ways, we'll have</span>
<a name="line-126"></a>                      <span class='hs-comment'>-- several members of mod_avails with the same</span>
<a name="line-127"></a>                      <span class='hs-comment'>-- OccName.</span>
<a name="line-128"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"export mod"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span>
<a name="line-129"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_exports</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-130"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEModuleContents</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ie_names</span><span class='hs-layout'>,</span>
<a name="line-131"></a>                       <span class='hs-varid'>occs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_exports</span> <span class='hs-varop'>++</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-132"></a>
<a name="line-133"></a>    <span class='hs-varid'>exports_from_item</span> <span class='hs-varid'>acc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>lie_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>occs</span><span class='hs-layout'>,</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span>
<a name="line-134"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDoc</span> <span class='hs-varid'>ie</span>
<a name="line-135"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_ie</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_doc_ie</span> <span class='hs-varid'>ie</span>
<a name="line-136"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_ie</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lie_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>occs</span><span class='hs-layout'>,</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span>
<a name="line-137"></a>
<a name="line-138"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-139"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ie</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_ie</span> <span class='hs-varid'>ie</span>
<a name="line-140"></a>             <span class='hs-keyword'>if</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-layout'>(</span><span class='hs-varid'>ieName</span> <span class='hs-varid'>new_ie</span><span class='hs-layout'>)</span>
<a name="line-141"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>acc</span>    <span class='hs-comment'>-- Avoid error cascade</span>
<a name="line-142"></a>                  <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-143"></a>
<a name="line-144"></a>             <span class='hs-varid'>occs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>check_occs</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>occs</span> <span class='hs-layout'>(</span><span class='hs-varid'>availNames</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span>
<a name="line-145"></a>
<a name="line-146"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_ie</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lie_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>occs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span> <span class='hs-conop'>:</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span>
<a name="line-147"></a>
<a name="line-148"></a>    <span class='hs-comment'>-------------</span>
<a name="line-149"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailInfo</span><span class='hs-layout'>)</span>
<a name="line-150"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEVar</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-151"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGreRn</span> <span class='hs-varid'>rdr</span>
<a name="line-152"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>greExportAvail</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span>
<a name="line-153"></a>
<a name="line-154"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAbs</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-155"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGreRn</span> <span class='hs-varid'>rdr</span>
<a name="line-156"></a>             <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span>
<a name="line-157"></a>                 <span class='hs-varid'>avail</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>greExportAvail</span> <span class='hs-varid'>gre</span>
<a name="line-158"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAbs</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span>
<a name="line-159"></a>
<a name="line-160"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-varid'>ie</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-161"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGlobalOccRn</span> <span class='hs-varid'>rdr</span>
<a name="line-162"></a>             <span class='hs-keyword'>let</span> <span class='hs-varid'>kids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findChildren</span> <span class='hs-varid'>kids_env</span> <span class='hs-varid'>name</span>
<a name="line-163"></a>             <span class='hs-varid'>addUsedKids</span> <span class='hs-varid'>rdr</span> <span class='hs-varid'>kids</span>
<a name="line-164"></a>             <span class='hs-varid'>warnDodgyExports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnDodgyExports</span>
<a name="line-165"></a>             <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>kids</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-166"></a>                  <span class='hs-keyword'>if</span> <span class='hs-varid'>isTyConName</span> <span class='hs-varid'>name</span>
<a name="line-167"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>when</span> <span class='hs-varid'>warnDodgyExports</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>dodgyExportWarn</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-168"></a>                  <span class='hs-keyword'>else</span> <span class='hs-comment'>-- This occurs when you export T(..), but</span>
<a name="line-169"></a>                       <span class='hs-comment'>-- only import T abstractly, or T is a synonym.</span>
<a name="line-170"></a>                       <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exportItemErr</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span>
<a name="line-171"></a>
<a name="line-172"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-conop'>:</span><span class='hs-varid'>kids</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-173"></a>
<a name="line-174"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-varid'>ie</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>rdr</span> <span class='hs-varid'>sub_rdrs</span><span class='hs-layout'>)</span>
<a name="line-175"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGlobalOccRn</span> <span class='hs-varid'>rdr</span>
<a name="line-176"></a>             <span class='hs-keyword'>if</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>name</span>
<a name="line-177"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>name</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-178"></a>                <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-179"></a>             <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupChildren</span> <span class='hs-layout'>(</span><span class='hs-varid'>findChildren</span> <span class='hs-varid'>kids_env</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>sub_rdrs</span>
<a name="line-180"></a>             <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_names</span>
<a name="line-181"></a>                <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exportItemErr</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span>
<a name="line-182"></a>                        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>name</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-183"></a>                <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catMaybes</span> <span class='hs-varid'>mb_names</span>
<a name="line-184"></a>                        <span class='hs-varid'>addUsedKids</span> <span class='hs-varid'>rdr</span> <span class='hs-varid'>names</span>
<a name="line-185"></a>                        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>name</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-conop'>:</span><span class='hs-varid'>names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a>    <span class='hs-varid'>lookup_ie</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"lookup_ie"</span>    <span class='hs-comment'>-- Other cases covered earlier</span>
<a name="line-188"></a>
<a name="line-189"></a>    <span class='hs-comment'>-------------</span>
<a name="line-190"></a>    <span class='hs-varid'>lookup_doc_ie</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-191"></a>    <span class='hs-varid'>lookup_doc_ie</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEGroup</span> <span class='hs-varid'>lev</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>rn_doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsDoc</span> <span class='hs-varid'>doc</span>
<a name="line-192"></a>                                         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEGroup</span> <span class='hs-varid'>lev</span> <span class='hs-varid'>rn_doc</span><span class='hs-layout'>)</span>
<a name="line-193"></a>    <span class='hs-varid'>lookup_doc_ie</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDoc</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>rn_doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsDoc</span> <span class='hs-varid'>doc</span>
<a name="line-194"></a>                                         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDoc</span> <span class='hs-varid'>rn_doc</span><span class='hs-layout'>)</span>
<a name="line-195"></a>    <span class='hs-varid'>lookup_doc_ie</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDocNamed</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDocNamed</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>
<a name="line-196"></a>    <span class='hs-varid'>lookup_doc_ie</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"lookup_doc_ie"</span>    <span class='hs-comment'>-- Other cases covered earlier</span>
<a name="line-197"></a>
<a name="line-198"></a>    <span class='hs-comment'>-- In an export item M.T(A,B,C), we want to treat the uses of</span>
<a name="line-199"></a>    <span class='hs-comment'>-- A,B,C as if they were M.A, M.B, M.C</span>
<a name="line-200"></a>    <span class='hs-varid'>addUsedKids</span> <span class='hs-varid'>parent_rdr</span> <span class='hs-varid'>kid_names</span>
<a name="line-201"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addUsedRdrNames</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_kid_rdr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nameOccName</span><span class='hs-layout'>)</span> <span class='hs-varid'>kid_names</span>
<a name="line-202"></a>       <span class='hs-keyword'>where</span>
<a name="line-203"></a>         <span class='hs-varid'>mk_kid_rdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isQual_maybe</span> <span class='hs-varid'>parent_rdr</span> <span class='hs-keyword'>of</span>
<a name="line-204"></a>                         <span class='hs-conid'>Nothing</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrUnqual</span>
<a name="line-205"></a>                         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>modName</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrQual</span> <span class='hs-varid'>modName</span>
<a name="line-206"></a>
<a name="line-207"></a><a name="isDoc"></a><span class='hs-definition'>isDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-208"></a><span class='hs-definition'>isDoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDoc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-209"></a><span class='hs-definition'>isDoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEDocNamed</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-210"></a><span class='hs-definition'>isDoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEGroup</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-211"></a><span class='hs-definition'>isDoc</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="isModuleExported"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-214"></a><span class='hs-definition'>isModuleExported</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-215"></a><span class='hs-comment'>-- True if the thing is in scope *both* unqualified, *and* with qualifier M</span>
<a name="line-216"></a><span class='hs-definition'>isModuleExported</span> <span class='hs-varid'>implicit_prelude</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-217"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>implicit_prelude</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isBuiltInSyntax</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-218"></a>        <span class='hs-comment'>-- Optimisation: filter out names for built-in syntax</span>
<a name="line-219"></a>        <span class='hs-comment'>-- They just clutter up the environment (esp tuples), and the parser</span>
<a name="line-220"></a>        <span class='hs-comment'>-- will generate Exact RdrNames for them, so the cluttered</span>
<a name="line-221"></a>        <span class='hs-comment'>-- envt is no use.  To avoid doing this filter all the time,</span>
<a name="line-222"></a>        <span class='hs-comment'>-- we use -XNoImplicitPrelude as a clue that the filter is</span>
<a name="line-223"></a>        <span class='hs-comment'>-- worth while.  Really, it's only useful for GHC.Base and GHC.Tuple.</span>
<a name="line-224"></a>        <span class='hs-comment'>--</span>
<a name="line-225"></a>        <span class='hs-comment'>-- It's worth doing because it makes the environment smaller for</span>
<a name="line-226"></a>        <span class='hs-comment'>-- every module that imports the Prelude</span>
<a name="line-227"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>prov</span> <span class='hs-keyword'>of</span>
<a name="line-229"></a>        <span class='hs-conid'>LocalDef</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>name</span>
<a name="line-230"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>name_mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mod</span>
<a name="line-231"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-232"></a>        <span class='hs-conid'>Imported</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>unQualSpecOK</span> <span class='hs-varid'>is</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>qualSpecOK</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="check_occs"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-235"></a><span class='hs-definition'>check_occs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExportOccMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>ExportOccMap</span>
<a name="line-236"></a><span class='hs-definition'>check_occs</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>names</span>  <span class='hs-comment'>-- 'names' are the entities specifed by 'ie'</span>
<a name="line-237"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>check</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>names</span>
<a name="line-238"></a>  <span class='hs-keyword'>where</span>
<a name="line-239"></a>    <span class='hs-varid'>check</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>name</span>
<a name="line-240"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>name_occ</span> <span class='hs-keyword'>of</span>
<a name="line-241"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendOccEnv</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>name_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-242"></a>
<a name="line-243"></a>          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>name'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie'</span><span class='hs-layout'>)</span>
<a name="line-244"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name'</span>   <span class='hs-comment'>-- Duplicate export</span>
<a name="line-245"></a>            <span class='hs-comment'>-- But we don't want to warn if the same thing is exported</span>
<a name="line-246"></a>            <span class='hs-comment'>-- by two different module exports. See ticket #4478.</span>
<a name="line-247"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupExport_ok</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>ie'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-248"></a>                      <span class='hs-varid'>warn_dup_exports</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnDuplicateExports</span>
<a name="line-249"></a>                      <span class='hs-varid'>warnIf</span> <span class='hs-varid'>warn_dup_exports</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupExportWarn</span> <span class='hs-varid'>name_occ</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>ie'</span><span class='hs-layout'>)</span>
<a name="line-250"></a>                  <span class='hs-varid'>return</span> <span class='hs-varid'>occs</span>
<a name="line-251"></a>
<a name="line-252"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-comment'>-- Same occ name but different names: an error</span>
<a name="line-253"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>global_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGlobalRdrEnv</span> <span class='hs-layout'>;</span>
<a name="line-254"></a>                     <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exportClashErr</span> <span class='hs-varid'>global_env</span> <span class='hs-varid'>name'</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ie'</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-255"></a>                     <span class='hs-varid'>return</span> <span class='hs-varid'>occs</span> <span class='hs-layout'>}</span>
<a name="line-256"></a>      <span class='hs-keyword'>where</span>
<a name="line-257"></a>        <span class='hs-varid'>name_occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-258"></a>
<a name="line-259"></a>
<a name="line-260"></a><a name="dupExport_ok"></a><span class='hs-definition'>dupExport_ok</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-261"></a><span class='hs-comment'>-- The Name is exported by both IEs. Is that ok?</span>
<a name="line-262"></a><span class='hs-comment'>-- "No"  iff the name is mentioned explicitly in both IEs</span>
<a name="line-263"></a><span class='hs-comment'>--        or one of the IEs mentions the name *alone*</span>
<a name="line-264"></a><span class='hs-comment'>-- "Yes" otherwise</span>
<a name="line-265"></a><span class='hs-comment'>--</span>
<a name="line-266"></a><span class='hs-comment'>-- Examples of "no":  module M( f, f )</span>
<a name="line-267"></a><span class='hs-comment'>--                    module M( fmap, Functor(..) )</span>
<a name="line-268"></a><span class='hs-comment'>--                    module M( module Data.List, head )</span>
<a name="line-269"></a><span class='hs-comment'>--</span>
<a name="line-270"></a><span class='hs-comment'>-- Example of "yes"</span>
<a name="line-271"></a><span class='hs-comment'>--    module M( module A, module B ) where</span>
<a name="line-272"></a><span class='hs-comment'>--        import A( f )</span>
<a name="line-273"></a><span class='hs-comment'>--        import B( f )</span>
<a name="line-274"></a><span class='hs-comment'>--</span>
<a name="line-275"></a><span class='hs-comment'>-- Example of "yes" (Trac #2436)</span>
<a name="line-276"></a><span class='hs-comment'>--    module M( C(..), T(..) ) where</span>
<a name="line-277"></a><span class='hs-comment'>--         class C a where { data T a }</span>
<a name="line-278"></a><span class='hs-comment'>--         instace C Int where { data T Int = TInt }</span>
<a name="line-279"></a><span class='hs-comment'>--</span>
<a name="line-280"></a><span class='hs-comment'>-- Example of "yes" (Trac #2436)</span>
<a name="line-281"></a><span class='hs-comment'>--    module Foo ( T ) where</span>
<a name="line-282"></a><span class='hs-comment'>--      data family T a</span>
<a name="line-283"></a><span class='hs-comment'>--    module Bar ( T(..), module Foo ) where</span>
<a name="line-284"></a><span class='hs-comment'>--        import Foo</span>
<a name="line-285"></a><span class='hs-comment'>--        data instance T Int = TInt</span>
<a name="line-286"></a>
<a name="line-287"></a><span class='hs-definition'>dupExport_ok</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ie1</span> <span class='hs-varid'>ie2</span>
<a name="line-288"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span>  <span class='hs-varid'>single</span> <span class='hs-varid'>ie1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>single</span> <span class='hs-varid'>ie2</span>
<a name="line-289"></a>        <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>explicit_in</span> <span class='hs-varid'>ie1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>explicit_in</span> <span class='hs-varid'>ie2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-290"></a>  <span class='hs-keyword'>where</span>
<a name="line-291"></a>    <span class='hs-varid'>explicit_in</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEModuleContents</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>                <span class='hs-comment'>-- module M</span>
<a name="line-292"></a>    <span class='hs-varid'>explicit_in</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>r</span>  <span class='hs-comment'>-- T(..)</span>
<a name="line-293"></a>    <span class='hs-varid'>explicit_in</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-294"></a>
<a name="line-295"></a>    <span class='hs-varid'>single</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-296"></a>    <span class='hs-varid'>single</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAbs</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-297"></a>    <span class='hs-varid'>single</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}


%*********************************************************
%*                                                       *
\subsection{Unused names}
%*                                                       *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="reportUnusedNames"></a><span class='hs-definition'>reportUnusedNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LIE</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Export list</span>
<a name="line-2"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>reportUnusedNames</span> <span class='hs-sel'>_export_decls</span> <span class='hs-varid'>gbl_env</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"RUN"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedImportDecls</span> <span class='hs-varid'>gbl_env</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedTopBinds</span>   <span class='hs-varid'>unused_locals</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>used_names</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span>
<a name="line-9"></a>    <span class='hs-varid'>used_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findUses</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_dus</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-10"></a>    <span class='hs-comment'>-- NB: currently, if f x = g, we only treat 'g' as used if 'f' is used</span>
<a name="line-11"></a>    <span class='hs-comment'>-- Hence findUses</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-comment'>-- Collect the defined names from the in-scope environment</span>
<a name="line-14"></a>    <span class='hs-varid'>defined_names</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a>    <span class='hs-varid'>defined_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_rdr_env</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a>    <span class='hs-comment'>-- Note that defined_and_used, defined_but_not_used</span>
<a name="line-18"></a>    <span class='hs-comment'>-- are both [GRE]; that's why we need defined_and_used</span>
<a name="line-19"></a>    <span class='hs-comment'>-- rather than just used_names</span>
<a name="line-20"></a>    <span class='hs-sel'>_defined_and_used</span><span class='hs-layout'>,</span> <span class='hs-varid'>defined_but_not_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_defined_and_used</span><span class='hs-layout'>,</span> <span class='hs-varid'>defined_but_not_used</span><span class='hs-layout'>)</span>
<a name="line-22"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_is_used</span> <span class='hs-varid'>used_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>defined_names</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-varid'>kids_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkChildEnv</span> <span class='hs-varid'>defined_names</span>
<a name="line-25"></a>    <span class='hs-comment'>-- This is done in mkExports too; duplicated work</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>gre_is_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-28"></a>    <span class='hs-varid'>gre_is_used</span> <span class='hs-varid'>used_names</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-29"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>used_names</span>
<a name="line-30"></a>          <span class='hs-varop'>||</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>used_names</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>findChildren</span> <span class='hs-varid'>kids_env</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                <span class='hs-comment'>-- A use of C implies a use of T,</span>
<a name="line-32"></a>                <span class='hs-comment'>-- if C was brought into scope by T(..) or T(C)</span>
<a name="line-33"></a>
<a name="line-34"></a>    <span class='hs-comment'>-- Filter out the ones that are</span>
<a name="line-35"></a>    <span class='hs-comment'>--  (a) defined in this module, and</span>
<a name="line-36"></a>    <span class='hs-comment'>--  (b) not defined by a 'deriving' clause</span>
<a name="line-37"></a>    <span class='hs-comment'>-- The latter have an Internal Name, so we can filter them out easily</span>
<a name="line-38"></a>    <span class='hs-varid'>unused_locals</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a>    <span class='hs-varid'>unused_locals</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_unused_local</span> <span class='hs-varid'>defined_but_not_used</span>
<a name="line-40"></a>    <span class='hs-varid'>is_unused_local</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-41"></a>    <span class='hs-varid'>is_unused_local</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLocalGRE</span> <span class='hs-varid'>gre</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span>
</pre>\end{code}

%*********************************************************
%*                                                       *
\subsection{Unused imports}
%*                                                       *
%*********************************************************

This code finds which import declarations are unused.  The
specification and implementation notes are here:
  http://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/UnusedImports

\begin{code}
<pre><a name="line-1"></a><a name="ImportDeclUsage"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ImportDeclUsage</span>
<a name="line-2"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span>   <span class='hs-comment'>-- The import declaration</span>
<a name="line-3"></a>     <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- What *is* used (normalised)</span>
<a name="line-4"></a>     <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>           <span class='hs-comment'>-- What is imported but *not* used</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="warnUnusedImportDecls"></a><span class='hs-definition'>warnUnusedImportDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>warnUnusedImportDecls</span> <span class='hs-varid'>gbl_env</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uses</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_used_rdrnames</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>user_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>ideclImplicit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_rn_imports</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span>
<a name="line-5"></a>                            <span class='hs-comment'>-- This whole function deals only with *user* imports</span>
<a name="line-6"></a>                            <span class='hs-comment'>-- both for warning about unnecessary ones, and for</span>
<a name="line-7"></a>                            <span class='hs-comment'>-- deciding the minimal ones</span>
<a name="line-8"></a>             <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-varid'>gbl_env</span>
<a name="line-9"></a>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>usage</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportDeclUsage</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a>             <span class='hs-varid'>usage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findImportUsage</span> <span class='hs-varid'>user_imports</span> <span class='hs-varid'>rdr_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Uses:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-14"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Import usage"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>usage</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnUnusedImports</span> <span class='hs-varop'>$</span>
<a name="line-16"></a>         <span class='hs-varid'>mapM_</span> <span class='hs-varid'>warnUnusedImport</span> <span class='hs-varid'>usage</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>whenGOptM</span> <span class='hs-conid'>Opt_D_dump_minimal_imports</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>         <span class='hs-varid'>printMinimalImports</span> <span class='hs-varid'>usage</span> <span class='hs-layout'>}</span>
</pre>\end{code}


Note [The ImportMap]
~~~~~~~~~~~~~~~~~~~~
The ImportMap is a short-lived intermediate data struture records, for
each import declaration, what stuff brought into scope by that
declaration is actually used in the module.

The SrcLoc is the location of the END of a particular 'import'
declaration.  Why *END*?  Because we don't want to get confused
by the implicit Prelude import. Consider (Trac #7476) the module
    import Foo( foo )
    main = print foo
There is an implicit 'import Prelude(print)', and it gets a SrcSpan
of line 1:1 (just the point, not a span). If we use the *START* of
the SrcSpan to identify the import decl, we'll confuse the implicit
import Prelude with the explicit 'import Foo'.  So we use the END.
It's just a cheap hack; we could equally well use the Span too.

The AvailInfos are the things imported from that decl (just a list,
not normalised).

\begin{code}
<pre><a name="line-1"></a><a name="ImportMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ImportMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>SrcLoc</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- See [The ImportMap]</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="findImportUsage"></a><span class='hs-definition'>findImportUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-5"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportDeclUsage</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>findImportUsage</span> <span class='hs-varid'>imports</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>rdrs</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>unused_decl</span> <span class='hs-varid'>imports</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>import_usage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportMap</span>
<a name="line-12"></a>    <span class='hs-varid'>import_usage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendImportMap</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-varid'>rdrs</span>
<a name="line-13"></a>
<a name="line-14"></a>    <span class='hs-varid'>unused_decl</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ideclHiding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imps</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>nubAvails</span> <span class='hs-varid'>used_avails</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>unused_imps</span><span class='hs-layout'>)</span>
<a name="line-16"></a>      <span class='hs-keyword'>where</span>
<a name="line-17"></a>        <span class='hs-varid'>used_avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanEnd</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>import_usage</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-18"></a>                      <span class='hs-comment'>-- srcSpanEnd: see Note [The ImportMap]</span>
<a name="line-19"></a>        <span class='hs-varid'>used_names</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>availsToNameSet</span> <span class='hs-varid'>used_avails</span>
<a name="line-20"></a>        <span class='hs-varid'>used_parents</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>used_avails</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-varid'>unused_imps</span>   <span class='hs-comment'>-- Not trivial; see eg Trac #7454</span>
<a name="line-23"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>imps</span> <span class='hs-keyword'>of</span>
<a name="line-24"></a>              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_ies</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_unused</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameSet</span> <span class='hs-varid'>imp_ies</span>
<a name="line-25"></a>              <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyNameSet</span> <span class='hs-comment'>-- No explicit import list =&gt; no unused-name list</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-varid'>add_unused</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-28"></a>        <span class='hs-varid'>add_unused</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>          <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_unused_name</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span>
<a name="line-29"></a>        <span class='hs-varid'>add_unused</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAbs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>     <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_unused_name</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span>
<a name="line-30"></a>        <span class='hs-varid'>add_unused</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>     <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_unused_all</span>  <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span>
<a name="line-31"></a>        <span class='hs-varid'>add_unused</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_unused_with</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>acc</span>
<a name="line-32"></a>        <span class='hs-varid'>add_unused</span> <span class='hs-keyword'>_</span>                  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-33"></a>
<a name="line-34"></a>        <span class='hs-varid'>add_unused_name</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span>
<a name="line-35"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>used_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-36"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`addOneToNameSet`</span> <span class='hs-varid'>n</span>
<a name="line-37"></a>        <span class='hs-varid'>add_unused_all</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span>
<a name="line-38"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>used_names</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-39"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>used_parents</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-40"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`addOneToNameSet`</span> <span class='hs-varid'>n</span>
<a name="line-41"></a>        <span class='hs-varid'>add_unused_with</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>acc</span>
<a name="line-42"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>acc1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_unused_name</span> <span class='hs-varid'>p</span> <span class='hs-varid'>acc1</span>
<a name="line-43"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc1</span>
<a name="line-44"></a>          <span class='hs-keyword'>where</span>
<a name="line-45"></a>            <span class='hs-varid'>acc1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_unused_name</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>ns</span>
<a name="line-46"></a>       <span class='hs-comment'>-- If you use 'signum' from Num, then the user may well have</span>
<a name="line-47"></a>       <span class='hs-comment'>-- imported Num(signum).  We don't want to complain that</span>
<a name="line-48"></a>       <span class='hs-comment'>-- Num is not itself mentioned.  Hence the two cases in add_unused_with.</span>
<a name="line-49"></a>
<a name="line-50"></a>
<a name="line-51"></a><a name="extendImportMap"></a><span class='hs-definition'>extendImportMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportMap</span>
<a name="line-52"></a><span class='hs-comment'>-- For a used RdrName, find all the import decls that brought</span>
<a name="line-53"></a><span class='hs-comment'>-- it into scope; choose one of them (bestImport), and record</span>
<a name="line-54"></a><span class='hs-comment'>-- the RdrName in that import decl's entry in the ImportMap</span>
<a name="line-55"></a><span class='hs-definition'>extendImportMap</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>rdr</span> <span class='hs-varid'>imp_map</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>gre</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGRE_RdrName</span> <span class='hs-varid'>rdr</span> <span class='hs-varid'>rdr_env</span>
<a name="line-57"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Imported</span> <span class='hs-varid'>imps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gre_prov</span> <span class='hs-varid'>gre</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_imp</span> <span class='hs-varid'>gre</span> <span class='hs-layout'>(</span><span class='hs-varid'>bestImport</span> <span class='hs-varid'>imps</span><span class='hs-layout'>)</span> <span class='hs-varid'>imp_map</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_map</span>
<a name="line-61"></a>  <span class='hs-keyword'>where</span>
<a name="line-62"></a>    <span class='hs-varid'>add_imp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportMap</span>
<a name="line-63"></a>    <span class='hs-varid'>add_imp</span> <span class='hs-varid'>gre</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_decl_spec</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>imp_map</span>
<a name="line-64"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insertWith</span> <span class='hs-varid'>add</span> <span class='hs-varid'>decl_loc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>avail</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>imp_map</span>
<a name="line-65"></a>      <span class='hs-keyword'>where</span>
<a name="line-66"></a>        <span class='hs-varid'>add</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>avails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>avail</span> <span class='hs-conop'>:</span> <span class='hs-varid'>avails</span> <span class='hs-comment'>-- add is really just a specialised (++)</span>
<a name="line-67"></a>        <span class='hs-varid'>decl_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcSpanEnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_dloc</span> <span class='hs-varid'>imp_decl_spec</span><span class='hs-layout'>)</span>
<a name="line-68"></a>                   <span class='hs-comment'>-- For srcSpanEnd see Note [The ImportMap]</span>
<a name="line-69"></a>        <span class='hs-varid'>avail</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>greExportAvail</span> <span class='hs-varid'>gre</span>
<a name="line-70"></a>
<a name="line-71"></a>    <span class='hs-varid'>bestImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportSpec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportSpec</span>
<a name="line-72"></a>    <span class='hs-varid'>bestImport</span> <span class='hs-varid'>iss</span>
<a name="line-73"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isImpAll</span> <span class='hs-varid'>iss</span> <span class='hs-keyword'>of</span>
<a name="line-74"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_somes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>textuallyFirst</span> <span class='hs-varid'>imp_somes</span>
<a name="line-75"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>imp_alls</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>textuallyFirst</span> <span class='hs-varid'>imp_alls</span>
<a name="line-76"></a>
<a name="line-77"></a>    <span class='hs-varid'>textuallyFirst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportSpec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportSpec</span>
<a name="line-78"></a>    <span class='hs-varid'>textuallyFirst</span> <span class='hs-varid'>iss</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sortWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_dloc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>is_decl</span><span class='hs-layout'>)</span> <span class='hs-varid'>iss</span> <span class='hs-keyword'>of</span>
<a name="line-79"></a>                           <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"textuallyFirst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>iss</span><span class='hs-layout'>)</span>
<a name="line-80"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>is</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>is</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-varid'>isImpAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-83"></a>    <span class='hs-varid'>isImpAll</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpAll</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-84"></a>    <span class='hs-varid'>isImpAll</span> <span class='hs-sel'>_other</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="warnUnusedImport"></a><span class='hs-definition'>warnUnusedImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportDeclUsage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>warnUnusedImport</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>used</span><span class='hs-layout'>,</span> <span class='hs-varid'>unused</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ideclHiding</span> <span class='hs-varid'>decl</span>
<a name="line-4"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>            <span class='hs-comment'>-- Do not warn for 'import M()'</span>
<a name="line-5"></a>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>hides</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ideclHiding</span> <span class='hs-varid'>decl</span>
<a name="line-7"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>hides</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>pRELUDE_NAME</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ideclName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>            <span class='hs-comment'>-- Note [Do not warn about Prelude hiding]</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>used</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnAt</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>msg1</span>   <span class='hs-comment'>-- Nothing used; drop entire decl</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>unused</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>            <span class='hs-comment'>-- Everything imported is used; nop</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnAt</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>msg2</span>   <span class='hs-comment'>-- Some imports are unused</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-varid'>msg1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pp_herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>pp_mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_not_used</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"except perhaps to import instances from"</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>pp_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-17"></a>                 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To import instances alone, use:"</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"import"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_mod</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>empty</span> <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>    <span class='hs-varid'>msg2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pp_herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unused</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-20"></a>                    <span class='hs-varid'>text</span> <span class='hs-str'>"from module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>pp_mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_not_used</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>    <span class='hs-varid'>pp_herald</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_qual</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"import of"</span>
<a name="line-22"></a>    <span class='hs-varid'>pp_qual</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ideclQualified</span> <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"qualified"</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-25"></a>    <span class='hs-varid'>pp_mod</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ideclName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-varid'>pp_not_used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is redundant"</span>
</pre>\end{code}

Note [Do not warn about Prelude hiding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not warn about
   import Prelude hiding( x, y )
because even if nothing else from Prelude is used, it may be essential to hide
x,y to avoid name-shadowing warnings.  Example (Trac #9061)
   import Prelude hiding( log )
   f x = log where log = ()



Note [Printing minimal imports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To print the minimal imports we walk over the user-supplied import
decls, and simply trim their import lists.  NB that

  * We do *not* change the 'qualified' or 'as' parts!

  * We do not disard a decl altogether; we might need instances
    from it.  Instead we just trim to an empty import list

\begin{code}
<pre><a name="line-1"></a><a name="printMinimalImports"></a><span class='hs-definition'>printMinimalImports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportDeclUsage</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [Printing minimal imports]</span>
<a name="line-3"></a><span class='hs-definition'>printMinimalImports</span> <span class='hs-varid'>imports_w_usage</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imports'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mk_minimal</span> <span class='hs-varid'>imports_w_usage</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openFile</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFilename</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-conid'>WriteMode</span>
<a name="line-9"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>printForUser</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>h</span> <span class='hs-varid'>neverQualify</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>imports'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>              <span class='hs-comment'>-- The neverQualify is important.  We are printing Names</span>
<a name="line-11"></a>              <span class='hs-comment'>-- but they are in the context of an 'import' decl, and</span>
<a name="line-12"></a>              <span class='hs-comment'>-- we never qualify things inside there</span>
<a name="line-13"></a>              <span class='hs-comment'>-- E.g.   import Blag( f, b )</span>
<a name="line-14"></a>              <span class='hs-comment'>-- not    import Blag( Blag.f, Blag.g )!</span>
<a name="line-15"></a>       <span class='hs-layout'>}</span>
<a name="line-16"></a>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-varid'>mkFilename</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span>
<a name="line-18"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dumpDir</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>basefn</span>
<a name="line-19"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>basefn</span>
<a name="line-20"></a>      <span class='hs-keyword'>where</span>
<a name="line-21"></a>        <span class='hs-varid'>basefn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>".imports"</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>mk_minimal</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>used</span><span class='hs-layout'>,</span> <span class='hs-varid'>unused</span><span class='hs-layout'>)</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>unused</span>
<a name="line-25"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ideclHiding</span> <span class='hs-varid'>decl</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-27"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-28"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>ImportDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ideclName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mod_name</span>
<a name="line-29"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>ideclSource</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_boot</span>
<a name="line-30"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>ideclPkgQual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_pkg</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl</span>
<a name="line-31"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadSrcInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>mb_pkg</span>
<a name="line-32"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lies</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_ie</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-varid'>used</span><span class='hs-layout'>)</span>
<a name="line-33"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ideclHiding</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>lies</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>      <span class='hs-keyword'>where</span>
<a name="line-35"></a>        <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Compute minimal imports for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span>
<a name="line-36"></a>
<a name="line-37"></a>    <span class='hs-varid'>to_ie</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-38"></a>    <span class='hs-comment'>-- The main trick here is that if we're importing all the constructors</span>
<a name="line-39"></a>    <span class='hs-comment'>-- we want to say "T(..)", but if we're importing only a subset we want</span>
<a name="line-40"></a>    <span class='hs-comment'>-- to say "T(A,B,C)".  So we have to find out what the module exports.</span>
<a name="line-41"></a>    <span class='hs-varid'>to_ie</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-42"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IEVar</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-43"></a>    <span class='hs-varid'>to_ie</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-44"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IEThingAbs</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>    <span class='hs-varid'>to_ie</span> <span class='hs-varid'>iface</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span>
<a name="line-46"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>x</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mi_exports</span> <span class='hs-varid'>iface</span>
<a name="line-47"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n</span>
<a name="line-48"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>xs</span>    <span class='hs-comment'>-- Note [Partial export]</span>
<a name="line-49"></a>                 <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-50"></a>           <span class='hs-keyglyph'>[</span><span class='hs-varid'>xs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all_used</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-51"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>           <span class='hs-sel'>_other</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>map</span> <span class='hs-conid'>IEVar</span> <span class='hs-varid'>ns</span>
<a name="line-53"></a>        <span class='hs-keyword'>where</span>
<a name="line-54"></a>          <span class='hs-varid'>all_used</span> <span class='hs-varid'>avail_occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-varid'>avail_occs</span>
</pre>\end{code}

Note [Partial export]
~~~~~~~~~~~~~~~~~~~~~
Suppose we have

   module A( op ) where
     class C a where
       op :: a -> a

   module B where
   import A
   f = ..op...

Then the minimal import for module B is
   import A( op )
not
   import A( C( op ) )
which we would usually generate if C was exported from B.  Hence
the (x `elem` xs) test when deciding what to generate.


%************************************************************************
%*                                                                      *
\subsection{Errors}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="qualImportItemErr"></a><span class='hs-definition'>qualImportItemErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>qualImportItemErr</span> <span class='hs-varid'>rdr</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal qualified name in import item:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="badImportItemErrStd"></a><span class='hs-definition'>badImportItemErrStd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-7"></a><span class='hs-definition'>badImportItemErrStd</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-varid'>ie</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Module"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_mod</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>source_import</span><span class='hs-layout'>,</span>
<a name="line-9"></a>         <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not export"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>source_import</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(hi-boot interface)"</span><span class='hs-layout'>)</span>
<a name="line-12"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="badImportItemErrDataCon"></a><span class='hs-definition'>badImportItemErrDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-15"></a><span class='hs-definition'>badImportItemErrDataCon</span> <span class='hs-varid'>dataType</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-varid'>ie</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In module"</span><span class='hs-layout'>)</span>
<a name="line-17"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_mod</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>source_import</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-19"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>datacon</span>
<a name="line-20"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a data constructor of"</span><span class='hs-layout'>)</span>
<a name="line-21"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dataType</span><span class='hs-layout'>)</span>
<a name="line-22"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To import it use"</span><span class='hs-layout'>)</span>
<a name="line-23"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"import"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_mod</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>)</span>
<a name="line-25"></a>             <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens_sp</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dataType</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens_sp</span> <span class='hs-varid'>datacon</span><span class='hs-layout'>)</span>
<a name="line-26"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or"</span><span class='hs-layout'>)</span>
<a name="line-27"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"import"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-28"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_mod</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>)</span>
<a name="line-29"></a>             <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens_sp</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dataType</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(..)"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>         <span class='hs-keyglyph'>]</span>
<a name="line-31"></a>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-varid'>datacon_occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdrNameOcc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ieName</span> <span class='hs-varid'>ie</span>
<a name="line-33"></a>    <span class='hs-varid'>datacon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-varid'>datacon_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>datacon_occ</span><span class='hs-layout'>)</span>
<a name="line-34"></a>    <span class='hs-varid'>source_import</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(hi-boot interface)"</span><span class='hs-layout'>)</span>
<a name="line-35"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-36"></a>    <span class='hs-varid'>parens_sp</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>space</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>space</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- T( f,g )</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="badImportItemErr"></a><span class='hs-definition'>badImportItemErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-39"></a><span class='hs-definition'>badImportItemErr</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>avails</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>find</span> <span class='hs-varid'>checkIfDataCon</span> <span class='hs-varid'>avails</span> <span class='hs-keyword'>of</span>
<a name="line-41"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>badImportItemErrDataCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>availOccName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-varid'>ie</span>
<a name="line-42"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>badImportItemErrStd</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>decl_spec</span> <span class='hs-varid'>ie</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>checkIfDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-45"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>importedFS</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nameOccNameFS</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>of</span>
<a name="line-46"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isDataConName</span> <span class='hs-varid'>n</span>
<a name="line-47"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-48"></a>    <span class='hs-varid'>checkIfDataCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-49"></a>    <span class='hs-varid'>availOccName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>availName</span>
<a name="line-50"></a>    <span class='hs-varid'>nameOccNameFS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameFS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nameOccName</span>
<a name="line-51"></a>    <span class='hs-varid'>importedFS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameFS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rdrNameOcc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ieName</span> <span class='hs-varid'>ie</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="illegalImportItemErr"></a><span class='hs-definition'>illegalImportItemErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-54"></a><span class='hs-definition'>illegalImportItemErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal import item"</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="dodgyImportWarn"></a><span class='hs-definition'>dodgyImportWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-57"></a><span class='hs-definition'>dodgyImportWarn</span> <span class='hs-varid'>item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dodgyMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"import"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>item</span>
<a name="line-58"></a><a name="dodgyExportWarn"></a><span class='hs-definition'>dodgyExportWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-59"></a><span class='hs-definition'>dodgyExportWarn</span> <span class='hs-varid'>item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dodgyMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"export"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>item</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="dodgyMsg"></a><span class='hs-definition'>dodgyMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-62"></a><span class='hs-definition'>dodgyMsg</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>tc</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>kind</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"item"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IEThingAll</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-64"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"suggests that"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-65"></a>          <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has (in-scope) constructors or class methods,"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-66"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but it has none"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="exportItemErr"></a><span class='hs-definition'>exportItemErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-69"></a><span class='hs-definition'>exportItemErr</span> <span class='hs-varid'>export_item</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The export item"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>export_item</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-71"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"attempts to export constructors or class methods that are not visible here"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="exportClashErr"></a><span class='hs-definition'>exportClashErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span>
<a name="line-74"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-75"></a><span class='hs-definition'>exportClashErr</span> <span class='hs-varid'>global_env</span> <span class='hs-varid'>name1</span> <span class='hs-varid'>name2</span> <span class='hs-varid'>ie1</span> <span class='hs-varid'>ie2</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Conflicting exports for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-77"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_export</span> <span class='hs-varid'>ie1'</span> <span class='hs-varid'>name1'</span>
<a name="line-78"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_export</span> <span class='hs-varid'>ie2'</span> <span class='hs-varid'>name2'</span> <span class='hs-keyglyph'>]</span>
<a name="line-79"></a>  <span class='hs-keyword'>where</span>
<a name="line-80"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name1</span>
<a name="line-81"></a>    <span class='hs-varid'>ppr_export</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nest</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"exports"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-82"></a>                                       <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-83"></a>                                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprNameProvenance</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_gre</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a>    <span class='hs-comment'>-- get_gre finds a GRE for the Name, so that we can show its provenance</span>
<a name="line-86"></a>    <span class='hs-varid'>get_gre</span> <span class='hs-varid'>name</span>
<a name="line-87"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupGRE_Name</span> <span class='hs-varid'>global_env</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-88"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>gre</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gre</span>
<a name="line-89"></a>             <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"exportClashErr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-90"></a>    <span class='hs-varid'>get_loc</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>greSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_gre</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-91"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>name1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>name2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>get_loc</span> <span class='hs-varid'>name1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>get_loc</span> <span class='hs-varid'>name2</span>
<a name="line-92"></a>                                   <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>name1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie1</span><span class='hs-layout'>,</span> <span class='hs-varid'>name2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie2</span><span class='hs-layout'>)</span>
<a name="line-93"></a>                                   <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>name2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie2</span><span class='hs-layout'>,</span> <span class='hs-varid'>name1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ie1</span><span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="greSrcSpan"></a><span class='hs-comment'>-- the SrcSpan that pprNameProvenance prints out depends on whether</span>
<a name="line-96"></a><span class='hs-comment'>-- the Name is defined locally or not: for a local definition the</span>
<a name="line-97"></a><span class='hs-comment'>-- definition site is used, otherwise the location of the import</span>
<a name="line-98"></a><span class='hs-comment'>-- declaration.  We want to sort the export locations in</span>
<a name="line-99"></a><span class='hs-comment'>-- exportClashErr by this SrcSpan, we need to extract it:</span>
<a name="line-100"></a><span class='hs-definition'>greSrcSpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-101"></a><span class='hs-definition'>greSrcSpan</span> <span class='hs-varid'>gre</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Imported</span> <span class='hs-layout'>(</span><span class='hs-varid'>is</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gre_prov</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_dloc</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name_span</span>
<a name="line-104"></a>  <span class='hs-keyword'>where</span>
<a name="line-105"></a>    <span class='hs-varid'>name_span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="addDupDeclErr"></a><span class='hs-definition'>addDupDeclErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-108"></a><span class='hs-definition'>addDupDeclErr</span> <span class='hs-conid'>[]</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"addDupDeclErr: empty list"</span>
<a name="line-110"></a><span class='hs-definition'>addDupDeclErr</span> <span class='hs-varid'>names</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>last</span> <span class='hs-varid'>sorted_names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-112"></a>    <span class='hs-comment'>-- Report the error at the later location</span>
<a name="line-113"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Multiple declarations of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-114"></a>             <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-115"></a>             <span class='hs-comment'>-- NB. print the OccName, not the Name, because the</span>
<a name="line-116"></a>             <span class='hs-comment'>-- latter might not be in scope in the RdrEnv and so will</span>
<a name="line-117"></a>             <span class='hs-comment'>-- be printed qualified.</span>
<a name="line-118"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Declared at:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-119"></a>                   <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nameSrcLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sorted_names</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-120"></a>  <span class='hs-keyword'>where</span>
<a name="line-121"></a>    <span class='hs-varid'>sorted_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortWith</span> <span class='hs-varid'>nameSrcLoc</span> <span class='hs-varid'>names</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="dupExportWarn"></a><span class='hs-definition'>dupExportWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-124"></a><span class='hs-definition'>dupExportWarn</span> <span class='hs-varid'>occ_name</span> <span class='hs-varid'>ie1</span> <span class='hs-varid'>ie2</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>occ_name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-126"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is exported by"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ie1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-127"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>            <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ie2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="dupModuleExport"></a><span class='hs-definition'>dupModuleExport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-130"></a><span class='hs-definition'>dupModuleExport</span> <span class='hs-varid'>mod</span>
<a name="line-131"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-132"></a>          <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-133"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in export list"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="moduleNotImported"></a><span class='hs-definition'>moduleNotImported</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-136"></a><span class='hs-definition'>moduleNotImported</span> <span class='hs-varid'>mod</span>
<a name="line-137"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The export item `module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-138"></a>    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"' is not imported"</span><span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a><a name="nullModuleExport"></a><span class='hs-definition'>nullModuleExport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-141"></a><span class='hs-definition'>nullModuleExport</span> <span class='hs-varid'>mod</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The export item `module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"' exports nothing"</span><span class='hs-layout'>)</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="missingImportListWarn"></a><span class='hs-definition'>missingImportListWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-145"></a><span class='hs-definition'>missingImportListWarn</span> <span class='hs-varid'>mod</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not have an explicit import list"</span><span class='hs-layout'>)</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="missingImportListItem"></a><span class='hs-definition'>missingImportListItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-149"></a><span class='hs-definition'>missingImportListItem</span> <span class='hs-varid'>ie</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The import item"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ie</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not have an explicit import list"</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="moduleWarn"></a><span class='hs-definition'>moduleWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WarningTxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-153"></a><span class='hs-definition'>moduleWarn</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>WarningTxt</span> <span class='hs-varid'>txt</span><span class='hs-layout'>)</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>":"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-155"></a>          <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>txt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-156"></a><span class='hs-definition'>moduleWarn</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>DeprecatedTxt</span> <span class='hs-varid'>txt</span><span class='hs-layout'>)</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-158"></a>                                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is deprecated:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-159"></a>          <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>txt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="packageImportErr"></a><span class='hs-definition'>packageImportErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-162"></a><span class='hs-definition'>packageImportErr</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Package-qualified imports are not enabled; use PackageImports"</span><span class='hs-layout'>)</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-comment'>-- This data decl will parse OK</span>
<a name="line-166"></a><span class='hs-comment'>--      data T = a Int</span>
<a name="line-167"></a><span class='hs-comment'>-- treating "a" as the constructor.</span>
<a name="line-168"></a><span class='hs-comment'>-- It is really hard to make the parser spot this malformation.</span>
<a name="line-169"></a><span class='hs-comment'>-- So the renamer has to check that the constructor is legal</span>
<a name="line-170"></a><span class='hs-comment'>--</span>
<a name="line-171"></a><span class='hs-comment'>-- We can get an operator as the constructor, even in the prefix form:</span>
<a name="line-172"></a><span class='hs-comment'>--      data T = :% Int Int</span>
<a name="line-173"></a><span class='hs-comment'>-- from interface files, which always print in prefix form</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="checkConName"></a><span class='hs-definition'>checkConName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-176"></a><span class='hs-definition'>checkConName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRdrDataCon</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badDataCon</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="badDataCon"></a><span class='hs-definition'>badDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-179"></a><span class='hs-definition'>badDataCon</span> <span class='hs-varid'>name</span>
<a name="line-180"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal data constructor name"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}
</body>
</html>
