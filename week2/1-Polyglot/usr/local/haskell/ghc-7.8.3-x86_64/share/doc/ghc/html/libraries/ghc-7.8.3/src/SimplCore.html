<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>simplCore/SimplCore.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[SimplCore]{Driver for simplifying @Core@ programs}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>SimplCore</span> <span class='hs-layout'>(</span> <span class='hs-varid'>core2core</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplifyExpr</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-6"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSubst</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CSE</span>              <span class='hs-layout'>(</span> <span class='hs-varid'>cseProgram</span> <span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Rules</span>            <span class='hs-layout'>(</span> <span class='hs-conid'>RuleBase</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyRuleBase</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRuleBase</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionRuleBase</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                          <span class='hs-varid'>extendRuleBaseList</span><span class='hs-layout'>,</span> <span class='hs-varid'>ruleCheckProgram</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSpecInfo</span><span class='hs-layout'>,</span> <span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>pprCoreBindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoreExpr</span> <span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccurAnal</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>occurAnalysePgm</span><span class='hs-layout'>,</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>coreBindsSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>coreBindsStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprSize</span> <span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Simplify</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>simplTopBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplExpr</span> <span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SimplUtils</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>simplEnvForGHCi</span><span class='hs-layout'>,</span> <span class='hs-varid'>activeRule</span> <span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SimplEnv</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SimplMonad</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreMonad</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>ErrUtils</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Err</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FloatIn</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>floatInwards</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FloatOut</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>floatOutwards</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>CompilerPhase</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDefaultInlinePragma</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LiberateCase</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>liberateCase</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SAT</span>              <span class='hs-layout'>(</span> <span class='hs-varid'>doStaticArgs</span> <span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Specialise</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>specProgram</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SpecConstr</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>specConstrProgram</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DmdAnal</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>dmdAnalProgram</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>WorkWrap</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>wwTopBinds</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Vectorise</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>vectorise</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>UniqSupply</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSplitUniqSupply</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>             <span class='hs-layout'>(</span> <span class='hs-varid'>mkTyConTy</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>mkRdrQual</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>mkVarOcc</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>pluginTyConName</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynamicLoading</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>forceLoadTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupRdrNameInModuleForPlugins</span><span class='hs-layout'>,</span> <span class='hs-varid'>getValueSafely</span> <span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>ModuleName</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-53"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{The driver for the simplifier}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="core2core"></a><span class='hs-definition'>core2core</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModGuts</span>
<a name="line-2"></a><span class='hs-definition'>core2core</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>guts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'s'</span>
<a name="line-4"></a>       <span class='hs-comment'>-- make sure all plugins are loaded</span>
<a name="line-5"></a>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>builtin_passes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCoreToDo</span> <span class='hs-varid'>dflags</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>guts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runCoreM</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hpt_rule_base</span> <span class='hs-varid'>us</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>$</span>
<a name="line-9"></a>                        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>all_passes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addPluginPasses</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>builtin_passes</span>
<a name="line-10"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>runCorePasses</span> <span class='hs-varid'>all_passes</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-comment'>{--
<a name="line-13"></a>       ; Err.dumpIfSet_dyn dflags Opt_D_dump_core_pipeline
<a name="line-14"></a>             "Plugin information" "" -- TODO FIXME: dump plugin info
<a name="line-15"></a>--}</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span>
<a name="line-17"></a>             <span class='hs-str'>"Grand total simplifier statistics"</span>
<a name="line-18"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>guts2</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>dflags</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-23"></a>    <span class='hs-varid'>home_pkg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hptRules</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_deps</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>    <span class='hs-varid'>hpt_rule_base</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRuleBase</span> <span class='hs-varid'>home_pkg_rules</span>
<a name="line-25"></a>    <span class='hs-varid'>mod</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mg_module</span> <span class='hs-varid'>guts</span>
<a name="line-26"></a>    <span class='hs-comment'>-- mod: get the module out of the current HscEnv so we can retrieve it from the monad.</span>
<a name="line-27"></a>    <span class='hs-comment'>-- This is very convienent for the users of the monad (e.g. plugins do not have to</span>
<a name="line-28"></a>    <span class='hs-comment'>-- consume the ModGuts to find the module) but somewhat ugly because mg_module may</span>
<a name="line-29"></a>    <span class='hs-comment'>-- _theoretically_ be changed during the Core pipeline (it's part of ModGuts), which</span>
<a name="line-30"></a>    <span class='hs-comment'>-- would mean our cached value would go out of date.</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
           Generating the main optimisation pipeline
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="getCoreToDo"></a><span class='hs-definition'>getCoreToDo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>getCoreToDo</span> <span class='hs-varid'>dflags</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>core_todo</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>opt_level</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>optLevel</span>           <span class='hs-varid'>dflags</span>
<a name="line-6"></a>    <span class='hs-varid'>phases</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simplPhases</span>        <span class='hs-varid'>dflags</span>
<a name="line-7"></a>    <span class='hs-varid'>max_iter</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maxSimplIterations</span> <span class='hs-varid'>dflags</span>
<a name="line-8"></a>    <span class='hs-varid'>rule_check</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ruleCheck</span>          <span class='hs-varid'>dflags</span>
<a name="line-9"></a>    <span class='hs-varid'>strictness</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Strictness</span>                   <span class='hs-varid'>dflags</span>
<a name="line-10"></a>    <span class='hs-varid'>full_laziness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FullLaziness</span>                 <span class='hs-varid'>dflags</span>
<a name="line-11"></a>    <span class='hs-varid'>do_specialise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Specialise</span>                   <span class='hs-varid'>dflags</span>
<a name="line-12"></a>    <span class='hs-varid'>do_float_in</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FloatIn</span>                      <span class='hs-varid'>dflags</span>
<a name="line-13"></a>    <span class='hs-varid'>cse</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_CSE</span>                          <span class='hs-varid'>dflags</span>
<a name="line-14"></a>    <span class='hs-varid'>spec_constr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SpecConstr</span>                   <span class='hs-varid'>dflags</span>
<a name="line-15"></a>    <span class='hs-varid'>liberate_case</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_LiberateCase</span>                 <span class='hs-varid'>dflags</span>
<a name="line-16"></a>    <span class='hs-varid'>late_dmd_anal</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_LateDmdAnal</span>                  <span class='hs-varid'>dflags</span>
<a name="line-17"></a>    <span class='hs-varid'>static_args</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_StaticArgumentTransformation</span> <span class='hs-varid'>dflags</span>
<a name="line-18"></a>    <span class='hs-varid'>rules_on</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_EnableRewriteRules</span>           <span class='hs-varid'>dflags</span>
<a name="line-19"></a>    <span class='hs-varid'>eta_expand_on</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DoLambdaEtaExpansion</span>         <span class='hs-varid'>dflags</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-varid'>maybe_rule_check</span> <span class='hs-varid'>phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMaybe</span> <span class='hs-varid'>rule_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoRuleCheck</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>maybe_strictness_before</span> <span class='hs-varid'>phase</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>phase</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>strictnessBefore</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-conid'>CoreDoStrictness</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>base_mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SimplMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"base_mode"</span>
<a name="line-27"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-28"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_rules</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules_on</span>
<a name="line-29"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_eta_expand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eta_expand_on</span>
<a name="line-30"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_inline</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-31"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sm_case_case</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-varid'>simpl_phase</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>names</span> <span class='hs-varid'>iter</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoPasses</span>
<a name="line-35"></a>      <span class='hs-varop'>$</span>   <span class='hs-keyglyph'>[</span> <span class='hs-varid'>maybe_strictness_before</span> <span class='hs-varid'>phase</span>
<a name="line-36"></a>          <span class='hs-layout'>,</span> <span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>iter</span>
<a name="line-37"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>base_mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Phase</span> <span class='hs-varid'>phase</span>
<a name="line-38"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>names</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>maybe_rule_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>Phase</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-41"></a>
<a name="line-42"></a>          <span class='hs-comment'>-- Vectorisation can introduce a fair few common sub expressions involving</span>
<a name="line-43"></a>          <span class='hs-comment'>--  DPH primitives. For example, see the Reverse test from dph-examples.</span>
<a name="line-44"></a>          <span class='hs-comment'>--  We need to eliminate these common sub expressions before their definitions</span>
<a name="line-45"></a>          <span class='hs-comment'>--  are inlined in phase 2. The CSE introduces lots of  v1 = v2 bindings,</span>
<a name="line-46"></a>          <span class='hs-comment'>--  so we also run simpl_gently to inline them.</span>
<a name="line-47"></a>      <span class='hs-varop'>++</span>  <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Vectorise</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>phase</span> <span class='hs-varop'>==</span> <span class='hs-num'>3</span>
<a name="line-48"></a>            <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreCSE</span><span class='hs-layout'>,</span> <span class='hs-varid'>simpl_gently</span><span class='hs-keyglyph'>]</span>
<a name="line-49"></a>            <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>vectorisation</span>
<a name="line-52"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Vectorise</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-53"></a>          <span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>simpl_gently</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreDoVectorisation</span> <span class='hs-keyglyph'>]</span>
<a name="line-54"></a>
<a name="line-55"></a>                <span class='hs-comment'>-- By default, we have 2 phases before phase 0.</span>
<a name="line-56"></a>
<a name="line-57"></a>                <span class='hs-comment'>-- Want to run with inline phase 2 after the specialiser to give</span>
<a name="line-58"></a>                <span class='hs-comment'>-- maximum chance for fusion to work before we inline build/augment</span>
<a name="line-59"></a>                <span class='hs-comment'>-- in phase 1.  This made a difference in 'ansi' where an</span>
<a name="line-60"></a>                <span class='hs-comment'>-- overloaded function wasn't inlined till too late.</span>
<a name="line-61"></a>
<a name="line-62"></a>                <span class='hs-comment'>-- Need phase 1 so that build/augment get</span>
<a name="line-63"></a>                <span class='hs-comment'>-- inlined.  I found that spectral/hartel/genfft lost some useful</span>
<a name="line-64"></a>                <span class='hs-comment'>-- strictness in the function sumcode' if augment is not inlined</span>
<a name="line-65"></a>                <span class='hs-comment'>-- before strictness analysis runs</span>
<a name="line-66"></a>    <span class='hs-varid'>simpl_phases</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>simpl_phase</span> <span class='hs-varid'>phase</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"main"</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>max_iter</span>
<a name="line-67"></a>                                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>phase</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>phases</span><span class='hs-layout'>,</span> <span class='hs-varid'>phases</span><span class='hs-comment'>-</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-num'>1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-68"></a>
<a name="line-69"></a>
<a name="line-70"></a>        <span class='hs-comment'>-- initial simplify: mk specialiser happy: minimum effort please</span>
<a name="line-71"></a>    <span class='hs-varid'>simpl_gently</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>max_iter</span>
<a name="line-72"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>base_mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InitialPhase</span>
<a name="line-73"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"Gentle"</span><span class='hs-keyglyph'>]</span>
<a name="line-74"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules_on</span>   <span class='hs-comment'>-- Note [RULEs enabled in SimplGently]</span>
<a name="line-75"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-76"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>sm_case_case</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-77"></a>                          <span class='hs-comment'>-- Don't do case-of-case transformations.</span>
<a name="line-78"></a>                          <span class='hs-comment'>-- This makes full laziness work better</span>
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-comment'>-- New demand analyser</span>
<a name="line-81"></a>    <span class='hs-varid'>demand_analyser</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span>
<a name="line-82"></a>                           <span class='hs-conid'>CoreDoStrictness</span><span class='hs-layout'>,</span>
<a name="line-83"></a>                           <span class='hs-conid'>CoreDoWorkerWrapper</span><span class='hs-layout'>,</span>
<a name="line-84"></a>                           <span class='hs-varid'>simpl_phase</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"post-worker-wrapper"</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>max_iter</span>
<a name="line-85"></a>                           <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-varid'>core_todo</span> <span class='hs-keyglyph'>=</span>
<a name="line-88"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_level</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span>
<a name="line-89"></a>       <span class='hs-keyglyph'>[</span> <span class='hs-varid'>vectorisation</span>
<a name="line-90"></a>       <span class='hs-layout'>,</span> <span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>max_iter</span>
<a name="line-91"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>base_mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Phase</span> <span class='hs-num'>0</span>
<a name="line-92"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"Non-opt simplification"</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-93"></a>       <span class='hs-keyglyph'>]</span>
<a name="line-94"></a>
<a name="line-95"></a>     <span class='hs-keyword'>else</span> <span class='hs-comment'>{- opt_level &gt;= 1 -}</span> <span class='hs-keyglyph'>[</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class='hs-comment'>-- We want to do the static argument transform before full laziness as it</span>
<a name="line-98"></a>    <span class='hs-comment'>-- may expose extra opportunities to float things outwards. However, to fix</span>
<a name="line-99"></a>    <span class='hs-comment'>-- up the output of the transformation we need at do at least one simplify</span>
<a name="line-100"></a>    <span class='hs-comment'>-- after this before anything else</span>
<a name="line-101"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>static_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>simpl_gently</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreDoStaticArgs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-102"></a>
<a name="line-103"></a>        <span class='hs-comment'>-- We run vectorisation here for now, but we might also try to run</span>
<a name="line-104"></a>        <span class='hs-comment'>-- it later</span>
<a name="line-105"></a>        <span class='hs-varid'>vectorisation</span><span class='hs-layout'>,</span>
<a name="line-106"></a>
<a name="line-107"></a>        <span class='hs-comment'>-- initial simplify: mk specialiser happy: minimum effort please</span>
<a name="line-108"></a>        <span class='hs-varid'>simpl_gently</span><span class='hs-layout'>,</span>
<a name="line-109"></a>
<a name="line-110"></a>        <span class='hs-comment'>-- Specialisation is best done before full laziness</span>
<a name="line-111"></a>        <span class='hs-comment'>-- so that overloaded functions have all their dictionary lambdas manifest</span>
<a name="line-112"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>do_specialise</span> <span class='hs-conid'>CoreDoSpecialising</span><span class='hs-layout'>,</span>
<a name="line-113"></a>
<a name="line-114"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>full_laziness</span> <span class='hs-varop'>$</span>
<a name="line-115"></a>           <span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-layout'>{</span>
<a name="line-116"></a>                                 <span class='hs-varid'>floatOutLambdas</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span>
<a name="line-117"></a>                                 <span class='hs-varid'>floatOutConstants</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span>
<a name="line-118"></a>                                 <span class='hs-varid'>floatOutPartialApplications</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-119"></a>                <span class='hs-comment'>-- Was: gentleFloatOutSwitches</span>
<a name="line-120"></a>                <span class='hs-comment'>--</span>
<a name="line-121"></a>                <span class='hs-comment'>-- I have no idea why, but not floating constants to</span>
<a name="line-122"></a>                <span class='hs-comment'>-- top level is very bad in some cases.</span>
<a name="line-123"></a>                <span class='hs-comment'>--</span>
<a name="line-124"></a>                <span class='hs-comment'>-- Notably: p_ident in spectral/rewrite</span>
<a name="line-125"></a>                <span class='hs-comment'>--          Changing from "gentle" to "constantsOnly"</span>
<a name="line-126"></a>                <span class='hs-comment'>--          improved rewrite's allocation by 19%, and</span>
<a name="line-127"></a>                <span class='hs-comment'>--          made 0.0% difference to any other nofib</span>
<a name="line-128"></a>                <span class='hs-comment'>--          benchmark</span>
<a name="line-129"></a>                <span class='hs-comment'>--</span>
<a name="line-130"></a>                <span class='hs-comment'>-- Not doing floatOutPartialApplications yet, we'll do</span>
<a name="line-131"></a>                <span class='hs-comment'>-- that later on when we've had a chance to get more</span>
<a name="line-132"></a>                <span class='hs-comment'>-- accurate arity information.  In fact it makes no</span>
<a name="line-133"></a>                <span class='hs-comment'>-- difference at all to performance if we do it here,</span>
<a name="line-134"></a>                <span class='hs-comment'>-- but maybe we save some unnecessary to-and-fro in</span>
<a name="line-135"></a>                <span class='hs-comment'>-- the simplifier.</span>
<a name="line-136"></a>
<a name="line-137"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>do_float_in</span> <span class='hs-conid'>CoreDoFloatInwards</span><span class='hs-layout'>,</span>
<a name="line-138"></a>
<a name="line-139"></a>        <span class='hs-varid'>simpl_phases</span><span class='hs-layout'>,</span>
<a name="line-140"></a>
<a name="line-141"></a>                <span class='hs-comment'>-- Phase 0: allow all Ids to be inlined now</span>
<a name="line-142"></a>                <span class='hs-comment'>-- This gets foldr inlined before strictness analysis</span>
<a name="line-143"></a>
<a name="line-144"></a>                <span class='hs-comment'>-- At least 3 iterations because otherwise we land up with</span>
<a name="line-145"></a>                <span class='hs-comment'>-- huge dead expressions because of an infelicity in the</span>
<a name="line-146"></a>                <span class='hs-comment'>-- simpifier.</span>
<a name="line-147"></a>                <span class='hs-comment'>--      let k = BIG in foldr k z xs</span>
<a name="line-148"></a>                <span class='hs-comment'>-- ==&gt;  let k = BIG in letrec go = \xs -&gt; ...(k x).... in go xs</span>
<a name="line-149"></a>                <span class='hs-comment'>-- ==&gt;  let k = BIG in letrec go = \xs -&gt; ...(BIG x).... in go xs</span>
<a name="line-150"></a>                <span class='hs-comment'>-- Don't stop now!</span>
<a name="line-151"></a>        <span class='hs-varid'>simpl_phase</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"main"</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>max_iter</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-152"></a>
<a name="line-153"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>strictness</span> <span class='hs-varid'>demand_analyser</span><span class='hs-layout'>,</span>
<a name="line-154"></a>
<a name="line-155"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>full_laziness</span> <span class='hs-varop'>$</span>
<a name="line-156"></a>           <span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-layout'>{</span>
<a name="line-157"></a>                                 <span class='hs-varid'>floatOutLambdas</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatLamArgs</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>,</span>
<a name="line-158"></a>                                 <span class='hs-varid'>floatOutConstants</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span>
<a name="line-159"></a>                                 <span class='hs-varid'>floatOutPartialApplications</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-160"></a>                <span class='hs-comment'>-- nofib/spectral/hartel/wang doubles in speed if you</span>
<a name="line-161"></a>                <span class='hs-comment'>-- do full laziness late in the day.  It only happens</span>
<a name="line-162"></a>                <span class='hs-comment'>-- after fusion and other stuff, so the early pass doesn't</span>
<a name="line-163"></a>                <span class='hs-comment'>-- catch it.  For the record, the redex is</span>
<a name="line-164"></a>                <span class='hs-comment'>--        f_el22 (f_el21 r_midblock)</span>
<a name="line-165"></a>
<a name="line-166"></a>
<a name="line-167"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>cse</span> <span class='hs-conid'>CoreCSE</span><span class='hs-layout'>,</span>
<a name="line-168"></a>                <span class='hs-comment'>-- We want CSE to follow the final full-laziness pass, because it may</span>
<a name="line-169"></a>                <span class='hs-comment'>-- succeed in commoning up things floated out by full laziness.</span>
<a name="line-170"></a>                <span class='hs-comment'>-- CSE used to rely on the no-shadowing invariant, but it doesn't any more</span>
<a name="line-171"></a>
<a name="line-172"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>do_float_in</span> <span class='hs-conid'>CoreDoFloatInwards</span><span class='hs-layout'>,</span>
<a name="line-173"></a>
<a name="line-174"></a>        <span class='hs-varid'>maybe_rule_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>Phase</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-175"></a>
<a name="line-176"></a>                <span class='hs-comment'>-- Case-liberation for -O2.  This should be after</span>
<a name="line-177"></a>                <span class='hs-comment'>-- strictness analysis and the simplification which follows it.</span>
<a name="line-178"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>liberate_case</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span>
<a name="line-179"></a>            <span class='hs-conid'>CoreLiberateCase</span><span class='hs-layout'>,</span>
<a name="line-180"></a>            <span class='hs-varid'>simpl_phase</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"post-liberate-case"</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>max_iter</span>
<a name="line-181"></a>            <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Run the simplifier after LiberateCase to vastly</span>
<a name="line-182"></a>                        <span class='hs-comment'>-- reduce the possiblility of shadowing</span>
<a name="line-183"></a>                        <span class='hs-comment'>-- Reason: see Note [Shadowing] in SpecConstr.lhs</span>
<a name="line-184"></a>
<a name="line-185"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>spec_constr</span> <span class='hs-conid'>CoreDoSpecConstr</span><span class='hs-layout'>,</span>
<a name="line-186"></a>
<a name="line-187"></a>        <span class='hs-varid'>maybe_rule_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>Phase</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-188"></a>
<a name="line-189"></a>        <span class='hs-comment'>-- Final clean-up simplification:</span>
<a name="line-190"></a>        <span class='hs-varid'>simpl_phase</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"final"</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>max_iter</span><span class='hs-layout'>,</span>
<a name="line-191"></a>
<a name="line-192"></a>        <span class='hs-varid'>runWhen</span> <span class='hs-varid'>late_dmd_anal</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span>
<a name="line-193"></a>            <span class='hs-conid'>CoreDoStrictness</span><span class='hs-layout'>,</span>
<a name="line-194"></a>            <span class='hs-conid'>CoreDoWorkerWrapper</span><span class='hs-layout'>,</span>
<a name="line-195"></a>            <span class='hs-varid'>simpl_phase</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"post-late-ww"</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>max_iter</span>
<a name="line-196"></a>          <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-197"></a>
<a name="line-198"></a>        <span class='hs-varid'>maybe_rule_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>Phase</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-199"></a>     <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Loading plugins

\begin{code}
<pre><a name="line-1"></a><a name="addPluginPasses"></a><span class='hs-definition'>addPluginPasses</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-cpp'>#ifndef GHCI</span>
<a name="line-3"></a><span class='hs-definition'>addPluginPasses</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>builtin_passes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>builtin_passes</span>
<a name="line-4"></a><span class='hs-cpp'>#else</span>
<a name="line-5"></a><span class='hs-definition'>addPluginPasses</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>builtin_passes</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>named_plugins</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadPlugins</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>query_plug</span> <span class='hs-varid'>builtin_passes</span> <span class='hs-varid'>named_plugins</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>query_plug</span> <span class='hs-varid'>todos</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>plug</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installCoreToDos</span> <span class='hs-varid'>plug</span> <span class='hs-varid'>options</span> <span class='hs-varid'>todos</span>
<a name="line-12"></a>       <span class='hs-keyword'>where</span>
<a name="line-13"></a>         <span class='hs-varid'>options</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>option</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_mod_nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>option</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pluginModNameOpts</span> <span class='hs-varid'>dflags</span>
<a name="line-14"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>opt_mod_nm</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mod_nm</span> <span class='hs-keyglyph'>]</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="loadPlugins"></a><span class='hs-definition'>loadPlugins</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Plugin</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a><span class='hs-definition'>loadPlugins</span> <span class='hs-varid'>hsc_env</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>to_load</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pluginModNames</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>plugins</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadPlugin</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>to_load</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>to_load</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>plugins</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="loadPlugin"></a><span class='hs-definition'>loadPlugin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Plugin</span>
<a name="line-23"></a><span class='hs-definition'>loadPlugin</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_name</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>plugin_rdr_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRdrQual</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOcc</span> <span class='hs-str'>"plugin"</span><span class='hs-layout'>)</span>
<a name="line-25"></a>             <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupRdrNameInModuleForPlugins</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>plugin_rdr_name</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-28"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-29"></a>                <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdLineError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span>
<a name="line-30"></a>                          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The module"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod_name</span>
<a name="line-31"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"did not export the plugin name"</span><span class='hs-layout'>)</span>
<a name="line-32"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>plugin_rdr_name</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-33"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-34"></a>
<a name="line-35"></a>     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>plugin_tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forceLoadTyCon</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pluginTyConName</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mb_plugin</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getValueSafely</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>plugin_tycon</span><span class='hs-layout'>)</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_plugin</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-39"></a>                <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdLineError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span>
<a name="line-40"></a>                          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The value"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-41"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"did not have the type"</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pluginTyConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"as required"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-43"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>plugin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>plugin</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-44"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                  The CoreToDo interpreter
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="runCorePasses"></a><span class='hs-definition'>runCorePasses</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-2"></a><span class='hs-definition'>runCorePasses</span> <span class='hs-varid'>passes</span> <span class='hs-varid'>guts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-varid'>passes</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-conid'>CoreDoNothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>guts</span>
<a name="line-6"></a>    <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runCorePasses</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>guts</span>
<a name="line-7"></a>    <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-varid'>pass</span>
<a name="line-8"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-9"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-10"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pass</span>
<a name="line-11"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>guts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doCorePass</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>guts</span>
<a name="line-12"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>endPass</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pass</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_rules</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span>
<a name="line-13"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>guts'</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="doCorePass"></a><span class='hs-definition'>doCorePass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-16"></a><span class='hs-definition'>doCorePass</span> <span class='hs-varid'>pass</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoreDoSimplify</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Simplify" #-}</span>
<a name="line-17"></a>                                       <span class='hs-varid'>simplifyPgm</span> <span class='hs-varid'>pass</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreCSE</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "CommonSubExpr" #-}</span>
<a name="line-20"></a>                                       <span class='hs-varid'>doPass</span> <span class='hs-varid'>cseProgram</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreLiberateCase</span>          <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "LiberateCase" #-}</span>
<a name="line-23"></a>                                       <span class='hs-varid'>doPassD</span> <span class='hs-varid'>liberateCase</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoFloatInwards</span>        <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "FloatInwards" #-}</span>
<a name="line-26"></a>                                       <span class='hs-varid'>doPassD</span> <span class='hs-varid'>floatInwards</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>doCorePass</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "FloatOutwards" #-}</span>
<a name="line-29"></a>                                       <span class='hs-varid'>doPassDUM</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatOutwards</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoStaticArgs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "StaticArgs" #-}</span>
<a name="line-32"></a>                                       <span class='hs-varid'>doPassU</span> <span class='hs-varid'>doStaticArgs</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoStrictness</span>          <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "NewStranal" #-}</span>
<a name="line-35"></a>                                       <span class='hs-varid'>doPassDFM</span> <span class='hs-varid'>dmdAnalProgram</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoWorkerWrapper</span>       <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "WorkWrap" #-}</span>
<a name="line-38"></a>                                       <span class='hs-varid'>doPassDFU</span> <span class='hs-varid'>wwTopBinds</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoSpecialising</span>        <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Specialise" #-}</span>
<a name="line-41"></a>                                       <span class='hs-varid'>specProgram</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoSpecConstr</span>          <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "SpecConstr" #-}</span>
<a name="line-44"></a>                                       <span class='hs-varid'>specConstrProgram</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoVectorisation</span>       <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Vectorise" #-}</span>
<a name="line-47"></a>                                       <span class='hs-varid'>vectorise</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoPrintCore</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>observe</span>   <span class='hs-varid'>printCore</span>
<a name="line-50"></a><span class='hs-definition'>doCorePass</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoRuleCheck</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ruleCheckPass</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>pat</span>
<a name="line-51"></a><span class='hs-definition'>doCorePass</span> <span class='hs-conid'>CoreDoNothing</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-52"></a><span class='hs-definition'>doCorePass</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-varid'>passes</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runCorePasses</span> <span class='hs-varid'>passes</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-55"></a><span class='hs-definition'>doCorePass</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPluginPass</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Plugin" #-}</span> <span class='hs-varid'>pass</span>
<a name="line-56"></a><span class='hs-cpp'>#endif</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>doCorePass</span> <span class='hs-varid'>pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"doCorePass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Core pass combinators}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="printCore"></a><span class='hs-definition'>printCore</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>printCore</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>binds</span>
<a name="line-3"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>True</span> <span class='hs-str'>"Print Core"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCoreBindings</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="ruleCheckPass"></a><span class='hs-definition'>ruleCheckPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CompilerPhase</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-6"></a><span class='hs-definition'>ruleCheckPass</span> <span class='hs-varid'>current_phase</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-7"></a>    <span class='hs-varid'>rb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuleBase</span>
<a name="line-8"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-9"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"RuleCheck"</span>
<a name="line-10"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-conid'>SevDump</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultDumpStyle</span>
<a name="line-11"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ruleCheckProgram</span> <span class='hs-varid'>current_phase</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rb</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>guts</span>
<a name="line-13"></a>
<a name="line-14"></a>
<a name="line-15"></a><a name="doPassDUM"></a><span class='hs-definition'>doPassDUM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-16"></a><span class='hs-definition'>doPassDUM</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>binds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-17"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-18"></a>    <span class='hs-varid'>us</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-19"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span> <span class='hs-varid'>binds</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="doPassDM"></a><span class='hs-definition'>doPassDM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-22"></a><span class='hs-definition'>doPassDM</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDUM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="doPassD"></a><span class='hs-definition'>doPassD</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-25"></a><span class='hs-definition'>doPassD</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="doPassDU"></a><span class='hs-definition'>doPassDU</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-28"></a><span class='hs-definition'>doPassDU</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDUM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="doPassU"></a><span class='hs-definition'>doPassU</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-31"></a><span class='hs-definition'>doPassU</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassDU</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>do_pass</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="doPassDFM"></a><span class='hs-definition'>doPassDFM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-34"></a><span class='hs-definition'>doPassDFM</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-35"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-36"></a>    <span class='hs-varid'>p_fam_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPackageFamInstEnv</span>
<a name="line-37"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>p_fam_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-varid'>doPassM</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="doPassDFU"></a><span class='hs-definition'>doPassDFU</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-41"></a><span class='hs-definition'>doPassDFU</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-42"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-43"></a>    <span class='hs-varid'>us</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-44"></a>    <span class='hs-varid'>p_fam_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPackageFamInstEnv</span>
<a name="line-45"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>p_fam_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-46"></a>    <span class='hs-varid'>doPass</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-varid'>guts</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="doPassM"></a><span class='hs-comment'>-- Most passes return no stats and don't change rules: these combinators</span>
<a name="line-49"></a><span class='hs-comment'>-- let us lift them to the full blown ModGuts+CoreM world</span>
<a name="line-50"></a><span class='hs-definition'>doPassM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>ModGuts</span>
<a name="line-51"></a><span class='hs-definition'>doPassM</span> <span class='hs-varid'>bind_f</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-52"></a>    <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bind_f</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-53"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="doPass"></a><span class='hs-definition'>doPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-56"></a><span class='hs-definition'>doPass</span> <span class='hs-varid'>bind_f</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_f</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="observe"></a><span class='hs-comment'>-- Observer passes just peek; don't modify the bindings at all</span>
<a name="line-59"></a><span class='hs-definition'>observe</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-60"></a><span class='hs-definition'>observe</span> <span class='hs-varid'>do_pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doPassM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>binds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-61"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-62"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>do_pass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>binds</span>
<a name="line-63"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>binds</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Gentle simplification
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="simplifyExpr"></a><span class='hs-definition'>simplifyExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-comment'>-- includes spec of what core-to-core passes to do</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-3"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-4"></a><span class='hs-comment'>-- simplifyExpr is called by the driver to simplify an</span>
<a name="line-5"></a><span class='hs-comment'>-- expression typed in at the interactive prompt</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-- Also used by Template Haskell</span>
<a name="line-8"></a><span class='hs-definition'>simplifyExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>expr</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Simplify"</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span>  <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'s'</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprSize</span> <span class='hs-varid'>expr</span>
<a name="line-15"></a>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>counts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initSmpl</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>emptyRuleBase</span> <span class='hs-varid'>emptyFamInstEnvs</span> <span class='hs-varid'>us</span> <span class='hs-varid'>sz</span> <span class='hs-varop'>$</span>
<a name="line-17"></a>                                 <span class='hs-varid'>simplExprGently</span> <span class='hs-layout'>(</span><span class='hs-varid'>simplEnvForGHCi</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                  <span class='hs-str'>"Simplifier statistics"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>counts</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_simpl</span> <span class='hs-str'>"Simplified expression"</span>
<a name="line-23"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>pprCoreExpr</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>expr'</span>
<a name="line-26"></a>        <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="simplExprGently"></a><span class='hs-definition'>simplExprGently</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-29"></a><span class='hs-comment'>-- Simplifies an expression</span>
<a name="line-30"></a><span class='hs-comment'>--      does occurrence analysis, then simplification</span>
<a name="line-31"></a><span class='hs-comment'>--      and repeats (twice currently) because one pass</span>
<a name="line-32"></a><span class='hs-comment'>--      alone leaves tons of crud.</span>
<a name="line-33"></a><span class='hs-comment'>-- Used (a) for user expressions typed in at the interactive prompt</span>
<a name="line-34"></a><span class='hs-comment'>--      (b) the LHS and RHS of a RULE</span>
<a name="line-35"></a><span class='hs-comment'>--      (c) Template Haskell splices</span>
<a name="line-36"></a><span class='hs-comment'>--</span>
<a name="line-37"></a><span class='hs-comment'>-- The name 'Gently' suggests that the SimplifierMode is SimplGently,</span>
<a name="line-38"></a><span class='hs-comment'>-- and in fact that is so.... but the 'Gently' in simplExprGently doesn't</span>
<a name="line-39"></a><span class='hs-comment'>-- enforce that; it just simplifies the expression twice</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-comment'>-- It's important that simplExprGently does eta reduction; see</span>
<a name="line-42"></a><span class='hs-comment'>-- Note [Simplifying the left-hand side of a RULE] above.  The</span>
<a name="line-43"></a><span class='hs-comment'>-- simplifier does indeed do eta reduction (it's in Simplify.completeLam)</span>
<a name="line-44"></a><span class='hs-comment'>-- but only if -O is on.</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>simplExprGently</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-47"></a>    <span class='hs-varid'>expr1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-48"></a>    <span class='hs-varid'>simplExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr1</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{The driver for the simplifier}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="simplifyPgm"></a><span class='hs-definition'>simplifyPgm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-2"></a><span class='hs-definition'>simplifyPgm</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>guts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRuleBase</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>liftIOWithCount</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>         <span class='hs-varid'>simplifyPgmIO</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>us</span> <span class='hs-varid'>rb</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="simplifyPgmIO"></a><span class='hs-definition'>simplifyPgmIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span>
<a name="line-10"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span>
<a name="line-11"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-12"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleBase</span>
<a name="line-13"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span>
<a name="line-14"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModGuts</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- New bindings</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>simplifyPgmIO</span> <span class='hs-varid'>pass</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>max_iterations</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span>
<a name="line-17"></a>              <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>us</span> <span class='hs-varid'>hpt_rule_base</span>
<a name="line-18"></a>              <span class='hs-varid'>guts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ModGuts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span>
<a name="line-19"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span>
<a name="line-20"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_inst_env</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>termination_msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>it_count</span><span class='hs-layout'>,</span> <span class='hs-varid'>counts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span>
<a name="line-22"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_iteration</span> <span class='hs-varid'>us</span> <span class='hs-num'>1</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>dump_phase</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                  <span class='hs-str'>"Simplifier statistics for following pass"</span>
<a name="line-26"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-varid'>termination_msg</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"after"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>it_count</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"iterations"</span><span class='hs-layout'>,</span>
<a name="line-27"></a>                         <span class='hs-varid'>blankLine</span><span class='hs-layout'>,</span>
<a name="line-28"></a>                         <span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>counts_out</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>counts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>guts'</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-layout'>}</span>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>dflags</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-34"></a>    <span class='hs-varid'>dump_phase</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dumpSimplPhase</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mode</span>
<a name="line-35"></a>    <span class='hs-varid'>simpl_env</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSimplEnv</span> <span class='hs-varid'>mode</span>
<a name="line-36"></a>    <span class='hs-varid'>active_rule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>activeRule</span> <span class='hs-varid'>simpl_env</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-varid'>do_iteration</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-39"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>          <span class='hs-comment'>-- Counts iterations</span>
<a name="line-40"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SimplCount</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Counts from earlier iterations, reversed</span>
<a name="line-41"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>  <span class='hs-comment'>-- Bindings in</span>
<a name="line-42"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- and orphan rules</span>
<a name="line-43"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>SimplCount</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModGuts</span><span class='hs-layout'>)</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-varid'>do_iteration</span> <span class='hs-varid'>us</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varid'>counts_so_far</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-46"></a>        <span class='hs-comment'>-- iteration_no is the number of the iteration we are</span>
<a name="line-47"></a>        <span class='hs-comment'>-- about to begin, with '1' for the first</span>
<a name="line-48"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>max_iterations</span>   <span class='hs-comment'>-- Stop if we've run out of iterations</span>
<a name="line-49"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>max_iterations</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-50"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Simplifier bailing out after"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>max_iterations</span>
<a name="line-51"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"iterations"</span><span class='hs-layout'>)</span>
<a name="line-52"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span>
<a name="line-53"></a>                         <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varop'>.</span> <span class='hs-varid'>simplCountN</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>counts_so_far</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Size ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreBindsStats</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a>                <span class='hs-comment'>-- Subtract 1 from iteration_no to get the</span>
<a name="line-57"></a>                <span class='hs-comment'>-- number of iterations we actually completed</span>
<a name="line-58"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-str'>"Simplifier baled out"</span><span class='hs-layout'>,</span> <span class='hs-varid'>iteration_no</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-59"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>totalise</span> <span class='hs-varid'>counts_so_far</span>
<a name="line-60"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a>      <span class='hs-comment'>-- Try and force thunks off the binds; significantly reduces</span>
<a name="line-63"></a>      <span class='hs-comment'>-- space usage, especially with -O.  JRS, 000620.</span>
<a name="line-64"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreBindsSize</span> <span class='hs-varid'>binds</span>
<a name="line-65"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>sz</span> <span class='hs-varop'>==</span> <span class='hs-varid'>sz</span>     <span class='hs-comment'>-- Force it</span>
<a name="line-66"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-67"></a>                <span class='hs-comment'>-- Occurrence analysis</span>
<a name="line-68"></a>           <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Note [Vectorisation declarations and occurrences]</span>
<a name="line-69"></a>                   <span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-70"></a>                   <span class='hs-comment'>-- During the 'InitialPhase' (i.e., before vectorisation), we need to make sure</span>
<a name="line-71"></a>                   <span class='hs-comment'>-- that the right-hand sides of vectorisation declarations are taken into</span>
<a name="line-72"></a>                   <span class='hs-comment'>-- account during occurrence analysis. After the 'InitialPhase', we need to ensure</span>
<a name="line-73"></a>                   <span class='hs-comment'>-- that the binders representing variable vectorisation declarations are kept alive.</span>
<a name="line-74"></a>                   <span class='hs-comment'>-- (In contrast to automatically vectorised variables, their unvectorised versions</span>
<a name="line-75"></a>                   <span class='hs-comment'>-- don't depend on them.)</span>
<a name="line-76"></a>                 <span class='hs-varid'>vectVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varop'>$</span>
<a name="line-77"></a>                              <span class='hs-varid'>catMaybes</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectInfoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_vect_info</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr</span>
<a name="line-78"></a>                                        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Vect</span> <span class='hs-varid'>bndr</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mg_vect_decls</span> <span class='hs-varid'>guts</span><span class='hs-keyglyph'>]</span>
<a name="line-79"></a>                              <span class='hs-varop'>++</span>
<a name="line-80"></a>                              <span class='hs-varid'>catMaybes</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectInfoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_vect_info</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr</span>
<a name="line-81"></a>                                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>]</span>
<a name="line-82"></a>                                        <span class='hs-comment'>-- FIXME: This second comprehensions is only needed as long as we</span>
<a name="line-83"></a>                                        <span class='hs-comment'>--        have vectorised bindings where we get "Could NOT call</span>
<a name="line-84"></a>                                        <span class='hs-comment'>--        vectorised from original version".</span>
<a name="line-85"></a>              <span class='hs-layout'>;</span>  <span class='hs-layout'>(</span><span class='hs-varid'>maybeVects</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeVectVars</span><span class='hs-layout'>)</span>
<a name="line-86"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sm_phase</span> <span class='hs-varid'>mode</span> <span class='hs-keyword'>of</span>
<a name="line-87"></a>                       <span class='hs-conid'>InitialPhase</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_vect_decls</span> <span class='hs-varid'>guts</span><span class='hs-layout'>,</span> <span class='hs-varid'>vectVars</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                       <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>vectVars</span><span class='hs-layout'>)</span>
<a name="line-89"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>tagged_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "OccAnal" #-}</span>
<a name="line-90"></a>                     <span class='hs-varid'>occurAnalysePgm</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>active_rule</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>maybeVects</span> <span class='hs-varid'>maybeVectVars</span> <span class='hs-varid'>binds</span>
<a name="line-91"></a>               <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-92"></a>           <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_occur_anal</span> <span class='hs-str'>"Occurrence analysis"</span>
<a name="line-93"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>pprCoreBindings</span> <span class='hs-varid'>tagged_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-94"></a>
<a name="line-95"></a>                <span class='hs-comment'>-- Get any new rules, and extend the rule base</span>
<a name="line-96"></a>                <span class='hs-comment'>-- See Note [Overall plumbing for rules] in Rules.lhs</span>
<a name="line-97"></a>                <span class='hs-comment'>-- We need to do this regularly, because simplification can</span>
<a name="line-98"></a>                <span class='hs-comment'>-- poke on IdInfo thunks, which in turn brings in new rules</span>
<a name="line-99"></a>                <span class='hs-comment'>-- behind the scenes.  Otherwise there's a danger we'll simply</span>
<a name="line-100"></a>                <span class='hs-comment'>-- miss the rules for Ids hidden inside imported inlinings</span>
<a name="line-101"></a>           <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>;</span>
<a name="line-102"></a>           <span class='hs-keyword'>let</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>rule_base1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionRuleBase</span> <span class='hs-varid'>hpt_rule_base</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_rule_base</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span>
<a name="line-103"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>rule_base2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendRuleBaseList</span> <span class='hs-varid'>rule_base1</span> <span class='hs-varid'>rules</span>
<a name="line-104"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>simpl_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "SimplTopBinds" #-}</span>
<a name="line-105"></a>                                <span class='hs-varid'>simplTopBinds</span> <span class='hs-varid'>simpl_env</span> <span class='hs-varid'>tagged_binds</span>
<a name="line-106"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_inst_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-107"></a>
<a name="line-108"></a>                <span class='hs-comment'>-- Simplify the program</span>
<a name="line-109"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>counts1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initSmpl</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rule_base2</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>us1</span> <span class='hs-varid'>sz</span> <span class='hs-varid'>simpl_binds</span> <span class='hs-layout'>;</span>
<a name="line-110"></a>
<a name="line-111"></a>           <span class='hs-keyword'>let</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>binds1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getFloatBinds</span> <span class='hs-varid'>env1</span>
<a name="line-112"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>rules1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substRulesForImportedIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoreSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"imp-rules"</span><span class='hs-layout'>)</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>rules</span>
<a name="line-113"></a>                <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-114"></a>
<a name="line-115"></a>                <span class='hs-comment'>-- Stop if nothing happened; don't dump output</span>
<a name="line-116"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>isZeroSimplCount</span> <span class='hs-varid'>counts1</span> <span class='hs-keyword'>then</span>
<a name="line-117"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-str'>"Simplifier reached fixed point"</span><span class='hs-layout'>,</span> <span class='hs-varid'>iteration_no</span>
<a name="line-118"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>totalise</span> <span class='hs-layout'>(</span><span class='hs-varid'>counts1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>counts_so_far</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Include "free" ticks</span>
<a name="line-119"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules1</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-120"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-121"></a>                <span class='hs-comment'>-- Short out indirections</span>
<a name="line-122"></a>                <span class='hs-comment'>-- We do this *after* at least one run of the simplifier</span>
<a name="line-123"></a>                <span class='hs-comment'>-- because indirection-shorting uses the export flag on *occurrences*</span>
<a name="line-124"></a>                <span class='hs-comment'>-- and that isn't guaranteed to be ok until after the first run propagates</span>
<a name="line-125"></a>                <span class='hs-comment'>-- stuff from the binding site to its occurrences</span>
<a name="line-126"></a>                <span class='hs-comment'>--</span>
<a name="line-127"></a>                <span class='hs-comment'>-- ToDo: alas, this means that indirection-shorting does not happen at all</span>
<a name="line-128"></a>                <span class='hs-comment'>--       if the simplifier does nothing (not common, I know, but unsavoury)</span>
<a name="line-129"></a>           <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds2</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "ZapInd" #-}</span> <span class='hs-varid'>shortOutIndirections</span> <span class='hs-varid'>binds1</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-130"></a>
<a name="line-131"></a>                <span class='hs-comment'>-- Dump the result of this iteration</span>
<a name="line-132"></a>           <span class='hs-varid'>dump_end_iteration</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varid'>counts1</span> <span class='hs-varid'>binds2</span> <span class='hs-varid'>rules1</span> <span class='hs-layout'>;</span>
<a name="line-133"></a>           <span class='hs-varid'>lintPassResult</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>binds2</span> <span class='hs-layout'>;</span>
<a name="line-134"></a>
<a name="line-135"></a>                <span class='hs-comment'>-- Loop</span>
<a name="line-136"></a>           <span class='hs-varid'>do_iteration</span> <span class='hs-varid'>us2</span> <span class='hs-layout'>(</span><span class='hs-varid'>iteration_no</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>counts1</span><span class='hs-conop'>:</span><span class='hs-varid'>counts_so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds2</span> <span class='hs-varid'>rules1</span>
<a name="line-137"></a>           <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-138"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"do_iteration"</span>
<a name="line-139"></a>      <span class='hs-keyword'>where</span>
<a name="line-140"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-141"></a>
<a name="line-142"></a>        <span class='hs-comment'>-- Remember the counts_so_far are reversed</span>
<a name="line-143"></a>        <span class='hs-varid'>totalise</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SimplCount</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span>
<a name="line-144"></a>        <span class='hs-varid'>totalise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`plusSimplCount`</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-145"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>zeroSimplCount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-definition'>simplifyPgmIO</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"simplifyPgmIO"</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="dump_end_iteration"></a><span class='hs-comment'>-------------------</span>
<a name="line-150"></a><span class='hs-definition'>dump_end_iteration</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-151"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-152"></a><span class='hs-definition'>dump_end_iteration</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>iteration_no</span> <span class='hs-varid'>counts</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dumpPassResult</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mb_flag</span> <span class='hs-varid'>hdr</span> <span class='hs-varid'>pp_counts</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-154"></a>  <span class='hs-keyword'>where</span>
<a name="line-155"></a>    <span class='hs-varid'>mb_flag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl_iterations</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_simpl_phases</span>
<a name="line-156"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-157"></a>            <span class='hs-comment'>-- Show details if Opt_D_dump_simpl_iterations is on</span>
<a name="line-158"></a>
<a name="line-159"></a>    <span class='hs-varid'>hdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Simplifier iteration="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>iteration_no</span>
<a name="line-160"></a>    <span class='hs-varid'>pp_counts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"---- Simplifier counts for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hdr</span>
<a name="line-161"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>pprSimplCount</span> <span class='hs-varid'>counts</span>
<a name="line-162"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"---- End of simplifier counts for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hdr</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Shorting out indirections
%*                                                                      *
%************************************************************************

If we have this:

        x_local = <expression>
        ...bindings...
        x_exported = x_local

where x_exported is exported, and x_local is not, then we replace it with this:

        x_exported = <expression>
        x_local = x_exported
        ...bindings...

Without this we never get rid of the x_exported = x_local thing.  This
save a gratuitous jump (from \tr{x_exported} to \tr{x_local}), and
makes strictness information propagate better.  This used to happen in
the final phase, but it's tidier to do it here.

Note [Transferring IdInfo]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to propagage any useful IdInfo on x_local to x_exported.

STRICTNESS: if we have done strictness analysis, we want the strictness info on
x_local to transfer to x_exported.  Hence the copyIdInfo call.

RULES: we want to *add* any RULES for x_local to x_exported.


Note [Messing up the exported Id's RULES]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must be careful about discarding (obviously) or even merging the
RULES on the exported Id. The example that went bad on me at one stage
was this one:

    iterate :: (a -> a) -> a -> [a]
        [Exported]
    iterate = iterateList

    iterateFB c f x = x `c` iterateFB c f (f x)
    iterateList f x =  x : iterateList f (f x)
        [Not exported]

    {-# RULES
    "iterate"   forall f x.     iterate f x = build (\c _n -> iterateFB c f x)
    "iterateFB"                 iterateFB (:) = iterateList
     #-}

This got shorted out to:

    iterateList :: (a -> a) -> a -> [a]
    iterateList = iterate

    iterateFB c f x = x `c` iterateFB c f (f x)
    iterate f x =  x : iterate f (f x)

    {-# RULES
    "iterate"   forall f x.     iterate f x = build (\c _n -> iterateFB c f x)
    "iterateFB"                 iterateFB (:) = iterate
     #-}

And now we get an infinite loop in the rule system
        iterate f x -> build (\cn -> iterateFB c f x)
                    -> iterateFB (:) f x
                    -> iterate f x

Old "solution":
        use rule switching-off pragmas to get rid
        of iterateList in the first place

But in principle the user *might* want rules that only apply to the Id
he says.  And inline pragmas are similar
   {-# NOINLINE f #-}
   f = local
   local = <stuff>
Then we do not want to get rid of the NOINLINE.

Hence hasShortableIdinfo.


Note [Rules and indirection-zapping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Problem: what if x_exported has a RULE that mentions something in ...bindings...?
Then the things mentioned can be out of scope!  Solution
 a) Make sure that in this pass the usage-info from x_exported is
        available for ...bindings...
 b) If there are any such RULES, rec-ify the entire top-level.
    It'll get sorted out next time round

Other remarks
~~~~~~~~~~~~~
If more than one exported thing is equal to a local thing (i.e., the
local thing really is shared), then we do one only:
\begin{verbatim}
        x_local = ....
        x_exported1 = x_local
        x_exported2 = x_local
==>
        x_exported1 = ....

        x_exported2 = x_exported1
\end{verbatim}

We rely on prior eta reduction to simplify things like
\begin{verbatim}
        x_exported = /\ tyvars -> x_local tyvars
==>
        x_exported = x_local
\end{verbatim}
Hence,there's a possibility of leaving unchanged something like this:
\begin{verbatim}
        x_local = ....
        x_exported1 = x_local Int
\end{verbatim}
By the time we've thrown away the types in STG land this
could be eliminated.  But I don't think it's very common
and it's dangerous to do this fiddling in STG land
because we might elminate a binding that's mentioned in the
unfolding for something.

\begin{code}
<pre><a name="line-1"></a><a name="IndEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Maps local_id -&gt; exported_id</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="shortOutIndirections"></a><span class='hs-definition'>shortOutIndirections</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-4"></a><span class='hs-definition'>shortOutIndirections</span> <span class='hs-varid'>binds</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>ind_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_need_to_flatten</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span>                      <span class='hs-comment'>-- See Note [Rules and indirect-zapping]</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- for this no_need_to_flatten stuff</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>ind_env</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeIndEnv</span> <span class='hs-varid'>binds</span>
<a name="line-10"></a>    <span class='hs-varid'>exp_ids</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>ind_env</span>    <span class='hs-comment'>-- These exported Ids are the subjects</span>
<a name="line-11"></a>    <span class='hs-varid'>exp_id_set</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>exp_ids</span>       <span class='hs-comment'>-- of the indirection-elimination</span>
<a name="line-12"></a>    <span class='hs-varid'>no_need_to_flatten</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>specInfoRules</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idSpecialisation</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_ids</span>
<a name="line-13"></a>    <span class='hs-varid'>binds'</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>zap</span> <span class='hs-varid'>binds</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-varid'>zap</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zapPair</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>    <span class='hs-varid'>zap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>zapPair</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>zapPair</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-19"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>exp_id_set</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-20"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>exp_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>ind_env</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>transferIdInfo</span> <span class='hs-varid'>exp_id</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-21"></a>                                                      <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>exp_id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="makeIndEnv"></a><span class='hs-definition'>makeIndEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span>
<a name="line-25"></a><span class='hs-definition'>makeIndEnv</span> <span class='hs-varid'>binds</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_bind</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>binds</span>
<a name="line-27"></a>  <span class='hs-keyword'>where</span>
<a name="line-28"></a>    <span class='hs-varid'>add_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span>
<a name="line-29"></a>    <span class='hs-varid'>add_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>exported_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-30"></a>    <span class='hs-varid'>add_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>              <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_pair</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pairs</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-varid'>add_pair</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IndEnv</span>
<a name="line-33"></a>    <span class='hs-varid'>add_pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>exported_id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>local_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-34"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>shortMeOut</span> <span class='hs-varid'>env</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>local_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>local_id</span> <span class='hs-varid'>exported_id</span>
<a name="line-35"></a>    <span class='hs-varid'>add_pair</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="shortMeOut"></a><span class='hs-comment'>-----------------</span>
<a name="line-38"></a><span class='hs-definition'>shortMeOut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IndEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-39"></a><span class='hs-definition'>shortMeOut</span> <span class='hs-varid'>ind_env</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>local_id</span>
<a name="line-40"></a><span class='hs-comment'>-- The if-then-else stuff is just so I can get a pprTrace to see</span>
<a name="line-41"></a><span class='hs-comment'>-- how often I don't get shorting out because of IdInfo stuff</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>exported_id</span> <span class='hs-varop'>&amp;&amp;</span>              <span class='hs-comment'>-- Only if this is exported</span>
<a name="line-43"></a>
<a name="line-44"></a>       <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>local_id</span> <span class='hs-varop'>&amp;&amp;</span>                    <span class='hs-comment'>-- Only if this one is defined in this</span>
<a name="line-45"></a>                                                <span class='hs-comment'>--      module, so that we *can* change its</span>
<a name="line-46"></a>                                                <span class='hs-comment'>--      binding to be the exported thing!</span>
<a name="line-47"></a>
<a name="line-48"></a>       <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isExportedId</span> <span class='hs-varid'>local_id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>           <span class='hs-comment'>-- Only if this one is not itself exported,</span>
<a name="line-49"></a>                                                <span class='hs-comment'>--      since the transformation will nuke it</span>
<a name="line-50"></a>
<a name="line-51"></a>       <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_id</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>ind_env</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Only if not already substituted for</span>
<a name="line-52"></a>    <span class='hs-keyword'>then</span>
<a name="line-53"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>hasShortableIdInfo</span> <span class='hs-varid'>exported_id</span>
<a name="line-54"></a>        <span class='hs-keyword'>then</span> <span class='hs-conid'>True</span>       <span class='hs-comment'>-- See Note [Messing up the exported Id's IdInfo]</span>
<a name="line-55"></a>        <span class='hs-keyword'>else</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Not shorting out:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exported_id</span> <span class='hs-layout'>)</span>
<a name="line-56"></a>             <span class='hs-conid'>False</span>
<a name="line-57"></a>    <span class='hs-keyword'>else</span>
<a name="line-58"></a>        <span class='hs-conid'>False</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="hasShortableIdInfo"></a><span class='hs-comment'>-----------------</span>
<a name="line-61"></a><span class='hs-definition'>hasShortableIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-62"></a><span class='hs-comment'>-- True if there is no user-attached IdInfo on exported_id,</span>
<a name="line-63"></a><span class='hs-comment'>-- so we can safely discard it</span>
<a name="line-64"></a><span class='hs-comment'>-- See Note [Messing up the exported Id's IdInfo]</span>
<a name="line-65"></a><span class='hs-definition'>hasShortableIdInfo</span> <span class='hs-varid'>id</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isEmptySpecInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>specInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-67"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isDefaultInlinePragma</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStableUnfolding</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-keyword'>where</span>
<a name="line-70"></a>     <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="transferIdInfo"></a><span class='hs-comment'>-----------------</span>
<a name="line-73"></a><span class='hs-definition'>transferIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-74"></a><span class='hs-comment'>-- See Note [Transferring IdInfo]</span>
<a name="line-75"></a><span class='hs-comment'>-- If we have</span>
<a name="line-76"></a><span class='hs-comment'>--      lcl_id = e; exp_id = lcl_id</span>
<a name="line-77"></a><span class='hs-comment'>-- and lcl_id has useful IdInfo, we don't want to discard it by going</span>
<a name="line-78"></a><span class='hs-comment'>--      gbl_id = e; lcl_id = gbl_id</span>
<a name="line-79"></a><span class='hs-comment'>-- Instead, transfer IdInfo from lcl_id to exp_id</span>
<a name="line-80"></a><span class='hs-comment'>-- Overwriting, rather than merging, seems to work ok.</span>
<a name="line-81"></a><span class='hs-definition'>transferIdInfo</span> <span class='hs-varid'>exported_id</span> <span class='hs-varid'>local_id</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyIdInfo</span> <span class='hs-varid'>transfer</span> <span class='hs-varid'>exported_id</span>
<a name="line-83"></a>  <span class='hs-keyword'>where</span>
<a name="line-84"></a>    <span class='hs-varid'>local_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>local_id</span>
<a name="line-85"></a>    <span class='hs-varid'>transfer</span> <span class='hs-varid'>exp_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_info</span> <span class='hs-varop'>`setStrictnessInfo`</span>    <span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>local_info</span>
<a name="line-86"></a>                                 <span class='hs-varop'>`setUnfoldingInfo`</span>     <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>local_info</span>
<a name="line-87"></a>                                 <span class='hs-varop'>`setInlinePragInfo`</span>    <span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>local_info</span>
<a name="line-88"></a>                                 <span class='hs-varop'>`setSpecInfo`</span>          <span class='hs-varid'>addSpecInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>specInfo</span> <span class='hs-varid'>exp_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_info</span>
<a name="line-89"></a>    <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSpecInfoHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>exported_id</span><span class='hs-layout'>)</span>
<a name="line-90"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>specInfo</span> <span class='hs-varid'>local_info</span><span class='hs-layout'>)</span>
<a name="line-91"></a>        <span class='hs-comment'>-- Remember to set the function-name field of the</span>
<a name="line-92"></a>        <span class='hs-comment'>-- rules as we transfer them from one function to another</span>
</pre>\end{code}
</body>
</html>
