<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcRnTypes.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>

% (c) The University of Glasgow 2006-2012
% (c) The GRASP Project, Glasgow University, 1992-2002
%

Various types used during typechecking, please see TcRnMonad as well for
operations on these types. You probably want to import it, instead of this
module.

All the monads exported here are built on top of the same IOEnv monad. The
monad functions like a Reader monad in the way it passes the environment
around. This is done to allow the environment to be manipulated in a stack
like fashion when entering expressions... ect.

For state that is global and should be returned at the end (e.g not part
of the stack mechanism), you should use an TcRef (= IORef) to store them.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcRnTypes</span><span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-conid'>TcRnIf</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcM</span><span class='hs-layout'>,</span> <span class='hs-conid'>RnM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfL</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The monad is opaque outside this module</span>
<a name="line-3"></a>        <span class='hs-conid'>TcRef</span><span class='hs-layout'>,</span>
<a name="line-4"></a>
<a name="line-5"></a>        <span class='hs-comment'>-- The environment types</span>
<a name="line-6"></a>        <span class='hs-conid'>Env</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-conid'>IfGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-comment'>-- Ranamer types</span>
<a name="line-11"></a>        <span class='hs-conid'>ErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyImportAvails</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusImportAvails</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-conid'>WhereFrom</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkModDeps</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-comment'>-- Typechecker types</span>
<a name="line-16"></a>        <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PromotionErr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>pprTcTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPECategory</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-comment'>-- Template Haskell</span>
<a name="line-20"></a>        <span class='hs-conid'>ThStage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PendingStuff</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-conid'>ThLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>thLevel</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- Arrows</span>
<a name="line-24"></a>        <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>(</span><span class='hs-conid'>NoArrowCtxt</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>newArrowScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>escapeArrowScope</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- Canonical constraints</span>
<a name="line-27"></a>        <span class='hs-conid'>Xi</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>andCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>andManyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropDerivedWC</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>singleCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>listToCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctsElts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCtsList</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>isEmptyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCTyEqCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCFunEqCan</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>isCDictCan_Maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCFunEqCan_maybe</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>isCIrredEvCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCNonCanonical</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerivedCt</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>isGivenCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isHoleCt</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>ctEvidence</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>mkNonCanonical</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNonCanonicalCt</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>ctEvPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvId</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvCheckDepth</span><span class='hs-layout'>,</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>insolubleWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWC</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>andWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionsWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>addFlats</span><span class='hs-layout'>,</span> <span class='hs-varid'>addImplics</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFlatWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInsols</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-conid'>Implication</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-conid'>SubGoalCounter</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-conid'>SubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>initialSubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxSubGoalDepth</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>bumpSubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>subGoalCounterValue</span><span class='hs-layout'>,</span> <span class='hs-varid'>subGoalDepthExceeded</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-conid'>CtLoc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocOrigin</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>ctLocDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpCtLocDepth</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>setCtLocOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCtLocEnv</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>pushErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pushErrCtxtSameOrigin</span><span class='hs-layout'>,</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-51"></a>
<a name="line-52"></a>        <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>mkGivenLoc</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>isWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGiven</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerived</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>canRewrite</span><span class='hs-layout'>,</span> <span class='hs-varid'>canRewriteOrSame</span><span class='hs-layout'>,</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-comment'>-- Pretty printing</span>
<a name="line-58"></a>        <span class='hs-varid'>pprEvVarTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprWantedsWithLocs</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>pprEvVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprEvVarWithType</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>pprArising</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprArisingAt</span><span class='hs-layout'>,</span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-comment'>-- Misc other types</span>
<a name="line-63"></a>        <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVarBind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVarBinds</span>
<a name="line-64"></a>
<a name="line-65"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Class</span> <span class='hs-layout'>)</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>ConLike</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConUserType</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-layout'>)</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>   <span class='hs-layout'>(</span> <span class='hs-conid'>PatSyn</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynType</span> <span class='hs-layout'>)</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IOEnv</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dynamic</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Dynamic</span> <span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TypeRep</span> <span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-111"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
               Standard monad definition for TcRn
    All the combinators for the monad can be found in TcRnMonad
%*                                                                      *
%************************************************************************

The monad itself has to be defined here, because it is mentioned by ErrCtxt

\begin{code}
<pre><a name="line-1"></a><a name="TcRef"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IORef</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><a name="TcId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcId</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span>
<a name="line-3"></a><a name="TcIdSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcIdSet</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdSet</span>
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a><a name="TcRnIf"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IOEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-7"></a><a name="IfM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-varid'>lcl</span>         <span class='hs-comment'>-- Iface stuff</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="IfG"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfG</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>()</span>                          <span class='hs-comment'>-- Top level</span>
<a name="line-10"></a><a name="IfL"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfL</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>IfLclEnv</span>                    <span class='hs-comment'>-- Nested</span>
<a name="line-11"></a><a name="TcRn"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRn</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-12"></a><a name="RnM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RnM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>            <span class='hs-comment'>-- Historical</span>
<a name="line-13"></a><a name="TcM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>            <span class='hs-comment'>-- Historical</span>
</pre>\end{code}

Representation of type bindings to uninstantiated meta variables used during
constraint solving.

\begin{code}
<pre><a name="line-1"></a><a name="TcTyVarBind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyVarBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyVarBind</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-conid'>TcType</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="TcTyVarBinds"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTyVarBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>TcTyVarBind</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyVarBind</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVarBind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                The main environment types
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Env"></a><span class='hs-comment'>-- We 'stack' these envs through the Reader like monad infastructure</span>
<a name="line-2"></a><a name="Env"></a><span class='hs-comment'>-- as we move into an expression (although the change is focused in</span>
<a name="line-3"></a><a name="Env"></a><span class='hs-comment'>-- the lcl type).</span>
<a name="line-4"></a><a name="Env"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Env</span> <span class='hs-layout'>{</span>
<a name="line-6"></a>        <span class='hs-varid'>env_top</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Top-level stuff that never changes</span>
<a name="line-7"></a>                             <span class='hs-comment'>-- Includes all info about imported things</span>
<a name="line-8"></a>
<a name="line-9"></a>        <span class='hs-varid'>env_us</span>   <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>UniqSupply</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                             <span class='hs-comment'>-- Unique supply for local varibles</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-varid'>env_gbl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>gbl</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Info about things defined at the top level</span>
<a name="line-13"></a>                             <span class='hs-comment'>-- of the module being compiled</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-varid'>env_lcl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>lcl</span>      <span class='hs-comment'>-- Nested stuff; changes as we go into</span>
<a name="line-16"></a>    <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsDynFlags</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>extractDynFlags</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-20"></a>    <span class='hs-varid'>replaceDynFlags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dflags</span>
<a name="line-21"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span><span class='hs-varid'>env_top</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replaceDynFlags</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-varid'>gbl</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-24"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_gbl</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-comment'>-- TcGblEnv describes the top-level of the module at the</span>
<a name="line-27"></a><span class='hs-comment'>-- point at which the typechecker is finished work.</span>
<a name="line-28"></a><span class='hs-comment'>-- It is this structure that is handed on to the desugarer</span>
<a name="line-29"></a><span class='hs-comment'>-- For state that needs to be updated during the typechecking</span>
<a name="line-30"></a><span class='hs-comment'>-- phase and returned at end, use a TcRef (= IORef).</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="TcGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-34"></a>        <span class='hs-varid'>tcg_mod</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ Module being compiled</span>
<a name="line-35"></a>        <span class='hs-varid'>tcg_src</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscSource</span><span class='hs-layout'>,</span>
<a name="line-36"></a>          <span class='hs-comment'>-- ^ What kind of module (regular Haskell, hs-boot, ext-core)</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Top level envt; used during renaming</span>
<a name="line-39"></a>        <span class='hs-varid'>tcg_default</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-40"></a>          <span class='hs-comment'>-- ^ Types used for defaulting. @Nothing@ =&gt; no @default@ decl</span>
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-varid'>tcg_fix_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-43"></a>        <span class='hs-varid'>tcg_field_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-44"></a>                                        <span class='hs-comment'>-- See Note [The interactive package] in HscTypes</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-varid'>tcg_type_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-47"></a>          <span class='hs-comment'>-- ^ Global type env for the module we are compiling now.  All</span>
<a name="line-48"></a>          <span class='hs-comment'>-- TyCons and Classes (for this module) end up in here right away,</span>
<a name="line-49"></a>          <span class='hs-comment'>-- along with their derived constructors, selectors.</span>
<a name="line-50"></a>          <span class='hs-comment'>--</span>
<a name="line-51"></a>          <span class='hs-comment'>-- (Ids defined in this module start in the local envt, though they</span>
<a name="line-52"></a>          <span class='hs-comment'>--  move to the global envt during zonking)</span>
<a name="line-53"></a>          <span class='hs-comment'>--</span>
<a name="line-54"></a>          <span class='hs-comment'>-- NB: for what "things in this module" means, see</span>
<a name="line-55"></a>          <span class='hs-comment'>-- Note [The interactive package] in HscTypes</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-varid'>tcg_type_env_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-58"></a>                <span class='hs-comment'>-- Used only to initialise the interface-file</span>
<a name="line-59"></a>                <span class='hs-comment'>-- typechecker in initIfaceTcRn, so that it can see stuff</span>
<a name="line-60"></a>                <span class='hs-comment'>-- bound in this module when dealing with hi-boot recursions</span>
<a name="line-61"></a>                <span class='hs-comment'>-- Updated at intervals (e.g. after dealing with types and classes)</span>
<a name="line-62"></a>
<a name="line-63"></a>        <span class='hs-varid'>tcg_inst_env</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span>
<a name="line-64"></a>          <span class='hs-comment'>-- ^ Instance envt for all /home-package/ modules;</span>
<a name="line-65"></a>          <span class='hs-comment'>-- Includes the dfuns in tcg_insts</span>
<a name="line-66"></a>        <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Ditto for family instances</span>
<a name="line-67"></a>        <span class='hs-varid'>tcg_ann_env</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnnEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ And for annotations</span>
<a name="line-68"></a>
<a name="line-69"></a>                <span class='hs-comment'>-- Now a bunch of things about this module that are simply</span>
<a name="line-70"></a>                <span class='hs-comment'>-- accumulated, but never consulted until the end.</span>
<a name="line-71"></a>                <span class='hs-comment'>-- Nevertheless, it's convenient to accumulate them along</span>
<a name="line-72"></a>                <span class='hs-comment'>-- with the rest of the info from this module.</span>
<a name="line-73"></a>        <span class='hs-varid'>tcg_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ What is exported</span>
<a name="line-74"></a>        <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span>
<a name="line-75"></a>          <span class='hs-comment'>-- ^ Information about what was imported from where, including</span>
<a name="line-76"></a>          <span class='hs-comment'>-- things bound in this module. Also store Safe Haskell info</span>
<a name="line-77"></a>          <span class='hs-comment'>-- here about transative trusted packaage requirements.</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-varid'>tcg_dus</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ What is defined in this module and what is used.</span>
<a name="line-80"></a>        <span class='hs-varid'>tcg_used_rdrnames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-81"></a>          <span class='hs-comment'>-- See Note [Tracking unused binding and imports]</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-varid'>tcg_keep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-84"></a>          <span class='hs-comment'>-- ^ Locally-defined top-level names to keep alive.</span>
<a name="line-85"></a>          <span class='hs-comment'>--</span>
<a name="line-86"></a>          <span class='hs-comment'>-- "Keep alive" means give them an Exported flag, so that the</span>
<a name="line-87"></a>          <span class='hs-comment'>-- simplifier does not discard them as dead code, and so that they</span>
<a name="line-88"></a>          <span class='hs-comment'>-- are exposed in the interface file (but not to export to the</span>
<a name="line-89"></a>          <span class='hs-comment'>-- user).</span>
<a name="line-90"></a>          <span class='hs-comment'>--</span>
<a name="line-91"></a>          <span class='hs-comment'>-- Some things, like dict-fun Ids and default-method Ids are "born"</span>
<a name="line-92"></a>          <span class='hs-comment'>-- with the Exported flag on, for exactly the above reason, but some</span>
<a name="line-93"></a>          <span class='hs-comment'>-- we only discover as we go.  Specifically:</span>
<a name="line-94"></a>          <span class='hs-comment'>--</span>
<a name="line-95"></a>          <span class='hs-comment'>--   * The to/from functions for generic data types</span>
<a name="line-96"></a>          <span class='hs-comment'>--</span>
<a name="line-97"></a>          <span class='hs-comment'>--   * Top-level variables appearing free in the RHS of an orphan</span>
<a name="line-98"></a>          <span class='hs-comment'>--     rule</span>
<a name="line-99"></a>          <span class='hs-comment'>--</span>
<a name="line-100"></a>          <span class='hs-comment'>--   * Top-level variables appearing free in a TH bracket</span>
<a name="line-101"></a>
<a name="line-102"></a>        <span class='hs-varid'>tcg_th_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-103"></a>          <span class='hs-comment'>-- ^ @True@ &lt;=&gt; Template Haskell syntax used.</span>
<a name="line-104"></a>          <span class='hs-comment'>--</span>
<a name="line-105"></a>          <span class='hs-comment'>-- We need this so that we can generate a dependency on the</span>
<a name="line-106"></a>          <span class='hs-comment'>-- Template Haskell package, because the desugarer is going</span>
<a name="line-107"></a>          <span class='hs-comment'>-- to emit loads of references to TH symbols.  The reference</span>
<a name="line-108"></a>          <span class='hs-comment'>-- is implicit rather than explicit, so we have to zap a</span>
<a name="line-109"></a>          <span class='hs-comment'>-- mutable variable.</span>
<a name="line-110"></a>
<a name="line-111"></a>        <span class='hs-varid'>tcg_th_splice_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-112"></a>          <span class='hs-comment'>-- ^ @True@ &lt;=&gt; A Template Haskell splice was used.</span>
<a name="line-113"></a>          <span class='hs-comment'>--</span>
<a name="line-114"></a>          <span class='hs-comment'>-- Splices disable recompilation avoidance (see #481)</span>
<a name="line-115"></a>
<a name="line-116"></a>        <span class='hs-varid'>tcg_dfun_n</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>OccSet</span><span class='hs-layout'>,</span>
<a name="line-117"></a>          <span class='hs-comment'>-- ^ Allows us to choose unique DFun names.</span>
<a name="line-118"></a>
<a name="line-119"></a>        <span class='hs-comment'>-- The next fields accumulate the payload of the module</span>
<a name="line-120"></a>        <span class='hs-comment'>-- The binds, rules and foreign-decl fiels are collected</span>
<a name="line-121"></a>        <span class='hs-comment'>-- initially in un-zonked form and are finally zonked in tcRnSrcDecls</span>
<a name="line-122"></a>
<a name="line-123"></a>        <span class='hs-varid'>tcg_rn_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-124"></a>        <span class='hs-varid'>tcg_rn_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-125"></a>                <span class='hs-comment'>-- Keep the renamed imports regardless.  They are not</span>
<a name="line-126"></a>                <span class='hs-comment'>-- voluminous and are needed if you want to report unused imports</span>
<a name="line-127"></a>
<a name="line-128"></a>        <span class='hs-varid'>tcg_rn_decls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-129"></a>          <span class='hs-comment'>-- ^ Renamed decls, maybe.  @Nothing@ &lt;=&gt; Don't retain renamed</span>
<a name="line-130"></a>          <span class='hs-comment'>-- decls.</span>
<a name="line-131"></a>
<a name="line-132"></a>        <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ dependencies from addDependentFile</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-135"></a>        <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-136"></a>        <span class='hs-comment'>-- ^ Top-level declarations from addTopDecls</span>
<a name="line-137"></a>
<a name="line-138"></a>        <span class='hs-varid'>tcg_th_topnames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-139"></a>        <span class='hs-comment'>-- ^ Exact names bound in top-level declarations in tcg_th_topdecls</span>
<a name="line-140"></a>
<a name="line-141"></a>        <span class='hs-varid'>tcg_th_modfinalizers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Q</span> <span class='hs-conid'>()</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-142"></a>        <span class='hs-comment'>-- ^ Template Haskell module finalizers</span>
<a name="line-143"></a>
<a name="line-144"></a>        <span class='hs-varid'>tcg_th_state</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span> <span class='hs-conid'>TypeRep</span> <span class='hs-conid'>Dynamic</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-145"></a>        <span class='hs-comment'>-- ^ Template Haskell state</span>
<a name="line-146"></a><span class='hs-cpp'>#endif /* GHCI */</span>
<a name="line-147"></a>
<a name="line-148"></a>        <span class='hs-varid'>tcg_ev_binds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Top-level evidence bindings</span>
<a name="line-149"></a>        <span class='hs-varid'>tcg_binds</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Value bindings in this module</span>
<a name="line-150"></a>        <span class='hs-varid'>tcg_sigs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- ...Top-level names that *lack* a signature</span>
<a name="line-151"></a>        <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ...SPECIALISE prags for imported Ids</span>
<a name="line-152"></a>        <span class='hs-varid'>tcg_warns</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Warnings</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Warnings and deprecations</span>
<a name="line-153"></a>        <span class='hs-varid'>tcg_anns</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Annotation</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- ...Annotations</span>
<a name="line-154"></a>        <span class='hs-varid'>tcg_tcs</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- ...TyCons and Classes</span>
<a name="line-155"></a>        <span class='hs-varid'>tcg_insts</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ...Instances</span>
<a name="line-156"></a>        <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ...Family instances</span>
<a name="line-157"></a>        <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- ...Rules</span>
<a name="line-158"></a>        <span class='hs-varid'>tcg_fords</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ...Foreign import &amp; exports</span>
<a name="line-159"></a>        <span class='hs-varid'>tcg_vects</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- ...Vectorisation declarations</span>
<a name="line-160"></a>        <span class='hs-varid'>tcg_patsyns</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PatSyn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Pattern synonyms</span>
<a name="line-161"></a>
<a name="line-162"></a>        <span class='hs-varid'>tcg_doc_hdr</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Maybe Haddock header docs</span>
<a name="line-163"></a>        <span class='hs-varid'>tcg_hpc</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- ^ @True@ if any part of the</span>
<a name="line-164"></a>                                             <span class='hs-comment'>--  prog uses hpc instrumentation.</span>
<a name="line-165"></a>
<a name="line-166"></a>        <span class='hs-varid'>tcg_main</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ The Name of the main</span>
<a name="line-167"></a>                                             <span class='hs-comment'>-- function, if this module is</span>
<a name="line-168"></a>                                             <span class='hs-comment'>-- the main module.</span>
<a name="line-169"></a>        <span class='hs-varid'>tcg_safeInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span>          <span class='hs-comment'>-- Has the typechecker</span>
<a name="line-170"></a>                                             <span class='hs-comment'>-- inferred this module</span>
<a name="line-171"></a>                                             <span class='hs-comment'>-- as -XSafe (Safe Haskell)</span>
<a name="line-172"></a>    <span class='hs-layout'>}</span>
<a name="line-173"></a>
<a name="line-174"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyword'>where</span>
<a name="line-175"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>env</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="RecFieldEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RecFieldEnv</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecFields</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Maps a constructor name *in this module*</span>
<a name="line-179"></a>                                <span class='hs-comment'>-- to the fields for that constructor</span>
<a name="line-180"></a>              <span class='hs-conid'>NameSet</span>           <span class='hs-comment'>-- Set of all fields declared *in this module*;</span>
<a name="line-181"></a>                                <span class='hs-comment'>-- used to suppress name-shadowing complaints</span>
<a name="line-182"></a>                                <span class='hs-comment'>-- when using record wild cards</span>
<a name="line-183"></a>                                <span class='hs-comment'>-- E.g.  let fld = e in C {..}</span>
<a name="line-184"></a>        <span class='hs-comment'>-- This is used when dealing with ".." notation in record</span>
<a name="line-185"></a>        <span class='hs-comment'>-- construction and pattern matching.</span>
<a name="line-186"></a>        <span class='hs-comment'>-- The FieldEnv deals *only* with constructors defined in *this*</span>
<a name="line-187"></a>        <span class='hs-comment'>-- module.  For imported modules, we get the same info from the</span>
<a name="line-188"></a>        <span class='hs-comment'>-- TypeEnv</span>
</pre>\end{code}

Note [Tracking unused binding and imports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We gather two sorts of usage information
 * tcg_dus (defs/uses)
      Records *defined* Names (local, top-level)
          and *used*    Names (local or imported)

      Used (a) to report "defined but not used"
               (see RnNames.reportUnusedNames)
           (b) to generate version-tracking usage info in interface
               files (see MkIface.mkUsedNames)
   This usage info is mainly gathered by the renamer's
   gathering of free-variables

 * tcg_used_rdrnames
      Records used *imported* (not locally-defined) RdrNames
      Used only to report unused import declarations
      Notice that they are RdrNames, not Names, so we can
      tell whether the reference was qualified or unqualified, which
      is esssential in deciding whether a particular import decl
      is unnecessary.  This info isn't present in Names.


%************************************************************************
%*                                                                      *
                The interface environments
              Used when dealing with IfaceDecls
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="IfGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfGblEnv</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-3"></a>        <span class='hs-comment'>-- The type environment for the module being compiled,</span>
<a name="line-4"></a>        <span class='hs-comment'>-- in case the interface refers back to it via a reference that</span>
<a name="line-5"></a>        <span class='hs-comment'>-- was originally a hi-boot file.</span>
<a name="line-6"></a>        <span class='hs-comment'>-- We need the module name so we can test when it's appropriate</span>
<a name="line-7"></a>        <span class='hs-comment'>-- to look in this env.</span>
<a name="line-8"></a>        <span class='hs-varid'>if_rec_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                <span class='hs-comment'>-- Allows a read effect, so it can be in a mutable</span>
<a name="line-10"></a>                <span class='hs-comment'>-- variable; c.f. handling the external package type env</span>
<a name="line-11"></a>                <span class='hs-comment'>-- Nothing =&gt; interactive stuff, no loops possible</span>
<a name="line-12"></a>    <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="IfLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfLclEnv</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-16"></a>        <span class='hs-comment'>-- The module for the current IfaceDecl</span>
<a name="line-17"></a>        <span class='hs-comment'>-- So if we see   f = \x -&gt; x</span>
<a name="line-18"></a>        <span class='hs-comment'>-- it means M.f = \x -&gt; x, where M is the if_mod</span>
<a name="line-19"></a>        <span class='hs-varid'>if_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-comment'>-- The field is used only for error reporting</span>
<a name="line-22"></a>        <span class='hs-comment'>-- if (say) there's a Lint error in it</span>
<a name="line-23"></a>        <span class='hs-varid'>if_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>,</span>
<a name="line-24"></a>                <span class='hs-comment'>-- Where the interface came from:</span>
<a name="line-25"></a>                <span class='hs-comment'>--      .hi file, or GHCi state, or ext core</span>
<a name="line-26"></a>                <span class='hs-comment'>-- plus which bit is currently being examined</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-varid'>if_tv_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Nested tyvar bindings</span>
<a name="line-29"></a>                                        <span class='hs-comment'>-- (and coercions)</span>
<a name="line-30"></a>        <span class='hs-varid'>if_id_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Nested id binding</span>
<a name="line-31"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                The local typechecker environment
%*                                                                      *
%************************************************************************

The Global-Env/Local-Env story
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During type checking, we keep in the tcg_type_env
        * All types and classes
        * All Ids derived from types and classes (constructors, selectors)

At the end of type checking, we zonk the local bindings,
and as we do so we add to the tcg_type_env
        * Locally defined top-level Ids

Why?  Because they are now Ids not TcIds.  This final GlobalEnv is
        a) fed back (via the knot) to typechecking the
           unfoldings of interface signatures
        b) used in the ModDetails of this module

\begin{code}
<pre><a name="line-1"></a><a name="TcLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcLclEnv</span>           <span class='hs-comment'>-- Changes as we move inside an expression</span>
<a name="line-2"></a>                        <span class='hs-comment'>-- Discarded after typecheck/rename; not passed on to desugarer</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-4"></a>        <span class='hs-varid'>tcl_loc</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Source span</span>
<a name="line-5"></a>        <span class='hs-varid'>tcl_ctxt</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ErrCtxt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Error context, innermost on top</span>
<a name="line-6"></a>        <span class='hs-varid'>tcl_untch</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Birthplace for new unification variables</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-varid'>tcl_th_ctxt</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Template Haskell context</span>
<a name="line-9"></a>        <span class='hs-varid'>tcl_th_bndrs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThBindEnv</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Binding level of in-scope Names</span>
<a name="line-10"></a>                                           <span class='hs-comment'>-- defined in this module (not imported)</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-varid'>tcl_arrow_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-varid'>tcl_rdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Local name envt</span>
<a name="line-15"></a>                <span class='hs-comment'>-- Maintained during renaming, of course, but also during</span>
<a name="line-16"></a>                <span class='hs-comment'>-- type checking, solely so that when renaming a Template-Haskell</span>
<a name="line-17"></a>                <span class='hs-comment'>-- splice we have the right environment for the renamer.</span>
<a name="line-18"></a>                <span class='hs-comment'>--</span>
<a name="line-19"></a>                <span class='hs-comment'>--   Does *not* include global name envt; may shadow it</span>
<a name="line-20"></a>                <span class='hs-comment'>--   Includes both ordinary variables and type variables;</span>
<a name="line-21"></a>                <span class='hs-comment'>--   they are kept distinct because tyvar have a different</span>
<a name="line-22"></a>                <span class='hs-comment'>--   occurrence contructor (Name.TvOcc)</span>
<a name="line-23"></a>                <span class='hs-comment'>-- We still need the unsullied global name env so that</span>
<a name="line-24"></a>                <span class='hs-comment'>--   we can look up record field names</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-varid'>tcl_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- The local type environment:</span>
<a name="line-27"></a>                                  <span class='hs-comment'>-- Ids and TyVars defined in this module</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-varid'>tcl_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Stack of locally-bound Ids, innermost on top</span>
<a name="line-30"></a>                                     <span class='hs-comment'>-- Used only for error reporting</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-varid'>tcl_tidy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Used for tidying types; contains all</span>
<a name="line-33"></a>                                  <span class='hs-comment'>-- in-scope type variables (but not term variables)</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-varid'>tcl_tyvars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TcTyVarSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The "global tyvars"</span>
<a name="line-36"></a>                        <span class='hs-comment'>-- Namely, the in-scope TyVars bound in tcl_env,</span>
<a name="line-37"></a>                        <span class='hs-comment'>-- plus the tyvars mentioned in the types of Ids bound</span>
<a name="line-38"></a>                        <span class='hs-comment'>-- in tcl_lenv.</span>
<a name="line-39"></a>                        <span class='hs-comment'>-- Why mutable? see notes with tcGetGlobalTyVars</span>
<a name="line-40"></a>
<a name="line-41"></a>        <span class='hs-varid'>tcl_lie</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Place to accumulate type constraints</span>
<a name="line-42"></a>        <span class='hs-varid'>tcl_errs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Messages</span>              <span class='hs-comment'>-- Place to accumulate errors</span>
<a name="line-43"></a>    <span class='hs-layout'>}</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="TcTypeEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTypeEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="ThBindEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThBindEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThLevel</span><span class='hs-layout'>)</span>
<a name="line-48"></a>   <span class='hs-comment'>-- Domain = all Ids bound in this module (ie not imported)</span>
<a name="line-49"></a>   <span class='hs-comment'>-- The TopLevelFlag tells if the binding is syntactically top level.</span>
<a name="line-50"></a>   <span class='hs-comment'>-- We need to know this, because the cross-stage persistence story allows</span>
<a name="line-51"></a>   <span class='hs-comment'>-- cross-stage at arbitrary types if the Id is bound at top level.</span>
<a name="line-52"></a>   <span class='hs-comment'>--</span>
<a name="line-53"></a>   <span class='hs-comment'>-- Nota bene: a ThLevel of 'outerLevel' is *not* the same as being</span>
<a name="line-54"></a>   <span class='hs-comment'>-- bound at top level!  See Note [Template Haskell levels] in TcSplice</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="TcIdBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcIdBinder</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcIdBndr</span>
<a name="line-58"></a>       <span class='hs-conid'>TcId</span>
<a name="line-59"></a>       <span class='hs-conid'>TopLevelFlag</span>    <span class='hs-comment'>-- Tells whether the bindind is syntactically top-level</span>
<a name="line-60"></a>                       <span class='hs-comment'>-- (The monomorphic Ids for a recursive group count</span>
<a name="line-61"></a>                       <span class='hs-comment'>--  as not-top-level for this purpose.)</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>{- Note [Given Insts]
<a name="line-64"></a>   ~~~~~~~~~~~~~~~~~~
<a name="line-65"></a>Because of GADTs, we have to pass inwards the Insts provided by type signatures
<a name="line-66"></a>and existential contexts. Consider
<a name="line-67"></a>        data T a where { T1 :: b -&gt; b -&gt; T [b] }
<a name="line-68"></a>        f :: Eq a =&gt; T a -&gt; Bool
<a name="line-69"></a>        f (T1 x y) = [x]==[y]
<a name="line-70"></a>
<a name="line-71"></a>The constructor T1 binds an existential variable 'b', and we need Eq [b].
<a name="line-72"></a>Well, we have it, because Eq a refines to Eq [b], but we can only spot that if we
<a name="line-73"></a>pass it inwards.
<a name="line-74"></a>
<a name="line-75"></a>-}</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-comment'>---------------------------</span>
<a name="line-78"></a><span class='hs-comment'>-- Template Haskell stages and levels</span>
<a name="line-79"></a><span class='hs-comment'>---------------------------</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="ThStage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ThStage</span>    <span class='hs-comment'>-- See Note [Template Haskell state diagram] in TcSplice</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span>      <span class='hs-comment'>-- Top-level splicing</span>
<a name="line-83"></a>                <span class='hs-comment'>-- This code will be run *at compile time*;</span>
<a name="line-84"></a>                <span class='hs-comment'>--   the result replaces the splice</span>
<a name="line-85"></a>                <span class='hs-comment'>-- Binding level = 0</span>
<a name="line-86"></a>      <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True if in a typed splice, False otherwise</span>
<a name="line-87"></a>
<a name="line-88"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Comp</span>        <span class='hs-comment'>-- Ordinary Haskell code</span>
<a name="line-89"></a>                <span class='hs-comment'>-- Binding level = 1</span>
<a name="line-90"></a>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Brack</span>                       <span class='hs-comment'>-- Inside brackets</span>
<a name="line-92"></a>      <span class='hs-conid'>ThStage</span>                   <span class='hs-comment'>--   Enclosing stage</span>
<a name="line-93"></a>      <span class='hs-conid'>PendingStuff</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="PendingStuff"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PendingStuff</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RnPendingUntyped</span>              <span class='hs-comment'>-- Renaming the inside of an *untyped* bracket</span>
<a name="line-97"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Pending splices in here</span>
<a name="line-98"></a>
<a name="line-99"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RnPendingTyped</span>                <span class='hs-comment'>-- Renaming the inside of a *typed* bracket</span>
<a name="line-100"></a>
<a name="line-101"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPending</span>                     <span class='hs-comment'>-- Typechecking the iniside of a typed bracket</span>
<a name="line-102"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingTcSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--   Accumulate pending splices here</span>
<a name="line-103"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--     and type constraints here</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="topStage"></a><span class='hs-definition'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span>
<a name="line-106"></a><span class='hs-definition'>topStage</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Comp</span>
<a name="line-107"></a><a name="topAnnStage"></a><span class='hs-definition'>topAnnStage</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>False</span>
<a name="line-108"></a><a name="topSpliceStage"></a><span class='hs-definition'>topSpliceStage</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>False</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyword'>where</span>
<a name="line-111"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Splice"</span>
<a name="line-112"></a>   <span class='hs-varid'>ppr</span> <span class='hs-conid'>Comp</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Comp"</span>
<a name="line-113"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Brack"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="ThLevel"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-116"></a>    <span class='hs-comment'>-- NB: see Note [Template Haskell levels] in TcSplice</span>
<a name="line-117"></a>    <span class='hs-comment'>-- Incremented when going inside a bracket,</span>
<a name="line-118"></a>    <span class='hs-comment'>-- decremented when going inside a splice</span>
<a name="line-119"></a>    <span class='hs-comment'>-- NB: ThLevel is one greater than the 'n' in Fig 2 of the</span>
<a name="line-120"></a>    <span class='hs-comment'>--     original "Template meta-programming for Haskell" paper</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="impLevel"></a><span class='hs-definition'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThLevel</span>
<a name="line-123"></a><span class='hs-definition'>impLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Imported things; they can be used inside a top level splice</span>
<a name="line-124"></a><a name="outerLevel"></a><span class='hs-definition'>outerLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>  <span class='hs-comment'>-- Things defined outside brackets</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="thLevel"></a><span class='hs-definition'>thLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThLevel</span>
<a name="line-127"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-128"></a><span class='hs-definition'>thLevel</span> <span class='hs-conid'>Comp</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-129"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thLevel</span> <span class='hs-varid'>s</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-comment'>---------------------------</span>
<a name="line-132"></a><span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-133"></a><span class='hs-comment'>---------------------------</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-comment'>{- Note [Escaping the arrow scope]
<a name="line-136"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-137"></a>In arrow notation, a variable bound by a proc (or enclosed let/kappa)
<a name="line-138"></a>is not in scope to the left of an arrow tail (-&lt;) or the head of (|..|).
<a name="line-139"></a>For example
<a name="line-140"></a>
<a name="line-141"></a>        proc x -&gt; (e1 -&lt; e2)
<a name="line-142"></a>
<a name="line-143"></a>Here, x is not in scope in e1, but it is in scope in e2.  This can get
<a name="line-144"></a>a bit complicated:
<a name="line-145"></a>
<a name="line-146"></a>        let x = 3 in
<a name="line-147"></a>        proc y -&gt; (proc z -&gt; e1) -&lt; e2
<a name="line-148"></a>
<a name="line-149"></a>Here, x and z are in scope in e1, but y is not.
<a name="line-150"></a>
<a name="line-151"></a>We implement this by
<a name="line-152"></a>recording the environment when passing a proc (using newArrowScope),
<a name="line-153"></a>and returning to that (using escapeArrowScope) on the left of -&lt; and the
<a name="line-154"></a>head of (|..|).
<a name="line-155"></a>
<a name="line-156"></a>All this can be dealt with by the *renamer*; by the time we get to
<a name="line-157"></a>the *type checker* we have sorted out the scopes
<a name="line-158"></a>-}</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="ArrowCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArrowCtxt</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoArrowCtxt</span>
<a name="line-162"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="newArrowScope"></a><span class='hs-comment'>-- Record the current environment (outside a proc)</span>
<a name="line-165"></a><span class='hs-definition'>newArrowScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-166"></a><span class='hs-definition'>newArrowScope</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updEnv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-168"></a>        <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env_lcl</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_lcl</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_arrow_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArrowCtxt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="escapeArrowScope"></a><span class='hs-comment'>-- Return to the stored environment (from the enclosing proc)</span>
<a name="line-171"></a><span class='hs-definition'>escapeArrowScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-172"></a><span class='hs-definition'>escapeArrowScope</span>
<a name="line-173"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updEnv</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcl_arrow_ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_lcl</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-174"></a>        <span class='hs-conid'>NoArrowCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env</span>
<a name="line-175"></a>        <span class='hs-conid'>ArrowCtxt</span> <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env'</span>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-comment'>---------------------------</span>
<a name="line-178"></a><span class='hs-comment'>-- TcTyThing</span>
<a name="line-179"></a><span class='hs-comment'>---------------------------</span>
<a name="line-180"></a>
<a name="line-181"></a><a name="TcTyThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AGlobal</span> <span class='hs-conid'>TyThing</span>             <span class='hs-comment'>-- Used only in the return type of a lookup</span>
<a name="line-183"></a>
<a name="line-184"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATcId</span>   <span class='hs-layout'>{</span>           <span class='hs-comment'>-- Ids defined in this module; may not be fully zonked</span>
<a name="line-185"></a>        <span class='hs-varid'>tct_id</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span>
<a name="line-186"></a>        <span class='hs-varid'>tct_closed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-layout'>}</span>   <span class='hs-comment'>-- See Note [Bindings with closed types]</span>
<a name="line-187"></a>
<a name="line-188"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyVar</span>  <span class='hs-conid'>Name</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- The type variable to which the lexically scoped type</span>
<a name="line-189"></a>                                <span class='hs-comment'>-- variable is bound. We only need the Name</span>
<a name="line-190"></a>                                <span class='hs-comment'>-- for error-message purposes; it is the corresponding</span>
<a name="line-191"></a>                                <span class='hs-comment'>-- Name in the domain of the envt</span>
<a name="line-192"></a>
<a name="line-193"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AThing</span>  <span class='hs-conid'>TcKind</span>   <span class='hs-comment'>-- Used temporarily, during kind checking, for the</span>
<a name="line-194"></a>                     <span class='hs-comment'>-- tycons and clases in this recursive group</span>
<a name="line-195"></a>                     <span class='hs-comment'>-- Can be a mono-kind or a poly-kind; in TcTyClsDcls see</span>
<a name="line-196"></a>                     <span class='hs-comment'>-- Note [Type checking recursive type and class declarations]</span>
<a name="line-197"></a>
<a name="line-198"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>APromotionErr</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="PromotionErr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-201"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConPE</span>          <span class='hs-comment'>-- TyCon used in a kind before we are ready</span>
<a name="line-202"></a>                     <span class='hs-comment'>--     data T :: T -&gt; * where ...</span>
<a name="line-203"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPE</span>          <span class='hs-comment'>-- Ditto Class</span>
<a name="line-204"></a>
<a name="line-205"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamDataConPE</span>     <span class='hs-comment'>-- Data constructor for a data family</span>
<a name="line-206"></a>                     <span class='hs-comment'>-- See Note [AFamDataCon: not promoting data family constructors] in TcRnDriver</span>
<a name="line-207"></a>
<a name="line-208"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecDataConPE</span>     <span class='hs-comment'>-- Data constructor in a recursive loop</span>
<a name="line-209"></a>                     <span class='hs-comment'>-- See Note [ARecDataCon: recusion and promoting data constructors] in TcTyClsDecls</span>
<a name="line-210"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoDataKinds</span>      <span class='hs-comment'>-- -XDataKinds not enabled</span>
<a name="line-211"></a>
<a name="line-212"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyword'>where</span>     <span class='hs-comment'>-- Debugging only</span>
<a name="line-213"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThing</span> <span class='hs-varid'>g</span>
<a name="line-214"></a>   <span class='hs-varid'>ppr</span> <span class='hs-varid'>elt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Identifier"</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-215"></a>                          <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-216"></a>                                 <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-217"></a>                                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_closed</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-218"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type variable"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-219"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"AThing"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span>
<a name="line-220"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"APromotionErr"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>err</span>
<a name="line-221"></a>
<a name="line-222"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyword'>where</span>
<a name="line-223"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ClassPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ClassPE"</span>
<a name="line-224"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TyConPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TyConPE"</span>
<a name="line-225"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>FamDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"FamDataConPE"</span>
<a name="line-226"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RecDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RecDataConPE"</span>
<a name="line-227"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoDataKinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoDataKinds"</span>
<a name="line-228"></a>
<a name="line-229"></a><a name="pprTcTyThingCategory"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-230"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThingCategory</span> <span class='hs-varid'>thing</span>
<a name="line-231"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type variable"</span><span class='hs-layout'>)</span>
<a name="line-232"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Local identifier"</span><span class='hs-layout'>)</span>
<a name="line-233"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kinded thing"</span><span class='hs-layout'>)</span>
<a name="line-234"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>pe</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>pe</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="pprPECategory"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-237"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>ClassPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Class"</span><span class='hs-layout'>)</span>
<a name="line-238"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>TyConPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type constructor"</span><span class='hs-layout'>)</span>
<a name="line-239"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>FamDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span>
<a name="line-240"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>RecDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span>
<a name="line-241"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>NoDataKinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span>
</pre>\end{code}


Note [Bindings with closed types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  f x = let g ys = map not ys
        in ...

Can we generalise 'g' under the OutsideIn algorithm?  Yes,
because all g's free variables are top-level; that is they themselves
have no free type variables, and it is the type variables in the
environment that makes things tricky for OutsideIn generalisation.

Definition:

   A variable is "closed", and has tct_closed set to TopLevel,
      iff
   a) all its free variables are imported, or are themselves closed
   b) generalisation is not restricted by the monomorphism restriction

Under OutsideIn we are free to generalise a closed let-binding.
This is an extension compared to the JFP paper on OutsideIn, which
used "top-level" as a proxy for "closed".  (It's not a good proxy
anyway -- the MR can make a top-level binding with a free type
variable.)

Note that:
  * A top-level binding may not be closed, if it suffer from the MR

  * A nested binding may be closed (eg 'g' in the example we started with)
    Indeed, that's the point; whether a function is defined at top level
    or nested is orthogonal to the question of whether or not it is closed

  * A binding may be non-closed because it mentions a lexically scoped
    *type variable*  Eg
        f :: forall a. blah
        f x = let g y = ...(y::a)...


\begin{code}
<pre><a name="line-1"></a><a name="ErrCtxt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2"></a>        <span class='hs-comment'>-- Monadic so that we have a chance</span>
<a name="line-3"></a>        <span class='hs-comment'>-- to deal with bound type variables just before error</span>
<a name="line-4"></a>        <span class='hs-comment'>-- message construction</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-comment'>-- Bool:  True &lt;=&gt; this is a landmark context; do not</span>
<a name="line-7"></a>        <span class='hs-comment'>--                 discard it when trimming for display</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Operations over ImportAvails
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="ImportAvails"></a><span class='hs-comment'>-- | 'ImportAvails' summarises what was imported from where, irrespective of</span>
<a name="line-2"></a><a name="ImportAvails"></a><span class='hs-comment'>-- whether the imported things are actually used or not.  It is used:</span>
<a name="line-3"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when processing the export list,</span>
<a name="line-5"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when constructing usage info for the interface file,</span>
<a name="line-7"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * to identify the list of directly imported modules for initialisation</span>
<a name="line-9"></a><a name="ImportAvails"></a><span class='hs-comment'>--    purposes and for optimised overlap checking of family instances,</span>
<a name="line-10"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when figuring out what things are really unused</span>
<a name="line-12"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><a name="ImportAvails"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-14"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span>
<a name="line-15"></a>        <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportedMods</span><span class='hs-layout'>,</span>
<a name="line-16"></a>          <span class='hs-comment'>--      = ModuleEnv [(ModuleName, Bool, SrcSpan, Bool)],</span>
<a name="line-17"></a>          <span class='hs-comment'>-- ^ Domain is all directly-imported modules</span>
<a name="line-18"></a>          <span class='hs-comment'>-- The 'ModuleName' is what the module was imported as, e.g. in</span>
<a name="line-19"></a>          <span class='hs-comment'>-- @</span>
<a name="line-20"></a>          <span class='hs-comment'>--     import Foo as Bar</span>
<a name="line-21"></a>          <span class='hs-comment'>-- @</span>
<a name="line-22"></a>          <span class='hs-comment'>-- it is @Bar@.</span>
<a name="line-23"></a>          <span class='hs-comment'>--</span>
<a name="line-24"></a>          <span class='hs-comment'>-- The 'Bool' means:</span>
<a name="line-25"></a>          <span class='hs-comment'>--</span>
<a name="line-26"></a>          <span class='hs-comment'>--  - @True@ =&gt; import was @import Foo ()@</span>
<a name="line-27"></a>          <span class='hs-comment'>--</span>
<a name="line-28"></a>          <span class='hs-comment'>--  - @False@ =&gt; import was some other form</span>
<a name="line-29"></a>          <span class='hs-comment'>--</span>
<a name="line-30"></a>          <span class='hs-comment'>-- Used</span>
<a name="line-31"></a>          <span class='hs-comment'>--</span>
<a name="line-32"></a>          <span class='hs-comment'>--   (a) to help construct the usage information in the interface</span>
<a name="line-33"></a>          <span class='hs-comment'>--       file; if we import something we need to recompile if the</span>
<a name="line-34"></a>          <span class='hs-comment'>--       export version changes</span>
<a name="line-35"></a>          <span class='hs-comment'>--</span>
<a name="line-36"></a>          <span class='hs-comment'>--   (b) to specify what child modules to initialise</span>
<a name="line-37"></a>          <span class='hs-comment'>--</span>
<a name="line-38"></a>          <span class='hs-comment'>-- We need a full ModuleEnv rather than a ModuleNameEnv here,</span>
<a name="line-39"></a>          <span class='hs-comment'>-- because we might be importing modules of the same name from</span>
<a name="line-40"></a>          <span class='hs-comment'>-- different packages. (currently not the case, but might be in the</span>
<a name="line-41"></a>          <span class='hs-comment'>-- future).</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-44"></a>          <span class='hs-comment'>-- ^ Home-package modules needed by the module being compiled</span>
<a name="line-45"></a>          <span class='hs-comment'>--</span>
<a name="line-46"></a>          <span class='hs-comment'>-- It doesn't matter whether any of these dependencies</span>
<a name="line-47"></a>          <span class='hs-comment'>-- are actually /used/ when compiling the module; they</span>
<a name="line-48"></a>          <span class='hs-comment'>-- are listed if they are below it at all.  For</span>
<a name="line-49"></a>          <span class='hs-comment'>-- example, suppose M imports A which imports X.  Then</span>
<a name="line-50"></a>          <span class='hs-comment'>-- compiling M might not need to consult X.hi, but X</span>
<a name="line-51"></a>          <span class='hs-comment'>-- is still listed in M's dependencies.</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-54"></a>          <span class='hs-comment'>-- ^ Packages needed by the module being compiled, whether directly,</span>
<a name="line-55"></a>          <span class='hs-comment'>-- or via other modules in this package, or via modules imported</span>
<a name="line-56"></a>          <span class='hs-comment'>-- from other packages.</span>
<a name="line-57"></a>
<a name="line-58"></a>        <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-59"></a>          <span class='hs-comment'>-- ^ This is strictly a subset of imp_dep_pkgs and records the</span>
<a name="line-60"></a>          <span class='hs-comment'>-- packages the current module needs to trust for Safe Haskell</span>
<a name="line-61"></a>          <span class='hs-comment'>-- compilation to succeed. A package is required to be trusted if</span>
<a name="line-62"></a>          <span class='hs-comment'>-- we are dependent on a trustworthy module in that package.</span>
<a name="line-63"></a>          <span class='hs-comment'>-- While perhaps making imp_dep_pkgs a tuple of (PackageId, Bool)</span>
<a name="line-64"></a>          <span class='hs-comment'>-- where True for the bool indicates the package is required to be</span>
<a name="line-65"></a>          <span class='hs-comment'>-- trusted is the more logical  design, doing so complicates a lot</span>
<a name="line-66"></a>          <span class='hs-comment'>-- of code not concerned with Safe Haskell.</span>
<a name="line-67"></a>          <span class='hs-comment'>-- See Note [RnNames . Tracking Trust Transitively]</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-70"></a>          <span class='hs-comment'>-- ^ Do we require that our own package is trusted?</span>
<a name="line-71"></a>          <span class='hs-comment'>-- This is to handle efficiently the case where a Safe module imports</span>
<a name="line-72"></a>          <span class='hs-comment'>-- a Trustworthy module that resides in the same package as it.</span>
<a name="line-73"></a>          <span class='hs-comment'>-- See Note [RnNames . Trust Own Package]</span>
<a name="line-74"></a>
<a name="line-75"></a>        <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-76"></a>          <span class='hs-comment'>-- ^ Orphan modules below us in the import tree (and maybe including</span>
<a name="line-77"></a>          <span class='hs-comment'>-- us for imported modules)</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>
<a name="line-80"></a>          <span class='hs-comment'>-- ^ Family instance modules below us in the import tree (and maybe</span>
<a name="line-81"></a>          <span class='hs-comment'>-- including us for imported modules)</span>
<a name="line-82"></a>      <span class='hs-layout'>}</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="mkModDeps"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-85"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyUFM</span> <span class='hs-varid'>deps</span>
<a name="line-87"></a>               <span class='hs-keyword'>where</span>
<a name="line-88"></a>                 <span class='hs-varid'>add</span> <span class='hs-varid'>env</span> <span class='hs-varid'>elt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-varid'>env</span> <span class='hs-varid'>m</span> <span class='hs-varid'>elt</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="emptyImportAvails"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-91"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModuleEnv</span><span class='hs-layout'>,</span>
<a name="line-92"></a>                                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span>
<a name="line-93"></a>                                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-94"></a>                                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-95"></a>                                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-96"></a>                                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-97"></a>                                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="plusImportAvails"></a><span class='hs-comment'>-- | Union two ImportAvails</span>
<a name="line-100"></a><span class='hs-comment'>--</span>
<a name="line-101"></a><span class='hs-comment'>-- This function is a key part of Import handling, basically</span>
<a name="line-102"></a><span class='hs-comment'>-- for each import we create a separate ImportAvails structure</span>
<a name="line-103"></a><span class='hs-comment'>-- and then union them all together with this function.</span>
<a name="line-104"></a><span class='hs-definition'>plusImportAvails</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span>
<a name="line-105"></a><span class='hs-definition'>plusImportAvails</span>
<a name="line-106"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods1</span><span class='hs-layout'>,</span>
<a name="line-107"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span><span class='hs-layout'>,</span>
<a name="line-108"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span><span class='hs-layout'>,</span>
<a name="line-109"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-111"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-112"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-113"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusModuleEnv_C</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods1</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-115"></a>                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusUFM_C</span> <span class='hs-varid'>plus_mod_dep</span> <span class='hs-varid'>dmods1</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span>
<a name="line-116"></a>                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-117"></a>                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span>
<a name="line-118"></a>                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-119"></a>                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span>
<a name="line-120"></a>                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span>
<a name="line-121"></a>  <span class='hs-keyword'>where</span>
<a name="line-122"></a>    <span class='hs-varid'>plus_mod_dep</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span>
<a name="line-123"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>boot1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-124"></a>                <span class='hs-comment'>-- Check mod-names match</span>
<a name="line-125"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- If either side can "see" a non-hi-boot interface, use that</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Where from}
%*                                                                      *
%************************************************************************

The @WhereFrom@ type controls where the renamer looks for an interface file

\begin{code}
<pre><a name="line-1"></a><a name="WhereFrom"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WhereFrom</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportByUser</span> <span class='hs-conid'>IsBootInterface</span>        <span class='hs-comment'>-- Ordinary user import (perhaps {-# SOURCE #-})</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportBySystem</span>                      <span class='hs-comment'>-- Non user import.</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportByPlugin</span>                      <span class='hs-comment'>-- Importing a plugin;</span>
<a name="line-5"></a>                                        <span class='hs-comment'>-- See Note [Care with plugin imports] in LoadIface</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WhereFrom</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_boot</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"{- SOURCE -}"</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-10"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportBySystem</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"{- SYSTEM -}"</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportByPlugin</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"{- PLUGIN -}"</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*                       Canonical constraints                          *
%*                                                                      *
%*   These are the constraints the low-level simplifier works with      *
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- The syntax of xi types:</span>
<a name="line-2"></a><span class='hs-comment'>-- xi ::= a | T xis | xis -&gt; xis | ... | forall a. tau</span>
<a name="line-3"></a><span class='hs-comment'>-- Two important notes:</span>
<a name="line-4"></a><span class='hs-comment'>--      (i) No type families, unless we are under a ForAll</span>
<a name="line-5"></a><span class='hs-comment'>--      (ii) Note that xi types can contain unexpanded type synonyms;</span>
<a name="line-6"></a><span class='hs-comment'>--           however, the (transitive) expansions of those type synonyms</span>
<a name="line-7"></a><span class='hs-comment'>--           will not contain any type functions, unless we are under a ForAll.</span>
<a name="line-8"></a><span class='hs-comment'>-- We enforce the structure of Xi types when we flatten (TcCanonical)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="Xi"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- In many comments, "xi" ranges over Xi</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="Cts"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="Ct"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Ct</span>
<a name="line-15"></a>  <span class='hs-comment'>-- Atomic canonical constraints</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- e.g.  Num xi</span>
<a name="line-17"></a>      <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-18"></a>      <span class='hs-varid'>cc_class</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span>
<a name="line-19"></a>      <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>    <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- These stand for yet-unusable predicates</span>
<a name="line-23"></a>      <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>   <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-24"></a>        <span class='hs-comment'>-- The ctev_pred of the evidence is</span>
<a name="line-25"></a>        <span class='hs-comment'>-- of form   (tv xi1 xi2 ... xin)</span>
<a name="line-26"></a>        <span class='hs-comment'>--      or   (tv1 ~ ty2)   where the CTyEqCan  kind invariant fails</span>
<a name="line-27"></a>        <span class='hs-comment'>--      or   (F tys ~ ty)  where the CFunEqCan kind invariant fails</span>
<a name="line-28"></a>        <span class='hs-comment'>-- See Note [CIrredEvCan constraints]</span>
<a name="line-29"></a>    <span class='hs-layout'>}</span>
<a name="line-30"></a>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- tv ~ xi      (recall xi means function free)</span>
<a name="line-32"></a>       <span class='hs-comment'>-- Invariant:</span>
<a name="line-33"></a>       <span class='hs-comment'>--   * tv not in tvs(xi)   (occurs check)</span>
<a name="line-34"></a>       <span class='hs-comment'>--   * typeKind xi `subKind` typeKind tv</span>
<a name="line-35"></a>       <span class='hs-comment'>--       See Note [Kind orientation for CTyEqCan]</span>
<a name="line-36"></a>       <span class='hs-comment'>--   * We prefer unification variables on the left *JUST* for efficiency</span>
<a name="line-37"></a>      <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-38"></a>      <span class='hs-varid'>cc_tyvar</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span>
<a name="line-39"></a>      <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Xi</span>
<a name="line-40"></a>    <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- F xis ~ xi</span>
<a name="line-43"></a>       <span class='hs-comment'>-- Invariant: * isSynFamilyTyCon cc_fun</span>
<a name="line-44"></a>       <span class='hs-comment'>--            * typeKind (F xis) `subKind` typeKind xi</span>
<a name="line-45"></a>       <span class='hs-comment'>--       See Note [Kind orientation for CFunEqCan]</span>
<a name="line-46"></a>      <span class='hs-varid'>cc_ev</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-47"></a>      <span class='hs-varid'>cc_fun</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- A type function</span>
<a name="line-48"></a>      <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Either under-saturated or exactly saturated</span>
<a name="line-49"></a>      <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Xi</span>           <span class='hs-comment'>--    *never* over-saturated (because if so</span>
<a name="line-50"></a>                                <span class='hs-comment'>--    we should have decomposed)</span>
<a name="line-51"></a>    <span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span>        <span class='hs-comment'>-- See Note [NonCanonical Semantics]</span>
<a name="line-54"></a>      <span class='hs-varid'>cc_ev</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-55"></a>    <span class='hs-layout'>}</span>
<a name="line-56"></a>
<a name="line-57"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span>             <span class='hs-comment'>-- Treated as an "insoluble" constraint</span>
<a name="line-58"></a>                           <span class='hs-comment'>-- See Note [Insoluble constraints]</span>
<a name="line-59"></a>      <span class='hs-varid'>cc_ev</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>
<a name="line-60"></a>      <span class='hs-varid'>cc_occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span>    <span class='hs-comment'>-- The name of this hole</span>
<a name="line-61"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Kind orientation for CTyEqCan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given an equality  (t:* ~ s:Open), we absolutely want to re-orient it.
We can't solve it by updating t:=s, ragardless of how touchable 't' is,
because the kinds don't work.  Indeed we don't want to leave it with
the orientation (t ~ s), because if that gets into the inert set we'll
start replacing t's by s's, and that too is the wrong way round.

Hence in a CTyEqCan, (t:k1 ~ xi:k2) we require that k2 is a subkind of k1.

If the two have incompatible kinds, we just don't use a CTyEqCan at all.
See Note [Equalities with incompatible kinds] in TcCanonical

We can't require *equal* kinds, because
     * wanted constraints don't necessarily have identical kinds
               eg   alpha::? ~ Int
     * a solved wanted constraint becomes a given

Note [Kind orientation for CFunEqCan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For (F xis ~ rhs) we require that kind(lhs) is a subkind of kind(rhs).
This reallly only maters when rhs is an Open type variable (since only type
variables have Open kinds):
   F ty ~ (a:Open)
which can happen, say, from
      f :: F a b
      f = undefined   -- The a:Open comes from instantiating 'undefined'

Note that the kind invariant is maintained by rewriting.
Eg wanted1 rewrites wanted2; if both were compatible kinds before,
   wanted2 will be afterwards.  Similarly givens.

Caveat:
  - Givens from higher-rank, such as:
          type family T b :: * -> * -> *
          type instance T Bool = (->)

          f :: forall a. ((T a ~ (->)) => ...) -> a -> ...
          flop = f (...) True
     Whereas we would be able to apply the type instance, we would not be able to
     use the given (T Bool ~ (->)) in the body of 'flop'


Note [CIrredEvCan constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CIrredEvCan constraints are used for constraints that are "stuck"
   - we can't solve them (yet)
   - we can't use them to solve other constraints
   - but they may become soluble if we substitute for some
     of the type variables in the constraint

Example 1:  (c Int), where c :: * -> Constraint.  We can't do anything
            with this yet, but if later c := Num, *then* we can solve it

Example 2:  a ~ b, where a :: *, b :: k, where k is a kind variable
            We don't want to use this to substitute 'b' for 'a', in case
            'k' is subequently unifed with (say) *->*, because then
            we'd have ill-kinded types floating about.  Rather we want
            to defer using the equality altogether until 'k' get resolved.

Note [Ct/evidence invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If  ct :: Ct, then extra fields of 'ct' cache precisely the ctev_pred field
of (cc_ev ct), and is fully rewritten wrt the substitution.   Eg for CDictCan,
   ctev_pred (cc_ev ct) = (cc_class ct) (cc_tyargs ct)
This holds by construction; look at the unique place where CDictCan is
built (in TcCanonical).

In contrast, the type of the evidence *term* (ccev_evtm or ctev_evar) in
the evidence may *not* be fully zonked; we are careful not to look at it
during constraint solving.  See Note [Evidence field of CtEvidence]

\begin{code}
<pre><a name="line-1"></a><a name="mkNonCanonical"></a><span class='hs-definition'>mkNonCanonical</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-2"></a><span class='hs-definition'>mkNonCanonical</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="mkNonCanonicalCt"></a><span class='hs-definition'>mkNonCanonicalCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-5"></a><span class='hs-definition'>mkNonCanonicalCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="ctEvidence"></a><span class='hs-definition'>ctEvidence</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-8"></a><span class='hs-definition'>ctEvidence</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="ctLoc"></a><span class='hs-definition'>ctLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-11"></a><span class='hs-definition'>ctLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="ctPred"></a><span class='hs-definition'>ctPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-14"></a><span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-15"></a><span class='hs-definition'>ctPred</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="dropDerivedWC"></a><span class='hs-definition'>dropDerivedWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-18"></a><span class='hs-comment'>-- See Note [Dropping derived constraints]</span>
<a name="line-19"></a><span class='hs-definition'>dropDerivedWC</span> <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flats</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>isWantedCt</span>          <span class='hs-varid'>flats</span>
<a name="line-21"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isDerivedCt</span><span class='hs-layout'>)</span> <span class='hs-varid'>insols</span>  <span class='hs-layout'>}</span>
<a name="line-22"></a>    <span class='hs-comment'>-- Keep Givens from insols because they indicate unreachable code</span>
<a name="line-23"></a>    <span class='hs-comment'>-- The implications are (recursively) already filtered</span>
</pre>\end{code}

Note [Dropping derived constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general we discard derived constraints at the end of constraint solving;
see dropDerivedWC.  A consequence is that
   we never report an error for a derived constraint,
   and hence we do not need to take much care with their CtLoc

For example,

 * If we have an unsolved (Ord a), we don't want to complain about
   an unsolved (Eq a) as well.
 * If we have kind-incompatible (a::* ~ Int#::#) equality, we
   don't want to complain about the kind error twice.

Arguably, for *some* derived constraints we might want to report errors.
Notably, functional dependencies.  If we have
    class C a b | a -> b
and we have
    [W] C a b, [W] C a c
where a,b,c are all signature variables.  Then we could imagine
reporting an error unifying (b ~ c). But it's better to report that we can't
solve (C a b) and (C a c) since those arose directly from something the
programmer wrote.


%************************************************************************
%*                                                                      *
                    CtEvidence
         The "flavor" of a canonical constraint
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="isWantedCt"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isWanted</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="isGivenCt"></a><span class='hs-definition'>isGivenCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a><span class='hs-definition'>isGivenCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGiven</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="isDerivedCt"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-8"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDerived</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="isCTyEqCan"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-12"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-13"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="isCDictCan_Maybe"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Class</span>
<a name="line-16"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span>
<a name="line-17"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="isCIrredEvCan"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-20"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-21"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="isCFunEqCan_maybe"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>xis</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="isCFunEqCan"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-28"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-29"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="isCNonCanonical"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-32"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-layout'>(</span><span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-33"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="isHoleCt"></a><span class='hs-definition'>isHoleCt</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-36"></a><span class='hs-definition'>isHoleCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-37"></a><span class='hs-definition'>isHoleCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-38"></a>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Ct</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>ct_sort</span><span class='hs-layout'>)</span>
<a name="line-3"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>ct_sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>                           <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CTyEqCan"</span>
<a name="line-5"></a>                           <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CFunEqCan"</span>
<a name="line-6"></a>                           <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CNonCanonical"</span>
<a name="line-7"></a>                           <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CDictCan"</span>
<a name="line-8"></a>                           <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CIrredEvCan"</span>
<a name="line-9"></a>                           <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CHoleCan"</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="singleCt"></a><span class='hs-definition'>singleCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2"></a><span class='hs-definition'>singleCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="andCts"></a><span class='hs-definition'>andCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-5"></a><span class='hs-definition'>andCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionBags</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="listToCts"></a><span class='hs-definition'>listToCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-8"></a><span class='hs-definition'>listToCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="ctsElts"></a><span class='hs-definition'>ctsElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a><span class='hs-definition'>ctsElts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="extendCts"></a><span class='hs-definition'>extendCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-14"></a><span class='hs-definition'>extendCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocBag</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="extendCtsList"></a><span class='hs-definition'>extendCtsList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-17"></a><span class='hs-definition'>extendCtsList</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>xs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-18"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>xs</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="andManyCts"></a><span class='hs-definition'>andManyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Cts</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-21"></a><span class='hs-definition'>andManyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyBags</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="emptyCts"></a><span class='hs-definition'>emptyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-24"></a><span class='hs-definition'>emptyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="isEmptyCts"></a><span class='hs-definition'>isEmptyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-27"></a><span class='hs-definition'>isEmptyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Wanted constraints
     These are forced to be in TcRnTypes because
           TcLclEnv mentions WantedConstraints
           WantedConstraint mentions CtLoc
           CtLoc mentions ErrCtxt
           ErrCtxt mentions TcM
%*                                                                      *
v%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="WantedConstraints"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>               <span class='hs-comment'>-- Unsolved constraints, all wanted</span>
<a name="line-4"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-5"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>               <span class='hs-comment'>-- Insoluble constraints, can be</span>
<a name="line-6"></a>                                       <span class='hs-comment'>-- wanted, given, or derived</span>
<a name="line-7"></a>                                       <span class='hs-comment'>-- See Note [Insoluble constraints]</span>
<a name="line-8"></a>    <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="emptyWC"></a><span class='hs-definition'>emptyWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-11"></a><span class='hs-definition'>emptyWC</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="mkFlatWC"></a><span class='hs-definition'>mkFlatWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-14"></a><span class='hs-definition'>mkFlatWC</span> <span class='hs-varid'>cts</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="isEmptyWC"></a><span class='hs-definition'>isEmptyWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-18"></a><span class='hs-definition'>isEmptyWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>n</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="insolubleWC"></a><span class='hs-definition'>insolubleWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-22"></a><span class='hs-comment'>-- True if there are any insoluble constraints in the wanted bag</span>
<a name="line-23"></a><span class='hs-definition'>insolubleWC</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_insol</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>               <span class='hs-varop'>||</span> <span class='hs-varid'>anyBag</span> <span class='hs-varid'>ic_insol</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_impl</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="andWC"></a><span class='hs-definition'>andWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-27"></a><span class='hs-definition'>andWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-28"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>f2</span>
<a name="line-30"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>i2</span>
<a name="line-31"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>n2</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="unionsWC"></a><span class='hs-definition'>unionsWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WantedConstraints</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-34"></a><span class='hs-definition'>unionsWC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>andWC</span> <span class='hs-varid'>emptyWC</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="addFlats"></a><span class='hs-definition'>addFlats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-37"></a><span class='hs-definition'>addFlats</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>cts</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_flat</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="addImplics"></a><span class='hs-definition'>addImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-41"></a><span class='hs-definition'>addImplics</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_impl</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="addInsols"></a><span class='hs-definition'>addInsols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-44"></a><span class='hs-definition'>addInsols</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>cts</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_insol</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyword'>where</span>
<a name="line-48"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span><span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-49"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"WC"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span>
<a name="line-50"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span> <span class='hs-keyword'>else</span>
<a name="line-51"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"wc_flat ="</span><span class='hs-layout'>)</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprBag</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>f</span>
<a name="line-52"></a>        <span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span> <span class='hs-keyword'>else</span>
<a name="line-53"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"wc_impl ="</span><span class='hs-layout'>)</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprBag</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>i</span>
<a name="line-54"></a>        <span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span> <span class='hs-keyword'>else</span>
<a name="line-55"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"wc_insol ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprBag</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="pprBag"></a><span class='hs-definition'>pprBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-58"></a><span class='hs-definition'>pprBag</span> <span class='hs-varid'>pp</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>$$</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>pp</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span> <span class='hs-varid'>b</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Implication constraints
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Implication"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Implication</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span>
<a name="line-3"></a>      <span class='hs-varid'>ic_untch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Untouchables: unification variables</span>
<a name="line-4"></a>                                <span class='hs-comment'>-- free in the environment</span>
<a name="line-5"></a>
<a name="line-6"></a>      <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Introduced skolems</span>
<a name="line-7"></a>      <span class='hs-varid'>ic_info</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- See Note [Skolems in an implication]</span>
<a name="line-8"></a>                                 <span class='hs-comment'>-- See Note [Shadowing in a constraint]</span>
<a name="line-9"></a>
<a name="line-10"></a>      <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Given evidence variables</span>
<a name="line-11"></a>                                 <span class='hs-comment'>--   (order does not matter)</span>
<a name="line-12"></a>                                 <span class='hs-comment'>-- See Invariant (GivenInv) in TcType</span>
<a name="line-13"></a>
<a name="line-14"></a>      <span class='hs-varid'>ic_fsks</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Extra flatten-skolems introduced by</span>
<a name="line-15"></a>                                 <span class='hs-comment'>-- by flattening the givens</span>
<a name="line-16"></a>      <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- True  &lt;=&gt; ic_givens have no equalities, for sure</span>
<a name="line-17"></a>                                 <span class='hs-comment'>-- False &lt;=&gt; ic_givens might have equalities</span>
<a name="line-18"></a>
<a name="line-19"></a>      <span class='hs-varid'>ic_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Gives the source location and error context</span>
<a name="line-20"></a>                                 <span class='hs-comment'>-- for the implicatdion, and hence for all the</span>
<a name="line-21"></a>                                 <span class='hs-comment'>-- given evidence variables</span>
<a name="line-22"></a>
<a name="line-23"></a>      <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The wanted</span>
<a name="line-24"></a>      <span class='hs-varid'>ic_insol</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>               <span class='hs-comment'>-- True iff insolubleWC ic_wanted is true</span>
<a name="line-25"></a>
<a name="line-26"></a>      <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>   <span class='hs-comment'>-- Points to the place to fill in the</span>
<a name="line-27"></a>                                <span class='hs-comment'>-- abstraction and bindings</span>
<a name="line-28"></a>    <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Implication</span> <span class='hs-keyword'>where</span>
<a name="line-31"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>untch</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_fsks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsks</span>
<a name="line-32"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_eqs</span>
<a name="line-33"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span>
<a name="line-34"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-35"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Implic"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span>
<a name="line-36"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Untouchables ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>untch</span>
<a name="line-37"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Skolems ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTvBndrs</span> <span class='hs-varid'>skols</span>
<a name="line-38"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Flatten-skolems ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTvBndrs</span> <span class='hs-varid'>fsks</span>
<a name="line-39"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No-eqs ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>no_eqs</span>
<a name="line-40"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Given ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVars</span> <span class='hs-varid'>given</span>
<a name="line-41"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Wanted ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span>
<a name="line-42"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Binds ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span>
<a name="line-43"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>pprSkolInfo</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Shadowing in a constraint]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We assume NO SHADOWING in a constraint.  Specifically
 * The unification variables are all implicitly quantified at top
   level, and are all unique
 * The skolem varibles bound in ic_skols are all freah when the
   implication is created.
So we can safely substitute. For example, if we have
   forall a.  a~Int => ...(forall b. ...a...)...
we can push the (a~Int) constraint inwards in the "givens" without
worrying that 'b' might clash.

Note [Skolems in an implication]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The skolems in an implication are not there to perform a skolem escape
check.  That happens because all the environment variables are in the
untouchables, and therefore cannot be unified with anything at all,
let alone the skolems.

Instead, ic_skols is used only when considering floating a constraint
outside the implication in TcSimplify.floatEqualities or
TcSimplify.approximateImplications

Note [Insoluble constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some of the errors that we get during canonicalization are best
reported when all constraints have been simplified as much as
possible. For instance, assume that during simplification the
following constraints arise:

 [Wanted]   F alpha ~  uf1
 [Wanted]   beta ~ uf1 beta

When canonicalizing the wanted (beta ~ uf1 beta), if we eagerly fail
we will simply see a message:
    'Can't construct the infinite type  beta ~ uf1 beta'
and the user has no idea what the uf1 variable is.

Instead our plan is that we will NOT fail immediately, but:
    (1) Record the "frozen" error in the ic_insols field
    (2) Isolate the offending constraint from the rest of the inerts
    (3) Keep on simplifying/canonicalizing

At the end, we will hopefully have substituted uf1 := F alpha, and we
will be able to report a more informative error:
    'Can't construct the infinite type beta ~ F alpha beta'

Insoluble constraints *do* include Derived constraints. For example,
a functional dependency might give rise to [D] Int ~ Bool, and we must
report that.  If insolubles did not contain Deriveds, reportErrors would
never see it.


%************************************************************************
%*                                                                      *
            Pretty printing
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="pprEvVars"></a><span class='hs-definition'>pprEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>    <span class='hs-comment'>-- Print with their types</span>
<a name="line-2"></a><span class='hs-definition'>pprEvVars</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprEvVarWithType</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="pprEvVarTheta"></a><span class='hs-definition'>pprEvVarTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-5"></a><span class='hs-definition'>pprEvVarTheta</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="pprEvVarWithType"></a><span class='hs-definition'>pprEvVarWithType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-8"></a><span class='hs-definition'>pprEvVarWithType</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="pprWantedsWithLocs"></a><span class='hs-definition'>pprWantedsWithLocs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-11"></a><span class='hs-definition'>pprWantedsWithLocs</span> <span class='hs-varid'>wcs</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprBag</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_flat</span> <span class='hs-varid'>wcs</span><span class='hs-layout'>)</span>
<a name="line-13"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>pprBag</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_impl</span> <span class='hs-varid'>wcs</span><span class='hs-layout'>)</span>
<a name="line-14"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>pprBag</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_insol</span> <span class='hs-varid'>wcs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
            CtEvidence
%*                                                                      *
%************************************************************************

Note [Evidence field of CtEvidence]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During constraint solving we never look at the type of ctev_evtm, or
ctev_evar; instead we look at the cte_pred field.  The evtm/evar field
may be un-zonked.

\begin{code}
<pre><a name="line-1"></a><a name="CtEvidence"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>      <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-3"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span>          <span class='hs-comment'>-- See Note [Evidence field of CtEvidence]</span>
<a name="line-4"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>    <span class='hs-comment'>-- Truly given, not depending on subgoals</span>
<a name="line-6"></a>    <span class='hs-comment'>-- NB: Spontaneous unifications belong here</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>     <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-9"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span>          <span class='hs-comment'>-- See Note [Evidence field of CtEvidence]</span>
<a name="line-10"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>    <span class='hs-comment'>-- Wanted goal</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>
<a name="line-14"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>    <span class='hs-comment'>-- A goal that we don't really have to solve and can't immediately</span>
<a name="line-16"></a>    <span class='hs-comment'>-- rewrite anything other than a derived (there's no evidence!)</span>
<a name="line-17"></a>    <span class='hs-comment'>-- but if we do manage to solve it may help in solving other goals.</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="ctEvPred"></a><span class='hs-definition'>ctEvPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span>
<a name="line-20"></a><span class='hs-comment'>-- The predicate of a flavor</span>
<a name="line-21"></a><span class='hs-definition'>ctEvPred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_pred</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="ctEvTerm"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-24"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span>
<a name="line-25"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>ev</span>
<a name="line-26"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvTerm: derived constraint cannot have id"</span>
<a name="line-27"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="ctEvCheckDepth"></a><span class='hs-comment'>-- | Checks whether the evidence can be used to solve a goal with the given minimum depth</span>
<a name="line-30"></a><span class='hs-definition'>ctEvCheckDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-31"></a><span class='hs-definition'>ctEvCheckDepth</span> <span class='hs-keyword'>_</span>      <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- Given evidence has infinite depth</span>
<a name="line-32"></a><span class='hs-definition'>ctEvCheckDepth</span> <span class='hs-varid'>min</span> <span class='hs-varid'>ev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>min</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ctLocDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev_loc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-definition'>ctEvCheckDepth</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>ev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvCheckDepth: cannot consider derived evidence"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="ctEvId"></a><span class='hs-definition'>ctEvId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span>
<a name="line-36"></a><span class='hs-definition'>ctEvId</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-37"></a><span class='hs-definition'>ctEvId</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvId:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyword'>where</span>
<a name="line-40"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span>
<a name="line-41"></a>             <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[G]"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev_evtm</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_pty</span>
<a name="line-42"></a>             <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[W]"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev_evar</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_pty</span>
<a name="line-43"></a>             <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[D]"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"_"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_pty</span>
<a name="line-44"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>ppr_pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="isWanted"></a><span class='hs-definition'>isWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-47"></a><span class='hs-definition'>isWanted</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-48"></a><span class='hs-definition'>isWanted</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="isGiven"></a><span class='hs-definition'>isGiven</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-51"></a><span class='hs-definition'>isGiven</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-52"></a><span class='hs-definition'>isGiven</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="isDerived"></a><span class='hs-definition'>isDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-55"></a><span class='hs-definition'>isDerived</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-56"></a><span class='hs-definition'>isDerived</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="canRewrite"></a><span class='hs-comment'>-----------------------------------------</span>
<a name="line-59"></a><span class='hs-definition'>canRewrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-60"></a><span class='hs-comment'>-- Very important function!</span>
<a name="line-61"></a><span class='hs-comment'>-- See Note [canRewrite and canRewriteOrSame]</span>
<a name="line-62"></a><span class='hs-definition'>canRewrite</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-63"></a><span class='hs-definition'>canRewrite</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-64"></a><span class='hs-definition'>canRewrite</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- Derived can't solve wanted/given</span>
<a name="line-65"></a><span class='hs-definition'>canRewrite</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>             <span class='hs-comment'>-- No evidence for a derived, anyway</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="canRewriteOrSame"></a><span class='hs-definition'>canRewriteOrSame</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-68"></a><span class='hs-definition'>canRewriteOrSame</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-69"></a><span class='hs-definition'>canRewriteOrSame</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-70"></a><span class='hs-definition'>canRewriteOrSame</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-71"></a><span class='hs-definition'>canRewriteOrSame</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-72"></a><span class='hs-definition'>canRewriteOrSame</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

See Note [canRewrite and canRewriteOrSame]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(canRewrite ct1 ct2) holds if the constraint ct1 can be used to solve ct2.
"To solve" means a reaction where the active parts of the two constraints match.
   active(F xis ~ xi) = F xis
   active(tv ~ xi)    = tv
   active(D xis)      = D xis
   active(IP nm ty)   = nm

At the moment we don't allow Wanteds to rewrite Wanteds, because that can give
rise to very confusing type error messages.  A good example is Trac #8450.
Here's another
   f :: a -> Bool
   f x = ( [x,'c'], [x,True] ) `seq` True
Here we get
  [W] a ~ Char
  [W] a ~ Bool
but we do not want to complain about Bool ~ Char!

NB:  either (a `canRewrite` b) or (b `canRewrite` a)
         or a==b
     must hold

canRewriteOrSame is similar but returns True for Wanted/Wanted.
See the call sites for explanations.

%************************************************************************
%*                                                                      *
            SubGoalDepth
%*                                                                      *
%************************************************************************

Note [SubGoalDepth]
~~~~~~~~~~~~~~~~~~~
The 'SubGoalCounter' takes care of stopping the constraint solver from looping.
Because of the different use-cases of regular constaints and type function
applications, there are two independent counters. Therefore, this datatype is
abstract. See Note [WorkList]

Each counter starts at zero and increases.

* The "dictionary constraint counter" counts the depth of type class
  instance declarations.  Example:
     [W] d{7} : Eq [Int]
  That is d's dictionary-constraint depth is 7.  If we use the instance
     $dfEqList :: Eq a => Eq [a]
  to simplify it, we get
     d{7} = $dfEqList d'{8}
  where d'{8} : Eq Int, and d' has dictionary-constraint depth 8.

  For civilised (decidable) instance declarations, each increase of
  depth removes a type constructor from the type, so the depth never
  gets big; i.e. is bounded by the structural depth of the type.

  The flag -fcontext-stack=n (not very well named!) fixes the maximium
  level.

* The "type function reduction counter" does the same thing when resolving
* qualities involving type functions. Example:
  Assume we have a wanted at depth 7:
    [W] d{7} : F () ~ a
  If thre is an type function equation "F () = Int", this would be rewritten to
    [W] d{8} : Int ~ a
  and remembered as having depth 8.

  Again, without UndecidableInstances, this counter is bounded, but without it
  can resolve things ad infinitum. Hence there is a maximum level. But we use a
  different maximum, as we expect possibly many more type function reductions
  in sensible programs than type class constraints.

  The flag -ftype-function-depth=n fixes the maximium level.

\begin{code}
<pre><a name="line-1"></a><a name="SubGoalCounter"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CountConstraints</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CountTyFunApps</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="SubGoalDepth"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SubGoalDepth</span>  <span class='hs-comment'>-- See Note [SubGoalDepth]</span>
<a name="line-4"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-5"></a>         <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>      <span class='hs-comment'>-- Dictionary constraints</span>
<a name="line-6"></a>         <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>      <span class='hs-comment'>-- Type function reductions</span>
<a name="line-7"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyword'>where</span>
<a name="line-10"></a> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>angleBrackets</span> <span class='hs-varop'>$</span>
<a name="line-11"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'C'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-12"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'F'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>f</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="initialSubGoalDepth"></a><span class='hs-definition'>initialSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-15"></a><span class='hs-definition'>initialSubGoalDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="maxSubGoalDepth"></a><span class='hs-definition'>maxSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-18"></a><span class='hs-definition'>maxSubGoalDepth</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxtStkDepth</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyFunStkDepth</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="bumpSubGoalDepth"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-21"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-conid'>CountConstraints</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-22"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-conid'>CountTyFunApps</span>   <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="subGoalCounterValue"></a><span class='hs-definition'>subGoalCounterValue</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-25"></a><span class='hs-definition'>subGoalCounterValue</span> <span class='hs-conid'>CountConstraints</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-26"></a><span class='hs-definition'>subGoalCounterValue</span> <span class='hs-conid'>CountTyFunApps</span>   <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="subGoalDepthExceeded"></a><span class='hs-definition'>subGoalDepthExceeded</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SubGoalCounter</span>
<a name="line-29"></a><span class='hs-definition'>subGoalDepthExceeded</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>mc</span> <span class='hs-varid'>mf</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-30"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>mc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>CountConstraints</span>
<a name="line-31"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>mf</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>CountTyFunApps</span>
<a name="line-32"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

Note [Preventing recursive dictionaries]

We have some classes where it is not very useful to build recursive
dictionaries (Coercible, at the moment). So we need the constraint solver to
prevent that. We conservatively ensure this property using the subgoal depth of
the constraints: When solving a Coercible constraint at depth d, we do not
consider evidence from a depth <= d as suitable.

Therefore we need to record the minimum depth allowed to solve a CtWanted. This
is done in the SubGoalDepth field of CtWanted. Most code now uses mkCtWanted,
which initializes it to initialSubGoalDepth (i.e. 0); but when requesting a
Coercible instance (requestCoercible in TcInteract), we bump the current depth
by one and use that.

There are two spots where wanted contraints attempted to be solved using
existing constraints; doTopReactDict in TcInteract (in the general solver) and
newWantedEvVarNonrec (only used by requestCoercible) in TcSMonad. Both use
ctEvCheckDepth to make the check. That function ensures that a Given constraint
can always be used to solve a goal (i.e. they are at depth infinity, for our
purposes)


%************************************************************************
%*                                                                      *
            CtLoc
%*                                                                      *
%************************************************************************

The 'CtLoc' gives information about where a constraint came from.
This is important for decent error message reporting because
dictionaries don't appear in the original source code.
type will evolve...

\begin{code}
<pre><a name="line-1"></a><a name="CtLoc"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-3"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_depth</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>}</span>
<a name="line-4"></a>  <span class='hs-comment'>-- The TcLclEnv includes particularly</span>
<a name="line-5"></a>  <span class='hs-comment'>--    source location:  tcl_loc   :: SrcSpan</span>
<a name="line-6"></a>  <span class='hs-comment'>--    context:          tcl_ctxt  :: [ErrCtxt]</span>
<a name="line-7"></a>  <span class='hs-comment'>--    binder stack:     tcl_bndrs :: [TcIdBinders]</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="mkGivenLoc"></a><span class='hs-definition'>mkGivenLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-10"></a><span class='hs-definition'>mkGivenLoc</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>skol_info</span>
<a name="line-11"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-12"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initialSubGoalDepth</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="ctLocEnv"></a><span class='hs-definition'>ctLocEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-15"></a><span class='hs-definition'>ctLocEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_env</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="ctLocDepth"></a><span class='hs-definition'>ctLocDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-18"></a><span class='hs-definition'>ctLocDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_depth</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="ctLocOrigin"></a><span class='hs-definition'>ctLocOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-21"></a><span class='hs-definition'>ctLocOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_origin</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="ctLocSpan"></a><span class='hs-definition'>ctLocSpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-24"></a><span class='hs-definition'>ctLocSpan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>lcl</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="bumpCtLocDepth"></a><span class='hs-definition'>bumpCtLocDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-27"></a><span class='hs-definition'>bumpCtLocDepth</span> <span class='hs-varid'>cnt</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpSubGoalDepth</span> <span class='hs-varid'>cnt</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="setCtLocOrigin"></a><span class='hs-definition'>setCtLocOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-30"></a><span class='hs-definition'>setCtLocOrigin</span> <span class='hs-varid'>ctl</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="setCtLocEnv"></a><span class='hs-definition'>setCtLocEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-33"></a><span class='hs-definition'>setCtLocEnv</span> <span class='hs-varid'>ctl</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="pushErrCtxt"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-36"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-varid'>o</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="pushErrCtxtSameOrigin"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-40"></a><span class='hs-comment'>-- Just add information w/o updating the origin!</span>
<a name="line-41"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="pprArising"></a><span class='hs-definition'>pprArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-45"></a><span class='hs-comment'>-- Used for the main, top-level error message</span>
<a name="line-46"></a><span class='hs-comment'>-- We've done special processing for TypeEq and FunDep origins</span>
<a name="line-47"></a><span class='hs-definition'>pprArising</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-48"></a><span class='hs-definition'>pprArising</span> <span class='hs-conid'>FunDepOrigin</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-49"></a><span class='hs-definition'>pprArising</span> <span class='hs-varid'>orig</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"arising from"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="pprArisingAt"></a><span class='hs-definition'>pprArisingAt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-52"></a><span class='hs-definition'>pprArisingAt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"arising from"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>o</span>
<a name="line-54"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                SkolemInfo
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="SkolemInfo"></a><span class='hs-comment'>-- SkolemInfo gives the origin of *given* constraints</span>
<a name="line-2"></a><a name="SkolemInfo"></a><span class='hs-comment'>--   a) type variables are skolemised</span>
<a name="line-3"></a><a name="SkolemInfo"></a><span class='hs-comment'>--   b) an implication constraint is generated</span>
<a name="line-4"></a><a name="SkolemInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-conid'>UserTypeCtxt</span>        <span class='hs-comment'>-- A skolem that is created by instantiating</span>
<a name="line-6"></a>            <span class='hs-conid'>Type</span>                <span class='hs-comment'>-- a programmer-supplied type signature</span>
<a name="line-7"></a>                                <span class='hs-comment'>-- Location of the binding site is on the TyVar</span>
<a name="line-8"></a>
<a name="line-9"></a>        <span class='hs-comment'>-- The rest are for non-scoped skolems</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClsSkol</span> <span class='hs-conid'>Class</span>       <span class='hs-comment'>-- Bound at a class decl</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstSkol</span>            <span class='hs-comment'>-- Bound at an instance decl</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataSkol</span>            <span class='hs-comment'>-- Bound at a data type declaration</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamInstSkol</span>         <span class='hs-comment'>-- Bound at a family instance decl</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSkol</span>             <span class='hs-comment'>-- An existential type variable bound by a pattern for</span>
<a name="line-15"></a>      <span class='hs-conid'>ConLike</span>           <span class='hs-comment'>-- a data constructor with an existential type.</span>
<a name="line-16"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-17"></a>             <span class='hs-comment'>-- e.g.   data T = forall a. Eq a =&gt; MkT a</span>
<a name="line-18"></a>             <span class='hs-comment'>--        f (MkT x) = ...</span>
<a name="line-19"></a>             <span class='hs-comment'>-- The pattern MkT x will allocate an existential type</span>
<a name="line-20"></a>             <span class='hs-comment'>-- variable for 'a'.</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowSkol</span>           <span class='hs-comment'>-- An arrow form (see TcArrows)</span>
<a name="line-23"></a>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IPSkol</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsIPName</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Binding site of an implicit parameter</span>
<a name="line-25"></a>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuleSkol</span> <span class='hs-conid'>RuleName</span>   <span class='hs-comment'>-- The LHS of a RULE</span>
<a name="line-27"></a>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InferSkol</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>                        <span class='hs-comment'>-- We have inferred a type for these (mutually-recursivive)</span>
<a name="line-30"></a>                        <span class='hs-comment'>-- polymorphic Ids, and are now checking that their RHS</span>
<a name="line-31"></a>                        <span class='hs-comment'>-- constraints are satisfied.</span>
<a name="line-32"></a>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BracketSkol</span>         <span class='hs-comment'>-- Template Haskell bracket</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnifyForAllSkol</span>     <span class='hs-comment'>-- We are unifying two for-all types</span>
<a name="line-36"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- The instantiated skolem variables</span>
<a name="line-37"></a>       <span class='hs-conid'>TcType</span>           <span class='hs-comment'>-- The instantiated type *inside* the forall</span>
<a name="line-38"></a>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnkSkol</span>             <span class='hs-comment'>-- Unhelpful info (until I improve it)</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprSkolInfo</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="pprSkolInfo"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-45"></a><span class='hs-comment'>-- Complete the sentence "is a rigid type variable bound by..."</span>
<a name="line-46"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the type signature for"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>                                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>cx</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-50"></a>                                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPSkol</span> <span class='hs-varid'>ips</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the implicit-parameter bindings for"</span><span class='hs-layout'>)</span>
<a name="line-52"></a>                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ips</span>
<a name="line-53"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClsSkol</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the class declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>InstSkol</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the instance declaration"</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>DataSkol</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the data type declaration"</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>FamInstSkol</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the family instance declaration"</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>BracketSkol</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a Template Haskell bracket"</span><span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleSkol</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the RULE"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ftext</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>ArrowSkol</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the arrow form"</span><span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSkol</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>mc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cl</span> <span class='hs-keyword'>of</span>
<a name="line-61"></a>    <span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern with constructor"</span><span class='hs-layout'>)</span>
<a name="line-62"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-63"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-64"></a>                            <span class='hs-comment'>-- pprType prints forall's regardless of -fprint-explict-foralls</span>
<a name="line-65"></a>                            <span class='hs-comment'>-- which is what we want here, since we might be saying</span>
<a name="line-66"></a>                            <span class='hs-comment'>-- type variable 't' is bound by ...</span>
<a name="line-67"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprMatchContext</span> <span class='hs-varid'>mc</span> <span class='hs-keyglyph'>]</span>
<a name="line-68"></a>    <span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern with pattern synonym"</span><span class='hs-layout'>)</span>
<a name="line-69"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ps</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-70"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynType</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-71"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprMatchContext</span> <span class='hs-varid'>mc</span> <span class='hs-keyglyph'>]</span>
<a name="line-72"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the inferred type of"</span><span class='hs-layout'>)</span>
<a name="line-73"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-74"></a>                                         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-comment'>-- UnkSkol</span>
<a name="line-78"></a><span class='hs-comment'>-- For type variables the others are dealt with by pprSkolTvBinding.</span>
<a name="line-79"></a><span class='hs-comment'>-- For Insts, these cases should not happen</span>
<a name="line-80"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"pprSkolInfo: UnkSkol"</span> <span class='hs-layout'>)</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"UnkSkol"</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
            CtOrigin
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="CtOrigin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FlatSkolOrigin</span>              <span class='hs-comment'>-- Flatten-skolems created for Givens</span>
<a name="line-4"></a>                                <span class='hs-comment'>-- Note [When does an implication have given equalities?]</span>
<a name="line-5"></a>                                <span class='hs-comment'>-- in TcSimplify</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-comment'>-- All the others are for *wanted* constraints</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccurrenceOf</span> <span class='hs-conid'>Name</span>           <span class='hs-comment'>-- Occurrence of an overloaded identifier</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppOrigin</span>                   <span class='hs-comment'>-- An application of some kind</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SpecPragOrigin</span> <span class='hs-conid'>Name</span>         <span class='hs-comment'>-- Specialisation pragma for identifier</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>
<a name="line-14"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KindEqOrigin</span>
<a name="line-16"></a>      <span class='hs-conid'>TcType</span> <span class='hs-conid'>TcType</span>             <span class='hs-comment'>-- A kind equality arising from unifying these two types</span>
<a name="line-17"></a>      <span class='hs-conid'>CtOrigin</span>                  <span class='hs-comment'>-- originally arising from this</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IPOccOrigin</span>  <span class='hs-conid'>HsIPName</span>       <span class='hs-comment'>-- Occurrence of an implicit parameter</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LiteralOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Occurrence of a literal</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NegateOrigin</span>                        <span class='hs-comment'>-- Occurrence of syntactic negation</span>
<a name="line-23"></a>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- [x..], [x..y] etc</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PArrSeqOrigin</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- [:x..y:] and [:x,y..z:]</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SectionOrigin</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TupleOrigin</span>                        <span class='hs-comment'>-- (..,..)</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AmbigOrigin</span> <span class='hs-conid'>UserTypeCtxt</span>    <span class='hs-comment'>-- Will be FunSigCtxt, InstDeclCtxt, or SpecInstCtxt</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ExprSigOrigin</span>       <span class='hs-comment'>-- e :: ty</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSigOrigin</span>        <span class='hs-comment'>-- p :: ty</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatOrigin</span>           <span class='hs-comment'>-- Instantiating a polytyped pattern at a constructor</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecordUpdOrigin</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ViewPatOrigin</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ScOrigin</span>            <span class='hs-comment'>-- Typechecking superclasses of an instance declaration</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOrigin</span>         <span class='hs-comment'>-- Typechecking deriving</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOriginDC</span> <span class='hs-conid'>DataCon</span> <span class='hs-conid'>Int</span>
<a name="line-38"></a>                        <span class='hs-comment'>-- Checking constraints arising from this data con and field index</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOriginCoerce</span> <span class='hs-conid'>Id</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>
<a name="line-40"></a>                        <span class='hs-comment'>-- DerivOriginCoerce id ty1 ty2: Trying to coerce class method `id` from</span>
<a name="line-41"></a>                        <span class='hs-comment'>-- `ty1` to `ty2`.</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StandAloneDerivOrigin</span> <span class='hs-comment'>-- Typechecking stand-alone deriving</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DefaultOrigin</span>       <span class='hs-comment'>-- Typechecking a default decl</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DoOrigin</span>            <span class='hs-comment'>-- Arising from a do expression</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MCompOrigin</span>         <span class='hs-comment'>-- Arising from a monad comprehension</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfOrigin</span>            <span class='hs-comment'>-- Arising from an if statement</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ProcOrigin</span>          <span class='hs-comment'>-- Arising from a proc expression</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnnOrigin</span>           <span class='hs-comment'>-- An annotation</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunDepOrigin</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleOrigin</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnboundOccurrenceOf</span> <span class='hs-conid'>RdrName</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ListOrigin</span>          <span class='hs-comment'>-- An overloaded list</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="pprO"></a><span class='hs-definition'>pprO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-55"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sk</span>
<a name="line-56"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>FlatSkolOrigin</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a given flatten-skolem"</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOf</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-58"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>AppOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an application"</span><span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPragOrigin</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a specialisation pragma for"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-60"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPOccOrigin</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of implicit parameter"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-61"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>RecordUpdOrigin</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a record update"</span><span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>AmbigOrigin</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the ambiguity check for"</span><span class='hs-layout'>)</span>
<a name="line-63"></a>                             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-64"></a>                                    <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-65"></a>                                    <span class='hs-conid'>InfSigCtxt</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-66"></a>                                    <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span>
<a name="line-67"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>ExprSigOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an expression type signature"</span><span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>PatSigOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern type signature"</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>PatOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern"</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>ViewPatOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a view pattern"</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>IfOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an if statement"</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiteralOrigin</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the literal"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-73"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the arithmetic sequence"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-74"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the parallel array sequence"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>SectionOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an operator section"</span><span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>TupleOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span>
<a name="line-77"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>NegateOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of syntactic negation"</span><span class='hs-layout'>)</span>
<a name="line-78"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>ScOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the superclasses of an instance declaration"</span><span class='hs-layout'>)</span>
<a name="line-79"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>DerivOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the 'deriving' clause of a data type declaration"</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivOriginDC</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span>
<a name="line-81"></a>                                    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"field of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-82"></a>                                    <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-83"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivOriginCoerce</span> <span class='hs-varid'>meth</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the coercion"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of the method"</span><span class='hs-layout'>)</span>
<a name="line-86"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>meth</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"from type"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-87"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to type"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-88"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>StandAloneDerivOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a 'deriving' declaration"</span><span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>DefaultOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a 'default' declaration"</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>DoOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a do statement"</span><span class='hs-layout'>)</span>
<a name="line-91"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>MCompOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a statement in a monad comprehension"</span><span class='hs-layout'>)</span>
<a name="line-92"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>ProcOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a proc expression"</span><span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a type equality"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-94"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a kind equality arising from"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-95"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>AnnOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an annotation"</span><span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>FunDepOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a functional dependency"</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>HoleOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-definition'>pprO</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnboundOccurrenceOf</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an undeclared identifier"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-99"></a><span class='hs-definition'>pprO</span> <span class='hs-conid'>ListOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an overloaded list"</span><span class='hs-layout'>)</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyword'>where</span>
<a name="line-102"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprO</span>
</pre>\end{code}
</body>
</html>
