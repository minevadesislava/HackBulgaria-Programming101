<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSplice.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

TcSplice: Template Haskell splices


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSplice</span><span class='hs-layout'>(</span>
<a name="line-4"></a>     <span class='hs-comment'>-- These functions are defined in stage1 and stage2</span>
<a name="line-5"></a>     <span class='hs-comment'>-- The raise civilised errors in stage1</span>
<a name="line-6"></a>     <span class='hs-varid'>tcSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypedBracket</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUntypedBracket</span><span class='hs-layout'>,</span>
<a name="line-7"></a>     <span class='hs-varid'>runQuasiQuoteExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>runQuasiQuotePat</span><span class='hs-layout'>,</span>
<a name="line-8"></a>     <span class='hs-varid'>runQuasiQuoteDecl</span><span class='hs-layout'>,</span> <span class='hs-varid'>runQuasiQuoteType</span><span class='hs-layout'>,</span>
<a name="line-9"></a>     <span class='hs-varid'>runAnnotation</span><span class='hs-layout'>,</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-12"></a>     <span class='hs-comment'>-- These ones are defined only in stage2, and are</span>
<a name="line-13"></a>     <span class='hs-comment'>-- called only in stage2 (ie GHCI is on)</span>
<a name="line-14"></a>     <span class='hs-varid'>runMetaE</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaP</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaT</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMetaD</span><span class='hs-layout'>,</span> <span class='hs-varid'>runQuasi</span><span class='hs-layout'>,</span>
<a name="line-15"></a>     <span class='hs-varid'>tcTopSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupThName_maybe</span><span class='hs-layout'>,</span>
<a name="line-16"></a><span class='hs-cpp'>#endif</span>
<a name="line-17"></a>      <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscMain</span>
<a name="line-30"></a>        <span class='hs-comment'>-- These imports are the reason that TcSplice</span>
<a name="line-31"></a>        <span class='hs-comment'>-- is very high up the module hierarchy</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Convert</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnExpr</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnTypes</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcExpr</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hooks</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>patSynName</span> <span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsExpr</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Serialized</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span><span class='hs-layout'>(</span> <span class='hs-conid'>MaybeErr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>when</span> <span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMeta</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-89"></a><span class='hs-comment'>-- THSyntax gives access to internal functions and data types</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-comment'>-- Because GHC.Desugar might not be in the base library of the bootstrapping compiler</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Desugar</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>AnnotationWrapper</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dynamic</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>fromDynamic</span><span class='hs-layout'>,</span> <span class='hs-varid'>toDyn</span> <span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>(</span> <span class='hs-varid'>typeOf</span> <span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Exts</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-layout'>)</span>
<a name="line-100"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Main interface + stubs for the non-GHCI case
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcTypedBracket"></a><span class='hs-definition'>tcTypedBracket</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-2"></a><a name="tcUntypedBracket"></a><span class='hs-definition'>tcUntypedBracket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-3"></a><a name="tcSpliceExpr"></a><span class='hs-definition'>tcSpliceExpr</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-4"></a>        <span class='hs-comment'>-- None of these functions add constraints to the LIE</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="runQuasiQuoteExpr"></a><span class='hs-definition'>runQuasiQuoteExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsQuasiQuote</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-7"></a><a name="runQuasiQuotePat"></a><span class='hs-definition'>runQuasiQuotePat</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsQuasiQuote</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-8"></a><a name="runQuasiQuoteType"></a><span class='hs-definition'>runQuasiQuoteType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsQuasiQuote</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-9"></a><a name="runQuasiQuoteDecl"></a><span class='hs-definition'>runQuasiQuoteDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsQuasiQuote</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="runAnnotation"></a><span class='hs-definition'>runAnnotation</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreAnnTarget</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Annotation</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-cpp'>#ifndef GHCI</span>
<a name="line-14"></a><span class='hs-definition'>tcTypedBracket</span>   <span class='hs-varid'>x</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>x</span> <span class='hs-str'>"Template Haskell bracket"</span>
<a name="line-15"></a><span class='hs-definition'>tcUntypedBracket</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>x</span> <span class='hs-str'>"Template Haskell bracket"</span>
<a name="line-16"></a><span class='hs-definition'>tcSpliceExpr</span>  <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>e</span> <span class='hs-str'>"Template Haskell splice"</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>runQuasiQuoteExpr</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>q</span> <span class='hs-str'>"quasiquote"</span>
<a name="line-19"></a><span class='hs-definition'>runQuasiQuotePat</span>  <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>q</span> <span class='hs-str'>"pattern quasiquote"</span>
<a name="line-20"></a><span class='hs-definition'>runQuasiQuoteType</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>q</span> <span class='hs-str'>"type quasiquote"</span>
<a name="line-21"></a><span class='hs-definition'>runQuasiQuoteDecl</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>q</span> <span class='hs-str'>"declaration quasiquote"</span>
<a name="line-22"></a><span class='hs-definition'>runAnnotation</span>   <span class='hs-keyword'>_</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failTH</span> <span class='hs-varid'>q</span> <span class='hs-str'>"annotation"</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-cpp'>#else</span>
<a name="line-25"></a>  <span class='hs-comment'>-- The whole of the rest of the file is the else-branch (ie stage2 only)</span>
</pre>\end{code}


Note [How top-level splices are handled]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Top-level splices (those not inside a [| .. |] quotation bracket) are handled
very straightforwardly:

  1. tcTopSpliceExpr: typecheck the body e of the splice $(e)

  2. runMetaT: desugar, compile, run it, and convert result back to
     HsSyn RdrName (of the appropriate flavour, eg HsType RdrName,
     HsExpr RdrName etc)

  3. treat the result as if that's what you saw in the first place
     e.g for HsType, rename and kind-check
         for HsExpr, rename and type-check

     (The last step is different for decls, because they can *only* be
      top-level: we return the result of step 2.)

Note [How brackets and nested splices are handled]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Nested splices (those inside a [| .. |] quotation bracket),
are treated quite differently.

Remember, there are two forms of bracket
         typed   [|| e ||]
   and untyped   [|  e  |]

The life cycle of a typed bracket:
   * Starts as HsBracket

   * When renaming:
        * Set the ThStage to (Brack s RnPendingTyped)
        * Rename the body
        * Result is still a HsBracket

   * When typechecking:
        * Set the ThStage to (Brack s (TcPending ps_var lie_var))
        * Typecheck the body, and throw away the elaborated result
        * Nested splices (which must be typed) are typechecked, and
          the results accumulated in ps_var; their constraints
          accumulate in lie_var
        * Result is a HsTcBracketOut rn_brack pending_splices
          where rn_brack is the incoming renamed bracket

The life cycle of a un-typed bracket:
   * Starts as HsBracket

   * When renaming:
        * Set the ThStage to (Brack s (RnPendingUntyped ps_var))
        * Rename the body
        * Nested splices (which must be untyped) are renamed, and the
          results accumulated in ps_var
        * Result is still (HsRnBracketOut rn_body pending_splices)

   * When typechecking a HsRnBracketOut
        * Typecheck the pending_splices individually
        * Ignore the body of the bracket; just check that the context
          expects a bracket of that type (e.g. a [p| pat |] bracket should
          be in a context needing a (Q Pat)
        * Result is a HsTcBracketOut rn_brack pending_splices
          where rn_brack is the incoming renamed bracket


In both cases, desugaring happens like this:
  * HsTcBracketOut is desugared by DsMeta.dsBracket.  It

      a) Extends the ds_meta environment with the PendingSplices
         attached to the bracket

      b) Converts the quoted (HsExpr Name) to a CoreExpr that, when
         run, will produce a suitable TH expression/type/decl.  This
         is why we leave the *renamed* expression attached to the bracket:
         the quoted expression should not be decorated with all the goop
         added by the type checker

  * Each splice carries a unique Name, called a "splice point", thus
    ${n}(e).  The name is initialised to an (Unqual "splice") when the
    splice is created; the renamer gives it a unique.

  * When DsMeta (used to desugar the body of the bracket) comes across
    a splice, it looks up the splice's Name, n, in the ds_meta envt,
    to find an (HsExpr Id) that should be substituted for the splice;
    it just desugars it to get a CoreExpr (DsMeta.repSplice).

Example:
    Source:       f = [| Just $(g 3) |]
      The [| |] part is a HsBracket

    Typechecked:  f = [| Just ${s7}(g 3) |]{s7 = g Int 3}
      The [| |] part is a HsBracketOut, containing *renamed*
        (not typechecked) expression
      The "s7" is the "splice point"; the (g Int 3) part
        is a typechecked expression

    Desugared:    f = do { s7 <- g Int 3
                         ; return (ConE "Data.Maybe.Just" s7) }


Note [Template Haskell state diagram]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here are the ThStages, s, their corresponding level numbers
(the result of (thLevel s)), and their state transitions.

      -----------     $      ------------   $
      |  Comp   | ---------> |  Splice  | -----|
      |   1     |            |    0     | <----|
      -----------            ------------
        ^     |                ^      |
      $ |     | [||]         $ |      | [||]
        |     v                |      v
   --------------          ----------------
   | Brack Comp |          | Brack Splice |
   |     2      |          |      1       |
   --------------          ----------------

* Normal top-level declarations start in state Comp
       (which has level 1).
  Annotations start in state Splice, since they are
       treated very like a splice (only without a '$')

* Code compiled in state Splice (and only such code)
  will be *run at compile time*, with the result replacing
  the splice

* The original paper used level -1 instead of 0, etc.

* The original paper did not allow a splice within a
  splice, but there is no reason not to. This is the
  $ transition in the top right.

Note [Template Haskell levels]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Imported things are impLevel (= 0)

* However things at level 0 are not *necessarily* imported.
      eg  $( \b -> ... )   here b is bound at level 0

* In GHCi, variables bound by a previous command are treated
  as impLevel, because we have bytecode for them.

* Variables are bound at the "current level"

* The current level starts off at outerLevel (= 1)

* The level is decremented by splicing $(..)
               incremented by brackets [| |]
               incremented by name-quoting 'f

When a variable is used, we compare
        bind:  binding level, and
        use:   current level at usage site

  Generally
        bind > use      Always error (bound later than used)
                        [| \x -> $(f x) |]

        bind = use      Always OK (bound same stage as used)
                        [| \x -> $(f [| x |]) |]

        bind < use      Inside brackets, it depends
                        Inside splice, OK
                        Inside neither, OK

  For (bind < use) inside brackets, there are three cases:
    - Imported things   OK      f = [| map |]
    - Top-level things  OK      g = [| f |]
    - Non-top-level     Only if there is a liftable instance
                                h = \(x:Int) -> [| x |]

  To track top-level-ness we use the ThBindEnv in TcLclEnv

  For example:
           f = ...
           g1 = $(map ...)         is OK
           g2 = $(f ...)           is not OK; because we havn't compiled f yet


%************************************************************************
%*                                                                      *
\subsection{Quoting an expression}
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="tcTypedBracket"></a><span class='hs-comment'>-- See Note [How brackets and nested splices are handled]</span>
<a name="line-2"></a><span class='hs-comment'>-- tcTypedBracket :: HsBracket Name -&gt; TcRhoType -&gt; TcM (HsExpr TcId)</span>
<a name="line-3"></a><span class='hs-definition'>tcTypedBracket</span> <span class='hs-varid'>brack</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotationCtxtDoc</span> <span class='hs-varid'>brack</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-5"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cur_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps_ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>[]</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lie_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getConstraintVar</span>   <span class='hs-comment'>-- Any constraints arising from nested splices</span>
<a name="line-8"></a>                                       <span class='hs-comment'>-- should get thrown into the constraint set</span>
<a name="line-9"></a>                                       <span class='hs-comment'>-- from outside the bracket</span>
<a name="line-10"></a>
<a name="line-11"></a>       <span class='hs-comment'>-- Typecheck expr to make sure it is valid,</span>
<a name="line-12"></a>       <span class='hs-comment'>-- Throw away the typechecked expression but return its type.</span>
<a name="line-13"></a>       <span class='hs-comment'>-- We'll typecheck it again when we splice it in somewhere</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-sel'>_tc_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>cur_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPending</span> <span class='hs-varid'>ps_ref</span> <span class='hs-varid'>lie_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-15"></a>                                <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>expr</span> 
<a name="line-16"></a>                                <span class='hs-comment'>-- NC for no context; tcBracket does that</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>expr_ty</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>meta_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_ref</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>texpco</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>unsafeTExpCoerceName</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>texpco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-23"></a>                                               <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a><span class='hs-definition'>tcTypedBracket</span> <span class='hs-varid'>other_brack</span> <span class='hs-keyword'>_</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcTypedBracket"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other_brack</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="tcUntypedBracket"></a><span class='hs-comment'>-- tcUntypedBracket :: HsBracket Name -&gt; [PendingRnSplice] -&gt; TcRhoType -&gt; TcM (HsExpr TcId)</span>
<a name="line-28"></a><span class='hs-definition'>tcUntypedBracket</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>res_ty</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_bracket untyped"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>brack</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcPendingSplice</span> <span class='hs-varid'>ps</span>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>meta_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcBrackTy</span> <span class='hs-varid'>brack</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>meta_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_bracket done untyped"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>meta_ty</span><span class='hs-layout'>)</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-layout'>}</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="tcBrackTy"></a><span class='hs-comment'>---------------</span>
<a name="line-37"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-38"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>nameTyConName</span>  <span class='hs-comment'>-- Result type is Var (not Q-monadic)</span>
<a name="line-39"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExpBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>expQTyConName</span>  <span class='hs-comment'>-- Result type is ExpQ (= Q Exp)</span>
<a name="line-40"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>typeQTyConName</span> <span class='hs-comment'>-- Result type is Type (= Q Typ)</span>
<a name="line-41"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DecBrG</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>decsQTyConName</span> <span class='hs-comment'>-- Result type is Q [Dec]</span>
<a name="line-42"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>patQTyConName</span>  <span class='hs-comment'>-- Result type is PatQ (= Q Pat)</span>
<a name="line-43"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DecBrL</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcBrackTy: Unexpected DecBrL"</span>
<a name="line-44"></a><span class='hs-definition'>tcBrackTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TExpBr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcUntypedBracket: Unexpected TExpBr"</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="tcPendingSplice"></a><span class='hs-comment'>---------------</span>
<a name="line-47"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PendingRnSplice</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PendingTcSplice</span>
<a name="line-48"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnExpSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>expQTyConName</span>
<a name="line-50"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_pending_splice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-51"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnPatSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>patQTyConName</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_pending_splice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-54"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnTypeSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>typeQTyConName</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_pending_splice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-57"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnDeclSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>decsQTyConName</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_pending_splice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-definition'>tcPendingSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>PendingRnCrossStageSplice</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-62"></a>  <span class='hs-comment'>-- Behave like $(lift x); not very pretty</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>expQTyConName</span>
<a name="line-64"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_pending_splice</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>liftName</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="tc_pending_splice"></a><span class='hs-comment'>---------------</span>
<a name="line-67"></a><span class='hs-definition'>tc_pending_splice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PendingTcSplice</span>
<a name="line-68"></a><span class='hs-definition'>tc_pending_splice</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-70"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>splice_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="tcTExpTy"></a><span class='hs-comment'>---------------</span>
<a name="line-73"></a><span class='hs-comment'>-- Takes a type tau and returns the type Q (TExp tau)</span>
<a name="line-74"></a><span class='hs-definition'>tcTExpTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-75"></a><span class='hs-definition'>tcTExpTy</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-76"></a>    <span class='hs-varid'>q</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>qTyConName</span>
<a name="line-77"></a>    <span class='hs-varid'>texp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>tExpTyConName</span>
<a name="line-78"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>texp</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tau</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Splicing an expression}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcSpliceExpr"></a><span class='hs-definition'>tcSpliceExpr</span> <span class='hs-varid'>splice</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSplice</span> <span class='hs-varid'>name</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliceCtxtDoc</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-3"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>    <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStage</span>
<a name="line-5"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stage</span> <span class='hs-keyword'>of</span>
<a name="line-6"></a>        <span class='hs-conid'>Splice</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-7"></a>        <span class='hs-conid'>Comp</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-8"></a>        <span class='hs-conid'>Brack</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varid'>pend</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcNestedSplice</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varid'>pend</span> <span class='hs-varid'>name</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="tcNestedSplice"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PendingStuff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-11"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-comment'>-- See Note [How brackets and nested splices are handled]</span>
<a name="line-13"></a>    <span class='hs-comment'>-- A splice inside brackets</span>
<a name="line-14"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-varid'>pop_stage</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPending</span> <span class='hs-varid'>ps_var</span> <span class='hs-varid'>lie_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>splice_name</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setStage</span> <span class='hs-varid'>pop_stage</span> <span class='hs-varop'>$</span>
<a name="line-17"></a>                  <span class='hs-varid'>setConstraintVar</span> <span class='hs-varid'>lie_var</span> <span class='hs-varop'>$</span>
<a name="line-18"></a>                  <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>untypeq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>unTypeQName</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>expr''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsTyApp</span> <span class='hs-varid'>untypeq</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>res_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_var</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ps_var</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>splice_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr''</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a>       <span class='hs-comment'>-- The returned expression is ignored; it's in the pending splices</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"tcSpliceExpr"</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>tcNestedSplice</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>splice_name</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcNestedSplice: rename stage found"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>splice_name</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="tcTopSplice"></a><span class='hs-definition'>tcTopSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-definition'>tcTopSplice</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Typecheck the expression,</span>
<a name="line-33"></a>         <span class='hs-comment'>-- making sure it has type Q (T res_ty)</span>
<a name="line-34"></a>         <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTExpTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>True</span> <span class='hs-varop'>$</span>
<a name="line-36"></a>                          <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span>
<a name="line-37"></a>
<a name="line-38"></a>         <span class='hs-comment'>-- Run the expression</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaE</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>showSplice</span> <span class='hs-str'>"expression"</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a>         <span class='hs-comment'>-- Rename and typecheck the spliced-in expression,</span>
<a name="line-43"></a>         <span class='hs-comment'>-- making sure it has type res_ty</span>
<a name="line-44"></a>         <span class='hs-comment'>-- These steps should never fail; this is a *typed* splice</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spliceResultDoc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>       <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp3</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>exp4</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>exp3</span> <span class='hs-varid'>res_ty</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>exp4</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Error messages}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="quotationCtxtDoc"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBracket</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>quotationCtxtDoc</span> <span class='hs-varid'>br_body</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the Template Haskell quotation"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="spliceCtxtDoc"></a><span class='hs-definition'>spliceCtxtDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsSplice</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-7"></a><span class='hs-definition'>spliceCtxtDoc</span> <span class='hs-varid'>splice</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the Template Haskell splice"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTypedSplice</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="spliceResultDoc"></a><span class='hs-definition'>spliceResultDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-12"></a><span class='hs-definition'>spliceResultDoc</span> <span class='hs-varid'>expr</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the result of the splice:"</span><span class='hs-layout'>)</span>
<a name="line-14"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'$'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprParendExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-15"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To see what the splice expanded to, use -ddump-splices"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="tcTopSpliceExpr"></a><span class='hs-comment'>-------------------</span>
<a name="line-18"></a><span class='hs-definition'>tcTopSpliceExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-comment'>-- Note [How top-level splices are handled]</span>
<a name="line-20"></a><span class='hs-comment'>-- Type check an expression that is the body of a top-level splice</span>
<a name="line-21"></a><span class='hs-comment'>--   (the caller will compile and run it)</span>
<a name="line-22"></a><span class='hs-comment'>-- Note that set the level to Splice, regardless of the original level,</span>
<a name="line-23"></a><span class='hs-comment'>-- before typechecking the expression.  For example:</span>
<a name="line-24"></a><span class='hs-comment'>--      f x = $( ...$(g 3) ... )</span>
<a name="line-25"></a><span class='hs-comment'>-- The recursive call to tcMonoExpr will simply expand the</span>
<a name="line-26"></a><span class='hs-comment'>-- inner escape before dealing with the outer one</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>tcTopSpliceExpr</span> <span class='hs-varid'>isTypedSplice</span> <span class='hs-varid'>tc_action</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- checkNoErrs: must not try to run the thing</span>
<a name="line-30"></a>                   <span class='hs-comment'>-- if the type checker fails!</span>
<a name="line-31"></a>    <span class='hs-varid'>unsetGOptM</span> <span class='hs-conid'>Opt_DeferTypeErrors</span> <span class='hs-varop'>$</span>
<a name="line-32"></a>                   <span class='hs-comment'>-- Don't defer type errors.  Not only are we</span>
<a name="line-33"></a>                   <span class='hs-comment'>-- going to run this code, but we do an unsafe</span>
<a name="line-34"></a>                   <span class='hs-comment'>-- coerce, so we get a seg-fault if, say we</span>
<a name="line-35"></a>                   <span class='hs-comment'>-- splice a type into a place where an expression</span>
<a name="line-36"></a>                   <span class='hs-comment'>-- is expected (Trac #7276)</span>
<a name="line-37"></a>    <span class='hs-varid'>setStage</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-varid'>isTypedSplice</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-38"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>    <span class='hs-comment'>-- Typecheck the expression</span>
<a name="line-39"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varid'>tc_action</span>
<a name="line-40"></a>
<a name="line-41"></a>        <span class='hs-comment'>-- Solve the constraints</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>const_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>lie</span>
<a name="line-43"></a>
<a name="line-44"></a>          <span class='hs-comment'>-- Zonk it and tie the knot of dictionary bindings</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonkTopLExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsDictLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>const_binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Renamer errors]
~~~~~~~~~~~~~~~~~~~~~
It's important to wrap renamer calls in checkNoErrs, because the
renamer does not fail for out of scope variables etc. Instead it
returns a bogus term/type, so that it can report more than one error.
We don't want the type checker to see these bogus unbound variables.


%************************************************************************
%*                                                                      *
        Annotations
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="runAnnotation"></a><span class='hs-definition'>runAnnotation</span> <span class='hs-varid'>target</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2"></a>    <span class='hs-comment'>-- Find the classes we want instances for in order to call toAnnotationWrapper</span>
<a name="line-3"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-4"></a>    <span class='hs-varid'>data_class</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>dataClassName</span>
<a name="line-5"></a>    <span class='hs-varid'>to_annotation_wrapper_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>toAnnotationWrapperName</span>
<a name="line-6"></a>
<a name="line-7"></a>    <span class='hs-comment'>-- Check the instances we require live in another module (we want to execute it..)</span>
<a name="line-8"></a>    <span class='hs-comment'>-- and check identifiers live in other modules using TH stage checks. tcSimplifyStagedExpr</span>
<a name="line-9"></a>    <span class='hs-comment'>-- also resolves the LIE constraints to detect e.g. instance ambiguity</span>
<a name="line-10"></a>    <span class='hs-varid'>zonked_wrapped_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>False</span> <span class='hs-varop'>$</span>
<a name="line-11"></a>           <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>expr</span>
<a name="line-12"></a>                <span class='hs-comment'>-- We manually wrap the typechecked expression in a call to toAnnotationWrapper</span>
<a name="line-13"></a>                <span class='hs-comment'>-- By instantiating the call &gt;here&lt; it gets registered in the</span>
<a name="line-14"></a>                <span class='hs-comment'>-- LIE consulted by tcTopSpliceExpr</span>
<a name="line-15"></a>                <span class='hs-comment'>-- and hence ensures the appropriate dictionary is bound by const_binds</span>
<a name="line-16"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>wrapper</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-conid'>AnnOrigin</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>data_class</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>expr_ty</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>specialised_to_annotation_wrapper_expr</span>
<a name="line-18"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-varid'>wrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>to_annotation_wrapper_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>specialised_to_annotation_wrapper_expr</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-comment'>-- Run the appropriately wrapped expression to get the value of</span>
<a name="line-22"></a>    <span class='hs-comment'>-- the annotation and its dictionaries. The return value is of</span>
<a name="line-23"></a>    <span class='hs-comment'>-- type AnnotationWrapper by construction, so this conversion is</span>
<a name="line-24"></a>    <span class='hs-comment'>-- safe</span>
<a name="line-25"></a>    <span class='hs-varid'>flip</span> <span class='hs-varid'>runMetaAW</span> <span class='hs-varid'>zonked_wrapped_expr'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>annotation_wrapper</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-26"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>annotation_wrapper</span> <span class='hs-keyword'>of</span>
<a name="line-27"></a>            <span class='hs-conid'>AnnotationWrapper</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>serialized</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toSerialized</span> <span class='hs-varid'>serializeWithData</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-28"></a>                <span class='hs-comment'>-- Got the value and dictionaries: build the serialized value and</span>
<a name="line-29"></a>                <span class='hs-comment'>-- call it a day. We ensure that we seq the entire serialized value</span>
<a name="line-30"></a>                <span class='hs-comment'>-- in order that any errors in the user-written code for the</span>
<a name="line-31"></a>                <span class='hs-comment'>-- annotation are exposed at this point.  This is also why we are</span>
<a name="line-32"></a>                <span class='hs-comment'>-- doing all this stuff inside the context of runMeta: it has the</span>
<a name="line-33"></a>                <span class='hs-comment'>-- facilities to deal with user error in a meta-level expression</span>
<a name="line-34"></a>                <span class='hs-varid'>seqSerialized</span> <span class='hs-varid'>serialized</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>Annotation</span> <span class='hs-layout'>{</span>
<a name="line-35"></a>                    <span class='hs-varid'>ann_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span>
<a name="line-36"></a>                    <span class='hs-varid'>ann_value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>serialized</span>
<a name="line-37"></a>                <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Quasi-quoting
%*                                                                      *
%************************************************************************

Note [Quasi-quote overview]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
The GHC "quasi-quote" extension is described by Geoff Mainland's paper
"Why it's nice to be quoted: quasiquoting for Haskell" (Haskell
Workshop 2007).

Briefly, one writes
        [p| stuff |]
and the arbitrary string "stuff" gets parsed by the parser 'p', whose
type should be Language.Haskell.TH.Quote.QuasiQuoter.  'p' must be
defined in another module, because we are going to run it here.  It's
a bit like a TH splice:
        $(p "stuff")

However, you can do this in patterns as well as terms.  Because of this,
the splice is run by the *renamer* rather than the type checker.

%************************************************************************
%*                                                                      *
\subsubsection{Quasiquotation}
%*                                                                      *
%************************************************************************

See Note [Quasi-quote overview] in TcSplice.

\begin{code}
<pre><a name="line-1"></a><a name="runQuasiQuote"></a><span class='hs-definition'>runQuasiQuote</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>hs_syn</span>
<a name="line-2"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsQuasiQuote</span> <span class='hs-conid'>RdrName</span>   <span class='hs-comment'>-- Contains term of type QuasiQuoter, and the String</span>
<a name="line-3"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>                   <span class='hs-comment'>-- Of type QuasiQuoter -&gt; String -&gt; Q th_syn</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>                   <span class='hs-comment'>-- Name of th_syn type</span>
<a name="line-5"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MetaOps</span> <span class='hs-varid'>th_syn</span> <span class='hs-varid'>hs_syn</span>
<a name="line-6"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-varid'>hs_syn</span>
<a name="line-7"></a><span class='hs-definition'>runQuasiQuote</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuote</span> <span class='hs-varid'>quoter</span> <span class='hs-varid'>q_span</span> <span class='hs-varid'>quote</span><span class='hs-layout'>)</span> <span class='hs-varid'>quote_selector</span> <span class='hs-varid'>meta_ty</span> <span class='hs-varid'>meta_ops</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>     <span class='hs-comment'>-- Drop the leading "$" from the quoter name, if present</span>
<a name="line-9"></a>              <span class='hs-comment'>-- This is old-style syntax, now deprecated</span>
<a name="line-10"></a>              <span class='hs-comment'>-- NB: when removing this backward-compat, remove</span>
<a name="line-11"></a>              <span class='hs-comment'>--     the matching code in Lexer.x (around line 310)</span>
<a name="line-12"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>quoter</span><span class='hs-layout'>)</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>quoter</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>occ_str</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- Lexer ensures this</span>
<a name="line-14"></a>                    <span class='hs-keyword'>if</span> <span class='hs-varid'>head</span> <span class='hs-varid'>occ_str</span> <span class='hs-varop'>/=</span> <span class='hs-chr'>'$'</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>quoter</span>
<a name="line-15"></a>                    <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>deprecatedDollar</span> <span class='hs-varid'>quoter</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRdrUnqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>occ_str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>quoter'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccRn</span> <span class='hs-varid'>quoter</span>
<a name="line-19"></a>                <span class='hs-comment'>-- We use lookupOcc rather than lookupGlobalOcc because in the</span>
<a name="line-20"></a>                <span class='hs-comment'>-- erroneous case of \x -&gt; [x| ...|] we get a better error message</span>
<a name="line-21"></a>                <span class='hs-comment'>-- (stage restriction rather than out of scope).</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>quoter'</span><span class='hs-layout'>)</span> <span class='hs-varid'>failM</span>
<a name="line-24"></a>                <span class='hs-comment'>-- If 'quoter' is not in scope, proceed no further</span>
<a name="line-25"></a>                <span class='hs-comment'>-- The error message was generated by lookupOccRn, but it then</span>
<a name="line-26"></a>                <span class='hs-comment'>-- succeeds with an "unbound name", which makes the subsequent</span>
<a name="line-27"></a>                <span class='hs-comment'>-- attempt to run the quote fail in a confusing way</span>
<a name="line-28"></a>
<a name="line-29"></a>          <span class='hs-comment'>-- Check that the quoter is not locally defined, otherwise the TH</span>
<a name="line-30"></a>          <span class='hs-comment'>-- machinery will not be able to run the quasiquote.</span>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>is_local</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>quoter'</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>is_local</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>quoteStageError</span> <span class='hs-varid'>quoter'</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"runQQ"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>quoter</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>is_local</span><span class='hs-layout'>)</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>HsQuasiQuote</span> <span class='hs-varid'>quoter''</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>quote'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooked</span> <span class='hs-varid'>runQuasiQuoteHook</span> <span class='hs-varid'>return</span> <span class='hs-varop'>&gt;&gt;=</span>
<a name="line-37"></a>             <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-conid'>HsQuasiQuote</span> <span class='hs-varid'>quoter'</span> <span class='hs-varid'>q_span</span> <span class='hs-varid'>quote</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a>          <span class='hs-comment'>-- Build the expression</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>quoterExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>q_span</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>HsVar</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>quoter''</span>
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>quoteExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>q_span</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>HsLit</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>HsString</span> <span class='hs-varid'>quote'</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>q_span</span> <span class='hs-varop'>$</span>
<a name="line-43"></a>                     <span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>q_span</span> <span class='hs-varop'>$</span>
<a name="line-44"></a>                            <span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>q_span</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>quote_selector</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>quoterExpr</span><span class='hs-layout'>)</span> <span class='hs-varid'>quoteExpr</span>
<a name="line-45"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>meta_exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMetaTy</span> <span class='hs-varid'>meta_ty</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-comment'>-- Typecheck the expression</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_q_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTopSpliceExpr</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>meta_exp_ty</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-comment'>-- Run the expression</span>
<a name="line-51"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMetaQ</span> <span class='hs-varid'>meta_ops</span> <span class='hs-varid'>zonked_q_expr</span>
<a name="line-52"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>showSplice</span> <span class='hs-layout'>(</span><span class='hs-varid'>mt_desc</span> <span class='hs-varid'>meta_ops</span><span class='hs-layout'>)</span> <span class='hs-varid'>quoteExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="runQuasiQuoteExpr"></a><span class='hs-definition'>runQuasiQuoteExpr</span> <span class='hs-varid'>qq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runQuasiQuote</span> <span class='hs-varid'>qq</span> <span class='hs-varid'>quoteExpName</span>  <span class='hs-varid'>expQTyConName</span>  <span class='hs-varid'>exprMetaOps</span>
<a name="line-57"></a><a name="runQuasiQuotePat"></a><span class='hs-definition'>runQuasiQuotePat</span>  <span class='hs-varid'>qq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runQuasiQuote</span> <span class='hs-varid'>qq</span> <span class='hs-varid'>quotePatName</span>  <span class='hs-varid'>patQTyConName</span>  <span class='hs-varid'>patMetaOps</span>
<a name="line-58"></a><a name="runQuasiQuoteType"></a><span class='hs-definition'>runQuasiQuoteType</span> <span class='hs-varid'>qq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runQuasiQuote</span> <span class='hs-varid'>qq</span> <span class='hs-varid'>quoteTypeName</span> <span class='hs-varid'>typeQTyConName</span> <span class='hs-varid'>typeMetaOps</span>
<a name="line-59"></a><a name="runQuasiQuoteDecl"></a><span class='hs-definition'>runQuasiQuoteDecl</span> <span class='hs-varid'>qq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runQuasiQuote</span> <span class='hs-varid'>qq</span> <span class='hs-varid'>quoteDecName</span>  <span class='hs-varid'>decsQTyConName</span> <span class='hs-varid'>declMetaOps</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="quoteStageError"></a><span class='hs-definition'>quoteStageError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-62"></a><span class='hs-definition'>quoteStageError</span> <span class='hs-varid'>quoter</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"GHC stage restriction:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>quoter</span><span class='hs-layout'>,</span>
<a name="line-64"></a>         <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is used in a quasiquote, and must be imported, not defined locally"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="deprecatedDollar"></a><span class='hs-definition'>deprecatedDollar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-67"></a><span class='hs-definition'>deprecatedDollar</span> <span class='hs-varid'>quoter</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Deprecated syntax:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-69"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"quasiquotes no longer need a dollar sign:"</span><span class='hs-layout'>)</span>
<a name="line-70"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>quoter</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Running an expression}
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="runQuasi"></a><span class='hs-definition'>runQuasi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Q</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>runQuasi</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>runQ</span> <span class='hs-varid'>act</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="MetaOps"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MetaOps</span> <span class='hs-varid'>th_syn</span> <span class='hs-varid'>hs_syn</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mt_desc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>             <span class='hs-comment'>-- Type of beast (expression, type etc)</span>
<a name="line-3"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>mt_show</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>th_syn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>   <span class='hs-comment'>-- How to show the th_syn thing</span>
<a name="line-4"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>mt_cvt</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>th_syn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-varid'>hs_syn</span>
<a name="line-5"></a>                                       <span class='hs-comment'>-- How to convert to hs_syn</span>
<a name="line-6"></a>    <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="exprMetaOps"></a><span class='hs-definition'>exprMetaOps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaOps</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>exprMetaOps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mt_desc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"expression"</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_show</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_cvt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>convertToHsExpr</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="patMetaOps"></a><span class='hs-definition'>patMetaOps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaOps</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>patMetaOps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mt_desc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"pattern"</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_show</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_cvt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>convertToPat</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="typeMetaOps"></a><span class='hs-definition'>typeMetaOps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaOps</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>typeMetaOps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mt_desc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"type"</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_show</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_cvt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>convertToHsType</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="declMetaOps"></a><span class='hs-definition'>declMetaOps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaOps</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a><span class='hs-definition'>declMetaOps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mt_desc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"declarations"</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_show</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_cvt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>convertToHsDecls</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="runMetaAW"></a><span class='hs-comment'>----------------</span>
<a name="line-21"></a><span class='hs-definition'>runMetaAW</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>output</span>
<a name="line-22"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnnotationWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>output</span><span class='hs-layout'>)</span>
<a name="line-23"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Of type AnnotationWrapper</span>
<a name="line-24"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>output</span>
<a name="line-25"></a><span class='hs-definition'>runMetaAW</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>.</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-comment'>-- We turn off showing the code in meta-level exceptions because doing so exposes</span>
<a name="line-27"></a>    <span class='hs-comment'>-- the toAnnotationWrapper function that we slap around the users code</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="runMetaQ"></a><span class='hs-comment'>-----------------</span>
<a name="line-30"></a><span class='hs-definition'>runMetaQ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>hs_syn</span>
<a name="line-31"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MetaOps</span> <span class='hs-varid'>th_syn</span> <span class='hs-varid'>hs_syn</span>
<a name="line-32"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>
<a name="line-33"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span>
<a name="line-34"></a><span class='hs-definition'>runMetaQ</span> <span class='hs-layout'>(</span><span class='hs-conid'>MT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mt_show</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show_th</span><span class='hs-layout'>,</span> <span class='hs-varid'>mt_cvt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvt</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMeta</span> <span class='hs-conid'>True</span> <span class='hs-varid'>run_and_cvt</span> <span class='hs-varid'>expr</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>run_and_cvt</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>hval</span>
<a name="line-38"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>runQ</span> <span class='hs-varid'>hval</span>
<a name="line-39"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Got TH result:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show_th</span> <span class='hs-varid'>th_result</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvt</span> <span class='hs-varid'>expr_span</span> <span class='hs-varid'>th_result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="runMetaE"></a><span class='hs-definition'>runMetaE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type (Q Exp)</span>
<a name="line-43"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-definition'>runMetaE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMetaQ</span> <span class='hs-varid'>exprMetaOps</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="runMetaP"></a><span class='hs-definition'>runMetaP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type (Q Pat)</span>
<a name="line-47"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-definition'>runMetaP</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMetaQ</span> <span class='hs-varid'>patMetaOps</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="runMetaT"></a><span class='hs-definition'>runMetaT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type (Q Type)</span>
<a name="line-51"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-definition'>runMetaT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMetaQ</span> <span class='hs-varid'>typeMetaOps</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="runMetaD"></a><span class='hs-definition'>runMetaD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>          <span class='hs-comment'>-- Of type Q [Dec]</span>
<a name="line-55"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-56"></a><span class='hs-definition'>runMetaD</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMetaQ</span> <span class='hs-varid'>declMetaOps</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="runMeta"></a><span class='hs-comment'>---------------</span>
<a name="line-59"></a><span class='hs-definition'>runMeta</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>hs_syn</span><span class='hs-layout'>)</span>
<a name="line-60"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Bool</span>                 <span class='hs-comment'>-- Whether code should be printed in the exception message</span>
<a name="line-61"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-varid'>hs_syn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- How to run x</span>
<a name="line-62"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span>           <span class='hs-comment'>-- Of type x; typically x = Q TH.Exp, or something like that</span>
<a name="line-63"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>hs_syn</span>           <span class='hs-comment'>-- Of type t</span>
<a name="line-64"></a><span class='hs-definition'>runMeta</span> <span class='hs-varid'>show_code</span> <span class='hs-varid'>run_and_convert</span> <span class='hs-varid'>expr</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"About to run"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-66"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>recordThSpliceUse</span> <span class='hs-comment'>-- seems to be the best place to do this,</span>
<a name="line-67"></a>                            <span class='hs-comment'>-- we catch all kinds of splices and annotations.</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-comment'>-- Check that we've had no errors of any sort so far.</span>
<a name="line-70"></a>        <span class='hs-comment'>-- For example, if we found an error in an earlier defn f, but</span>
<a name="line-71"></a>        <span class='hs-comment'>-- recovered giving it type f :: forall a.a, it'd be very dodgy</span>
<a name="line-72"></a>        <span class='hs-comment'>-- to carry ont.  Mind you, the staging restrictions mean we won't</span>
<a name="line-73"></a>        <span class='hs-comment'>-- actually run f, but it still seems wrong. And, more concretely,</span>
<a name="line-74"></a>        <span class='hs-comment'>-- see Trac #5358 for an example that fell over when trying to</span>
<a name="line-75"></a>        <span class='hs-comment'>-- reify a function with a "?" kind in it.  (These don't occur</span>
<a name="line-76"></a>        <span class='hs-comment'>-- in type-correct programs.</span>
<a name="line-77"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>failIfErrsM</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-comment'>-- Desugar</span>
<a name="line-80"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ds_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initDsTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-81"></a>        <span class='hs-comment'>-- Compile and link it; might fail if linking fails</span>
<a name="line-82"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-83"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>src_span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-84"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"About to run (desugared)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ds_expr</span><span class='hs-layout'>)</span>
<a name="line-85"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-86"></a>                         <span class='hs-conid'>HscMain</span><span class='hs-varop'>.</span><span class='hs-varid'>hscCompileCoreExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_span</span> <span class='hs-varid'>ds_expr</span>
<a name="line-87"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-88"></a>            <span class='hs-conid'>Left</span> <span class='hs-varid'>exn</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_with_exn</span> <span class='hs-str'>"compile and link"</span> <span class='hs-varid'>exn</span> <span class='hs-layout'>;</span>
<a name="line-89"></a>            <span class='hs-conid'>Right</span> <span class='hs-varid'>hval</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-90"></a>
<a name="line-91"></a>        <span class='hs-layout'>{</span>       <span class='hs-comment'>-- Coerce it to Q t, and run it</span>
<a name="line-92"></a>
<a name="line-93"></a>                <span class='hs-comment'>-- Running might fail if it throws an exception of any kind (hence tryAllM)</span>
<a name="line-94"></a>                <span class='hs-comment'>-- including, say, a pattern-match exception in the code we are running</span>
<a name="line-95"></a>                <span class='hs-comment'>--</span>
<a name="line-96"></a>                <span class='hs-comment'>-- We also do the TH -&gt; HS syntax conversion inside the same</span>
<a name="line-97"></a>                <span class='hs-comment'>-- exception-cacthing thing so that if there are any lurking</span>
<a name="line-98"></a>                <span class='hs-comment'>-- exceptions in the data structure returned by hval, we'll</span>
<a name="line-99"></a>                <span class='hs-comment'>-- encounter them inside the try</span>
<a name="line-100"></a>                <span class='hs-comment'>--</span>
<a name="line-101"></a>                <span class='hs-comment'>-- See Note [Exceptions in TH]</span>
<a name="line-102"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>expr_span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getLoc</span> <span class='hs-varid'>expr</span>
<a name="line-103"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>either_tval</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryAllM</span> <span class='hs-varop'>$</span>
<a name="line-104"></a>                         <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>expr_span</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- Set the span so that qLocation can</span>
<a name="line-105"></a>                                                <span class='hs-comment'>-- see where this splice is</span>
<a name="line-106"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run_and_convert</span> <span class='hs-varid'>expr_span</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>hval</span><span class='hs-layout'>)</span>
<a name="line-107"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_result</span> <span class='hs-keyword'>of</span>
<a name="line-108"></a>                    <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>err</span>
<a name="line-109"></a>                    <span class='hs-conid'>Right</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Got HsSyn result:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-110"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-111"></a>
<a name="line-112"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_tval</span> <span class='hs-keyword'>of</span>
<a name="line-113"></a>            <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-114"></a>            <span class='hs-conid'>Left</span> <span class='hs-varid'>se</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>se</span> <span class='hs-keyword'>of</span>
<a name="line-115"></a>                         <span class='hs-conid'>Just</span> <span class='hs-conid'>IOEnvFailure</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failM</span> <span class='hs-comment'>-- Error already in Tc monad</span>
<a name="line-116"></a>                         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_with_exn</span> <span class='hs-str'>"run"</span> <span class='hs-varid'>se</span> <span class='hs-comment'>-- Exception</span>
<a name="line-117"></a>        <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-118"></a>  <span class='hs-keyword'>where</span>
<a name="line-119"></a>    <span class='hs-comment'>-- see Note [Concealed TH exceptions]</span>
<a name="line-120"></a>    <span class='hs-varid'>fail_with_exn</span> <span class='hs-varid'>phase</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-121"></a>        <span class='hs-varid'>exn_msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Panic</span><span class='hs-varop'>.</span><span class='hs-varid'>safeShowException</span> <span class='hs-varid'>exn</span>
<a name="line-122"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Exception when trying to"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>phase</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"compile-time code:"</span><span class='hs-layout'>,</span>
<a name="line-123"></a>                        <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>exn_msg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-124"></a>                        <span class='hs-keyword'>if</span> <span class='hs-varid'>show_code</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Code:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-keyglyph'>]</span>
<a name="line-125"></a>        <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
</pre>\end{code}

Note [Exceptions in TH]
~~~~~~~~~~~~~~~~~~~~~~~
Supppose we have something like this
        $( f 4 )
where
        f :: Int -> Q [Dec]
        f n | n>3       = fail "Too many declarations"
            | otherwise = ...

The 'fail' is a user-generated failure, and should be displayed as a
perfectly ordinary compiler error message, not a panic or anything
like that.  Here's how it's processed:

  * 'fail' is the monad fail.  The monad instance for Q in TH.Syntax
    effectively transforms (fail s) to
        qReport True s >> fail
    where 'qReport' comes from the Quasi class and fail from its monad
    superclass.

  * The TcM monad is an instance of Quasi (see TcSplice), and it implements
    (qReport True s) by using addErr to add an error message to the bag of errors.
    The 'fail' in TcM raises an IOEnvFailure exception

  * So, when running a splice, we catch all exceptions; then for
        - an IOEnvFailure exception, we assume the error is already
                in the error-bag (above)
        - other errors, we add an error to the bag
    and then fail

Note [Concealed TH exceptions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When displaying the error message contained in an exception originated from TH
code, we need to make sure that the error message itself does not contain an
exception.  For example, when executing the following splice:

    $( error ("foo " ++ error "bar") )

the message for the outer exception is a thunk which will throw the inner
exception when evaluated.

For this reason, we display the message of a TH exception using the
'safeShowException' function, which recursively catches any exception thrown
when showing an error message.


To call runQ in the Tc monad, we need to make TcM an instance of Quasi:

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Quasi</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>qNewName</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-3"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getKey</span> <span class='hs-varid'>u</span>
<a name="line-4"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameU</span> <span class='hs-varid'>s</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a>  <span class='hs-varid'>qReport</span> <span class='hs-conid'>True</span> <span class='hs-varid'>msg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span>  <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-varid'>qReport</span> <span class='hs-conid'>False</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>  <span class='hs-varid'>qLocation</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-10"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-11"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>                        <span class='hs-conid'>UnhelpfulSpan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"qLocation: Unhelpful location"</span>
<a name="line-13"></a>                                                    <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-14"></a>                        <span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-15"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Loc</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpackFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanFile</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_module</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_package</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>packageIdString</span> <span class='hs-layout'>(</span><span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_start</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStartLine</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanStartCol</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-19"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>loc_end</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanEndLine</span>   <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcSpanEndCol</span>   <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-varid'>qLookupName</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupName</span>
<a name="line-22"></a>  <span class='hs-varid'>qReify</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify</span>
<a name="line-23"></a>  <span class='hs-varid'>qReifyInstances</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyInstances</span>
<a name="line-24"></a>  <span class='hs-varid'>qReifyRoles</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyRoles</span>
<a name="line-25"></a>  <span class='hs-varid'>qReifyAnnotations</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyAnnotations</span>
<a name="line-26"></a>  <span class='hs-varid'>qReifyModule</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyModule</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- For qRecover, discard error messages if</span>
<a name="line-29"></a>        <span class='hs-comment'>-- the recovery action is chosen.  Otherwise</span>
<a name="line-30"></a>        <span class='hs-comment'>-- we'll only fail higher up.  c.f. tryTcLIE_</span>
<a name="line-31"></a>  <span class='hs-varid'>qRecover</span> <span class='hs-varid'>recover</span> <span class='hs-varid'>main</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryTcErrs</span> <span class='hs-varid'>main</span>
<a name="line-32"></a>                             <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_res</span> <span class='hs-keyword'>of</span>
<a name="line-33"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addMessages</span> <span class='hs-varid'>msgs</span>      <span class='hs-comment'>-- There might be warnings</span>
<a name="line-34"></a>                                                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>val</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>                                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>recover</span>                    <span class='hs-comment'>-- Discard all msgs</span>
<a name="line-36"></a>                          <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a>  <span class='hs-varid'>qRunIO</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>io</span>
<a name="line-39"></a>
<a name="line-40"></a>  <span class='hs-varid'>qAddDependentFile</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-41"></a>    <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-42"></a>    <span class='hs-varid'>dep_files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-43"></a>    <span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>fp</span><span class='hs-conop'>:</span><span class='hs-varid'>dep_files</span><span class='hs-layout'>)</span>
<a name="line-44"></a>
<a name="line-45"></a>  <span class='hs-varid'>qAddTopDecls</span> <span class='hs-varid'>thds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>      <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-47"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>convertToHsDecls</span> <span class='hs-varid'>l</span> <span class='hs-varid'>thds</span>
<a name="line-48"></a>      <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>either_hval</span> <span class='hs-keyword'>of</span>
<a name="line-49"></a>              <span class='hs-conid'>Left</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"qAddTopDecls: can't convert top-level declarations"</span> <span class='hs-varid'>exn</span>
<a name="line-50"></a>              <span class='hs-conid'>Right</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ds</span>
<a name="line-51"></a>      <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkTopDecl</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-52"></a>      <span class='hs-varid'>th_topdecls_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-53"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_topdecls_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>topds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>topds</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-keyword'>where</span>
<a name="line-55"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-56"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValD</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-57"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>bindName</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsBindBinders</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-58"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-59"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-60"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-61"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindName</span> <span class='hs-varid'>name</span>
<a name="line-62"></a>      <span class='hs-varid'>checkTopDecl</span> <span class='hs-keyword'>_</span>
<a name="line-63"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Only function, value, and foreign import declarations may be added with addTopDecl"</span>
<a name="line-64"></a>
<a name="line-65"></a>      <span class='hs-varid'>bindName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-66"></a>      <span class='hs-varid'>bindName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-67"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_topnames_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_topnames</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-68"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_topnames_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addOneToNameSet</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-69"></a>             <span class='hs-layout'>}</span>
<a name="line-70"></a>
<a name="line-71"></a>      <span class='hs-varid'>bindName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<a name="line-72"></a>          <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-73"></a>          <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The binder"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a NameU."</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-74"></a>             <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Probable cause: you used mkName instead of newName to generate a binding."</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a>  <span class='hs-varid'>qAddModFinalizer</span> <span class='hs-varid'>fin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-77"></a>      <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_modfinalizers</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-78"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_modfinalizers_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>fins</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fin</span><span class='hs-conop'>:</span><span class='hs-varid'>fins</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a>  <span class='hs-varid'>qGetQ</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-81"></a>      <span class='hs-varid'>th_state_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_state</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-82"></a>      <span class='hs-varid'>th_state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>th_state_var</span>
<a name="line-83"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeOf</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>th_state</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>fromDynamic</span>
<a name="line-84"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>
<a name="line-85"></a>
<a name="line-86"></a>  <span class='hs-varid'>qPutQ</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-87"></a>      <span class='hs-varid'>th_state_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>tcg_th_state</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-88"></a>      <span class='hs-varid'>updTcRef</span> <span class='hs-varid'>th_state_var</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeOf</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toDyn</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Errors and contexts}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="showSplice"></a><span class='hs-definition'>showSplice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- Note that 'before' is *renamed* but not *typechecked*</span>
<a name="line-3"></a><span class='hs-comment'>-- Reason (a) less typechecking crap</span>
<a name="line-4"></a><span class='hs-comment'>--        (b) data constructors after type checking have been</span>
<a name="line-5"></a><span class='hs-comment'>--            changed to their *wrappers*, and that makes them</span>
<a name="line-6"></a><span class='hs-comment'>--            print always fully qualified</span>
<a name="line-7"></a><span class='hs-definition'>showSplice</span> <span class='hs-varid'>what</span> <span class='hs-varid'>before</span> <span class='hs-varid'>after</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceSplice</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Splicing"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>what</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                            <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>before</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                                         <span class='hs-varid'>text</span> <span class='hs-str'>"======&gt;"</span><span class='hs-layout'>,</span>
<a name="line-12"></a>                                         <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>after</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
            Instance Testing
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="reifyInstances"></a><span class='hs-definition'>reifyInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>reifyInstances</span> <span class='hs-varid'>th_nm</span> <span class='hs-varid'>th_tys</span>
<a name="line-3"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the argument of reifyInstances:"</span><span class='hs-layout'>)</span>
<a name="line-4"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_nm</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_th</span> <span class='hs-varid'>th_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-5"></a>     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>th_tys</span><span class='hs-layout'>)</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_ty</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>rdr_ty</span>   <span class='hs-comment'>-- Rename  to HsType Name</span>
<a name="line-8"></a>                         <span class='hs-comment'>-- checkNoErrs: see Note [Renamer errors]</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-sel'>_kind</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsType</span> <span class='hs-varid'>rn_ty</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>emptyZonkEnv</span> <span class='hs-varid'>ty</span>   <span class='hs-comment'>-- Substitute out the meta type variables</span>
<a name="line-11"></a>                                                   <span class='hs-comment'>-- In particular, the type might have kind</span>
<a name="line-12"></a>                                                   <span class='hs-comment'>-- variables inside it (Trac #7477)</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>   <span class='hs-comment'>-- This expands any type synonyms</span>
<a name="line-16"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>                 <span class='hs-comment'>-- See Trac #7910</span>
<a name="line-17"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-18"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-19"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifies</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-20"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyClassInstance</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unifies</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-23"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-24"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFamInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-25"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reifyInstances2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-26"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyFamilyInstance</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fim_instance</span><span class='hs-layout'>)</span> <span class='hs-varid'>matches</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>            <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"reifyInstances:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-28"></a>                               <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a class constraint or type family application"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>  <span class='hs-keyword'>where</span>
<a name="line-30"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClassInstanceCtx</span>
<a name="line-31"></a>    <span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-varid'>cvt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-34"></a>    <span class='hs-varid'>cvt</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>convertToHsType</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>th_ty</span> <span class='hs-keyword'>of</span>
<a name="line-35"></a>                      <span class='hs-conid'>Left</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-36"></a>                      <span class='hs-conid'>Right</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                        Reification
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="lookupName"></a><span class='hs-definition'>lookupName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True  &lt;=&gt; type namespace</span>
<a name="line-2"></a>                        <span class='hs-comment'>-- False &lt;=&gt; value namespace</span>
<a name="line-3"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>lookupName</span> <span class='hs-varid'>is_type_name</span> <span class='hs-varid'>s</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupLocalRdrEnv</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGlobalOccRn_maybe</span> <span class='hs-varid'>rdr_name</span>
<a name="line-9"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>mb_nm</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkName</span> <span class='hs-varid'>s</span>       <span class='hs-comment'>-- Parses M.x into a base of 'x' and a module of 'M'</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-varid'>occ_fs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span>
<a name="line-14"></a>    <span class='hs-varid'>occ_fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>nameBase</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span>
<a name="line-17"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type_name</span>
<a name="line-18"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isLexCon</span> <span class='hs-varid'>occ_fs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mkTcOccFS</span>    <span class='hs-varid'>occ_fs</span>
<a name="line-19"></a>                             <span class='hs-keyword'>else</span> <span class='hs-varid'>mkTyVarOccFS</span> <span class='hs-varid'>occ_fs</span>
<a name="line-20"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-21"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isLexCon</span> <span class='hs-varid'>occ_fs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mkDataOccFS</span> <span class='hs-varid'>occ_fs</span>
<a name="line-22"></a>                             <span class='hs-keyword'>else</span> <span class='hs-varid'>mkVarOccFS</span>  <span class='hs-varid'>occ_fs</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-varid'>rdr_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>th_name</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrUnqual</span> <span class='hs-varid'>occ</span>
<a name="line-26"></a>                 <span class='hs-conid'>Just</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrQual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="getThing"></a><span class='hs-definition'>getThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-29"></a><span class='hs-definition'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName</span> <span class='hs-varid'>th_name</span>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"reify"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_ns</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcLookupTh</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>        <span class='hs-comment'>-- ToDo: this tcLookup could fail, which would give a</span>
<a name="line-34"></a>        <span class='hs-comment'>--       rather unhelpful error message</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataName</span> <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"data"</span>
<a name="line-37"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TcClsName</span> <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tc"</span>
<a name="line-38"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarName</span> <span class='hs-sel'>_pkg</span> <span class='hs-sel'>_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"var"</span>
<a name="line-39"></a>    <span class='hs-varid'>ppr_ns</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reify/ppr_ns"</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="reify"></a><span class='hs-definition'>reify</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-42"></a><span class='hs-definition'>reify</span> <span class='hs-varid'>th_name</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>reifyThing</span> <span class='hs-varid'>thing</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="lookupThName"></a><span class='hs-definition'>lookupThName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Name</span>
<a name="line-47"></a><span class='hs-definition'>lookupThName</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-48"></a>    <span class='hs-varid'>mb_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThName_maybe</span> <span class='hs-varid'>th_name</span>
<a name="line-49"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span>
<a name="line-50"></a>        <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notInScope</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-51"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>name</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="lookupThName_maybe"></a><span class='hs-definition'>lookupThName_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-definition'>lookupThName_maybe</span> <span class='hs-varid'>th_name</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapMaybeM</span> <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>thRdrNameGuesses</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-56"></a>          <span class='hs-comment'>-- Pick the first that works</span>
<a name="line-57"></a>          <span class='hs-comment'>-- E.g. reify (mkName "A") will pick the class A in preference to the data constructor A</span>
<a name="line-58"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToMaybe</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>    <span class='hs-varid'>lookup</span> <span class='hs-varid'>rdr_name</span>
<a name="line-61"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Repeat much of lookupOccRn, becase we want</span>
<a name="line-62"></a>                <span class='hs-comment'>-- to report errors in a TH-relevant way</span>
<a name="line-63"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-64"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupLocalRdrEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyword'>of</span>
<a name="line-65"></a>                 <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-66"></a>                 <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupGlobalOccRn_maybe</span> <span class='hs-varid'>rdr_name</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="tcLookupTh"></a><span class='hs-definition'>tcLookupTh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-69"></a><span class='hs-comment'>-- This is a specialised version of TcEnv.tcLookup; specialised mainly in that</span>
<a name="line-70"></a><span class='hs-comment'>-- it gives a reify-related error message on failure, whereas in the normal</span>
<a name="line-71"></a><span class='hs-comment'>-- tcLookup, failure is a bug.</span>
<a name="line-72"></a><span class='hs-definition'>tcLookupTh</span> <span class='hs-varid'>name</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnvs</span>
<a name="line-74"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_env</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-75"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>thing</span><span class='hs-layout'>;</span>
<a name="line-76"></a>                <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span>
<a name="line-77"></a>
<a name="line-78"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-79"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-80"></a>                <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span>
<a name="line-81"></a>
<a name="line-82"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>gbl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-83"></a>          <span class='hs-keyword'>then</span>  <span class='hs-comment'>-- It's defined in this module</span>
<a name="line-84"></a>                <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notInEnv</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a>          <span class='hs-keyword'>else</span>
<a name="line-87"></a>     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupImported_maybe</span> <span class='hs-varid'>name</span>
<a name="line-88"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-89"></a>            <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-90"></a>            <span class='hs-conid'>Failed</span> <span class='hs-varid'>msg</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-91"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="notInScope"></a><span class='hs-definition'>notInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-94"></a><span class='hs-definition'>notInScope</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-95"></a>                     <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not in scope at a reify"</span><span class='hs-layout'>)</span>
<a name="line-96"></a>        <span class='hs-comment'>-- Ugh! Rather an indirect way to display the name</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="notInEnv"></a><span class='hs-definition'>notInEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-99"></a><span class='hs-definition'>notInEnv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-100"></a>                     <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not in the type environment at a reify"</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="reifyRoles"></a><span class='hs-comment'>------------------------------</span>
<a name="line-103"></a><span class='hs-definition'>reifyRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-104"></a><span class='hs-definition'>reifyRoles</span> <span class='hs-varid'>th_name</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getThing</span> <span class='hs-varid'>th_name</span>
<a name="line-106"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-107"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reify_role</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-108"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No roles associated with"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-109"></a>       <span class='hs-layout'>}</span>
<a name="line-110"></a>  <span class='hs-keyword'>where</span>
<a name="line-111"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NominalR</span>
<a name="line-112"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>RepresentationalR</span>
<a name="line-113"></a>    <span class='hs-varid'>reify_role</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PhantomR</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="reifyThing"></a><span class='hs-comment'>------------------------------</span>
<a name="line-116"></a><span class='hs-definition'>reifyThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-117"></a><span class='hs-comment'>-- The only reason this is monadic is for error reporting,</span>
<a name="line-118"></a><span class='hs-comment'>-- which in turn is mainly for the case when TH can't express</span>
<a name="line-119"></a><span class='hs-comment'>-- some random GHC extension</span>
<a name="line-120"></a>
<a name="line-121"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-123"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFixity</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-124"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>id</span>
<a name="line-125"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-126"></a>            <span class='hs-conid'>ClassOpId</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassOpI</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span>
<a name="line-127"></a>            <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarI</span>     <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span>
<a name="line-128"></a>    <span class='hs-layout'>}</span>
<a name="line-129"></a>
<a name="line-130"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-131"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-132"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConName</span> <span class='hs-varid'>dc</span>
<a name="line-133"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-134"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFixity</span> <span class='hs-varid'>name</span>
<a name="line-135"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-136"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConOrigTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span>
<a name="line-137"></a>        <span class='hs-layout'>}</span>
<a name="line-138"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"pattern synonyms"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>patSynName</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-varid'>tct_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Make use of all the info we have, even</span>
<a name="line-143"></a>                                        <span class='hs-comment'>-- though it may be incomplete</span>
<a name="line-144"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty1</span>
<a name="line-145"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFixity</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-146"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-147"></a>
<a name="line-148"></a><span class='hs-definition'>reifyThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-150"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty1</span>
<a name="line-151"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-152"></a>
<a name="line-153"></a><span class='hs-definition'>reifyThing</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyThing"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTcTyThingCategory</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="reifyAxBranch"></a><span class='hs-comment'>-------------------------------------------</span>
<a name="line-156"></a><span class='hs-definition'>reifyAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span>
<a name="line-157"></a><span class='hs-definition'>reifyAxBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-158"></a>            <span class='hs-comment'>-- remove kind patterns (#8884)</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-160"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-161"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="reifyTyCon"></a><span class='hs-definition'>reifyTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-164"></a><span class='hs-definition'>reifyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-165"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyClass</span> <span class='hs-varid'>cls</span>
<a name="line-167"></a>
<a name="line-168"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-169"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PrimTyConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span>                <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-172"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PrimTyConI</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-173"></a>
<a name="line-174"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-175"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-176"></a>             <span class='hs-varid'>kind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span>
<a name="line-177"></a>
<a name="line-178"></a>             <span class='hs-comment'>-- we need the *result kind* (see #8884)</span>
<a name="line-179"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>kind</span>
<a name="line-180"></a>                                <span class='hs-comment'>-- tyConArity includes *kind* params</span>
<a name="line-181"></a>             <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span>
<a name="line-182"></a>                                                 <span class='hs-varid'>mono_kind</span>
<a name="line-183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyKind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-186"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>flav'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyFamFlavour</span> <span class='hs-varid'>tc</span>
<a name="line-187"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flav'</span> <span class='hs-keyword'>of</span>
<a name="line-188"></a>         <span class='hs-layout'>{</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>flav</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-comment'>-- open type/data family</span>
<a name="line-189"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-190"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>instances</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyFamilyInstance</span> <span class='hs-layout'>(</span><span class='hs-varid'>familyInstances</span> <span class='hs-varid'>fam_envs</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-191"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamilyI</span>
<a name="line-192"></a>                            <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamilyD</span> <span class='hs-varid'>flav</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-193"></a>                            <span class='hs-varid'>instances</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-194"></a>         <span class='hs-layout'>;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>eqns</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- closed type family</span>
<a name="line-195"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamilyI</span>
<a name="line-196"></a>                      <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClosedTypeFamilyD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind'</span> <span class='hs-varid'>eqns</span><span class='hs-layout'>)</span>
<a name="line-197"></a>                      <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-198"></a>
<a name="line-199"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConDefn_maybe</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- Vanilla type synonym</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>rhs</span>
<a name="line-201"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-202"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyConI</span>
<a name="line-203"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-204"></a>       <span class='hs-layout'>}</span>
<a name="line-205"></a>
<a name="line-206"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-207"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-208"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-209"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyDataCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-210"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>r_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-211"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span>
<a name="line-212"></a>              <span class='hs-varid'>deriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>        <span class='hs-comment'>-- Don't know about deriving</span>
<a name="line-213"></a>              <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NewtypeD</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>r_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-varid'>deriv</span>
<a name="line-214"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataD</span>    <span class='hs-varid'>cxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>r_tvs</span> <span class='hs-varid'>cons</span>        <span class='hs-varid'>deriv</span>
<a name="line-215"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyConI</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="reifyDataCon"></a><span class='hs-definition'>reifyDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Con</span>
<a name="line-218"></a><span class='hs-comment'>-- For GADTs etc, see Note [Reifying data constructors]</span>
<a name="line-219"></a><span class='hs-definition'>reifyDataCon</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>dc</span>
<a name="line-220"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSig</span> <span class='hs-varid'>dc</span>
<a name="line-221"></a>             <span class='hs-varid'>subst</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Dicard ex_tvs</span>
<a name="line-222"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropList</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-223"></a>             <span class='hs-varid'>theta'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>theta</span>
<a name="line-224"></a>             <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>arg_tys</span>
<a name="line-225"></a>             <span class='hs-varid'>stricts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>reifyStrict</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-226"></a>             <span class='hs-varid'>fields</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>dc</span>
<a name="line-227"></a>             <span class='hs-varid'>name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>dc</span>
<a name="line-228"></a>
<a name="line-229"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>r_arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>arg_tys'</span>
<a name="line-230"></a>
<a name="line-231"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>main_con</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span>
<a name="line-232"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>RecC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip3</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span> <span class='hs-varid'>stricts</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-233"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dataConIsInfix</span> <span class='hs-varid'>dc</span>
<a name="line-234"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>==</span> <span class='hs-num'>2</span> <span class='hs-layout'>)</span>
<a name="line-235"></a>                        <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixC</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>r_a1</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>r_a2</span><span class='hs-layout'>)</span>
<a name="line-236"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-237"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NormalC</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>stricts</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>r_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-238"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>r_a1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r_a2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r_arg_tys</span>
<a name="line-239"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span>   <span class='hs-varid'>s2</span><span class='hs-keyglyph'>]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stricts</span>
<a name="line-240"></a>
<a name="line-241"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>stricts</span> <span class='hs-layout'>)</span>
<a name="line-242"></a>         <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ex_tvs'</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span> <span class='hs-keyword'>then</span>
<a name="line-243"></a>             <span class='hs-varid'>return</span> <span class='hs-varid'>main_con</span>
<a name="line-244"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-245"></a>         <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta'</span>
<a name="line-246"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>ex_tvs''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>ex_tvs'</span>
<a name="line-247"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ForallC</span> <span class='hs-varid'>ex_tvs''</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>main_con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-248"></a>
<a name="line-249"></a><a name="reifyClass"></a><span class='hs-comment'>------------------------------</span>
<a name="line-250"></a><span class='hs-definition'>reifyClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span>
<a name="line-251"></a><span class='hs-definition'>reifyClass</span> <span class='hs-varid'>cls</span>
<a name="line-252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>theta</span>
<a name="line-253"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-254"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyClassInstance</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstEnv</span><span class='hs-varop'>.</span><span class='hs-varid'>classInstances</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-255"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ops</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reify_op</span> <span class='hs-varid'>op_stuff</span>
<a name="line-256"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-257"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassD</span> <span class='hs-varid'>cxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>fds'</span> <span class='hs-varid'>ops</span>
<a name="line-258"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassI</span> <span class='hs-varid'>dec</span> <span class='hs-varid'>insts</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-259"></a>  <span class='hs-keyword'>where</span>
<a name="line-260"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fds</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>cls</span>
<a name="line-261"></a>    <span class='hs-varid'>fds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>reifyFunDep</span> <span class='hs-varid'>fds</span>
<a name="line-262"></a>    <span class='hs-varid'>reify_op</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-263"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SigD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-264"></a>
<a name="line-265"></a><a name="reifyClassInstance"></a><span class='hs-comment'>------------------------------</span>
<a name="line-266"></a><span class='hs-definition'>reifyClassInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span>
<a name="line-267"></a><span class='hs-definition'>reifyClassInstance</span> <span class='hs-varid'>i</span>
<a name="line-268"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>n_silent</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-269"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thtypes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>types</span>
<a name="line-270"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>head_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkThAppTs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thtypes</span>
<a name="line-271"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InstanceD</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>head_ty</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-272"></a>  <span class='hs-keyword'>where</span>
<a name="line-273"></a>     <span class='hs-layout'>(</span><span class='hs-sel'>_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>types</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitDFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun</span><span class='hs-layout'>)</span>
<a name="line-274"></a>     <span class='hs-varid'>dfun</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>i</span>
<a name="line-275"></a>     <span class='hs-varid'>n_silent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfunNSilent</span> <span class='hs-varid'>dfun</span>
<a name="line-276"></a>
<a name="line-277"></a><a name="reifyFamilyInstance"></a><span class='hs-comment'>------------------------------</span>
<a name="line-278"></a><span class='hs-definition'>reifyFamilyInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span>
<a name="line-279"></a><span class='hs-definition'>reifyFamilyInstance</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span> 
<a name="line-280"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>fi_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span>
<a name="line-281"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-282"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>fi_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-283"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flavor</span> <span class='hs-keyword'>of</span>
<a name="line-284"></a>      <span class='hs-conid'>SynFamilyInst</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-285"></a>               <span class='hs-comment'>-- remove kind patterns (#8884)</span>
<a name="line-286"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>th_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-287"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span>  <span class='hs-varid'>rhs</span>
<a name="line-288"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynInstD</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>fam</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span> <span class='hs-varid'>th_lhs</span> <span class='hs-varid'>th_rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-289"></a>
<a name="line-290"></a>      <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-291"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>rep_tc</span>
<a name="line-292"></a>                 <span class='hs-varid'>fam'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>fam</span>
<a name="line-293"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyDataCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-294"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>th_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>lhs</span>
<a name="line-295"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>rep_tc</span>
<a name="line-296"></a>                     <span class='hs-keyword'>then</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NewtypeInstD</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>fam'</span> <span class='hs-varid'>th_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-297"></a>                     <span class='hs-keyword'>else</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataInstD</span>    <span class='hs-conid'>[]</span> <span class='hs-varid'>fam'</span> <span class='hs-varid'>th_tys</span> <span class='hs-varid'>cons</span>        <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="reifyType"></a><span class='hs-comment'>------------------------------</span>
<a name="line-300"></a><span class='hs-definition'>reifyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-301"></a><span class='hs-comment'>-- Monadic only because of failure</span>
<a name="line-302"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_for_all</span> <span class='hs-varid'>ty</span>
<a name="line-303"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>LitT</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-304"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-305"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_tc_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>   <span class='hs-comment'>-- Do not expand type synonyms here</span>
<a name="line-306"></a><span class='hs-definition'>reifyType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span><span class='hs-varop'>`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-307"></a><span class='hs-definition'>reifyType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-308"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_for_all</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- Types like ((?x::Int) =&gt; Char -&gt; Char)</span>
<a name="line-309"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span><span class='hs-varid'>r2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ArrowT</span> <span class='hs-varop'>`</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span><span class='hs-varop'>`</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>`</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span><span class='hs-varop'>`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-310"></a>
<a name="line-311"></a><a name="reify_for_all"></a><span class='hs-definition'>reify_for_all</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-312"></a><span class='hs-definition'>reify_for_all</span> <span class='hs-varid'>ty</span>
<a name="line-313"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyCxt</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>;</span>
<a name="line-314"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>tau</span>
<a name="line-315"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-316"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ForallT</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>cxt'</span> <span class='hs-varid'>tau'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-317"></a>  <span class='hs-keyword'>where</span>
<a name="line-318"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-319"></a>
<a name="line-320"></a><a name="reifyTyLit"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyLit</span>
<a name="line-321"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-322"></a><span class='hs-definition'>reifyTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>StrTyLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>unpackFS</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-323"></a>
<a name="line-324"></a><a name="reifyTypes"></a><span class='hs-definition'>reifyTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-325"></a><span class='hs-definition'>reifyTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyType</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="reifyKind"></a><span class='hs-definition'>reifyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span>
<a name="line-328"></a><span class='hs-definition'>reifyKind</span>  <span class='hs-varid'>ki</span>
<a name="line-329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kis</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>ki</span>
<a name="line-330"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ki'_rep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-varid'>ki'</span>
<a name="line-331"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kis_rep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>kis</span>
<a name="line-332"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ArrowT</span><span class='hs-layout'>)</span> <span class='hs-varid'>ki'_rep</span> <span class='hs-varid'>kis_rep</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-333"></a>  <span class='hs-keyword'>where</span>
<a name="line-334"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>StarT</span>
<a name="line-335"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConstraintT</span>
<a name="line-336"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-337"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>k</span>
<a name="line-338"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reify_kc_app</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>kis</span>
<a name="line-339"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>k1</span>
<a name="line-340"></a>                                                  <span class='hs-layout'>;</span> <span class='hs-varid'>k2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>k2</span>
<a name="line-341"></a>                                                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>k1'</span> <span class='hs-varid'>k2'</span><span class='hs-layout'>)</span>
<a name="line-342"></a>                                                  <span class='hs-layout'>}</span>
<a name="line-343"></a>    <span class='hs-varid'>reifyNonArrowKind</span> <span class='hs-varid'>k</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"this kind"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="reify_kc_app"></a><span class='hs-definition'>reify_kc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span>
<a name="line-346"></a><span class='hs-definition'>reify_kc_app</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>kis</span>
<a name="line-347"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-varid'>r_kc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span>
<a name="line-348"></a>  <span class='hs-keyword'>where</span>
<a name="line-349"></a>    <span class='hs-varid'>r_kc</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPromotedTyCon_maybe</span> <span class='hs-varid'>kc</span>
<a name="line-350"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TupleT</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>kc</span><span class='hs-layout'>)</span>
<a name="line-351"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>listTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ListT</span>
<a name="line-352"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>kc</span><span class='hs-layout'>)</span>
<a name="line-353"></a>
<a name="line-354"></a><a name="reifyCxt"></a><span class='hs-definition'>reifyCxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pred</span><span class='hs-keyglyph'>]</span>
<a name="line-355"></a><span class='hs-definition'>reifyCxt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reifyPred</span>
<a name="line-356"></a>
<a name="line-357"></a><a name="reifyFunDep"></a><span class='hs-definition'>reifyFunDep</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FunDep</span>
<a name="line-358"></a><span class='hs-definition'>reifyFunDep</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FunDep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-359"></a>
<a name="line-360"></a><a name="reifyFamFlavour"></a><span class='hs-definition'>reifyFamFlavour</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FamFlavour</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TySynEqn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-361"></a><span class='hs-definition'>reifyFamFlavour</span> <span class='hs-varid'>tc</span>
<a name="line-362"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenSynFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeFam</span>
<a name="line-363"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataFamilyTyCon</span>    <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataFam</span>
<a name="line-364"></a>
<a name="line-365"></a>    <span class='hs-comment'>-- this doesn't really handle abstract closed families, but let's not worry</span>
<a name="line-366"></a>    <span class='hs-comment'>-- about that now</span>
<a name="line-367"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isClosedSynFamilyTyCon_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-368"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eqns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>brListMapM</span> <span class='hs-varid'>reifyAxBranch</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>ax</span>
<a name="line-369"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>eqns</span> <span class='hs-layout'>}</span>
<a name="line-370"></a>                   
<a name="line-371"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-372"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcSplice.reifyFamFlavour: not a type family"</span>
<a name="line-373"></a>
<a name="line-374"></a><a name="reifyTyVars"></a><span class='hs-definition'>reifyTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-375"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarBndr</span><span class='hs-keyglyph'>]</span>
<a name="line-376"></a><span class='hs-definition'>reifyTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>reify_tv</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isTypeVar</span> <span class='hs-varid'>tvs</span>
<a name="line-377"></a>  <span class='hs-keyword'>where</span>
<a name="line-378"></a>    <span class='hs-varid'>reify_tv</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PlainTV</span>  <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-379"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyKind</span> <span class='hs-varid'>kind</span>
<a name="line-380"></a>                                             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>KindedTV</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-381"></a>      <span class='hs-keyword'>where</span>
<a name="line-382"></a>        <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-383"></a>        <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reifyName</span> <span class='hs-varid'>tv</span>
<a name="line-384"></a>
<a name="line-385"></a><a name="reify_tc_app"></a><span class='hs-definition'>reify_tc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-386"></a><span class='hs-definition'>reify_tc_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-387"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-388"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkThAppTs</span> <span class='hs-varid'>r_tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-389"></a>  <span class='hs-keyword'>where</span>
<a name="line-390"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-391"></a>    <span class='hs-varid'>r_tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isPromotedDataCon</span> <span class='hs-varid'>tc</span>
<a name="line-392"></a>                                        <span class='hs-keyword'>then</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedTupleT</span> <span class='hs-varid'>arity</span>
<a name="line-393"></a>                                        <span class='hs-keyword'>else</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TupleT</span> <span class='hs-varid'>arity</span>
<a name="line-394"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>listTyConKey</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ListT</span>
<a name="line-395"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>nilDataConKey</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedNilT</span>
<a name="line-396"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>consDataConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PromotedConsT</span>
<a name="line-397"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ConT</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-398"></a>    <span class='hs-varid'>removeKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-399"></a>    <span class='hs-varid'>removeKinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-400"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSuperKind</span> <span class='hs-varid'>k1</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeKinds</span> <span class='hs-varid'>k2</span> <span class='hs-varid'>t</span>
<a name="line-401"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:</span> <span class='hs-varid'>removeKinds</span> <span class='hs-varid'>k2</span> <span class='hs-varid'>t</span>
<a name="line-402"></a>    <span class='hs-varid'>removeKinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>v</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-conop'>:</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-403"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSuperKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeKinds</span> <span class='hs-varid'>k</span> <span class='hs-varid'>t</span>
<a name="line-404"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:</span> <span class='hs-varid'>removeKinds</span> <span class='hs-varid'>k</span> <span class='hs-varid'>t</span>
<a name="line-405"></a>    <span class='hs-varid'>removeKinds</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-406"></a>
<a name="line-407"></a><a name="reifyPred"></a><span class='hs-definition'>reifyPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeRep</span><span class='hs-varop'>.</span><span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pred</span>
<a name="line-408"></a><span class='hs-definition'>reifyPred</span> <span class='hs-varid'>ty</span>
<a name="line-409"></a>  <span class='hs-comment'>-- We could reify the implicit paramter as a class but it seems</span>
<a name="line-410"></a>  <span class='hs-comment'>-- nicer to support them properly...</span>
<a name="line-411"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"implicit parameters"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-412"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-413"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-414"></a>  <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyTypes</span> <span class='hs-varid'>tys</span> 
<a name="line-415"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassP</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifyName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span> <span class='hs-layout'>}</span>
<a name="line-416"></a>  <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty1</span>
<a name="line-417"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reifyType</span> <span class='hs-varid'>ty2</span>
<a name="line-418"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>EqualP</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span>
<a name="line-419"></a>                          <span class='hs-layout'>}</span>
<a name="line-420"></a>  <span class='hs-conid'>TuplePred</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tuple predicates"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-421"></a>  <span class='hs-conid'>IrredPred</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noTH</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"irreducible predicates"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-422"></a>
<a name="line-423"></a>
<a name="line-424"></a><a name="reifyName"></a><span class='hs-comment'>------------------------------</span>
<a name="line-425"></a><span class='hs-definition'>reifyName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NamedThing</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-426"></a><span class='hs-definition'>reifyName</span> <span class='hs-varid'>thing</span>
<a name="line-427"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_varg</span> <span class='hs-varid'>pkg_str</span> <span class='hs-varid'>mod_str</span> <span class='hs-varid'>occ_str</span>
<a name="line-428"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameU</span> <span class='hs-varid'>occ_str</span> <span class='hs-layout'>(</span><span class='hs-varid'>getKey</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-429"></a>        <span class='hs-comment'>-- Many of the things we reify have local bindings, and</span>
<a name="line-430"></a>        <span class='hs-comment'>-- NameL's aren't supposed to appear in binding positions, so</span>
<a name="line-431"></a>        <span class='hs-comment'>-- we use NameU.  When/if we start to reify nested things, that</span>
<a name="line-432"></a>        <span class='hs-comment'>-- have free variables, we may need to generate NameL's for them.</span>
<a name="line-433"></a>  <span class='hs-keyword'>where</span>
<a name="line-434"></a>    <span class='hs-varid'>name</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>thing</span>
<a name="line-435"></a>    <span class='hs-varid'>mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-436"></a>    <span class='hs-varid'>pkg_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>packageIdString</span> <span class='hs-layout'>(</span><span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-437"></a>    <span class='hs-varid'>mod_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-438"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameString</span> <span class='hs-varid'>occ</span>
<a name="line-439"></a>    <span class='hs-varid'>occ</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-440"></a>    <span class='hs-varid'>mk_varg</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isDataOcc</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameG_d</span>
<a name="line-441"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isVarOcc</span>  <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameG_v</span>
<a name="line-442"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isTcOcc</span>   <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNameG_tc</span>
<a name="line-443"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reifyName"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-444"></a>
<a name="line-445"></a><a name="reifyFixity"></a><span class='hs-comment'>------------------------------</span>
<a name="line-446"></a><span class='hs-definition'>reifyFixity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Fixity</span>
<a name="line-447"></a><span class='hs-definition'>reifyFixity</span> <span class='hs-varid'>name</span>
<a name="line-448"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>name</span>
<a name="line-449"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>conv_fix</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-450"></a>    <span class='hs-keyword'>where</span>
<a name="line-451"></a>      <span class='hs-varid'>conv_fix</span> <span class='hs-layout'>(</span><span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>i</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>conv_dir</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-452"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixR</span>
<a name="line-453"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixL</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixL</span>
<a name="line-454"></a>      <span class='hs-varid'>conv_dir</span> <span class='hs-conid'>BasicTypes</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InfixN</span>
<a name="line-455"></a>
<a name="line-456"></a><a name="reifyStrict"></a><span class='hs-definition'>reifyStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span><span class='hs-varop'>.</span><span class='hs-conid'>HsBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span>
<a name="line-457"></a><span class='hs-definition'>reifyStrict</span> <span class='hs-conid'>HsNoBang</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NotStrict</span>
<a name="line-458"></a><span class='hs-definition'>reifyStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NotStrict</span>
<a name="line-459"></a><span class='hs-definition'>reifyStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Unpacked</span>
<a name="line-460"></a><span class='hs-definition'>reifyStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-keyword'>_</span>     <span class='hs-conid'>True</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>IsStrict</span>
<a name="line-461"></a><span class='hs-definition'>reifyStrict</span> <span class='hs-conid'>HsStrict</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>IsStrict</span>
<a name="line-462"></a><span class='hs-definition'>reifyStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Unpacked</span>
<a name="line-463"></a>
<a name="line-464"></a><a name="lookupThAnnLookup"></a><span class='hs-comment'>------------------------------</span>
<a name="line-465"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CoreAnnTarget</span>
<a name="line-466"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookupName</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>NamedTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupThName</span> <span class='hs-varid'>th_nm</span><span class='hs-layout'>)</span>
<a name="line-467"></a><span class='hs-definition'>lookupThAnnLookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookupModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-468"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ModuleTarget</span> <span class='hs-varop'>$</span>
<a name="line-469"></a>    <span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>stringToPackageId</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pkgString</span> <span class='hs-varid'>pn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>modString</span> <span class='hs-varid'>mn</span><span class='hs-layout'>)</span>
<a name="line-470"></a>
<a name="line-471"></a><a name="reifyAnnotations"></a><span class='hs-definition'>reifyAnnotations</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AnnLookup</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-472"></a><span class='hs-definition'>reifyAnnotations</span> <span class='hs-varid'>th_name</span>
<a name="line-473"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupThAnnLookup</span> <span class='hs-varid'>th_name</span>
<a name="line-474"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>topEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-475"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prepareAnnotations</span> <span class='hs-varid'>topEnv</span> <span class='hs-conid'>Nothing</span>
<a name="line-476"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-477"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnns</span> <span class='hs-varid'>deserializeWithData</span> <span class='hs-varid'>epsHptAnns</span> <span class='hs-varid'>name</span>
<a name="line-478"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>selectedTcgAnns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findAnns</span> <span class='hs-varid'>deserializeWithData</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_ann_env</span> <span class='hs-varid'>tcg</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-479"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectedEpsHptAnns</span> <span class='hs-varop'>++</span> <span class='hs-varid'>selectedTcgAnns</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-480"></a>
<a name="line-481"></a><a name="modToTHMod"></a><span class='hs-comment'>------------------------------</span>
<a name="line-482"></a><span class='hs-definition'>modToTHMod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span>
<a name="line-483"></a><span class='hs-definition'>modToTHMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PkgName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>packageIdString</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-484"></a>                         <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-485"></a>
<a name="line-486"></a><a name="reifyModule"></a><span class='hs-definition'>reifyModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleInfo</span>
<a name="line-487"></a><span class='hs-definition'>reifyModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Module</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PkgName</span> <span class='hs-varid'>pkgString</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModName</span> <span class='hs-varid'>mString</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-488"></a>  <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-489"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>reifMod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>stringToPackageId</span> <span class='hs-varid'>pkgString</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-varid'>mString</span><span class='hs-layout'>)</span>
<a name="line-490"></a>  <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>reifMod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>reifyThisModule</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>reifyFromIface</span> <span class='hs-varid'>reifMod</span>
<a name="line-491"></a>    <span class='hs-keyword'>where</span>
<a name="line-492"></a>      <span class='hs-varid'>reifyThisModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-493"></a>        <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>modToTHMod</span> <span class='hs-varop'>.</span> <span class='hs-varid'>moduleEnvKeys</span> <span class='hs-varop'>.</span> <span class='hs-varid'>imp_mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>getImports</span>
<a name="line-494"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>usages</span>
<a name="line-495"></a>
<a name="line-496"></a>      <span class='hs-varid'>reifyFromIface</span> <span class='hs-varid'>reifMod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-497"></a>        <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadInterfaceForModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"reifying module from TH for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>reifMod</span><span class='hs-layout'>)</span> <span class='hs-varid'>reifMod</span>
<a name="line-498"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>modToTHMod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>usage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mi_usages</span> <span class='hs-varid'>iface</span><span class='hs-layout'>,</span>
<a name="line-499"></a>                                     <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>usageToModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>reifMod</span><span class='hs-layout'>)</span> <span class='hs-varid'>usage</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-500"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>usages</span>
<a name="line-501"></a>
<a name="line-502"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Usage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Module</span>
<a name="line-503"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageFile</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-504"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageHomeModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mn</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>mn</span>
<a name="line-505"></a>      <span class='hs-varid'>usageToModule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsagePackageModule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>m</span>
<a name="line-506"></a>
<a name="line-507"></a><a name="mkThAppTs"></a><span class='hs-comment'>------------------------------</span>
<a name="line-508"></a><span class='hs-definition'>mkThAppTs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-509"></a><span class='hs-definition'>mkThAppTs</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_tys</span>
<a name="line-510"></a>
<a name="line-511"></a><a name="noTH"></a><span class='hs-definition'>noTH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LitString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-512"></a><span class='hs-definition'>noTH</span> <span class='hs-varid'>s</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Can't represent"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-513"></a>                                <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in Template Haskell:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-514"></a>                             <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-515"></a>
<a name="line-516"></a><a name="ppr_th"></a><span class='hs-definition'>ppr_th</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Ppr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-517"></a><span class='hs-definition'>ppr_th</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Reifying data constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Template Haskell syntax is rich enough to express even GADTs,
provided we do so in the equality-predicate form.  So a GADT
like

  data T a where
     MkT1 :: a -> T [a]
     MkT2 :: T Int

will appear in TH syntax like this

  data T a = forall b. (a ~ [b]) => MkT1 b
           | (a ~ Int) => MkT2

\begin{code}
<pre><a name="line-1"></a><span class='hs-cpp'>#</span><span class='hs-varid'>endif</span>  <span class='hs-varop'>/*</span> <span class='hs-conid'>GHCI</span> <span class='hs-varop'>*/</span>
</pre>\end{code}
</body>
</html>
