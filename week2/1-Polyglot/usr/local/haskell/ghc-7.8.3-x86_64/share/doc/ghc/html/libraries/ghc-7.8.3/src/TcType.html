<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcType.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[TcType]{Types used in the typechecker}

This module provides the Type interface for front-end parts of the
compiler.  These parts

        * treat "source types" as opaque:
                newtypes, and predicates are meaningful.
        * look through usage types

The "tc" prefix is for "TypeChecker", because the type checker
is the principal client.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcType</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-3"></a>  <span class='hs-comment'>-- Types</span>
<a name="line-4"></a>  <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTauType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span>
<a name="line-5"></a>  <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVarSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoVar</span><span class='hs-layout'>,</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-comment'>-- Untouchables</span>
<a name="line-8"></a>  <span class='hs-conid'>Untouchables</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>noUntouchables</span><span class='hs-layout'>,</span> <span class='hs-varid'>pushUntouchables</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTouchable</span><span class='hs-layout'>,</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-11"></a>  <span class='hs-comment'>-- MetaDetails</span>
<a name="line-12"></a>  <span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprUserTypeCtxt</span><span class='hs-layout'>,</span>
<a name="line-13"></a>  <span class='hs-conid'>TcTyVarDetails</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTcTyVarDetails</span><span class='hs-layout'>,</span> <span class='hs-varid'>vanillaSkolemTv</span><span class='hs-layout'>,</span> <span class='hs-varid'>superSkolemTv</span><span class='hs-layout'>,</span>
<a name="line-14"></a>  <span class='hs-conid'>MetaDetails</span><span class='hs-layout'>(</span><span class='hs-conid'>Flexi</span><span class='hs-layout'>,</span> <span class='hs-conid'>Indirect</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-15"></a>  <span class='hs-varid'>isImmutableTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSkolemTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMetaTyVar</span><span class='hs-layout'>,</span>  <span class='hs-varid'>isMetaTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTyVarTy</span><span class='hs-layout'>,</span>
<a name="line-16"></a>  <span class='hs-varid'>isSigTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isOverlappableTyVar</span><span class='hs-layout'>,</span>  <span class='hs-varid'>isTyConableTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFlatSkolTyVar</span><span class='hs-layout'>,</span>
<a name="line-17"></a>  <span class='hs-varid'>isAmbiguousTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>metaTvRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>metaTyVarInfo</span><span class='hs-layout'>,</span>
<a name="line-18"></a>  <span class='hs-varid'>isFlexi</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIndirect</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeUnkSkol</span><span class='hs-layout'>,</span>
<a name="line-19"></a>  <span class='hs-varid'>isTypeVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isKindVar</span><span class='hs-layout'>,</span>
<a name="line-20"></a>  <span class='hs-varid'>metaTyVarUntouchables</span><span class='hs-layout'>,</span> <span class='hs-varid'>setMetaTyVarUntouchables</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>isTouchableMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFloatedTouchableMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-24"></a>  <span class='hs-comment'>-- Builders</span>
<a name="line-25"></a>  <span class='hs-varid'>mkPhiTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSigmaTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcEqPred</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-28"></a>  <span class='hs-comment'>-- Splitters</span>
<a name="line-29"></a>  <span class='hs-comment'>-- These are important because they do not look through newtypes</span>
<a name="line-30"></a>  <span class='hs-varid'>tcView</span><span class='hs-layout'>,</span>
<a name="line-31"></a>  <span class='hs-varid'>tcSplitForAllTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitPhiTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitPredFunTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-32"></a>  <span class='hs-varid'>tcSplitFunTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcFunArgTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcFunResultTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitFunTysN</span><span class='hs-layout'>,</span>
<a name="line-33"></a>  <span class='hs-varid'>tcSplitTyConApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyConAppTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyConAppArgs</span><span class='hs-layout'>,</span>
<a name="line-34"></a>  <span class='hs-varid'>tcSplitAppTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitAppTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>repSplitAppTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-35"></a>  <span class='hs-varid'>tcInstHeadTyNotSynonym</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstHeadTyAppAllTyVars</span><span class='hs-layout'>,</span>
<a name="line-36"></a>  <span class='hs-varid'>tcGetTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetTyVar</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>tcSplitSigmaTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcDeepSplitSigmaTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>  <span class='hs-comment'>---------------------------------</span>
<a name="line-40"></a>  <span class='hs-comment'>-- Predicates.</span>
<a name="line-41"></a>  <span class='hs-comment'>-- Again, newtypes are opaque</span>
<a name="line-42"></a>  <span class='hs-varid'>eqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpType</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTypeX</span><span class='hs-layout'>,</span>
<a name="line-43"></a>  <span class='hs-varid'>pickyEqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcEqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcEqKind</span><span class='hs-layout'>,</span>
<a name="line-44"></a>  <span class='hs-varid'>isSigmaTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isOverloadedTy</span><span class='hs-layout'>,</span>
<a name="line-45"></a>  <span class='hs-varid'>isDoubleTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFloatTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIntTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWordTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStringTy</span><span class='hs-layout'>,</span>
<a name="line-46"></a>  <span class='hs-varid'>isIntegerTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBoolTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCharTy</span><span class='hs-layout'>,</span>
<a name="line-47"></a>  <span class='hs-varid'>isTauTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTauTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIsTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIsForAllTy</span><span class='hs-layout'>,</span>
<a name="line-48"></a>  <span class='hs-varid'>isSynFamilyTyConApp</span><span class='hs-layout'>,</span>
<a name="line-49"></a>  <span class='hs-varid'>isPredTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTyVarClassPred</span><span class='hs-layout'>,</span>
<a name="line-50"></a>
<a name="line-51"></a>  <span class='hs-comment'>---------------------------------</span>
<a name="line-52"></a>  <span class='hs-comment'>-- Misc type manipulators</span>
<a name="line-53"></a>  <span class='hs-varid'>deNoteType</span><span class='hs-layout'>,</span> <span class='hs-varid'>occurCheckExpand</span><span class='hs-layout'>,</span> <span class='hs-conid'>OccCheckResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-54"></a>  <span class='hs-varid'>orphNamesOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>orphNamesOfDFunHead</span><span class='hs-layout'>,</span> <span class='hs-varid'>orphNamesOfCo</span><span class='hs-layout'>,</span>
<a name="line-55"></a>  <span class='hs-varid'>orphNamesOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>orphNamesOfCoCon</span><span class='hs-layout'>,</span>
<a name="line-56"></a>  <span class='hs-varid'>getDFunTyKey</span><span class='hs-layout'>,</span>
<a name="line-57"></a>  <span class='hs-varid'>evVarPred_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>evVarPred</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>  <span class='hs-comment'>---------------------------------</span>
<a name="line-60"></a>  <span class='hs-comment'>-- Predicate types</span>
<a name="line-61"></a>  <span class='hs-varid'>mkMinimalBySCs</span><span class='hs-layout'>,</span> <span class='hs-varid'>transSuperClasses</span><span class='hs-layout'>,</span> <span class='hs-varid'>immSuperClasses</span><span class='hs-layout'>,</span>
<a name="line-62"></a>
<a name="line-63"></a>  <span class='hs-comment'>-- * Finding type instances</span>
<a name="line-64"></a>  <span class='hs-varid'>tcTyFamInsts</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>  <span class='hs-comment'>-- * Finding "exact" (non-dead) type variables</span>
<a name="line-67"></a>  <span class='hs-varid'>exactTyVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>exactTyVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-68"></a>
<a name="line-69"></a>  <span class='hs-comment'>---------------------------------</span>
<a name="line-70"></a>  <span class='hs-comment'>-- Foreign import and export</span>
<a name="line-71"></a>  <span class='hs-varid'>isFFIArgumentTy</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- :: DynFlags -&gt; Safety -&gt; Type -&gt; Bool</span>
<a name="line-72"></a>  <span class='hs-varid'>isFFIImportResultTy</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- :: DynFlags -&gt; Type -&gt; Bool</span>
<a name="line-73"></a>  <span class='hs-varid'>isFFIExportResultTy</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- :: Type -&gt; Bool</span>
<a name="line-74"></a>  <span class='hs-varid'>isFFIExternalTy</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- :: Type -&gt; Bool</span>
<a name="line-75"></a>  <span class='hs-varid'>isFFIDynTy</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- :: Type -&gt; Type -&gt; Bool</span>
<a name="line-76"></a>  <span class='hs-varid'>isFFIPrimArgumentTy</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- :: DynFlags -&gt; Type -&gt; Bool</span>
<a name="line-77"></a>  <span class='hs-varid'>isFFIPrimResultTy</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- :: DynFlags -&gt; Type -&gt; Bool</span>
<a name="line-78"></a>  <span class='hs-varid'>isFFILabelTy</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- :: Type -&gt; Bool</span>
<a name="line-79"></a>  <span class='hs-varid'>isFFIDotnetTy</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- :: DynFlags -&gt; Type -&gt; Bool</span>
<a name="line-80"></a>  <span class='hs-varid'>isFFIDotnetObjTy</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- :: Type -&gt; Bool</span>
<a name="line-81"></a>  <span class='hs-varid'>isFFITy</span><span class='hs-layout'>,</span>             <span class='hs-comment'>-- :: Type -&gt; Bool</span>
<a name="line-82"></a>  <span class='hs-varid'>isFunPtrTy</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- :: Type -&gt; Bool</span>
<a name="line-83"></a>  <span class='hs-varid'>tcSplitIOType_maybe</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- :: Type -&gt; Maybe Type</span>
<a name="line-84"></a>
<a name="line-85"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-86"></a>  <span class='hs-comment'>-- Rexported from Kind</span>
<a name="line-87"></a>  <span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeKind</span><span class='hs-layout'>,</span>
<a name="line-88"></a>  <span class='hs-varid'>unliftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span>
<a name="line-89"></a>  <span class='hs-varid'>openTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>constraintKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkArrowKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkArrowKinds</span><span class='hs-layout'>,</span>
<a name="line-90"></a>  <span class='hs-varid'>isLiftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSubOpenTypeKind</span><span class='hs-layout'>,</span>
<a name="line-91"></a>  <span class='hs-varid'>tcIsSubKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitKindFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>defaultKind</span><span class='hs-layout'>,</span>
<a name="line-92"></a>
<a name="line-93"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-94"></a>  <span class='hs-comment'>-- Rexported from Type</span>
<a name="line-95"></a>  <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>PredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>
<a name="line-96"></a>  <span class='hs-varid'>mkForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span><span class='hs-layout'>,</span>
<a name="line-97"></a>  <span class='hs-varid'>mkFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipFunTys</span><span class='hs-layout'>,</span>
<a name="line-98"></a>  <span class='hs-varid'>mkTyConApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>applyTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>applyTys</span><span class='hs-layout'>,</span>
<a name="line-99"></a>  <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConTy</span><span class='hs-layout'>,</span>
<a name="line-100"></a>
<a name="line-101"></a>  <span class='hs-varid'>isClassPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIPPred</span><span class='hs-layout'>,</span>
<a name="line-102"></a>  <span class='hs-varid'>mkClassPred</span><span class='hs-layout'>,</span>
<a name="line-103"></a>  <span class='hs-varid'>isDictLikeTy</span><span class='hs-layout'>,</span>
<a name="line-104"></a>  <span class='hs-varid'>tcSplitDFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitDFunHead</span><span class='hs-layout'>,</span>
<a name="line-105"></a>  <span class='hs-varid'>mkEqPred</span><span class='hs-layout'>,</span>
<a name="line-106"></a>
<a name="line-107"></a>  <span class='hs-comment'>-- Type substitutions</span>
<a name="line-108"></a>  <span class='hs-conid'>TvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Representation visible to a few friends</span>
<a name="line-109"></a>  <span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTvSubst</span><span class='hs-layout'>,</span>
<a name="line-110"></a>  <span class='hs-varid'>mkOpenTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipOpenTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTopTvSubst</span><span class='hs-layout'>,</span>
<a name="line-111"></a>  <span class='hs-varid'>mkTopTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>notElemTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionTvSubst</span><span class='hs-layout'>,</span>
<a name="line-112"></a>  <span class='hs-varid'>getTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvInScope</span><span class='hs-layout'>,</span>
<a name="line-113"></a>  <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span>
<a name="line-114"></a>  <span class='hs-varid'>extendTvSubstList</span><span class='hs-layout'>,</span> <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTyEnv</span><span class='hs-layout'>,</span>
<a name="line-115"></a>  <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span><span class='hs-layout'>,</span>
<a name="line-116"></a>
<a name="line-117"></a>  <span class='hs-varid'>isUnLiftedType</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Source types are always lifted</span>
<a name="line-118"></a>  <span class='hs-varid'>isUnboxedTupleType</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Ditto</span>
<a name="line-119"></a>  <span class='hs-varid'>isPrimitiveType</span><span class='hs-layout'>,</span>
<a name="line-120"></a>
<a name="line-121"></a>  <span class='hs-varid'>tyVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKinds</span><span class='hs-layout'>,</span>
<a name="line-122"></a>  <span class='hs-varid'>tcTyVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-123"></a>
<a name="line-124"></a>  <span class='hs-varid'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSigmaType</span><span class='hs-layout'>,</span>
<a name="line-125"></a>  <span class='hs-varid'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTypeApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyThingCategory</span><span class='hs-layout'>,</span>
<a name="line-126"></a>  <span class='hs-varid'>pprTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprThetaArrowTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprClassPred</span>
<a name="line-127"></a>
<a name="line-128"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-129"></a>
<a name="line-130"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-131"></a>
<a name="line-132"></a><span class='hs-comment'>-- friends:</span>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-comment'>-- others:</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-comment'>-- hiding (varName)</span>
<a name="line-147"></a>            <span class='hs-comment'>-- We use this to make dictionaries for type literals.</span>
<a name="line-148"></a>            <span class='hs-comment'>-- Perhaps there's a better way to do this?</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-159"></a>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftM</span><span class='hs-layout'>,</span> <span class='hs-varid'>ap</span><span class='hs-layout'>)</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-layout'>(</span><span class='hs-conid'>Applicative</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Types}
%*                                                                      *
%************************************************************************

The type checker divides the generic Type world into the
following more structured beasts:

sigma ::= forall tyvars. phi
        -- A sigma type is a qualified type
        --
        -- Note that even if 'tyvars' is empty, theta
        -- may not be: e.g.   (?x::Int) => Int

        -- Note that 'sigma' is in prenex form:
        -- all the foralls are at the front.
        -- A 'phi' type has no foralls to the right of
        -- an arrow

phi :: theta => rho

rho ::= sigma -> rho
     |  tau

-- A 'tau' type has no quantification anywhere
-- Note that the args of a type constructor must be taus
tau ::= tyvar
     |  tycon tau_1 .. tau_n
     |  tau_1 tau_2
     |  tau_1 -> tau_2

-- In all cases, a (saturated) type synonym application is legal,
-- provided it expands to the required form.

\begin{code}
<pre><a name="line-1"></a><a name="TcTyVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVar</span>    <span class='hs-comment'>-- Used only during type inference</span>
<a name="line-2"></a><a name="TcCoVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcCoVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVar</span>    <span class='hs-comment'>-- Used only during type inference; mutable</span>
<a name="line-3"></a><a name="TcType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>      <span class='hs-comment'>-- A TcType can have mutable type variables</span>
<a name="line-4"></a>        <span class='hs-comment'>-- Invariant on ForAllTy in TcTypes:</span>
<a name="line-5"></a>        <span class='hs-comment'>--      forall a. T</span>
<a name="line-6"></a>        <span class='hs-comment'>-- a cannot occur inside a MutTyVar in T; that is,</span>
<a name="line-7"></a>        <span class='hs-comment'>-- T is "flattened" before quantifying over a</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="TcPredType"></a><span class='hs-comment'>-- These types do not have boxy type variables in them</span>
<a name="line-10"></a><a name="TcPredType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcPredType</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PredType</span>
<a name="line-11"></a><a name="TcThetaType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcThetaType</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ThetaType</span>
<a name="line-12"></a><a name="TcSigmaType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcSigmaType</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcType</span>
<a name="line-13"></a><a name="TcRhoType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRhoType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcType</span>
<a name="line-14"></a><a name="TcTauType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTauType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcType</span>
<a name="line-15"></a><a name="TcKind"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcKind</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Kind</span>
<a name="line-16"></a><a name="TcTyVarSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTyVarSet</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarSet</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{TyVarDetails}
%*                                                                      *
%************************************************************************

TyVarDetails gives extra info about type variables, used during type
checking.  It's attached to mutable type variables only.
It's knot-tied back to Var.lhs.  There is no reason in principle
why Var.lhs shouldn't actually have the definition, but it "belongs" here.

Note [Signature skolems]
~~~~~~~~~~~~~~~~~~~~~~~~
Consider this

  f :: forall a. [a] -> Int
  f (x::b : xs) = 3

Here 'b' is a lexically scoped type variable, but it turns out to be
the same as the skolem 'a'.  So we have a special kind of skolem
constant, SigTv, which can unify with other SigTvs. They are used
*only* for pattern type signatures.

Similarly consider
  data T (a:k1) = MkT (S a)
  data S (b:k2) = MkS (T b)
When doing kind inference on {S,T} we don't want *skolems* for k1,k2,
because they end up unifying; we want those SigTvs again.

\begin{code}
<pre><a name="line-1"></a><a name="TcTyVarDetails"></a><span class='hs-comment'>-- A TyVarDetails is inside a TyVar</span>
<a name="line-2"></a><a name="TcTyVarDetails"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyVarDetails</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SkolemTv</span>      <span class='hs-comment'>-- A skolem</span>
<a name="line-4"></a>       <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- True &lt;=&gt; this skolem type variable can be overlapped</span>
<a name="line-5"></a>                  <span class='hs-comment'>--          when looking up instances</span>
<a name="line-6"></a>                  <span class='hs-comment'>-- See Note [Binding when looking up instances] in InstEnv</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuntimeUnk</span>    <span class='hs-comment'>-- Stands for an as-yet-unknown type in the GHCi</span>
<a name="line-9"></a>                  <span class='hs-comment'>-- interactive context</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FlatSkol</span> <span class='hs-conid'>TcType</span>
<a name="line-12"></a>           <span class='hs-comment'>-- The "skolem" obtained by flattening during</span>
<a name="line-13"></a>           <span class='hs-comment'>-- constraint simplification</span>
<a name="line-14"></a>
<a name="line-15"></a>           <span class='hs-comment'>-- In comments we will use the notation alpha[flat = ty]</span>
<a name="line-16"></a>           <span class='hs-comment'>-- to represent a flattening skolem variable alpha</span>
<a name="line-17"></a>           <span class='hs-comment'>-- identified with type ty.</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaInfo</span>
<a name="line-20"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>mtv_ref</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>MetaDetails</span>
<a name="line-21"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>mtv_untch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- See Note [Untouchable type variables]</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="vanillaSkolemTv"></a><span class='hs-definition'>vanillaSkolemTv</span><span class='hs-layout'>,</span> <span class='hs-varid'>superSkolemTv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVarDetails</span>
<a name="line-24"></a><span class='hs-comment'>-- See Note [Binding when looking up instances] in InstEnv</span>
<a name="line-25"></a><span class='hs-definition'>vanillaSkolemTv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- Might be instantiated</span>
<a name="line-26"></a><a name="superSkolemTv"></a><span class='hs-definition'>superSkolemTv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- Treat this as a completely distinct type</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="MetaDetails"></a><span class='hs-comment'>-----------------------------</span>
<a name="line-29"></a><a name="MetaDetails"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MetaDetails</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Flexi</span>  <span class='hs-comment'>-- Flexi type variables unify to become Indirects</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Indirect</span> <span class='hs-conid'>TcType</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>MetaDetails</span> <span class='hs-keyword'>where</span>
<a name="line-34"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Flexi</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Flexi"</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Indirect"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="MetaInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MetaInfo</span>
<a name="line-38"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TauTv</span>         <span class='hs-comment'>-- This MetaTv is an ordinary unification variable</span>
<a name="line-39"></a>                   <span class='hs-comment'>-- A TauTv is always filled in with a tau-type, which</span>
<a name="line-40"></a>                   <span class='hs-comment'>-- never contains any ForAlls</span>
<a name="line-41"></a>
<a name="line-42"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PolyTv</span>        <span class='hs-comment'>-- Like TauTv, but can unify with a sigma-type</span>
<a name="line-43"></a>
<a name="line-44"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SigTv</span>         <span class='hs-comment'>-- A variant of TauTv, except that it should not be</span>
<a name="line-45"></a>                   <span class='hs-comment'>-- unified with a type, only with a type variable</span>
<a name="line-46"></a>                   <span class='hs-comment'>-- SigTvs are only distinguished to improve error messages</span>
<a name="line-47"></a>                   <span class='hs-comment'>--      see Note [Signature skolems]</span>
<a name="line-48"></a>                   <span class='hs-comment'>--      The MetaDetails, if filled in, will</span>
<a name="line-49"></a>                   <span class='hs-comment'>--      always be another SigTv or a SkolemTv</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-comment'>-------------------------------------</span>
<a name="line-52"></a><span class='hs-comment'>-- UserTypeCtxt describes the origin of the polymorphic type</span>
<a name="line-53"></a><span class='hs-comment'>-- in the places where we need to an expression has that type</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="UserTypeCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- Function type signature</span>
<a name="line-57"></a>                        <span class='hs-comment'>-- Also used for types in SPECIALISE pragmas</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InfSigCtxt</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- Inferred type for function</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ExprSigCtxt</span>         <span class='hs-comment'>-- Expression type signature</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ConArgCtxt</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- Data constructor argument</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TySynCtxt</span> <span class='hs-conid'>Name</span>      <span class='hs-comment'>-- RHS of a type synonym decl</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LamPatSigCtxt</span>               <span class='hs-comment'>-- Type sig in lambda pattern</span>
<a name="line-63"></a>                        <span class='hs-comment'>--      f (x::t) = ...</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BindPatSigCtxt</span>      <span class='hs-comment'>-- Type sig in pattern binding pattern</span>
<a name="line-65"></a>                        <span class='hs-comment'>--      (x::t, y) = e</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuleSigCtxt</span> <span class='hs-conid'>Name</span>    <span class='hs-comment'>-- LHS of a RULE forall</span>
<a name="line-67"></a>                        <span class='hs-comment'>--    RULE "foo" forall (x :: a -&gt; a). f (Just x) = ...</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ResSigCtxt</span>          <span class='hs-comment'>-- Result type sig</span>
<a name="line-69"></a>                        <span class='hs-comment'>--      f x :: t = ....</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForSigCtxt</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- Foreign import or export signature</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DefaultDeclCtxt</span>     <span class='hs-comment'>-- Types in a default declaration</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstDeclCtxt</span>        <span class='hs-comment'>-- An instance declaration</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SpecInstCtxt</span>        <span class='hs-comment'>-- SPECIALISE instance pragma</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ThBrackCtxt</span>         <span class='hs-comment'>-- Template Haskell type brackets [t| ... |]</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GenSigCtxt</span>          <span class='hs-comment'>-- Higher-rank or impredicative situations</span>
<a name="line-76"></a>                        <span class='hs-comment'>-- e.g. (f e) where f has a higher-rank type</span>
<a name="line-77"></a>                        <span class='hs-comment'>-- We might want to elaborate this</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GhciCtxt</span>            <span class='hs-comment'>-- GHCi command :kind &lt;type&gt;</span>
<a name="line-79"></a>
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassSCCtxt</span> <span class='hs-conid'>Name</span>    <span class='hs-comment'>-- Superclasses of a class</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SigmaCtxt</span>           <span class='hs-comment'>-- Theta part of a normal for-all type</span>
<a name="line-82"></a>                        <span class='hs-comment'>--      f :: &lt;S&gt; =&gt; a -&gt; a</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataTyCtxt</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- Theta part of a data decl</span>
<a name="line-84"></a>                        <span class='hs-comment'>--      data &lt;S&gt; =&gt; T a = MkT a</span>
</pre>\end{code}


-- Notes re TySynCtxt
-- We allow type synonyms that aren't types; e.g.  type List = []
--
-- If the RHS mentions tyvars that aren't in scope, we'll
-- quantify over them:
--      e.g.    type T = a->a
-- will become  type T = forall a. a->a
--
-- With gla-exts that's right, but for H98 we should complain.


%************************************************************************
%*                                                                      *
                Untoucable type variables
%*                                                                      *
%************************************************************************

Note [Untouchable type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Each unification variable (MetaTv)
  and each Implication
  has a level number (of type Untouchables)

* INVARIANTS.  In a tree of Implications,

    (ImplicInv) The level number of an Implication is
                STRICTLY GREATER THAN that of its parent

    (MetaTvInv) The level number of a unification variable is
                LESS THAN OR EQUAL TO that of its parent
                implication

* A unification variable is *touchable* if its level number
  is EQUAL TO that of its immediate parent implication.

* INVARIANT
    (GivenInv)  The free variables of the ic_given of an
                implication are all untouchable; ie their level
                numbers are LESS THAN the ic_untch of the implication


Note [Skolem escape prevention]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We only unify touchable unification variables.  Because of
(MetaTvInv), there can be no occurrences of he variable further out,
so the unification can't cause the kolems to escape. Example:
     data T = forall a. MkT a (a->Int)
     f x (MkT v f) = length [v,x]
We decide (x::alpha), and generate an implication like
      [1]forall a. (a ~ alpha[0])
But we must not unify alpha:=a, because the skolem would escape.

For the cases where we DO want to unify, we rely on floating the
equality.   Example (with same T)
     g x (MkT v f) = x && True
We decide (x::alpha), and generate an implication like
      [1]forall a. (Bool ~ alpha[0])
We do NOT unify directly, bur rather float out (if the constraint
does not mention 'a') to get
      (Bool ~ alpha[0]) /\ [1]forall a.()
and NOW we can unify alpha.

The same idea of only unifying touchables solves another problem.
Suppose we had
   (F Int ~ uf[0])  /\  [1](forall a. C a => F Int ~ beta[1])
In this example, beta is touchable inside the implication. The
first solveInteract step leaves 'uf' un-unified. Then we move inside
the implication where a new constraint
       uf  ~  beta
emerges. If we (wrongly) spontaneously solved it to get uf := beta,
the whole implication disappears but when we pop out again we are left with
(F Int ~ uf) which will be unified by our final solveCTyFunEqs stage and
uf will get unified *once more* to (F Int).

\begin{code}
<pre><a name="line-1"></a><a name="Untouchables"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Untouchables</span> <span class='hs-conid'>Int</span>
<a name="line-2"></a>  <span class='hs-comment'>-- See Note [Untouchable type variables] for what this Int is</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="noUntouchables"></a><span class='hs-definition'>noUntouchables</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span>
<a name="line-5"></a><span class='hs-definition'>noUntouchables</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Untouchables</span> <span class='hs-num'>0</span>   <span class='hs-comment'>-- 0 = outermost level</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="pushUntouchables"></a><span class='hs-definition'>pushUntouchables</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span>
<a name="line-8"></a><span class='hs-definition'>pushUntouchables</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Untouchables</span> <span class='hs-layout'>(</span><span class='hs-varid'>us</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="isFloatedTouchable"></a><span class='hs-definition'>isFloatedTouchable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-definition'>isFloatedTouchable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>ctxt_untch</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>tv_untch</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>tv_untch</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="isTouchable"></a><span class='hs-definition'>isTouchable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-15"></a><span class='hs-definition'>isTouchable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>ctxt_untch</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>tv_untch</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv_untch</span>   <span class='hs-comment'>-- NB: invariant ctxt_untch &gt;= tv_untch</span>
<a name="line-17"></a>                             <span class='hs-comment'>--     So &lt;= would be equivalent</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="checkTouchableInvariant"></a><span class='hs-definition'>checkTouchableInvariant</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-20"></a><span class='hs-comment'>-- Checks (MetaTvInv) from Note [Untouchable type variables]</span>
<a name="line-21"></a><span class='hs-definition'>checkTouchableInvariant</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>ctxt_untch</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>tv_untch</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>tv_untch</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyword'>where</span>
<a name="line-25"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>us</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Pretty-printing
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="pprTcTyVarDetails"></a><span class='hs-definition'>pprTcTyVarDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVarDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-comment'>-- For debugging</span>
<a name="line-3"></a><span class='hs-definition'>pprTcTyVarDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ssk"</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>pprTcTyVarDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"sk"</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>pprTcTyVarDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"rt"</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>pprTcTyVarDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"fsk"</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>pprTcTyVarDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>mtv_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>untch</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_info</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>untch</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>pp_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>                <span class='hs-conid'>PolyTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"poly"</span><span class='hs-layout'>)</span>
<a name="line-12"></a>                <span class='hs-conid'>TauTv</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tau"</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                <span class='hs-conid'>SigTv</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"sig"</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="pprUserTypeCtxt"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-16"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the inferred type for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the type signature for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a RULE for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>ExprSigCtxt</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an expression type signature"</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConArgCtxt</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the type of the constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynCtxt</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the RHS of the type synonym"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>ThBrackCtxt</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a Template Haskell quotation [t|...|]"</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>LamPatSigCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern type signature"</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>BindPatSigCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern type signature"</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>ResSigCtxt</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a result type signature"</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the foreign declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>DefaultDeclCtxt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a type in a `default' declaration"</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>InstDeclCtxt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an instance declaration"</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>SpecInstCtxt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a SPECIALISE instance pragma"</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>GenSigCtxt</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a type expected by the context"</span><span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>GhciCtxt</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a type in a GHCi command"</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassSCCtxt</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the super-classes of class"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-conid'>SigmaCtxt</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the context of a polymorphic type"</span><span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-definition'>pprUserTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataTyCtxt</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the context of the data type declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                  *
    Finding type family instances
%*                  *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcTyFamInsts"></a><span class='hs-comment'>-- | Finds outermost type-family applications occuring in a type,</span>
<a name="line-2"></a><span class='hs-comment'>-- after expanding synonyms.</span>
<a name="line-3"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>exp_ty</span>
<a name="line-6"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-7"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-11"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>ty2</span>
<a name="line-12"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>ty2</span>
<a name="line-13"></a><span class='hs-definition'>tcTyFamInsts</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>ty</span>
</pre>\end{code}

%************************************************************************
%*                  *
          The "exact" free variables of a type
%*                  *
%************************************************************************

Note [Silly type synonym]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  type T a = Int
What are the free tyvars of (T x)?  Empty, of course!
Here's the example that Ralf Laemmel showed me:
  foo :: (forall a. C u a -> C u a) -> u
  mappend :: Monoid u => u -> u -> u

  bar :: Monoid u => u
  bar = foo (\t -> t `mappend` t)
We have to generalise at the arg to f, and we don't
want to capture the constraint (Monad (C u a)) because
it appears to mention a.  Pretty silly, but it was useful to him.

exactTyVarsOfType is used by the type checker to figure out exactly
which type variables are mentioned in a type.  It's also used in the
smart-app checking code --- see TcExpr.tcIdApp

On the other hand, consider a *top-level* definition
  f = (\x -> x) :: T a -> T a
If we don't abstract over 'a' it'll get fixed to GHC.Prim.Any, and then
if we have an application like (f "x") we get a confusing error message
involving Any.  So the conclusion is this: when generalising
  - at top level use tyVarsOfType
  - in nested bindings use exactTyVarsOfType
See Trac #1813 for example.

\begin{code}
<pre><a name="line-1"></a><a name="exactTyVarsOfType"></a><span class='hs-definition'>exactTyVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-2"></a><span class='hs-comment'>-- Find the free type variables (of any kind)</span>
<a name="line-3"></a><span class='hs-comment'>-- but *expand* type synonyms.  See Note [Silly type synonym] above.</span>
<a name="line-4"></a><span class='hs-definition'>exactTyVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>  <span class='hs-comment'>-- This is the key line</span>
<a name="line-8"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv</span>
<a name="line-9"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exactTyVarsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-10"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-11"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-12"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-13"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvar</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="exactTyVarsOfTypes"></a><span class='hs-definition'>exactTyVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-16"></a><span class='hs-definition'>exactTyVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>exactTyVarsOfType</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>tys</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Predicates
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="isTouchableMetaTyVar"></a><span class='hs-definition'>isTouchableMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>isTouchableMetaTyVar</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varid'>tv</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-4"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-5"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_untch</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>checkTouchableInvariant</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varid'>tv_untch</span><span class='hs-layout'>,</span>
<a name="line-7"></a>                    <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_untch</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-layout'>)</span>
<a name="line-8"></a>           <span class='hs-varid'>isTouchable</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varid'>tv_untch</span>
<a name="line-9"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="isFloatedTouchableMetaTyVar"></a><span class='hs-definition'>isFloatedTouchableMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-12"></a><span class='hs-definition'>isFloatedTouchableMetaTyVar</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varid'>tv</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-14"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-15"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_untch</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isFloatedTouchable</span> <span class='hs-varid'>ctxt_untch</span> <span class='hs-varid'>tv_untch</span>
<a name="line-16"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="isImmutableTyVar"></a><span class='hs-definition'>isImmutableTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-19"></a><span class='hs-definition'>isImmutableTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="isTyConableTyVar"></a><span class='hs-definition'>isTyConableTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSkolemTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isOverlappableTyVar</span><span class='hs-layout'>,</span>
<a name="line-24"></a>  <span class='hs-varid'>isMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAmbiguousTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFlatSkolTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>isTyConableTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-27"></a>        <span class='hs-comment'>-- True of a meta-type variable that can be filled in</span>
<a name="line-28"></a>        <span class='hs-comment'>-- with a type constructor application; in particular,</span>
<a name="line-29"></a>        <span class='hs-comment'>-- not a SigTv</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-32"></a>        <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-33"></a>        <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="isFlatSkolTyVar"></a><span class='hs-definition'>isFlatSkolTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-37"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>        <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-39"></a>        <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="isSkolemTyVar"></a><span class='hs-definition'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-43"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>        <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-45"></a>        <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-46"></a>        <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-47"></a>        <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="isOverlappableTyVar"></a><span class='hs-definition'>isOverlappableTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-51"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-52"></a>        <span class='hs-conid'>SkolemTv</span> <span class='hs-varid'>overlappable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>overlappable</span>
<a name="line-53"></a>        <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="isMetaTyVar"></a><span class='hs-definition'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-57"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-58"></a>        <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-59"></a>        <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="isAmbiguousTyVar"></a><span class='hs-comment'>-- isAmbiguousTyVar is used only when reporting type errors</span>
<a name="line-62"></a><span class='hs-comment'>-- It picks out variables that are unbound, namely meta</span>
<a name="line-63"></a><span class='hs-comment'>-- type variables and the RuntimUnk variables created by</span>
<a name="line-64"></a><span class='hs-comment'>-- RtClosureInspect.zonkRTTIType.  These are "ambiguous" in</span>
<a name="line-65"></a><span class='hs-comment'>-- the sense that they stand for an as-yet-unknown type</span>
<a name="line-66"></a><span class='hs-definition'>isAmbiguousTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-68"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-69"></a>        <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-70"></a>        <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-71"></a>        <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="isMetaTyVarTy"></a><span class='hs-definition'>isMetaTyVarTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-74"></a><span class='hs-definition'>isMetaTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-75"></a><span class='hs-definition'>isMetaTyVarTy</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="metaTyVarInfo"></a><span class='hs-definition'>metaTyVarInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MetaInfo</span>
<a name="line-78"></a><span class='hs-definition'>metaTyVarInfo</span> <span class='hs-varid'>tv</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-80"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-81"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>info</span>
<a name="line-82"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"metaTyVarInfo"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="metaTyVarUntouchables"></a><span class='hs-definition'>metaTyVarUntouchables</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span>
<a name="line-85"></a><span class='hs-definition'>metaTyVarUntouchables</span> <span class='hs-varid'>tv</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-87"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-88"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>untch</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>untch</span>
<a name="line-89"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"metaTyVarUntouchables"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="setMetaTyVarUntouchables"></a><span class='hs-definition'>setMetaTyVarUntouchables</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-92"></a><span class='hs-definition'>setMetaTyVarUntouchables</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>untch</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-94"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-95"></a>      <span class='hs-varid'>details</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setTcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>details</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>untch</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-96"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"metaTyVarUntouchables"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="isSigTyVar"></a><span class='hs-definition'>isSigTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-99"></a><span class='hs-definition'>isSigTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-101"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-102"></a>        <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-103"></a>        <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="metaTvRef"></a><span class='hs-definition'>metaTvRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>MetaDetails</span>
<a name="line-106"></a><span class='hs-definition'>metaTvRef</span> <span class='hs-varid'>tv</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-108"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-109"></a>        <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ref</span>
<a name="line-110"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"metaTvRef"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="isFlexi"></a><span class='hs-definition'>isFlexi</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIndirect</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-113"></a><span class='hs-definition'>isFlexi</span> <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-114"></a><span class='hs-definition'>isFlexi</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="isIndirect"></a><span class='hs-definition'>isIndirect</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indirect</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-117"></a><span class='hs-definition'>isIndirect</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="isRuntimeUnkSkol"></a><span class='hs-definition'>isRuntimeUnkSkol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-120"></a><span class='hs-comment'>-- Called only in TcErrors; see Note [Runtime skolems] there</span>
<a name="line-121"></a><span class='hs-definition'>isRuntimeUnkSkol</span> <span class='hs-varid'>x</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>RuntimeUnk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Tau, sigma and rho}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkSigmaTy"></a><span class='hs-definition'>mkSigmaTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>mkSigmaTy</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="mkPhiTy"></a><span class='hs-definition'>mkPhiTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-5"></a><span class='hs-definition'>mkPhiTy</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>theta</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mkTcEqPred"></a><span class='hs-definition'>mkTcEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-8"></a><span class='hs-comment'>-- During type checking we build equalities between</span>
<a name="line-9"></a><span class='hs-comment'>-- type variables with OpenKind or ArgKind.  Ultimately</span>
<a name="line-10"></a><span class='hs-comment'>-- they will all settle, but we want the equality predicate</span>
<a name="line-11"></a><span class='hs-comment'>-- itself to have kind '*'.  I think.</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>-- But for now we call mkTyConApp, not mkEqPred, because the invariants</span>
<a name="line-14"></a><span class='hs-comment'>-- of the latter might not be satisfied during type checking.</span>
<a name="line-15"></a><span class='hs-comment'>-- Notably when we form an equalty   (a : OpenKind) ~ (Int : *)</span>
<a name="line-16"></a><span class='hs-comment'>--</span>
<a name="line-17"></a><span class='hs-comment'>-- But this is horribly delicate: what about type variables</span>
<a name="line-18"></a><span class='hs-comment'>-- that turn out to be bound to Int#?</span>
<a name="line-19"></a><span class='hs-definition'>mkTcEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>eqTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
</pre>\end{code}

@isTauTy@ tests for nested for-alls.  It should not be called on a boxy type.

\begin{code}
<pre><a name="line-1"></a><a name="isTauTy"></a><span class='hs-definition'>isTauTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>isTauTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>ty'</span>
<a name="line-3"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-4"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-5"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTauTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-6"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>b</span>
<a name="line-7"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>b</span>
<a name="line-8"></a><span class='hs-definition'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="isTauTyCon"></a><span class='hs-definition'>isTauTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-comment'>-- Returns False for type synonyms whose expansion is a polytype</span>
<a name="line-12"></a><span class='hs-definition'>isTauTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConDefn_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTauTy</span> <span class='hs-varid'>rhs</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="getDFunTyKey"></a><span class='hs-comment'>---------------</span>
<a name="line-17"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-comment'>-- Get some string from a type, to be used to</span>
<a name="line-18"></a>                                <span class='hs-comment'>-- construct a dictionary function name</span>
<a name="line-19"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getDFunTyKey</span> <span class='hs-varid'>ty'</span>
<a name="line-20"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv</span>
<a name="line-21"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tc</span>
<a name="line-22"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getDFunTyLitKey</span> <span class='hs-varid'>x</span>
<a name="line-23"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getDFunTyKey</span> <span class='hs-varid'>fun</span>
<a name="line-24"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>funTyCon</span>
<a name="line-25"></a><span class='hs-definition'>getDFunTyKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getDFunTyKey</span> <span class='hs-varid'>t</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="getDFunTyLitKey"></a><span class='hs-definition'>getDFunTyLitKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-28"></a><span class='hs-definition'>getDFunTyLitKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-definition'>getDFunTyLitKey</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- hm</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Expanding and splitting}
%*                                                                      *
%************************************************************************

These tcSplit functions are like their non-Tc analogues, but
        *) they do not look through newtypes

However, they are non-monadic and do not follow through mutable type
variables.  It's up to you to make sure this doesn't matter.

\begin{code}
<pre><a name="line-1"></a><a name="tcSplitForAllTys"></a><span class='hs-definition'>tcSplitForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tcSplitForAllTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-3"></a>   <span class='hs-keyword'>where</span>
<a name="line-4"></a>     <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>tvs</span>
<a name="line-5"></a>     <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>     <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>          <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="tcIsForAllTy"></a><span class='hs-definition'>tcIsForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-9"></a><span class='hs-definition'>tcIsForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIsForAllTy</span> <span class='hs-varid'>ty'</span>
<a name="line-10"></a><span class='hs-definition'>tcIsForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-11"></a><span class='hs-definition'>tcIsForAllTy</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="tcSplitPredFunTy_maybe"></a><span class='hs-definition'>tcSplitPredFunTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>PredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-comment'>-- Split off the first predicate argument from a type</span>
<a name="line-15"></a><span class='hs-definition'>tcSplitPredFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPredFunTy_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-17"></a><span class='hs-definition'>tcSplitPredFunTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>tcSplitPredFunTy_maybe</span> <span class='hs-keyword'>_</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="tcSplitPhiTy"></a><span class='hs-definition'>tcSplitPhiTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-definition'>tcSplitPhiTy</span> <span class='hs-varid'>ty</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ts</span>
<a name="line-27"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitPredFunTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-28"></a>          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-29"></a>          <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="tcSplitSigmaTy"></a><span class='hs-definition'>tcSplitSigmaTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-definition'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-33"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitPhiTy</span> <span class='hs-varid'>rho</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>                                        <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="tcDeepSplitSigmaTy_maybe"></a><span class='hs-comment'>-----------------------</span>
<a name="line-37"></a><span class='hs-definition'>tcDeepSplitSigmaTy_maybe</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-comment'>-- Looks for a *non-trivial* quantified type, under zero or more function arrows</span>
<a name="line-40"></a><span class='hs-comment'>-- By "non-trivial" we mean either tyvars or constraints are non-empty</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-definition'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-44"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeepSplitSigmaTy_maybe</span> <span class='hs-varid'>res_ty</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="tcTyConAppTyCon"></a><span class='hs-comment'>-----------------------</span>
<a name="line-54"></a><span class='hs-definition'>tcTyConAppTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-55"></a><span class='hs-definition'>tcTyConAppTyCon</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-56"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span>
<a name="line-57"></a>                        <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcTyConAppTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="tcTyConAppArgs"></a><span class='hs-definition'>tcTyConAppArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-60"></a><span class='hs-definition'>tcTyConAppArgs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-61"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>args</span>
<a name="line-62"></a>                        <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcTyConAppArgs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="tcSplitTyConApp"></a><span class='hs-definition'>tcSplitTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-definition'>tcSplitTyConApp</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a>                        <span class='hs-conid'>Just</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stuff</span>
<a name="line-67"></a>                        <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSplitTyConApp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="tcSplitTyConApp_maybe"></a><span class='hs-definition'>tcSplitTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-definition'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-71"></a><span class='hs-definition'>tcSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-definition'>tcSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-73"></a>        <span class='hs-comment'>-- Newtypes are opaque, so they may be split</span>
<a name="line-74"></a>        <span class='hs-comment'>-- However, predicates are not treated</span>
<a name="line-75"></a>        <span class='hs-comment'>-- as tycon applications by the type checker</span>
<a name="line-76"></a><span class='hs-definition'>tcSplitTyConApp_maybe</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="tcSplitFunTys"></a><span class='hs-comment'>-----------------------</span>
<a name="line-79"></a><span class='hs-definition'>tcSplitFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-definition'>tcSplitFunTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-81"></a>                        <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-82"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span>
<a name="line-83"></a>                                       <span class='hs-keyword'>where</span>
<a name="line-84"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span><span class='hs-varid'>res'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>res</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="tcSplitFunTy_maybe"></a><span class='hs-definition'>tcSplitFunTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-definition'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-88"></a><span class='hs-definition'>tcSplitFunTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-definition'>tcSplitFunTy_maybe</span> <span class='hs-keyword'>_</span>                                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-90"></a>        <span class='hs-comment'>-- Note the typeKind guard</span>
<a name="line-91"></a>        <span class='hs-comment'>-- Consider     (?x::Int) =&gt; Bool</span>
<a name="line-92"></a>        <span class='hs-comment'>-- We don't want to treat this as a function type!</span>
<a name="line-93"></a>        <span class='hs-comment'>-- A concrete example is test tc230:</span>
<a name="line-94"></a>        <span class='hs-comment'>--      f :: () -&gt; (?p :: ()) =&gt; () -&gt; ()</span>
<a name="line-95"></a>        <span class='hs-comment'>--</span>
<a name="line-96"></a>        <span class='hs-comment'>--      g = f () ()</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="tcSplitFunTysN"></a><span class='hs-definition'>tcSplitFunTysN</span>
<a name="line-99"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-100"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>                <span class='hs-comment'>-- N: Number of desired args</span>
<a name="line-101"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Arg types (N or fewer)</span>
<a name="line-102"></a>            <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- The rest of the type</span>
<a name="line-103"></a>
<a name="line-104"></a><span class='hs-definition'>tcSplitFunTysN</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n_args</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitFunTysN</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_args</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-109"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="tcSplitFunTy"></a><span class='hs-definition'>tcSplitFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-114"></a><span class='hs-definition'>tcSplitFunTy</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"tcSplitFunTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSplitFunTy_maybe</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="tcFunArgTy"></a><span class='hs-definition'>tcFunArgTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-117"></a><span class='hs-definition'>tcFunArgTy</span>    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSplitFunTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="tcFunResultTy"></a><span class='hs-definition'>tcFunResultTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-120"></a><span class='hs-definition'>tcFunResultTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSplitFunTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="tcSplitAppTy_maybe"></a><span class='hs-comment'>-----------------------</span>
<a name="line-123"></a><span class='hs-definition'>tcSplitAppTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-definition'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-125"></a><span class='hs-definition'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="tcSplitAppTy"></a><span class='hs-definition'>tcSplitAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-128"></a><span class='hs-definition'>tcSplitAppTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-129"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stuff</span>
<a name="line-130"></a>                    <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSplitAppTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="tcSplitAppTys"></a><span class='hs-definition'>tcSplitAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-133"></a><span class='hs-definition'>tcSplitAppTys</span> <span class='hs-varid'>ty</span>
<a name="line-134"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-135"></a>  <span class='hs-keyword'>where</span>
<a name="line-136"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-137"></a>                   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-138"></a>                   <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a><a name="tcGetTyVar_maybe"></a><span class='hs-comment'>-----------------------</span>
<a name="line-141"></a><span class='hs-definition'>tcGetTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyVar</span>
<a name="line-142"></a><span class='hs-definition'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-143"></a><span class='hs-definition'>tcGetTyVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span>
<a name="line-144"></a><span class='hs-definition'>tcGetTyVar_maybe</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-145"></a>
<a name="line-146"></a><a name="tcGetTyVar"></a><span class='hs-definition'>tcGetTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-147"></a><span class='hs-definition'>tcGetTyVar</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="tcIsTyVarTy"></a><span class='hs-definition'>tcIsTyVarTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-150"></a><span class='hs-definition'>tcIsTyVarTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeToBool</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="tcSplitDFunTy"></a><span class='hs-comment'>-----------------------</span>
<a name="line-153"></a><span class='hs-definition'>tcSplitDFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-154"></a><span class='hs-comment'>-- Split the type of a dictionary function</span>
<a name="line-155"></a><span class='hs-comment'>-- We don't use tcSplitSigmaTy,  because a DFun may (with NDP)</span>
<a name="line-156"></a><span class='hs-comment'>-- have non-Pred arguments, such as</span>
<a name="line-157"></a><span class='hs-comment'>--     df :: forall m. (forall b. Eq b =&gt; Eq (m b)) -&gt; C m</span>
<a name="line-158"></a><span class='hs-comment'>--</span>
<a name="line-159"></a><span class='hs-comment'>-- Also NB splitFunTys, not tcSplitFunTys;</span>
<a name="line-160"></a><span class='hs-comment'>-- the latter  specifically stops at PredTy arguments,</span>
<a name="line-161"></a><span class='hs-comment'>-- and we don't want to do that here</span>
<a name="line-162"></a><span class='hs-definition'>tcSplitDFunTy</span> <span class='hs-varid'>ty</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty</span>   <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span>
<a name="line-164"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>splitFunTys</span> <span class='hs-varid'>rho</span>       <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-165"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitDFunHead</span> <span class='hs-varid'>tau</span>   <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span>
<a name="line-166"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="tcSplitDFunHead"></a><span class='hs-definition'>tcSplitDFunHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-169"></a><span class='hs-definition'>tcSplitDFunHead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getClassPredTys</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="tcInstHeadTyNotSynonym"></a><span class='hs-definition'>tcInstHeadTyNotSynonym</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-172"></a><span class='hs-comment'>-- Used in Haskell-98 mode, for the argument types of an instance head</span>
<a name="line-173"></a><span class='hs-comment'>-- These must not be type synonyms, but everywhere else type synonyms</span>
<a name="line-174"></a><span class='hs-comment'>-- are transparent, so we need a special function here</span>
<a name="line-175"></a><span class='hs-definition'>tcInstHeadTyNotSynonym</span> <span class='hs-varid'>ty</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-177"></a>        <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeSynonymTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-178"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-179"></a>
<a name="line-180"></a><a name="tcInstHeadTyAppAllTyVars"></a><span class='hs-definition'>tcInstHeadTyAppAllTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-181"></a><span class='hs-comment'>-- Used in Haskell-98 mode, for the argument types of an instance head</span>
<a name="line-182"></a><span class='hs-comment'>-- These must be a constructor applied to type variable arguments.</span>
<a name="line-183"></a><span class='hs-comment'>-- But we allow kind instantiations.</span>
<a name="line-184"></a><span class='hs-definition'>tcInstHeadTyAppAllTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span>       <span class='hs-comment'>-- Look through synonyms</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstHeadTyAppAllTyVars</span> <span class='hs-varid'>ty'</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-188"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-189"></a>        <span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- avoid kinds</span>
<a name="line-190"></a>        <span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ok</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span>
<a name="line-191"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-192"></a>  <span class='hs-keyword'>where</span>
<a name="line-193"></a>        <span class='hs-comment'>-- Check that all the types are type variables,</span>
<a name="line-194"></a>        <span class='hs-comment'>-- and that each is distinct</span>
<a name="line-195"></a>    <span class='hs-varid'>ok</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>hasNoDups</span> <span class='hs-varid'>tvs</span>
<a name="line-196"></a>           <span class='hs-keyword'>where</span>
<a name="line-197"></a>             <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>get_tv</span> <span class='hs-varid'>tys</span>
<a name="line-198"></a>
<a name="line-199"></a>    <span class='hs-varid'>get_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span>      <span class='hs-comment'>-- through synonyms</span>
<a name="line-200"></a>    <span class='hs-varid'>get_tv</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="tcEqKind"></a><span class='hs-definition'>tcEqKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>tcEqKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcEqType</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="tcEqType"></a><span class='hs-definition'>tcEqType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a><span class='hs-comment'>-- tcEqType is a proper, sensible type-equality function, that does</span>
<a name="line-6"></a><span class='hs-comment'>-- just what you'd expect The function Type.eqType (currently) has a</span>
<a name="line-7"></a><span class='hs-comment'>-- grotesque hack that makes OpenKind = *, and that is NOT what we</span>
<a name="line-8"></a><span class='hs-comment'>-- want in the type checker!  Otherwise, for example, TcCanonical.reOrient</span>
<a name="line-9"></a><span class='hs-comment'>-- thinks the LHS and RHS have the same kinds, when they don't, and</span>
<a name="line-10"></a><span class='hs-comment'>-- fails to re-orient.  That in turn caused Trac #8553.</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>tcEqType</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>init_env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>init_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2</span>
<a name="line-17"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2'</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rnOccR</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv2</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>lit1</span><span class='hs-layout'>)</span>        <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>lit2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lit1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lit2</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                                                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-24"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>ts1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span>
<a name="line-25"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>       <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-28"></a>    <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>ts1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2</span><span class='hs-conop'>:</span><span class='hs-varid'>ts2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span>
<a name="line-29"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="pickyEqType"></a><span class='hs-definition'>pickyEqType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-32"></a><span class='hs-comment'>-- Check when two types _look_ the same, _including_ synonyms.</span>
<a name="line-33"></a><span class='hs-comment'>-- So (pickyEqType String [Char]) returns False</span>
<a name="line-34"></a><span class='hs-definition'>pickyEqType</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>init_env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>init_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rnOccR</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv2</span>
<a name="line-39"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>lit1</span><span class='hs-layout'>)</span>        <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>lit2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lit1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lit2</span>
<a name="line-40"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                                                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-42"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-43"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-44"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>ts1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span>
<a name="line-45"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-46"></a>
<a name="line-47"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>       <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-48"></a>    <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>ts1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2</span><span class='hs-conop'>:</span><span class='hs-varid'>ts2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>gos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span>
<a name="line-49"></a>    <span class='hs-varid'>gos</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [Occurs check expansion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(occurCheckExpand tv xi) expands synonyms in xi just enough to get rid
of occurrences of tv outside type function arguments, if that is
possible; otherwise, it returns Nothing.

For example, suppose we have
  type F a b = [a]
Then
  occurCheckExpand b (F Int b) = Just [Int]
but
  occurCheckExpand a (F a Int) = Nothing

We don't promise to do the absolute minimum amount of expanding
necessary, but we try not to do expansions we don't need to.  We
prefer doing inner expansions first.  For example,
  type F a b = (a, Int, a, [a])
  type G b   = Char
We have
  occurCheckExpand b (F (G b)) = F Char
even though we could also expand F to get rid of b.

See also Note [occurCheckExpand] in TcCanonical

\begin{code}
<pre><a name="line-1"></a><a name="OccCheckResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>OccCheckResult</span> <span class='hs-varid'>a</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_OK</span> <span class='hs-varid'>a</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OC_Forall</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OC_NonTyVar</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OC_Occurs</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>OccCheckResult</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>      <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>OccCheckResult</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>      <span class='hs-varid'>pure</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-12"></a>      <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>OccCheckResult</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_OK</span> <span class='hs-varid'>x</span>
<a name="line-16"></a>  <span class='hs-conid'>OC_OK</span> <span class='hs-varid'>x</span>     <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span> <span class='hs-varid'>x</span>
<a name="line-17"></a>  <span class='hs-conid'>OC_Forall</span>   <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Forall</span>
<a name="line-18"></a>  <span class='hs-conid'>OC_NonTyVar</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_NonTyVar</span>
<a name="line-19"></a>  <span class='hs-conid'>OC_Occurs</span>   <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Occurs</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="occurCheckExpand"></a><span class='hs-definition'>occurCheckExpand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccCheckResult</span> <span class='hs-conid'>Type</span>
<a name="line-22"></a><span class='hs-comment'>-- See Note [Occurs check expansion]</span>
<a name="line-23"></a><span class='hs-comment'>-- Check whether</span>
<a name="line-24"></a><span class='hs-comment'>--   a) the given variable occurs in the given type.</span>
<a name="line-25"></a><span class='hs-comment'>--   b) there is a forall in the type (unless we have -XImpredicativeTypes</span>
<a name="line-26"></a><span class='hs-comment'>--                                     or it's a PolyTv</span>
<a name="line-27"></a><span class='hs-comment'>--   c) if it's a SigTv, ty should be a tyvar</span>
<a name="line-28"></a><span class='hs-comment'>--</span>
<a name="line-29"></a><span class='hs-comment'>-- We may have needed to do some type synonym unfolding in order to</span>
<a name="line-30"></a><span class='hs-comment'>-- get rid of the variable (or forall), so we also return the unfolded</span>
<a name="line-31"></a><span class='hs-comment'>-- version of the type, which is guaranteed to be syntactically free</span>
<a name="line-32"></a><span class='hs-comment'>-- of the given type variable.  If the type is already syntactically</span>
<a name="line-33"></a><span class='hs-comment'>-- free of the variable, then the same type is returned.</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-definition'>occurCheckExpand</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>details</span>
<a name="line-37"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_sig_tv</span> <span class='hs-varid'>ty</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fast_check</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-40"></a>  <span class='hs-keyword'>where</span>
<a name="line-41"></a>    <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>impredicative</span>
<a name="line-44"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>details</span> <span class='hs-keyword'>of</span>
<a name="line-45"></a>          <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PolyTv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-46"></a>          <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTv</span> <span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-47"></a>          <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TauTv</span> <span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_ImpredicativeTypes</span> <span class='hs-varid'>dflags</span>
<a name="line-48"></a>                                       <span class='hs-varop'>||</span> <span class='hs-varid'>isOpenTypeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-49"></a>                                          <span class='hs-comment'>-- Note [OpenTypeKind accepts foralls]</span>
<a name="line-50"></a>                                          <span class='hs-comment'>-- in TcUnify</span>
<a name="line-51"></a>          <span class='hs-sel'>_other</span>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-52"></a>          <span class='hs-comment'>-- We can have non-meta tyvars in given constraints</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-comment'>-- Check 'ty' is a tyvar, or can be expanded into one</span>
<a name="line-55"></a>    <span class='hs-varid'>go_sig_tv</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_OK</span> <span class='hs-varid'>ty</span>
<a name="line-56"></a>    <span class='hs-varid'>go_sig_tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_sig_tv</span> <span class='hs-varid'>ty'</span>
<a name="line-57"></a>    <span class='hs-varid'>go_sig_tv</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_NonTyVar</span>
<a name="line-58"></a>
<a name="line-59"></a>    <span class='hs-comment'>-- True =&gt; fine</span>
<a name="line-60"></a>    <span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-61"></a>    <span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>tv'</span>
<a name="line-62"></a>    <span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>fast_check</span> <span class='hs-varid'>tys</span>
<a name="line-63"></a>    <span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fast_check</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fast_check</span> <span class='hs-varid'>res</span>
<a name="line-64"></a>    <span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fast_check</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fast_check</span> <span class='hs-varid'>arg</span>
<a name="line-65"></a>    <span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>impredicative</span>
<a name="line-66"></a>                                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-varop'>||</span> <span class='hs-varid'>fast_check</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Occurs</span>
<a name="line-70"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>t</span>
<a name="line-71"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-72"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span>
<a name="line-73"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-74"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span>
<a name="line-76"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-77"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-78"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span>
<a name="line-79"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>impredicative</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Forall</span>
<a name="line-80"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fast_check</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OC_Occurs</span>
<a name="line-81"></a>           <span class='hs-comment'>-- Can't expand away the kinds unless we create</span>
<a name="line-82"></a>           <span class='hs-comment'>-- fresh variables which we don't want to do at this point.</span>
<a name="line-83"></a>           <span class='hs-comment'>-- In principle fast_check might fail because of a for-all</span>
<a name="line-84"></a>           <span class='hs-comment'>-- but we don't yet have poly-kinded tyvars so I'm not</span>
<a name="line-85"></a>           <span class='hs-comment'>-- going to worry about that now</span>
<a name="line-86"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-87"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>body_ty</span>
<a name="line-88"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-89"></a>
<a name="line-90"></a>    <span class='hs-comment'>-- For a type constructor application, first try expanding away the</span>
<a name="line-91"></a>    <span class='hs-comment'>-- offending variable from the arguments.  If that doesn't work, next</span>
<a name="line-92"></a>    <span class='hs-comment'>-- see if the type constructor is a type synonym, and if so, expand</span>
<a name="line-93"></a>    <span class='hs-comment'>-- it and try again.</span>
<a name="line-94"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-95"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>of</span>
<a name="line-96"></a>          <span class='hs-conid'>OC_OK</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- First try to eliminate the tyvar from the args</span>
<a name="line-97"></a>          <span class='hs-varid'>bad</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-98"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bad</span>
<a name="line-99"></a>                      <span class='hs-comment'>-- Failing that, try to expand a synonym</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Predicate types}
%*                                                                      *
%************************************************************************

Deconstructors and tests on predicate types

\begin{code}
<pre><a name="line-1"></a><a name="isTyVarClassPred"></a><span class='hs-definition'>isTyVarClassPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>isTyVarClassPred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-3"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>tys</span>
<a name="line-4"></a>    <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="evVarPred_maybe"></a><span class='hs-definition'>evVarPred_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PredType</span>
<a name="line-7"></a><span class='hs-definition'>evVarPred_maybe</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>v</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="evVarPred"></a><span class='hs-definition'>evVarPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-11"></a><span class='hs-definition'>evVarPred</span> <span class='hs-varid'>var</span>
<a name="line-12"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>evVarPred_maybe</span> <span class='hs-varid'>var</span> <span class='hs-keyword'>of</span>
<a name="line-14"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pred</span>
<a name="line-15"></a>      <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcEvVarPred"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>var</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>var</span>
</pre>\end{code}

Superclasses

\begin{code}
<pre><a name="line-1"></a><a name="mkMinimalBySCs"></a><span class='hs-definition'>mkMinimalBySCs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- Remove predicates that can be deduced from others by superclasses</span>
<a name="line-3"></a><span class='hs-definition'>mkMinimalBySCs</span> <span class='hs-varid'>ptys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ploc</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>ploc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ptys</span>
<a name="line-4"></a>                             <span class='hs-layout'>,</span>  <span class='hs-varid'>ploc</span> <span class='hs-varop'>`not_in_preds`</span> <span class='hs-varid'>rec_scs</span> <span class='hs-keyglyph'>]</span>
<a name="line-5"></a> <span class='hs-keyword'>where</span>
<a name="line-6"></a>   <span class='hs-varid'>rec_scs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>trans_super_classes</span> <span class='hs-varid'>ptys</span>
<a name="line-7"></a>   <span class='hs-varid'>not_in_preds</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqPred</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>   <span class='hs-varid'>trans_super_classes</span> <span class='hs-varid'>pred</span>   <span class='hs-comment'>-- Superclasses of pred, excluding pred itself</span>
<a name="line-10"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>         <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>transSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-12"></a>         <span class='hs-conid'>TuplePred</span> <span class='hs-varid'>ts</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>trans_super_classes</span> <span class='hs-varid'>ts</span>
<a name="line-13"></a>         <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="transSuperClasses"></a><span class='hs-definition'>transSuperClasses</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a><span class='hs-definition'>transSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>    <span class='hs-comment'>-- Superclasses of (cls tys),</span>
<a name="line-17"></a>                             <span class='hs-comment'>-- excluding (cls tys) itself</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>trans_sc</span> <span class='hs-layout'>(</span><span class='hs-varid'>immSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>trans_sc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>    <span class='hs-comment'>-- (trans_sc p) returns (p : p's superclasses)</span>
<a name="line-22"></a>    <span class='hs-varid'>trans_sc</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>of</span>
<a name="line-23"></a>                   <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-conop'>:</span> <span class='hs-varid'>transSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-24"></a>                   <span class='hs-conid'>TuplePred</span> <span class='hs-varid'>ps</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>trans_sc</span> <span class='hs-varid'>ps</span>
<a name="line-25"></a>                   <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="immSuperClasses"></a><span class='hs-definition'>immSuperClasses</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-28"></a><span class='hs-definition'>immSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>sc_theta</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span><span class='hs-varid'>sc_theta</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classBigSig</span> <span class='hs-varid'>cls</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Predicates}
%*                                                                      *
%************************************************************************

isSigmaTy returns true of any qualified type.  It doesn't *necessarily* have
any foralls.  E.g.
        f :: (?x::Int) => Int -> Int

\begin{code}
<pre><a name="line-1"></a><a name="isSigmaTy"></a><span class='hs-definition'>isSigmaTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>isSigmaTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSigmaTy</span> <span class='hs-varid'>ty'</span>
<a name="line-3"></a><span class='hs-definition'>isSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-4"></a><span class='hs-definition'>isSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>a</span>
<a name="line-5"></a><span class='hs-definition'>isSigmaTy</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="isOverloadedTy"></a><span class='hs-definition'>isOverloadedTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-8"></a><span class='hs-comment'>-- Yes for a type of a function that might require evidence-passing</span>
<a name="line-9"></a><span class='hs-comment'>-- Used only by bindLocalMethods</span>
<a name="line-10"></a><span class='hs-definition'>isOverloadedTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isOverloadedTy</span> <span class='hs-varid'>ty'</span>
<a name="line-11"></a><span class='hs-definition'>isOverloadedTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isOverloadedTy</span> <span class='hs-varid'>ty</span>
<a name="line-12"></a><span class='hs-definition'>isOverloadedTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>a</span>
<a name="line-13"></a><span class='hs-definition'>isOverloadedTy</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="isFloatTy"></a><span class='hs-definition'>isFloatTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDoubleTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIntegerTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIntTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWordTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBoolTy</span><span class='hs-layout'>,</span>
<a name="line-2"></a>    <span class='hs-varid'>isUnitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCharTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAnyTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a><span class='hs-definition'>isFloatTy</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>floatTyConKey</span>
<a name="line-4"></a><a name="isDoubleTy"></a><span class='hs-definition'>isDoubleTy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>doubleTyConKey</span>
<a name="line-5"></a><a name="isIntegerTy"></a><span class='hs-definition'>isIntegerTy</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>integerTyConKey</span>
<a name="line-6"></a><a name="isIntTy"></a><span class='hs-definition'>isIntTy</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>intTyConKey</span>
<a name="line-7"></a><a name="isWordTy"></a><span class='hs-definition'>isWordTy</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>wordTyConKey</span>
<a name="line-8"></a><a name="isBoolTy"></a><span class='hs-definition'>isBoolTy</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>boolTyConKey</span>
<a name="line-9"></a><a name="isUnitTy"></a><span class='hs-definition'>isUnitTy</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>unitTyConKey</span>
<a name="line-10"></a><a name="isCharTy"></a><span class='hs-definition'>isCharTy</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>charTyConKey</span>
<a name="line-11"></a><a name="isAnyTy"></a><span class='hs-definition'>isAnyTy</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_tc</span> <span class='hs-varid'>anyTyConKey</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="isStringTy"></a><span class='hs-definition'>isStringTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-14"></a><span class='hs-definition'>isStringTy</span> <span class='hs-varid'>ty</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-16"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>listTyCon</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isCharTy</span> <span class='hs-varid'>arg_ty</span>
<a name="line-17"></a>      <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="is_tc"></a><span class='hs-definition'>is_tc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-20"></a><span class='hs-comment'>-- Newtypes are opaque to this</span>
<a name="line-21"></a><span class='hs-definition'>is_tc</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-22"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uniq</span> <span class='hs-varop'>==</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span>
<a name="line-23"></a>                        <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="isSynFamilyTyConApp"></a><span class='hs-comment'>-- NB: Currently used in places where we have already expanded type synonyms;</span>
<a name="line-2"></a><span class='hs-comment'>--     hence no 'coreView'.  This could, however, be changed without breaking</span>
<a name="line-3"></a><span class='hs-comment'>--     any code.</span>
<a name="line-4"></a><span class='hs-definition'>isSynFamilyTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a><span class='hs-definition'>isSynFamilyTyConApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-6"></a>                                      <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-7"></a><span class='hs-definition'>isSynFamilyTyConApp</span> <span class='hs-sel'>_other</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Misc}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="deNoteType"></a><span class='hs-definition'>deNoteType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-comment'>-- Remove all *outermost* type synonyms and other notes</span>
<a name="line-3"></a><span class='hs-definition'>deNoteType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deNoteType</span> <span class='hs-varid'>ty'</span>
<a name="line-4"></a><span class='hs-definition'>deNoteType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="tcTyVarsOfType"></a><span class='hs-definition'>tcTyVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-7"></a><span class='hs-comment'>-- Just the *TcTyVars* free in the type</span>
<a name="line-8"></a><span class='hs-comment'>-- (Types.tyVarsOfTypes finds all free TyVars)</span>
<a name="line-9"></a><span class='hs-definition'>tcTyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv</span>
<a name="line-10"></a>                                                      <span class='hs-keyword'>else</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-11"></a><span class='hs-definition'>tcTyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-12"></a><span class='hs-definition'>tcTyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-13"></a><span class='hs-definition'>tcTyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarsOfType</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tcTyVarsOfType</span> <span class='hs-varid'>res</span>
<a name="line-14"></a><span class='hs-definition'>tcTyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarsOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tcTyVarsOfType</span> <span class='hs-varid'>arg</span>
<a name="line-15"></a><span class='hs-definition'>tcTyVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tyvar</span>
<a name="line-16"></a>        <span class='hs-comment'>-- We do sometimes quantify over skolem TcTyVars</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="tcTyVarsOfTypes"></a><span class='hs-definition'>tcTyVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-19"></a><span class='hs-definition'>tcTyVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span><span class='hs-varop'>.</span><span class='hs-varid'>tcTyVarsOfType</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>tys</span>
</pre>\end{code}

Find the free tycons and classes of a type.  This is used in the front
end of the compiler.

\begin{code}
<pre><a name="line-1"></a><a name="orphNamesOfTyCon"></a><span class='hs-definition'>orphNamesOfTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-2"></a><span class='hs-definition'>orphNamesOfTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tycon</span> <span class='hs-keyword'>of</span>
<a name="line-3"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-4"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="orphNamesOfType"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-7"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>ty'</span>
<a name="line-8"></a>                <span class='hs-comment'>-- Look through type synonyms (Trac #4912)</span>
<a name="line-9"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-10"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-11"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-12"></a>                                       <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-13"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfTyCon</span> <span class='hs-varid'>funTyCon</span>   <span class='hs-comment'>-- NB!  See Trac #8535</span>
<a name="line-14"></a>                                       <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>arg</span>
<a name="line-15"></a>                                       <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>res</span>
<a name="line-16"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>arg</span>
<a name="line-17"></a><span class='hs-definition'>orphNamesOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="orphNamesOfThings"></a><span class='hs-definition'>orphNamesOfThings</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-20"></a><span class='hs-definition'>orphNamesOfThings</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionNameSets</span> <span class='hs-varop'>.</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="orphNamesOfTypes"></a><span class='hs-definition'>orphNamesOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-23"></a><span class='hs-definition'>orphNamesOfTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfThings</span> <span class='hs-varid'>orphNamesOfType</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="orphNamesOfDFunHead"></a><span class='hs-definition'>orphNamesOfDFunHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-26"></a><span class='hs-comment'>-- Find the free type constructors and classes</span>
<a name="line-27"></a><span class='hs-comment'>-- of the head of the dfun instance type</span>
<a name="line-28"></a><span class='hs-comment'>-- The 'dfun_head_type' is because of</span>
<a name="line-29"></a><span class='hs-comment'>--      instance Foo a =&gt; Baz T where ...</span>
<a name="line-30"></a><span class='hs-comment'>-- The decl is an orphan if Baz and T are both not locally defined,</span>
<a name="line-31"></a><span class='hs-comment'>--      even if Foo *is* locally defined</span>
<a name="line-32"></a><span class='hs-definition'>orphNamesOfDFunHead</span> <span class='hs-varid'>dfun_ty</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>dfun_ty</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>head_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>head_ty</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="orphNamesOfCo"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-37"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>ty</span>
<a name="line-38"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-39"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-40"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co</span>
<a name="line-41"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-42"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCoCon</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-43"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>ty2</span>
<a name="line-44"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co</span>
<a name="line-45"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-46"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co</span>
<a name="line-47"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co</span>
<a name="line-48"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfCo</span> <span class='hs-varid'>co</span>
<a name="line-50"></a><span class='hs-definition'>orphNamesOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfTypes</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>`unionNameSets`</span>
<a name="line-51"></a>                                      <span class='hs-varid'>orphNamesOfCos</span> <span class='hs-varid'>cs</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="orphNamesOfCos"></a><span class='hs-definition'>orphNamesOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-54"></a><span class='hs-definition'>orphNamesOfCos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfThings</span> <span class='hs-varid'>orphNamesOfCo</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="orphNamesOfCoCon"></a><span class='hs-definition'>orphNamesOfCoCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-57"></a><span class='hs-definition'>orphNamesOfCoCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfCoAxBranches</span> <span class='hs-varid'>branches</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="orphNamesOfCoAxBranches"></a><span class='hs-definition'>orphNamesOfCoAxBranches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BranchList</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-61"></a><span class='hs-definition'>orphNamesOfCoAxBranches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brListFoldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionNameSets</span> <span class='hs-varop'>.</span> <span class='hs-varid'>orphNamesOfCoAxBranch</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="orphNamesOfCoAxBranch"></a><span class='hs-definition'>orphNamesOfCoAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-64"></a><span class='hs-definition'>orphNamesOfCoAxBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfTypes</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>rhs</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection[TysWiredIn-ext-type]{External types}
%*                                                                      *
%************************************************************************

The compiler's foreign function interface supports the passing of a
restricted set of types as arguments and results (the restricting factor
being the )

\begin{code}
<pre><a name="line-1"></a><a name="tcSplitIOType_maybe"></a><span class='hs-definition'>tcSplitIOType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- (tcSplitIOType_maybe t) returns Just (IO,t',co)</span>
<a name="line-3"></a><span class='hs-comment'>--              if co : t ~ IO t'</span>
<a name="line-4"></a><span class='hs-comment'>--              returns Nothing otherwise</span>
<a name="line-5"></a><span class='hs-definition'>tcSplitIOType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>io_tycon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>io_res_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-8"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>io_tycon</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ioTyConKey</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-9"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>io_tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>io_res_ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-11"></a>            <span class='hs-conid'>Nothing</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="isFFITy"></a><span class='hs-definition'>isFFITy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-14"></a><span class='hs-comment'>-- True for any TyCon that can possibly be an arg or result of an FFI call</span>
<a name="line-15"></a><span class='hs-definition'>isFFITy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-varid'>legalFFITyCon</span> <span class='hs-varid'>ty</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="isFFIArgumentTy"></a><span class='hs-definition'>isFFIArgumentTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Safety</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-18"></a><span class='hs-comment'>-- Checks for valid argument type for a 'foreign import'</span>
<a name="line-19"></a><span class='hs-definition'>isFFIArgumentTy</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>safety</span> <span class='hs-varid'>ty</span>
<a name="line-20"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>legalOutgoingTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>safety</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="isFFIExternalTy"></a><span class='hs-definition'>isFFIExternalTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-23"></a><span class='hs-comment'>-- Types that are allowed as arguments of a 'foreign export'</span>
<a name="line-24"></a><span class='hs-definition'>isFFIExternalTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-varid'>legalFEArgTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="isFFIImportResultTy"></a><span class='hs-definition'>isFFIImportResultTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-27"></a><span class='hs-definition'>isFFIImportResultTy</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>legalFIResultTyCon</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="isFFIExportResultTy"></a><span class='hs-definition'>isFFIExportResultTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-31"></a><span class='hs-definition'>isFFIExportResultTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-varid'>legalFEResultTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="isFFIDynTy"></a><span class='hs-definition'>isFFIDynTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-34"></a><span class='hs-comment'>-- The type in a foreign import dynamic must be Ptr, FunPtr, or a newtype of</span>
<a name="line-35"></a><span class='hs-comment'>-- either, and the wrapped function type must be equal to the given type.</span>
<a name="line-36"></a><span class='hs-comment'>-- We assume that all types have been run through normalizeFfiType, so we don't</span>
<a name="line-37"></a><span class='hs-comment'>-- need to worry about expanding newtypes here.</span>
<a name="line-38"></a><span class='hs-definition'>isFFIDynTy</span> <span class='hs-varid'>expected</span> <span class='hs-varid'>ty</span>
<a name="line-39"></a>    <span class='hs-comment'>-- Note [Foreign import dynamic]</span>
<a name="line-40"></a>    <span class='hs-comment'>-- In the example below, expected would be 'CInt -&gt; IO ()', while ty would</span>
<a name="line-41"></a>    <span class='hs-comment'>-- be 'FunPtr (CDouble -&gt; IO ())'.</span>
<a name="line-42"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-43"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>tyConUnique</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptrTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>funPtrTyConKey</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>eqType</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>expected</span>
<a name="line-45"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-46"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-47"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="isFFILabelTy"></a><span class='hs-definition'>isFFILabelTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-50"></a><span class='hs-comment'>-- The type of a foreign label must be Ptr, FunPtr, or a newtype of either.</span>
<a name="line-51"></a><span class='hs-definition'>isFFILabelTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyConKey</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptrTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>funPtrTyConKey</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="isFFIPrimArgumentTy"></a><span class='hs-definition'>isFFIPrimArgumentTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-54"></a><span class='hs-comment'>-- Checks for valid argument type for a 'foreign import prim'</span>
<a name="line-55"></a><span class='hs-comment'>-- Currently they must all be simple unlifted types, or the well-known type</span>
<a name="line-56"></a><span class='hs-comment'>-- Any, which can be used to pass the address to a Haskell object on the heap to</span>
<a name="line-57"></a><span class='hs-comment'>-- the foreign function.</span>
<a name="line-58"></a><span class='hs-definition'>isFFIPrimArgumentTy</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span>
<a name="line-59"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isAnyTy</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>legalFIPrimArgTyCon</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="isFFIPrimResultTy"></a><span class='hs-definition'>isFFIPrimResultTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-62"></a><span class='hs-comment'>-- Checks for valid result type for a 'foreign import prim'</span>
<a name="line-63"></a><span class='hs-comment'>-- Currently it must be an unlifted type, including unboxed tuples.</span>
<a name="line-64"></a><span class='hs-definition'>isFFIPrimResultTy</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span>
<a name="line-65"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>legalFIPrimResultTyCon</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="isFFIDotnetTy"></a><span class='hs-definition'>isFFIDotnetTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-68"></a><span class='hs-definition'>isFFIDotnetTy</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ty</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>legalFIResultTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span>
<a name="line-70"></a>                           <span class='hs-varid'>isFFIDotnetObjTy</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isStringTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-71"></a>        <span class='hs-comment'>-- NB: isStringTy used to look through newtypes, but</span>
<a name="line-72"></a>        <span class='hs-comment'>--     it no longer does so.  May need to adjust isFFIDotNetTy</span>
<a name="line-73"></a>        <span class='hs-comment'>--     if we do want to look through newtypes.</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="isFFIDotnetObjTy"></a><span class='hs-definition'>isFFIDotnetObjTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-76"></a><span class='hs-definition'>isFFIDotnetObjTy</span> <span class='hs-varid'>ty</span>
<a name="line-77"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>t_ty</span>
<a name="line-78"></a>  <span class='hs-keyword'>where</span>
<a name="line-79"></a>   <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>t_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-80"></a>   <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>objectTyConName</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="isFunPtrTy"></a><span class='hs-definition'>isFunPtrTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-83"></a><span class='hs-definition'>isFunPtrTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyConKey</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>funPtrTyConKey</span><span class='hs-keyglyph'>]</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="checkRepTyCon"></a><span class='hs-comment'>-- normaliseFfiType gets run before checkRepTyCon, so we don't</span>
<a name="line-86"></a><span class='hs-comment'>-- need to worry about looking through newtypes or type functions</span>
<a name="line-87"></a><span class='hs-comment'>-- here; that's already been taken care of.</span>
<a name="line-88"></a><span class='hs-definition'>checkRepTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-89"></a><span class='hs-definition'>checkRepTyCon</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>ty</span>
<a name="line-90"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-91"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span>
<a name="line-92"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-93"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="checkRepTyConKey"></a><span class='hs-definition'>checkRepTyConKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Unique</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-96"></a><span class='hs-comment'>-- Like checkRepTyCon, but just looks at the TyCon key</span>
<a name="line-97"></a><span class='hs-definition'>checkRepTyConKey</span> <span class='hs-varid'>keys</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRepTyCon</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tyConUnique</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>keys</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Foreign import dynamic]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A dynamic stub must be of the form 'FunPtr ft -> ft' where ft is any foreign
type.  Similarly, a wrapper stub must be of the form 'ft -> IO (FunPtr ft)'.

We use isFFIDynTy to check whether a signature is well-formed. For example,
given a (illegal) declaration like:

foreign import ccall "dynamic"
  foo :: FunPtr (CDouble -> IO ()) -> CInt -> IO ()

isFFIDynTy will compare the 'FunPtr' type 'CDouble -> IO ()' with the curried
result type 'CInt -> IO ()', and return False, as they are not equal.


----------------------------------------------
These chaps do the work; they are not exported
----------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="legalFEArgTyCon"></a><span class='hs-definition'>legalFEArgTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>legalFEArgTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-3"></a>  <span class='hs-comment'>-- It's illegal to make foreign exports that take unboxed</span>
<a name="line-4"></a>  <span class='hs-comment'>-- arguments.  The RTS API currently can't invoke such things.  --SDM 7/2000</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boxedMarshalableTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="legalFIResultTyCon"></a><span class='hs-definition'>legalFIResultTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-8"></a><span class='hs-definition'>legalFIResultTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unitTyCon</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>marshalableTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="legalFEResultTyCon"></a><span class='hs-definition'>legalFEResultTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-13"></a><span class='hs-definition'>legalFEResultTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unitTyCon</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boxedMarshalableTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="legalOutgoingTyCon"></a><span class='hs-definition'>legalOutgoingTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Safety</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-18"></a><span class='hs-comment'>-- Checks validity of types going from Haskell -&gt; external world</span>
<a name="line-19"></a><span class='hs-definition'>legalOutgoingTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>marshalableTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="legalFFITyCon"></a><span class='hs-definition'>legalFFITyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-23"></a><span class='hs-comment'>-- True for any TyCon that can possibly be an arg or result of an FFI call</span>
<a name="line-24"></a><span class='hs-definition'>legalFFITyCon</span> <span class='hs-varid'>tc</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>boxedMarshalableTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>unitTyCon</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="marshalableTyCon"></a><span class='hs-definition'>marshalableTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-28"></a><span class='hs-definition'>marshalableTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_UnliftedFFITypes</span> <span class='hs-varid'>dflags</span>
<a name="line-30"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-31"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-32"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConPrimRep</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>        <span class='hs-comment'>-- Note [Marshalling VoidRep]</span>
<a name="line-33"></a>           <span class='hs-conid'>VoidRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-34"></a>           <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>boxedMarshalableTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="boxedMarshalableTyCon"></a><span class='hs-definition'>boxedMarshalableTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-38"></a><span class='hs-definition'>boxedMarshalableTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-39"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>intTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>int8TyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>int16TyConKey</span>
<a name="line-40"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>int32TyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>int64TyConKey</span>
<a name="line-41"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>wordTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>word8TyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>word16TyConKey</span>
<a name="line-42"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>word32TyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>word64TyConKey</span>
<a name="line-43"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>floatTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>doubleTyConKey</span>
<a name="line-44"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ptrTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>funPtrTyConKey</span>
<a name="line-45"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>charTyConKey</span>
<a name="line-46"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>stablePtrTyConKey</span>
<a name="line-47"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>boolTyConKey</span>
<a name="line-48"></a>                         <span class='hs-keyglyph'>]</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="legalFIPrimArgTyCon"></a><span class='hs-definition'>legalFIPrimArgTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-51"></a><span class='hs-comment'>-- Check args of 'foreign import prim', only allow simple unlifted types.</span>
<a name="line-52"></a><span class='hs-comment'>-- Strictly speaking it is unnecessary to ban unboxed tuples here since</span>
<a name="line-53"></a><span class='hs-comment'>-- currently they're of the wrong kind to use in function args anyway.</span>
<a name="line-54"></a><span class='hs-definition'>legalFIPrimArgTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_UnliftedFFITypes</span> <span class='hs-varid'>dflags</span>
<a name="line-56"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-57"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="legalFIPrimResultTyCon"></a><span class='hs-definition'>legalFIPrimResultTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-60"></a><span class='hs-comment'>-- Check result type of 'foreign import prim'. Allow simple unlifted</span>
<a name="line-61"></a><span class='hs-comment'>-- types and also unboxed tuple result types '... -&gt; (# , , #)'</span>
<a name="line-62"></a><span class='hs-definition'>legalFIPrimResultTyCon</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tc</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_UnliftedFFITypes</span> <span class='hs-varid'>dflags</span>
<a name="line-64"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-65"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-66"></a>        <span class='hs-varop'>||</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConPrimRep</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>      <span class='hs-comment'>-- Note [Marshalling VoidRep]</span>
<a name="line-67"></a>           <span class='hs-conid'>VoidRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-68"></a>           <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Marshalling VoidRep]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We don't treat State# (whose PrimRep is VoidRep) as marshalable.
In turn that means you can't write
        foreign import foo :: Int -> State# RealWorld

Reason: the back end falls over with panic "primRepHint:VoidRep";
        and there is no compelling reason to permit it
</body>
</html>
