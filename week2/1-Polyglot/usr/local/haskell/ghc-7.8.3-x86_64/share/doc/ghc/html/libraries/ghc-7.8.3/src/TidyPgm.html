<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>main/TidyPgm.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>

% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section{Tidying up Core}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TidyPgm</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>       <span class='hs-varid'>mkBootModDetailsTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyProgram</span><span class='hs-layout'>,</span> <span class='hs-varid'>globaliseAndTidyId</span>
<a name="line-3"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUnfold</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreTidy</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreMonad</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CorePrep</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Rules</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>exprArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprBotStrictness_maybe</span> <span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>             <span class='hs-layout'>(</span> <span class='hs-varid'>tidyTopType</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>appIsBottom</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNopSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBottomingSig</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IfaceEnv</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Packages</span><span class='hs-layout'>(</span> <span class='hs-varid'>isDllName</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span> <span class='hs-layout'>(</span><span class='hs-conid'>Severity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastBool</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>fastOr</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>ErrUtils</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Err</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-layout'>)</span>
</pre>\end{code}


Constructing the TypeEnv, Instances, Rules, VectInfo from which the
ModIface is constructed, and which goes on to subsequent modules in
--make mode.

Most of the interface file is obtained simply by serialising the
TypeEnv.  One important consequence is that if the *interface file*
has pragma info if and only if the final TypeEnv does. This is not so
important for *this* module, but it's essential for ghc --make:
subsequent compilations must not see (e.g.) the arity if the interface
file does not contain arity If they do, they'll exploit the arity;
then the arity might change, but the iface file doesn't change =>
recompilation does not happen => disaster.

For data types, the final TypeEnv will have a TyThing for the TyCon,
plus one for each DataCon; the interface file will contain just one
data type declaration, but it is de-serialised back into a collection
of TyThings.

%************************************************************************
%*                                                                      *
                Plan A: simpleTidyPgm
%*                                                                      *
%************************************************************************


Plan A: mkBootModDetails: omit pragmas, make interfaces small
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Ignore the bindings

* Drop all WiredIn things from the TypeEnv
        (we never want them in interface files)

* Retain all TyCons and Classes in the TypeEnv, to avoid
        having to find which ones are mentioned in the
        types of exported Ids

* Trim off the constructors of non-exported TyCons, both
        from the TyCon and from the TypeEnv

* Drop non-exported Ids from the TypeEnv

* Tidy the types of the DFunIds of Instances,
  make them into GlobalIds, (they already have External Names)
  and add them to the TypeEnv

* Tidy the types of the (exported) Ids in the TypeEnv,
  make them into GlobalIds (they already have External Names)

* Drop rules altogether

* Tidy the bindings, to ensure that the Caf and Arity
  information is correct for each top-level binder; the
  code generator needs it. And to ensure that local names have
  distinct OccNames in case of object-file splitting

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- This is Plan A: make a small type env when typechecking only,</span>
<a name="line-2"></a><span class='hs-comment'>-- or when compiling a hs-boot file, or simply when not using -O</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- We don't look at the bindings at all -- there aren't any</span>
<a name="line-5"></a><span class='hs-comment'>-- for hs-boot files</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mkBootModDetailsTc"></a><span class='hs-definition'>mkBootModDetailsTc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModDetails</span>
<a name="line-8"></a><span class='hs-definition'>mkBootModDetailsTc</span> <span class='hs-varid'>hsc_env</span>
<a name="line-9"></a>        <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>{</span> <span class='hs-varid'>tcg_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                  <span class='hs-varid'>tcg_type_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- just for the Ids</span>
<a name="line-11"></a>                  <span class='hs-varid'>tcg_tcs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs</span><span class='hs-layout'>,</span>
<a name="line-12"></a>                  <span class='hs-varid'>tcg_patsyns</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat_syns</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                  <span class='hs-varid'>tcg_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                  <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span>
<a name="line-15"></a>                <span class='hs-layout'>}</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>CoreTidy</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>insts'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyClsInstDFun</span> <span class='hs-varid'>globaliseAndTidyId</span><span class='hs-layout'>)</span> <span class='hs-varid'>insts</span>
<a name="line-20"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>pat_syns'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyPatSynIds</span>   <span class='hs-varid'>globaliseAndTidyId</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_syns</span>
<a name="line-21"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>dfun_ids</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>insts'</span>
<a name="line-22"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>pat_syn_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>patSynIds</span> <span class='hs-varid'>pat_syns'</span>
<a name="line-23"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>type_env1</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBootTypeEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>availsToNameSet</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>typeEnvIds</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>fam_insts</span>
<a name="line-25"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>type_env'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>type_env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat_syn_ids</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dfun_ids</span><span class='hs-layout'>)</span>
<a name="line-26"></a>              <span class='hs-layout'>}</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModDetails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>md_types</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env'</span>
<a name="line-28"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>md_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts'</span>
<a name="line-29"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>md_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span>
<a name="line-30"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>md_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-31"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>md_anns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-32"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>md_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span>
<a name="line-33"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>md_vect_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noVectInfo</span>
<a name="line-34"></a>                             <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-35"></a>        <span class='hs-layout'>}</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="mkBootTypeEnv"></a><span class='hs-definition'>mkBootTypeEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeEnv</span>
<a name="line-39"></a><span class='hs-definition'>mkBootTypeEnv</span> <span class='hs-varid'>exports</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>fam_insts</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTypeEnv</span> <span class='hs-conid'>True</span> <span class='hs-varop'>$</span>
<a name="line-41"></a>       <span class='hs-varid'>typeEnvFromEntities</span> <span class='hs-varid'>final_ids</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>fam_insts</span>
<a name="line-42"></a>  <span class='hs-keyword'>where</span>
<a name="line-43"></a>        <span class='hs-comment'>-- Find the LocalIds in the type env that are exported</span>
<a name="line-44"></a>        <span class='hs-comment'>-- Make them into GlobalIds, and tidy their types</span>
<a name="line-45"></a>        <span class='hs-comment'>--</span>
<a name="line-46"></a>        <span class='hs-comment'>-- It's very important to remove the non-exported ones</span>
<a name="line-47"></a>        <span class='hs-comment'>-- because we don't tidy the OccNames, and if we don't remove</span>
<a name="line-48"></a>        <span class='hs-comment'>-- the non-exported ones we'll get many things with the</span>
<a name="line-49"></a>        <span class='hs-comment'>-- same name in the interface file, giving chaos.</span>
<a name="line-50"></a>        <span class='hs-comment'>--</span>
<a name="line-51"></a>        <span class='hs-comment'>-- Do make sure that we keep Ids that are already Global.</span>
<a name="line-52"></a>        <span class='hs-comment'>-- When typechecking an .hs-boot file, the Ids come through as</span>
<a name="line-53"></a>        <span class='hs-comment'>-- GlobalIds.</span>
<a name="line-54"></a>    <span class='hs-varid'>final_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>globaliseAndTidyId</span> <span class='hs-varid'>id</span>
<a name="line-55"></a>                                  <span class='hs-keyword'>else</span> <span class='hs-varid'>id</span>
<a name="line-56"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span>
<a name="line-57"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>keep_it</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>]</span>
<a name="line-58"></a>
<a name="line-59"></a>        <span class='hs-comment'>-- default methods have their export flag set, but everything</span>
<a name="line-60"></a>        <span class='hs-comment'>-- else doesn't (yet), because this is pre-desugaring, so we</span>
<a name="line-61"></a>        <span class='hs-comment'>-- must test both.</span>
<a name="line-62"></a>    <span class='hs-varid'>keep_it</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>||</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>exports</span>
<a name="line-63"></a>
<a name="line-64"></a>
<a name="line-65"></a>
<a name="line-66"></a><a name="globaliseAndTidyId"></a><span class='hs-definition'>globaliseAndTidyId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-67"></a><span class='hs-comment'>-- Takes an LocalId with an External Name,</span>
<a name="line-68"></a><span class='hs-comment'>-- makes it into a GlobalId</span>
<a name="line-69"></a><span class='hs-comment'>--     * unchanged Name (might be Internal or External)</span>
<a name="line-70"></a><span class='hs-comment'>--     * unchanged details</span>
<a name="line-71"></a><span class='hs-comment'>--     * VanillaIdInfo (makes a conservative assumption about Caf-hood)</span>
<a name="line-72"></a><span class='hs-definition'>globaliseAndTidyId</span> <span class='hs-varid'>id</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>setIdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>globaliseId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>tidy_type</span>
<a name="line-74"></a>  <span class='hs-keyword'>where</span>
<a name="line-75"></a>    <span class='hs-varid'>tidy_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTopType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Plan B: tidy bindings, make TypeEnv full of IdInfo
%*                                                                      *
%************************************************************************

Plan B: include pragmas, make interfaces
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Figure out which Ids are externally visible

* Tidy the bindings, externalising appropriate Ids

* Drop all Ids from the TypeEnv, and add all the External Ids from
  the bindings.  (This adds their IdInfo to the TypeEnv; and adds
  floated-out Ids that weren't even in the TypeEnv before.)

Step 1: Figure out external Ids
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note [choosing external names]

See also the section "Interface stability" in the
RecompilationAvoidance commentary:
  http://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/RecompilationAvoidance

First we figure out which Ids are "external" Ids.  An
"external" Id is one that is visible from outside the compilation
unit.  These are
  a) the user exported ones
  b) ones mentioned in the unfoldings, workers,
     rules of externally-visible ones ,
     or vectorised versions of externally-visible ones

While figuring out which Ids are external, we pick a "tidy" OccName
for each one.  That is, we make its OccName distinct from the other
external OccNames in this module, so that in interface files and
object code we can refer to it unambiguously by its OccName.  The
OccName for each binder is prefixed by the name of the exported Id
that references it; e.g. if "f" references "x" in its unfolding, then
"x" is renamed to "f_x".  This helps distinguish the different "x"s
from each other, and means that if "f" is later removed, things that
depend on the other "x"s will not need to be recompiled.  Of course,
if there are multiple "f_x"s, then we have to disambiguate somehow; we
use "f_x0", "f_x1" etc.

As far as possible we should assign names in a deterministic fashion.
Each time this module is compiled with the same options, we should end
up with the same set of external names with the same types.  That is,
the ABI hash in the interface should not change.  This turns out to be
quite tricky, since the order of the bindings going into the tidy
phase is already non-deterministic, as it is based on the ordering of
Uniques, which are assigned unpredictably.

To name things in a stable way, we do a depth-first-search of the
bindings, starting from the exports sorted by name.  This way, as long
as the bindings themselves are deterministic (they sometimes aren't!),
the order in which they are presented to the tidying phase does not
affect the names we assign.

Step 2: Tidy the program
~~~~~~~~~~~~~~~~~~~~~~~~
Next we traverse the bindings top to bottom.  For each *top-level*
binder

 1. Make it into a GlobalId; its IdDetails becomes VanillaGlobal,
    reflecting the fact that from now on we regard it as a global,
    not local, Id

 2. Give it a system-wide Unique.
    [Even non-exported things need system-wide Uniques because the
    byte-code generator builds a single Name->BCO symbol table.]

    We use the NameCache kept in the HscEnv as the
    source of such system-wide uniques.

    For external Ids, use the original-name cache in the NameCache
    to ensure that the unique assigned is the same as the Id had
    in any previous compilation run.

 3. Rename top-level Ids according to the names we chose in step 1.
    If it's an external Id, make it have a External Name, otherwise
    make it have an Internal Name.  This is used by the code generator
    to decide whether to make the label externally visible

 4. Give it its UTTERLY FINAL IdInfo; in ptic,
        * its unfolding, if it should have one

        * its arity, computed from the number of visible lambdas

        * its CAF info, computed from what is free in its RHS


Finally, substitute these new top-level binders consistently
throughout, including in unfoldings.  We also tidy binders in
RHSs, so that they print nicely in interfaces.

\begin{code}
<pre><a name="line-1"></a><a name="tidyProgram"></a><span class='hs-definition'>tidyProgram</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgGuts</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModDetails</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tidyProgram</span> <span class='hs-varid'>hsc_env</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ModGuts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_module</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span>
<a name="line-3"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span>
<a name="line-4"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_tcs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs</span>
<a name="line-5"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span>
<a name="line-6"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span>
<a name="line-7"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_binds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span>
<a name="line-8"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_patsyns</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patsyns</span>
<a name="line-9"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_rules</span>
<a name="line-10"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_vect_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vect_info</span>
<a name="line-11"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_anns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anns</span>
<a name="line-12"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_deps</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span>
<a name="line-13"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_foreign</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_stubs</span>
<a name="line-14"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_hpc_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpc_info</span>
<a name="line-15"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>mg_modBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modBreaks</span>
<a name="line-16"></a>                              <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-19"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>omit_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_OmitInterfacePragmas</span> <span class='hs-varid'>dflags</span>
<a name="line-20"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>expose_all</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ExposeAllUnfoldings</span>  <span class='hs-varid'>dflags</span>
<a name="line-21"></a>              <span class='hs-layout'>}</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>CoreTidy</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>type_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeEnvFromEntities</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>fam_insts</span>
<a name="line-25"></a>
<a name="line-26"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>implicit_binds</span>
<a name="line-27"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>getClassImplicitBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeEnvClasses</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-28"></a>                    <span class='hs-varid'>concatMap</span> <span class='hs-varid'>getTyConImplicitBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeEnvTyCons</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>)</span>
<a name="line-29"></a>              <span class='hs-layout'>}</span>
<a name="line-30"></a>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfold_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_occ_env</span><span class='hs-layout'>)</span>
<a name="line-32"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>chooseExternalIds</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>omit_prags</span> <span class='hs-varid'>expose_all</span>
<a name="line-33"></a>                                   <span class='hs-varid'>binds</span> <span class='hs-varid'>implicit_binds</span> <span class='hs-varid'>imp_rules</span> <span class='hs-layout'>(</span><span class='hs-varid'>vectInfoVar</span> <span class='hs-varid'>vect_info</span><span class='hs-layout'>)</span>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ext_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findExternalRules</span> <span class='hs-varid'>omit_prags</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>imp_rules</span> <span class='hs-varid'>unfold_env</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>                <span class='hs-comment'>-- Glom together imp_rules and rules currently attached to binders</span>
<a name="line-36"></a>                <span class='hs-comment'>-- Then pick just the ones we need to expose</span>
<a name="line-37"></a>                <span class='hs-comment'>-- See Note [Which rules to expose]</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_binds</span><span class='hs-layout'>)</span>
<a name="line-40"></a>                 <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tidyTopBinds</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>tidy_occ_env</span> <span class='hs-varid'>binds</span>
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>final_ids</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>tidy_binds</span><span class='hs-layout'>,</span>
<a name="line-43"></a>                                    <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>type_env1</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>type_env</span> <span class='hs-varid'>final_ids</span>
<a name="line-45"></a>
<a name="line-46"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>tidy_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyClsInstDFun</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_aux_id</span> <span class='hs-varid'>tidy_type_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>insts</span>
<a name="line-47"></a>                <span class='hs-comment'>-- A DFunId will have a binding in tidy_binds, and so will now be in</span>
<a name="line-48"></a>                <span class='hs-comment'>-- tidy_type_env, replete with IdInfo.  Its name will be unchanged since</span>
<a name="line-49"></a>                <span class='hs-comment'>-- it was born, but we want Global, IdInfo-rich (or not) DFunId in the</span>
<a name="line-50"></a>                <span class='hs-comment'>-- tidy_insts.  Similarly the Ids inside a PatSyn.</span>
<a name="line-51"></a>
<a name="line-52"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>tidy_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyRules</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ext_rules</span>
<a name="line-53"></a>                <span class='hs-comment'>-- You might worry that the tidy_env contains IdInfo-rich stuff</span>
<a name="line-54"></a>                <span class='hs-comment'>-- and indeed it does, but if omit_prags is on, ext_rules is</span>
<a name="line-55"></a>                <span class='hs-comment'>-- empty</span>
<a name="line-56"></a>
<a name="line-57"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>tidy_vect_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyVectInfo</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>vect_info</span>
<a name="line-58"></a>
<a name="line-59"></a>                <span class='hs-comment'>-- Tidy the Ids inside each PatSyn, very similarly to DFunIds</span>
<a name="line-60"></a>                <span class='hs-comment'>-- and then override the PatSyns in the type_env with the new tidy ones</span>
<a name="line-61"></a>                <span class='hs-comment'>-- This is really the only reason we keep mg_patsyns at all; otherwise</span>
<a name="line-62"></a>                <span class='hs-comment'>-- they could just stay in type_env</span>
<a name="line-63"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>tidy_patsyns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyPatSynIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_aux_id</span> <span class='hs-varid'>tidy_type_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>patsyns</span>
<a name="line-64"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>type_env2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvList</span> <span class='hs-varid'>type_env1</span>
<a name="line-65"></a>                                    <span class='hs-keyglyph'>[</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tidy_patsyns</span> <span class='hs-keyglyph'>]</span>
<a name="line-66"></a>
<a name="line-67"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>tidy_type_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTypeEnv</span> <span class='hs-varid'>omit_prags</span> <span class='hs-varid'>type_env2</span>
<a name="line-68"></a>
<a name="line-69"></a>              <span class='hs-comment'>-- See Note [Injecting implicit bindings]</span>
<a name="line-70"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>all_tidy_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_binds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tidy_binds</span>
<a name="line-71"></a>
<a name="line-72"></a>              <span class='hs-comment'>-- get the TyCons to generate code for.  Careful!  We must use</span>
<a name="line-73"></a>              <span class='hs-comment'>-- the untidied TypeEnv here, because we need</span>
<a name="line-74"></a>              <span class='hs-comment'>--  (a) implicit TyCons arising from types and classes defined</span>
<a name="line-75"></a>              <span class='hs-comment'>--      in this module</span>
<a name="line-76"></a>              <span class='hs-comment'>--  (b) wired-in TyCons, which are normally removed from the</span>
<a name="line-77"></a>              <span class='hs-comment'>--      TypeEnv we put in the ModDetails</span>
<a name="line-78"></a>              <span class='hs-comment'>--  (c) Constructors even if they are not exported (the</span>
<a name="line-79"></a>              <span class='hs-comment'>--      tidied TypeEnv has trimmed these away)</span>
<a name="line-80"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>alg_tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeEnvTyCons</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>)</span>
<a name="line-81"></a>              <span class='hs-layout'>}</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>endPass</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>CoreTidy</span> <span class='hs-varid'>all_tidy_binds</span> <span class='hs-varid'>tidy_rules</span>
<a name="line-84"></a>
<a name="line-85"></a>          <span class='hs-comment'>-- If the endPass didn't print the rules, but ddump-rules is</span>
<a name="line-86"></a>          <span class='hs-comment'>-- on, print now</span>
<a name="line-87"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-88"></a>            <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_rules</span>
<a name="line-89"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreTidy</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"rules"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-90"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>pprRulesForUser</span> <span class='hs-varid'>tidy_rules</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a>          <span class='hs-comment'>-- Print one-line size info</span>
<a name="line-93"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreBindsStats</span> <span class='hs-varid'>tidy_binds</span>
<a name="line-94"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_core_stats</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-95"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>SevDump</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultDumpStyle</span>
<a name="line-96"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Tidy size (terms,types,coercions)"</span><span class='hs-layout'>)</span>
<a name="line-97"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-98"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_tm</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-99"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_ty</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_co</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgGuts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_module</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span>
<a name="line-103"></a>                           <span class='hs-varid'>cg_tycons</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alg_tycons</span><span class='hs-layout'>,</span>
<a name="line-104"></a>                           <span class='hs-varid'>cg_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all_tidy_binds</span><span class='hs-layout'>,</span>
<a name="line-105"></a>                           <span class='hs-varid'>cg_foreign</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_stubs</span><span class='hs-layout'>,</span>
<a name="line-106"></a>                           <span class='hs-varid'>cg_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-varid'>deps</span><span class='hs-layout'>,</span>
<a name="line-107"></a>                           <span class='hs-varid'>cg_hpc_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpc_info</span><span class='hs-layout'>,</span>
<a name="line-108"></a>                           <span class='hs-varid'>cg_modBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modBreaks</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-109"></a>
<a name="line-110"></a>                   <span class='hs-conid'>ModDetails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>md_types</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_type_env</span><span class='hs-layout'>,</span>
<a name="line-111"></a>                                <span class='hs-varid'>md_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_rules</span><span class='hs-layout'>,</span>
<a name="line-112"></a>                                <span class='hs-varid'>md_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_insts</span><span class='hs-layout'>,</span>
<a name="line-113"></a>                                <span class='hs-varid'>md_vect_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_vect_info</span><span class='hs-layout'>,</span>
<a name="line-114"></a>                                <span class='hs-varid'>md_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>,</span>
<a name="line-115"></a>                                <span class='hs-varid'>md_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span><span class='hs-layout'>,</span>
<a name="line-116"></a>                                <span class='hs-varid'>md_anns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anns</span>      <span class='hs-comment'>-- are already tidy</span>
<a name="line-117"></a>                              <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-118"></a>        <span class='hs-layout'>}</span>
<a name="line-119"></a>
<a name="line-120"></a><a name="lookup_aux_id"></a><span class='hs-definition'>lookup_aux_id</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-121"></a><span class='hs-definition'>lookup_aux_id</span> <span class='hs-varid'>type_env</span> <span class='hs-varid'>id</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupTypeEnv</span> <span class='hs-varid'>type_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-123"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id'</span>
<a name="line-124"></a>        <span class='hs-sel'>_other</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"lookup_axu_id"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="tidyTypeEnv"></a><span class='hs-comment'>--------------------------</span>
<a name="line-127"></a><span class='hs-definition'>tidyTypeEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- Compiling without -O, so omit prags</span>
<a name="line-128"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeEnv</span>
<a name="line-129"></a>
<a name="line-130"></a><span class='hs-comment'>-- The competed type environment is gotten from</span>
<a name="line-131"></a><span class='hs-comment'>--      a) the types and classes defined here (plus implicit things)</span>
<a name="line-132"></a><span class='hs-comment'>--      b) adding Ids with correct IdInfo, including unfoldings,</span>
<a name="line-133"></a><span class='hs-comment'>--              gotten from the bindings</span>
<a name="line-134"></a><span class='hs-comment'>-- From (b) we keep only those Ids with External names;</span>
<a name="line-135"></a><span class='hs-comment'>--          the CoreTidy pass makes sure these are all and only</span>
<a name="line-136"></a><span class='hs-comment'>--          the externally-accessible ones</span>
<a name="line-137"></a><span class='hs-comment'>-- This truncates the type environment to include only the</span>
<a name="line-138"></a><span class='hs-comment'>-- exported Ids and things needed from them, which saves space</span>
<a name="line-139"></a><span class='hs-comment'>--</span>
<a name="line-140"></a><span class='hs-comment'>-- See Note [Don't attempt to trim data types]</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-definition'>tidyTypeEnv</span> <span class='hs-varid'>omit_prags</span> <span class='hs-varid'>type_env</span>
<a name="line-143"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-144"></a>        <span class='hs-varid'>type_env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isWiredInName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getName</span><span class='hs-layout'>)</span> <span class='hs-varid'>type_env</span>
<a name="line-145"></a>          <span class='hs-comment'>-- (1) remove wired-in things</span>
<a name="line-146"></a>        <span class='hs-varid'>type_env2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>omit_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapNameEnv</span> <span class='hs-varid'>trimThing</span> <span class='hs-varid'>type_env1</span>
<a name="line-147"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env1</span>
<a name="line-148"></a>          <span class='hs-comment'>-- (2) trimmed if necessary</span>
<a name="line-149"></a>    <span class='hs-keyword'>in</span>
<a name="line-150"></a>    <span class='hs-varid'>type_env2</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="trimThing"></a><span class='hs-comment'>--------------------------</span>
<a name="line-153"></a><span class='hs-definition'>trimThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyThing</span>
<a name="line-154"></a><span class='hs-comment'>-- Trim off inessentials, for boot files and no -O</span>
<a name="line-155"></a><span class='hs-definition'>trimThing</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-156"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isImplicitId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-157"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnId</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span> <span class='hs-varop'>`setIdInfo`</span> <span class='hs-varid'>vanillaIdInfo</span><span class='hs-layout'>)</span>
<a name="line-158"></a>
<a name="line-159"></a><span class='hs-definition'>trimThing</span> <span class='hs-varid'>other_thing</span>
<a name="line-160"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_thing</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="tidyVectInfo"></a><span class='hs-definition'>tidyVectInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VectInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VectInfo</span>
<a name="line-2"></a><span class='hs-definition'>tidyVectInfo</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>info</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>VectInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>vectInfoVar</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span>
<a name="line-3"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>vectInfoParallelVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parallelVars</span>
<a name="line-4"></a>                                         <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>vectInfoVar</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_vars</span>
<a name="line-6"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>vectInfoParallelVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_parallelVars</span>
<a name="line-7"></a>         <span class='hs-layout'>}</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>      <span class='hs-comment'>-- we only export mappings whose domain and co-domain is exported (otherwise, the iface is</span>
<a name="line-10"></a>      <span class='hs-comment'>-- inconsistent)</span>
<a name="line-11"></a>    <span class='hs-varid'>tidy_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_var</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_var_v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>vars</span>
<a name="line-13"></a>                         <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_var</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_var</span> <span class='hs-varid'>var</span>
<a name="line-14"></a>                               <span class='hs-varid'>tidy_var_v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_var</span> <span class='hs-varid'>var_v</span>
<a name="line-15"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>isExternalId</span> <span class='hs-varid'>tidy_var</span>   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>tidy_var</span>
<a name="line-16"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>isExternalId</span> <span class='hs-varid'>tidy_var_v</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>tidy_var_v</span>
<a name="line-17"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>isDataConWorkId</span> <span class='hs-varid'>var</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isImplicitId</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                         <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>tidy_parallelVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tidy_var</span>
<a name="line-21"></a>                                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>parallelVars</span>
<a name="line-22"></a>                                 <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_var</span> <span class='hs-varid'>var</span>
<a name="line-23"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>isExternalId</span> <span class='hs-varid'>tidy_var</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>tidy_var</span>
<a name="line-24"></a>                                 <span class='hs-keyglyph'>]</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>lookup_var</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupWithDefaultVarEnv</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>var</span> <span class='hs-varid'>var</span>
<a name="line-27"></a>    
<a name="line-28"></a>    <span class='hs-comment'>-- We need to make sure that all names getting into the iface version of 'VectInfo' are</span>
<a name="line-29"></a>    <span class='hs-comment'>-- external; otherwise, 'MkIface' will bomb out.</span>
<a name="line-30"></a>    <span class='hs-varid'>isExternalId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idName</span>
</pre>\end{code}

Note [Don't attempt to trim data types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For some time GHC tried to avoid exporting the data constructors
of a data type if it wasn't strictly necessary to do so; see Trac #835.
But "strictly necessary" accumulated a longer and longer list 
of exceptions, and finally I gave up the battle:

    commit 9a20e540754fc2af74c2e7392f2786a81d8d5f11
    Author: Simon Peyton Jones <simonpj@microsoft.com>
    Date:   Thu Dec 6 16:03:16 2012 +0000

    Stop attempting to "trim" data types in interface files
    
    Without -O, we previously tried to make interface files smaller
    by not including the data constructors of data types.  But
    there are a lot of exceptions, notably when Template Haskell is
    involved or, more recently, DataKinds.
    
    However Trac #7445 shows that even without TemplateHaskell, using
    the Data class and invoking Language.Haskell.TH.Quote.dataToExpQ
    is enough to require us to expose the data constructors.
    
    So I've given up on this "optimisation" -- it's probably not
    important anyway.  Now I'm simply not attempting to trim off
    the data constructors.  The gain in simplicity is worth the
    modest cost in interface file growth, which is limited to the
    bits reqd to describe those data constructors.

%************************************************************************
%*                                                                      *
        Implicit bindings
%*                                                                      *
%************************************************************************

Note [Injecting implicit bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We inject the implict bindings right at the end, in CoreTidy.
Some of these bindings, notably record selectors, are not
constructed in an optimised form.  E.g. record selector for
        data T = MkT { x :: {-# UNPACK #-} !Int }
Then the unfolding looks like
        x = \t. case t of MkT x1 -> let x = I# x1 in x
This generates bad code unless it's first simplified a bit.  That is
why CoreUnfold.mkImplicitUnfolding uses simleExprOpt to do a bit of
optimisation first.  (Only matters when the selector is used curried;
eg map x ys.)  See Trac #2070.

[Oct 09: in fact, record selectors are no longer implicit Ids at all,
because we really do want to optimise them properly. They are treated
much like any other Id.  But doing "light" optimisation on an implicit
Id still makes sense.]

At one time I tried injecting the implicit bindings *early*, at the
beginning of SimplCore.  But that gave rise to real difficulty,
because GlobalIds are supposed to have *fixed* IdInfo, but the
simplifier and other core-to-core passes mess with IdInfo all the
time.  The straw that broke the camels back was when a class selector
got the wrong arity -- ie the simplifier gave it arity 2, whereas
importing modules were expecting it to have arity 1 (Trac #2844).
It's much safer just to inject them right at the end, after tidying.

Oh: two other reasons for injecting them late:

  - If implicit Ids are already in the bindings when we start TidyPgm,
    we'd have to be careful not to treat them as external Ids (in
    the sense of findExternalIds); else the Ids mentioned in *their*
    RHSs will be treated as external and you get an interface file
    saying      a18 = <blah>
    but nothing refererring to a18 (because the implicit Id is the
    one that does, and implicit Ids don't appear in interface files).

  - More seriously, the tidied type-envt will include the implicit
    Id replete with a18 in its unfolding; but we won't take account
    of a18 when computing a fingerprint for the class; result chaos.

There is one sort of implicit binding that is injected still later,
namely those for data constructor workers. Reason (I think): it's
really just a code generation trick.... binding itself makes no sense.
See Note [Data constructor workers] in CorePrep.

\begin{code}
<pre><a name="line-1"></a><a name="getTyConImplicitBinds"></a><span class='hs-definition'>getTyConImplicitBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>getTyConImplicitBinds</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>get_defn</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>dataConWrapId_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="getClassImplicitBinds"></a><span class='hs-definition'>getClassImplicitBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>getClassImplicitBinds</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>get_defn</span> <span class='hs-layout'>(</span><span class='hs-varid'>classAllSelIds</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="get_defn"></a><span class='hs-definition'>get_defn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-8"></a><span class='hs-definition'>get_defn</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfoldingTemplate</span> <span class='hs-layout'>(</span><span class='hs-varid'>realIdUnfolding</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Step 1: finding externals}
%*                                                                      *
%************************************************************************

See Note [Choosing external names].

\begin{code}
<pre><a name="line-1"></a><a name="UnfoldEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UnfoldEnv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-comment'>{-new name-}</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>{-show unfolding-}</span><span class='hs-layout'>)</span>
<a name="line-2"></a>  <span class='hs-comment'>-- Maps each top-level Id to its new Name (the Id is tidied in step 2)</span>
<a name="line-3"></a>  <span class='hs-comment'>-- The Unique is unchanged.  If the new Name is external, it will be</span>
<a name="line-4"></a>  <span class='hs-comment'>-- visible in the interface file.</span>
<a name="line-5"></a>  <span class='hs-comment'>--</span>
<a name="line-6"></a>  <span class='hs-comment'>-- Bool =&gt; expose unfolding or not.</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="chooseExternalIds"></a><span class='hs-definition'>chooseExternalIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-9"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-10"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-15"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfoldEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TidyOccEnv</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                  <span class='hs-comment'>-- Step 1 from the notes above</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>chooseExternalIds</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>omit_prags</span> <span class='hs-varid'>expose_all</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>implicit_binds</span> <span class='hs-varid'>imp_id_rules</span> <span class='hs-varid'>vect_vars</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfold_env1</span><span class='hs-layout'>,</span><span class='hs-varid'>occ_env1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>search</span> <span class='hs-varid'>init_work_list</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>init_occ_env</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>internal_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>unfold_env1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>binders</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tidy_internal</span> <span class='hs-varid'>internal_ids</span> <span class='hs-varid'>unfold_env1</span> <span class='hs-varid'>occ_env1</span> <span class='hs-layout'>}</span>
<a name="line-22"></a> <span class='hs-keyword'>where</span>
<a name="line-23"></a>  <span class='hs-varid'>nc_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_NC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-24"></a>
<a name="line-25"></a>  <span class='hs-comment'>-- init_ext_ids is the intial list of Ids that should be</span>
<a name="line-26"></a>  <span class='hs-comment'>-- externalised.  It serves as the starting point for finding a</span>
<a name="line-27"></a>  <span class='hs-comment'>-- deterministic, tidy, renaming for all external Ids in this</span>
<a name="line-28"></a>  <span class='hs-comment'>-- module.</span>
<a name="line-29"></a>  <span class='hs-comment'>--</span>
<a name="line-30"></a>  <span class='hs-comment'>-- It is sorted, so that it has adeterministic order (i.e. it's the</span>
<a name="line-31"></a>  <span class='hs-comment'>-- same list every time this module is compiled), in contrast to the</span>
<a name="line-32"></a>  <span class='hs-comment'>-- bindings, which are ordered non-deterministically.</span>
<a name="line-33"></a>  <span class='hs-varid'>init_work_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>init_ext_ids</span> <span class='hs-varid'>init_ext_ids</span>
<a name="line-34"></a>  <span class='hs-varid'>init_ext_ids</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>compare</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>getOccName</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>                   <span class='hs-varid'>filter</span> <span class='hs-varid'>is_external</span> <span class='hs-varid'>binders</span>
<a name="line-36"></a>
<a name="line-37"></a>  <span class='hs-comment'>-- An Id should be external if either (a) it is exported,</span>
<a name="line-38"></a>  <span class='hs-comment'>-- (b) it appears in the RHS of a local rule for an imported Id, or</span>
<a name="line-39"></a>  <span class='hs-comment'>-- (c) it is the vectorised version of an imported Id</span>
<a name="line-40"></a>  <span class='hs-comment'>-- See Note [Which rules to expose]</span>
<a name="line-41"></a>  <span class='hs-varid'>is_external</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>||</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>rule_rhs_vars</span> <span class='hs-varop'>||</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>vect_var_vs</span>
<a name="line-42"></a>  <span class='hs-varid'>rule_rhs_vars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ruleRhsFreeVars</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>imp_id_rules</span>
<a name="line-43"></a>  <span class='hs-varid'>vect_var_vs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>var_v</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-varid'>vect_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGlobalId</span> <span class='hs-varid'>var</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>
<a name="line-45"></a>  <span class='hs-varid'>binders</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>binds</span>
<a name="line-46"></a>  <span class='hs-varid'>implicit_binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>implicit_binds</span>
<a name="line-47"></a>  <span class='hs-varid'>binder_set</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>binders</span>
<a name="line-48"></a>
<a name="line-49"></a>  <span class='hs-varid'>avoids</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binders</span> <span class='hs-varop'>++</span> <span class='hs-varid'>implicit_binders</span><span class='hs-layout'>,</span>
<a name="line-50"></a>                                <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span>
<a name="line-51"></a>                                <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>]</span>
<a name="line-52"></a>                <span class='hs-comment'>-- In computing our "avoids" list, we must include</span>
<a name="line-53"></a>                <span class='hs-comment'>--      all implicit Ids</span>
<a name="line-54"></a>                <span class='hs-comment'>--      all things with global names (assigned once and for</span>
<a name="line-55"></a>                <span class='hs-comment'>--                                      all by the renamer)</span>
<a name="line-56"></a>                <span class='hs-comment'>-- since their names are "taken".</span>
<a name="line-57"></a>                <span class='hs-comment'>-- The type environment is a convenient source of such things.</span>
<a name="line-58"></a>                <span class='hs-comment'>-- In particular, the set of binders doesn't include</span>
<a name="line-59"></a>                <span class='hs-comment'>-- implicit Ids at this stage.</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-comment'>-- We also make sure to avoid any exported binders.  Consider</span>
<a name="line-62"></a>        <span class='hs-comment'>--      f{-u1-} = 1     -- Local decl</span>
<a name="line-63"></a>        <span class='hs-comment'>--      ...</span>
<a name="line-64"></a>        <span class='hs-comment'>--      f{-u2-} = 2     -- Exported decl</span>
<a name="line-65"></a>        <span class='hs-comment'>--</span>
<a name="line-66"></a>        <span class='hs-comment'>-- The second exported decl must 'get' the name 'f', so we</span>
<a name="line-67"></a>        <span class='hs-comment'>-- have to put 'f' in the avoids list before we get to the first</span>
<a name="line-68"></a>        <span class='hs-comment'>-- decl.  tidyTopId then does a no-op on exported binders.</span>
<a name="line-69"></a>  <span class='hs-varid'>init_occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initTidyOccEnv</span> <span class='hs-varid'>avoids</span>
<a name="line-70"></a>
<a name="line-71"></a>
<a name="line-72"></a>  <span class='hs-varid'>search</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- The work-list: (external id, referrring id)</span>
<a name="line-73"></a>                         <span class='hs-comment'>-- Make a tidy, external Name for the external id,</span>
<a name="line-74"></a>                         <span class='hs-comment'>--   add it to the UnfoldEnv, and do the same for the</span>
<a name="line-75"></a>                         <span class='hs-comment'>--   transitive closure of Ids it refers to</span>
<a name="line-76"></a>                         <span class='hs-comment'>-- The referring id is used to generate a tidy</span>
<a name="line-77"></a>                         <span class='hs-comment'>---  name for the external id</span>
<a name="line-78"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldEnv</span>    <span class='hs-comment'>-- id -&gt; (new Name, show_unfold)</span>
<a name="line-79"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyOccEnv</span>   <span class='hs-comment'>-- occ env for choosing new Names</span>
<a name="line-80"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfoldEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TidyOccEnv</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a>  <span class='hs-varid'>search</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfold_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ_env</span><span class='hs-layout'>)</span>
<a name="line-83"></a>
<a name="line-84"></a>  <span class='hs-varid'>search</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>idocc</span><span class='hs-layout'>,</span><span class='hs-varid'>referrer</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>occ_env</span>
<a name="line-85"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>idocc</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>unfold_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>search</span> <span class='hs-varid'>rest</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>occ_env</span>
<a name="line-86"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-87"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>name'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tidyTopName</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>nc_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>referrer</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>idocc</span>
<a name="line-88"></a>      <span class='hs-keyword'>let</span>
<a name="line-89"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>new_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>show_unfold</span><span class='hs-layout'>)</span>
<a name="line-90"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>omit_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-91"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addExternal</span> <span class='hs-varid'>expose_all</span> <span class='hs-varid'>refined_id</span>
<a name="line-92"></a>
<a name="line-93"></a>                <span class='hs-comment'>-- add vectorised version if any exists</span>
<a name="line-94"></a>          <span class='hs-varid'>new_ids'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ids</span> <span class='hs-varop'>++</span> <span class='hs-varid'>maybeToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>vect_vars</span> <span class='hs-varid'>idocc</span><span class='hs-layout'>)</span>
<a name="line-95"></a>          
<a name="line-96"></a>                <span class='hs-comment'>-- 'idocc' is an *occurrence*, but we need to see the</span>
<a name="line-97"></a>                <span class='hs-comment'>-- unfolding in the *definition*; so look up in binder_set</span>
<a name="line-98"></a>          <span class='hs-varid'>refined_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarSet</span> <span class='hs-varid'>binder_set</span> <span class='hs-varid'>idocc</span> <span class='hs-keyword'>of</span>
<a name="line-99"></a>                         <span class='hs-conid'>Just</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span>
<a name="line-100"></a>                         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>idocc</span> <span class='hs-layout'>)</span> <span class='hs-varid'>idocc</span>
<a name="line-101"></a>
<a name="line-102"></a>          <span class='hs-varid'>unfold_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>idocc</span> <span class='hs-layout'>(</span><span class='hs-varid'>name'</span><span class='hs-layout'>,</span><span class='hs-varid'>show_unfold</span><span class='hs-layout'>)</span>
<a name="line-103"></a>          <span class='hs-varid'>referrer'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExportedId</span> <span class='hs-varid'>refined_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>refined_id</span>
<a name="line-104"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>referrer</span>
<a name="line-105"></a>      <span class='hs-comment'>--</span>
<a name="line-106"></a>      <span class='hs-varid'>search</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>new_ids'</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>referrer'</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varid'>unfold_env'</span> <span class='hs-varid'>occ_env'</span>
<a name="line-107"></a>
<a name="line-108"></a>  <span class='hs-varid'>tidy_internal</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyOccEnv</span>
<a name="line-109"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfoldEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TidyOccEnv</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-varid'>tidy_internal</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfold_env</span><span class='hs-layout'>,</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-varid'>tidy_internal</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-conop'>:</span><span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-112"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>name'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tidyTopName</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>nc_var</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>id</span>
<a name="line-113"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>unfold_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>name'</span><span class='hs-layout'>,</span><span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-114"></a>      <span class='hs-varid'>tidy_internal</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>unfold_env'</span> <span class='hs-varid'>occ_env'</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="addExternal"></a><span class='hs-definition'>addExternal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-definition'>addExternal</span> <span class='hs-varid'>expose_all</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_needed_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>show_unfold</span><span class='hs-layout'>)</span>
<a name="line-118"></a>  <span class='hs-keyword'>where</span>
<a name="line-119"></a>    <span class='hs-varid'>new_needed_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrFvsInOrder</span> <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>id</span>
<a name="line-120"></a>    <span class='hs-varid'>idinfo</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-121"></a>    <span class='hs-varid'>show_unfold</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show_unfolding</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span>
<a name="line-122"></a>    <span class='hs-varid'>never_active</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNeverActive</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-123"></a>    <span class='hs-varid'>loop_breaker</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrongLoopBreaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>occInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span>
<a name="line-124"></a>    <span class='hs-varid'>bottoming_fn</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBottomingSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span>
<a name="line-125"></a>
<a name="line-126"></a>        <span class='hs-comment'>-- Stuff to do with the Id's unfolding</span>
<a name="line-127"></a>        <span class='hs-comment'>-- We leave the unfolding there even if there is a worker</span>
<a name="line-128"></a>        <span class='hs-comment'>-- In GHCi the unfolding is used by importers</span>
<a name="line-129"></a>
<a name="line-130"></a>    <span class='hs-varid'>show_unfolding</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-131"></a>       <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>expose_all</span>         <span class='hs-comment'>-- 'expose_all' says to expose all</span>
<a name="line-132"></a>                             <span class='hs-comment'>-- unfoldings willy-nilly</span>
<a name="line-133"></a>
<a name="line-134"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>isStableSource</span> <span class='hs-varid'>src</span>     <span class='hs-comment'>-- Always expose things whose</span>
<a name="line-135"></a>                                 <span class='hs-comment'>-- source is an inline rule</span>
<a name="line-136"></a>
<a name="line-137"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>bottoming_fn</span>      <span class='hs-comment'>-- No need to inline bottom functions</span>
<a name="line-138"></a>           <span class='hs-varop'>||</span> <span class='hs-varid'>never_active</span>       <span class='hs-comment'>-- Or ones that say not to</span>
<a name="line-139"></a>           <span class='hs-varop'>||</span> <span class='hs-varid'>loop_breaker</span>       <span class='hs-comment'>-- Or that are loop breakers</span>
<a name="line-140"></a>           <span class='hs-varop'>||</span> <span class='hs-varid'>neverUnfoldGuidance</span> <span class='hs-varid'>guidance</span><span class='hs-layout'>)</span>
<a name="line-141"></a>    <span class='hs-varid'>show_unfolding</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-142"></a>    <span class='hs-varid'>show_unfolding</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
               Deterministic free variables
%*                                                                      *
%************************************************************************

We want a deterministic free-variable list.  exprFreeVars gives us
a VarSet, which is in a non-deterministic order when converted to a
list.  Hence, here we define a free-variable finder that returns
the free variables in the order that they are encountered.

See Note [Choosing external names]

\begin{code}
<pre><a name="line-1"></a><a name="bndrFvsInOrder"></a><span class='hs-definition'>bndrFvsInOrder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>bndrFvsInOrder</span> <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>id</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>run</span> <span class='hs-layout'>(</span><span class='hs-varid'>dffvLetBndr</span> <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="run"></a><span class='hs-definition'>run</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFFV</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a><span class='hs-definition'>run</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFFV</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>                 <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ids</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ids</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="DFFV"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>DFFV</span> <span class='hs-varid'>a</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFFV</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarSet</span>              <span class='hs-comment'>-- Envt: non-top-level things that are in scope</span>
<a name="line-11"></a>                              <span class='hs-comment'>-- we don't want to record these as free vars</span>
<a name="line-12"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarSet</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Input State: (set, list) of free vars so far</span>
<a name="line-13"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>VarSet</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Output state</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>DFFV</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>DFFV</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>pure</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-20"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>DFFV</span> <span class='hs-keyword'>where</span>
<a name="line-23"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFFV</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>st</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>st</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>DFFV</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFFV</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-varid'>st</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-25"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-varid'>env</span> <span class='hs-varid'>st</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>st'</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>of</span>
<a name="line-27"></a>                     <span class='hs-conid'>DFFV</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>env</span> <span class='hs-varid'>st'</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="extendScope"></a><span class='hs-definition'>extendScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-varid'>a</span>
<a name="line-30"></a><span class='hs-definition'>extendScope</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFFV</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFFV</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-varid'>st</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>st</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="extendScopeList"></a><span class='hs-definition'>extendScopeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-varid'>a</span>
<a name="line-33"></a><span class='hs-definition'>extendScopeList</span> <span class='hs-varid'>vs</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFFV</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFFV</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-varid'>st</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarSetList</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>st</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="insert"></a><span class='hs-definition'>insert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-conid'>()</span>
<a name="line-36"></a><span class='hs-definition'>insert</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFFV</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>set</span><span class='hs-layout'>,</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-37"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>keep_me</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-38"></a>                         <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-39"></a>                           <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>set</span><span class='hs-layout'>)</span>
<a name="line-40"></a>           <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>keep_me</span>
<a name="line-41"></a>              <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>set</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>ids</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-42"></a>              <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>set</span><span class='hs-layout'>,</span>                <span class='hs-varid'>ids</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>   <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a>
<a name="line-45"></a><a name="dffvExpr"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-conid'>()</span>
<a name="line-46"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert</span> <span class='hs-varid'>v</span>
<a name="line-47"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e1</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e2</span>
<a name="line-48"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendScope</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-conid'>Breakpoint</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>insert</span> <span class='hs-varid'>ids</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e</span>
<a name="line-50"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-sel'>_other</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e</span>
<a name="line-51"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e</span>
<a name="line-52"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>x</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dffvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>extendScope</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendScopeList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-54"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>mapM_</span> <span class='hs-varid'>dffvBind</span> <span class='hs-varid'>prs</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>extendScope</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM_</span> <span class='hs-varid'>dffvAlt</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-definition'>dffvExpr</span> <span class='hs-sel'>_other</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="dffvAlt"></a><span class='hs-definition'>dffvAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-conid'>()</span>
<a name="line-59"></a><span class='hs-definition'>dffvAlt</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendScopeList</span> <span class='hs-varid'>xs</span> <span class='hs-layout'>(</span><span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="dffvBind"></a><span class='hs-definition'>dffvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-conid'>()</span>
<a name="line-62"></a><span class='hs-definition'>dffvBind</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isId</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>r</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dffvLetBndr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>r</span>
<a name="line-65"></a>                <span class='hs-comment'>-- Pass False because we are doing the RHS right here</span>
<a name="line-66"></a>                <span class='hs-comment'>-- If you say True you'll get *exponential* behaviour!</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="dffvLetBndr"></a><span class='hs-definition'>dffvLetBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFFV</span> <span class='hs-conid'>()</span>
<a name="line-69"></a><span class='hs-comment'>-- Gather the free vars of the RULES and unfolding of a binder</span>
<a name="line-70"></a><span class='hs-comment'>-- We always get the free vars of a *stable* unfolding, but</span>
<a name="line-71"></a><span class='hs-comment'>-- for a *vanilla* one (InlineRhs), the flag controls what happens:</span>
<a name="line-72"></a><span class='hs-comment'>--   True &lt;=&gt; get fvs of even a *vanilla* unfolding</span>
<a name="line-73"></a><span class='hs-comment'>--   False &lt;=&gt; ignore an InlineRhs</span>
<a name="line-74"></a><span class='hs-comment'>-- For nested bindings (call from dffvBind) we always say "False" because</span>
<a name="line-75"></a><span class='hs-comment'>--       we are taking the fvs of the RHS anyway</span>
<a name="line-76"></a><span class='hs-comment'>-- For top-level bindings (call from addExternal, via bndrFvsInOrder)</span>
<a name="line-77"></a><span class='hs-comment'>--       we say "True" if we are exposing that unfolding</span>
<a name="line-78"></a><span class='hs-definition'>dffvLetBndr</span> <span class='hs-varid'>vanilla_unfold</span> <span class='hs-varid'>id</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>go_unf</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span>
<a name="line-80"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>go_rule</span> <span class='hs-layout'>(</span><span class='hs-varid'>specInfoRules</span> <span class='hs-layout'>(</span><span class='hs-varid'>specInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-81"></a>  <span class='hs-keyword'>where</span>
<a name="line-82"></a>    <span class='hs-varid'>idinfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-varid'>go_unf</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-85"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>src</span> <span class='hs-keyword'>of</span>
<a name="line-86"></a>           <span class='hs-conid'>InlineRhs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>vanilla_unfold</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-87"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-88"></a>           <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-89"></a>
<a name="line-90"></a>    <span class='hs-varid'>go_unf</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-91"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendScopeList</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>args</span>
<a name="line-92"></a>    <span class='hs-varid'>go_unf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-varid'>go_rule</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-95"></a>    <span class='hs-varid'>go_rule</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-96"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendScopeList</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>dffvExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
               tidyTopName
%*                                                                      *
%************************************************************************

This is where we set names to local/global based on whether they really are
externally visible (see comment at the top of this module).  If the name
was previously local, we have to give it a unique occurrence name if
we intend to externalise it.

\begin{code}
<pre><a name="line-1"></a><a name="tidyTopName"></a><span class='hs-definition'>tidyTopName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>NameCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyOccEnv</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyOccEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>tidyTopName</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>nc_var</span> <span class='hs-varid'>maybe_ref</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>id</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>global</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>internal</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>localiseName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>global</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>external</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-7"></a>        <span class='hs-comment'>-- Global names are assumed to have been allocated by the renamer,</span>
<a name="line-8"></a>        <span class='hs-comment'>-- so they already have the "right" unique</span>
<a name="line-9"></a>        <span class='hs-comment'>-- And it's a system-wide unique too</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-comment'>-- Now we get to the real reason that all this is in the IO Monad:</span>
<a name="line-12"></a>  <span class='hs-comment'>-- we have to update the name cache in a nice atomic fashion</span>
<a name="line-13"></a>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>local</span>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>internal</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_local_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>nc_var</span> <span class='hs-varid'>mk_new_local</span>
<a name="line-15"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_local_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>        <span class='hs-comment'>-- Even local, internal names must get a unique occurrence, because</span>
<a name="line-17"></a>        <span class='hs-comment'>-- if we do -split-objs we externalise the name later, in the code generator</span>
<a name="line-18"></a>        <span class='hs-comment'>--</span>
<a name="line-19"></a>        <span class='hs-comment'>-- Similarly, we must make sure it has a system-wide Unique, because</span>
<a name="line-20"></a>        <span class='hs-comment'>-- the byte-code generator builds a system-wide Name-&gt;BCO symbol table</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>local</span>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>external</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_external_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>nc_var</span> <span class='hs-varid'>mk_new_external</span>
<a name="line-23"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_external_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tidyTopName"</span>
<a name="line-26"></a>  <span class='hs-keyword'>where</span>
<a name="line-27"></a>    <span class='hs-varid'>name</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-28"></a>    <span class='hs-varid'>external</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>maybe_ref</span>
<a name="line-29"></a>    <span class='hs-varid'>global</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span>
<a name="line-30"></a>    <span class='hs-varid'>local</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varid'>global</span>
<a name="line-31"></a>    <span class='hs-varid'>internal</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varid'>external</span>
<a name="line-32"></a>    <span class='hs-varid'>loc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>name</span>
<a name="line-33"></a>
<a name="line-34"></a>    <span class='hs-varid'>old_occ</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-35"></a>    <span class='hs-varid'>new_occ</span>
<a name="line-36"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_ref</span><span class='hs-layout'>,</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span>
<a name="line-37"></a>          <span class='hs-varid'>mkOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameSpace</span> <span class='hs-varid'>old_occ</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-38"></a>             <span class='hs-keyword'>let</span>
<a name="line-39"></a>                 <span class='hs-varid'>ref_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-40"></a>                 <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameString</span> <span class='hs-varid'>old_occ</span>
<a name="line-41"></a>             <span class='hs-keyword'>in</span>
<a name="line-42"></a>             <span class='hs-keyword'>case</span> <span class='hs-varid'>occ_str</span> <span class='hs-keyword'>of</span>
<a name="line-43"></a>               <span class='hs-chr'>'$'</span><span class='hs-conop'>:</span><span class='hs-chr'>'w'</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ_str</span>
<a name="line-44"></a>                  <span class='hs-comment'>-- workers: the worker for a function already</span>
<a name="line-45"></a>                  <span class='hs-comment'>-- includes the occname for its parent, so there's</span>
<a name="line-46"></a>                  <span class='hs-comment'>-- no need to prepend the referrer.</span>
<a name="line-47"></a>               <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSystemName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ref_str</span>
<a name="line-48"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ref_str</span> <span class='hs-varop'>++</span> <span class='hs-chr'>'_'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>occ_str</span>
<a name="line-49"></a>                  <span class='hs-comment'>-- If this name was system-generated, then don't bother</span>
<a name="line-50"></a>                  <span class='hs-comment'>-- to retain its OccName, just use the referrer.  These</span>
<a name="line-51"></a>                  <span class='hs-comment'>-- system-generated names will become "f1", "f2", etc. for</span>
<a name="line-52"></a>                  <span class='hs-comment'>-- a referrer "f".</span>
<a name="line-53"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_occ</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>new_occ</span>
<a name="line-56"></a>
<a name="line-57"></a>    <span class='hs-varid'>mk_new_local</span> <span class='hs-varid'>nc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>nc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nsUniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ'</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-58"></a>                    <span class='hs-keyword'>where</span>
<a name="line-59"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeUniqFromSupply</span> <span class='hs-layout'>(</span><span class='hs-varid'>nsUniqs</span> <span class='hs-varid'>nc</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-varid'>mk_new_external</span> <span class='hs-varid'>nc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allocateGlobalBinder</span> <span class='hs-varid'>nc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ'</span> <span class='hs-varid'>loc</span>
<a name="line-62"></a>        <span class='hs-comment'>-- If we want to externalise a currently-local name, check</span>
<a name="line-63"></a>        <span class='hs-comment'>-- whether we have already assigned a unique for it.</span>
<a name="line-64"></a>        <span class='hs-comment'>-- If so, use it; if not, extend the table.</span>
<a name="line-65"></a>        <span class='hs-comment'>-- All this is done by allcoateGlobalBinder.</span>
<a name="line-66"></a>        <span class='hs-comment'>-- This is needed when *re*-compiling a module in GHCi; we must</span>
<a name="line-67"></a>        <span class='hs-comment'>-- use the same name for externally-visible things as we did before.</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="findExternalRules"></a><span class='hs-definition'>findExternalRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- Omit pragmas</span>
<a name="line-2"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Local rules for imported fns</span>
<a name="line-4"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldEnv</span>  <span class='hs-comment'>-- Ids that are exported, so we need their rules</span>
<a name="line-5"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>  <span class='hs-comment'>-- The complete rules are gotten by combining</span>
<a name="line-7"></a>  <span class='hs-comment'>--    a) local rules for imported Ids</span>
<a name="line-8"></a>  <span class='hs-comment'>--    b) rules embedded in the top-level Ids</span>
<a name="line-9"></a><span class='hs-definition'>findExternalRules</span> <span class='hs-varid'>omit_prags</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>imp_id_rules</span> <span class='hs-varid'>unfold_env</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>omit_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-varid'>internal_rule</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_id_rules</span> <span class='hs-varop'>++</span> <span class='hs-varid'>local_rules</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>local_rules</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>rule</span>
<a name="line-14"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                     <span class='hs-varid'>external_id</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                     <span class='hs-varid'>rule</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idCoreRules</span> <span class='hs-varid'>id</span>
<a name="line-17"></a>                   <span class='hs-keyglyph'>]</span>
<a name="line-18"></a>
<a name="line-19"></a>    <span class='hs-varid'>internal_rule</span> <span class='hs-varid'>rule</span>
<a name="line-20"></a>        <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>external_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>ruleLhsFreeIds</span> <span class='hs-varid'>rule</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                <span class='hs-comment'>-- Don't export a rule whose LHS mentions a locally-defined</span>
<a name="line-22"></a>                <span class='hs-comment'>--  Id that is completely internal (i.e. not visible to an</span>
<a name="line-23"></a>                <span class='hs-comment'>-- importing module)</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>external_id</span> <span class='hs-varid'>id</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span>
<a name="line-27"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [Which rules to expose]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
findExternalRules filters imp_rules to avoid binders that
aren't externally visible; but the externally-visible binders
are computed (by findExternalIds) assuming that all orphan
rules are externalised (see init_ext_ids in function
'search'). So in fact we may export more than we need.
(It's a sort of mutual recursion.)

%************************************************************************
%*                                                                      *
\subsection{Step 2: top-level tidying}
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- TopTidyEnv: when tidying we need to know</span>
<a name="line-2"></a><span class='hs-comment'>--   * nc_var: The NameCache, containing a unique supply and any pre-ordained Names.</span>
<a name="line-3"></a><span class='hs-comment'>--        These may have arisen because the</span>
<a name="line-4"></a><span class='hs-comment'>--        renamer read in an interface file mentioning M.$wf, say,</span>
<a name="line-5"></a><span class='hs-comment'>--        and assigned it unique r77.  If, on this compilation, we've</span>
<a name="line-6"></a><span class='hs-comment'>--        invented an Id whose name is $wf (but with a different unique)</span>
<a name="line-7"></a><span class='hs-comment'>--        we want to rename it to have unique r77, so that we can do easy</span>
<a name="line-8"></a><span class='hs-comment'>--        comparisons with stuff from the interface file</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>--   * occ_env: The TidyOccEnv, which tells us which local occurrences</span>
<a name="line-11"></a><span class='hs-comment'>--     are 'used'</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>--   * subst_env: A Var-&gt;Var mapping that substitutes the new Var for the old</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="tidyTopBinds"></a><span class='hs-definition'>tidyTopBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-16"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-17"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldEnv</span>
<a name="line-18"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyOccEnv</span>
<a name="line-19"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-20"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-definition'>tidyTopBinds</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>init_occ_env</span> <span class='hs-varid'>binds</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupMkIntegerName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-24"></a>       <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tidy</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-varid'>init_env</span> <span class='hs-varid'>binds</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-varid'>init_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>init_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-varid'>tidy</span> <span class='hs-keyword'>_</span>           <span class='hs-varid'>env</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-33"></a>    <span class='hs-varid'>tidy</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTopBind</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span>
<a name="line-34"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>bs</span>
<a name="line-35"></a>                                  <span class='hs-keyword'>in</span>
<a name="line-36"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-conop'>:</span><span class='hs-varid'>bs'</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="tidyTopBind"></a><span class='hs-comment'>------------------------</span>
<a name="line-39"></a><span class='hs-definition'>tidyTopBind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-40"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageId</span>
<a name="line-41"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-42"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-43"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldEnv</span>
<a name="line-44"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-45"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-46"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>tidyTopBind</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-varid'>unfold_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span><span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env2</span><span class='hs-layout'>,</span>  <span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyword'>where</span>
<a name="line-51"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>name'</span><span class='hs-layout'>,</span><span class='hs-varid'>show_unfold</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>bndr</span>
<a name="line-52"></a>    <span class='hs-varid'>caf_info</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hasCafRefs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntegerId</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idArity</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-53"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTopPair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>tidy_env2</span> <span class='hs-varid'>caf_info</span> <span class='hs-varid'>name'</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-varid'>subst2</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr'</span>
<a name="line-55"></a>    <span class='hs-varid'>tidy_env2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst2</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>tidyTopBind</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-varid'>unfold_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span><span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-varid'>prs'</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>    <span class='hs-varid'>prs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tidyTopPair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>tidy_env2</span> <span class='hs-varid'>caf_info</span> <span class='hs-varid'>name'</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-61"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prs</span><span class='hs-layout'>,</span>
<a name="line-62"></a>             <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>name'</span><span class='hs-layout'>,</span><span class='hs-varid'>show_unfold</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-63"></a>                    <span class='hs-varid'>expectJust</span> <span class='hs-str'>"tidyTopBind"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>unfold_env</span> <span class='hs-varid'>id</span>
<a name="line-64"></a>           <span class='hs-keyglyph'>]</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>subst2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>subst1</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>prs'</span><span class='hs-layout'>)</span>
<a name="line-67"></a>    <span class='hs-varid'>tidy_env2</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst2</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a>    <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>prs</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-comment'>-- the CafInfo for a recursive group says whether *any* rhs in</span>
<a name="line-72"></a>        <span class='hs-comment'>-- the group may refer indirectly to a CAF (because then, they all do).</span>
<a name="line-73"></a>    <span class='hs-varid'>caf_info</span>
<a name="line-74"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>or</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasCafRefs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntegerId</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idArity</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-75"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MayHaveCafRefs</span>
<a name="line-76"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCafRefs</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="tidyTopPair"></a><span class='hs-comment'>-----------------------------------------------------------</span>
<a name="line-79"></a><span class='hs-definition'>tidyTopPair</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-80"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- show unfolding</span>
<a name="line-81"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>  <span class='hs-comment'>-- The TidyEnv is used to tidy the IdInfo</span>
<a name="line-82"></a>                        <span class='hs-comment'>-- It is knot-tied: don't look at it!</span>
<a name="line-83"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CafInfo</span>
<a name="line-84"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>             <span class='hs-comment'>-- New name</span>
<a name="line-85"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Binder and RHS before tidying</span>
<a name="line-86"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-87"></a>        <span class='hs-comment'>-- This function is the heart of Step 2</span>
<a name="line-88"></a>        <span class='hs-comment'>-- The rec_tidy_env is the one to use for the IdInfo</span>
<a name="line-89"></a>        <span class='hs-comment'>-- It's necessary because when we are dealing with a recursive</span>
<a name="line-90"></a>        <span class='hs-comment'>-- group, a variable late in the group might be mentioned</span>
<a name="line-91"></a>        <span class='hs-comment'>-- in the IdInfo of one early in the group</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-definition'>tidyTopPair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>rhs_tidy_env</span> <span class='hs-varid'>caf_info</span> <span class='hs-varid'>name'</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span>
<a name="line-95"></a>  <span class='hs-keyword'>where</span>
<a name="line-96"></a>    <span class='hs-varid'>bndr1</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalId</span> <span class='hs-varid'>details</span> <span class='hs-varid'>name'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>idinfo'</span>
<a name="line-97"></a>    <span class='hs-varid'>details</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>bndr</span>   <span class='hs-comment'>-- Preserve the IdDetails</span>
<a name="line-98"></a>    <span class='hs-varid'>ty'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTopType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-99"></a>    <span class='hs-varid'>rhs1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>rhs_tidy_env</span> <span class='hs-varid'>rhs</span>
<a name="line-100"></a>    <span class='hs-varid'>idinfo'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTopIdInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rhs_tidy_env</span> <span class='hs-varid'>name'</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rhs1</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-101"></a>                             <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>caf_info</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="tidyTopIdInfo"></a><span class='hs-comment'>-- tidyTopIdInfo creates the final IdInfo for top-level</span>
<a name="line-104"></a><span class='hs-comment'>-- binders.  There are two delicate pieces:</span>
<a name="line-105"></a><span class='hs-comment'>--</span>
<a name="line-106"></a><span class='hs-comment'>--  * Arity.  After CoreTidy, this arity must not change any more.</span>
<a name="line-107"></a><span class='hs-comment'>--      Indeed, CorePrep must eta expand where necessary to make</span>
<a name="line-108"></a><span class='hs-comment'>--      the manifest arity equal to the claimed arity.</span>
<a name="line-109"></a><span class='hs-comment'>--</span>
<a name="line-110"></a><span class='hs-comment'>--  * CAF info.  This must also remain valid through to code generation.</span>
<a name="line-111"></a><span class='hs-comment'>--      We add the info here so that it propagates to all</span>
<a name="line-112"></a><span class='hs-comment'>--      occurrences of the binders in RHSs, and hence to occurrences in</span>
<a name="line-113"></a><span class='hs-comment'>--      unfoldings, which are inside Ids imported by GHCi. Ditto RULES.</span>
<a name="line-114"></a><span class='hs-comment'>--      CoreToStg makes use of this when constructing SRTs.</span>
<a name="line-115"></a><span class='hs-definition'>tidyTopIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-116"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CafInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdInfo</span>
<a name="line-117"></a><span class='hs-definition'>tidyTopIdInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rhs_tidy_env</span> <span class='hs-varid'>name</span> <span class='hs-varid'>orig_rhs</span> <span class='hs-varid'>tidy_rhs</span> <span class='hs-varid'>idinfo</span> <span class='hs-varid'>show_unfold</span> <span class='hs-varid'>caf_info</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_external</span>     <span class='hs-comment'>-- For internal Ids (not externally visible)</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaIdInfo</span>       <span class='hs-comment'>-- we only need enough info for code generation</span>
<a name="line-120"></a>                        <span class='hs-comment'>-- Arity and strictness info are enough;</span>
<a name="line-121"></a>                        <span class='hs-comment'>--      c.f. CoreTidy.tidyLetBndr</span>
<a name="line-122"></a>        <span class='hs-varop'>`setCafInfo`</span>        <span class='hs-varid'>caf_info</span>
<a name="line-123"></a>        <span class='hs-varop'>`setArityInfo`</span>      <span class='hs-varid'>arity</span>
<a name="line-124"></a>        <span class='hs-varop'>`setStrictnessInfo`</span> <span class='hs-varid'>final_sig</span>
<a name="line-125"></a>
<a name="line-126"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-comment'>-- Externally-visible Ids get the whole lot</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-128"></a>        <span class='hs-varop'>`setCafInfo`</span>           <span class='hs-varid'>caf_info</span>
<a name="line-129"></a>        <span class='hs-varop'>`setArityInfo`</span>         <span class='hs-varid'>arity</span>
<a name="line-130"></a>        <span class='hs-varop'>`setStrictnessInfo`</span>    <span class='hs-varid'>final_sig</span>
<a name="line-131"></a>        <span class='hs-varop'>`setOccInfo`</span>           <span class='hs-varid'>robust_occ_info</span>
<a name="line-132"></a>        <span class='hs-varop'>`setInlinePragInfo`</span>    <span class='hs-layout'>(</span><span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span>
<a name="line-133"></a>        <span class='hs-varop'>`setUnfoldingInfo`</span>     <span class='hs-varid'>unfold_info</span>
<a name="line-134"></a>                <span class='hs-comment'>-- NB: we throw away the Rules</span>
<a name="line-135"></a>                <span class='hs-comment'>-- They have already been extracted by findExternalRules</span>
<a name="line-136"></a>  <span class='hs-keyword'>where</span>
<a name="line-137"></a>    <span class='hs-varid'>is_external</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span>
<a name="line-138"></a>
<a name="line-139"></a>    <span class='hs-comment'>--------- OccInfo ------------</span>
<a name="line-140"></a>    <span class='hs-varid'>robust_occ_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapFragileOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>occInfo</span> <span class='hs-varid'>idinfo</span><span class='hs-layout'>)</span>
<a name="line-141"></a>    <span class='hs-comment'>-- It's important to keep loop-breaker information</span>
<a name="line-142"></a>    <span class='hs-comment'>-- when we are doing -fexpose-all-unfoldings</span>
<a name="line-143"></a>
<a name="line-144"></a>    <span class='hs-comment'>--------- Strictness ------------</span>
<a name="line-145"></a>    <span class='hs-varid'>mb_bot_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprBotStrictness_maybe</span> <span class='hs-varid'>orig_rhs</span>
<a name="line-146"></a>
<a name="line-147"></a>    <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>idinfo</span>
<a name="line-148"></a>    <span class='hs-varid'>final_sig</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isNopSig</span> <span class='hs-varid'>sig</span>
<a name="line-149"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-sel'>_bottom_hidden</span> <span class='hs-varid'>sig</span> <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>sig</span> 
<a name="line-150"></a>                 <span class='hs-comment'>-- try a cheap-and-cheerful bottom analyser</span>
<a name="line-151"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>nsig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_bot_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nsig</span>
<a name="line-152"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-153"></a>
<a name="line-154"></a>    <span class='hs-sel'>_bottom_hidden</span> <span class='hs-varid'>id_sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_bot_str</span> <span class='hs-keyword'>of</span>
<a name="line-155"></a>                                  <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-156"></a>                                  <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>appIsBottom</span> <span class='hs-varid'>id_sig</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-157"></a>
<a name="line-158"></a>    <span class='hs-comment'>--------- Unfolding ------------</span>
<a name="line-159"></a>    <span class='hs-varid'>unf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>idinfo</span>
<a name="line-160"></a>    <span class='hs-varid'>unfold_info</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>show_unfold</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyUnfolding</span> <span class='hs-varid'>rhs_tidy_env</span> <span class='hs-varid'>unf_info</span> <span class='hs-varid'>unf_from_rhs</span>
<a name="line-161"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-162"></a>    <span class='hs-varid'>unf_from_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_bot</span> <span class='hs-varid'>tidy_rhs</span>
<a name="line-163"></a>    <span class='hs-varid'>is_bot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBottomingSig</span> <span class='hs-varid'>final_sig</span>
<a name="line-164"></a>    <span class='hs-comment'>-- NB: do *not* expose the worker if show_unfold is off,</span>
<a name="line-165"></a>    <span class='hs-comment'>--     because that means this thing is a loop breaker or</span>
<a name="line-166"></a>    <span class='hs-comment'>--     marked NOINLINE or something like that</span>
<a name="line-167"></a>    <span class='hs-comment'>-- This is important: if you expose the worker for a loop-breaker</span>
<a name="line-168"></a>    <span class='hs-comment'>-- then you can make the simplifier go into an infinite loop, because</span>
<a name="line-169"></a>    <span class='hs-comment'>-- in effect the unfolding is exposed.  See Trac #1709</span>
<a name="line-170"></a>    <span class='hs-comment'>--</span>
<a name="line-171"></a>    <span class='hs-comment'>-- You might think that if show_unfold is False, then the thing should</span>
<a name="line-172"></a>    <span class='hs-comment'>-- not be w/w'd in the first place.  But a legitimate reason is this:</span>
<a name="line-173"></a>    <span class='hs-comment'>--    the function returns bottom</span>
<a name="line-174"></a>    <span class='hs-comment'>-- In this case, show_unfold will be false (we don't expose unfoldings</span>
<a name="line-175"></a>    <span class='hs-comment'>-- for bottoming functions), but we might still have a worker/wrapper</span>
<a name="line-176"></a>    <span class='hs-comment'>-- split (see Note [Worker-wrapper for bottoming functions] in WorkWrap.lhs</span>
<a name="line-177"></a>
<a name="line-178"></a>    <span class='hs-comment'>--------- Arity ------------</span>
<a name="line-179"></a>    <span class='hs-comment'>-- Usually the Id will have an accurate arity on it, because</span>
<a name="line-180"></a>    <span class='hs-comment'>-- the simplifier has just run, but not always.</span>
<a name="line-181"></a>    <span class='hs-comment'>-- One case I found was when the last thing the simplifier</span>
<a name="line-182"></a>    <span class='hs-comment'>-- did was to let-bind a non-atomic argument and then float</span>
<a name="line-183"></a>    <span class='hs-comment'>-- it to the top level. So it seems more robust just to</span>
<a name="line-184"></a>    <span class='hs-comment'>-- fix it here.</span>
<a name="line-185"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprArity</span> <span class='hs-varid'>orig_rhs</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Figuring out CafInfo for an expression}
%*                                                                      *
%************************************************************************

hasCafRefs decides whether a top-level closure can point into the dynamic heap.
We mark such things as `MayHaveCafRefs' because this information is
used to decide whether a particular closure needs to be referenced
in an SRT or not.

There are two reasons for setting MayHaveCafRefs:
        a) The RHS is a CAF: a top-level updatable thunk.
        b) The RHS refers to something that MayHaveCafRefs

Possible improvement: In an effort to keep the number of CAFs (and
hence the size of the SRTs) down, we could also look at the expression and
decide whether it requires a small bounded amount of heap, so we can ignore
it as a CAF.  In these cases however, we would need to use an additional
CAF list to keep track of non-collectable CAFs.

\begin{code}
<pre><a name="line-1"></a><a name="hasCafRefs"></a><span class='hs-definition'>hasCafRefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-3"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CafInfo</span>
<a name="line-4"></a><span class='hs-definition'>hasCafRefs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>p</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_caf</span> <span class='hs-varop'>||</span> <span class='hs-varid'>mentions_cafs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MayHaveCafRefs</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCafRefs</span>
<a name="line-7"></a> <span class='hs-keyword'>where</span>
<a name="line-8"></a>  <span class='hs-varid'>mentions_cafs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFastTrue</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-varid'>is_dynamic_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDllName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span>
<a name="line-10"></a>  <span class='hs-varid'>is_caf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-varop'>||</span> <span class='hs-varid'>rhsIsStatic</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>is_dynamic_name</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-comment'>-- NB. we pass in the arity of the expression, which is expected</span>
<a name="line-13"></a>  <span class='hs-comment'>-- to be calculated by exprArity.  This is because exprArity</span>
<a name="line-14"></a>  <span class='hs-comment'>-- knows how much eta expansion is going to be done by</span>
<a name="line-15"></a>  <span class='hs-comment'>-- CorePrep later on, and we don't want to duplicate that</span>
<a name="line-16"></a>  <span class='hs-comment'>-- knowledge in rhsIsStatic below.</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="cafRefsE"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Expr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastBool</span>
<a name="line-19"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-keyword'>_</span>      <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafRefsV</span> <span class='hs-varid'>p</span> <span class='hs-varid'>id</span>
<a name="line-20"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafRefsL</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>lit</span>
<a name="line-21"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastOr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-22"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>e</span>
<a name="line-23"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastOr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsEs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhssOfBind</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-24"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-sel'>_bndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastOr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsEs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhssOfAlts</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-sel'>_n</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>e</span>
<a name="line-26"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-sel'>_co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>e</span>
<a name="line-27"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-conid'>False</span>
<a name="line-28"></a><span class='hs-definition'>cafRefsE</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-conid'>False</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="cafRefsEs"></a><span class='hs-definition'>cafRefsEs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Expr</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastBool</span>
<a name="line-31"></a><span class='hs-definition'>cafRefsEs</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-conid'>False</span>
<a name="line-32"></a><span class='hs-definition'>cafRefsEs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-conop'>:</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastOr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cafRefsEs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="cafRefsL"></a><span class='hs-definition'>cafRefsL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Literal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastBool</span>
<a name="line-35"></a><span class='hs-comment'>-- Don't forget that mk_integer id might have Caf refs!</span>
<a name="line-36"></a><span class='hs-comment'>-- We first need to convert the Integer into its final form, to</span>
<a name="line-37"></a><span class='hs-comment'>-- see whether mkInteger is used.</span>
<a name="line-38"></a><span class='hs-definition'>cafRefsL</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>mk_integer</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafRefsE</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtLitInteger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mk_integer</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-definition'>cafRefsL</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-conid'>False</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="cafRefsV"></a><span class='hs-definition'>cafRefsV</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastBool</span>
<a name="line-42"></a><span class='hs-definition'>cafRefsV</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLocalId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-layout'>(</span><span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>id'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>p</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-layout'>(</span><span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-conid'>False</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="fastOr"></a><span class='hs-definition'>fastOr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastBool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastBool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastBool</span>
<a name="line-48"></a><span class='hs-comment'>-- hack for lazy-or over FastBool.</span>
<a name="line-49"></a><span class='hs-definition'>fastOr</span> <span class='hs-varid'>a</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fastBool</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFastTrue</span> <span class='hs-varid'>a</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isFastTrue</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


------------------------------------------------------------------------------
--               Old, dead, type-trimming code
-------------------------------------------------------------------------------

We used to try to "trim off" the constructors of data types that are
not exported, to reduce the size of interface files, at least without
-O.  But that is not always possible: see the old Note [When we can't
trim types] below for exceptions.

Then (Trac #7445) I realised that the TH problem arises for any data type
that we have deriving( Data ), because we can invoke
   Language.Haskell.TH.Quote.dataToExpQ
to get a TH Exp representation of a value built from that data type.
You don't even need {-# LANGUAGE TemplateHaskell #-}.

At this point I give up. The pain of trimming constructors just
doesn't seem worth the gain.  So I've dumped all the code, and am just
leaving it here at the end of the module in case something like this
is ever resurrected.


Note [When we can't trim types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The basic idea of type trimming is to export algebraic data types
abstractly (without their data constructors) when compiling without
-O, unless of course they are explicitly exported by the user.

We always export synonyms, because they can be mentioned in the type
of an exported Id.  We could do a full dependency analysis starting
from the explicit exports, but that's quite painful, and not done for
now.

But there are some times we can't do that, indicated by the 'no_trim_types' flag.

First, Template Haskell.  Consider (Trac #2386) this
        module M(T, makeOne) where
          data T = Yay String
          makeOne = [| Yay "Yep" |]
Notice that T is exported abstractly, but makeOne effectively exports it too!
A module that splices in $(makeOne) will then look for a declartion of Yay,
so it'd better be there.  Hence, brutally but simply, we switch off type
constructor trimming if TH is enabled in this module.

Second, data kinds.  Consider (Trac #5912)
     {-# LANGUAGE DataKinds #-}
     module M() where
     data UnaryTypeC a = UnaryDataC a
     type Bug = 'UnaryDataC
We always export synonyms, so Bug is exposed, and that means that
UnaryTypeC must be too, even though it's not explicitly exported.  In
effect, DataKinds means that we'd need to do a full dependency analysis
to see what data constructors are mentioned.  But we don't do that yet.

In these two cases we just switch off type trimming altogether.

mustExposeTyCon :: Bool         -- Type-trimming flag
                -> NameSet      -- Exports
                -> TyCon        -- The tycon
                -> Bool         -- Can its rep be hidden?
-- We are compiling without -O, and thus trying to write as little as
-- possible into the interface file.  But we must expose the details of
-- any data types whose constructors or fields are exported
mustExposeTyCon no_trim_types exports tc
  | no_trim_types               -- See Note [When we can't trim types]
  = True

  | not (isAlgTyCon tc)         -- Always expose synonyms (otherwise we'd have to
                                -- figure out whether it was mentioned in the type
                                -- of any other exported thing)
  = True

  | isEnumerationTyCon tc       -- For an enumeration, exposing the constructors
  = True                        -- won't lead to the need for further exposure

  | isFamilyTyCon tc            -- Open type family
  = True

  -- Below here we just have data/newtype decls or family instances

  | null data_cons              -- Ditto if there are no data constructors
  = True                        -- (NB: empty data types do not count as enumerations
                                -- see Note [Enumeration types] in TyCon

  | any exported_con data_cons  -- Expose rep if any datacon or field is exported
  = True

  | isNewTyCon tc && isFFITy (snd (newTyConRhs tc))
  = True   -- Expose the rep for newtypes if the rep is an FFI type.
           -- For a very annoying reason.  'Foreign import' is meant to
           -- be able to look through newtypes transparently, but it
           -- can only do that if it can "see" the newtype representation

  | otherwise
  = False
  where
    data_cons = tyConDataCons tc
    exported_con con = any (`elemNameSet` exports)
                           (dataConName con : dataConFieldLabels con)
</body>
</html>
