<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcExpr.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
c%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[TcExpr]{Typecheck an expression}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcExpr</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcPolyExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPolyExprNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMonoExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMonoExprNC</span><span class='hs-layout'>,</span>
<a name="line-2"></a>                <span class='hs-varid'>tcInferRho</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferRhoNC</span><span class='hs-layout'>,</span>
<a name="line-3"></a>                <span class='hs-varid'>tcSyntaxOp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCheckId</span><span class='hs-layout'>,</span>
<a name="line-4"></a>                <span class='hs-varid'>addExprErrCtxt</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>   <span class='hs-conid'>TcSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypedBracket</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUntypedBracket</span> <span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMeta</span><span class='hs-layout'>(</span> <span class='hs-varid'>liftStringName</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftName</span> <span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-cpp'>#endif</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcBinds</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>tcLookupFamInst</span> <span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>famInstAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataFamInstRepTyCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstMatch</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcArrows</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMatches</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcPat</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMonad</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span><span class='hs-layout'>(</span> <span class='hs-varid'>intPrimTy</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span><span class='hs-layout'>(</span> <span class='hs-varid'>tagToEnumKey</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span><span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Main wrappers}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcPolyExpr"></a><span class='hs-definition'>tcPolyExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPolyExprNC</span>
<a name="line-2"></a>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>        <span class='hs-comment'>-- Expression to type check</span>
<a name="line-3"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>         <span class='hs-comment'>-- Expected type (could be a polytpye)</span>
<a name="line-4"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Generalised expr with expected type</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>-- tcPolyExpr is a convenient place (frequent but not too frequent)</span>
<a name="line-7"></a><span class='hs-comment'>-- place to add context information.</span>
<a name="line-8"></a><span class='hs-comment'>-- The NC version does not do so, usually because the caller wants</span>
<a name="line-9"></a><span class='hs-comment'>-- to do so himself.</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>tcPolyExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addExprErrCtxt</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>$</span>
<a name="line-13"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcPolyExpr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>tcPolyExprNC</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="tcPolyExprNC"></a><span class='hs-definition'>tcPolyExprNC</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcPolyExprNC"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>gen_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGen</span> <span class='hs-conid'>GenSigCtxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rho</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-18"></a>                            <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>rho</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrap</span> <span class='hs-varid'>gen_fn</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="tcMonoExpr"></a><span class='hs-comment'>---------------</span>
<a name="line-22"></a><span class='hs-definition'>tcMonoExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMonoExprNC</span>
<a name="line-23"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>      <span class='hs-comment'>-- Expression to type check</span>
<a name="line-24"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>         <span class='hs-comment'>-- Expected type (could be a type variable)</span>
<a name="line-25"></a>                         <span class='hs-comment'>-- Definitely no foralls at the top</span>
<a name="line-26"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprCtxt</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-30"></a>    <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="tcMonoExprNC"></a><span class='hs-definition'>tcMonoExprNC</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSigmaTy</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-34"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="tcInferRho"></a><span class='hs-comment'>---------------</span>
<a name="line-39"></a><span class='hs-definition'>tcInferRho</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-comment'>-- Infer a *rho*-type.  This is, in effect, a special case</span>
<a name="line-41"></a><span class='hs-comment'>-- for ids and partial applications, so that if</span>
<a name="line-42"></a><span class='hs-comment'>--     f :: Int -&gt; (forall a. a -&gt; a) -&gt; Int</span>
<a name="line-43"></a><span class='hs-comment'>-- then we can infer</span>
<a name="line-44"></a><span class='hs-comment'>--     f 3 :: (forall a. a -&gt; a) -&gt; Int</span>
<a name="line-45"></a><span class='hs-comment'>-- And that in turn is useful</span>
<a name="line-46"></a><span class='hs-comment'>--  (a) for the function part of any application (see tcApp)</span>
<a name="line-47"></a><span class='hs-comment'>--  (b) for the special rule for '$'</span>
<a name="line-48"></a><span class='hs-definition'>tcInferRho</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprCtxt</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="tcInferRhoNC"></a><span class='hs-definition'>tcInferRhoNC</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-52"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInfExpr</span> <span class='hs-varid'>expr</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="tcInfExpr"></a><span class='hs-definition'>tcInfExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-definition'>tcInfExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInferId</span> <span class='hs-varid'>f</span>
<a name="line-57"></a><span class='hs-definition'>tcInfExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>e</span>
<a name="line-58"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-59"></a><span class='hs-definition'>tcInfExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInferApp</span> <span class='hs-varid'>e1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e2</span><span class='hs-keyglyph'>]</span>
<a name="line-60"></a><span class='hs-definition'>tcInfExpr</span> <span class='hs-varid'>e</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInfer</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="tcHole"></a><span class='hs-definition'>tcHole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-63"></a><span class='hs-definition'>tcHole</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>res_ty</span>
<a name="line-64"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-65"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysName</span> <span class='hs-varid'>occ</span>
<a name="line-66"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span>
<a name="line-67"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLoc</span> <span class='hs-conid'>HoleOrigin</span>
<a name="line-68"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>can</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtWanted</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span> <span class='hs-layout'>}</span>
<a name="line-69"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>emitInsoluble</span> <span class='hs-varid'>can</span>
<a name="line-70"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        tcExpr: the main expression typechecker
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tcExpr</span> <span class='hs-varid'>e</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSigmaTy</span> <span class='hs-varid'>res_ty</span>     <span class='hs-comment'>-- Sanity check</span>
<a name="line-3"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcExpr: sigma"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>  <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcCheckId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcApp</span> <span class='hs-varid'>e1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>   <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lit_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLitType</span> <span class='hs-varid'>lit</span>
<a name="line-10"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-varid'>lit_ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>  <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-13"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>info</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>info</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>lit'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOverloadedLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiteralOrigin</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-varid'>lit</span> <span class='hs-varid'>res_ty</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>neg_expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>neg_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>NegateOrigin</span> <span class='hs-varid'>neg_expr</span>
<a name="line-33"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>neg_expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IPOccOrigin</span> <span class='hs-varid'>x</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ipClassName</span>
<a name="line-40"></a>           <span class='hs-comment'>{- Implicit parameters must have a *tau-type* not a.
<a name="line-41"></a>              type scheme.  We enforce this by creating a fresh
<a name="line-42"></a>              type variable as its type.  (Because res_ty may not
<a name="line-43"></a>              be a tau-type.) -}</span>
<a name="line-44"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ip_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ip_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrLitTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsIPNameFS</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ip_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitWanted</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ip_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ip_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromDict</span> <span class='hs-varid'>ipClass</span> <span class='hs-varid'>ip_name</span> <span class='hs-varid'>ip_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>ip_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ip_ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>  <span class='hs-keyword'>where</span>
<a name="line-49"></a>  <span class='hs-comment'>-- Coerces a dictionry for `IP "x" t` into `t`.</span>
<a name="line-50"></a>  <span class='hs-varid'>fromDict</span> <span class='hs-varid'>ipClass</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-51"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unwrapNewTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>ipClass</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-52"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkWpCast</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a>      <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"The dictionary for `IP` is not a newtype?"</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>match</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>match'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMatchLambda</span> <span class='hs-varid'>match</span> <span class='hs-varid'>res_ty</span>
<a name="line-57"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>co_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>match'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-definition'>tcExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunTys</span> <span class='hs-varid'>msg</span> <span class='hs-num'>1</span> <span class='hs-varid'>res_ty</span>
<a name="line-61"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>matches'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMatchesCase</span> <span class='hs-varid'>match_ctxt</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>matches</span> <span class='hs-varid'>body_ty</span>
<a name="line-62"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co_fn</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>matches'</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The function"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-64"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"requires"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-65"></a>        <span class='hs-varid'>match_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_what</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CaseAlt</span><span class='hs-layout'>,</span> <span class='hs-varid'>mc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcBody</span> <span class='hs-layout'>}</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-68"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_tc_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-conid'>ExprSigCtxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-69"></a>
<a name="line-70"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>gen_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-71"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGen</span> <span class='hs-conid'>ExprSigCtxt</span> <span class='hs-varid'>sig_tc_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-72"></a>
<a name="line-73"></a>                  <span class='hs-comment'>-- Remember to extend the lexical type-variable environment</span>
<a name="line-74"></a>                  <span class='hs-comment'>-- See Note [More instantiated than scoped] in TcBinds</span>
<a name="line-75"></a>               <span class='hs-varid'>tcExtendTyVarEnv2</span> 
<a name="line-76"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findScopedTyVars</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>sig_tc_ty</span> <span class='hs-varid'>skol_tvs</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-77"></a>
<a name="line-78"></a>               <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-79"></a>
<a name="line-80"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inner_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExprWithTySigOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrap</span> <span class='hs-varid'>gen_fn</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-varid'>sig_ty</span>
<a name="line-81"></a>
<a name="line-82"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplyInstantiate</span> <span class='hs-conid'>ExprSigOrigin</span> <span class='hs-varid'>sig_tc_ty</span>
<a name="line-83"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>inst_wrap</span> <span class='hs-varid'>inner_expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Can't handle type argument:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-87"></a>        <span class='hs-comment'>-- This is the syntax for type applications that I was planning</span>
<a name="line-88"></a>        <span class='hs-comment'>-- but there are difficulties (e.g. what order for type args)</span>
<a name="line-89"></a>        <span class='hs-comment'>-- so it's not enabled yet.</span>
<a name="line-90"></a>        <span class='hs-comment'>-- Can't eliminate it altogether from the parser, because the</span>
<a name="line-91"></a>        <span class='hs-comment'>-- same parser parses *patterns*.</span>
<a name="line-92"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnboundVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHole</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Infix operators and sections
%*                                                                      *
%************************************************************************

Note [Left sections]
~~~~~~~~~~~~~~~~~~~~
Left sections, like (4 *), are equivalent to
        \ x -> (*) 4 x,
or, if PostfixOperators is enabled, just
        (*) 4
With PostfixOperators we don't actually require the function to take
two arguments at all.  For example, (x `not`) means (not x); you get
postfix operators!  Not Haskell 98, but it's less work and kind of
useful.

Note [Typing rule for ($)]
~~~~~~~~~~~~~~~~~~~~~~~~~~
People write
   runST $ blah
so much, where
   runST :: (forall s. ST s a) -> a
that I have finally given in and written a special type-checking
rule just for saturated appliations of ($).
  * Infer the type of the first argument
  * Decompose it; should be of form (arg2_ty -> res_ty),
       where arg2_ty might be a polytype
  * Use arg2_ty to typecheck arg2

Note [Typing rule for seq]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to allow
       x `seq` (# p,q #)
which suggests this type for seq:
   seq :: forall (a:*) (b:??). a -> b -> b,
with (b:??) meaning that be can be instantiated with an unboxed tuple.
But that's ill-kinded!  Function arguments can't be unboxed tuples.
And indeed, you could not expect to do this with a partially-applied
'seq'; it's only going to work when it's fully applied.  so it turns
into
    case x of _ -> (# p,q #)

For a while I slid by by giving 'seq' an ill-kinded type, but then
the simplifier eta-reduced an application of seq and Lint blew up
with a kind error.  It seems more uniform to treat 'seq' as it it
was a language construct.

See Note [seqId magic] in MkId, and


\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>op</span>
<a name="line-3"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>op_name</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>seqIdKey</span>           <span class='hs-comment'>-- Note [Typing rule for seq]</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg1_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg2_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArg</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1_ty</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArg</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2_ty</span><span class='hs-layout'>,</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>op_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>op_name</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>op'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpTyApps</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>OpApp</span> <span class='hs-varid'>arg1'</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>arg2'</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>op</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>op_name</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>dollarIdKey</span>        <span class='hs-comment'>-- Note [Typing rule for ($)]</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Application rule"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRho</span> <span class='hs-varid'>arg1</span>
<a name="line-16"></a>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The first argument of ($) takes"</span><span class='hs-layout'>)</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_arg1</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg2_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunTys</span> <span class='hs-varid'>doc</span> <span class='hs-num'>1</span> <span class='hs-varid'>arg1_ty</span>
<a name="line-19"></a>         <span class='hs-comment'>-- arg1_ty = arg2_ty -&gt; op_res_ty</span>
<a name="line-20"></a>         <span class='hs-comment'>-- And arg2_ty maybe polymorphic; that's the point</span>
<a name="line-21"></a>
<a name="line-22"></a>       <span class='hs-comment'>-- Make sure that the argument type has kind '*'</span>
<a name="line-23"></a>       <span class='hs-comment'>-- Eg we do not want to allow  (D#  $  4.0#)   Trac #5570</span>
<a name="line-24"></a>       <span class='hs-comment'>--    (which gives a seg fault)</span>
<a name="line-25"></a>       <span class='hs-comment'>-- We do this by unifying with a MetaTv; but of course</span>
<a name="line-26"></a>       <span class='hs-comment'>-- it must allow foralls in the type it unifies with (hence PolyTv)!</span>
<a name="line-27"></a>       <span class='hs-comment'>--</span>
<a name="line-28"></a>       <span class='hs-comment'>-- The result type can have any kind (Trac #8739),</span>
<a name="line-29"></a>       <span class='hs-comment'>-- so we can just use res_ty</span>
<a name="line-30"></a>
<a name="line-31"></a>       <span class='hs-comment'>-- ($) :: forall (a:*) (b:Open). (a-&gt;b) -&gt; a -&gt; b</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>a_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newPolyFlexiTyVarTy</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArg</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2_ty</span><span class='hs-layout'>,</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co_a</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>arg2_ty</span>   <span class='hs-varid'>a_ty</span>      <span class='hs-comment'>-- arg2 ~ a</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co_b</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>op_res_ty</span> <span class='hs-varid'>res_ty</span>    <span class='hs-comment'>-- op_res ~ res</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>op_id</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>op_name</span>
<a name="line-38"></a>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>op'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpTyApps</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-41"></a>         <span class='hs-conid'>OpApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co_a</span> <span class='hs-varid'>co_b</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-42"></a>                <span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_arg1</span> <span class='hs-varid'>arg1'</span><span class='hs-layout'>)</span>
<a name="line-43"></a>               <span class='hs-varid'>op'</span> <span class='hs-varid'>fix</span>
<a name="line-44"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_a</span> <span class='hs-varid'>arg2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Non Application rule"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferFun</span> <span class='hs-varid'>op</span>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyOpFunTysWrap</span> <span class='hs-varid'>op</span> <span class='hs-num'>2</span> <span class='hs-varid'>op_ty</span>
<a name="line-50"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>op_res_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-51"></a>       <span class='hs-layout'>;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2'</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArgs</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>arg_tys</span>
<a name="line-52"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co_res</span> <span class='hs-varop'>$</span>
<a name="line-53"></a>         <span class='hs-conid'>OpApp</span> <span class='hs-varid'>arg1'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>op'</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>arg2'</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-comment'>-- Right sections, equivalent to \ x -&gt; x `op` expr, or</span>
<a name="line-56"></a><span class='hs-comment'>--      \ x -&gt; op x expr</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>op</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferFun</span> <span class='hs-varid'>op</span>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyOpFunTysWrap</span> <span class='hs-varid'>op</span> <span class='hs-num'>2</span> <span class='hs-varid'>op_ty</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>arg1_ty</span> <span class='hs-varid'>op_res_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-62"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArg</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2_ty</span><span class='hs-layout'>,</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co_res</span> <span class='hs-varop'>$</span>
<a name="line-64"></a>         <span class='hs-conid'>SectionR</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>op'</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg2'</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferFun</span> <span class='hs-varid'>op</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>      <span class='hs-comment'>-- Note [Left sections]</span>
<a name="line-69"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n_reqd_args</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_PostfixOperators</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-70"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span>
<a name="line-71"></a>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyOpFunTysWrap</span> <span class='hs-varid'>op</span> <span class='hs-varid'>n_reqd_args</span> <span class='hs-varid'>op_ty</span>
<a name="line-73"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>op_res_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-74"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArg</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1_ty</span><span class='hs-layout'>,</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-75"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co_res</span> <span class='hs-varop'>$</span>
<a name="line-76"></a>         <span class='hs-conid'>SectionL</span> <span class='hs-varid'>arg1'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>op'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>tupArgPresent</span> <span class='hs-varid'>tup_args</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tup_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxityNormalTupleSort</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tup_args</span><span class='hs-layout'>)</span>
<a name="line-81"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>tup_tc</span> <span class='hs-varid'>res_ty</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tup_args1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTupArgs</span> <span class='hs-varid'>tup_args</span> <span class='hs-varid'>arg_tys</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args1</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-84"></a>
<a name="line-85"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- The tup_args are a mixture of Present and Missing (for tuple sections)</span>
<a name="line-87"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>boxity</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Boxed</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-88"></a>                                   <span class='hs-layout'>;</span> <span class='hs-conid'>Unboxed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>openTypeKind</span> <span class='hs-layout'>}</span>
<a name="line-89"></a>             <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tup_args</span>
<a name="line-90"></a>             <span class='hs-varid'>tup_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxityNormalTupleSort</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span> <span class='hs-varid'>arity</span>
<a name="line-91"></a>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tup_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>actual_res_ty</span>
<a name="line-94"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Missing</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tup_args</span><span class='hs-keyglyph'>]</span>
<a name="line-95"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tup_tc</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>coi</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>actual_res_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-98"></a>
<a name="line-99"></a>       <span class='hs-comment'>-- Handle tuple sections where</span>
<a name="line-100"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tup_args1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTupArgs</span> <span class='hs-varid'>tup_args</span> <span class='hs-varid'>arg_tys</span>
<a name="line-101"></a>
<a name="line-102"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args1</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-103"></a>
<a name="line-104"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>exprs</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>witness</span> <span class='hs-keyword'>of</span>
<a name="line-106"></a>      <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedListTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-107"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>exprs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_elt</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exprs</span>
<a name="line-108"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>elt_ty</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>exprs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>fln</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>list_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-111"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>fln'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>ListOrigin</span> <span class='hs-varid'>fln</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>intTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>list_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-112"></a>                     <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedListTy</span> <span class='hs-varid'>list_ty</span>
<a name="line-113"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>exprs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_elt</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exprs</span>
<a name="line-114"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>elt_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fln'</span><span class='hs-layout'>)</span> <span class='hs-varid'>exprs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>     <span class='hs-keyword'>where</span> <span class='hs-varid'>tc_elt</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>elt_ty</span>
<a name="line-116"></a>
<a name="line-117"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>exprs</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>    <span class='hs-comment'>-- maybe empty</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPArrTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-119"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>exprs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_elt</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exprs</span>
<a name="line-120"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>exprs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-121"></a>  <span class='hs-keyword'>where</span>
<a name="line-122"></a>    <span class='hs-varid'>tc_elt</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>elt_ty</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Let, case, if, do
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLocalBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>$</span>
<a name="line-3"></a>                             <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>res_ty</span>
<a name="line-4"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>binds'</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_ty</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>  <span class='hs-comment'>-- We used to typecheck the case alternatives first.</span>
<a name="line-8"></a>           <span class='hs-comment'>-- The case patterns tend to give good type info to use</span>
<a name="line-9"></a>           <span class='hs-comment'>-- when typechecking the scrutinee.  For example</span>
<a name="line-10"></a>           <span class='hs-comment'>--   case (map f) of</span>
<a name="line-11"></a>           <span class='hs-comment'>--     (x:xs) -&gt; ...</span>
<a name="line-12"></a>           <span class='hs-comment'>-- will report that map is applied to too few arguments</span>
<a name="line-13"></a>           <span class='hs-comment'>--</span>
<a name="line-14"></a>           <span class='hs-comment'>-- But now, in the GADT world, we need to typecheck the scrutinee</span>
<a name="line-15"></a>           <span class='hs-comment'>-- first, to get type info that may be refined in the case alternatives</span>
<a name="line-16"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>scrut'</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRho</span> <span class='hs-varid'>scrut</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"HsCase"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>)</span>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>matches'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMatchesCase</span> <span class='hs-varid'>match_ctxt</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>matches</span> <span class='hs-varid'>exp_ty</span>
<a name="line-20"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a> <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>match_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_what</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CaseAlt</span><span class='hs-layout'>,</span>
<a name="line-23"></a>                      <span class='hs-varid'>mc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcBody</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>    <span class='hs-comment'>-- Ordinary 'if'</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pred'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>boolTy</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>res_ty</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>b2</span> <span class='hs-varid'>res_ty</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>pred'</span> <span class='hs-varid'>b1'</span> <span class='hs-varid'>b2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>   <span class='hs-comment'>-- Note [Rebindable syntax for if]</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pred_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b1_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b2_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>if_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pred_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>b1_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>b2_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fun'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>IfOrigin</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>if_ty</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>pred'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>pred_ty</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b1'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b1_ty</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b2'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>b2</span> <span class='hs-varid'>b2_ty</span>
<a name="line-40"></a>       <span class='hs-comment'>-- Fundamentally we are just typing (ifThenElse e1 e2 e3)</span>
<a name="line-41"></a>       <span class='hs-comment'>-- so maybe we should use the code for function applications</span>
<a name="line-42"></a>       <span class='hs-comment'>-- (which would allow ifThenElse to be higher rank).</span>
<a name="line-43"></a>       <span class='hs-comment'>-- But it's a little awkward, so I'm leaving it alone for now</span>
<a name="line-44"></a>       <span class='hs-comment'>-- and it maintains uniformity with other rebindable syntax</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> <span class='hs-varid'>pred'</span> <span class='hs-varid'>b1'</span> <span class='hs-varid'>b2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcGRHS</span> <span class='hs-varid'>match_ctxt</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsMultiIf</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>alts'</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>match_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_what</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfAlt</span><span class='hs-layout'>,</span> <span class='hs-varid'>mc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcBody</span> <span class='hs-layout'>}</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcDoStmts</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmd'</span><span class='hs-layout'>,</span> <span class='hs-varid'>coi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcProc</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>cmd</span> <span class='hs-varid'>res_ty</span>
<a name="line-57"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>cmd'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Rebindable syntax for if]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The rebindable syntax for 'if' uses the most flexible possible type
for conditionals:
  ifThenElse :: p -> b1 -> b2 -> res
to support expressions like this:

 ifThenElse :: Maybe a -> (a -> b) -> b -> b
 ifThenElse (Just a) f _ = f a  ifThenElse Nothing  _ e = e

 example :: String
 example = if Just 2
              then \v -> show v
              else "No value"


%************************************************************************
%*                                                                      *
                Record construction and update
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rbinds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupDataCon</span> <span class='hs-varid'>con_name</span>
<a name="line-3"></a>
<a name="line-4"></a>        <span class='hs-comment'>-- Check for missing fields</span>
<a name="line-5"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkMissingFields</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>rbinds</span>
<a name="line-6"></a>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferId</span> <span class='hs-varid'>con_name</span>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSourceArity</span> <span class='hs-varid'>data_con</span>
<a name="line-9"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTysN</span> <span class='hs-varid'>con_tau</span> <span class='hs-varid'>arity</span>
<a name="line-10"></a>              <span class='hs-varid'>con_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>data_con</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>co_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>actual_res_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rbinds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRecordBinds</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>rbinds</span>
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co_res</span> <span class='hs-varop'>$</span>
<a name="line-15"></a>          <span class='hs-conid'>RecordCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>con_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>con_expr</span> <span class='hs-varid'>rbinds'</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Type of a record update]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The main complication with RecordUpd is that we need to explicitly
handle the *non-updated* fields.  Consider:

        data T a b c = MkT1 { fa :: a, fb :: (b,c) }
                     | MkT2 { fa :: a, fb :: (b,c), fc :: c -> c }
                     | MkT3 { fd :: a }

        upd :: T a b c -> (b',c) -> T a b' c
        upd t x = t { fb = x}

The result type should be (T a b' c)
not (T a b c),   because 'b' *is not* mentioned in a non-updated field
not (T a b' c'), because 'c' *is*     mentioned in a non-updated field
NB that it's not good enough to look at just one constructor; we must
look at them all; cf Trac #3219

After all, upd should be equivalent to:
        upd t x = case t of
                        MkT1 p q -> MkT1 p x
                        MkT2 a b -> MkT2 p b
                        MkT3 d   -> error ...

So we need to give a completely fresh type to the result record,
and then constrain it by the fields that are *not* updated ("p" above).
We call these the "fixed" type variables, and compute them in getFixedTyVars.

Note that because MkT3 doesn't contain all the fields being updated,
its RHS is simply an error, so it doesn't impose any type constraints.
Hence the use of 'relevant_cont'.

Note [Implict type sharing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We also take into account any "implicit" non-update fields.  For example
        data T a b where { MkT { f::a } :: T a a; ... }
So the "real" type of MkT is: forall ab. (a~b) => a -> T a b

Then consider
        upd t x = t { f=x }
We infer the type
        upd :: T a b -> a -> T a b
        upd (t::T a b) (x::a)
           = case t of { MkT (co:a~b) (_:a) -> MkT co x }
We can't give it the more general type
        upd :: T a b -> c -> T c b

Note [Criteria for update]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to allow update for existentials etc, provided the updated
field isn't part of the existential. For example, this should be ok.
  data T a where { MkT { f1::a, f2::b->b } :: T a }
  f :: T a -> b -> T b
  f t b = t { f1=b }

The criterion we use is this:

  The types of the updated fields
  mention only the universally-quantified type variables
  of the data constructor

NB: this is not (quite) the same as being a "naughty" record selector
(See Note [Naughty record selectors]) in TcTyClsDecls), at least
in the case of GADTs. Consider
   data T a where { MkT :: { f :: a } :: T [a] }
Then f is not "naughty" because it has a well-typed record selector.
But we don't allow updates for 'f'.  (One could consider trying to
allow this, but it makes my head hurt.  Badly.  And no one has asked
for it.)

In principle one could go further, and allow
  g :: T a -> T a
  g t = t { f2 = \x -> x }
because the expression is polymorphic...but that seems a bridge too far.

Note [Data family example]
~~~~~~~~~~~~~~~~~~~~~~~~~~
    data instance T (a,b) = MkT { x::a, y::b }
  --->
    data :TP a b = MkT { a::a, y::b }
    coTP a b :: T (a,b) ~ :TP a b

Suppose r :: T (t1,t2), e :: t3
Then  r { x=e } :: T (t3,t1)
  --->
      case r |> co1 of
        MkT x y -> MkT e y |> co2
      where co1 :: T (t1,t2) ~ :TP t1 t2
            co2 :: :TP t3 t2 ~ T (t3,t2)
The wrapping with co2 is done by the constructor wrapper for MkT

Outgoing invariants
~~~~~~~~~~~~~~~~~~~
In the outgoing (HsRecordUpd scrut binds cons in_inst_tys out_inst_tys):

  * cons are the data constructors to be updated

  * in_inst_tys, out_inst_tys have same length, and instantiate the
        *representation* tycon of the data cons.  In Note [Data
        family example], in_inst_tys = [t1,t2], out_inst_tys = [t3,t2]

\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>record_expr</span> <span class='hs-varid'>rbinds</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>notNull</span> <span class='hs-varid'>upd_fld_names</span> <span class='hs-layout'>)</span>
<a name="line-3"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>
<a name="line-4"></a>        <span class='hs-comment'>-- STEP 0</span>
<a name="line-5"></a>        <span class='hs-comment'>-- Check that the field names are really field names</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sel_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLookupField</span> <span class='hs-varid'>upd_fld_names</span>
<a name="line-7"></a>                        <span class='hs-comment'>-- The renamer has already checked that</span>
<a name="line-8"></a>                        <span class='hs-comment'>-- selectors are all in scope</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bad_guys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notSelector</span> <span class='hs-varid'>fld_name</span><span class='hs-layout'>)</span>
<a name="line-10"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span><span class='hs-layout'>,</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rec_flds</span> <span class='hs-varid'>rbinds</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>sel_ids</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                           <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRecordSelector</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Excludes class ops</span>
<a name="line-12"></a>                           <span class='hs-keyword'>let</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fld_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-varid'>fld</span> <span class='hs-keyglyph'>]</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_guys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequence</span> <span class='hs-varid'>bad_guys</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>failM</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-comment'>-- STEP 1</span>
<a name="line-16"></a>        <span class='hs-comment'>-- Figure out the tycon and data cons from the first field name</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>   <span class='hs-comment'>-- It's OK to use the non-tc splitters here (for a selector)</span>
<a name="line-18"></a>              <span class='hs-varid'>sel_id</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sel_ids</span>
<a name="line-19"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>recordSelectorFieldLabel</span> <span class='hs-varid'>sel_id</span>     <span class='hs-comment'>-- We've failed already if</span>
<a name="line-20"></a>              <span class='hs-varid'>data_cons</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span>                 <span class='hs-comment'>-- it's not a field label</span>
<a name="line-21"></a>                <span class='hs-comment'>-- NB: for a data type family, the tycon is the instance tycon</span>
<a name="line-22"></a>
<a name="line-23"></a>              <span class='hs-varid'>relevant_cons</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_relevant</span> <span class='hs-varid'>data_cons</span>
<a name="line-24"></a>              <span class='hs-varid'>is_relevant</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>upd_fld_names</span>
<a name="line-25"></a>                <span class='hs-comment'>-- A constructor is only relevant to this process if</span>
<a name="line-26"></a>                <span class='hs-comment'>-- it contains *all* the fields that are being updated</span>
<a name="line-27"></a>                <span class='hs-comment'>-- Other ones will cause a runtime error if they occur</span>
<a name="line-28"></a>
<a name="line-29"></a>                <span class='hs-comment'>-- Take apart a representative constructor</span>
<a name="line-30"></a>              <span class='hs-varid'>con1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>relevant_cons</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varid'>head</span> <span class='hs-varid'>relevant_cons</span>
<a name="line-31"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>con1_tvs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>con1_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>con1</span>
<a name="line-32"></a>              <span class='hs-varid'>con1_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>con1</span>
<a name="line-33"></a>              <span class='hs-varid'>con1_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFamilyTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>con1_tvs</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-comment'>-- Step 2</span>
<a name="line-36"></a>        <span class='hs-comment'>-- Check that at least one constructor has all the named fields</span>
<a name="line-37"></a>        <span class='hs-comment'>-- i.e. has an empty set of bad fields returned by badFields</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>relevant_cons</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badFieldsUpd</span> <span class='hs-varid'>rbinds</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-comment'>-- STEP 3    Note [Criteria for update]</span>
<a name="line-41"></a>        <span class='hs-comment'>-- Check that each updated field is polymorphic; that is, its type</span>
<a name="line-42"></a>        <span class='hs-comment'>-- mentions only the universally-quantified variables of the data con</span>
<a name="line-43"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>flds1_w_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipEqual</span> <span class='hs-str'>"tcExpr:RecConUpd"</span> <span class='hs-varid'>con1_flds</span> <span class='hs-varid'>con1_arg_tys</span>
<a name="line-44"></a>              <span class='hs-varid'>upd_flds1_w_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_updated</span> <span class='hs-varid'>flds1_w_tys</span>
<a name="line-45"></a>              <span class='hs-varid'>is_updated</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fld</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>upd_fld_names</span>
<a name="line-46"></a>
<a name="line-47"></a>              <span class='hs-varid'>bad_upd_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>bad_fld</span> <span class='hs-varid'>upd_flds1_w_tys</span>
<a name="line-48"></a>              <span class='hs-varid'>con1_tv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>con1_tvs</span>
<a name="line-49"></a>              <span class='hs-varid'>bad_fld</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fld</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>upd_fld_names</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-50"></a>                                      <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`subVarSet`</span> <span class='hs-varid'>con1_tv_set</span><span class='hs-layout'>)</span>
<a name="line-51"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_upd_flds</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badFieldTypes</span> <span class='hs-varid'>bad_upd_flds</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-comment'>-- STEP 4  Note [Type of a record update]</span>
<a name="line-54"></a>        <span class='hs-comment'>-- Figure out types for the scrutinee and result</span>
<a name="line-55"></a>        <span class='hs-comment'>-- Both are of form (T a b c), with fresh type variables, but with</span>
<a name="line-56"></a>        <span class='hs-comment'>-- common variables where the scrutinee and result must have the same type</span>
<a name="line-57"></a>        <span class='hs-comment'>-- These are variables that appear in *any* arg of *any* of the</span>
<a name="line-58"></a>        <span class='hs-comment'>-- relevant constructors *except* in the updated fields</span>
<a name="line-59"></a>        <span class='hs-comment'>--</span>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fixed_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getFixedTyVars</span> <span class='hs-varid'>con1_tvs</span> <span class='hs-varid'>relevant_cons</span>
<a name="line-61"></a>              <span class='hs-varid'>is_fixed_tv</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fixed_tvs</span>
<a name="line-62"></a>
<a name="line-63"></a>              <span class='hs-varid'>mk_inst_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TKVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-64"></a>              <span class='hs-comment'>-- Deals with instantiation of kind variables</span>
<a name="line-65"></a>              <span class='hs-comment'>--   c.f. TcMType.tcInstTyVarsX</span>
<a name="line-66"></a>              <span class='hs-varid'>mk_inst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_inst_ty</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_fixed_tv</span> <span class='hs-varid'>tv</span>   <span class='hs-comment'>-- Same as result type</span>
<a name="line-68"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>result_inst_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_inst_ty</span><span class='hs-layout'>)</span>
<a name="line-69"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-comment'>-- Fresh type, of correct kind</span>
<a name="line-70"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_inst_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>result_subst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyVars</span> <span class='hs-varid'>con1_tvs</span>
<a name="line-74"></a>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>scrut_subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_inst_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>mk_inst_ty</span> <span class='hs-varid'>emptyTvSubst</span>
<a name="line-76"></a>                                                      <span class='hs-layout'>(</span><span class='hs-varid'>con1_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>result_inst_tys</span><span class='hs-layout'>)</span>
<a name="line-77"></a>
<a name="line-78"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rec_res_ty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>result_subst</span> <span class='hs-varid'>con1_res_ty</span>
<a name="line-79"></a>              <span class='hs-varid'>scrut_ty</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>scrut_subst</span>  <span class='hs-varid'>con1_res_ty</span>
<a name="line-80"></a>              <span class='hs-varid'>con1_arg_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>result_subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>con1_arg_tys</span>
<a name="line-81"></a>
<a name="line-82"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>co_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>rec_res_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-83"></a>
<a name="line-84"></a>        <span class='hs-comment'>-- STEP 5</span>
<a name="line-85"></a>        <span class='hs-comment'>-- Typecheck the thing to be updated, and the bindings</span>
<a name="line-86"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>record_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>record_expr</span> <span class='hs-varid'>scrut_ty</span>
<a name="line-87"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rbinds'</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRecordBinds</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>con1_arg_tys'</span> <span class='hs-varid'>rbinds</span>
<a name="line-88"></a>
<a name="line-89"></a>        <span class='hs-comment'>-- STEP 6: Deal with the stupid theta</span>
<a name="line-90"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>theta'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>scrut_subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConStupidTheta</span> <span class='hs-varid'>con1</span><span class='hs-layout'>)</span>
<a name="line-91"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>instStupidTheta</span> <span class='hs-conid'>RecordUpdOrigin</span> <span class='hs-varid'>theta'</span>
<a name="line-92"></a>
<a name="line-93"></a>        <span class='hs-comment'>-- Step 7: make a cast for the scrutinee, in the case that it's from a type family</span>
<a name="line-94"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>scrut_co</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-95"></a>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_con</span> <span class='hs-varid'>scrut_inst_tys</span><span class='hs-layout'>)</span>
<a name="line-96"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-97"></a>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span>
<a name="line-98"></a>        <span class='hs-comment'>-- Phew!</span>
<a name="line-99"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co_res</span> <span class='hs-varop'>$</span>
<a name="line-100"></a>          <span class='hs-conid'>RecordUpd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrap</span> <span class='hs-varid'>scrut_co</span> <span class='hs-varid'>record_expr'</span><span class='hs-layout'>)</span> <span class='hs-varid'>rbinds'</span>
<a name="line-101"></a>                                   <span class='hs-varid'>relevant_cons</span> <span class='hs-varid'>scrut_inst_tys</span> <span class='hs-varid'>result_inst_tys</span>  <span class='hs-layout'>}</span>
<a name="line-102"></a>  <span class='hs-keyword'>where</span>
<a name="line-103"></a>    <span class='hs-varid'>upd_fld_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsRecFields</span> <span class='hs-varid'>rbinds</span>
<a name="line-104"></a>
<a name="line-105"></a>    <span class='hs-varid'>getFixedTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DataCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-106"></a>    <span class='hs-comment'>-- These tyvars must not change across the updates</span>
<a name="line-107"></a>    <span class='hs-varid'>getFixedTyVars</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>cons</span>
<a name="line-108"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cons</span>
<a name="line-109"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSig</span> <span class='hs-varid'>con</span>
<a name="line-110"></a>                            <span class='hs-varid'>flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>con</span>
<a name="line-111"></a>                            <span class='hs-varid'>fixed_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exactTyVarsOfTypes</span> <span class='hs-varid'>fixed_tys</span>
<a name="line-112"></a>                                    <span class='hs-comment'>-- fixed_tys: See Note [Type of a record update]</span>
<a name="line-113"></a>                                        <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>theta</span>
<a name="line-114"></a>                                    <span class='hs-comment'>-- Universally-quantified tyvars that</span>
<a name="line-115"></a>                                    <span class='hs-comment'>-- appear in any of the *implicit*</span>
<a name="line-116"></a>                                    <span class='hs-comment'>-- arguments to the constructor are fixed</span>
<a name="line-117"></a>                                    <span class='hs-comment'>-- See Note [Implict type sharing]</span>
<a name="line-118"></a>
<a name="line-119"></a>                            <span class='hs-varid'>fixed_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>flds</span> <span class='hs-varid'>arg_tys</span>
<a name="line-120"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>upd_fld_names</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-121"></a>                      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-layout'>,</span><span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs1</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tvs</span>      <span class='hs-comment'>-- Discards existentials in tvs</span>
<a name="line-122"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fixed_tvs</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Arithmetic sequences                    e.g. [a,b..]
        and their parallel-array counterparts   e.g. [: a,b.. :]

%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcArithSeq</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>seq</span> <span class='hs-varid'>res_ty</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>seq</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPArrTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>elt_ty</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>elt_ty</span>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>enumFromToP</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initDsTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dsDPHBuiltin</span> <span class='hs-varid'>enumFromToPVar</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>enum_from_to</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMethodFromName</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-10"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>enumFromToP</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt_ty</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span>
<a name="line-12"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>enum_from_to</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>seq</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>expr3</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPArrTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>elt_ty</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>elt_ty</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr3'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr3</span> <span class='hs-varid'>elt_ty</span>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>enumFromThenToP</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initDsTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dsDPHBuiltin</span> <span class='hs-varid'>enumFromThenToPVar</span>
<a name="line-20"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>eft</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMethodFromName</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>enumFromThenToP</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt_ty</span>        <span class='hs-comment'>-- !!!FIXME: chak</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span>
<a name="line-23"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>eft</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span> <span class='hs-varid'>expr3'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcExpr.tcExpr: Infinite parallel array!"</span>
<a name="line-27"></a>    <span class='hs-comment'>-- the parser shouldn't have generated it and the renamer shouldn't have</span>
<a name="line-28"></a>    <span class='hs-comment'>-- let it through</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Template Haskell
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>is_ty</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span>  <span class='hs-varid'>res_ty</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>is_ty</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- Untyped splices are expanced by the renamer</span>
<a name="line-3"></a>   <span class='hs-varid'>tcSpliceExpr</span> <span class='hs-varid'>splice</span> <span class='hs-varid'>res_ty</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBracket</span> <span class='hs-varid'>brack</span><span class='hs-layout'>)</span>         <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypedBracket</span>   <span class='hs-varid'>brack</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a><span class='hs-definition'>tcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRnBracketOut</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcUntypedBracket</span> <span class='hs-varid'>brack</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>res_ty</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Catch-all
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcExpr"></a><span class='hs-definition'>tcExpr</span> <span class='hs-varid'>other</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcMonoExpr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-2"></a>  <span class='hs-comment'>-- Include ArrForm, ArrApp, which shouldn't appear at all</span>
<a name="line-3"></a>  <span class='hs-comment'>-- Also HsTcBracketOut, HsQuasiQuoteE</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Arithmetic sequences [a..b] etc
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcArithSeq"></a><span class='hs-definition'>tcArithSeq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-definition'>tcArithSeq</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>seq</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wit'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arithSeqEltType</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>elt_ty</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>enum_from</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMethodFromName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-8"></a>                              <span class='hs-varid'>enumFromName</span> <span class='hs-varid'>elt_ty</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>enum_from</span> <span class='hs-varid'>wit'</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>tcArithSeq</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>seq</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wit'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arithSeqEltType</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>res_ty</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>elt_ty</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>elt_ty</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>enum_from_then</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMethodFromName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                              <span class='hs-varid'>enumFromThenName</span> <span class='hs-varid'>elt_ty</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>enum_from_then</span> <span class='hs-varid'>wit'</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>tcArithSeq</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>seq</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wit'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arithSeqEltType</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>res_ty</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>elt_ty</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>expr2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>elt_ty</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>enum_from_to</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMethodFromName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                              <span class='hs-varid'>enumFromToName</span> <span class='hs-varid'>elt_ty</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>enum_from_to</span> <span class='hs-varid'>wit'</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>tcArithSeq</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>seq</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>expr3</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>wit'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arithSeqEltType</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>res_ty</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>elt_ty</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>elt_ty</span>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>expr3'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr3</span> <span class='hs-varid'>elt_ty</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>eft</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMethodFromName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                              <span class='hs-varid'>enumFromThenToName</span> <span class='hs-varid'>elt_ty</span>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>eft</span> <span class='hs-varid'>wit'</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span> <span class='hs-varid'>expr3'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="arithSeqEltType"></a><span class='hs-comment'>-----------------</span>
<a name="line-37"></a><span class='hs-definition'>arithSeqEltType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-38"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-definition'>arithSeqEltType</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>res_ty</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedListTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-42"></a><span class='hs-definition'>arithSeqEltType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>list_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-44"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>ListOrigin</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>list_ty</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedListTy</span> <span class='hs-varid'>list_ty</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>fl'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Applications
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcApp"></a><span class='hs-definition'>tcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Function and args</span>
<a name="line-2"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Translated fun and args</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-definition'>tcApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcApp</span> <span class='hs-varid'>e</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>tcApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcApp</span> <span class='hs-varid'>e1</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>   <span class='hs-comment'>-- Accumulate the arguments</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>tcApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tagToEnumKey</span>
<a name="line-12"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>args</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTagToEnum</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res_ty</span>
<a name="line-14"></a>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>seqIdKey</span>
<a name="line-16"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span><span class='hs-varid'>arg2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>args</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSeq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>arg2</span> <span class='hs-varid'>res_ty</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>tcApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res_ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Type-check the function</span>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferFun</span> <span class='hs-varid'>fun</span>
<a name="line-22"></a>
<a name="line-23"></a>            <span class='hs-comment'>-- Extract its argument types</span>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>expected_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span>
<a name="line-25"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_app_msg</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun_tau</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-comment'>-- Typecheck the result, thereby propagating</span>
<a name="line-28"></a>        <span class='hs-comment'>-- info (if any) from result into the argument types</span>
<a name="line-29"></a>        <span class='hs-comment'>-- Both actual_res_ty and res_ty are deeply skolemised</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>co_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>funResCtxt</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>actual_res_ty</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-31"></a>                    <span class='hs-varid'>unifyType</span> <span class='hs-varid'>actual_res_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- Typecheck the arguments</span>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArgs</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>expected_arg_tys</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-comment'>-- Assemble the result</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fun2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_fun</span> <span class='hs-varid'>fun1</span>
<a name="line-38"></a>              <span class='hs-varid'>app</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_res</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-varid'>mkHsApp</span> <span class='hs-varid'>fun2</span> <span class='hs-varid'>args1</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>app</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a>
<a name="line-43"></a><a name="mk_app_msg"></a><span class='hs-definition'>mk_app_msg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-44"></a><span class='hs-definition'>mk_app_msg</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The function"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is applied to"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="tcInferApp"></a><span class='hs-comment'>----------------</span>
<a name="line-48"></a><span class='hs-definition'>tcInferApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Function and args</span>
<a name="line-49"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Translated fun and args</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-definition'>tcInferApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInferApp</span> <span class='hs-varid'>e</span> <span class='hs-varid'>args</span>
<a name="line-52"></a><span class='hs-definition'>tcInferApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInferApp</span> <span class='hs-varid'>e1</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>tcInferApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Very like the tcApp version, except that there is</span>
<a name="line-55"></a>    <span class='hs-comment'>-- no expected result type passed in</span>
<a name="line-56"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferFun</span> <span class='hs-varid'>fun</span>
<a name="line-57"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>expected_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span>
<a name="line-58"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_app_msg</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun_tau</span>
<a name="line-59"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcArgs</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>expected_arg_tys</span>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fun2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLHsWrapCo</span> <span class='hs-varid'>co_fun</span> <span class='hs-varid'>fun1</span>
<a name="line-61"></a>              <span class='hs-varid'>app</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>mkHsApp</span> <span class='hs-varid'>fun2</span> <span class='hs-varid'>args1</span>
<a name="line-62"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>app</span><span class='hs-layout'>,</span> <span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="tcInferFun"></a><span class='hs-comment'>----------------</span>
<a name="line-65"></a><span class='hs-definition'>tcInferFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-comment'>-- Infer and instantiate the type of a function</span>
<a name="line-67"></a><span class='hs-definition'>tcInferFun</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInferId</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-69"></a>               <span class='hs-comment'>-- Don't wrap a context around a plain Id</span>
<a name="line-70"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-definition'>tcInferFun</span> <span class='hs-varid'>fun</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInfer</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a>         <span class='hs-comment'>-- Zonk the function type carefully, to expose any polymorphism</span>
<a name="line-76"></a>         <span class='hs-comment'>-- E.g. (( \(x::forall a. a-&gt;a). blah ) e)</span>
<a name="line-77"></a>         <span class='hs-comment'>-- We can see the rank-2 type of the lambda in time to genrealise e</span>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fun_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>fun_ty</span>
<a name="line-79"></a>
<a name="line-80"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplyInstantiate</span> <span class='hs-conid'>AppOrigin</span> <span class='hs-varid'>fun_ty'</span>
<a name="line-81"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsWrap</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="tcArgs"></a><span class='hs-comment'>----------------</span>
<a name="line-84"></a><span class='hs-definition'>tcArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>                          <span class='hs-comment'>-- The function (for error messages)</span>
<a name="line-85"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Actual arguments and expected arg types</span>
<a name="line-86"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span>                    <span class='hs-comment'>-- Resulting args</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-definition'>tcArgs</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>expected_arg_tys</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcArg</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip3</span> <span class='hs-varid'>args</span> <span class='hs-varid'>expected_arg_tys</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="tcArg"></a><span class='hs-comment'>----------------</span>
<a name="line-92"></a><span class='hs-definition'>tcArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>                           <span class='hs-comment'>-- The function (for error messages)</span>
<a name="line-93"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Actual argument and expected arg type</span>
<a name="line-94"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>                    <span class='hs-comment'>-- Resulting argument</span>
<a name="line-95"></a><span class='hs-definition'>tcArg</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funAppCtxt</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>)</span>
<a name="line-96"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>tcPolyExprNC</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="tcTupArgs"></a><span class='hs-comment'>----------------</span>
<a name="line-99"></a><span class='hs-definition'>tcTupArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsTupArg</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsTupArg</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span>
<a name="line-100"></a><span class='hs-definition'>tcTupArgs</span> <span class='hs-varid'>args</span> <span class='hs-varid'>tys</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>args</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyword'>where</span>
<a name="line-103"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>,</span>   <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-104"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>arg_ty</span>
<a name="line-105"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="unifyOpFunTysWrap"></a><span class='hs-comment'>----------------</span>
<a name="line-108"></a><span class='hs-definition'>unifyOpFunTysWrap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-109"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-comment'>-- A wrapper for matchExpectedFunTys</span>
<a name="line-111"></a><span class='hs-definition'>unifyOpFunTysWrap</span> <span class='hs-varid'>op</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchExpectedFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>ty</span>
<a name="line-112"></a>  <span class='hs-keyword'>where</span>
<a name="line-113"></a>    <span class='hs-varid'>herald</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The operator"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"takes"</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="tcSyntaxOp"></a><span class='hs-comment'>---------------------------</span>
<a name="line-116"></a><span class='hs-definition'>tcSyntaxOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-comment'>-- Typecheck a syntax operator, checking that it has the specified type</span>
<a name="line-118"></a><span class='hs-comment'>-- The operator is always a variable at this stage (i.e. renamer output)</span>
<a name="line-119"></a><span class='hs-comment'>-- This version assumes res_ty is a monotype</span>
<a name="line-120"></a><span class='hs-definition'>tcSyntaxOp</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferIdWithOrig</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>op</span>
<a name="line-121"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>tcWrapResult</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>rho</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-122"></a><span class='hs-definition'>tcSyntaxOp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other</span>         <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSyntaxOp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
</pre>\end{code}


Note [Push result type in]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Unify with expected result before type-checking the args so that the
info from res_ty percolates to args.  This is when we might detect a
too-few args situation.  (One can think of cases when the opposite
order would give a better error message.)
experimenting with putting this first.

Here's an example where it actually makes a real difference

   class C t a b | t a -> b
   instance C Char a Bool

   data P t a = forall b. (C t a b) => MkP b
   data Q t   = MkQ (forall a. P t a)

   f1, f2 :: Q Char;
   f1 = MkQ (MkP True)
   f2 = MkQ (MkP True :: forall a. P Char a)

With the change, f1 will type-check, because the 'Char' info from
the signature is propagated into MkQ's argument. With the check
in the other order, the extra signature in f2 is reqd.


%************************************************************************
%*                                                                      *
                 tcInferId
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcCheckId"></a><span class='hs-definition'>tcCheckId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tcCheckId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>res_ty</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferId</span> <span class='hs-varid'>name</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>funResCtxt</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>actual_res_ty</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-5"></a>         <span class='hs-varid'>tcWrapResult</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>actual_res_ty</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="tcInferId"></a><span class='hs-comment'>------------------------</span>
<a name="line-8"></a><span class='hs-definition'>tcInferId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-comment'>-- Infer type, and deeply instantiate</span>
<a name="line-10"></a><span class='hs-definition'>tcInferId</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInferIdWithOrig</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOf</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="tcInferIdWithOrig"></a><span class='hs-comment'>------------------------</span>
<a name="line-13"></a><span class='hs-definition'>tcInferIdWithOrig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-comment'>-- Look up an occurrence of an Id, and instantiate it (deeply)</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>tcInferIdWithOrig</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>id_name</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup_id</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>id_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>id_rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instantiateOuter</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>id</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplyInstantiate</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>id_rho</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>id_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>lookup_id</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcId</span>
<a name="line-23"></a>    <span class='hs-varid'>lookup_id</span>
<a name="line-24"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>id_name</span>
<a name="line-25"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>                 <span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tct_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_naughty</span> <span class='hs-varid'>id</span>        <span class='hs-comment'>-- Note [Local record selectors]</span>
<a name="line-28"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>checkThLocalId</span> <span class='hs-varid'>id</span>
<a name="line-29"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>
<a name="line-31"></a>                 <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-32"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_naughty</span> <span class='hs-varid'>id</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>                        <span class='hs-comment'>-- A global cannot possibly be ill-staged</span>
<a name="line-34"></a>                        <span class='hs-comment'>-- nor does it need the 'lifting' treatment</span>
<a name="line-35"></a>                        <span class='hs-comment'>-- hence no checkTh stuff here</span>
<a name="line-36"></a>
<a name="line-37"></a>                 <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-varid'>cl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cl</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>                     <span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                     <span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>patSynWrapper</span> <span class='hs-varid'>ps</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>                         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>bad_patsyn</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                         <span class='hs-conid'>Just</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span>
<a name="line-42"></a>
<a name="line-43"></a>                 <span class='hs-varid'>other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>bad_lookup</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-varid'>bad_lookup</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used where a value identifer was expected"</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>    <span class='hs-varid'>bad_patsyn</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span>  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used in an expression, but it's a non-bidirectional pattern synonym"</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-varid'>check_naughty</span> <span class='hs-varid'>id</span>
<a name="line-50"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNaughtyRecordSelector</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>naughtyRecordSel</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-51"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="instantiateOuter"></a><span class='hs-comment'>------------------------</span>
<a name="line-54"></a><span class='hs-definition'>instantiateOuter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-comment'>-- Do just the first level of instantiation of an Id</span>
<a name="line-56"></a><span class='hs-comment'>--   a) Deal with method sharing</span>
<a name="line-57"></a><span class='hs-comment'>--   b) Deal with stupid checks</span>
<a name="line-58"></a><span class='hs-comment'>-- Only look at the *outer level* of quantification</span>
<a name="line-59"></a><span class='hs-comment'>-- See Note [Multiple instantiation]</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-definition'>instantiateOuter</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>id</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyVars</span> <span class='hs-varid'>tvs</span>
<a name="line-67"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>doStupidChecks</span> <span class='hs-varid'>id</span> <span class='hs-varid'>tys</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>theta'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>theta</span>
<a name="line-69"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Instantiating"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"with"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>theta'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCall</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>theta'</span>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>wrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-72"></a>  <span class='hs-keyword'>where</span>
<a name="line-73"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Multiple instantiation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We are careful never to make a MethodInst that has, as its meth_id, another MethodInst.
For example, consider
        f :: forall a. Eq a => forall b. Ord b => a -> b
At a call to f, at say [Int, Bool], it's tempting to translate the call to

        f_m1
  where
        f_m1 :: forall b. Ord b => Int -> b
        f_m1 = f Int dEqInt

        f_m2 :: Int -> Bool
        f_m2 = f_m1 Bool dOrdBool

But notice that f_m2 has f_m1 as its meth_id.  Now the danger is that if we do
a tcSimplCheck with a Given f_mx :: f Int dEqInt, we may make a binding
        f_m1 = f_mx
But it's entirely possible that f_m2 will continue to float out, because it
mentions no type variables.  Result, f_m1 isn't in scope.

Here's a concrete example that does this (test tc200):

    class C a where
      f :: Eq b => b -> a -> Int
      baz :: Eq a => Int -> a -> Int

    instance C Int where
      baz = f

Current solution: only do the "method sharing" thing for the first type/dict
application, not for the iterated ones.  A horribly subtle point.

\begin{code}
<pre><a name="line-1"></a><a name="doStupidChecks"></a><span class='hs-definition'>doStupidChecks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span>
<a name="line-2"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-4"></a><span class='hs-comment'>-- Check two tiresome and ad-hoc cases</span>
<a name="line-5"></a><span class='hs-comment'>-- (a) the "stupid theta" for a data con; add the constraints</span>
<a name="line-6"></a><span class='hs-comment'>--     from the "stupid theta" of a data constructor (sigh)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>doStupidChecks</span> <span class='hs-varid'>fun_id</span> <span class='hs-varid'>tys</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isDataConId_maybe</span> <span class='hs-varid'>fun_id</span>   <span class='hs-comment'>-- (a)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDataConStupidTheta</span> <span class='hs-varid'>con</span> <span class='hs-varid'>tys</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fun_id</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tagToEnumKey</span>           <span class='hs-comment'>-- (b)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tagToEnum# must appear applied to one argument"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- The common case</span>
</pre>\end{code}

Note [tagToEnum#]
~~~~~~~~~~~~~~~~~
Nasty check to ensure that tagToEnum# is applied to a type that is an
enumeration TyCon.  Unification may refine the type later, but this
check won't see that, alas.  It's crude, because it relies on our
knowing *now* that the type is ok, which in turn relies on the
eager-unification part of the type checker pushing enough information
here.  In theory the Right Thing to do is to have a new form of
constraint but I definitely cannot face that!  And it works ok as-is.

Here's are two cases that should fail
        f :: forall a. a
        f = tagToEnum# 0        -- Can't do tagToEnum# at a type variable

        g :: Int
        g = tagToEnum# 0        -- Int is not an enumeration

When data type families are involved it's a bit more complicated.
     data family F a
     data instance F [Int] = A | B | C
Then we want to generate something like
     tagToEnum# R:FListInt 3# |> co :: R:FListInt ~ F [Int]
Usually that coercion is hidden inside the wrappers for
constructors of F [Int] but here we have to do it explicitly.

It's all grotesquely complicated.

\begin{code}
<pre><a name="line-1"></a><a name="tcSeq"></a><span class='hs-definition'>tcSeq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-comment'>-- (seq e1 e2) :: res_ty</span>
<a name="line-4"></a><span class='hs-comment'>-- We need a special typing rule because res_ty can be unboxed</span>
<a name="line-5"></a><span class='hs-definition'>tcSeq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>arg2</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>fun_name</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInfer</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>arg2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>arg2</span> <span class='hs-varid'>res_ty</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fun'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-varid'>ty_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>              <span class='hs-varid'>ty_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>res_ty</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>arg1_ty</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg1'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="tcTagToEnum"></a><span class='hs-definition'>tcTagToEnum</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-comment'>-- tagToEnum# :: forall a. Int# -&gt; a</span>
<a name="line-15"></a><span class='hs-comment'>-- See Note [tagToEnum#]   Urgh!</span>
<a name="line-16"></a><span class='hs-definition'>tcTagToEnum</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res_ty</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>fun_name</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>res_ty</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-comment'>-- Check that the type is algebraic</span>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_tc_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-22"></a>              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tc_app</span>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_tc_app</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>tagToEnumError</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>doc1</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- Look through any type family</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_rep_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEnumerationTyCon</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>tagToEnumError</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>doc2</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>intPrimTy</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>rep_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>              <span class='hs-varid'>rep_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_args</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>coi</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsApp</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>doc1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Specify the type by giving a type signature"</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"e.g. (tagToEnum# x) :: Bool"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-40"></a>    <span class='hs-varid'>doc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Result type must be an enumeration type"</span><span class='hs-layout'>)</span>
<a name="line-41"></a>    <span class='hs-varid'>doc3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No family instance for this type"</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>get_rep_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-45"></a>        <span class='hs-comment'>-- Converts a family type (eg F [a]) to its rep type (eg FList a)</span>
<a name="line-46"></a>        <span class='hs-comment'>-- and returns a coercion between the two</span>
<a name="line-47"></a>    <span class='hs-varid'>get_rep_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args</span>
<a name="line-48"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-49"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span>
<a name="line-50"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-51"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_fam</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupFamInst</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args</span>
<a name="line-52"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_fam</span> <span class='hs-keyword'>of</span>
<a name="line-53"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tagToEnumError</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>doc3</span><span class='hs-layout'>)</span>
<a name="line-54"></a>               <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstMatch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fim_instance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_fam</span>
<a name="line-55"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>fim_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-56"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcUnbranchedAxInstCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co_tc</span> <span class='hs-varid'>rep_args</span><span class='hs-layout'>)</span>
<a name="line-57"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_args</span> <span class='hs-layout'>)</span>
<a name="line-58"></a>                 <span class='hs-keyword'>where</span>
<a name="line-59"></a>                   <span class='hs-varid'>co_tc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstAxiom</span> <span class='hs-varid'>rep_fam</span>
<a name="line-60"></a>                   <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataFamInstRepTyCon</span> <span class='hs-varid'>rep_fam</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="tagToEnumError"></a><span class='hs-definition'>tagToEnumError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-63"></a><span class='hs-definition'>tagToEnumError</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>what</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad call to tagToEnum#"</span><span class='hs-layout'>)</span>
<a name="line-65"></a>           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-66"></a>         <span class='hs-num'>2</span> <span class='hs-varid'>what</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                 Template Haskell checks
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="checkThLocalId"></a><span class='hs-definition'>checkThLocalId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-cpp'>#ifndef GHCI  /* GHCI and TH is off */</span>
<a name="line-3"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-4"></a><span class='hs-comment'>-- Check for cross-stage lifting</span>
<a name="line-5"></a><span class='hs-definition'>checkThLocalId</span> <span class='hs-sel'>_id</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-cpp'>#else         /* GHCI and TH is on */</span>
<a name="line-9"></a><span class='hs-definition'>checkThLocalId</span> <span class='hs-varid'>id</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_local_use</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStageAndBindLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_local_use</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>             <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>top_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>bind_lvl</span>
<a name="line-14"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>isNotTopLevel</span> <span class='hs-varid'>top_lvl</span>
<a name="line-15"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkCrossStageLifting</span> <span class='hs-varid'>id</span> <span class='hs-varid'>use_stage</span>
<a name="line-16"></a>             <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- Not a locally-bound thing, or</span>
<a name="line-17"></a>                               <span class='hs-comment'>-- no cross-stage link</span>
<a name="line-18"></a>    <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="checkCrossStageLifting"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-21"></a><span class='hs-definition'>checkCrossStageLifting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-22"></a><span class='hs-comment'>-- If we are inside brackets, and (use_lvl &gt; bind_lvl)</span>
<a name="line-23"></a><span class='hs-comment'>-- we must check whether there's a cross-stage lift to do</span>
<a name="line-24"></a><span class='hs-comment'>-- Examples   \x -&gt; [| x |]</span>
<a name="line-25"></a><span class='hs-comment'>--            [| map |]</span>
<a name="line-26"></a><span class='hs-comment'>-- There is no error-checking to do, because the renamer did that</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>checkCrossStageLifting</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPending</span> <span class='hs-varid'>ps_var</span> <span class='hs-varid'>lie_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- Nested identifiers, such as 'x' in</span>
<a name="line-30"></a>        <span class='hs-comment'>-- E.g. \x -&gt; [| h x |]</span>
<a name="line-31"></a>        <span class='hs-comment'>-- We must behave as if the reference to x was</span>
<a name="line-32"></a>        <span class='hs-comment'>--      h $(lift x)</span>
<a name="line-33"></a>        <span class='hs-comment'>-- We use 'x' itself as the splice proxy, used by</span>
<a name="line-34"></a>        <span class='hs-comment'>-- the desugarer to stitch it all back together.</span>
<a name="line-35"></a>        <span class='hs-comment'>-- If 'x' occurs many times we may get many identical</span>
<a name="line-36"></a>        <span class='hs-comment'>-- bindings of the same splice proxy, but that doesn't</span>
<a name="line-37"></a>        <span class='hs-comment'>-- matter, although it's a mite untidy.</span>
<a name="line-38"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>id_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>id</span>
<a name="line-39"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTauTy</span> <span class='hs-varid'>id_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>polySpliceErr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-40"></a>               <span class='hs-comment'>-- If x is polymorphic, its occurrence sites might</span>
<a name="line-41"></a>               <span class='hs-comment'>-- have different instantiations, so we can't use plain</span>
<a name="line-42"></a>               <span class='hs-comment'>-- 'x' as the splice proxy name.  I don't know how to</span>
<a name="line-43"></a>               <span class='hs-comment'>-- solve this, and it's probably unimportant, so I'm</span>
<a name="line-44"></a>               <span class='hs-comment'>-- just going to flag an error for now</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>lift</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isStringTy</span> <span class='hs-varid'>id_ty</span> <span class='hs-keyword'>then</span>
<a name="line-47"></a>                     <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-conid'>DsMeta</span><span class='hs-varop'>.</span><span class='hs-varid'>liftStringName</span>
<a name="line-48"></a>                                     <span class='hs-comment'>-- See Note [Lifting strings]</span>
<a name="line-49"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>sid</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>                  <span class='hs-keyword'>else</span>
<a name="line-51"></a>                     <span class='hs-varid'>setConstraintVar</span> <span class='hs-varid'>lie_var</span>   <span class='hs-varop'>$</span>
<a name="line-52"></a>                          <span class='hs-comment'>-- Put the 'lift' constraint into the right LIE</span>
<a name="line-53"></a>                     <span class='hs-varid'>newMethodFromName</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOf</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>                                       <span class='hs-conid'>DsMeta</span><span class='hs-varop'>.</span><span class='hs-varid'>liftName</span> <span class='hs-varid'>id_ty</span>
<a name="line-55"></a>
<a name="line-56"></a>                   <span class='hs-comment'>-- Update the pending splices</span>
<a name="line-57"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ps_var</span>
<a name="line-58"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ps_var</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>lift</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-definition'>checkCrossStageLifting</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="polySpliceErr"></a><span class='hs-definition'>polySpliceErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-65"></a><span class='hs-definition'>polySpliceErr</span> <span class='hs-varid'>id</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Can't splice the polymorphic local variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-67"></a><span class='hs-cpp'>#endif /* GHCI */</span>
</pre>\end{code}

Note [Lifting strings]
~~~~~~~~~~~~~~~~~~~~~~
If we see $(... [| s |] ...) where s::String, we don't want to
generate a mass of Cons (CharL 'x') (Cons (CharL 'y') ...)) etc.
So this conditional short-circuits the lifting mechanism to generate
(liftString "xy") in that case.  I didn't want to use overlapping instances
for the Lift class in TH.Syntax, because that can lead to overlapping-instance
errors in a polymorphic situation.

If this check fails (which isn't impossible) we get another chance; see
Note [Converting strings] in Convert.lhs

Local record selectors
~~~~~~~~~~~~~~~~~~~~~~
Record selectors for TyCons in this module are ordinary local bindings,
which show up as ATcIds rather than AGlobals.  So we need to check for
naughtiness in both branches.  c.f. TcTyClsBindings.mkAuxBinds.


%************************************************************************
%*                                                                      *
\subsection{Record bindings}
%*                                                                      *
%************************************************************************

Game plan for record bindings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
1. Find the TyCon for the bindings, from the first field label.

2. Instantiate its tyvars and unify (T a1 .. an) with expected_ty.

For each binding field = value

3. Instantiate the field type (from the field label) using the type
   envt from step 2.

4  Type check the value using tcArg, passing the field type as
   the expected argument type.

This extends OK when the field types are universally quantified.


\begin{code}
<pre><a name="line-1"></a><a name="tcRecordBinds"></a><span class='hs-definition'>tcRecordBinds</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Expected type for each field</span>
<a name="line-4"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsRecordBinds</span> <span class='hs-conid'>Name</span>
<a name="line-5"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecordBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>tcRecordBinds</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>rbinds</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>do_bind</span> <span class='hs-varid'>rbinds</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>mb_binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>flds_w_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipEqual</span> <span class='hs-str'>"tcRecordBinds"</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-12"></a>    <span class='hs-varid'>do_bind</span> <span class='hs-varid'>fld</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>field_lbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-13"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>field_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>assocMaybe</span> <span class='hs-varid'>flds_w_tys</span> <span class='hs-varid'>field_lbl</span>
<a name="line-14"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>fieldCtxt</span> <span class='hs-varid'>field_lbl</span><span class='hs-layout'>)</span>        <span class='hs-varop'>$</span>
<a name="line-15"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExprNC</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>field_ty</span>
<a name="line-16"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>field_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUserLocal</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>field_lbl</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                                        <span class='hs-layout'>(</span><span class='hs-varid'>nameUnique</span> <span class='hs-varid'>field_lbl</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                                        <span class='hs-varid'>field_ty</span> <span class='hs-varid'>loc</span>
<a name="line-19"></a>                <span class='hs-comment'>-- Yuk: the field_id has the *unique* of the selector Id</span>
<a name="line-20"></a>                <span class='hs-comment'>--          (so we can find it easily)</span>
<a name="line-21"></a>                <span class='hs-comment'>--      but is a LocalId with the appropriate type of the RHS</span>
<a name="line-22"></a>                <span class='hs-comment'>--          (so the desugarer knows the type of local binder to make)</span>
<a name="line-23"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>field_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-25"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>badFieldCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varid'>field_lbl</span><span class='hs-layout'>)</span>
<a name="line-26"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="checkMissingFields"></a><span class='hs-definition'>checkMissingFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsRecordBinds</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-29"></a><span class='hs-definition'>checkMissingFields</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>rbinds</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>field_labels</span>   <span class='hs-comment'>-- Not declared as a record;</span>
<a name="line-31"></a>                        <span class='hs-comment'>-- But C{} is still valid if no strict fields</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isBanged</span> <span class='hs-varid'>field_strs</span> <span class='hs-keyword'>then</span>
<a name="line-33"></a>        <span class='hs-comment'>-- Illegal if any arg is strict</span>
<a name="line-34"></a>        <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>missingStrictFields</span> <span class='hs-varid'>data_con</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-keyword'>else</span>
<a name="line-36"></a>        <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-37"></a>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>              <span class='hs-comment'>-- A record</span>
<a name="line-39"></a>    <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>missing_s_fields</span><span class='hs-layout'>)</span>
<a name="line-40"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>missingStrictFields</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>missing_s_fields</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>warn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnMissingFields</span>
<a name="line-43"></a>    <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>warn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>notNull</span> <span class='hs-varid'>missing_ns_fields</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>warnTc</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>missingFields</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>missing_ns_fields</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a>  <span class='hs-keyword'>where</span>
<a name="line-47"></a>    <span class='hs-varid'>missing_s_fields</span>
<a name="line-48"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>field_info</span><span class='hs-layout'>,</span>
<a name="line-49"></a>                 <span class='hs-varid'>isBanged</span> <span class='hs-varid'>str</span><span class='hs-layout'>,</span>
<a name="line-50"></a>                 <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>field_names_used</span><span class='hs-layout'>)</span>
<a name="line-51"></a>          <span class='hs-keyglyph'>]</span>
<a name="line-52"></a>    <span class='hs-varid'>missing_ns_fields</span>
<a name="line-53"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>field_info</span><span class='hs-layout'>,</span>
<a name="line-54"></a>                 <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBanged</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-55"></a>                 <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>field_names_used</span><span class='hs-layout'>)</span>
<a name="line-56"></a>          <span class='hs-keyglyph'>]</span>
<a name="line-57"></a>
<a name="line-58"></a>    <span class='hs-varid'>field_names_used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsRecFields</span> <span class='hs-varid'>rbinds</span>
<a name="line-59"></a>    <span class='hs-varid'>field_labels</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>data_con</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-varid'>field_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipEqual</span> <span class='hs-str'>"missingFields"</span>
<a name="line-62"></a>                          <span class='hs-varid'>field_labels</span>
<a name="line-63"></a>                          <span class='hs-varid'>field_strs</span>
<a name="line-64"></a>
<a name="line-65"></a>    <span class='hs-varid'>field_strs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>data_con</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Errors and contexts}
%*                                                                      *
%************************************************************************

Boring and alphabetical:
\begin{code}
<pre><a name="line-1"></a><a name="addExprErrCtxt"></a><span class='hs-definition'>addExprErrCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>addExprErrCtxt</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprCtxt</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="exprCtxt"></a><span class='hs-definition'>exprCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-5"></a><span class='hs-definition'>exprCtxt</span> <span class='hs-varid'>expr</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the expression:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="fieldCtxt"></a><span class='hs-definition'>fieldCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-9"></a><span class='hs-definition'>fieldCtxt</span> <span class='hs-varid'>field_name</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>field_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"field of a record"</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="funAppCtxt"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-13"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_no</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                    <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>", namely"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-16"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="funResCtxt"></a><span class='hs-definition'>funResCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- There is at least one argument</span>
<a name="line-19"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-20"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-comment'>-- When we have a mis-match in the return type of a function</span>
<a name="line-22"></a><span class='hs-comment'>-- try to give a helpful message about too many/few arguments</span>
<a name="line-23"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><span class='hs-comment'>-- Used for naked variables too; but with has_args = False</span>
<a name="line-25"></a><span class='hs-definition'>funResCtxt</span> <span class='hs-varid'>has_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>fun_res_ty</span> <span class='hs-varid'>env_ty</span> <span class='hs-varid'>tidy_env</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>fun_res_ty</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env'</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>env_ty</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_fun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>fun_res'</span>
<a name="line-29"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>args_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>env'</span>
<a name="line-30"></a>             <span class='hs-varid'>n_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args_fun</span>
<a name="line-31"></a>             <span class='hs-varid'>n_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args_env</span>
<a name="line-32"></a>             <span class='hs-varid'>info</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_fun</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-33"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_fun</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n_env</span>
<a name="line-34"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>not_fun</span> <span class='hs-varid'>res_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable cause:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span>
<a name="line-35"></a>                                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is applied to too few arguments"</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>has_args</span>
<a name="line-37"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>not_fun</span> <span class='hs-varid'>res_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible cause:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is applied to too many arguments"</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>  <span class='hs-comment'>-- Never suggest that a naked variable is</span>
<a name="line-40"></a>                                             <span class='hs-comment'>-- applied to too many args!</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>  <span class='hs-keyword'>where</span>
<a name="line-43"></a>    <span class='hs-varid'>not_fun</span> <span class='hs-varid'>ty</span>   <span class='hs-comment'>-- ty is definitely not an arrow type,</span>
<a name="line-44"></a>                 <span class='hs-comment'>-- and cannot conceivably become one</span>
<a name="line-45"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-46"></a>          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-47"></a>          <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="badFieldTypes"></a><span class='hs-definition'>badFieldTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-50"></a><span class='hs-definition'>badFieldTypes</span> <span class='hs-varid'>prs</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Record update for insufficiently polymorphic field"</span><span class='hs-layout'>)</span>
<a name="line-52"></a>                         <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>prs</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-53"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="badFieldsUpd"></a><span class='hs-definition'>badFieldsUpd</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsRecFields</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- Field names that don't belong to a single datacon</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DataCon</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Data cons of the type which the first field name belongs to</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-59"></a><span class='hs-definition'>badFieldsUpd</span> <span class='hs-varid'>rbinds</span> <span class='hs-varid'>data_cons</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No constructor has all these fields:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-61"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>conflictingFields</span><span class='hs-layout'>)</span>
<a name="line-62"></a>          <span class='hs-comment'>-- See Note [Finding the conflicting fields]</span>
<a name="line-63"></a>  <span class='hs-keyword'>where</span>
<a name="line-64"></a>    <span class='hs-comment'>-- A (preferably small) set of fields such that no constructor contains</span>
<a name="line-65"></a>    <span class='hs-comment'>-- all of them.  See Note [Finding the conflicting fields]</span>
<a name="line-66"></a>    <span class='hs-varid'>conflictingFields</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nonMembers</span> <span class='hs-keyword'>of</span>
<a name="line-67"></a>        <span class='hs-comment'>-- nonMember belongs to a different type.</span>
<a name="line-68"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>nonMember</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>aMember</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonMember</span><span class='hs-keyglyph'>]</span>
<a name="line-69"></a>        <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span>
<a name="line-70"></a>            <span class='hs-comment'>-- All of rbinds belong to one type. In this case, repeatedly add</span>
<a name="line-71"></a>            <span class='hs-comment'>-- a field to the set until no constructor contains the set.</span>
<a name="line-72"></a>
<a name="line-73"></a>            <span class='hs-comment'>-- Each field, together with a list indicating which constructors</span>
<a name="line-74"></a>            <span class='hs-comment'>-- have all the fields so far.</span>
<a name="line-75"></a>            <span class='hs-varid'>growingSets</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-76"></a>            <span class='hs-varid'>growingSets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scanl1</span> <span class='hs-varid'>combine</span> <span class='hs-varid'>membership</span>
<a name="line-77"></a>            <span class='hs-varid'>combine</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>setMem</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>field</span><span class='hs-layout'>,</span> <span class='hs-varid'>fldMem</span><span class='hs-layout'>)</span>
<a name="line-78"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>field</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>&amp;&amp;</span><span class='hs-layout'>)</span> <span class='hs-varid'>setMem</span> <span class='hs-varid'>fldMem</span><span class='hs-layout'>)</span>
<a name="line-79"></a>            <span class='hs-keyword'>in</span>
<a name="line-80"></a>            <span class='hs-comment'>-- Fields that don't change the membership status of the set</span>
<a name="line-81"></a>            <span class='hs-comment'>-- are redundant and can be dropped.</span>
<a name="line-82"></a>            <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>head</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>groupBy</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>growingSets</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-varid'>aMember</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>members</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>members</span><span class='hs-layout'>)</span>
<a name="line-85"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>members</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonMembers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>or</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>membership</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-comment'>-- For each field, which constructors contain the field?</span>
<a name="line-88"></a>    <span class='hs-varid'>membership</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-89"></a>    <span class='hs-varid'>membership</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortMembership</span> <span class='hs-varop'>$</span>
<a name="line-90"></a>        <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>fld</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span> <span class='hs-varid'>fieldLabelSets</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-91"></a>          <span class='hs-varid'>hsRecFields</span> <span class='hs-varid'>rbinds</span>
<a name="line-92"></a>
<a name="line-93"></a>    <span class='hs-varid'>fieldLabelSets</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-94"></a>    <span class='hs-varid'>fieldLabelSets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dataConFieldLabels</span><span class='hs-layout'>)</span> <span class='hs-varid'>data_cons</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-comment'>-- Sort in order of increasing number of True, so that a smaller</span>
<a name="line-97"></a>    <span class='hs-comment'>-- conflicting set can be found.</span>
<a name="line-98"></a>    <span class='hs-varid'>sortMembership</span> <span class='hs-keyglyph'>=</span>
<a name="line-99"></a>      <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span>
<a name="line-100"></a>      <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>compare</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span>
<a name="line-101"></a>      <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>membershipRow</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>countTrue</span> <span class='hs-varid'>membershipRow</span><span class='hs-layout'>,</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a>    <span class='hs-varid'>countTrue</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>id</span>
</pre>\end{code}

Note [Finding the conflicting fields]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
  data A = A {a0, a1 :: Int}
         | B {b0, b1 :: Int}
and we see a record update
  x { a0 = 3, a1 = 2, b0 = 4, b1 = 5 }
Then we'd like to find the smallest subset of fields that no
constructor has all of.  Here, say, {a0,b0}, or {a0,b1}, etc.
We don't really want to report that no constructor has all of
{a0,a1,b0,b1}, because when there are hundreds of fields it's 
hard to see what was really wrong.

We may need more than two fields, though; eg
  data T = A { x,y :: Int, v::Int } 
          | B { y,z :: Int, v::Int } 
          | C { z,x :: Int, v::Int }
with update
   r { x=e1, y=e2, z=e3 }, we

Finding the smallest subset is hard, so the code here makes
a decent stab, no more.  See Trac #7989. 

\begin{code}
<pre><a name="line-1"></a><a name="naughtyRecordSel"></a><span class='hs-definition'>naughtyRecordSel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>naughtyRecordSel</span> <span class='hs-varid'>sel_id</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot use record selector"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-4"></a>    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"as a function due to escaped type variables"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-5"></a>    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable fix: use pattern-matching syntax instead"</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="notSelector"></a><span class='hs-definition'>notSelector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-8"></a><span class='hs-definition'>notSelector</span> <span class='hs-varid'>field</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>field</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a record selector"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="missingStrictFields"></a><span class='hs-definition'>missingStrictFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-12"></a><span class='hs-definition'>missingStrictFields</span> <span class='hs-varid'>con</span> <span class='hs-varid'>fields</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>header</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>rest</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fields</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>  <span class='hs-comment'>-- Happens for non-record constructors</span>
<a name="line-16"></a>                                <span class='hs-comment'>-- with strict fields</span>
<a name="line-17"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fields</span>
<a name="line-18"></a>
<a name="line-19"></a>    <span class='hs-varid'>header</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-20"></a>             <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not have the required strict field(s)"</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="missingFields"></a><span class='hs-definition'>missingFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-23"></a><span class='hs-definition'>missingFields</span> <span class='hs-varid'>con</span> <span class='hs-varid'>fields</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Fields of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"not initialised:"</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fields</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-comment'>-- callCtxt fun args = ptext (sLit "In the call") &lt;+&gt; parens (ppr (foldl mkHsApp fun args))</span>
</pre>\end{code}
</body>
</html>
