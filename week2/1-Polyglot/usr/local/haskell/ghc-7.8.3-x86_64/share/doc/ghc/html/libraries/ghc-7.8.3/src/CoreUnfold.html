<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CoreUnfold.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The AQUA Project, Glasgow University, 1994-1998
%

Core-syntax unfoldings

Unfoldings (which can travel across module boundaries) are in Core
syntax (namely @CoreExpr@s).

The type @Unfolding@ sits ``above'' simply-Core-expressions
unfoldings, capturing ``higher-level'' things we know about a binding,
usually things that the simplifier found out (e.g., ``it's a
literal'').  In the corner of a @CoreUnfolding@ unfolding, you will
find, unsurprisingly, a Core expression.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreUnfold</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-conid'>Unfolding</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnfoldingGuidance</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Abstract types</span>
<a name="line-10"></a>
<a name="line-11"></a>	<span class='hs-varid'>noUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkImplicitUnfolding</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>mkUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoreUnfolding</span><span class='hs-layout'>,</span>
<a name="line-13"></a>	<span class='hs-varid'>mkTopUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSimpleUnfolding</span><span class='hs-layout'>,</span>
<a name="line-14"></a>	<span class='hs-varid'>mkInlineUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInlinableUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWwInlineRule</span><span class='hs-layout'>,</span>
<a name="line-15"></a>	<span class='hs-varid'>mkCompulsoryUnfolding</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDFunUnfolding</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>	<span class='hs-varid'>interestingArg</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgSummary</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>	<span class='hs-varid'>couldBeSmallEnoughToInline</span><span class='hs-layout'>,</span> <span class='hs-varid'>inlineBoringOk</span><span class='hs-layout'>,</span>
<a name="line-20"></a>	<span class='hs-varid'>certainlyWillInline</span><span class='hs-layout'>,</span> <span class='hs-varid'>smallEnoughToInline</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>	<span class='hs-varid'>callSiteInline</span><span class='hs-layout'>,</span> <span class='hs-conid'>CallCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-comment'>-- Reexport from CoreSubst (it only live there so it can be used</span>
<a name="line-25"></a>        <span class='hs-comment'>-- by the Very Simple Optimiser)</span>
<a name="line-26"></a>        <span class='hs-varid'>exprIsConApp_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprIsLiteral_maybe</span>
<a name="line-27"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>		<span class='hs-conid'>()</span>	<span class='hs-comment'>-- Instances</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccurAnal</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSubst</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>substTy</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>manifestArity</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprBotStrictness_maybe</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>	<span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>realWorldStatePrimTy</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastTypes</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Making unfoldings}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkTopUnfolding"></a><span class='hs-definition'>mkTopUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-2"></a><span class='hs-definition'>mkTopUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>InlineRhs</span> <span class='hs-conid'>True</span> <span class='hs-comment'>{- Top level -}</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="mkImplicitUnfolding"></a><span class='hs-definition'>mkImplicitUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-5"></a><span class='hs-comment'>-- For implicit Ids, do a tiny bit of optimising first</span>
<a name="line-6"></a><span class='hs-definition'>mkImplicitUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>expr</span>
<a name="line-7"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-- Note [Top-level flag on inline rules]</span>
<a name="line-10"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-11"></a><span class='hs-comment'>-- Slight hack: note that mk_inline_rules conservatively sets the</span>
<a name="line-12"></a><span class='hs-comment'>-- top-level flag to True.  It gets set more accurately by the simplifier</span>
<a name="line-13"></a><span class='hs-comment'>-- Simplify.simplUnfolding.</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="mkSimpleUnfolding"></a><span class='hs-definition'>mkSimpleUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-16"></a><span class='hs-definition'>mkSimpleUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>InlineRhs</span> <span class='hs-conid'>False</span> <span class='hs-conid'>False</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="mkDFunUnfolding"></a><span class='hs-definition'>mkDFunUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-19"></a><span class='hs-definition'>mkDFunUnfolding</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ops</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span>
<a name="line-21"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>df_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span>
<a name="line-22"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>ops</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>                  <span class='hs-comment'>-- See Note [Occurrrence analysis of unfoldings]</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="mkWwInlineRule"></a><span class='hs-definition'>mkWwInlineRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-26"></a><span class='hs-definition'>mkWwInlineRule</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>arity</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-conid'>InlineStable</span> <span class='hs-conid'>True</span>
<a name="line-28"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>arity</span>
<a name="line-29"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>UnfWhen</span> <span class='hs-varid'>unSaturatedOk</span> <span class='hs-varid'>boringCxtNotOk</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="mkCompulsoryUnfolding"></a><span class='hs-definition'>mkCompulsoryUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-32"></a><span class='hs-definition'>mkCompulsoryUnfolding</span> <span class='hs-varid'>expr</span>	   <span class='hs-comment'>-- Used for things that absolutely must be unfolded</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-conid'>InlineCompulsory</span> <span class='hs-conid'>True</span>
<a name="line-34"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Arity of unfolding doesn't matter</span>
<a name="line-35"></a>                    <span class='hs-layout'>(</span><span class='hs-conid'>UnfWhen</span> <span class='hs-varid'>unSaturatedOk</span> <span class='hs-varid'>boringCxtOk</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="mkInlineUnfolding"></a><span class='hs-definition'>mkInlineUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-38"></a><span class='hs-definition'>mkInlineUnfolding</span> <span class='hs-varid'>mb_arity</span> <span class='hs-varid'>expr</span> 
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreUnfolding</span> <span class='hs-conid'>InlineStable</span>
<a name="line-40"></a>    		    <span class='hs-conid'>True</span> 	 <span class='hs-comment'>-- Note [Top-level flag on inline rules]</span>
<a name="line-41"></a>                    <span class='hs-varid'>expr'</span> <span class='hs-varid'>arity</span> 
<a name="line-42"></a>		    <span class='hs-layout'>(</span><span class='hs-conid'>UnfWhen</span> <span class='hs-varid'>unsat_ok</span> <span class='hs-varid'>boring_ok</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span>
<a name="line-45"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>unsat_ok</span><span class='hs-layout'>,</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_arity</span> <span class='hs-keyword'>of</span>
<a name="line-46"></a>                          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>unSaturatedOk</span><span class='hs-layout'>,</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                          <span class='hs-conid'>Just</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>needSaturated</span><span class='hs-layout'>,</span> <span class='hs-varid'>ar</span><span class='hs-layout'>)</span>
<a name="line-48"></a>              
<a name="line-49"></a>    <span class='hs-varid'>boring_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlineBoringOk</span> <span class='hs-varid'>expr'</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="mkInlinableUnfolding"></a><span class='hs-definition'>mkInlinableUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-52"></a><span class='hs-definition'>mkInlinableUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>expr</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>InlineStable</span> <span class='hs-conid'>True</span> <span class='hs-varid'>is_bot</span> <span class='hs-varid'>expr'</span>
<a name="line-54"></a>  <span class='hs-keyword'>where</span>
<a name="line-55"></a>    <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>expr</span>
<a name="line-56"></a>    <span class='hs-varid'>is_bot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprBotStrictness_maybe</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span>
</pre>\end{code}

Internal functions

\begin{code}
<pre><a name="line-1"></a><a name="mkCoreUnfolding"></a><span class='hs-definition'>mkCoreUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnfoldingSource</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingGuidance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-3"></a><span class='hs-comment'>-- Occurrence-analyses the expression before capturing it</span>
<a name="line-4"></a><span class='hs-definition'>mkCoreUnfolding</span> <span class='hs-varid'>src</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>guidance</span> 
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span>   	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-6"></a>                      <span class='hs-comment'>-- See Note [Occurrrence analysis of unfoldings]</span>
<a name="line-7"></a>    		    <span class='hs-varid'>uf_src</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    		    <span class='hs-varid'>uf_arity</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span>
<a name="line-9"></a>		    <span class='hs-varid'>uf_is_top</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>,</span>
<a name="line-10"></a>		    <span class='hs-varid'>uf_is_value</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsHNF</span>        <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                    <span class='hs-varid'>uf_is_conlike</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsConLike</span>    <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-12"></a>		    <span class='hs-varid'>uf_is_work_free</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsWorkFree</span>   <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-13"></a>		    <span class='hs-varid'>uf_expandable</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsExpandable</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-14"></a>		    <span class='hs-varid'>uf_guidance</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="mkUnfolding"></a><span class='hs-definition'>mkUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingSource</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-17"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-18"></a><span class='hs-comment'>-- Calculates unfolding guidance</span>
<a name="line-19"></a><span class='hs-comment'>-- Occurrence-analyses the expression before capturing it</span>
<a name="line-20"></a><span class='hs-definition'>mkUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>src</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>is_bottoming</span> <span class='hs-varid'>expr</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_bottoming</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoUnfolding</span>    <span class='hs-comment'>-- See Note [Do not inline top-level bottoming functions]</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span>   	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurAnalyseExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-26"></a>                      <span class='hs-comment'>-- See Note [Occurrrence analysis of unfoldings]</span>
<a name="line-27"></a>    		    <span class='hs-varid'>uf_src</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span>
<a name="line-28"></a>    		    <span class='hs-varid'>uf_arity</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span>
<a name="line-29"></a>		    <span class='hs-varid'>uf_is_top</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>,</span>
<a name="line-30"></a>		    <span class='hs-varid'>uf_is_value</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsHNF</span>        <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-31"></a>                    <span class='hs-varid'>uf_is_conlike</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsConLike</span>    <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-32"></a>		    <span class='hs-varid'>uf_expandable</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsExpandable</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-33"></a>		    <span class='hs-varid'>uf_is_work_free</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsWorkFree</span>   <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-34"></a>		    <span class='hs-varid'>uf_guidance</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>guidance</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calcUnfoldingGuidance</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>expr</span>
<a name="line-37"></a>        <span class='hs-comment'>-- NB: *not* (calcUnfoldingGuidance (occurAnalyseExpr expr))!</span>
<a name="line-38"></a>	<span class='hs-comment'>-- See Note [Calculate unfolding guidance on the non-occ-anal'd expression]</span>
</pre>\end{code}

Note [Occurrence analysis of unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do occurrence-analysis of unfoldings once and for all, when the
unfolding is built, rather than each time we inline them.

But given this decision it's vital that we do
*always* do it.  Consider this unfolding
    \x -> letrec { f = ...g...; g* = f } in body
where g* is (for some strange reason) the loop breaker.  If we don't
occ-anal it when reading it in, we won't mark g as a loop breaker, and
we may inline g entirely in body, dropping its binding, and leaving
the occurrence in f out of scope. This happened in Trac #8892, where
the unfolding in question was a DFun unfolding.

But more generally, the simplifier is designed on the
basis that it is looking at occurrence-analysed expressions, so better
ensure that they acutally are.

Note [Calculate unfolding guidance on the non-occ-anal'd expression]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Notice that we give the non-occur-analysed expression to
calcUnfoldingGuidance.  In some ways it'd be better to occur-analyse
first; for example, sometimes during simplification, there's a large
let-bound thing which has been substituted, and so is now dead; so
'expr' contains two copies of the thing while the occurrence-analysed
expression doesn't.

Nevertheless, we *don't* and *must not* occ-analyse before computing
the size because 

a) The size computation bales out after a while, whereas occurrence
   analysis does not.

b) Residency increases sharply if you occ-anal first.  I'm not 
   100% sure why, but it's a large effect.  Compiling Cabal went 
   from residency of 534M to over 800M with this one change.

This can occasionally mean that the guidance is very pessimistic;
it gets fixed up next round.  And it should be rare, because large
let-bound things that are dead are usually caught by preInlineUnconditionally


%************************************************************************
%*									*
\subsection{The UnfoldingGuidance type}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="inlineBoringOk"></a><span class='hs-definition'>inlineBoringOk</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [INLINE for small functions]</span>
<a name="line-3"></a><span class='hs-comment'>-- True =&gt; the result of inlining the expression is </span>
<a name="line-4"></a><span class='hs-comment'>--         no bigger than the expression itself</span>
<a name="line-5"></a><span class='hs-comment'>--     eg      (\x y -&gt; f y x)</span>
<a name="line-6"></a><span class='hs-comment'>-- This is a quick and dirty version. It doesn't attempt</span>
<a name="line-7"></a><span class='hs-comment'>-- to deal with  (\x y z -&gt; x (y z))</span>
<a name="line-8"></a><span class='hs-comment'>-- The really important one is (x `cast` c)</span>
<a name="line-9"></a><span class='hs-definition'>inlineBoringOk</span> <span class='hs-varid'>e</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-varid'>e</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-13"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>x</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>credit</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-14"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>e</span>
<a name="line-15"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>f</span>
<a name="line-16"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>credit</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>  
<a name="line-17"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>credit</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- dubious</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 		   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>credit</span> <span class='hs-varid'>e</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         		   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boringCxtOk</span>
<a name="line-21"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span>                		   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boringCxtNotOk</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="calcUnfoldingGuidance"></a><span class='hs-definition'>calcUnfoldingGuidance</span>
<a name="line-24"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-25"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Expression to look at</span>
<a name="line-26"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnfoldingGuidance</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-definition'>calcUnfoldingGuidance</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>expr</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-29"></a>    <span class='hs-keyword'>let</span>
<a name="line-30"></a>        <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ufCreationThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-31"></a>               <span class='hs-comment'>-- Bomb out if size gets bigger than this</span>
<a name="line-32"></a>        <span class='hs-varid'>val_bndrs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndrs</span>
<a name="line-33"></a>	<span class='hs-varid'>n_val_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>val_bndrs</span>
<a name="line-34"></a>
<a name="line-35"></a>    	<span class='hs-varid'>guidance</span> 
<a name="line-36"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sizeExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-varid'>bOMB_OUT_SIZE</span><span class='hs-layout'>)</span> <span class='hs-varid'>val_bndrs</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>of</span>
<a name="line-37"></a>      	      <span class='hs-conid'>TooBig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfNever</span>
<a name="line-38"></a>      	      <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>size</span> <span class='hs-varid'>cased_bndrs</span> <span class='hs-varid'>scrut_discount</span>
<a name="line-39"></a>      	        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>uncondInline</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>n_val_bndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>iBox</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span>
<a name="line-40"></a>      	        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfWhen</span> <span class='hs-varid'>unSaturatedOk</span> <span class='hs-varid'>boringCxtOk</span>   <span class='hs-comment'>-- Note [INLINE for small functions]</span>
<a name="line-41"></a>	        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-42"></a>      	        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>discount</span> <span class='hs-varid'>cased_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>val_bndrs</span>
<a name="line-43"></a>      	                         <span class='hs-layout'>,</span> <span class='hs-varid'>ug_size</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iBox</span> <span class='hs-varid'>size</span>
<a name="line-44"></a>      	        	  	 <span class='hs-layout'>,</span> <span class='hs-varid'>ug_res</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iBox</span> <span class='hs-varid'>scrut_discount</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-varid'>discount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-47"></a>        <span class='hs-varid'>discount</span> <span class='hs-varid'>cbs</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldlBag</span> <span class='hs-varid'>combine</span> <span class='hs-num'>0</span> <span class='hs-varid'>cbs</span>
<a name="line-48"></a>           <span class='hs-keyword'>where</span>
<a name="line-49"></a>             <span class='hs-varid'>combine</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>disc</span><span class='hs-layout'>)</span> 
<a name="line-50"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`plus_disc`</span> <span class='hs-varid'>disc</span>
<a name="line-51"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-52"></a>   
<a name="line-53"></a>             <span class='hs-varid'>plus_disc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-54"></a>             <span class='hs-varid'>plus_disc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span>
<a name="line-55"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span>
<a name="line-56"></a>             <span class='hs-comment'>-- See Note [Function and non-function discounts]</span>
<a name="line-57"></a>    <span class='hs-keyword'>in</span>
<a name="line-58"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>n_val_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>guidance</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Computing the size of an expression]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The basic idea of sizeExpr is obvious enough: count nodes.  But getting the
heuristics right has taken a long time.  Here's the basic strategy:

    * Variables, literals: 0
      (Exception for string literals, see litSize.)

    * Function applications (f e1 .. en): 1 + #value args

    * Constructor applications: 1, regardless of #args

    * Let(rec): 1 + size of components

    * Note, cast: 0

Examples

  Size	Term
  --------------
    0	  42#
    0	  x
    0     True
    2	  f x
    1	  Just x
    4 	  f (g x)

Notice that 'x' counts 0, while (f x) counts 2.  That's deliberate: there's
a function call to account for.  Notice also that constructor applications 
are very cheap, because exposing them to a caller is so valuable.

[25/5/11] All sizes are now multiplied by 10, except for primops
(which have sizes like 1 or 4.  This makes primops look fantastically
cheap, and seems to be almost unversally beneficial.  Done partly as a
result of #4978.

Note [Do not inline top-level bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The FloatOut pass has gone to some trouble to float out calls to 'error' 
and similar friends.  See Note [Bottoming floats] in SetLevels.
Do not re-inline them!  But we *do* still inline if they are very small
(the uncondInline stuff).

Note [INLINE for small functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider	{-# INLINE f #-}
                f x = Just x
                g y = f y
Then f's RHS is no larger than its LHS, so we should inline it into
even the most boring context.  In general, f the function is
sufficiently small that its body is as small as the call itself, the
inline unconditionally, regardless of how boring the context is.

Things to note:

(1) We inline *unconditionally* if inlined thing is smaller (using sizeExpr)
    than the thing it's replacing.  Notice that
      (f x) --> (g 3) 		  -- YES, unconditionally
      (f x) --> x : []		  -- YES, *even though* there are two
      	    	    		  --      arguments to the cons
      x     --> g 3		  -- NO
      x	    --> Just v		  -- NO

    It's very important not to unconditionally replace a variable by
    a non-atomic term.

(2) We do this even if the thing isn't saturated, else we end up with the
    silly situation that
       f x y = x
       ...map (f 3)...
    doesn't inline.  Even in a boring context, inlining without being
    saturated will give a lambda instead of a PAP, and will be more
    efficient at runtime.

(3) However, when the function's arity > 0, we do insist that it 
    has at least one value argument at the call site.  (This check is
    made in the UnfWhen case of callSiteInline.) Otherwise we find this:
         f = /\a \x:a. x
         d = /\b. MkD (f b)
    If we inline f here we get
         d = /\b. MkD (\x:b. x)
    and then prepareRhs floats out the argument, abstracting the type
    variables, so we end up with the original again!

(4) We must be much more cautious about arity-zero things. Consider
       let x = y +# z in ...
    In *size* terms primops look very small, because the generate a
    single instruction, but we do not want to unconditionally replace
    every occurrence of x with (y +# z).  So we only do the
    unconditional-inline thing for *trivial* expressions.
  
    NB: you might think that PostInlineUnconditionally would do this
    but it doesn't fire for top-level things; see SimplUtils
    Note [Top level and postInlineUnconditionally]

\begin{code}
<pre><a name="line-1"></a><a name="uncondInline"></a><span class='hs-definition'>uncondInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-comment'>-- Inline unconditionally if there no size increase</span>
<a name="line-3"></a><span class='hs-comment'>-- Size of call is arity (+1 for the function)</span>
<a name="line-4"></a><span class='hs-comment'>-- See Note [INLINE for small functions]</span>
<a name="line-5"></a><span class='hs-definition'>uncondInline</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>size</span> 
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- See Note [INLINE for small functions] (1)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>rhs</span>        <span class='hs-comment'>-- See Note [INLINE for small functions] (4)</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="sizeExpr"></a><span class='hs-definition'>sizeExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-2"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastInt</span> 	    <span class='hs-comment'>-- Bomb out if it gets bigger than this</span>
<a name="line-3"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>	    <span class='hs-comment'>-- Arguments; we're interested in which of these</span>
<a name="line-4"></a>			    <span class='hs-comment'>-- get case'd</span>
<a name="line-5"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-6"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>-- Note [Computing the size of an expression]</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>sizeExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>expr</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>expr</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>
<a name="line-14"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>
<a name="line-15"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>           <span class='hs-comment'>-- Types cost nothing</span>
<a name="line-16"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-17"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-varid'>litSize</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-19"></a>                      <span class='hs-comment'>-- Make sure we get constructor discounts even</span>
<a name="line-20"></a>                      <span class='hs-comment'>-- on nullary constructors</span>
<a name="line-21"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_call</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span> <span class='hs-num'>0</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyCoArg</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>fun</span>
<a name="line-25"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>arg</span>  <span class='hs-varop'>`addSizeNSD`</span>
<a name="line-26"></a>                        <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>then</span> <span class='hs-num'>1</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-29"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lamScrutDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span> <span class='hs-varop'>`addSizeN`</span> <span class='hs-num'>10</span><span class='hs-layout'>)</span>
<a name="line-30"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-33"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>rhs</span>		<span class='hs-varop'>`addSizeNSD`</span>
<a name="line-34"></a>	<span class='hs-varid'>size_up</span> <span class='hs-varid'>body</span>		<span class='hs-varop'>`addSizeN`</span>
<a name="line-35"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-num'>0</span> <span class='hs-keyword'>else</span> <span class='hs-num'>10</span><span class='hs-layout'>)</span>
<a name="line-36"></a>		<span class='hs-comment'>-- For the allocation</span>
<a name="line-37"></a>		<span class='hs-comment'>-- If the binder has an unlifted type there is no allocation</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-40"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>addSizeNSD</span> <span class='hs-varop'>.</span> <span class='hs-varid'>size_up</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> 
<a name="line-41"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>size_up</span> <span class='hs-varid'>body</span> <span class='hs-varop'>`addSizeN`</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-varid'>length</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- (length pairs) for the allocation</span>
<a name="line-42"></a>              <span class='hs-varid'>pairs</span>
<a name="line-43"></a>
<a name="line-44"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> 
<a name="line-45"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>top_args</span>		<span class='hs-comment'>-- We are scrutinising an argument variable</span>
<a name="line-46"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>alts_size</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>addAltSize</span> <span class='hs-varid'>sizeZero</span> <span class='hs-varid'>alt_sizes</span><span class='hs-layout'>)</span>
<a name="line-47"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>maxSize</span>    <span class='hs-varid'>sizeZero</span> <span class='hs-varid'>alt_sizes</span><span class='hs-layout'>)</span>
<a name="line-48"></a>		<span class='hs-comment'>-- Good to inline if an arg is scrutinised, because</span>
<a name="line-49"></a>		<span class='hs-comment'>-- that may eliminate allocation in the caller</span>
<a name="line-50"></a>		<span class='hs-comment'>-- And it eliminates the case itself</span>
<a name="line-51"></a>	<span class='hs-keyword'>where</span>
<a name="line-52"></a>	  <span class='hs-varid'>alt_sizes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>size_up_alt</span> <span class='hs-varid'>alts</span>
<a name="line-53"></a>
<a name="line-54"></a>		<span class='hs-comment'>-- alts_size tries to compute a good discount for</span>
<a name="line-55"></a>		<span class='hs-comment'>-- the case when we are scrutinising an argument variable</span>
<a name="line-56"></a>	  <span class='hs-varid'>alts_size</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>tot</span> <span class='hs-varid'>tot_disc</span> <span class='hs-varid'>tot_scrut</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Size of all alternatives</span>
<a name="line-57"></a>		    <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>max</span> <span class='hs-keyword'>_</span>        <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-comment'>-- Size of biggest alternative</span>
<a name="line-58"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>tot</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>iBox</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>20</span><span class='hs-layout'>)</span> <span class='hs-varop'>+#</span> <span class='hs-varid'>tot</span> <span class='hs-varop'>-#</span> <span class='hs-varid'>max</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>tot_disc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tot_scrut</span>
<a name="line-59"></a>			<span class='hs-comment'>-- If the variable is known, we produce a discount that</span>
<a name="line-60"></a>			<span class='hs-comment'>-- will take us back to 'max', the size of the largest alternative</span>
<a name="line-61"></a>			<span class='hs-comment'>-- The 1+ is a little discount for reduced allocation in the caller</span>
<a name="line-62"></a>			<span class='hs-comment'>--</span>
<a name="line-63"></a>			<span class='hs-comment'>-- Notice though, that we return tot_disc, the total discount from </span>
<a name="line-64"></a>			<span class='hs-comment'>-- all branches.  I think that's right.</span>
<a name="line-65"></a>
<a name="line-66"></a>	  <span class='hs-varid'>alts_size</span> <span class='hs-varid'>tot_size</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tot_size</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-varid'>size_up</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>e</span>  <span class='hs-varop'>`addSizeNSD`</span>
<a name="line-69"></a>                                <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>addAltSize</span> <span class='hs-varop'>.</span> <span class='hs-varid'>size_up_alt</span><span class='hs-layout'>)</span> <span class='hs-varid'>case_size</span> <span class='hs-varid'>alts</span>
<a name="line-70"></a>      <span class='hs-keyword'>where</span>
<a name="line-71"></a>          <span class='hs-varid'>case_size</span>
<a name="line-72"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_inline_scrut</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>lengthExceeds</span> <span class='hs-varid'>alts</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>10</span><span class='hs-layout'>)</span>
<a name="line-73"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-74"></a>                <span class='hs-comment'>-- Normally we don't charge for the case itself, but</span>
<a name="line-75"></a>                <span class='hs-comment'>-- we charge one per alternative (see size_up_alt,</span>
<a name="line-76"></a>                <span class='hs-comment'>-- below) to account for the cost of the info table</span>
<a name="line-77"></a>                <span class='hs-comment'>-- and comparisons.</span>
<a name="line-78"></a>                <span class='hs-comment'>--</span>
<a name="line-79"></a>                <span class='hs-comment'>-- However, in certain cases (see is_inline_scrut</span>
<a name="line-80"></a>                <span class='hs-comment'>-- below), no code is generated for the case unless</span>
<a name="line-81"></a>                <span class='hs-comment'>-- there are multiple alts.  In these cases we</span>
<a name="line-82"></a>                <span class='hs-comment'>-- subtract one, making the first alt free.</span>
<a name="line-83"></a>                <span class='hs-comment'>-- e.g. case x# +# y# of _ -&gt; ...   should cost 1</span>
<a name="line-84"></a>                <span class='hs-comment'>--      case touch# x# of _ -&gt; ...  should cost 0</span>
<a name="line-85"></a>                <span class='hs-comment'>-- (see #4978)</span>
<a name="line-86"></a>                <span class='hs-comment'>--</span>
<a name="line-87"></a>                <span class='hs-comment'>-- I would like to not have the "not (lengthExceeds alts 1)"</span>
<a name="line-88"></a>                <span class='hs-comment'>-- condition above, but without that some programs got worse</span>
<a name="line-89"></a>                <span class='hs-comment'>-- (spectral/hartel/event and spectral/para).  I don't fully</span>
<a name="line-90"></a>                <span class='hs-comment'>-- understand why. (SDM 24/5/11)</span>
<a name="line-91"></a>
<a name="line-92"></a>                <span class='hs-comment'>-- unboxed variables, inline primops and unsafe foreign calls</span>
<a name="line-93"></a>                <span class='hs-comment'>-- are all "inline" things:</span>
<a name="line-94"></a>          <span class='hs-varid'>is_inline_scrut</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-95"></a>          <span class='hs-varid'>is_inline_scrut</span> <span class='hs-varid'>scrut</span>
<a name="line-96"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>scrut</span>
<a name="line-97"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>of</span>
<a name="line-98"></a>                    <span class='hs-conid'>FCallId</span> <span class='hs-varid'>fc</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSafeForeignCall</span> <span class='hs-varid'>fc</span><span class='hs-layout'>)</span>
<a name="line-99"></a>                    <span class='hs-conid'>PrimOpId</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                    <span class='hs-sel'>_other</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-101"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-102"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-103"></a>
<a name="line-104"></a>    <span class='hs-comment'>------------ </span>
<a name="line-105"></a>    <span class='hs-comment'>-- size_up_app is used when there's ONE OR MORE value args</span>
<a name="line-106"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-107"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyCoArg</span> <span class='hs-varid'>arg</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-108"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-varid'>arg</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>voids</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-109"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>		         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>arg</span>  <span class='hs-varop'>`addSizeNSD`</span>
<a name="line-110"></a>                                           <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>voids</span>
<a name="line-111"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span>     <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up_call</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span>
<a name="line-112"></a>    <span class='hs-varid'>size_up_app</span> <span class='hs-varid'>other</span>         <span class='hs-varid'>args</span> <span class='hs-varid'>voids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>other</span> <span class='hs-varop'>`addSizeN`</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-comment'>-</span> <span class='hs-varid'>voids</span><span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a>    <span class='hs-comment'>------------ </span>
<a name="line-115"></a>    <span class='hs-varid'>size_up_call</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-116"></a>    <span class='hs-varid'>size_up_call</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>val_args</span> <span class='hs-varid'>voids</span>
<a name="line-117"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>fun</span> <span class='hs-keyword'>of</span>
<a name="line-118"></a>           <span class='hs-conid'>FCallId</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-119"></a>           <span class='hs-conid'>DataConWorkId</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>conSize</span>    <span class='hs-varid'>dc</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span>
<a name="line-120"></a>           <span class='hs-conid'>PrimOpId</span> <span class='hs-varid'>op</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>primOpSize</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span>
<a name="line-121"></a>	   <span class='hs-conid'>ClassOpId</span> <span class='hs-keyword'>_</span> 	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>classOpSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>val_args</span>
<a name="line-122"></a>	   <span class='hs-keyword'>_</span>     	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>funSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>val_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>voids</span>
<a name="line-123"></a>
<a name="line-124"></a>    <span class='hs-comment'>------------ </span>
<a name="line-125"></a>    <span class='hs-varid'>size_up_alt</span> <span class='hs-layout'>(</span><span class='hs-sel'>_con</span><span class='hs-layout'>,</span> <span class='hs-sel'>_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size_up</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>`addSizeN`</span> <span class='hs-num'>10</span>
<a name="line-126"></a> 	<span class='hs-comment'>-- Don't charge for args, so that wrappers look cheap</span>
<a name="line-127"></a>	<span class='hs-comment'>-- (See comments about wrappers with Case)</span>
<a name="line-128"></a>	<span class='hs-comment'>--</span>
<a name="line-129"></a>	<span class='hs-comment'>-- IMPORATANT: *do* charge 1 for the alternative, else we </span>
<a name="line-130"></a>	<span class='hs-comment'>-- find that giant case nests are treated as practically free</span>
<a name="line-131"></a>	<span class='hs-comment'>-- A good example is Foreign.C.Error.errrnoToIOError</span>
<a name="line-132"></a>
<a name="line-133"></a>    <span class='hs-comment'>------------</span>
<a name="line-134"></a>	<span class='hs-comment'>-- These addSize things have to be here because</span>
<a name="line-135"></a>	<span class='hs-comment'>-- I don't want to give them bOMB_OUT_SIZE as an argument</span>
<a name="line-136"></a>    <span class='hs-varid'>addSizeN</span> <span class='hs-conid'>TooBig</span>          <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-137"></a>    <span class='hs-varid'>addSizeN</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSizeIs</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+#</span> <span class='hs-varid'>iUnbox</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span>
<a name="line-138"></a>    
<a name="line-139"></a>        <span class='hs-comment'>-- addAltSize is used to add the sizes of case alternatives</span>
<a name="line-140"></a>    <span class='hs-varid'>addAltSize</span> <span class='hs-conid'>TooBig</span>	         <span class='hs-keyword'>_</span>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-141"></a>    <span class='hs-varid'>addAltSize</span> <span class='hs-keyword'>_</span>		 <span class='hs-conid'>TooBig</span>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-142"></a>    <span class='hs-varid'>addAltSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>ys</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span> 
<a name="line-143"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSizeIs</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-varop'>+#</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> 
<a name="line-144"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> 
<a name="line-145"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>+#</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Note [addAltSize result discounts]</span>
<a name="line-146"></a>
<a name="line-147"></a>        <span class='hs-comment'>-- This variant ignores the result discount from its LEFT argument</span>
<a name="line-148"></a>	<span class='hs-comment'>-- It's used when the second argument isn't part of the result</span>
<a name="line-149"></a>    <span class='hs-varid'>addSizeNSD</span> <span class='hs-conid'>TooBig</span>	         <span class='hs-keyword'>_</span>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-150"></a>    <span class='hs-varid'>addSizeNSD</span> <span class='hs-keyword'>_</span>		 <span class='hs-conid'>TooBig</span>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-151"></a>    <span class='hs-varid'>addSizeNSD</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>ys</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span> 
<a name="line-152"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSizeIs</span> <span class='hs-varid'>bOMB_OUT_SIZE</span> <span class='hs-layout'>(</span><span class='hs-varid'>n1</span> <span class='hs-varop'>+#</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> 
<a name="line-153"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> 
<a name="line-154"></a>                                 <span class='hs-varid'>d2</span>  <span class='hs-comment'>-- Ignore d1</span>
<a name="line-155"></a>
<a name="line-156"></a>    <span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>realWorldStatePrimTy</span>
<a name="line-157"></a>
<a name="line-158"></a>    <span class='hs-comment'>-- an expression of type State# RealWorld must be a variable</span>
<a name="line-159"></a>    <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRealWorldId</span> <span class='hs-varid'>id</span>
<a name="line-160"></a>    <span class='hs-varid'>isRealWorldExpr</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="litSize"></a><span class='hs-comment'>-- | Finds a nominal size of a string literal.</span>
<a name="line-2"></a><span class='hs-definition'>litSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Literal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-3"></a><span class='hs-comment'>-- Used by CoreUnfold.sizeExpr</span>
<a name="line-4"></a><span class='hs-definition'>litSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInteger</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>100</span>	<span class='hs-comment'>-- Note [Size of literal integers]</span>
<a name="line-5"></a><span class='hs-definition'>litSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>MachStr</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span> <span class='hs-varop'>+</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>BS</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>str</span> <span class='hs-varop'>+</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>4</span><span class='hs-layout'>)</span>
<a name="line-6"></a>	<span class='hs-comment'>-- If size could be 0 then @f "x"@ might be too small</span>
<a name="line-7"></a>	<span class='hs-comment'>-- [Sept03: make literal strings a bit bigger to avoid fruitless </span>
<a name="line-8"></a>	<span class='hs-comment'>--  duplication of little strings]</span>
<a name="line-9"></a><span class='hs-definition'>litSize</span> <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Must match size of nullary constructors</span>
<a name="line-10"></a>	       	      <span class='hs-comment'>-- Key point: if  x |-&gt; 4, then x must inline unconditionally</span>
<a name="line-11"></a>		      <span class='hs-comment'>--     	    (eg via case binding)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="classOpSize"></a><span class='hs-definition'>classOpSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-14"></a><span class='hs-comment'>-- See Note [Conlike is interesting]</span>
<a name="line-15"></a><span class='hs-definition'>classOpSize</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeZero</span>
<a name="line-17"></a><span class='hs-definition'>classOpSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>other_args</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_discount</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>20</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-varid'>length</span> <span class='hs-varid'>other_args</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-comment'>-- If the class op is scrutinising a lambda bound dictionary then</span>
<a name="line-22"></a>    <span class='hs-comment'>-- give it a discount, to encourage the inlining of this function</span>
<a name="line-23"></a>    <span class='hs-comment'>-- The actual discount is rather arbitrarily chosen</span>
<a name="line-24"></a>    <span class='hs-varid'>arg_discount</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arg1</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>    		     <span class='hs-conid'>Var</span> <span class='hs-varid'>dict</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dict</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>top_args</span> 
<a name="line-26"></a>		     	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>dict</span><span class='hs-layout'>,</span> <span class='hs-varid'>ufDictDiscount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-27"></a>		     <span class='hs-sel'>_other</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyBag</span>
<a name="line-28"></a>    		     
<a name="line-29"></a><a name="funSize"></a><span class='hs-definition'>funSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-30"></a><span class='hs-comment'>-- Size for functions that are not constructors or primops</span>
<a name="line-31"></a><span class='hs-comment'>-- Note [Function applications]</span>
<a name="line-32"></a><span class='hs-definition'>funSize</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>top_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varid'>voids</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>buildIdKey</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildSize</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>augmentIdKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>augmentSize</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_discount</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-varid'>res_discount</span><span class='hs-layout'>)</span>
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>some_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>size</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>some_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span> <span class='hs-comment'>-</span> <span class='hs-varid'>voids</span><span class='hs-layout'>)</span>
<a name="line-40"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-41"></a>	<span class='hs-comment'>-- The 1+ is for the function itself</span>
<a name="line-42"></a>	<span class='hs-comment'>-- Add 1 for each non-trivial arg;</span>
<a name="line-43"></a>	<span class='hs-comment'>-- the allocation cost, as in let(rec)</span>
<a name="line-44"></a>  
<a name="line-45"></a>        <span class='hs-comment'>--                  DISCOUNTS</span>
<a name="line-46"></a>        <span class='hs-comment'>--  See Note [Function and non-function discounts]</span>
<a name="line-47"></a>    <span class='hs-varid'>arg_discount</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>some_val_args</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>top_args</span>
<a name="line-48"></a>    		 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>ufFunAppDiscount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-49"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-50"></a>	<span class='hs-comment'>-- If the function is an argument and is applied</span>
<a name="line-51"></a>	<span class='hs-comment'>-- to some values, give it an arg-discount</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>res_discount</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ufFunAppDiscount</span> <span class='hs-varid'>dflags</span>
<a name="line-54"></a>    		 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   	 	    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-55"></a>        <span class='hs-comment'>-- If the function is partially applied, show a result discount</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="conSize"></a><span class='hs-definition'>conSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-58"></a><span class='hs-definition'>conSize</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>n_val_args</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>10</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Like variables</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-comment'>-- See Note [Unboxed tuple size and result discount]</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-comment'>-- See Note [Constructor size and result discount]</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>10</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Constructor size and result discount]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Treat a constructors application as size 10, regardless of how many
arguments it has; we are keen to expose them (and we charge separately
for their args).  We can't treat them as size zero, else we find that
(Just x) has size 0, which is the same as a lone variable; and hence
'v' will always be replaced by (Just x), where v is bound to Just x.

The "result discount" is applied if the result of the call is
scrutinised (say by a case).  For a constructor application that will
mean the constructor application will disappear, so we don't need to
charge it to the function.  So the discount should at least match the
cost of the constructor application, namely 10.  But to give a bit
of extra incentive we give a discount of 10*(1 + n_val_args).

Simon M tried a MUCH bigger discount: (10 * (10 + n_val_args)), 
and said it was an "unambiguous win", but its terribly dangerous
because a fuction with many many case branches, each finishing with
a constructor, can have an arbitrarily large discount.  This led to
terrible code bloat: see Trac #6099.

Note [Unboxed tuple size and result discount]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
However, unboxed tuples count as size zero. I found occasions where we had 
	f x y z = case op# x y z of { s -> (# s, () #) }
and f wasn't getting inlined.

I tried giving unboxed tuples a *result discount* of zero (see the
commented-out line).  Why?  When returned as a result they do not
allocate, so maybe we don't want to charge so much for them If you
have a non-zero discount here, we find that workers often get inlined
back into wrappers, because it look like
    f x = case $wf x of (# a,b #) -> (a,b)
and we are keener because of the case.  However while this change
shrank binary sizes by 0.5% it also made spectral/boyer allocate 5%
more. All other changes were very small. So it's not a big deal but I
didn't adopt the idea.

Note [Function and non-function discounts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want a discount if the function is applied. A good example is
monadic combinators with continuation arguments, where inlining is
quite important.

But we don't want a big discount when a function is called many times
(see the detailed comments with Trac #6048) because if the function is 
big it won't be inlined at its many call sites and no benefit results.
Indeed, we can get exponentially big inlinings this way; that is what
Trac #6048 is about.

On the other hand, for data-valued arguments, if there are lots of
case expressions in the body, each one will get smaller if we apply
the function to a constructor application, so we *want* a big discount
if the argument is scrutinised by many case expressions.

Conclusion:
  - For functions, take the max of the discounts
  - For data values, take the sum of the discounts


Note [Literal integer size]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Literal integers *can* be big (mkInteger [...coefficients...]), but
need not be (S# n).  We just use an aribitrary big-ish constant here
so that, in particular, we don't inline top-level defns like
   n = S# 5
There's no point in doing so -- any optimisations will see the S#
through n's unfolding.  Nor will a big size inhibit unfoldings functions
that mention a literal Integer, because the float-out pass will float
all those constants to top level.

\begin{code}
<pre><a name="line-1"></a><a name="primOpSize"></a><span class='hs-definition'>primOpSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-2"></a><span class='hs-definition'>primOpSize</span> <span class='hs-varid'>op</span> <span class='hs-varid'>n_val_args</span>
<a name="line-3"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>op</span>
<a name="line-4"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>sizeN</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_size</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_val_args</span><span class='hs-layout'>)</span>
<a name="line-5"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>sizeN</span> <span class='hs-varid'>op_size</span>
<a name="line-6"></a> <span class='hs-keyword'>where</span>
<a name="line-7"></a>   <span class='hs-varid'>op_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpCodeSize</span> <span class='hs-varid'>op</span>
<a name="line-8"></a>
<a name="line-9"></a>
<a name="line-10"></a><a name="buildSize"></a><span class='hs-definition'>buildSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span>
<a name="line-11"></a><span class='hs-definition'>buildSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>40</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>	<span class='hs-comment'>-- We really want to inline applications of build</span>
<a name="line-13"></a>	<span class='hs-comment'>-- build t (\cn -&gt; e) should cost only the cost of e (because build will be inlined later)</span>
<a name="line-14"></a>	<span class='hs-comment'>-- Indeed, we should add a result_discount becuause build is </span>
<a name="line-15"></a>	<span class='hs-comment'>-- very like a constructor.  We don't bother to check that the</span>
<a name="line-16"></a>	<span class='hs-comment'>-- build is saturated (it usually is).  The "-2" discounts for the \c n, </span>
<a name="line-17"></a>	<span class='hs-comment'>-- The "4" is rather arbitrary.</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="augmentSize"></a><span class='hs-definition'>augmentSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span>
<a name="line-20"></a><span class='hs-definition'>augmentSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>40</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>	<span class='hs-comment'>-- Ditto (augment t (\cn -&gt; e) ys) should cost only the cost of</span>
<a name="line-22"></a>	<span class='hs-comment'>-- e plus ys. The -2 accounts for the \cn </span>
<a name="line-23"></a>
<a name="line-24"></a><a name="lamScrutDiscount"></a><span class='hs-comment'>-- When we return a lambda, give a discount if it's used (applied)</span>
<a name="line-25"></a><span class='hs-definition'>lamScrutDiscount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-26"></a><span class='hs-definition'>lamScrutDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>vs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>vs</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-layout'>(</span><span class='hs-varid'>ufFunAppDiscount</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-definition'>lamScrutDiscount</span> <span class='hs-keyword'>_</span>      <span class='hs-conid'>TooBig</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
</pre>\end{code}

Note [addAltSize result discounts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When adding the size of alternatives, we *add* the result discounts
too, rather than take the *maximum*.  For a multi-branch case, this
gives a discount for each branch that returns a constructor, making us
keener to inline.  I did try using 'max' instead, but it makes nofib 
'rewrite' and 'puzzle' allocate significantly more, and didn't make
binary sizes shrink significantly either.

Note [Discounts and thresholds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Constants for discounts and thesholds are defined in main/DynFlags,
all of form ufXxxx.   They are:

ufCreationThreshold
     At a definition site, if the unfolding is bigger than this, we
     may discard it altogether

ufUseThreshold
     At a call site, if the unfolding, less discounts, is smaller than
     this, then it's small enough inline

ufKeenessFactor
     Factor by which the discounts are multiplied before 
     subtracting from size

ufDictDiscount
     The discount for each occurrence of a dictionary argument
     as an argument of a class method.  Should be pretty small
     else big functions may get inlined

ufFunAppDiscount
     Discount for a function argument that is applied.  Quite
     large, because if we inline we avoid the higher-order call.

ufDearOp
     The size of a foreign call or not-dupable PrimOp


Note [Function applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a function application (f a b)

  - If 'f' is an argument to the function being analysed, 
    and there's at least one value arg, record a FunAppDiscount for f

  - If the application if a PAP (arity > 2 in this example)
    record a *result* discount (because inlining
    with "extra" args in the call may mean that we now 
    get a saturated application)

Code for manipulating sizes

\begin{code}
<pre><a name="line-1"></a><a name="ExprSize"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-2"></a>	      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SizeIs</span> <span class='hs-conid'>FastInt</span>		<span class='hs-comment'>-- Size found</span>
<a name="line-3"></a>		       <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Arguments cased herein, and discount for each such</span>
<a name="line-4"></a>		       <span class='hs-conid'>FastInt</span>		<span class='hs-comment'>-- Size to subtract if result is scrutinised </span>
<a name="line-5"></a>					<span class='hs-comment'>-- by a case expression</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TooBig</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"TooBig"</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>iBox</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>iBox</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="mkSizeIs"></a><span class='hs-comment'>-- subtract the discount before deciding whether to bale out. eg. we</span>
<a name="line-12"></a><span class='hs-comment'>-- want to inline a large constructor application into a selector:</span>
<a name="line-13"></a><span class='hs-comment'>--  	tup = (a_1, ..., a_99)</span>
<a name="line-14"></a><span class='hs-comment'>--  	x = case tup of ...</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-definition'>mkSizeIs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-17"></a><span class='hs-definition'>mkSizeIs</span> <span class='hs-varid'>max</span> <span class='hs-varid'>n</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>-#</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;#</span> <span class='hs-varid'>max</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-18"></a>		    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>d</span>
<a name="line-19"></a> 
<a name="line-20"></a><a name="maxSize"></a><span class='hs-definition'>maxSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-21"></a><span class='hs-definition'>maxSize</span> <span class='hs-conid'>TooBig</span>         <span class='hs-keyword'>_</span> 				  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-22"></a><span class='hs-definition'>maxSize</span> <span class='hs-keyword'>_</span>              <span class='hs-conid'>TooBig</span>				  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TooBig</span>
<a name="line-23"></a><span class='hs-definition'>maxSize</span> <span class='hs-varid'>s1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SizeIs</span> <span class='hs-varid'>n2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>&gt;#</span> <span class='hs-varid'>n2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span>
<a name="line-24"></a>					      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="sizeZero"></a><span class='hs-definition'>sizeZero</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprSize</span>
<a name="line-27"></a><a name="sizeN"></a><span class='hs-definition'>sizeN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprSize</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>sizeZero</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-definition'>sizeN</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SizeIs</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ILIT</span><span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[considerUnfolding]{Given all the info, do (not) do the unfolding}
%*									*
%************************************************************************

We use 'couldBeSmallEnoughToInline' to avoid exporting inlinings that
we ``couldn't possibly use'' on the other side.  Can be overridden w/
flaggery.  Just the same as smallEnoughToInline, except that it has no
actual arguments.

\begin{code}
<pre><a name="line-1"></a><a name="couldBeSmallEnoughToInline"></a><span class='hs-definition'>couldBeSmallEnoughToInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>couldBeSmallEnoughToInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>threshold</span> <span class='hs-varid'>rhs</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sizeExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>iUnbox</span> <span class='hs-varid'>threshold</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>       <span class='hs-conid'>TooBig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-5"></a>       <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>rhs</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="smallEnoughToInline"></a><span class='hs-comment'>----------------</span>
<a name="line-10"></a><span class='hs-definition'>smallEnoughToInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-definition'>smallEnoughToInline</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span><span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span><span class='hs-varid'>ug_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ufUseThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-13"></a><span class='hs-definition'>smallEnoughToInline</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="certainlyWillInline"></a><span class='hs-comment'>----------------</span>
<a name="line-17"></a><span class='hs-definition'>certainlyWillInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-18"></a>  <span class='hs-comment'>-- Sees if the unfolding is pretty certain to inline	</span>
<a name="line-19"></a><span class='hs-definition'>certainlyWillInline</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_vals</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>guidance</span> <span class='hs-keyword'>of</span>
<a name="line-21"></a>      <span class='hs-conid'>UnfNever</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-22"></a>      <span class='hs-conid'>UnfWhen</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-23"></a>      <span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span><span class='hs-layout'>}</span> 
<a name="line-24"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n_vals</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>     <span class='hs-comment'>-- See Note [certainlyWillInline: be caseful of thunks]</span>
<a name="line-25"></a>                    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>size</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_vals</span> <span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ufUseThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>certainlyWillInline</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [certainlyWillInline: be caseful of thunks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Don't claim that thunks will certainly inline, because that risks work
duplication.  Even if the work duplication is not great (eg is_cheap
holds), it can make a big difference in an inner loop In Trac #5623 we
found that the WorkWrap phase thought that
       y = case x of F# v -> F# (v +# v)
was certainlyWillInline, so the addition got duplicated.  


%************************************************************************
%*									*
\subsection{callSiteInline}
%*									*
%************************************************************************

This is the key function.  It decides whether to inline a variable at a call site

callSiteInline is used at call sites, so it is a bit more generous.
It's a very important function that embodies lots of heuristics.
A non-WHNF can be inlined if it doesn't occur inside a lambda,
and occurs exactly once or 
    occurs once in each branch of a case and is small

If the thing is in WHNF, there's no danger of duplicating work, 
so we can inline if it occurs once, or is small

NOTE: we don't want to inline top-level functions that always diverge.
It just makes the code bigger.  Tt turns out that the convenient way to prevent
them inlining is to give them a NOINLINE pragma, which we do in 
StrictAnal.addStrictnessInfoToTopId

\begin{code}
<pre><a name="line-1"></a><a name="callSiteInline"></a><span class='hs-definition'>callSiteInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-2"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>			<span class='hs-comment'>-- The Id</span>
<a name="line-3"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>			<span class='hs-comment'>-- True &lt;=&gt; unfolding is active</span>
<a name="line-4"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>			<span class='hs-comment'>-- True if there are are no arguments at all (incl type args)</span>
<a name="line-5"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgSummary</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- One for each value arg; True if it is interesting</span>
<a name="line-6"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallCtxt</span>		<span class='hs-comment'>-- True &lt;=&gt; continuation is interesting</span>
<a name="line-7"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreExpr</span>	<span class='hs-comment'>-- Unfolding, if any</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ArgSummary</span> <span class='hs-keyword'>where</span>
<a name="line-10"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TrivArg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"TrivArg"</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NonTrivArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"NonTrivArg"</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ValueArg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ValueArg"</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="CallCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CallCtxt</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BoringCtxt</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RhsCtxt</span>             <span class='hs-comment'>-- Rhs of a let-binding; see Note [RHS of lets]</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DiscArgCtxt</span>         <span class='hs-comment'>-- Argument of a fuction with non-zero arg discount</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuleArgCtxt</span>		<span class='hs-comment'>-- We are somewhere in the argument of a function with rules</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ValAppCtxt</span> 	        <span class='hs-comment'>-- We're applied to at least one value arg</span>
<a name="line-21"></a>		        <span class='hs-comment'>-- This arises when we have ((f x |&gt; co) y)</span>
<a name="line-22"></a>		        <span class='hs-comment'>-- Then the (f x) has argument 'x' but in a ValAppCtxt</span>
<a name="line-23"></a>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseCtxt</span>	        <span class='hs-comment'>-- We're the scrutinee of a case</span>
<a name="line-25"></a>		        <span class='hs-comment'>-- that decomposes its scrutinee</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CallCtxt</span> <span class='hs-keyword'>where</span>
<a name="line-28"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CaseCtxt</span> 	  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CaseCtxt"</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ValAppCtxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ValAppCtxt"</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>BoringCtxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"BoringCtxt"</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RhsCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"RhsCtxt"</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>DiscArgCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"DiscArgCtxt"</span><span class='hs-layout'>)</span>
<a name="line-33"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RuleArgCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"RuleArgCtxt"</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-definition'>callSiteInline</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>active_unfolding</span> <span class='hs-varid'>lone_variable</span> <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idUnfolding</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span> 
<a name="line-37"></a>      <span class='hs-comment'>-- idUnfolding checks for loop-breakers, returning NoUnfolding</span>
<a name="line-38"></a>      <span class='hs-comment'>-- Things with an INLINE pragma may have an unfolding *and* </span>
<a name="line-39"></a>      <span class='hs-comment'>-- be a loop breaker  (maybe the knot is not yet untied)</span>
<a name="line-40"></a>	<span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf_template</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_is_top</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_top</span> 
<a name="line-41"></a>		      <span class='hs-layout'>,</span> <span class='hs-varid'>uf_is_work_free</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_wf</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uf_arity</span>
<a name="line-42"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_expandable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_exp</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>active_unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tryUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>lone_variable</span> 
<a name="line-44"></a>                                    <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span> <span class='hs-varid'>unf_template</span> <span class='hs-varid'>is_top</span> 
<a name="line-45"></a>                                    <span class='hs-varid'>is_wf</span> <span class='hs-varid'>is_exp</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varid'>guidance</span>
<a name="line-46"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_inlinings</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-varid'>dflags</span>
<a name="line-47"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"Inactive unfolding:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-48"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-49"></a>	<span class='hs-conid'>NoUnfolding</span> 	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span> 
<a name="line-50"></a>	<span class='hs-conid'>OtherCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> 	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span> 
<a name="line-51"></a>	<span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span> 	<span class='hs-comment'>-- Never unfold a DFun</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="tryUnfolding"></a><span class='hs-definition'>tryUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallCtxt</span>
<a name="line-54"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnfoldingGuidance</span>
<a name="line-55"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreExpr</span>	
<a name="line-56"></a><span class='hs-definition'>tryUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>lone_variable</span> 
<a name="line-57"></a>             <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span> <span class='hs-varid'>unf_template</span> <span class='hs-varid'>is_top</span> 
<a name="line-58"></a>             <span class='hs-varid'>is_wf</span> <span class='hs-varid'>is_exp</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varid'>guidance</span>
<a name="line-59"></a>			<span class='hs-comment'>-- uf_arity will typically be equal to (idArity id), </span>
<a name="line-60"></a>			<span class='hs-comment'>-- but may be less for InlineRules</span>
<a name="line-61"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_inlinings</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-varid'>dflags</span>
<a name="line-62"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-layout'>(</span><span class='hs-str'>"Considering inlining: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showSDocDump</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-63"></a>		 <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"arg infos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_infos</span><span class='hs-layout'>,</span>
<a name="line-64"></a>			<span class='hs-varid'>text</span> <span class='hs-str'>"uf arity"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>uf_arity</span><span class='hs-layout'>,</span>
<a name="line-65"></a>			<span class='hs-varid'>text</span> <span class='hs-str'>"interesting continuation"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cont_info</span><span class='hs-layout'>,</span>
<a name="line-66"></a>			<span class='hs-varid'>text</span> <span class='hs-str'>"some_benefit"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>some_benefit</span><span class='hs-layout'>,</span>
<a name="line-67"></a>                        <span class='hs-varid'>text</span> <span class='hs-str'>"is exp:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>is_exp</span><span class='hs-layout'>,</span>
<a name="line-68"></a>                        <span class='hs-varid'>text</span> <span class='hs-str'>"is work-free:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>is_wf</span><span class='hs-layout'>,</span>
<a name="line-69"></a>			<span class='hs-varid'>text</span> <span class='hs-str'>"guidance"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>guidance</span><span class='hs-layout'>,</span>
<a name="line-70"></a>			<span class='hs-varid'>extra_doc</span><span class='hs-layout'>,</span>
<a name="line-71"></a>			<span class='hs-varid'>text</span> <span class='hs-str'>"ANSWER ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>yes_or_no</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"YES"</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NO"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-72"></a>	         <span class='hs-varid'>result</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>result</span>
<a name="line-74"></a>
<a name="line-75"></a>  <span class='hs-keyword'>where</span>
<a name="line-76"></a>    <span class='hs-varid'>n_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_infos</span>
<a name="line-77"></a>    <span class='hs-varid'>saturated</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>uf_arity</span>
<a name="line-78"></a>    <span class='hs-varid'>cont_info'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValAppCtxt</span>
<a name="line-79"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cont_info</span>
<a name="line-80"></a>
<a name="line-81"></a>    <span class='hs-varid'>result</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>yes_or_no</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>unf_template</span>
<a name="line-82"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-varid'>interesting_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>nonTriv</span> <span class='hs-varid'>arg_infos</span> 
<a name="line-85"></a>    	<span class='hs-comment'>-- NB: (any nonTriv arg_infos) looks at the</span>
<a name="line-86"></a>    	<span class='hs-comment'>-- over-saturated args too which is "wrong"; </span>
<a name="line-87"></a>    	<span class='hs-comment'>-- but if over-saturated we inline anyway.</span>
<a name="line-88"></a>
<a name="line-89"></a>           <span class='hs-comment'>-- some_benefit is used when the RHS is small enough</span>
<a name="line-90"></a>           <span class='hs-comment'>-- and the call has enough (or too many) value</span>
<a name="line-91"></a>           <span class='hs-comment'>-- arguments (ie n_val_args &gt;= arity). But there must</span>
<a name="line-92"></a>           <span class='hs-comment'>-- be *something* interesting about some argument, or the</span>
<a name="line-93"></a>           <span class='hs-comment'>-- result context, to make it worth inlining</span>
<a name="line-94"></a>    <span class='hs-varid'>some_benefit</span> 
<a name="line-95"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>saturated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>interesting_args</span>	<span class='hs-comment'>-- Under-saturated</span>
<a name="line-96"></a>    	   	      		     	<span class='hs-comment'>-- Note [Unsaturated applications]</span>
<a name="line-97"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>interesting_args</span>	<span class='hs-comment'>-- Saturated or over-saturated</span>
<a name="line-98"></a>                  <span class='hs-varop'>||</span> <span class='hs-varid'>interesting_call</span>
<a name="line-99"></a>
<a name="line-100"></a>    <span class='hs-varid'>interesting_call</span> 
<a name="line-101"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cont_info'</span> <span class='hs-keyword'>of</span>
<a name="line-102"></a>          <span class='hs-conid'>CaseCtxt</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>lone_variable</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_wf</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Note [Lone variables]</span>
<a name="line-103"></a>          <span class='hs-conid'>ValAppCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>			      <span class='hs-comment'>-- Note [Cast then apply]</span>
<a name="line-104"></a>          <span class='hs-conid'>RuleArgCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>  <span class='hs-comment'>-- See Note [Unfold info lazy contexts]</span>
<a name="line-105"></a>          <span class='hs-conid'>DiscArgCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>  <span class='hs-comment'>--</span>
<a name="line-106"></a>          <span class='hs-conid'>RhsCtxt</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>  <span class='hs-comment'>--</span>
<a name="line-107"></a>          <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_top</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>   <span class='hs-comment'>-- Note [Nested functions]</span>
<a name="line-108"></a>                                                      <span class='hs-comment'>-- Note [Inlining in ArgCtxt]</span>
<a name="line-109"></a>
<a name="line-110"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>yes_or_no</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_doc</span><span class='hs-layout'>)</span>
<a name="line-111"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>guidance</span> <span class='hs-keyword'>of</span>
<a name="line-112"></a>          <span class='hs-conid'>UnfNever</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a>          <span class='hs-conid'>UnfWhen</span> <span class='hs-varid'>unsat_ok</span> <span class='hs-varid'>boring_ok</span> 
<a name="line-115"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>enough_args</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>boring_ok</span> <span class='hs-varop'>||</span> <span class='hs-varid'>some_benefit</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>)</span>
<a name="line-116"></a>             <span class='hs-keyword'>where</span>      <span class='hs-comment'>-- See Note [INLINE for small functions (3)]</span>
<a name="line-117"></a>               <span class='hs-varid'>enough_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>saturated</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsat_ok</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>n_val_args</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-118"></a>
<a name="line-119"></a>          <span class='hs-conid'>UnfIfGoodArgs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ug_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_discounts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_discount</span><span class='hs-layout'>,</span> <span class='hs-varid'>ug_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-layout'>}</span>
<a name="line-120"></a>      	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-varid'>is_wf</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>some_benefit</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>small_enough</span>
<a name="line-121"></a>                <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"discounted size ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>discounted_size</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-122"></a>    	     <span class='hs-keyword'>where</span>
<a name="line-123"></a>    	       <span class='hs-varid'>discounted_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>size</span> <span class='hs-comment'>-</span> <span class='hs-varid'>discount</span>
<a name="line-124"></a>    	       <span class='hs-varid'>small_enough</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discounted_size</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ufUseThreshold</span> <span class='hs-varid'>dflags</span>
<a name="line-125"></a>    	       <span class='hs-varid'>discount</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>computeDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varid'>arg_discounts</span> 
<a name="line-126"></a>    	         		          <span class='hs-varid'>res_discount</span> <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info'</span>
</pre>\end{code}

Note [Unfold into lazy contexts], Note [RHS of lets]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the call is the argument of a function with a RULE, or the RHS of a let,
we are a little bit keener to inline.  For example
     f y = (y,y,y)
     g y = let x = f y in ...(case x of (a,b,c) -> ...) ...
We'd inline 'f' if the call was in a case context, and it kind-of-is,
only we can't see it.  Also
     x = f v
could be expensive whereas
     x = case v of (a,b) -> a
is patently cheap and may allow more eta expansion.
So we treat the RHS of a let as not-totally-boring.

Note [Unsaturated applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When a call is not saturated, we *still* inline if one of the
arguments has interesting structure.  That's sometimes very important.
A good example is the Ord instance for Bool in Base:

 Rec {
    $fOrdBool =GHC.Classes.D:Ord
        	 @ Bool
      		 ...
      		 $cmin_ajX

    $cmin_ajX [Occ=LoopBreaker] :: Bool -> Bool -> Bool
    $cmin_ajX = GHC.Classes.$dmmin @ Bool $fOrdBool
  }

But the defn of GHC.Classes.$dmmin is:

  $dmmin :: forall a. GHC.Classes.Ord a => a -> a -> a
    {- Arity: 3, HasNoCafRefs, Strictness: SLL,
       Unfolding: (\ @ a $dOrd :: GHC.Classes.Ord a x :: a y :: a ->
                   case @ a GHC.Classes.<= @ a $dOrd x y of wild {
                     GHC.Types.False -> y GHC.Types.True -> x }) -}

We *really* want to inline $dmmin, even though it has arity 3, in
order to unravel the recursion.


Note [Things to watch]
~~~~~~~~~~~~~~~~~~~~~~
*   { y = I# 3; x = y `cast` co; ...case (x `cast` co) of ... }
    Assume x is exported, so not inlined unconditionally.
    Then we want x to inline unconditionally; no reason for it 
    not to, and doing so avoids an indirection.

*   { x = I# 3; ....f x.... }
    Make sure that x does not inline unconditionally!  
    Lest we get extra allocation.

Note [Inlining an InlineRule]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An InlineRules is used for
  (a) programmer INLINE pragmas
  (b) inlinings from worker/wrapper

For (a) the RHS may be large, and our contract is that we *only* inline
when the function is applied to all the arguments on the LHS of the
source-code defn.  (The uf_arity in the rule.)

However for worker/wrapper it may be worth inlining even if the 
arity is not satisfied (as we do in the CoreUnfolding case) so we don't
require saturation.


Note [Nested functions]
~~~~~~~~~~~~~~~~~~~~~~~
If a function has a nested defn we also record some-benefit, on the
grounds that we are often able to eliminate the binding, and hence the
allocation, for the function altogether; this is good for join points.
But this only makes sense for *functions*; inlining a constructor
doesn't help allocation unless the result is scrutinised.  UNLESS the
constructor occurs just once, albeit possibly in multiple case
branches.  Then inlining it doesn't increase allocation, but it does
increase the chance that the constructor won't be allocated at all in
the branches that don't use it.

Note [Cast then apply]
~~~~~~~~~~~~~~~~~~~~~~
Consider
   myIndex = __inline_me ( (/\a. <blah>) |> co )
   co :: (forall a. a -> a) ~ (forall a. T a)
     ... /\a.\x. case ((myIndex a) |> sym co) x of { ... } ...

We need to inline myIndex to unravel this; but the actual call (myIndex a) has
no value arguments.  The ValAppCtxt gives it enough incentive to inline.

Note [Inlining in ArgCtxt]
~~~~~~~~~~~~~~~~~~~~~~~~~~
The condition (arity > 0) here is very important, because otherwise
we end up inlining top-level stuff into useless places; eg
   x = I# 3#
   f = \y.  g x
This can make a very big difference: it adds 16% to nofib 'integer' allocs,
and 20% to 'power'.

At one stage I replaced this condition by 'True' (leading to the above 
slow-down).  The motivation was test eyeball/inline1.hs; but that seems
to work ok now.

NOTE: arguably, we should inline in ArgCtxt only if the result of the
call is at least CONLIKE.  At least for the cases where we use ArgCtxt
for the RHS of a 'let', we only profit from the inlining if we get a 
CONLIKE thing (modulo lets).

Note [Lone variables]	See also Note [Interaction of exprIsWorkFree and lone variables]
~~~~~~~~~~~~~~~~~~~~~   which appears below
The "lone-variable" case is important.  I spent ages messing about
with unsatisfactory varaints, but this is nice.  The idea is that if a
variable appears all alone

	as an arg of lazy fn, or rhs	BoringCtxt
	as scrutinee of a case		CaseCtxt
	as arg of a fn			ArgCtxt
AND
	it is bound to a cheap expression

then we should not inline it (unless there is some other reason,
e.g. is is the sole occurrence).  That is what is happening at 
the use of 'lone_variable' in 'interesting_call'.

Why?  At least in the case-scrutinee situation, turning
	let x = (a,b) in case x of y -> ...
into
	let x = (a,b) in case (a,b) of y -> ...
and thence to 
	let x = (a,b) in let y = (a,b) in ...
is bad if the binding for x will remain.

Another example: I discovered that strings
were getting inlined straight back into applications of 'error'
because the latter is strict.
	s = "foo"
	f = \x -> ...(error s)...

Fundamentally such contexts should not encourage inlining because the
context can ``see'' the unfolding of the variable (e.g. case or a
RULE) so there's no gain.  If the thing is bound to a value.

However, watch out:

 * Consider this:
	foo = _inline_ (\n. [n])
	bar = _inline_ (foo 20)
	baz = \n. case bar of { (m:_) -> m + n }
   Here we really want to inline 'bar' so that we can inline 'foo'
   and the whole thing unravels as it should obviously do.  This is 
   important: in the NDP project, 'bar' generates a closure data
   structure rather than a list. 

   So the non-inlining of lone_variables should only apply if the
   unfolding is regarded as cheap; because that is when exprIsConApp_maybe
   looks through the unfolding.  Hence the "&& is_wf" in the
   InlineRule branch.

 * Even a type application or coercion isn't a lone variable.
   Consider
	case $fMonadST @ RealWorld of { :DMonad a b c -> c }
   We had better inline that sucker!  The case won't see through it.

   For now, I'm treating treating a variable applied to types 
   in a *lazy* context "lone". The motivating example was
	f = /\a. \x. BIG
	g = /\a. \y.  h (f a)
   There's no advantage in inlining f here, and perhaps
   a significant disadvantage.  Hence some_val_args in the Stop case

Note [Interaction of exprIsWorkFree and lone variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The lone-variable test says "don't inline if a case expression
scrutines a lone variable whose unfolding is cheap".  It's very 
important that, under these circumstances, exprIsConApp_maybe
can spot a constructor application. So, for example, we don't
consider
	let x = e in (x,x)
to be cheap, and that's good because exprIsConApp_maybe doesn't
think that expression is a constructor application.

In the 'not (lone_variable && is_wf)' test, I used to test is_value
rather than is_wf, which was utterly wrong, because the above
expression responds True to exprIsHNF, which is what sets is_value.

This kind of thing can occur if you have

	{-# INLINE foo #-}
	foo = let x = e in (x,x)

which Roman did.

\begin{code}
<pre><a name="line-1"></a><a name="computeDiscount"></a><span class='hs-definition'>computeDiscount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgSummary</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallCtxt</span>
<a name="line-2"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-3"></a><span class='hs-definition'>computeDiscount</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varid'>arg_discounts</span> <span class='hs-varid'>res_discount</span> <span class='hs-varid'>arg_infos</span> <span class='hs-varid'>cont_info</span>
<a name="line-4"></a> 	<span class='hs-comment'>-- We multiple the raw discounts (args_discount and result_discount)</span>
<a name="line-5"></a>	<span class='hs-comment'>-- ty opt_UnfoldingKeenessFactor because the former have to do with</span>
<a name="line-6"></a>	<span class='hs-comment'>--  *size* whereas the discounts imply that there's some extra </span>
<a name="line-7"></a>	<span class='hs-comment'>--  *efficiency* to be gained (e.g. beta reductions, case reductions) </span>
<a name="line-8"></a>	<span class='hs-comment'>-- by inlining.</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span>          <span class='hs-comment'>-- Discount of 1 because the result replaces the call</span>
<a name="line-11"></a>		<span class='hs-comment'>-- so we count 1 for the function itself</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-varop'>+</span> <span class='hs-num'>10</span> <span class='hs-varop'>*</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>uf_arity</span> <span class='hs-varid'>arg_infos</span><span class='hs-layout'>)</span>
<a name="line-14"></a>      	       <span class='hs-comment'>-- Discount of (un-scaled) 1 for each arg supplied, </span>
<a name="line-15"></a>   	       <span class='hs-comment'>-- because the result replaces the call</span>
<a name="line-16"></a>
<a name="line-17"></a>    <span class='hs-varop'>+</span> <span class='hs-varid'>round</span> <span class='hs-layout'>(</span><span class='hs-varid'>ufKeenessFactor</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>*</span>
<a name="line-18"></a>	     <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_discount</span> <span class='hs-varop'>+</span> <span class='hs-varid'>res_discount'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>arg_discount</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_arg_discount</span> <span class='hs-varid'>arg_discounts</span> <span class='hs-varid'>arg_infos</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-varid'>mk_arg_discount</span> <span class='hs-keyword'>_</span> 	     <span class='hs-conid'>TrivArg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> 
<a name="line-23"></a>    <span class='hs-varid'>mk_arg_discount</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>NonTrivArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span>
<a name="line-24"></a>    <span class='hs-varid'>mk_arg_discount</span> <span class='hs-varid'>discount</span> <span class='hs-conid'>ValueArg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discount</span> 
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>res_discount'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cont_info</span> <span class='hs-keyword'>of</span>
<a name="line-27"></a>			<span class='hs-conid'>BoringCtxt</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-28"></a>			<span class='hs-conid'>CaseCtxt</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res_discount</span>  <span class='hs-comment'>-- Presumably a constructor</span>
<a name="line-29"></a>			<span class='hs-conid'>ValAppCtxt</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res_discount</span>  <span class='hs-comment'>-- Presumably a function</span>
<a name="line-30"></a>			<span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>40</span> <span class='hs-varop'>`min`</span> <span class='hs-varid'>res_discount</span>
<a name="line-31"></a>                <span class='hs-comment'>-- ToDo: this 40 `min` res_dicount doesn't seem right</span>
<a name="line-32"></a>                <span class='hs-comment'>--   for DiscArgCtxt it shouldn't matter because the function will</span>
<a name="line-33"></a>                <span class='hs-comment'>--    get the arg discount for any non-triv arg</span>
<a name="line-34"></a>                <span class='hs-comment'>--   for RuleArgCtxt we do want to be keener to inline; but not only</span>
<a name="line-35"></a>                <span class='hs-comment'>--    constructor results</span>
<a name="line-36"></a>                <span class='hs-comment'>--   for RhsCtxt I suppose that exposing a data con is good in general</span>
<a name="line-37"></a>                <span class='hs-comment'>--   And 40 seems very arbitrary</span>
<a name="line-38"></a>                <span class='hs-comment'>--</span>
<a name="line-39"></a>		<span class='hs-comment'>-- res_discount can be very large when a function returns</span>
<a name="line-40"></a>		<span class='hs-comment'>-- constructors; but we only want to invoke that large discount</span>
<a name="line-41"></a>		<span class='hs-comment'>-- when there's a case continuation.</span>
<a name="line-42"></a>		<span class='hs-comment'>-- Otherwise we, rather arbitrarily, threshold it.  Yuk.</span>
<a name="line-43"></a>		<span class='hs-comment'>-- But we want to aovid inlining large functions that return </span>
<a name="line-44"></a>		<span class='hs-comment'>-- constructors into contexts that are simply "interesting"</span>
</pre>\end{code}

%************************************************************************
%*									*
	Interesting arguments
%*									*
%************************************************************************

Note [Interesting arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An argument is interesting if it deserves a discount for unfoldings
with a discount in that argument position.  The idea is to avoid
unfolding a function that is applied only to variables that have no
unfolding (i.e. they are probably lambda bound): f x y z There is
little point in inlining f here.

Generally, *values* (like (C a b) and (\x.e)) deserve discounts.  But
we must look through lets, eg (let x = e in C a b), because the let will
float, exposing the value, if we inline.  That makes it different to
exprIsHNF.

Before 2009 we said it was interesting if the argument had *any* structure
at all; i.e. (hasSomeUnfolding v).  But does too much inlining; see Trac #3016.

But we don't regard (f x y) as interesting, unless f is unsaturated.
If it's saturated and f hasn't inlined, then it's probably not going
to now!

Note [Conlike is interesting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
	f d = ...((*) d x y)...
	... f (df d')...
where df is con-like. Then we'd really like to inline 'f' so that the
rule for (*) (df d) can fire.  To do this 
  a) we give a discount for being an argument of a class-op (eg (*) d)
  b) we say that a con-like argument (eg (df d)) is interesting

\begin{code}
<pre><a name="line-1"></a><a name="ArgSummary"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArgSummary</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TrivArg</span>	<span class='hs-comment'>-- Nothing interesting</span>
<a name="line-2"></a>     		<span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonTrivArg</span>	<span class='hs-comment'>-- Arg has structure</span>
<a name="line-3"></a>		<span class='hs-keyglyph'>|</span> <span class='hs-conid'>ValueArg</span>	<span class='hs-comment'>-- Arg is a con-app or PAP</span>
<a name="line-4"></a>		  		<span class='hs-comment'>-- ..or con-like. Note [Conlike is interesting]</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="interestingArg"></a><span class='hs-definition'>interestingArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgSummary</span>
<a name="line-7"></a><span class='hs-comment'>-- See Note [Interesting arguments]</span>
<a name="line-8"></a><span class='hs-definition'>interestingArg</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-num'>0</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-comment'>-- n is # value args to which the expression is applied</span>
<a name="line-11"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>   	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValueArg</span>
<a name="line-12"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>  <span class='hs-varid'>n</span>
<a name="line-13"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConLikeId</span> <span class='hs-varid'>v</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValueArg</span>	<span class='hs-comment'>-- Experimenting with 'conlike' rather that</span>
<a name="line-14"></a>       	 	     	     		<span class='hs-comment'>--    data constructors here</span>
<a name="line-15"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValueArg</span>	<span class='hs-comment'>-- Catches (eg) primops with arity but no unfolding</span>
<a name="line-16"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>	           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonTrivArg</span>	<span class='hs-comment'>-- Saturated or unknown call</span>
<a name="line-17"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>conlike_unfolding</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValueArg</span>	<span class='hs-comment'>-- n==0; look for an interesting unfolding</span>
<a name="line-18"></a>                                        <span class='hs-comment'>-- See Note [Conlike is interesting]</span>
<a name="line-19"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TrivArg</span>	<span class='hs-comment'>-- n==0, no useful unfolding</span>
<a name="line-20"></a>       <span class='hs-keyword'>where</span>
<a name="line-21"></a>         <span class='hs-varid'>conlike_unfolding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isConLikeUnfolding</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnfolding</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TrivArg</span>
<a name="line-24"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TrivArg</span>
<a name="line-25"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>n</span>
<a name="line-26"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>n</span>
<a name="line-27"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fn</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-28"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>      <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span> <span class='hs-varid'>n</span>
<a name="line-29"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 	 <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-varid'>n</span>
<a name="line-30"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>  	 <span class='hs-varid'>n</span> 
<a name="line-31"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-varid'>n</span>
<a name="line-32"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span><span class='hs-varop'>&gt;</span><span class='hs-num'>0</span>	 	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-33"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValueArg</span>
<a name="line-34"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>  	 <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>ValueArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ValueArg</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NonTrivArg</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  	 <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonTrivArg</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="nonTriv"></a><span class='hs-definition'>nonTriv</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>ArgSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-38"></a><span class='hs-definition'>nonTriv</span> <span class='hs-conid'>TrivArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-39"></a><span class='hs-definition'>nonTriv</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
</pre>\end{code}
</body>
</html>
