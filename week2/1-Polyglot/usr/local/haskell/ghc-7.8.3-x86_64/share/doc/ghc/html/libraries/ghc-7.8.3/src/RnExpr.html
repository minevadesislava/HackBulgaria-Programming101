<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>rename/RnExpr.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[RnExpr]{Renaming of expressions}

Basically dependency analysis.

Handles @Match@, @GRHSs@, @HsExpr@, and @Qualifier@ datatypes.  In
general, all of these functions return a renamed thing, and a set of
free variables.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RnExpr</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-varid'>rnLExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnStmts</span>
<a name="line-3"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>runQuasiQuoteExpr</span> <span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnBinds</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>rnLocalBindsAndThen</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLocalValBindsRHS</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                   <span class='hs-varid'>rnMatchGroup</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnGRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>makeMiniFixityEnv</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>getModule</span> <span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnSplice</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>rnBracket</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnSpliceExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkThLocalName</span> <span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnTypes</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnPat</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>FixityDirection</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>removeDups</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>nilDataConName</span> <span class='hs-layout'>)</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="thenM"></a><span class='hs-comment'>-- XXX</span>
<a name="line-2"></a><span class='hs-definition'>thenM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varid'>c</span>
<a name="line-3"></a><span class='hs-definition'>thenM</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&gt;&gt;=</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="thenM_"></a><span class='hs-definition'>thenM_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varid'>c</span>
<a name="line-6"></a><span class='hs-definition'>thenM_</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>&gt;&gt;</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{Expressions}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnExprs"></a><span class='hs-definition'>rnExprs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>rnExprs</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnExprs'</span> <span class='hs-varid'>ls</span> <span class='hs-varid'>emptyUniqSet</span>
<a name="line-3"></a> <span class='hs-keyword'>where</span>
<a name="line-4"></a>  <span class='hs-varid'>rnExprs'</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-varid'>rnExprs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-conop'>:</span><span class='hs-varid'>exprs</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-6"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>               <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-comment'>-- Now we do a "seq" on the free vars because typically it's small</span>
<a name="line-9"></a>        <span class='hs-comment'>-- or empty, especially in very long lists of constants</span>
<a name="line-10"></a>    <span class='hs-keyword'>let</span>
<a name="line-11"></a>        <span class='hs-varid'>acc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvExpr</span>
<a name="line-12"></a>    <span class='hs-keyword'>in</span>
<a name="line-13"></a>    <span class='hs-varid'>acc'</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>rnExprs'</span> <span class='hs-varid'>exprs</span> <span class='hs-varid'>acc'</span> <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExprs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-14"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-conop'>:</span><span class='hs-varid'>exprs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExprs</span><span class='hs-layout'>)</span>
</pre>\end{code}

Variables. We look up the variable and return the resulting name.

\begin{code}
<pre><a name="line-1"></a><a name="rnLExpr"></a><span class='hs-definition'>rnLExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>rnLExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>rnExpr</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="rnExpr"></a><span class='hs-definition'>rnExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="finishHsVar"></a><span class='hs-definition'>finishHsVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-comment'>-- Separated from rnExpr because it's also used</span>
<a name="line-8"></a><span class='hs-comment'>-- when renaming infix expressions</span>
<a name="line-9"></a><span class='hs-comment'>-- See Note [Adding the implicit parameter to 'assert']</span>
<a name="line-10"></a><span class='hs-definition'>finishHsVar</span> <span class='hs-varid'>name</span>
<a name="line-11"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-12"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-13"></a>        <span class='hs-varid'>checkThLocalName</span> <span class='hs-varid'>name</span>
<a name="line-14"></a>
<a name="line-15"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>ignore_asserts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_IgnoreAsserts</span>
<a name="line-16"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ignore_asserts</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>assertIdKey</span><span class='hs-layout'>)</span>
<a name="line-17"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-18"></a>        <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkAssertErrorExpr</span>
<a name="line-19"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOccRn_maybe</span> <span class='hs-varid'>v</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_name</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-24"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>opt_TypeHoles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnTypedHoles</span>
<a name="line-25"></a>                         <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_TypeHoles</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>startsWithUnderscore</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-26"></a>                           <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnboundVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reportUnboundName</span> <span class='hs-varid'>v</span><span class='hs-layout'>;</span> <span class='hs-varid'>finishHsVar</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-28"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span>
<a name="line-29"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nilDataConName</span> <span class='hs-comment'>-- Treat [] as an ExplicitList, so that</span>
<a name="line-30"></a>                                       <span class='hs-comment'>-- OverloadedLists works correctly</span>
<a name="line-31"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-34"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>finishHsVar</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsString</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-41"></a>         <span class='hs-varid'>opt_OverloadedStrings</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_OverloadedStrings</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_OverloadedStrings</span> <span class='hs-keyword'>then</span>
<a name="line-43"></a>            <span class='hs-varid'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsIsString</span> <span class='hs-varid'>s</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>         <span class='hs-keyword'>else</span> <span class='hs-comment'>-- Same as below</span>
<a name="line-45"></a>            <span class='hs-varid'>rnLit</span> <span class='hs-varid'>lit</span>           <span class='hs-varop'>`thenM_`</span>
<a name="line-46"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-47"></a>       <span class='hs-layout'>}</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLit</span> <span class='hs-varid'>lit</span>           <span class='hs-varop'>`thenM_`</span>
<a name="line-51"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOverLit</span> <span class='hs-varid'>lit</span>               <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>lit'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-55"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>fun</span>         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvFun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-59"></a>    <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arg</span>         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-60"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvFun</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>op_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op_rdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e1</span>
<a name="line-64"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>e2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e2</span>
<a name="line-65"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>op_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>op_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupOccRn</span> <span class='hs-varid'>op_rdr</span><span class='hs-layout'>)</span>
<a name="line-66"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_op</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>finishHsVar</span> <span class='hs-varid'>op_name</span>
<a name="line-67"></a>                <span class='hs-comment'>-- NB: op' is usually just a variable, but might be</span>
<a name="line-68"></a>                <span class='hs-comment'>--     an applicatoin (assert "Foo.hs:47")</span>
<a name="line-69"></a>        <span class='hs-comment'>-- Deal with fixity</span>
<a name="line-70"></a>        <span class='hs-comment'>-- When renaming code synthesised from "deriving" declarations</span>
<a name="line-71"></a>        <span class='hs-comment'>-- we used to avoid fixity stuff, but we can't easily tell any</span>
<a name="line-72"></a>        <span class='hs-comment'>-- more, so I've removed the test.  Adding HsPars in TcGenDeriv</span>
<a name="line-73"></a>        <span class='hs-comment'>-- should prevent bad things happening.</span>
<a name="line-74"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fixity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>op_name</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>final_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpAppRn</span> <span class='hs-varid'>e1'</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>op_loc</span> <span class='hs-varid'>op'</span><span class='hs-layout'>)</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>e2'</span>
<a name="line-76"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_e</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_e2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-77"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other_op</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Infix application with a non-variable operator:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-79"></a>                        <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other_op</span><span class='hs-layout'>)</span>
<a name="line-80"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(Probably resulting from a Template Haskell splice)"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span>                   <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-84"></a>    <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>negateName</span> <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>neg_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_neg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-85"></a>    <span class='hs-varid'>mkNegAppRn</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>neg_name</span>      <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>final_e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-86"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_e</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_e</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_neg</span><span class='hs-layout'>)</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-89"></a><span class='hs-comment'>-- Template Haskell extensions</span>
<a name="line-90"></a><span class='hs-comment'>-- Don't ifdef-GHCI them because we want to fail gracefully</span>
<a name="line-91"></a><span class='hs-comment'>-- (not with an rnExpr crash) in a stage-1 compiler.</span>
<a name="line-92"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBracket</span> <span class='hs-varid'>br_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBracket</span> <span class='hs-varid'>e</span> <span class='hs-varid'>br_body</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnSpliceExpr</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>splice</span>
<a name="line-95"></a>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteE</span> <span class='hs-varid'>qq</span><span class='hs-layout'>)</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runQuasiQuoteExpr</span> <span class='hs-varid'>qq</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>lexpr'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-99"></a>    <span class='hs-comment'>-- Wrap the result of the quasi-quoter in parens so that we don't</span>
<a name="line-100"></a>    <span class='hs-comment'>-- lose the outermost location set by runQuasiQuote (#7918) </span>
<a name="line-101"></a>    <span class='hs-varid'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>lexpr'</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-104"></a><span class='hs-comment'>--      Sections</span>
<a name="line-105"></a><span class='hs-comment'>-- See Note [Parsing sections] in Parser.y.pp</span>
<a name="line-106"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>section'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>section</span>
<a name="line-108"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>section'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>section'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>section</span>
<a name="line-112"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>section'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span>
<a name="line-116"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sectionErr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>}</span>
<a name="line-120"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sectionErr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>rnSection</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-124"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>ann</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-126"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>ann</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>                <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-130"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>info</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-132"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>                <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-133"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>info</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>LambdaExpr</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>     <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-137"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span>
<a name="line-138"></a>
<a name="line-139"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_ms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-141"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_ms</span><span class='hs-layout'>)</span>
<a name="line-142"></a>
<a name="line-143"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>                                <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-145"></a>    <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>matches</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-146"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span>
<a name="line-147"></a>
<a name="line-148"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span>           <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-150"></a>    <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>                         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-151"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>binds'</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span>
<a name="line-152"></a>
<a name="line-153"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-155"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-156"></a>
<a name="line-157"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-varid'>exps</span><span class='hs-layout'>)</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>opt_OverloadedLists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_OverloadedLists</span>
<a name="line-159"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnExprs</span> <span class='hs-varid'>exps</span>
<a name="line-160"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_OverloadedLists</span>
<a name="line-161"></a>           <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-162"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>from_list_n_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>fromListNName</span>
<a name="line-163"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>from_list_n_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-164"></a>           <span class='hs-keyword'>else</span>
<a name="line-165"></a>            <span class='hs-varid'>return</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>exps</span><span class='hs-layout'>)</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnExprs</span> <span class='hs-varid'>exps</span>                        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-169"></a>    <span class='hs-varid'>return</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>exps'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span>
<a name="line-172"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTupleSection</span> <span class='hs-varid'>tup_args</span>
<a name="line-173"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTupSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tup_args</span><span class='hs-layout'>)</span>
<a name="line-174"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tup_args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>rnTupArg</span> <span class='hs-varid'>tup_args</span>
<a name="line-175"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args'</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-176"></a>  <span class='hs-keyword'>where</span>
<a name="line-177"></a>    <span class='hs-varid'>rnTupArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-178"></a>    <span class='hs-varid'>rnTupArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-179"></a>
<a name="line-180"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-varid'>con_id</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rbinds</span><span class='hs-layout'>)</span>
<a name="line-181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>conname</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocatedOccRn</span> <span class='hs-varid'>con_id</span>
<a name="line-182"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rbinds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvRbinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsRecBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFieldCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>conname</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rbinds</span>
<a name="line-183"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-varid'>conname</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-varid'>rbinds'</span><span class='hs-layout'>,</span>
<a name="line-184"></a>                  <span class='hs-varid'>fvRbinds</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>conname</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-185"></a>
<a name="line-186"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>rbinds</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-188"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rbinds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvRbinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsRecBinds</span> <span class='hs-conid'>HsRecFieldUpd</span> <span class='hs-varid'>rbinds</span>
<a name="line-189"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>rbinds'</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-190"></a>                  <span class='hs-varid'>fvExpr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvRbinds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-191"></a>
<a name="line-192"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span>
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvTy</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-conid'>ExprWithTySigCtx</span> <span class='hs-varid'>pty</span>
<a name="line-194"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindSigTyVarsFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsExplicitTvs</span> <span class='hs-varid'>pty'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-195"></a>                             <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-196"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>pty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvTy</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-197"></a>
<a name="line-198"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span>
<a name="line-199"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>p</span>
<a name="line-200"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>b1</span>
<a name="line-201"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>b2</span>
<a name="line-202"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_ite</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvITE</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIfThenElse</span>
<a name="line-203"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-varid'>mb_ite</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>b1'</span> <span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fvITE</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-206"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>alts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnGRHS</span> <span class='hs-conid'>IfAlt</span> <span class='hs-varid'>rnLExpr</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-207"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-208"></a>
<a name="line-209"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-210"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-conid'>HsTypeCtx</span> <span class='hs-varid'>a</span>       <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvT</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-211"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvT</span><span class='hs-layout'>)</span>
<a name="line-212"></a>
<a name="line-213"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-214"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>opt_OverloadedLists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_OverloadedLists</span>
<a name="line-215"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnArithSeq</span> <span class='hs-varid'>seq</span>
<a name="line-216"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_OverloadedLists</span>
<a name="line-217"></a>           <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-218"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>from_list_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>fromListName</span>
<a name="line-219"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>from_list_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-220"></a>           <span class='hs-keyword'>else</span>
<a name="line-221"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-222"></a>
<a name="line-223"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-224"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnArithSeq</span> <span class='hs-varid'>seq</span>       <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-225"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-varid'>new_seq</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
</pre>\end{code}

These three are pattern syntax appearing in expressions.
Since all the symbols are reservedops we can simply reject them.
We return a (bogus) EWildPat in each case.

\begin{code}
<pre><a name="line-1"></a><a name="rnExpr"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>EWildPat</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>holes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnTypedHoles</span>
<a name="line-2"></a>                            <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>holes</span>
<a name="line-3"></a>                                <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsHoleExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-4"></a>                                <span class='hs-keyword'>else</span> <span class='hs-varid'>patSynErr</span> <span class='hs-varid'>e</span>
<a name="line-5"></a>                            <span class='hs-layout'>}</span>
<a name="line-6"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EAsPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynErr</span> <span class='hs-varid'>e</span>
<a name="line-7"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EViewPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynErr</span> <span class='hs-varid'>e</span>
<a name="line-8"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ELazyPat</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynErr</span> <span class='hs-varid'>e</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Arrow notation
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnExpr"></a><span class='hs-definition'>rnExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newArrowScope</span> <span class='hs-varop'>$</span>
<a name="line-3"></a>    <span class='hs-varid'>rnPat</span> <span class='hs-conid'>ProcExpr</span> <span class='hs-varid'>pat</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4"></a>    <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>body</span>                <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvBody</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-5"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvBody</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>-- Ideally, these would be done in parsing, but to keep parsing simple, we do it here.</span>
<a name="line-8"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsArrApp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrowFail</span> <span class='hs-varid'>e</span>
<a name="line-9"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsArrForm</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arrowFail</span> <span class='hs-varid'>e</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>rnExpr</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnExpr: unexpected expression"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-12"></a>        <span class='hs-comment'>-- HsWrap</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="hsHoleExpr"></a><span class='hs-definition'>hsHoleExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span>
<a name="line-15"></a><span class='hs-definition'>hsHoleExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsUnboundVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRdrUnqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOcc</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="arrowFail"></a><span class='hs-definition'>arrowFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>arrowFail</span> <span class='hs-varid'>e</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Arrow command found where an expression was expected:"</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-21"></a>         <span class='hs-comment'>-- Return a place-holder hole, so that we can carry on</span>
<a name="line-22"></a>         <span class='hs-comment'>-- to report other errors</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsHoleExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="rnSection"></a><span class='hs-comment'>----------------------</span>
<a name="line-26"></a><span class='hs-comment'>-- See Note [Parsing sections] in Parser.y.pp</span>
<a name="line-27"></a><span class='hs-definition'>rnSection</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-definition'>rnSection</span> <span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>op</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkSectionPrec</span> <span class='hs-conid'>InfixR</span> <span class='hs-varid'>section</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>expr'</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>rnSection</span> <span class='hs-varid'>section</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkSectionPrec</span> <span class='hs-conid'>InfixL</span> <span class='hs-varid'>section</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>expr'</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>rnSection</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnSection"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Records
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnHsRecBinds"></a><span class='hs-definition'>rnHsRecBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsRecFieldContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsRecordBinds</span> <span class='hs-conid'>RdrName</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecordBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>rnHsRecBinds</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rec_binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_dotdot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dd</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>flds</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsRecFields1</span> <span class='hs-varid'>ctxt</span> <span class='hs-conid'>HsVar</span> <span class='hs-varid'>rec_binds</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>rn_field</span> <span class='hs-varid'>flds</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_dotdot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dd</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-7"></a>                 <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvss</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>rn_field</span> <span class='hs-varid'>fld</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsRecFieldArg</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span>
<a name="line-10"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Arrow commands
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnCmdArgs"></a><span class='hs-definition'>rnCmdArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>rnCmdArgs</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>rnCmdArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>arg</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-5"></a>    <span class='hs-varid'>rnCmdArgs</span> <span class='hs-varid'>args</span>      <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-6"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-conop'>:</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvArg</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArgs</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="rnCmdTop"></a><span class='hs-definition'>rnCmdTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>rnCmdTop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>rnCmdTop'</span>
<a name="line-10"></a> <span class='hs-keyword'>where</span>
<a name="line-11"></a>  <span class='hs-varid'>rnCmdTop'</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-12"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmd'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvCmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cmd_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arrAName</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeAName</span><span class='hs-layout'>,</span> <span class='hs-varid'>firstAName</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-14"></a>                          <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>cmd'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>        <span class='hs-comment'>-- Generate the rebindable syntax for the monad</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmd_names'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmd_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxNames</span> <span class='hs-varid'>cmd_names</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>cmd'</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmd_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>cmd_names'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-19"></a>                  <span class='hs-varid'>fvCmd</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>cmd_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="rnLCmd"></a><span class='hs-definition'>rnLCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-definition'>rnLCmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocFstM</span> <span class='hs-varid'>rnCmd</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="rnCmd"></a><span class='hs-definition'>rnCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsCmd</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-varid'>arrow</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ho</span> <span class='hs-varid'>rtl</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>select_arrow_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arrow</span><span class='hs-layout'>)</span>  <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrow'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArrow</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-28"></a>    <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arg</span>                         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-29"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-varid'>arrow'</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>ho</span> <span class='hs-varid'>rtl</span><span class='hs-layout'>,</span>
<a name="line-30"></a>             <span class='hs-varid'>fvArrow</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-varid'>select_arrow_scope</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ho</span> <span class='hs-keyword'>of</span>
<a name="line-33"></a>        <span class='hs-conid'>HsHigherOrderApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span>
<a name="line-34"></a>        <span class='hs-conid'>HsFirstOrderApp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>escapeArrowScope</span> <span class='hs-varid'>tc</span>
<a name="line-35"></a>        <span class='hs-comment'>-- See Note [Escaping the arrow scope] in TcRnTypes</span>
<a name="line-36"></a>        <span class='hs-comment'>-- Before renaming 'arrow', use the environment of the enclosing</span>
<a name="line-37"></a>        <span class='hs-comment'>-- proc for the (-&lt;) case.</span>
<a name="line-38"></a>        <span class='hs-comment'>-- Local bindings, inside the enclosing proc, are not in scope</span>
<a name="line-39"></a>        <span class='hs-comment'>-- inside 'arrow'.  In the higher-order case (-&lt;&lt;), they are.</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-comment'>-- infix form</span>
<a name="line-42"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>escapeArrowScope</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-44"></a>                        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_op</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-45"></a>    <span class='hs-keyword'>let</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op_name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>op'</span> <span class='hs-keyword'>in</span>
<a name="line-46"></a>    <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>arg1</span>       <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg1'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_arg1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-47"></a>    <span class='hs-varid'>rnCmdTop</span> <span class='hs-varid'>arg2</span>       <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg2'</span><span class='hs-layout'>,</span><span class='hs-varid'>fv_arg2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-comment'>-- Deal with fixity</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>op_name</span>              <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>fixity</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-52"></a>    <span class='hs-varid'>mkOpFormRn</span> <span class='hs-varid'>arg1'</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>arg2'</span>   <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>final_e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_e</span><span class='hs-layout'>,</span>
<a name="line-55"></a>              <span class='hs-varid'>fv_arg1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_op</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_arg2</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>cmds</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>escapeArrowScope</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>       <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvOp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-59"></a>    <span class='hs-varid'>rnCmdArgs</span> <span class='hs-varid'>cmds</span>                      <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmds'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvCmds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-60"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>cmds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvOp</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvCmds</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLCmd</span>  <span class='hs-varid'>fun</span>         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvFun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-64"></a>    <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>arg</span>         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-65"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvFun</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvArg</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>LambdaExpr</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>matches</span>     <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-69"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvMatch</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>e</span>
<a name="line-73"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_e</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>                        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-77"></a>    <span class='hs-varid'>rnMatchGroup</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-78"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>ms_fvs</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>p</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>b1</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>b2</span>
<a name="line-84"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_ite</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvITE</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupIfThenElse</span>
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-varid'>mb_ite</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>b1'</span> <span class='hs-varid'>b2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusFVs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fvITE</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvP</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvB2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span>           <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-89"></a>    <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>cmd</span>                         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmd'</span><span class='hs-layout'>,</span><span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-90"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-varid'>binds'</span> <span class='hs-varid'>cmd'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-definition'>rnCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdDo</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-conid'>ArrowExpr</span> <span class='hs-varid'>rnLCmd</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-94"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsCmdDo</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-definition'>rnCmd</span> <span class='hs-varid'>cmd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCast</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rnCmd"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="CmdNeeds"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-99"></a><a name="CmdNeeds"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CmdNeeds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FreeVars</span>        <span class='hs-comment'>-- Only inhabitants are</span>
<a name="line-100"></a>                                <span class='hs-comment'>--      appAName, choiceAName, loopAName</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="methodNamesLCmd"></a><span class='hs-comment'>-- find what methods the Cmd needs (loop, choice, apply)</span>
<a name="line-103"></a><span class='hs-definition'>methodNamesLCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmdNeeds</span>
<a name="line-104"></a><span class='hs-definition'>methodNamesLCmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesCmd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="methodNamesCmd"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsCmd</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmdNeeds</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-sel'>_arrow</span> <span class='hs-sel'>_arg</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsFirstOrderApp</span> <span class='hs-sel'>_rtl</span><span class='hs-layout'>)</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-110"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-sel'>_arrow</span> <span class='hs-sel'>_arg</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsHigherOrderApp</span> <span class='hs-sel'>_rtl</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>appAName</span>
<a name="line-112"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-113"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCast</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c</span>
<a name="line-116"></a>
<a name="line-117"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c2</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>choiceAName</span>
<a name="line-119"></a>
<a name="line-120"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c</span>
<a name="line-121"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdDo</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesStmts</span> <span class='hs-varid'>stmts</span>
<a name="line-122"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>c</span>
<a name="line-123"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>match</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesMatch</span> <span class='hs-varid'>match</span>
<a name="line-124"></a>
<a name="line-125"></a><span class='hs-definition'>methodNamesCmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesMatch</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>choiceAName</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-comment'>--methodNamesCmd _ = emptyFVs</span>
<a name="line-129"></a>   <span class='hs-comment'>-- Other forms can't occur in commands, but it's not convenient</span>
<a name="line-130"></a>   <span class='hs-comment'>-- to error here so we just do what's convenient.</span>
<a name="line-131"></a>   <span class='hs-comment'>-- The type checker will complain later</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="methodNamesMatch"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-134"></a><span class='hs-definition'>methodNamesMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-135"></a><span class='hs-definition'>methodNamesMatch</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-137"></a> <span class='hs-keyword'>where</span>
<a name="line-138"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesGRHSs</span> <span class='hs-varid'>grhss</span>
<a name="line-139"></a>
<a name="line-140"></a><a name="methodNamesGRHSs"></a><span class='hs-comment'>-------------------------------------------------</span>
<a name="line-141"></a><span class='hs-comment'>-- gaw 2004</span>
<a name="line-142"></a><span class='hs-definition'>methodNamesGRHSs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-143"></a><span class='hs-definition'>methodNamesGRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>methodNamesGRHS</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span>
<a name="line-144"></a>
<a name="line-145"></a><span class='hs-comment'>-------------------------------------------------</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="methodNamesGRHS"></a><span class='hs-definition'>methodNamesGRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmdNeeds</span>
<a name="line-148"></a><span class='hs-definition'>methodNamesGRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>rhs</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="methodNamesStmts"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-151"></a><span class='hs-definition'>methodNamesStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-152"></a><span class='hs-definition'>methodNamesStmts</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>methodNamesLStmt</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="methodNamesLStmt"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-155"></a><span class='hs-definition'>methodNamesLStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-156"></a><span class='hs-definition'>methodNamesLStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesStmt</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="methodNamesStmt"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-159"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-160"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-161"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cmd</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesLCmd</span> <span class='hs-varid'>cmd</span>
<a name="line-162"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>methodNamesStmts</span> <span class='hs-varid'>stmts</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>loopAName</span>
<a name="line-163"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-164"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-165"></a><span class='hs-definition'>methodNamesStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFVs</span>
<a name="line-166"></a>   <span class='hs-comment'>-- ParStmt and TransStmt can't occur in commands, but it's not convenient to error</span>
<a name="line-167"></a>   <span class='hs-comment'>-- here so we just do what's convenient</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Arithmetic sequences
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnArithSeq"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-3"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr</span>         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span>
<a name="line-7"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr1</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-8"></a>   <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-9"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>)</span>
<a name="line-12"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr1</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-13"></a>   <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-14"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>rnArithSeq</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1</span> <span class='hs-varid'>expr2</span> <span class='hs-varid'>expr3</span><span class='hs-layout'>)</span>
<a name="line-17"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr1</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-18"></a>   <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr2</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-19"></a>   <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>expr3</span>        <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr3'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-20"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>expr1'</span> <span class='hs-varid'>expr2'</span> <span class='hs-varid'>expr3'</span><span class='hs-layout'>,</span>
<a name="line-21"></a>            <span class='hs-varid'>plusFVs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fvExpr1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvExpr3</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{@Stmt@s: in @do@ expressions}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnStmts"></a><span class='hs-definition'>rnStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-comment'>-- Variables bound by the Stmts, and mentioned in thing_inside,</span>
<a name="line-7"></a><span class='hs-comment'>-- do not appear in the result FreeVars</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>rnStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>thing_inside</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkEmptyStmts</span> <span class='hs-varid'>ctxt</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-conid'>[]</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>rnStmts</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>thing_inside</span>    <span class='hs-comment'>-- Deal with mdo</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Behave like do { rec { ...all but last... }; last }</span>
<a name="line-16"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-17"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmt</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkRecStmt</span> <span class='hs-varid'>all_but_last</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-18"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>last_stmt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLastStmt</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>last_stmt</span>
<a name="line-19"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>rnStmt</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>last_stmt'</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>stmts2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>all_but_last</span><span class='hs-layout'>,</span> <span class='hs-varid'>last_stmt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>stmts</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-definition'>rnStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-varid'>lstmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lstmts</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>lstmts</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-27"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lstmt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLastStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>lstmt'</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-32"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>                         <span class='hs-varop'>$</span>
<a name="line-33"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span>
<a name="line-34"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>lstmt</span>    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs1</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-35"></a>                    <span class='hs-varid'>rnStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>lstmts</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-36"></a>                    <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bndrs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>stmts2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="rnStmt"></a><span class='hs-comment'>----------------------</span>
<a name="line-40"></a><span class='hs-definition'>rnStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-41"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-42"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-comment'>-- Variables bound by the Stmt, and mentioned in thing_inside,</span>
<a name="line-46"></a><span class='hs-comment'>-- do not appear in the result FreeVars</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-50"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-51"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span>  <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-conid'>[]</span>
<a name="line-52"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>ret_op</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-53"></a>                  <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-57"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>then_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>thenMName</span>
<a name="line-58"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>guard_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isListCompExpr</span> <span class='hs-varid'>ctxt</span>
<a name="line-59"></a>                              <span class='hs-keyword'>then</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>guardMName</span>
<a name="line-60"></a>                              <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-61"></a>                              <span class='hs-comment'>-- Only list/parr/monad comprehensions use 'guard'</span>
<a name="line-62"></a>                              <span class='hs-comment'>-- Also for sub-stmts of same eg [ e | x&lt;-xs, gd | blah ]</span>
<a name="line-63"></a>                              <span class='hs-comment'>-- Here "gd" is a guard</span>
<a name="line-64"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-conid'>[]</span>
<a name="line-65"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>then_op</span> <span class='hs-varid'>guard_op</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-66"></a>                  <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-70"></a>                <span class='hs-comment'>-- The binders do not scope over the expression</span>
<a name="line-71"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-72"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fail_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>failMName</span>
<a name="line-73"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rnPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-74"></a>        <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-76"></a>                  <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-77"></a>       <span class='hs-comment'>-- fv_expr shouldn't really be filtered by the rnPatsAndThen</span>
<a name="line-78"></a>        <span class='hs-comment'>-- but it does not matter because the names are unique</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-definition'>rnStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>rnLocalBindsAndThen</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-82"></a>        <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectLocalBinders</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span>
<a name="line-83"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>  <span class='hs-layout'>}</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_stmts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-87"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mfix_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>mfixName</span>
<a name="line-88"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-89"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyRecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_ret_fn</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op</span>
<a name="line-90"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>recS_mfix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mfix_op</span>
<a name="line-91"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>recS_bind_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span> <span class='hs-layout'>}</span>
<a name="line-92"></a>
<a name="line-93"></a>        <span class='hs-comment'>-- Step1: Bring all the binders of the mdo into scope</span>
<a name="line-94"></a>        <span class='hs-comment'>-- (Remember that this also removes the binders from the</span>
<a name="line-95"></a>        <span class='hs-comment'>-- finally-returned free-vars.)</span>
<a name="line-96"></a>        <span class='hs-comment'>-- And rename each individual stmt, making a</span>
<a name="line-97"></a>        <span class='hs-comment'>-- singleton segment.  At this stage the FwdRefs field</span>
<a name="line-98"></a>        <span class='hs-comment'>-- isn't finished: it's empty for all except a BindStmt</span>
<a name="line-99"></a>        <span class='hs-comment'>-- for which it's the fwd refs within the bind itself</span>
<a name="line-100"></a>        <span class='hs-comment'>-- (This set may not be empty, because we're in a recursive</span>
<a name="line-101"></a>        <span class='hs-comment'>-- context.)</span>
<a name="line-102"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rnRecStmtsAndThen</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>rec_stmts</span>   <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>segs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-103"></a>        <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionNameSets</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-104"></a>                                            <span class='hs-varid'>emptyNameSet</span> <span class='hs-varid'>segs</span>
<a name="line-105"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>bndrs</span>
<a name="line-106"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>rec_stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>segmentRecStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-107"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>rec_stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>segs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>mzip_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>mzipName</span>
<a name="line-111"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-112"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-113"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnParallelStmts</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>return_op</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-114"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>segs'</span> <span class='hs-varid'>mzip_op</span> <span class='hs-varid'>bind_op</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-115"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-116"></a>
<a name="line-117"></a><span class='hs-definition'>rnStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span>
<a name="line-118"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Rename the 'using' expression in the context before the transform is begun</span>
<a name="line-120"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>using'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>using</span>
<a name="line-121"></a>
<a name="line-122"></a>         <span class='hs-comment'>-- Rename the stmts and the 'by' expression</span>
<a name="line-123"></a>         <span class='hs-comment'>-- Keep track of the variables mentioned in the 'by' expression</span>
<a name="line-124"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span>
<a name="line-125"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-126"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>by'</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs_by</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapMaybeFvRn</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>by</span>
<a name="line-127"></a>                   <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>bndrs</span>
<a name="line-128"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs_by</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_thing</span>
<a name="line-129"></a>                         <span class='hs-varid'>used_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-130"></a>                         <span class='hs-comment'>-- The paper (Fig 5) has a bug here; we must treat any free varaible</span>
<a name="line-131"></a>                         <span class='hs-comment'>-- of the "thing inside", **or of the by-expression**, as used</span>
<a name="line-132"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-133"></a>
<a name="line-134"></a>       <span class='hs-comment'>-- Lookup `return`, `(&gt;&gt;=)` and `liftM` for monad comprehensions</span>
<a name="line-135"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>returnMName</span>
<a name="line-136"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs4</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>bindMName</span>
<a name="line-137"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap_op</span><span class='hs-layout'>,</span>   <span class='hs-varid'>fvs5</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>form</span> <span class='hs-keyword'>of</span>
<a name="line-138"></a>                                <span class='hs-conid'>ThenForm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-139"></a>                                <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>fmapName</span>
<a name="line-140"></a>
<a name="line-141"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_fvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs3</span>
<a name="line-142"></a>                             <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs4</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs5</span>
<a name="line-143"></a>             <span class='hs-varid'>bndr_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>used_bndrs</span>
<a name="line-144"></a>             <span class='hs-comment'>-- See Note [TransStmt binder map] in HsExpr</span>
<a name="line-145"></a>
<a name="line-146"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rnStmt: implicitly rebound these used binders:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr_map</span><span class='hs-layout'>)</span>
<a name="line-147"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr_map</span>
<a name="line-148"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span>
<a name="line-149"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>trS_ret</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span>
<a name="line-150"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>trS_fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap_op</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="rnParallelStmts"></a><span class='hs-definition'>rnParallelStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>thing</span><span class='hs-varop'>.</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-153"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>Name</span>
<a name="line-154"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>RdrName</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-155"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-156"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-157"></a><span class='hs-comment'>-- Note [Renaming parallel Stmts]</span>
<a name="line-158"></a><span class='hs-definition'>rnParallelStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>return_op</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>orig_lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-160"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rn_segs</span> <span class='hs-varid'>orig_lcl_env</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>segs</span> <span class='hs-layout'>}</span>
<a name="line-161"></a>  <span class='hs-keyword'>where</span>
<a name="line-162"></a>    <span class='hs-varid'>rn_segs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span>
<a name="line-163"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>RdrName</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-164"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-165"></a>    <span class='hs-varid'>rn_segs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndrs_so_far</span> <span class='hs-conid'>[]</span>
<a name="line-166"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeDups</span> <span class='hs-varid'>cmpByOcc</span> <span class='hs-varid'>bndrs_so_far</span>
<a name="line-167"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>dupErr</span> <span class='hs-varid'>dups</span>
<a name="line-168"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindLocalNames</span> <span class='hs-varid'>bndrs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span>
<a name="line-169"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-170"></a>
<a name="line-171"></a>    <span class='hs-varid'>rn_segs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs_so_far</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-172"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-173"></a>                    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rnLExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-174"></a>                       <span class='hs-varid'>setLocalRdrEnv</span> <span class='hs-varid'>env</span>       <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-175"></a>                       <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_segs</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bndrs_so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>segs</span>
<a name="line-176"></a>                       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>used_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-177"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>used_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-178"></a>
<a name="line-179"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>seg'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>used_bndrs</span> <span class='hs-varid'>return_op</span>
<a name="line-180"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>seg'</span><span class='hs-conop'>:</span><span class='hs-varid'>segs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-181"></a>
<a name="line-182"></a>    <span class='hs-varid'>cmpByOcc</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>n2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n2</span>
<a name="line-183"></a>    <span class='hs-varid'>dupErr</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate binding in parallel list comprehension for:"</span><span class='hs-layout'>)</span>
<a name="line-184"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-185"></a>
<a name="line-186"></a><a name="lookupStmtName"></a><span class='hs-definition'>lookupStmtName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-187"></a><span class='hs-comment'>-- Like lookupSyntaxName, but ListComp/PArrComp are never rebindable</span>
<a name="line-188"></a><span class='hs-comment'>-- Neither is ArrowExpr, which has its own desugarer in DsArrows</span>
<a name="line-189"></a><span class='hs-definition'>lookupStmtName</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>n</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-191"></a>      <span class='hs-conid'>ListComp</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not_rebindable</span>
<a name="line-192"></a>      <span class='hs-conid'>PArrComp</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not_rebindable</span>
<a name="line-193"></a>      <span class='hs-conid'>ArrowExpr</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not_rebindable</span>
<a name="line-194"></a>      <span class='hs-conid'>PatGuard</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not_rebindable</span>
<a name="line-195"></a>
<a name="line-196"></a>      <span class='hs-conid'>DoExpr</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rebindable</span>
<a name="line-197"></a>      <span class='hs-conid'>MDoExpr</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rebindable</span>
<a name="line-198"></a>      <span class='hs-conid'>MonadComp</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rebindable</span>
<a name="line-199"></a>      <span class='hs-conid'>GhciStmtCtxt</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rebindable</span>   <span class='hs-comment'>-- I suppose?</span>
<a name="line-200"></a>
<a name="line-201"></a>      <span class='hs-conid'>ParStmtCtxt</span>   <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>c</span> <span class='hs-varid'>n</span>     <span class='hs-comment'>-- Look inside to</span>
<a name="line-202"></a>      <span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupStmtName</span> <span class='hs-varid'>c</span> <span class='hs-varid'>n</span>     <span class='hs-comment'>-- the parent context</span>
<a name="line-203"></a>  <span class='hs-keyword'>where</span>
<a name="line-204"></a>    <span class='hs-varid'>rebindable</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>n</span>
<a name="line-205"></a>    <span class='hs-varid'>not_rebindable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Renaming parallel Stmts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Renaming parallel statements is painful.  Given, say
     [ a+c | a <- as, bs <- bss
           | c <- bs, a <- ds ]
Note that
  (a) In order to report "Defined by not used" about 'bs', we must rename
      each group of Stmts with a thing_inside whose FreeVars include at least {a,c}

  (b) We want to report that 'a' is illegally bound in both branches

  (c) The 'bs' in the second group must obviously not be captured by
      the binding in the first group

To satisfy (a) we nest the segements.
To satisfy (b) we check for duplicates just before thing_inside.
To satisfy (c) we reset the LocalRdrEnv each time.

%************************************************************************
%*                                                                      *
\subsubsection{mdo expressions}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="FwdRefs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FwdRefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameSet</span>
<a name="line-2"></a><a name="Segment"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Segment</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defs</span><span class='hs-layout'>,</span>
<a name="line-3"></a>                      <span class='hs-conid'>Uses</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- May include defs</span>
<a name="line-4"></a>                      <span class='hs-conid'>FwdRefs</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- A subset of uses that are</span>
<a name="line-5"></a>                                <span class='hs-comment'>--   (a) used before they are bound in this segment, or</span>
<a name="line-6"></a>                                <span class='hs-comment'>--   (b) used here, and bound in subsequent segments</span>
<a name="line-7"></a>                      <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Either Stmt or [Stmt]</span>
<a name="line-8"></a>
<a name="line-9"></a>
<a name="line-10"></a><a name="rnRecStmtsAndThen"></a><span class='hs-comment'>-- wrapper that does both the left- and right-hand sides</span>
<a name="line-11"></a><span class='hs-definition'>rnRecStmtsAndThen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-12"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a>                         <span class='hs-comment'>-- assumes that the FreeVars returned includes</span>
<a name="line-15"></a>                         <span class='hs-comment'>-- the FreeVars of the Segments</span>
<a name="line-16"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>rnRecStmtsAndThen</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>s</span> <span class='hs-varid'>cont</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-comment'>-- (A) Make the mini fixity env for all of the stmts</span>
<a name="line-20"></a>          <span class='hs-varid'>fix_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeMiniFixityEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectRecStmtsFixities</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>          <span class='hs-comment'>-- (B) Do the LHSes</span>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_lhs_and_fv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_rec_stmts_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>s</span>
<a name="line-24"></a>
<a name="line-25"></a>          <span class='hs-comment'>--    ...bring them and their fixities into scope</span>
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bound_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLStmtsBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>new_lhs_and_fv</span><span class='hs-layout'>)</span>
<a name="line-27"></a>              <span class='hs-comment'>-- Fake uses of variables introduced implicitly (warning suppression, see #4404)</span>
<a name="line-28"></a>              <span class='hs-varid'>implicit_uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lStmtsImplicits</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>new_lhs_and_fv</span><span class='hs-layout'>)</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>bound_names</span> <span class='hs-varop'>$</span>
<a name="line-30"></a>          <span class='hs-varid'>addLocalFixities</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>bound_names</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-31"></a>
<a name="line-32"></a>          <span class='hs-comment'>-- (C) do the right-hand-sides and thing-inside</span>
<a name="line-33"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>segs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rn_rec_stmts</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>bound_names</span> <span class='hs-varid'>new_lhs_and_fv</span>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cont</span> <span class='hs-varid'>segs</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedLocalBinds</span> <span class='hs-varid'>bound_names</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvs</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>implicit_uses</span><span class='hs-layout'>)</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="collectRecStmtsFixities"></a><span class='hs-comment'>-- get all the fixity decls in any Let stmt</span>
<a name="line-39"></a><span class='hs-definition'>collectRecStmtsFixities</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>RdrName</span> <span class='hs-conid'>RdrName</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFixitySig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-40"></a><span class='hs-definition'>collectRecStmtsFixities</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-41"></a>    <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>acc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-42"></a>                            <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-43"></a>                                <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sig</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>                                                           <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FixSig</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span>
<a name="line-45"></a>                                                           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>sigs</span>
<a name="line-46"></a>                            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>l</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-comment'>-- left-hand sides</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="rn_rec_stmt_lhs"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-51"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-varid'>body</span>
<a name="line-52"></a>                   <span class='hs-comment'>-- rename LHS, and return its FVs</span>
<a name="line-53"></a>                   <span class='hs-comment'>-- Warning: we will only need the FreeVars below in the case of a BindStmt,</span>
<a name="line-54"></a>                   <span class='hs-comment'>-- so we don't bother to compute it accurately in the other cases</span>
<a name="line-55"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span> <span class='hs-varid'>body</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-65"></a>      <span class='hs-comment'>-- should the ctxt be MDo instead?</span>
<a name="line-66"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBindPat</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRecNameMaker</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span>
<a name="line-67"></a>      <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-68"></a>               <span class='hs-varid'>fv_pat</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>badIpBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an mdo expression"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-74"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-sel'>_bound_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLocalValBindsLHS</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>binds</span>
<a name="line-75"></a>         <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-76"></a>                 <span class='hs-comment'>-- Warning: this is bogus; see function invariant</span>
<a name="line-77"></a>                 <span class='hs-varid'>emptyFVs</span>
<a name="line-78"></a>                 <span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-comment'>-- XXX Do we need to do something with the return and mfix names?</span>
<a name="line-81"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Flatten Rec inside Rec</span>
<a name="line-82"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rn_rec_stmts_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>stmts</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-definition'>rn_rec_stmt_lhs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-conid'>EmptyLocalBinds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rn_rec_stmt LetStmt EmptyLocalBinds"</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="rn_rec_stmts_lhs"></a><span class='hs-definition'>rn_rec_stmts_lhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MiniFixityEnv</span>
<a name="line-94"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span>
<a name="line-95"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span> <span class='hs-varid'>body</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-96"></a><span class='hs-definition'>rn_rec_stmts_lhs</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>stmts</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_rec_stmt_lhs</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>boundNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLStmtsBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>ls</span><span class='hs-layout'>)</span>
<a name="line-99"></a>            <span class='hs-comment'>-- First do error checking: we need to check for dups here because we</span>
<a name="line-100"></a>            <span class='hs-comment'>-- don't bind all of the variables from the Stmt at once</span>
<a name="line-101"></a>            <span class='hs-comment'>-- with bindLocatedLocals.</span>
<a name="line-102"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkDupNames</span> <span class='hs-varid'>boundNames</span>
<a name="line-103"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ls</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a>
<a name="line-106"></a><span class='hs-comment'>-- right-hand-sides</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="rn_rec_stmt"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-109"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-110"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-111"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-112"></a>        <span class='hs-comment'>-- Rename a Stmt that is inside a RecStmt (or mdo)</span>
<a name="line-113"></a>        <span class='hs-comment'>-- Assumes all binders are already in scope</span>
<a name="line-114"></a>        <span class='hs-comment'>-- Turns each stmt into a singleton Stmt</span>
<a name="line-115"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>
<a name="line-117"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>returnMName</span>
<a name="line-118"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span>
<a name="line-119"></a>                   <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>ret_op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-120"></a>
<a name="line-121"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span> <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-123"></a>    <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>thenMName</span>  <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>then_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-124"></a>    <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span>
<a name="line-125"></a>              <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>then_op</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_pat</span>
<a name="line-128"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>body</span>         <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>body'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fv_expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-129"></a>    <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>bindMName</span>  <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-130"></a>    <span class='hs-varid'>lookupSyntaxName</span> <span class='hs-varid'>failMName</span>  <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>fail_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-131"></a>    <span class='hs-keyword'>let</span>
<a name="line-132"></a>        <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span>
<a name="line-133"></a>        <span class='hs-varid'>fvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fv_expr</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fv_pat</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span>
<a name="line-134"></a>    <span class='hs-keyword'>in</span>
<a name="line-135"></a>    <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span>
<a name="line-136"></a>              <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>badIpBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an mdo expression"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>all_bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-142"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>du_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-143"></a>      <span class='hs-comment'>-- fixities and unused are handled above in rnRecStmtsAndThen</span>
<a name="line-144"></a>      <span class='hs-varid'>rnLocalValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>all_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds'</span>
<a name="line-145"></a>  <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>duDefs</span> <span class='hs-varid'>du_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>allUses</span> <span class='hs-varid'>du_binds</span><span class='hs-layout'>,</span>
<a name="line-146"></a>           <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-147"></a>
<a name="line-148"></a><span class='hs-comment'>-- no RecStmt case because they get flattened above when doing the LHSes</span>
<a name="line-149"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt: RecStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>       <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt: ParStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-154"></a>
<a name="line-155"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>     <span class='hs-comment'>-- Syntactically illegal in mdo</span>
<a name="line-156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"rn_rec_stmt: TransStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-157"></a>
<a name="line-158"></a><span class='hs-definition'>rn_rec_stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-conid'>EmptyLocalBinds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rn_rec_stmt: LetStmt EmptyLocalBinds"</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="rn_rec_stmts"></a><span class='hs-definition'>rn_rec_stmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-162"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-163"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-164"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LStmtLR</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-165"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-166"></a><span class='hs-definition'>rn_rec_stmts</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span>
<a name="line-167"></a>    <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_rec_stmt</span> <span class='hs-varid'>rnBody</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>     <span class='hs-varop'>`thenM`</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>segs_s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-168"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>segs_s</span><span class='hs-layout'>)</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="segmentRecStmts"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-171"></a><span class='hs-definition'>segmentRecStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> 
<a name="line-172"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span>
<a name="line-173"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>
<a name="line-174"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-175"></a>
<a name="line-176"></a><span class='hs-definition'>segmentRecStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-177"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>segsToStmts</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>grouped_segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-179"></a>                <span class='hs-comment'>-- Step 4: Turn the segments into Stmts</span>
<a name="line-180"></a>                <span class='hs-comment'>--         Use RecStmt when and only when there are fwd refs</span>
<a name="line-181"></a>                <span class='hs-comment'>--         Also gather up the uses from the end towards the</span>
<a name="line-182"></a>                <span class='hs-comment'>--         start, so we can tell the RecStmt which things are</span>
<a name="line-183"></a>                <span class='hs-comment'>--         used 'after' the RecStmt</span>
<a name="line-184"></a>
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-187"></a>       <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ss</span>
<a name="line-188"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span>
<a name="line-189"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-190"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>uses</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span>
<a name="line-191"></a>
<a name="line-192"></a>  <span class='hs-keyword'>where</span>
<a name="line-193"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>defs_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses_s</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip4</span> <span class='hs-varid'>segs</span>
<a name="line-194"></a>    <span class='hs-varid'>defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>defs_s</span>
<a name="line-195"></a>    <span class='hs-varid'>uses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>uses_s</span>
<a name="line-196"></a>
<a name="line-197"></a>                <span class='hs-comment'>-- Step 2: Fill in the fwd refs.</span>
<a name="line-198"></a>                <span class='hs-comment'>--         The segments are all singletons, but their fwd-ref</span>
<a name="line-199"></a>                <span class='hs-comment'>--         field mentions all the things used by the segment</span>
<a name="line-200"></a>                <span class='hs-comment'>--         that are bound after their use</span>
<a name="line-201"></a>    <span class='hs-varid'>segs_w_fwd_refs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addFwdRefs</span> <span class='hs-varid'>segs</span>
<a name="line-202"></a>
<a name="line-203"></a>                <span class='hs-comment'>-- Step 3: Group together the segments to make bigger segments</span>
<a name="line-204"></a>                <span class='hs-comment'>--         Invariant: in the result, no segment uses a variable</span>
<a name="line-205"></a>                <span class='hs-comment'>--                    bound in a later segment</span>
<a name="line-206"></a>    <span class='hs-varid'>grouped_segs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>glomSegments</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>segs_w_fwd_refs</span>
<a name="line-207"></a>
<a name="line-208"></a><a name="addFwdRefs"></a><span class='hs-comment'>----------------------------</span>
<a name="line-209"></a><span class='hs-definition'>addFwdRefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-210"></a><span class='hs-comment'>-- So far the segments only have forward refs *within* the Stmt</span>
<a name="line-211"></a><span class='hs-comment'>--      (which happens for bind:  x &lt;- ...x...)</span>
<a name="line-212"></a><span class='hs-comment'>-- This function adds the cross-seg fwd ref info</span>
<a name="line-213"></a>
<a name="line-214"></a><span class='hs-definition'>addFwdRefs</span> <span class='hs-varid'>segs</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>mk_seg</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyNameSet</span><span class='hs-layout'>)</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-216"></a>  <span class='hs-keyword'>where</span>
<a name="line-217"></a>    <span class='hs-varid'>mk_seg</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>segs</span><span class='hs-layout'>,</span> <span class='hs-varid'>later_defs</span><span class='hs-layout'>)</span>
<a name="line-218"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_seg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_defs</span><span class='hs-layout'>)</span>
<a name="line-219"></a>        <span class='hs-keyword'>where</span>
<a name="line-220"></a>          <span class='hs-varid'>new_seg</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-221"></a>          <span class='hs-varid'>all_defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>later_defs</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>defs</span>
<a name="line-222"></a>          <span class='hs-varid'>new_fwds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fwds</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-layout'>(</span><span class='hs-varid'>uses</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>later_defs</span><span class='hs-layout'>)</span>
<a name="line-223"></a>                <span class='hs-comment'>-- Add the downstream fwd refs here</span>
</pre>\end{code}

Note [Segmenting mdo]
~~~~~~~~~~~~~~~~~~~~~
NB. June 7 2012: We only glom segments that appear in an explicit mdo;
and leave those found in "do rec"'s intact.  See
http://ghc.haskell.org/trac/ghc/ticket/4148 for the discussion
leading to this design choice.  Hence the test in segmentRecStmts.

Note [Glomming segments]
~~~~~~~~~~~~~~~~~~~~~~~~
Glomming the singleton segments of an mdo into minimal recursive groups.

At first I thought this was just strongly connected components, but
there's an important constraint: the order of the stmts must not change.

Consider
     mdo { x <- ...y...
           p <- z
           y <- ...x...
           q <- x
           z <- y
           r <- x }

Here, the first stmt mention 'y', which is bound in the third.
But that means that the innocent second stmt (p <- z) gets caught
up in the recursion.  And that in turn means that the binding for
'z' has to be included... and so on.

Start at the tail { r <- x }
Now add the next one { z <- y ; r <- x }
Now add one more     { q <- x ; z <- y ; r <- x }
Now one more... but this time we have to group a bunch into rec
     { rec { y <- ...x... ; q <- x ; z <- y } ; r <- x }
Now one more, which we can add on without a rec
     { p <- z ;
       rec { y <- ...x... ; q <- x ; z <- y } ;
       r <- x }
Finally we add the last one; since it mentions y we have to
glom it together with the first two groups
     { rec { x <- ...y...; p <- z ; y <- ...x... ;
             q <- x ; z <- y } ;
       r <- x }

\begin{code}
<pre><a name="line-1"></a><a name="glomSegments"></a><span class='hs-definition'>glomSegments</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [Glomming segments]</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-definition'>glomSegments</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-5"></a><span class='hs-definition'>glomSegments</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span><span class='hs-varid'>uses</span><span class='hs-layout'>,</span><span class='hs-varid'>fwds</span><span class='hs-layout'>,</span><span class='hs-varid'>stmt</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>        <span class='hs-comment'>-- Actually stmts will always be a singleton</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>seg_defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>seg_uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>seg_fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>seg_stmts</span><span class='hs-layout'>)</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>others</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>segs'</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>glomSegments</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>segs</span>
<a name="line-10"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>extras</span><span class='hs-layout'>,</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grab</span> <span class='hs-varid'>uses</span> <span class='hs-varid'>segs'</span>
<a name="line-11"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>us</span><span class='hs-layout'>,</span> <span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip4</span> <span class='hs-varid'>extras</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-varid'>seg_defs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>defs</span>
<a name="line-14"></a>    <span class='hs-varid'>seg_uses</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>us</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>uses</span>
<a name="line-15"></a>    <span class='hs-varid'>seg_fwds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fs</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fwds</span>
<a name="line-16"></a>    <span class='hs-varid'>seg_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>ss</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>grab</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span>             <span class='hs-comment'>-- The client</span>
<a name="line-19"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Needed by the 'client'</span>
<a name="line-21"></a>             <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Not needed by the client</span>
<a name="line-22"></a>        <span class='hs-comment'>-- The result is simply a split of the input</span>
<a name="line-23"></a>    <span class='hs-varid'>grab</span> <span class='hs-varid'>uses</span> <span class='hs-varid'>dus</span>
<a name="line-24"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-keyword'>where</span>
<a name="line-26"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>noes</span><span class='hs-layout'>,</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-varid'>not_needed</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>dus</span><span class='hs-layout'>)</span>
<a name="line-27"></a>          <span class='hs-varid'>not_needed</span> <span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersectsNameSet</span> <span class='hs-varid'>defs</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="segsToStmts"></a><span class='hs-comment'>----------------------------------------------------</span>
<a name="line-30"></a><span class='hs-definition'>segsToStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span>                   <span class='hs-comment'>-- A RecStmt with the SyntaxOps filled in</span>
<a name="line-31"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Segment</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVars</span>                         <span class='hs-comment'>-- Free vars used 'later'</span>
<a name="line-33"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-definition'>segsToStmts</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>fvs_later</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_later</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-definition'>segsToStmts</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uses</span><span class='hs-layout'>,</span> <span class='hs-varid'>fwds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>segs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs_later</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>later_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>later_uses</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>uses</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyword'>where</span>
<a name="line-40"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>later_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>later_uses</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>segsToStmts</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-varid'>segs</span> <span class='hs-varid'>fvs_later</span>
<a name="line-41"></a>    <span class='hs-varid'>new_stmt</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>non_rec</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>ss</span>
<a name="line-42"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rec_stmt</span>
<a name="line-43"></a>    <span class='hs-varid'>rec_stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty_rec_stmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ss</span>
<a name="line-44"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>used_later</span>
<a name="line-45"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>fwds</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>    <span class='hs-varid'>non_rec</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>ss</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyNameSet</span> <span class='hs-varid'>fwds</span>
<a name="line-47"></a>    <span class='hs-varid'>used_later</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defs</span> <span class='hs-varop'>`intersectNameSet`</span> <span class='hs-varid'>later_uses</span>
<a name="line-48"></a>                                <span class='hs-comment'>-- The ones needed after the RecStmt</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{Assertion utils}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="srcSpanPrimLit"></a><span class='hs-definition'>srcSpanPrimLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-definition'>srcSpanPrimLit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>span</span>
<a name="line-3"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStringPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeMkByteString</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDocOneLine</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="mkAssertErrorExpr"></a><span class='hs-definition'>mkAssertErrorExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-comment'>-- Return an expression for (assertError "Foo.hs:27")</span>
<a name="line-7"></a><span class='hs-definition'>mkAssertErrorExpr</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>sloc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-9"></a>       <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-10"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>sloc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>assertErrorName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                     <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>sloc</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanPrimLit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sloc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Adding the implicit parameter to 'assert']
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The renamer transforms (assert e1 e2) to (assert "Foo.hs:27" e1 e2).
By doing this in the renamer we allow the typechecker to just see the
expanded application and do the right thing. But it's not really
the Right Thing because there's no way to "undo" if you want to see
the original source code.  We'll have fix this in due course, when
we care more about being able to reconstruct the exact original
program.

%************************************************************************
%*                                                                      *
\subsubsection{Errors}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="checkEmptyStmts"></a><span class='hs-definition'>checkEmptyStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- We've seen an empty sequence of Stmts... is that ok?</span>
<a name="line-3"></a><span class='hs-definition'>checkEmptyStmts</span> <span class='hs-varid'>ctxt</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>okEmpty</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="okEmpty"></a><span class='hs-definition'>okEmpty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-7"></a><span class='hs-definition'>okEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatGuard</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-8"></a><span class='hs-definition'>okEmpty</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="emptyErr"></a><span class='hs-definition'>emptyErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-11"></a><span class='hs-definition'>emptyErr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Empty statement group in parallel comprehension"</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>emptyErr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmtCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Empty statement group preceding 'group' or 'then'"</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-definition'>emptyErr</span> <span class='hs-varid'>ctxt</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Empty"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprStmtContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="checkLastStmt"></a><span class='hs-comment'>----------------------</span>
<a name="line-16"></a><span class='hs-definition'>checkLastStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-17"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>checkLastStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-21"></a>      <span class='hs-conid'>ListComp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_comp</span>
<a name="line-22"></a>      <span class='hs-conid'>MonadComp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_comp</span>
<a name="line-23"></a>      <span class='hs-conid'>PArrComp</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_comp</span>
<a name="line-24"></a>      <span class='hs-conid'>ArrowExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_do</span>
<a name="line-25"></a>      <span class='hs-conid'>DoExpr</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_do</span>
<a name="line-26"></a>      <span class='hs-conid'>MDoExpr</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_do</span>
<a name="line-27"></a>      <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_other</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>check_do</span>    <span class='hs-comment'>-- Expect BodyStmt, and change it to LastStmt</span>
<a name="line-30"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-31"></a>          <span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLastStmt</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-32"></a>          <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span>   <span class='hs-comment'>-- "Deriving" clauses may generate a</span>
<a name="line-33"></a>                                             <span class='hs-comment'>-- LastStmt directly (unlike the parser)</span>
<a name="line-34"></a>          <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-varid'>last_error</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>    <span class='hs-varid'>last_error</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The last statement in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprAStmtContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-36"></a>                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must be an expression"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-varid'>check_comp</span>  <span class='hs-comment'>-- Expect LastStmt; this should be enforced by the parser!</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>          <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span>
<a name="line-41"></a>          <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"checkLastStmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lstmt</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>check_other</span> <span class='hs-comment'>-- Behave just as if this wasn't the last stmt</span>
<a name="line-44"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lstmt</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lstmt</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="checkStmt"></a><span class='hs-comment'>-- Checking when a particular Stmt is ok</span>
<a name="line-47"></a><span class='hs-definition'>checkStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-48"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-50"></a><span class='hs-definition'>checkStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-52"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-53"></a>           <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-54"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>   <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprStmtCat</span> <span class='hs-varid'>stmt</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"statement"</span><span class='hs-layout'>)</span>
<a name="line-57"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprAStmtContext</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>]</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="pprStmtCat"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stmt</span> <span class='hs-varid'>a</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-60"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"transform"</span><span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"return expression"</span><span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"body"</span><span class='hs-layout'>)</span>
<a name="line-63"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"binding"</span><span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let"</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"rec"</span><span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-definition'>pprStmtCat</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"parallel"</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="isOK"></a><span class='hs-comment'>------------</span>
<a name="line-69"></a><span class='hs-definition'>isOK</span><span class='hs-layout'>,</span> <span class='hs-varid'>notOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>
<a name="line-70"></a><span class='hs-definition'>isOK</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-71"></a><a name="notOK"></a><span class='hs-definition'>notOK</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>empty</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="okStmt"></a><span class='hs-definition'>okStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okDoStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okCompStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okParStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>okPArrStmt</span>
<a name="line-74"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-75"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>
<a name="line-76"></a><span class='hs-comment'>-- Return Nothing if OK, (Just extra) if not ok</span>
<a name="line-77"></a><span class='hs-comment'>-- The "extra" is an SDoc that is appended to an generic error message</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-definition'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-81"></a>      <span class='hs-conid'>PatGuard</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okPatGuardStmt</span> <span class='hs-varid'>stmt</span>
<a name="line-82"></a>      <span class='hs-conid'>ParStmtCtxt</span> <span class='hs-varid'>ctxt</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okParStmt</span>  <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-83"></a>      <span class='hs-conid'>DoExpr</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-84"></a>      <span class='hs-conid'>MDoExpr</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-85"></a>      <span class='hs-conid'>ArrowExpr</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-86"></a>      <span class='hs-conid'>GhciStmtCtxt</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okDoStmt</span>   <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-87"></a>      <span class='hs-conid'>ListComp</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okCompStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-88"></a>      <span class='hs-conid'>MonadComp</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okCompStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-89"></a>      <span class='hs-conid'>PArrComp</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okPArrStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-90"></a>      <span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="okPatGuardStmt"></a><span class='hs-comment'>-------------</span>
<a name="line-93"></a><span class='hs-definition'>okPatGuardStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>
<a name="line-94"></a><span class='hs-definition'>okPatGuardStmt</span> <span class='hs-varid'>stmt</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-96"></a>      <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-97"></a>      <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-98"></a>      <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-99"></a>      <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="okParStmt"></a><span class='hs-comment'>-------------</span>
<a name="line-102"></a><span class='hs-definition'>okParStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-104"></a>      <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>
<a name="line-105"></a>      <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>okStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="okDoStmt"></a><span class='hs-comment'>----------------</span>
<a name="line-108"></a><span class='hs-definition'>okDoStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-110"></a>       <span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-111"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Opt_RecursiveDo</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-112"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowExpr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>    <span class='hs-comment'>-- Arrows allows 'rec'</span>
<a name="line-113"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use RecursiveDo"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-114"></a>       <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-115"></a>       <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-116"></a>       <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-117"></a>       <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="okCompStmt"></a><span class='hs-comment'>----------------</span>
<a name="line-120"></a><span class='hs-definition'>okCompStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-122"></a>       <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-123"></a>       <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-124"></a>       <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-125"></a>       <span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-126"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Opt_ParallelListComp</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-127"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use ParallelListComp"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-128"></a>       <span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-129"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Opt_TransformListComp</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-130"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use TransformListComp"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-131"></a>       <span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>
<a name="line-132"></a>       <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>  <span class='hs-comment'>-- Should not happen (dealt with by checkLastStmt)</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="okPArrStmt"></a><span class='hs-comment'>----------------</span>
<a name="line-135"></a><span class='hs-definition'>okPArrStmt</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-137"></a>       <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-138"></a>       <span class='hs-conid'>LetStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-139"></a>       <span class='hs-conid'>BodyStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-140"></a>       <span class='hs-conid'>ParStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-141"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Opt_ParallelListComp</span> <span class='hs-varop'>`xopt`</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isOK</span>
<a name="line-142"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use ParallelListComp"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-143"></a>       <span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>
<a name="line-144"></a>       <span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>
<a name="line-145"></a>       <span class='hs-conid'>LastStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notOK</span>  <span class='hs-comment'>-- Should not happen (dealt with by checkLastStmt)</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="checkTupleSection"></a><span class='hs-comment'>---------</span>
<a name="line-148"></a><span class='hs-definition'>checkTupleSection</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsTupArg</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-149"></a><span class='hs-definition'>checkTupleSection</span> <span class='hs-varid'>args</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>tuple_section</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_TupleSections</span>
<a name="line-151"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>tupArgPresent</span> <span class='hs-varid'>args</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tuple_section</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span>
<a name="line-152"></a>  <span class='hs-keyword'>where</span>
<a name="line-153"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal tuple section: use TupleSections"</span><span class='hs-layout'>)</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="sectionErr"></a><span class='hs-comment'>---------</span>
<a name="line-156"></a><span class='hs-definition'>sectionErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-157"></a><span class='hs-definition'>sectionErr</span> <span class='hs-varid'>expr</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A section must be enclosed in parentheses"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-159"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"thus:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="patSynErr"></a><span class='hs-definition'>patSynErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-162"></a><span class='hs-definition'>patSynErr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Pattern syntax in expression context:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-163"></a>                                <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-164"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EWildPat</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="badIpBinds"></a><span class='hs-definition'>badIpBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-167"></a><span class='hs-definition'>badIpBinds</span> <span class='hs-varid'>what</span> <span class='hs-varid'>binds</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Implicit-parameter bindings illegal in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span><span class='hs-layout'>)</span>
<a name="line-169"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
