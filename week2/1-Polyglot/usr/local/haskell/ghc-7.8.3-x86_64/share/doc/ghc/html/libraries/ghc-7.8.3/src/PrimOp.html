<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>prelude/PrimOp.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[PrimOp]{Primitive operations (machine-level)}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>PrimOp</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-conid'>PrimOp</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimOpVecCat</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>allThePrimOps</span><span class='hs-layout'>,</span>
<a name="line-3"></a>        <span class='hs-varid'>primOpType</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpSig</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>primOpTag</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxPrimOpTag</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpOcc</span><span class='hs-layout'>,</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-varid'>tagToEnumKey</span><span class='hs-layout'>,</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-varid'>primOpOutOfLine</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpCodeSize</span><span class='hs-layout'>,</span>
<a name="line-9"></a>        <span class='hs-varid'>primOpOkForSpeculation</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpOkForSideEffects</span><span class='hs-layout'>,</span>
<a name="line-10"></a>        <span class='hs-varid'>primOpIsCheap</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpFixity</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-varid'>getPrimOpResultInfo</span><span class='hs-layout'>,</span>  <span class='hs-conid'>PrimOpResultInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-conid'>PrimCall</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-15"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmType</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>              <span class='hs-layout'>(</span> <span class='hs-conid'>TyVar</span> <span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>OccName</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprOccName</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>            <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPrimTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConPrimRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimRep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>             <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppTyCon</span><span class='hs-layout'>,</span>
<a name="line-28"></a>                          <span class='hs-varid'>typePrimRep</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityDirection</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TupleSort</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>CLabelString</span> <span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPrimOpIdUnique</span> <span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastTypes</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>PackageId</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[PrimOp-datatype]{Datatype for @PrimOp@ (an enumeration)}
%*                                                                      *
%************************************************************************

These are in \tr{state-interface.verb} order.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-comment'>-- supplies:</span>
<a name="line-3"></a><span class='hs-comment'>-- data PrimOp = ...</span>
<a name="line-4"></a><span class='hs-cpp'>#include "primop-data-decl.hs-incl"</span>
</pre>\end{code}

Used for the Ord instance

\begin{code}
<pre><a name="line-1"></a><a name="primOpTag"></a><span class='hs-definition'>primOpTag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2"></a><span class='hs-definition'>primOpTag</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iBox</span> <span class='hs-layout'>(</span><span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- supplies</span>
<a name="line-5"></a><span class='hs-comment'>-- tagOf_PrimOp :: PrimOp -&gt; FastInt</span>
<a name="line-6"></a><span class='hs-cpp'>#include "primop-tag.hs-incl"</span>
<a name="line-7"></a><a name="tagOf_PrimOp"></a><span class='hs-definition'>tagOf_PrimOp</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"tagOf_PrimOp: unknown primop"</span>
<a name="line-8"></a>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>==#</span> <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op2</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span>  <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;#</span> <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op2</span>
<a name="line-15"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;=#</span> <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op2</span>
<a name="line-16"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;=#</span> <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op2</span>
<a name="line-17"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;</span>  <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&gt;#</span> <span class='hs-varid'>tagOf_PrimOp</span> <span class='hs-varid'>op2</span>
<a name="line-18"></a>    <span class='hs-varid'>op1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>op2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-19"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-20"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrimOp</span> <span class='hs-varid'>op</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="PrimOpVecCat"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpVecCat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IntVec</span>
<a name="line-2"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WordVec</span>
<a name="line-3"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FloatVec</span>
</pre>\end{code}

An @Enum@-derived list would be better; meanwhile... (ToDo)

\begin{code}
<pre><a name="line-1"></a><a name="allThePrimOps"></a><span class='hs-definition'>allThePrimOps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PrimOp</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>allThePrimOps</span> <span class='hs-keyglyph'>=</span>
<a name="line-3"></a><span class='hs-cpp'>#include "primop-list.hs-incl"</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="tagToEnumKey"></a><span class='hs-definition'>tagToEnumKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span>
<a name="line-2"></a><span class='hs-definition'>tagToEnumKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimOpIdUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpTag</span> <span class='hs-conid'>TagToEnumOp</span><span class='hs-layout'>)</span>
</pre>\end{code}



%************************************************************************
%*                                                                      *
\subsection[PrimOp-info]{The essential info about each @PrimOp@}
%*                                                                      *
%************************************************************************

The @String@ in the @PrimOpInfos@ is the ``base name'' by which the user may
refer to the primitive operation.  The conventional \tr{#}-for-
unboxed ops is added on later.

The reason for the funny characters in the names is so we do not
interfere with the programmer's Haskell name spaces.

We use @PrimKinds@ for the ``type'' information, because they're
(slightly) more convenient to use than @TyCons@.
\begin{code}
<pre><a name="line-1"></a><a name="PrimOpInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dyadic</span>      <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: T -&gt; T -&gt; T</span>
<a name="line-3"></a>                <span class='hs-conid'>Type</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Monadic</span>     <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: T -&gt; T</span>
<a name="line-5"></a>                <span class='hs-conid'>Type</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Compare</span>     <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: T -&gt; T -&gt; Int#</span>
<a name="line-7"></a>                <span class='hs-conid'>Type</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GenPrimOp</span>   <span class='hs-conid'>OccName</span>         <span class='hs-comment'>-- string :: \/a1..an . T1 -&gt; .. -&gt; Tk -&gt; T</span>
<a name="line-9"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a>                <span class='hs-conid'>Type</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="mkDyadic"></a><span class='hs-definition'>mkDyadic</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkMonadic</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCompare</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-14"></a><span class='hs-definition'>mkDyadic</span> <span class='hs-varid'>str</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dyadic</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-15"></a><a name="mkMonadic"></a><span class='hs-definition'>mkMonadic</span> <span class='hs-varid'>str</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Monadic</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-16"></a><a name="mkCompare"></a><span class='hs-definition'>mkCompare</span> <span class='hs-varid'>str</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="mkGenPrimOp"></a><span class='hs-definition'>mkGenPrimOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-19"></a><span class='hs-definition'>mkGenPrimOp</span> <span class='hs-varid'>str</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenPrimOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{Strictness}
%*                                                                      *
%************************************************************************

Not all primops are strict!

\begin{code}
<pre><a name="line-1"></a><a name="primOpStrictness"></a><span class='hs-definition'>primOpStrictness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-2"></a>        <span class='hs-comment'>-- See Demand.StrictnessInfo for discussion of what the results</span>
<a name="line-3"></a>        <span class='hs-comment'>-- The arity should be the arity of the primop; that's why</span>
<a name="line-4"></a>        <span class='hs-comment'>-- this function isn't exported.</span>
<a name="line-5"></a><span class='hs-cpp'>#include "primop-strictness.hs-incl"</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{Fixity}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="primOpFixity"></a><span class='hs-definition'>primOpFixity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fixity</span>
<a name="line-2"></a><span class='hs-cpp'>#include "primop-fixity.hs-incl"</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection[PrimOp-comparison]{PrimOpInfo basic comparison ops}
%*                                                                      *
%************************************************************************

@primOpInfo@ gives all essential information (from which everything
else, notably a type, can be constructed) for each @PrimOp@.

\begin{code}
<pre><a name="line-1"></a><a name="primOpInfo"></a><span class='hs-definition'>primOpInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpInfo</span>
<a name="line-2"></a><span class='hs-cpp'>#include "primop-primop-info.hs-incl"</span>
<a name="line-3"></a><span class='hs-definition'>primOpInfo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"primOpInfo: unknown primop"</span>
</pre>\end{code}

Here are a load of comments from the old primOp info:

A @Word#@ is an unsigned @Int#@.

@decodeFloat#@ is given w/ Integer-stuff (it's similar).

@decodeDouble#@ is given w/ Integer-stuff (it's similar).

Decoding of floating-point numbers is sorta Integer-related.  Encoding
is done with plain ccalls now (see PrelNumExtra.lhs).

A @Weak@ Pointer is created by the @mkWeak#@ primitive:

        mkWeak# :: k -> v -> f -> State# RealWorld
                        -> (# State# RealWorld, Weak# v #)

In practice, you'll use the higher-level

        data Weak v = Weak# v
        mkWeak :: k -> v -> IO () -> IO (Weak v)

The following operation dereferences a weak pointer.  The weak pointer
may have been finalized, so the operation returns a result code which
must be inspected before looking at the dereferenced value.

        deRefWeak# :: Weak# v -> State# RealWorld ->
                        (# State# RealWorld, v, Int# #)

Only look at v if the Int# returned is /= 0 !!

The higher-level op is

        deRefWeak :: Weak v -> IO (Maybe v)

Weak pointers can be finalized early by using the finalize# operation:

        finalizeWeak# :: Weak# v -> State# RealWorld ->
                           (# State# RealWorld, Int#, IO () #)

The Int# returned is either

        0 if the weak pointer has already been finalized, or it has no
          finalizer (the third component is then invalid).

        1 if the weak pointer is still alive, with the finalizer returned
          as the third component.

A {\em stable name/pointer} is an index into a table of stable name
entries.  Since the garbage collector is told about stable pointers,
it is safe to pass a stable pointer to external systems such as C
routines.

\begin{verbatim}
makeStablePtr#  :: a -> State# RealWorld -> (# State# RealWorld, StablePtr# a #)
freeStablePtr   :: StablePtr# a -> State# RealWorld -> State# RealWorld
deRefStablePtr# :: StablePtr# a -> State# RealWorld -> (# State# RealWorld, a #)
eqStablePtr#    :: StablePtr# a -> StablePtr# a -> Int#
\end{verbatim}

It may seem a bit surprising that @makeStablePtr#@ is a @IO@
operation since it doesn't (directly) involve IO operations.  The
reason is that if some optimisation pass decided to duplicate calls to
@makeStablePtr#@ and we only pass one of the stable pointers over, a
massive space leak can result.  Putting it into the IO monad
prevents this.  (Another reason for putting them in a monad is to
ensure correct sequencing wrt the side-effecting @freeStablePtr@
operation.)

An important property of stable pointers is that if you call
makeStablePtr# twice on the same object you get the same stable
pointer back.

Note that we can implement @freeStablePtr#@ using @_ccall_@ (and,
besides, it's not likely to be used from Haskell) so it's not a
primop.

Question: Why @RealWorld@ - won't any instance of @_ST@ do the job? [ADR]

Stable Names
~~~~~~~~~~~~

A stable name is like a stable pointer, but with three important differences:

        (a) You can't deRef one to get back to the original object.
        (b) You can convert one to an Int.
        (c) You don't need to 'freeStableName'

The existence of a stable name doesn't guarantee to keep the object it
points to alive (unlike a stable pointer), hence (a).

Invariants:

        (a) makeStableName always returns the same value for a given
            object (same as stable pointers).

        (b) if two stable names are equal, it implies that the objects
            from which they were created were the same.

        (c) stableNameToInt always returns the same Int for a given
            stable name.


-- HWL: The first 4 Int# in all par... annotations denote:
--   name, granularity info, size of result, degree of parallelism
--      Same  structure as _seq_ i.e. returns Int#
-- KSW: v, the second arg in parAt# and parAtForNow#, is used only to determine
--   `the processor containing the expression v'; it is not evaluated

These primops are pretty weird.

        dataToTag# :: a -> Int    (arg must be an evaluated data type)
        tagToEnum# :: Int -> a    (result type must be an enumerated type)

The constraints aren't currently checked by the front end, but the
code generator will fall over if they aren't satisfied.

%************************************************************************
%*                                                                      *
            Which PrimOps are out-of-line
%*                                                                      *
%************************************************************************

Some PrimOps need to be called out-of-line because they either need to
perform a heap check or they block.


\begin{code}
<pre><a name="line-1"></a><a name="primOpOutOfLine"></a><span class='hs-definition'>primOpOutOfLine</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-cpp'>#include "primop-out-of-line.hs-incl"</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
            Failure and side effects
%*                                                                      *
%************************************************************************

Note [PrimOp can_fail and has_side_effects]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Both can_fail and has_side_effects mean that the primop has
some effect that is not captured entirely by its result value.

   ----------  has_side_effects ---------------------
   Has some imperative side effect, perhaps on the world (I/O),
   or perhaps on some mutable data structure (writeIORef).
   Generally speaking all such primops have a type like
      State -> input -> (State, output)
   so the state token guarantees ordering, and also ensures
   that the primop is executed even if 'output' is discarded.

   ----------  can_fail ----------------------------
   Can fail with a seg-fault or divide-by-zero error on some elements
   of its input domain.  Main examples:
      division (fails on zero demoninator
      array indexing (fails if the index is out of bounds)
   However (ASSUMPTION), these can_fail primops are ALWAYS surrounded
   with a test that checks for the bad cases.  

Consequences:

* You can discard a can_fail primop, or float it _inwards_.
  But you cannot float it _outwards_, lest you escape the
  dynamic scope of the test.  Example:
      case d ># 0# of
        True  -> case x /# d of r -> r +# 1
        False -> 0
  Here we must not float the case outwards to give
      case x/# d of r ->
      case d ># 0# of
        True  -> r +# 1
        False -> 0

* I believe that exactly the same rules apply to a has_side_effects
  primop; you can discard it (remember, the state token will keep
  it alive if necessary), or float it in, but not float it out.

  Example of the latter
       if blah then let! s1 = writeMutVar s0 v True in s1
               else s0
  Notice that s0 is mentioned in both branches of the 'if', but 
  only one of these two will actually be consumed.  But if we
  float out to
      let! s1 = writeMutVar s0 v True
      in if blah then s1 else s0
  the writeMutVar will be performed in both branches, which is
  utterly wrong.

* You cannot duplicate a has_side_effect primop.  You might wonder
  how this can occur given the state token threading, but just look
  at Control.Monad.ST.Lazy.Imp.strictToLazy!  We get something like
  this
        p = case readMutVar# s v of
              (# s', r #) -> (S# s', r)
        s' = case p of (s', r) -> s'
        r  = case p of (s', r) -> r

  (All these bindings are boxed.)  If we inline p at its two call
  sites, we get a catastrophe: because the read is performed once when
  s' is demanded, and once when 'r' is demanded, which may be much 
  later.  Utterly wrong.  Trac #3207 is real example of this happening.

  However, it's fine to duplicate a can_fail primop.  That is
  the difference between can_fail and has_side_effects.

            can_fail     has_side_effects
Discard        YES           YES
Float in       YES           YES
Float out      NO            NO
Duplicate      YES           NO

How do we achieve these effects?

Note [primOpOkForSpeculation]
  * The "no-float-out" thing is achieved by ensuring that we never
    let-bind a can_fail or has_side_effects primop.  The RHS of a
    let-binding (which can float in and out freely) satisfies
    exprOkForSpeculation.  And exprOkForSpeculation is false of
    can_fail and no_side_effect.

  * So can_fail and no_side_effect primops will appear only as the
    scrutinees of cases, and that's why the FloatIn pass is capable
    of floating case bindings inwards.

  * The no-duplicate thing is done via primOpIsCheap, by making
    has_side_effects things (very very very) not-cheap!


\begin{code}
<pre><a name="line-1"></a><a name="primOpHasSideEffects"></a><span class='hs-definition'>primOpHasSideEffects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-cpp'>#include "primop-has-side-effects.hs-incl"</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="primOpCanFail"></a><span class='hs-definition'>primOpCanFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a><span class='hs-cpp'>#include "primop-can-fail.hs-incl"</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="primOpOkForSpeculation"></a><span class='hs-definition'>primOpOkForSpeculation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-8"></a>  <span class='hs-comment'>-- See Note [primOpOkForSpeculation and primOpOkForFloatOut]</span>
<a name="line-9"></a>  <span class='hs-comment'>-- See comments with CoreUtils.exprOkForSpeculation</span>
<a name="line-10"></a><span class='hs-definition'>primOpOkForSpeculation</span> <span class='hs-varid'>op</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpHasSideEffects</span> <span class='hs-varid'>op</span> <span class='hs-varop'>||</span> <span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>op</span> <span class='hs-varop'>||</span> <span class='hs-varid'>primOpCanFail</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="primOpOkForSideEffects"></a><span class='hs-definition'>primOpOkForSideEffects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-14"></a><span class='hs-definition'>primOpOkForSideEffects</span> <span class='hs-varid'>op</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpHasSideEffects</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
</pre>\end{code}


Note [primOpIsCheap]
~~~~~~~~~~~~~~~~~~~~
@primOpIsCheap@, as used in \tr{SimplUtils.lhs}.  For now (HACK
WARNING), we just borrow some other predicates for a
what-should-be-good-enough test.  "Cheap" means willing to call it more
than once, and/or push it inside a lambda.  The latter could change the
behaviour of 'seq' for primops that can fail, so we don't treat them as cheap.

\begin{code}
<pre><a name="line-1"></a><a name="primOpIsCheap"></a><span class='hs-definition'>primOpIsCheap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>primOpIsCheap</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>primOpOkForSpeculation</span> <span class='hs-varid'>op</span>
<a name="line-3"></a><span class='hs-comment'>-- In March 2001, we changed this to</span>
<a name="line-4"></a><span class='hs-comment'>--      primOpIsCheap op = False</span>
<a name="line-5"></a><span class='hs-comment'>-- thereby making *no* primops seem cheap.  But this killed eta</span>
<a name="line-6"></a><span class='hs-comment'>-- expansion on case (x ==# y) of True -&gt; \s -&gt; ...</span>
<a name="line-7"></a><span class='hs-comment'>-- which is bad.  In particular a loop like</span>
<a name="line-8"></a><span class='hs-comment'>--      doLoop n = loop 0</span>
<a name="line-9"></a><span class='hs-comment'>--     where</span>
<a name="line-10"></a><span class='hs-comment'>--         loop i | i == n    = return ()</span>
<a name="line-11"></a><span class='hs-comment'>--                | otherwise = bar i &gt;&gt; loop (i+1)</span>
<a name="line-12"></a><span class='hs-comment'>-- allocated a closure every time round because it doesn't eta expand.</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- The problem that originally gave rise to the change was</span>
<a name="line-15"></a><span class='hs-comment'>--      let x = a +# b *# c in x +# x</span>
<a name="line-16"></a><span class='hs-comment'>-- were we don't want to inline x. But primopIsCheap doesn't control</span>
<a name="line-17"></a><span class='hs-comment'>-- that (it's exprIsDupable that does) so the problem doesn't occur</span>
<a name="line-18"></a><span class='hs-comment'>-- even if primOpIsCheap sometimes says 'True'.</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
               PrimOp code size
%*                                                                      *
%************************************************************************

primOpCodeSize
~~~~~~~~~~~~~~
Gives an indication of the code size of a primop, for the purposes of
calculating unfolding sizes; see CoreUnfold.sizeExpr.

\begin{code}
<pre><a name="line-1"></a><a name="primOpCodeSize"></a><span class='hs-definition'>primOpCodeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2"></a><span class='hs-cpp'>#include "primop-code-size.hs-incl"</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="primOpCodeSizeDefault"></a><span class='hs-definition'>primOpCodeSizeDefault</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-5"></a><span class='hs-definition'>primOpCodeSizeDefault</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-6"></a>  <span class='hs-comment'>-- CoreUnfold.primOpSize already takes into account primOpOutOfLine</span>
<a name="line-7"></a>  <span class='hs-comment'>-- and adds some further costs for the args in that case.</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="primOpCodeSizeForeignCall"></a><span class='hs-definition'>primOpCodeSizeForeignCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-10"></a><span class='hs-definition'>primOpCodeSizeForeignCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
               PrimOp types
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="primOpType"></a><span class='hs-definition'>primOpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- you may want to use primOpSig instead</span>
<a name="line-2"></a><span class='hs-definition'>primOpType</span> <span class='hs-varid'>op</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>    <span class='hs-conid'>Dyadic</span>  <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dyadic_fun_ty</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a>    <span class='hs-conid'>Monadic</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>monadic_fun_ty</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>    <span class='hs-conid'>Compare</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>compare_fun_ty</span> <span class='hs-varid'>ty</span>
<a name="line-7"></a>
<a name="line-8"></a>    <span class='hs-conid'>GenPrimOp</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-9"></a>        <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="primOpOcc"></a><span class='hs-definition'>primOpOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-12"></a><span class='hs-definition'>primOpOcc</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-13"></a>               <span class='hs-conid'>Dyadic</span>    <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-14"></a>               <span class='hs-conid'>Monadic</span>   <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-15"></a>               <span class='hs-conid'>Compare</span>   <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-16"></a>               <span class='hs-conid'>GenPrimOp</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>-- primOpSig is like primOpType but gives the result split apart:</span>
<a name="line-19"></a><span class='hs-comment'>-- (type variables, argument types, result type)</span>
<a name="line-20"></a><span class='hs-comment'>-- It also gives arity, strictness info</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="primOpSig"></a><span class='hs-definition'>primOpSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictSig</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-definition'>primOpSig</span> <span class='hs-varid'>op</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpStrictness</span> <span class='hs-varid'>op</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span>
<a name="line-27"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-28"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-29"></a>        <span class='hs-conid'>Monadic</span>   <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-varid'>ty</span>       <span class='hs-layout'>)</span>
<a name="line-30"></a>        <span class='hs-conid'>Dyadic</span>    <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span>       <span class='hs-layout'>)</span>
<a name="line-31"></a>        <span class='hs-conid'>Compare</span>   <span class='hs-sel'>_occ</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>intPrimTy</span><span class='hs-layout'>)</span>
<a name="line-32"></a>        <span class='hs-conid'>GenPrimOp</span> <span class='hs-sel'>_occ</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span>   <span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="PrimOpResultInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimOpResultInfo</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReturnsPrim</span>     <span class='hs-conid'>PrimRep</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ReturnsAlg</span>      <span class='hs-conid'>TyCon</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>-- Some PrimOps need not return a manifest primitive or algebraic value</span>
<a name="line-6"></a><span class='hs-comment'>-- (i.e. they might return a polymorphic value).  These PrimOps *must*</span>
<a name="line-7"></a><span class='hs-comment'>-- be out of line, or the code generator won't work.</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="getPrimOpResultInfo"></a><span class='hs-definition'>getPrimOpResultInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimOpResultInfo</span>
<a name="line-10"></a><span class='hs-definition'>getPrimOpResultInfo</span> <span class='hs-varid'>op</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpInfo</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>      <span class='hs-conid'>Dyadic</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>typePrimRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-13"></a>      <span class='hs-conid'>Monadic</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>typePrimRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-14"></a>      <span class='hs-conid'>Compare</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep</span> <span class='hs-varid'>intPrimTyCon</span><span class='hs-layout'>)</span>
<a name="line-15"></a>      <span class='hs-conid'>GenPrimOp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReturnsAlg</span> <span class='hs-varid'>tc</span>
<a name="line-17"></a>                         <span class='hs-keyword'>where</span>
<a name="line-18"></a>                           <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-19"></a>                        <span class='hs-comment'>-- All primops return a tycon-app result</span>
<a name="line-20"></a>                        <span class='hs-comment'>-- The tycon can be an unboxed tuple, though, which</span>
<a name="line-21"></a>                        <span class='hs-comment'>-- gives rise to a ReturnAlg</span>
</pre>\end{code}

We do not currently make use of whether primops are commutable.

We used to try to move constants to the right hand side for strength
reduction.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>commutableOp :: PrimOp -&gt; Bool
<a name="line-3"></a>#include "primop-commutable.hs-incl"
<a name="line-4"></a>-}</span>
</pre>\end{code}

Utils:
\begin{code}
<pre><a name="line-1"></a><a name="dyadic_fun_ty"></a><span class='hs-definition'>dyadic_fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>monadic_fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>compare_fun_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>dyadic_fun_ty</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a><a name="monadic_fun_ty"></a><span class='hs-definition'>monadic_fun_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTy</span>  <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-4"></a><a name="compare_fun_ty"></a><span class='hs-definition'>compare_fun_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>intPrimTy</span>
</pre>\end{code}

Output stuff:
\begin{code}
<pre><a name="line-1"></a><a name="pprPrimOp"></a><span class='hs-definition'>pprPrimOp</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>pprPrimOp</span> <span class='hs-varid'>other_op</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOcc</span> <span class='hs-varid'>other_op</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsubsection[PrimCall]{User-imported primitive calls}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="PrimCall"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PrimCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrimCall</span> <span class='hs-conid'>CLabelString</span> <span class='hs-conid'>PackageId</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PrimCall</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimCall</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>pkgId</span><span class='hs-layout'>)</span>
<a name="line-5"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"__primcall"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pkgId</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>lbl</span>
<a name="line-6"></a>
</pre>\end{code}
</body>
</html>
