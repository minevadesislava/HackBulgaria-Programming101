<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/FamInstEnv.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
%

FamInstEnv: Type checked family instance declarations

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE GADTs #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-layout'>(</span>
<a name="line-5"></a>        <span class='hs-conid'>FamInst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamFlavor</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInstAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInstTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInstRHS</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>famInstsRepTyCons</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInstRepTyCon_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataFamInstRepTyCon</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-varid'>pprFamInst</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprFamInstHdr</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprFamInsts</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-varid'>mkImportedFamInst</span><span class='hs-layout'>,</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-conid'>FamInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFamInstEnvs</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>extendFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>deleteFromFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendFamInstEnvList</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>identicalFamInst</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInstEnvElts</span><span class='hs-layout'>,</span> <span class='hs-varid'>familyInstances</span><span class='hs-layout'>,</span> <span class='hs-varid'>orphNamesOfFamInst</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-comment'>-- * CoAxioms</span>
<a name="line-15"></a>        <span class='hs-varid'>mkCoAxBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkBranchedCoAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedCoAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSingleCoAxiom</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>computeAxiomIncomps</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-conid'>FamInstMatch</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>lookupFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupFamInstEnvConflicts</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-varid'>isDominatedBy</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- Normalisation</span>
<a name="line-24"></a>        <span class='hs-varid'>instNewTyConTF_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>chooseBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>topNormaliseType</span><span class='hs-layout'>,</span> <span class='hs-varid'>topNormaliseType_maybe</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>normaliseType</span><span class='hs-layout'>,</span> <span class='hs-varid'>normaliseTcApp</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-comment'>-- Flattening</span>
<a name="line-28"></a>        <span class='hs-varid'>flattenTys</span>
<a name="line-29"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span> <span class='hs-layout'>(</span> <span class='hs-varid'>orphNamesOfTypes</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span><span class='hs-layout'>(</span> <span class='hs-varid'>isInteractiveModule</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
          Type checked family instance heads
%*                                                                      *
%************************************************************************

Note [FamInsts and CoAxioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* CoAxioms and FamInsts are just like
  DFunIds  and ClsInsts

* A CoAxiom is a System-FC thing: it can relate any two types

* A FamInst is a Haskell source-language thing, corresponding
  to a type/data family instance declaration.
    - The FamInst contains a CoAxiom, which is the evidence
      for the instance

    - The LHS of the CoAxiom is always of form F ty1 .. tyn
      where F is a type family

\begin{code}
<pre><a name="line-1"></a><a name="FamInst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FamInst</span>  <span class='hs-comment'>-- See Note [FamInsts and CoAxioms]</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>  <span class='hs-comment'>-- The new coercion axiom introduced</span>
<a name="line-3"></a>                                               <span class='hs-comment'>-- by this family instance</span>
<a name="line-4"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>fi_flavor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamFlavor</span>
<a name="line-5"></a>
<a name="line-6"></a>            <span class='hs-comment'>-- Everything below here is a redundant,</span>
<a name="line-7"></a>            <span class='hs-comment'>-- cached version of the two things above</span>
<a name="line-8"></a>            <span class='hs-comment'>-- except that the TyVars are freshened</span>
<a name="line-9"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>fi_fam</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>          <span class='hs-comment'>-- Family name</span>
<a name="line-10"></a>
<a name="line-11"></a>                <span class='hs-comment'>-- Used for "rough matching"; same idea as for class instances</span>
<a name="line-12"></a>                <span class='hs-comment'>-- See Note [Rough-match field] in InstEnv</span>
<a name="line-13"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tcs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Top of type args</span>
<a name="line-14"></a>                <span class='hs-comment'>-- INVARIANT: fi_tcs = roughMatchTcs fi_tys</span>
<a name="line-15"></a>
<a name="line-16"></a>                <span class='hs-comment'>-- Used for "proper matching"; ditto</span>
<a name="line-17"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tvs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Template tyvars for full match</span>
<a name="line-18"></a>                                 <span class='hs-comment'>-- Like ClsInsts, these variables are always</span>
<a name="line-19"></a>                                 <span class='hs-comment'>-- fresh. See Note [Template tyvars are fresh]</span>
<a name="line-20"></a>                                 <span class='hs-comment'>-- in InstEnv</span>
<a name="line-21"></a>
<a name="line-22"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tys</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>--   and its arg types</span>
<a name="line-23"></a>                <span class='hs-comment'>-- INVARIANT: fi_tvs = coAxiomTyVars fi_axiom</span>
<a name="line-24"></a>
<a name="line-25"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>fi_rhs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span>         <span class='hs-comment'>--   the RHS, with its freshened vars</span>
<a name="line-26"></a>            <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="FamFlavor"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FamFlavor</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SynFamilyInst</span>         <span class='hs-comment'>-- A synonym family</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataFamilyInst</span> <span class='hs-conid'>TyCon</span>  <span class='hs-comment'>-- A data family, with its representation TyCon</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="famInstAxiom"></a><span class='hs-comment'>-- Obtain the axiom of a family instance</span>
<a name="line-2"></a><span class='hs-definition'>famInstAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-3"></a><span class='hs-definition'>famInstAxiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fi_axiom</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="famInstSplitLHS"></a><span class='hs-comment'>-- Split the left-hand side of the FamInst</span>
<a name="line-6"></a><span class='hs-definition'>famInstSplitLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>famInstSplitLHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="famInstRHS"></a><span class='hs-comment'>-- Get the RHS of the FamInst</span>
<a name="line-11"></a><span class='hs-definition'>famInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-12"></a><span class='hs-definition'>famInstRHS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fi_rhs</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="famInstTyCon"></a><span class='hs-comment'>-- Get the family TyCon of the FamInst</span>
<a name="line-15"></a><span class='hs-definition'>famInstTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-16"></a><span class='hs-definition'>famInstTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varop'>.</span> <span class='hs-varid'>famInstAxiom</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="famInstsRepTyCons"></a><span class='hs-comment'>-- Return the representation TyCons introduced by data family instances, if any</span>
<a name="line-19"></a><span class='hs-definition'>famInstsRepTyCons</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a><span class='hs-definition'>famInstsRepTyCons</span> <span class='hs-varid'>fis</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fis</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="famInstRepTyCon_maybe"></a><span class='hs-comment'>-- Extracts the TyCon for this *data* (or newtype) instance</span>
<a name="line-23"></a><span class='hs-definition'>famInstRepTyCon_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCon</span>
<a name="line-24"></a><span class='hs-definition'>famInstRepTyCon_maybe</span> <span class='hs-varid'>fi</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fi_flavor</span> <span class='hs-varid'>fi</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>       <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tycon</span>
<a name="line-27"></a>       <span class='hs-conid'>SynFamilyInst</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="dataFamInstRepTyCon"></a><span class='hs-definition'>dataFamInstRepTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-30"></a><span class='hs-definition'>dataFamInstRepTyCon</span> <span class='hs-varid'>fi</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fi_flavor</span> <span class='hs-varid'>fi</span> <span class='hs-keyword'>of</span>
<a name="line-32"></a>       <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tycon</span>
<a name="line-33"></a>       <span class='hs-conid'>SynFamilyInst</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dataFamInstRepTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fi</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Pretty printing
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>   <span class='hs-varid'>getName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fi_axiom</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>   <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprFamInst</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="pprFamInst"></a><span class='hs-comment'>-- Prints the FamInst as a family instance declaration</span>
<a name="line-8"></a><span class='hs-definition'>pprFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-9"></a><span class='hs-definition'>pprFamInst</span> <span class='hs-varid'>famInst</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprFamInstHdr</span> <span class='hs-varid'>famInst</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Coercion axiom:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-12"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"RHS:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>famInstRHS</span> <span class='hs-varid'>famInst</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"--"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprDefinedAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>famInst</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-varid'>famInst</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="pprFamInstHdr"></a><span class='hs-definition'>pprFamInstHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-18"></a><span class='hs-definition'>pprFamInstHdr</span> <span class='hs-varid'>fi</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span><span class='hs-varid'>fi_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyConSort</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_instance</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_head</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-comment'>-- For *associated* types, say "type T Int = blah"</span>
<a name="line-22"></a>    <span class='hs-comment'>-- For *top level* type instances, say "type instance T Int = blah"</span>
<a name="line-23"></a>    <span class='hs-varid'>pp_instance</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyConAssoc</span> <span class='hs-varid'>fam_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-25"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instance"</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>etad_lhs_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstSplitLHS</span> <span class='hs-varid'>fi</span>
<a name="line-28"></a>    <span class='hs-varid'>vanilla_pp_head</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>etad_lhs_tys</span>
<a name="line-29"></a>
<a name="line-30"></a>    <span class='hs-varid'>pp_head</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flavor</span>
<a name="line-31"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>rep_tc</span>
<a name="line-32"></a>            <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>extra_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>etad_lhs_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-33"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>extra_tvs</span><span class='hs-layout'>)</span>
<a name="line-34"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-35"></a>              <span class='hs-keyword'>if</span> <span class='hs-varid'>debugStyle</span> <span class='hs-varid'>sty</span>
<a name="line-36"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>vanilla_pp_head</span>   <span class='hs-comment'>-- With -dppr-debug just show it as-is</span>
<a name="line-37"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>etad_lhs_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>extra_tvs</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                     <span class='hs-comment'>-- Without -dppr-debug, eta-expand</span>
<a name="line-39"></a>                     <span class='hs-comment'>-- See Trac #8674</span>
<a name="line-40"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-41"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanilla_pp_head</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>pprTyConSort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flavor</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>                     <span class='hs-conid'>SynFamilyInst</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                     <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>tycon</span>
<a name="line-46"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataTyCon</span>     <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"data"</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span>      <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"newtype"</span><span class='hs-layout'>)</span>
<a name="line-48"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"data"</span><span class='hs-layout'>)</span>
<a name="line-49"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"WEIRD"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="pprFamInsts"></a><span class='hs-definition'>pprFamInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-52"></a><span class='hs-definition'>pprFamInsts</span> <span class='hs-varid'>finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprFamInst</span> <span class='hs-varid'>finsts</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Lazy axiom match]
~~~~~~~~~~~~~~~~~~~~~~~
It is Vitally Important that mkImportedFamInst is *lazy* in its axiom
parameter. The axiom is loaded lazily, via a forkM, in TcIface. Sometime
later, mkImportedFamInst is called using that axiom. However, the axiom
may itself depend on entities which are not yet loaded as of the time
of the mkImportedFamInst. Thus, if mkImportedFamInst eagerly looks at the
axiom, a dependency loop spontaneously appears and GHC hangs. The solution
is simply for mkImportedFamInst never, ever to look inside of the axiom
until everything else is good and ready to do so. We can assume that this
readiness has been achieved when some other code pulls on the axiom in the
FamInst. Thus, we pattern match on the axiom lazily (in the where clause,
not in the parameter list) and we assert the consistency of names there
also.

\begin{code}
<pre><a name="line-1"></a><a name="mkImportedFamInst"></a><span class='hs-comment'>-- Make a family instance representation from the information found in an</span>
<a name="line-2"></a><span class='hs-comment'>-- interface file.  In particular, we get the rough match info from the iface</span>
<a name="line-3"></a><span class='hs-comment'>-- (instead of computing it here).</span>
<a name="line-4"></a><span class='hs-definition'>mkImportedFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>               <span class='hs-comment'>-- Name of the family</span>
<a name="line-5"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Rough match info</span>
<a name="line-6"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-comment'>-- Axiom introduced</span>
<a name="line-7"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span>            <span class='hs-comment'>-- Resulting family instance</span>
<a name="line-8"></a><span class='hs-definition'>mkImportedFamInst</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>mb_tcs</span> <span class='hs-varid'>axiom</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span>
<a name="line-10"></a>      <span class='hs-varid'>fi_fam</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span><span class='hs-layout'>,</span>
<a name="line-11"></a>      <span class='hs-varid'>fi_tcs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>,</span>
<a name="line-12"></a>      <span class='hs-varid'>fi_tvs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span>
<a name="line-13"></a>      <span class='hs-varid'>fi_tys</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span>
<a name="line-14"></a>      <span class='hs-varid'>fi_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-15"></a>      <span class='hs-varid'>fi_axiom</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>,</span>
<a name="line-16"></a>      <span class='hs-varid'>fi_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>     <span class='hs-comment'>-- See Note [Lazy axiom match]</span>
<a name="line-19"></a>     <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span>
<a name="line-20"></a>       <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-21"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-22"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>axiom</span>
<a name="line-23"></a>
<a name="line-24"></a>         <span class='hs-comment'>-- Derive the flavor for an imported FamInst rather disgustingly</span>
<a name="line-25"></a>         <span class='hs-comment'>-- Maybe we should store it in the IfaceFamInst?</span>
<a name="line-26"></a>     <span class='hs-varid'>flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>of</span>
<a name="line-27"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-28"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ax'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-29"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ax'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>axiom</span>
<a name="line-30"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataFamilyInst</span> <span class='hs-varid'>tc</span>
<a name="line-31"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SynFamilyInst</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                FamInstEnv
%*                                                                      *
%************************************************************************

Note [FamInstEnv]
~~~~~~~~~~~~~~~~~
A FamInstEnv maps a family name to the list of known instances for that family.

The same FamInstEnv includes both 'data family' and 'type family' instances.
Type families are reduced during type inference, but not data families;
the user explains when to use a data family instance by using contructors
and pattern matching.

Neverthless it is still useful to have data families in the FamInstEnv:

 - For finding overlaps and conflicts

 - For finding the representation type...see FamInstEnv.topNormaliseType
   and its call site in Simplify

 - In standalone deriving instance Eq (T [Int]) we need to find the
   representation type for T [Int]

Note [Varying number of patterns for data family axioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For data families, the number of patterns may vary between instances.
For example
   data family T a b
   data instance T Int a = T1 a | T2
   data instance T Bool [a] = T3 a

Then we get a data type for each instance, and an axiom:
   data TInt a = T1 a | T2
   data TBoolList a = T3 a

   axiom ax7   :: T Int ~ TInt   -- Eta-reduced
   axiom ax8 a :: T Bool [a] ~ TBoolList a

These two axioms for T, one with one pattern, one with two.  The reason
for this eta-reduction is decribed in TcInstDcls
   Note [Eta reduction for data family axioms]

\begin{code}
<pre><a name="line-1"></a><a name="FamInstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>FamilyInstEnv</span>  <span class='hs-comment'>-- Maps a family to its instances</span>
<a name="line-2"></a>     <span class='hs-comment'>-- See Note [FamInstEnv]</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="FamInstEnvs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-5"></a>     <span class='hs-comment'>-- External package inst-env, Home-package inst-env</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="FamilyInstEnv"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>FamilyInstEnv</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamIE</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- The instances for a particular family, in any order</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FamilyInstEnv</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"FamIE"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-comment'>-- INVARIANTS:</span>
<a name="line-14"></a><span class='hs-comment'>--  * The fs_tvs are distinct in each FamInst</span>
<a name="line-15"></a><span class='hs-comment'>--      of a range value of the map (so we can safely unify them)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="emptyFamInstEnvs"></a><span class='hs-definition'>emptyFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>emptyFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="emptyFamInstEnv"></a><span class='hs-definition'>emptyFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-21"></a><span class='hs-definition'>emptyFamInstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="famInstEnvElts"></a><span class='hs-definition'>famInstEnvElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span>
<a name="line-24"></a><span class='hs-definition'>famInstEnvElts</span> <span class='hs-varid'>fi</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>elt</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamIE</span> <span class='hs-varid'>elts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eltsUFM</span> <span class='hs-varid'>fi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>elts</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="familyInstances"></a><span class='hs-definition'>familyInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a><span class='hs-definition'>familyInstances</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_fie</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_fie</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get</span> <span class='hs-varid'>home_fie</span> <span class='hs-varop'>++</span> <span class='hs-varid'>get</span> <span class='hs-varid'>pkg_fie</span>
<a name="line-29"></a>  <span class='hs-keyword'>where</span>
<a name="line-30"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fam</span> <span class='hs-keyword'>of</span>
<a name="line-31"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>insts</span>
<a name="line-32"></a>                <span class='hs-conid'>Nothing</span>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="orphNamesOfFamInst"></a><span class='hs-comment'>-- | Collects the names of the concrete types and type constructors that</span>
<a name="line-35"></a><span class='hs-comment'>-- make up the LHS of a type family instance, including the family</span>
<a name="line-36"></a><span class='hs-comment'>-- name itself.</span>
<a name="line-37"></a><span class='hs-comment'>--</span>
<a name="line-38"></a><span class='hs-comment'>-- For instance, given `type family Foo a b`:</span>
<a name="line-39"></a><span class='hs-comment'>-- `type instance Foo (F (G (H a))) b = ...` would yield [Foo,F,G,H]</span>
<a name="line-40"></a><span class='hs-comment'>--</span>
<a name="line-41"></a><span class='hs-comment'>-- Used in the implementation of ":info" in GHCi.</span>
<a name="line-42"></a><span class='hs-definition'>orphNamesOfFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-43"></a><span class='hs-definition'>orphNamesOfFamInst</span> <span class='hs-varid'>fam_inst</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphNamesOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>brListMap</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>    <span class='hs-varop'>`addOneToNameSet`</span> <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyword'>where</span>
<a name="line-47"></a>    <span class='hs-varid'>axiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-varid'>fam_inst</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="extendFamInstEnvList"></a><span class='hs-definition'>extendFamInstEnvList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-50"></a><span class='hs-definition'>extendFamInstEnvList</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>fis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>extendFamInstEnv</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>fis</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="extendFamInstEnv"></a><span class='hs-definition'>extendFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-53"></a><span class='hs-definition'>extendFamInstEnv</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>ins_item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span><span class='hs-varid'>fi_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_nm</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_C</span> <span class='hs-varid'>add</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>cls_nm</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ins_item</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamIE</span> <span class='hs-layout'>(</span><span class='hs-varid'>ins_item</span><span class='hs-conop'>:</span><span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="deleteFromFamInstEnv"></a><span class='hs-definition'>deleteFromFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-59"></a><span class='hs-comment'>-- Used only for overriding in GHCi</span>
<a name="line-60"></a><span class='hs-definition'>deleteFromFamInstEnv</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>fam_inst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span><span class='hs-varid'>fi_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_nm</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-61"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>adjustUFM</span> <span class='hs-varid'>adjust</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>fam_nm</span>
<a name="line-62"></a> <span class='hs-keyword'>where</span>
<a name="line-63"></a>   <span class='hs-varid'>adjust</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamilyInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamilyInstEnv</span>
<a name="line-64"></a>   <span class='hs-varid'>adjust</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-65"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamIE</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>identicalFamInst</span> <span class='hs-varid'>fam_inst</span><span class='hs-layout'>)</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="identicalFamInst"></a><span class='hs-definition'>identicalFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-68"></a><span class='hs-comment'>-- Same LHS, *and* both instances are on the interactive command line</span>
<a name="line-69"></a><span class='hs-comment'>-- Used for overriding in GHCi</span>
<a name="line-70"></a><span class='hs-definition'>identicalFamInst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ax1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ax2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isInteractiveModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>ax1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-72"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isInteractiveModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>ax2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax2</span>
<a name="line-74"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>brListLength</span> <span class='hs-varid'>brs1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>brListLength</span> <span class='hs-varid'>brs2</span>
<a name="line-75"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>and</span> <span class='hs-layout'>(</span><span class='hs-varid'>brListZipWith</span> <span class='hs-varid'>identical_ax_branch</span> <span class='hs-varid'>brs1</span> <span class='hs-varid'>brs2</span><span class='hs-layout'>)</span>
<a name="line-76"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>brs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>ax1</span>
<a name="line-77"></a>        <span class='hs-varid'>brs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>ax2</span>
<a name="line-78"></a>        <span class='hs-varid'>identical_ax_branch</span> <span class='hs-varid'>br1</span> <span class='hs-varid'>br2</span>
<a name="line-79"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs2</span>
<a name="line-80"></a>            <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>lhs1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>lhs2</span>
<a name="line-81"></a>            <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>and</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>rn_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs1</span> <span class='hs-varid'>lhs2</span><span class='hs-layout'>)</span>
<a name="line-82"></a>          <span class='hs-keyword'>where</span>
<a name="line-83"></a>            <span class='hs-varid'>tvs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>br1</span>
<a name="line-84"></a>            <span class='hs-varid'>tvs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>br2</span>
<a name="line-85"></a>            <span class='hs-varid'>lhs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>br1</span>
<a name="line-86"></a>            <span class='hs-varid'>lhs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>br2</span>
<a name="line-87"></a>            <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBndrs2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>emptyInScopeSet</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>tvs2</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Compatibility
%*                                                                      *
%************************************************************************

Note [Apartness]
~~~~~~~~~~~~~~~~
In dealing with closed type families, we must be able to check that one type
will never reduce to another. This check is called /apartness/. The check
is always between a target (which may be an arbitrary type) and a pattern.
Here is how we do it:

apart(target, pattern) = not (unify(flatten(target), pattern))

where flatten (implemented in flattenTys, below) converts all type-family
applications into fresh variables. (See Note [Flattening].)

Note [Compatibility]
~~~~~~~~~~~~~~~~~~~~
Two patterns are /compatible/ if either of the following conditions hold:
1) The patterns are apart.
2) The patterns unify with a substitution S, and their right hand sides
equal under that substitution.

For open type families, only compatible instances are allowed. For closed
type families, the story is slightly more complicated. Consider the following:

type family F a where
  F Int = Bool
  F a   = Int

g :: Show a => a -> F a
g x = length (show x)

Should that type-check? No. We need to allow for the possibility that 'a'
might be Int and therefore 'F a' should be Bool. We can simplify 'F a' to Int
only when we can be sure that 'a' is not Int.

To achieve this, after finding a possible match within the equations, we have to
go back to all previous equations and check that, under the
substitution induced by the match, other branches are surely apart. (See
[Apartness].) This is similar to what happens with class
instance selection, when we need to guarantee that there is only a match and
no unifiers. The exact algorithm is different here because the the
potentially-overlapping group is closed.

As another example, consider this:

type family G x
type instance where
  G Int = Bool
  G a   = Double

type family H y
-- no instances

Now, we want to simplify (G (H Char)). We can't, because (H Char) might later
simplify to be Int. So, (G (H Char)) is stuck, for now.

While everything above is quite sound, it isn't as expressive as we'd like.
Consider this:

type family J a where
  J Int = Int
  J a   = a

Can we simplify (J b) to b? Sure we can. Yes, the first equation matches if
b is instantiated with Int, but the RHSs coincide there, so it's all OK.

So, the rule is this: when looking up a branch in a closed type family, we
find a branch that matches the target, but then we make sure that the target
is apart from every previous *incompatible* branch. We don't check the
branches that are compatible with the matching branch, because they are either
irrelevant (clause 1 of compatible) or benign (clause 2 of compatible).

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="compatibleBranches"></a><span class='hs-definition'>compatibleBranches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a><span class='hs-definition'>compatibleBranches</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-4"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcUnifyTysFG</span> <span class='hs-varid'>instanceBindFun</span> <span class='hs-varid'>lhs1</span> <span class='hs-varid'>lhs2</span> <span class='hs-keyword'>of</span>
<a name="line-6"></a>      <span class='hs-conid'>SurelyApart</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-7"></a>      <span class='hs-conid'>Unifiable</span> <span class='hs-varid'>subst</span>
<a name="line-8"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs2</span>
<a name="line-9"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-10"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="computeAxiomIncomps"></a><span class='hs-comment'>-- takes a CoAxiom with unknown branch incompatibilities and computes</span>
<a name="line-13"></a><span class='hs-comment'>-- the compatibilities</span>
<a name="line-14"></a><span class='hs-definition'>computeAxiomIncomps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span>
<a name="line-15"></a><span class='hs-definition'>computeAxiomIncomps</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ax</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchList</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-varid'>br</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>prev_branches</span> <span class='hs-layout'>(</span><span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span>
<a name="line-20"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>br</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_incomps</span> <span class='hs-varid'>br</span> <span class='hs-varid'>prev_branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>prev_branches</span> <span class='hs-layout'>(</span><span class='hs-conid'>NextBranch</span> <span class='hs-varid'>br</span> <span class='hs-varid'>tail</span><span class='hs-layout'>)</span>
<a name="line-22"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>br'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>br</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_incomps</span> <span class='hs-varid'>br</span> <span class='hs-varid'>prev_branches</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>in</span>
<a name="line-23"></a>        <span class='hs-conid'>NextBranch</span> <span class='hs-varid'>br'</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>br'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>prev_branches</span><span class='hs-layout'>)</span> <span class='hs-varid'>tail</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>mk_incomps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a>    <span class='hs-varid'>mk_incomps</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>compatibleBranches</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
           Constructing axioms
    These functions are here because tidyType / tcUnifyTysFG
    are not available in CoAxiom
%*                                                                      *
%************************************************************************

Note [Tidy axioms when we build them]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We print out axioms and don't want to print stuff like
    F k k a b = ...
Instead we must tidy those kind variables.  See Trac #7524.

\begin{code}
<pre><a name="line-1"></a><a name="mkCoAxBranch"></a><span class='hs-comment'>-- all axiom roles are Nominal, as this is only used with type families</span>
<a name="line-2"></a><span class='hs-definition'>mkCoAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- original, possibly stale, tyvars</span>
<a name="line-3"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- LHS patterns</span>
<a name="line-4"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>    <span class='hs-comment'>-- RHS</span>
<a name="line-5"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-6"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span>
<a name="line-7"></a><span class='hs-definition'>mkCoAxBranch</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>loc</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs1</span>
<a name="line-9"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lhs</span>
<a name="line-10"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs1</span>
<a name="line-11"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span>  <span class='hs-varid'>env</span> <span class='hs-varid'>rhs</span>
<a name="line-12"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_loc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-13"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderIncomps</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndrs</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>tvs</span>
<a name="line-16"></a>    <span class='hs-comment'>-- See Note [Tidy axioms when we build them]</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="mkBranchedCoAxiom"></a><span class='hs-comment'>-- all of the following code is here to avoid mutual dependencies with</span>
<a name="line-19"></a><span class='hs-comment'>-- Coercion</span>
<a name="line-20"></a><span class='hs-definition'>mkBranchedCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span>
<a name="line-21"></a><span class='hs-definition'>mkBranchedCoAxiom</span> <span class='hs-varid'>ax_name</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>branches</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>computeAxiomIncomps</span> <span class='hs-varop'>$</span>
<a name="line-23"></a>    <span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_unique</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>ax_name</span>
<a name="line-24"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ax_name</span>
<a name="line-25"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_tc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc</span>
<a name="line-26"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-27"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-28"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toBranchList</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="mkUnbranchedCoAxiom"></a><span class='hs-definition'>mkUnbranchedCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-31"></a><span class='hs-definition'>mkUnbranchedCoAxiom</span> <span class='hs-varid'>ax_name</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>branch</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_unique</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>ax_name</span>
<a name="line-33"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ax_name</span>
<a name="line-34"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_tc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc</span>
<a name="line-35"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-36"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-37"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>branch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="mkSingleCoAxiom"></a><span class='hs-definition'>mkSingleCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-40"></a><span class='hs-definition'>mkSingleCoAxiom</span> <span class='hs-varid'>ax_name</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs_tys</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_unique</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>ax_name</span>
<a name="line-42"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ax_name</span>
<a name="line-43"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_tc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc</span>
<a name="line-44"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-45"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-46"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>branch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>  <span class='hs-keyword'>where</span>
<a name="line-48"></a>    <span class='hs-varid'>branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoAxBranch</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>lhs_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>ax_name</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Looking up a family instance
%*                                                                      *
%************************************************************************

@lookupFamInstEnv@ looks up in a @FamInstEnv@, using a one-way match.
Multiple matches are only possible in case of type families (not data
families), and then, it doesn't matter which match we choose (as the
instances are guaranteed confluent).

We return the matching family instances and the type instance at which it
matches.  For example, if we lookup 'T [Int]' and have a family instance

  data instance T [a] = ..

desugared to

  data :R42T a = ..
  coe :Co:R42T a :: T [a] ~ :R42T a

we return the matching instance '(FamInst{.., fi_tycon = :R42T}, Int)'.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="FamInstMatch"></a><span class='hs-comment'>-- when matching a type family application, we get a FamInst,</span>
<a name="line-3"></a><a name="FamInstMatch"></a><span class='hs-comment'>-- and the list of types the axiom should be applied to</span>
<a name="line-4"></a><a name="FamInstMatch"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FamInstMatch</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamInstMatch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fim_instance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span>
<a name="line-5"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>fim_tys</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>                                 <span class='hs-layout'>}</span>
<a name="line-7"></a>  <span class='hs-comment'>-- See Note [Over-saturated matches]</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FamInstMatch</span> <span class='hs-keyword'>where</span>
<a name="line-10"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstMatch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fim_instance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst</span>
<a name="line-11"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>fim_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"match with"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>inst</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="lookupFamInstEnv"></a><span class='hs-definition'>lookupFamInstEnv</span>
<a name="line-15"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-16"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- What we are looking for</span>
<a name="line-17"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Successful matches</span>
<a name="line-18"></a><span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>lookupFamInstEnv</span>
<a name="line-21"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_fam_inst_env</span> <span class='hs-varid'>match</span>
<a name="line-22"></a>   <span class='hs-keyword'>where</span>
<a name="line-23"></a>     <span class='hs-varid'>match</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>tys</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="lookupFamInstEnvConflicts"></a><span class='hs-definition'>lookupFamInstEnvConflicts</span>
<a name="line-26"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-27"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span>          <span class='hs-comment'>-- Putative new instance</span>
<a name="line-28"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Conflicting matches (don't look at the fim_tys field)</span>
<a name="line-29"></a><span class='hs-comment'>-- E.g. when we are about to add</span>
<a name="line-30"></a><span class='hs-comment'>--    f : type instance F [a] = a-&gt;a</span>
<a name="line-31"></a><span class='hs-comment'>-- we do (lookupFamInstConflicts f [b])</span>
<a name="line-32"></a><span class='hs-comment'>-- to find conflicting matches</span>
<a name="line-33"></a><span class='hs-comment'>--</span>
<a name="line-34"></a><span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-definition'>lookupFamInstEnvConflicts</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>fam_inst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_axiom</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_fam_inst_env</span> <span class='hs-varid'>my_unify</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span>
<a name="line-38"></a>  <span class='hs-keyword'>where</span>
<a name="line-39"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fam</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstSplitLHS</span> <span class='hs-varid'>fam_inst</span>
<a name="line-40"></a>        <span class='hs-comment'>-- In example above,   fam tys' = F [b]</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>my_unify</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_axiom</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-keyword'>_</span>
<a name="line-43"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>,</span>
<a name="line-44"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fam</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-45"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tpl_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-46"></a>                <span class='hs-comment'>-- Unification will break badly if the variables overlap</span>
<a name="line-47"></a>                <span class='hs-comment'>-- They shouldn't because we allocate separate uniques for them</span>
<a name="line-48"></a>         <span class='hs-keyword'>if</span> <span class='hs-varid'>compatibleBranches</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomSingleBranch</span> <span class='hs-varid'>old_axiom</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_branch</span><span class='hs-layout'>)</span>
<a name="line-49"></a>           <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>
<a name="line-50"></a>           <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>noSubst</span>
<a name="line-51"></a>      <span class='hs-comment'>-- Note [Family instance overlap conflicts]</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>noSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"lookupFamInstEnvConflicts noSubst"</span>
<a name="line-54"></a>    <span class='hs-varid'>new_branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomSingleBranch</span> <span class='hs-varid'>new_axiom</span>
</pre>\end{code}

Note [Family instance overlap conflicts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- In the case of data family instances, any overlap is fundamentally a
  conflict (as these instances imply injective type mappings).

- In the case of type family instances, overlap is admitted as long as
  the right-hand sides of the overlapping rules coincide under the
  overlap substitution.  eg
       type instance F a Int = a
       type instance F Int b = b
  These two overlap on (F Int Int) but then both RHSs are Int,
  so all is well. We require that they are syntactically equal;
  anything else would be difficult to test for at this stage.

\begin{code}
<pre><a name="line-1"></a><a name="MatchFun"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-2"></a><a name="MatchFun"></a><span class='hs-comment'>-- Might be a one-way match or a unifier</span>
<a name="line-3"></a><a name="MatchFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MatchFun</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>FamInst</span>                <span class='hs-comment'>-- The FamInst template</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>--   fi_tvs, fi_tys of that FamInst</span>
<a name="line-5"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>                         <span class='hs-comment'>-- Target to match against</span>
<a name="line-6"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubst</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="lookup_fam_inst_env'"></a><span class='hs-definition'>lookup_fam_inst_env'</span>          <span class='hs-comment'>-- The worker, local to this module</span>
<a name="line-9"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchFun</span>
<a name="line-10"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-11"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- What we are looking for</span>
<a name="line-12"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a><span class='hs-definition'>lookup_fam_inst_env'</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>match_tys</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenFamilyTyCon</span> <span class='hs-varid'>fam</span>
<a name="line-15"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>fam</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-varid'>insts</span>    <span class='hs-comment'>-- The common case</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>find</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-21"></a>    <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>,</span>
<a name="line-22"></a>                          <span class='hs-varid'>fi_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-23"></a>        <span class='hs-comment'>-- Fast check for no match, uses the "rough match" fields</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>instanceCantMatch</span> <span class='hs-varid'>rough_tcs</span> <span class='hs-varid'>mb_tcs</span>
<a name="line-25"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-varid'>rest</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-comment'>-- Proper check</span>
<a name="line-28"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>item</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>match_tys1</span>
<a name="line-29"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstMatch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fim_instance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>item</span>
<a name="line-30"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>fim_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>match_tys2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-31"></a>        <span class='hs-conop'>:</span> <span class='hs-varid'>find</span> <span class='hs-varid'>rest</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- No match =&gt; try next</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-varid'>rest</span>
<a name="line-36"></a>
<a name="line-37"></a>      <span class='hs-keyword'>where</span>
<a name="line-38"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>rough_tcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>match_tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>match_tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split_tys</span> <span class='hs-varid'>tpl_tys</span>
<a name="line-39"></a>
<a name="line-40"></a>      <span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-comment'>-- Deal with over-saturation</span>
<a name="line-43"></a>    <span class='hs-comment'>-- See Note [Over-saturated matches]</span>
<a name="line-44"></a>    <span class='hs-varid'>split_tys</span> <span class='hs-varid'>tpl_tys</span>
<a name="line-45"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>fam</span>
<a name="line-46"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pre_rough_split_tys</span>
<a name="line-47"></a>
<a name="line-48"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-49"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>match_tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>match_tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>match_tys</span>
<a name="line-50"></a>            <span class='hs-varid'>rough_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roughMatchTcs</span> <span class='hs-varid'>match_tys1</span>
<a name="line-51"></a>        <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>rough_tcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>match_tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>match_tys2</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>pre_match_tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pre_match_tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fam</span><span class='hs-layout'>)</span> <span class='hs-varid'>match_tys</span>
<a name="line-54"></a>    <span class='hs-varid'>pre_rough_split_tys</span>
<a name="line-55"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>roughMatchTcs</span> <span class='hs-varid'>pre_match_tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pre_match_tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pre_match_tys2</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="lookup_fam_inst_env"></a><span class='hs-definition'>lookup_fam_inst_env</span>           <span class='hs-comment'>-- The worker, local to this module</span>
<a name="line-58"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchFun</span>
<a name="line-59"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-60"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- What we are looking for</span>
<a name="line-61"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Successful matches</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-definition'>lookup_fam_inst_env</span> <span class='hs-varid'>match_fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_ie</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_ie</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span>
<a name="line-66"></a>    <span class='hs-varid'>lookup_fam_inst_env'</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>++</span>
<a name="line-67"></a>    <span class='hs-varid'>lookup_fam_inst_env'</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>pkg_ie</span>  <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span>
<a name="line-68"></a>
</pre>\end{code}

Note [Over-saturated matches]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's ok to look up an over-saturated type constructor.  E.g.
     type family F a :: * -> *
     type instance F (a,b) = Either (a->b)

The type instance gives rise to a newtype TyCon (at a higher kind
which you can't do in Haskell!):
     newtype FPair a b = FP (Either (a->b))

Then looking up (F (Int,Bool) Char) will return a FamInstMatch
     (FPair, [Int,Bool,Char])

The "extra" type argument [Char] just stays on the end.

Because of eta-reduction of data family instances (see
Note [Eta reduction for data family axioms] in TcInstDecls), we must
handle data families and type families separately here. All instances
of a type family must have the same arity, so we can precompute the split
between the match_tys and the overflow tys. This is done in pre_rough_split_tys.
For data instances, though, we need to re-split for each instance, because
the breakdown might be different.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="isDominatedBy"></a><span class='hs-comment'>-- checks if one LHS is dominated by a list of other branches</span>
<a name="line-3"></a><span class='hs-comment'>-- in other words, if an application would match the first LHS, it is guaranteed</span>
<a name="line-4"></a><span class='hs-comment'>-- to match at least one of the others. The RHSs are ignored.</span>
<a name="line-5"></a><span class='hs-comment'>-- This algorithm is conservative:</span>
<a name="line-6"></a><span class='hs-comment'>--   True -&gt; the LHS is definitely covered by the others</span>
<a name="line-7"></a><span class='hs-comment'>--   False -&gt; no information</span>
<a name="line-8"></a><span class='hs-comment'>-- It is currently (Oct 2012) used only for generating errors for</span>
<a name="line-9"></a><span class='hs-comment'>-- inaccessible branches. If these errors go unreported, no harm done.</span>
<a name="line-10"></a><span class='hs-comment'>-- This is defined here to avoid a dependency from CoAxiom to Unify</span>
<a name="line-11"></a><span class='hs-definition'>isDominatedBy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-12"></a><span class='hs-definition'>isDominatedBy</span> <span class='hs-varid'>branch</span> <span class='hs-varid'>branches</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>or</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>match</span> <span class='hs-varid'>branches</span>
<a name="line-14"></a>    <span class='hs-keyword'>where</span>
<a name="line-15"></a>      <span class='hs-varid'>lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>branch</span>
<a name="line-16"></a>      <span class='hs-varid'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-17"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>lhs</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Choosing an axiom application
%*                                                                      *
%************************************************************************

The lookupFamInstEnv function does a nice job for *open* type families,
but we also need to handle closed ones when normalising a type:

\begin{code}
<pre><a name="line-1"></a><a name="reduceTyFamApp_maybe"></a><span class='hs-definition'>reduceTyFamApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Attempt to do a *one-step* reduction of a type-family application</span>
<a name="line-3"></a><span class='hs-comment'>-- It first normalises the type arguments, wrt functions but *not* newtypes,</span>
<a name="line-4"></a><span class='hs-comment'>-- to be sure that nested calls like</span>
<a name="line-5"></a><span class='hs-comment'>--    F (G Int)</span>
<a name="line-6"></a><span class='hs-comment'>-- are correctly reduced</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- The TyCon can be oversaturated.</span>
<a name="line-9"></a><span class='hs-comment'>-- Works on both open and closed families</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>reduceTyFamApp_maybe</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fim_instance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_inst</span>
<a name="line-14"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>fim_tys</span> <span class='hs-keyglyph'>=</span>      <span class='hs-varid'>inst_tys</span> <span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFamInstEnv</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ntys</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ax</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstAxiom</span> <span class='hs-varid'>fam_inst</span>
<a name="line-16"></a>        <span class='hs-varid'>co</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>inst_tys</span>
<a name="line-17"></a>        <span class='hs-varid'>ty</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_co</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isClosedSynFamilyTyCon_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-21"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>chooseBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ntys</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>inst_tys</span>
<a name="line-23"></a>        <span class='hs-varid'>ty</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-24"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_co</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isBuiltInSynFamTyCon_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-27"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>coax</span><span class='hs-layout'>,</span><span class='hs-varid'>ts</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sfMatchFam</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ntys</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxiomRuleCo</span> <span class='hs-varid'>coax</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>[]</span>
<a name="line-29"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_co</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-33"></a>
<a name="line-34"></a>  <span class='hs-keyword'>where</span>
<a name="line-35"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>args_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseTcArgs</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-36"></a>
<a name="line-37"></a>
<a name="line-38"></a><a name="chooseBranch"></a><span class='hs-comment'>-- The axiom can be oversaturated. (Closed families only.)</span>
<a name="line-39"></a><span class='hs-definition'>chooseBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>BranchIndex</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-definition'>chooseBranch</span> <span class='hs-varid'>axiom</span> <span class='hs-varid'>tys</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>num_pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNumPats</span> <span class='hs-varid'>axiom</span>
<a name="line-42"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>target_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>num_pats</span> <span class='hs-varid'>tys</span>
<a name="line-43"></a>             <span class='hs-varid'>branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomBranches</span> <span class='hs-varid'>axiom</span>
<a name="line-44"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromBranchList</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varid'>target_tys</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="findBranch"></a><span class='hs-comment'>-- The axiom must *not* be oversaturated</span>
<a name="line-48"></a><span class='hs-definition'>findBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoAxBranch</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- branches to check</span>
<a name="line-49"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span>              <span class='hs-comment'>-- index of current branch</span>
<a name="line-50"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>                   <span class='hs-comment'>-- target types</span>
<a name="line-51"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>BranchIndex</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-definition'>findBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>incomps</span> <span class='hs-layout'>}</span>
<a name="line-53"></a>              <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>target_tys</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tpl_lhs</span> <span class='hs-varid'>target_tys</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-comment'>-- matching worked. now, check for apartness.</span>
<a name="line-56"></a>        <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSurelyApart</span>
<a name="line-57"></a>                <span class='hs-varop'>.</span> <span class='hs-varid'>tcUnifyTysFG</span> <span class='hs-varid'>instanceBindFun</span> <span class='hs-varid'>flattened_target</span>
<a name="line-58"></a>                <span class='hs-varop'>.</span> <span class='hs-varid'>coAxBranchLHS</span><span class='hs-layout'>)</span> <span class='hs-varid'>incomps</span>
<a name="line-59"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- matching worked &amp; we're apart from all incompatible branches. success</span>
<a name="line-60"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ind</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a>      <span class='hs-comment'>-- failure. keep looking</span>
<a name="line-63"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>findBranch</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>(</span><span class='hs-varid'>ind</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>target_tys</span>
<a name="line-64"></a>
<a name="line-65"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>isSurelyApart</span> <span class='hs-conid'>SurelyApart</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-66"></a>        <span class='hs-varid'>isSurelyApart</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-varid'>flattened_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>target_tys</span>
<a name="line-69"></a>        <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSets</span> <span class='hs-varop'>$</span>
<a name="line-70"></a>                                 <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coAxBranchLHS</span><span class='hs-layout'>)</span> <span class='hs-varid'>incomps</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-comment'>-- fail if no branches left</span>
<a name="line-73"></a><span class='hs-definition'>findBranch</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-74"></a>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Looking up a family instance
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="instNewTyConTF_maybe"></a><span class='hs-comment'>-- | Unwrap a newtype of a newtype intances. This is analogous to</span>
<a name="line-2"></a><span class='hs-comment'>--   Coercion.instNewTyCon_maybe; differences are:</span>
<a name="line-3"></a><span class='hs-comment'>--     * it also lookups up newtypes families, and</span>
<a name="line-4"></a><span class='hs-comment'>--     * it does not require the newtype to be saturated.</span>
<a name="line-5"></a><span class='hs-comment'>--       (a requirement using it for Coercible)</span>
<a name="line-6"></a><span class='hs-definition'>instNewTyConTF_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>instNewTyConTF_maybe</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>result</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-10"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reduceTyFamApp_maybe</span> <span class='hs-varid'>env</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-11"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>rhs1</span>
<a name="line-12"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-13"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-14"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-varid'>result</span>
<a name="line-17"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwrapNewTyCon_maybe</span> <span class='hs-varid'>tc2</span> <span class='hs-comment'>-- Check for newtype</span>
<a name="line-18"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>newTyConEtadArity</span> <span class='hs-varid'>tc2</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys2</span>           <span class='hs-comment'>-- Check for enough arguments</span>
<a name="line-19"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConInstRhs</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span>
<a name="line-20"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_tc</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-21"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-22"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="topNormaliseType"></a><span class='hs-definition'>topNormaliseType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-25"></a><span class='hs-definition'>topNormaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>topNormaliseType_maybe</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>                            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-sel'>_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty'</span>
<a name="line-27"></a>                            <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="topNormaliseType_maybe"></a><span class='hs-definition'>topNormaliseType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-30"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-31"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-comment'>-- Get rid of *outermost* (or toplevel)</span>
<a name="line-34"></a><span class='hs-comment'>--      * type function redex</span>
<a name="line-35"></a><span class='hs-comment'>--      * newtypes</span>
<a name="line-36"></a><span class='hs-comment'>-- using appropriate coercions.  Specifically, if</span>
<a name="line-37"></a><span class='hs-comment'>--   topNormaliseType_maybe env ty = Maybe (co, ty')</span>
<a name="line-38"></a><span class='hs-comment'>-- then</span>
<a name="line-39"></a><span class='hs-comment'>--   (a) co :: ty ~ ty'</span>
<a name="line-40"></a><span class='hs-comment'>--   (b) ty' is not a newtype, and is not a type-family redex</span>
<a name="line-41"></a><span class='hs-comment'>--</span>
<a name="line-42"></a><span class='hs-comment'>-- However, ty' can be something like (Maybe (F ty)), where</span>
<a name="line-43"></a><span class='hs-comment'>-- (F ty) is a redex.</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-comment'>-- Its a bit like Type.repType, but handles type families too</span>
<a name="line-46"></a><span class='hs-comment'>-- The coercion returned is always an R coercion</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>topNormaliseType_maybe</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>initRecTc</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>ty</span>
<a name="line-50"></a>  <span class='hs-keyword'>where</span>
<a name="line-51"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecTcChecker</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-52"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>mb_co1</span> <span class='hs-varid'>ty</span>
<a name="line-53"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-54"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-55"></a>           <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>all_done</span> <span class='hs-varid'>mb_co1</span>
<a name="line-56"></a>       <span class='hs-keyword'>where</span>
<a name="line-57"></a>         <span class='hs-varid'>all_done</span> <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-58"></a>         <span class='hs-varid'>all_done</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>         <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-61"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-62"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-63"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_co1</span> <span class='hs-varop'>`trans`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span>
<a name="line-64"></a>                <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>  <span class='hs-comment'>-- No progress at all!</span>
<a name="line-65"></a>                                          <span class='hs-comment'>-- cf topNormaliseNewType_maybe</span>
<a name="line-66"></a>
<a name="line-67"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reduceTyFamApp_maybe</span> <span class='hs-varid'>env</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-68"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_co1</span> <span class='hs-varop'>`trans`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-69"></a>
<a name="line-70"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-71"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all_done</span> <span class='hs-varid'>mb_co1</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-conid'>Nothing</span>    <span class='hs-varop'>`trans`</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co2</span>
<a name="line-74"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`trans`</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a>
<a name="line-77"></a><a name="normaliseTcApp"></a><span class='hs-comment'>---------------</span>
<a name="line-78"></a><span class='hs-definition'>normaliseTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-79"></a><span class='hs-definition'>normaliseTcApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>first_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reduceTyFamApp_maybe</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>    <span class='hs-comment'>-- A reduction is possible</span>
<a name="line-82"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>rest_co</span><span class='hs-layout'>,</span><span class='hs-varid'>nty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty'</span>
<a name="line-83"></a>    <span class='hs-keyword'>in</span>
<a name="line-84"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>first_co</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>rest_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>nty</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- No unique matching family instance exists;</span>
<a name="line-87"></a>                <span class='hs-comment'>-- we do not do anything</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseTcArgs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>in</span>
<a name="line-89"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span>
<a name="line-90"></a>    
<a name="line-91"></a>
<a name="line-92"></a><a name="normaliseTcArgs"></a><span class='hs-comment'>---------------</span>
<a name="line-93"></a><span class='hs-definition'>normaliseTcArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>            <span class='hs-comment'>-- environment with family instances</span>
<a name="line-94"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>                   <span class='hs-comment'>-- desired role of output coercion</span>
<a name="line-95"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- tc tys</span>
<a name="line-96"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- (co, new_tys), where</span>
<a name="line-97"></a>                                          <span class='hs-comment'>-- co :: tc tys ~ tc new_tys</span>
<a name="line-98"></a><span class='hs-definition'>normaliseTcArgs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cois</span><span class='hs-layout'>,</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span>
<a name="line-100"></a>  <span class='hs-keyword'>where</span>
<a name="line-101"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>cois</span><span class='hs-layout'>,</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithAndUnzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="normaliseType"></a><span class='hs-comment'>---------------</span>
<a name="line-104"></a><span class='hs-definition'>normaliseType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>            <span class='hs-comment'>-- environment with family instances</span>
<a name="line-105"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>                   <span class='hs-comment'>-- desired role of output coercion</span>
<a name="line-106"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>                   <span class='hs-comment'>-- old type</span>
<a name="line-107"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- (coercion,new type), where</span>
<a name="line-108"></a>                                        <span class='hs-comment'>-- co :: old-type ~ new_type</span>
<a name="line-109"></a><span class='hs-comment'>-- Normalise the input type, by eliminating *all* type-function redexes</span>
<a name="line-110"></a><span class='hs-comment'>-- Returns with Refl if nothing happens</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty'</span>
<a name="line-114"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseTcApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-116"></a><span class='hs-definition'>normaliseType</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi1</span><span class='hs-layout'>,</span><span class='hs-varid'>nty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span>    <span class='hs-varid'>ty1</span>
<a name="line-119"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>coi2</span><span class='hs-layout'>,</span><span class='hs-varid'>nty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span>
<a name="line-120"></a>    <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>coi1</span> <span class='hs-varid'>coi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>nty1</span> <span class='hs-varid'>nty2</span><span class='hs-layout'>)</span>
<a name="line-121"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi1</span><span class='hs-layout'>,</span><span class='hs-varid'>nty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span>
<a name="line-123"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>coi2</span><span class='hs-layout'>,</span><span class='hs-varid'>nty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty2</span>
<a name="line-124"></a>    <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>coi1</span> <span class='hs-varid'>coi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>nty1</span> <span class='hs-varid'>nty2</span><span class='hs-layout'>)</span>
<a name="line-125"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span><span class='hs-varid'>nty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span>
<a name="line-127"></a>    <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>nty1</span><span class='hs-layout'>)</span>
<a name="line-128"></a><span class='hs-definition'>normaliseType</span> <span class='hs-keyword'>_</span>  <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
              Flattening
%*                                                                      *
%************************************************************************

Note [Flattening]
~~~~~~~~~~~~~~~~~

As described in
http://research.microsoft.com/en-us/um/people/simonpj/papers/ext-f/axioms-extended.pdf
we sometimes need to flatten core types before unifying them. Flattening
means replacing all top-level uses of type functions with fresh variables,
taking care to preserve sharing. That is, the type (Either (F a b) (F a b)) should
flatten to (Either c c), never (Either c d).

Defined here because of module dependencies.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="FlattenMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FlattenMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>TyVar</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="flattenTys"></a><span class='hs-comment'>-- See Note [Flattening]</span>
<a name="line-5"></a><span class='hs-definition'>flattenTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a><span class='hs-definition'>flattenTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coreFlattenTys</span> <span class='hs-varid'>all_in_scope</span> <span class='hs-varid'>emptyTypeMap</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-comment'>-- when we hit a type function, we replace it with a fresh variable</span>
<a name="line-9"></a>    <span class='hs-comment'>-- but, we need to make sure that this fresh variable isn't mentioned</span>
<a name="line-10"></a>    <span class='hs-comment'>-- *anywhere* in the types we're flattening, even if locally-bound in</span>
<a name="line-11"></a>    <span class='hs-comment'>-- a forall. That way, we can ensure consistency both within and outside</span>
<a name="line-12"></a>    <span class='hs-comment'>-- of that forall.</span>
<a name="line-13"></a>    <span class='hs-varid'>all_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>allTyVarsInTys</span> <span class='hs-varid'>tys</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="coreFlattenTys"></a><span class='hs-definition'>coreFlattenTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FlattenMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlattenMap</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-definition'>coreFlattenTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rtys</span> <span class='hs-varid'>m</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rtys</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-20"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreFlattenTy</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>in</span>
<a name="line-21"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span> <span class='hs-varid'>m'</span> <span class='hs-varid'>tys</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="coreFlattenTy"></a><span class='hs-definition'>coreFlattenTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FlattenMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlattenMap</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>coreFlattenTy</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-27"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>m</span>  <span class='hs-varid'>ty1</span>
<a name="line-28"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>in</span>
<a name="line-29"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-30"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-31"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-32"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreFlattenTyFamApp</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>in</span>
<a name="line-33"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-36"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreFlattenTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>in</span>
<a name="line-37"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>m</span>  <span class='hs-varid'>ty1</span>
<a name="line-40"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>in</span>
<a name="line-41"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a>      <span class='hs-comment'>-- Note to RAE: this will have to be changed with kind families</span>
<a name="line-44"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>in</span>
<a name="line-45"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="coreFlattenTyFamApp"></a><span class='hs-definition'>coreFlattenTyFamApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FlattenMap</span>
<a name="line-50"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>         <span class='hs-comment'>-- type family tycon</span>
<a name="line-51"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- args</span>
<a name="line-52"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlattenMap</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>coreFlattenTyFamApp</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>m</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_args</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupTypeMap</span> <span class='hs-varid'>m</span> <span class='hs-varid'>fam_ty</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-56"></a>              <span class='hs-comment'>-- we need fresh variables here, but this is called far from</span>
<a name="line-57"></a>              <span class='hs-comment'>-- any good source of uniques. So, we generate one from thin</span>
<a name="line-58"></a>              <span class='hs-comment'>-- air, using the arbitrary prime number 71 as a seed</span>
<a name="line-59"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tyvar_unique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deriveUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-num'>71</span>
<a name="line-60"></a>                     <span class='hs-varid'>tyvar_name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysTvName</span> <span class='hs-varid'>tyvar_unique</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"fl"</span><span class='hs-layout'>)</span>
<a name="line-61"></a>                     <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>tyvar_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-62"></a>                     <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeMap</span> <span class='hs-varid'>m</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>in</span>
<a name="line-63"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>m'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>fam_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_args</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="allTyVarsInTys"></a><span class='hs-definition'>allTyVarsInTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-67"></a><span class='hs-definition'>allTyVarsInTys</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-68"></a><span class='hs-definition'>allTyVarsInTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allTyVarsInTy</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>allTyVarsInTys</span> <span class='hs-varid'>tys</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="allTyVarsInTy"></a><span class='hs-definition'>allTyVarsInTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-71"></a><span class='hs-definition'>allTyVarsInTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-72"></a>  <span class='hs-keyword'>where</span>
<a name="line-73"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv</span>
<a name="line-74"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-75"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allTyVarsInTys</span> <span class='hs-varid'>tys</span>
<a name="line-76"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-77"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionVarSet`</span>
<a name="line-78"></a>                           <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`unionVarSet`</span>
<a name="line-79"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- don't remove tv</span>
<a name="line-80"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-81"></a>
</pre>\end{code}
</body>
</html>
