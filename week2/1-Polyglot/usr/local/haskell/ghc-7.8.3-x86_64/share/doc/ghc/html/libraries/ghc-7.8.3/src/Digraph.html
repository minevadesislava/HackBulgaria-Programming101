<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>utils/Digraph.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Digraph</span><span class='hs-layout'>(</span>
<a name="line-10"></a>        <span class='hs-conid'>Graph</span><span class='hs-layout'>,</span> <span class='hs-varid'>graphFromVerticesAndAdjacency</span><span class='hs-layout'>,</span> <span class='hs-varid'>graphFromEdgedVertices</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-conid'>SCC</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Node</span><span class='hs-layout'>,</span> <span class='hs-varid'>flattenSCC</span><span class='hs-layout'>,</span> <span class='hs-varid'>flattenSCCs</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>stronglyConnCompG</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>topologicalSortG</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfsTopSortG</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>verticesG</span><span class='hs-layout'>,</span> <span class='hs-varid'>edgesG</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasVertexG</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>reachableG</span><span class='hs-layout'>,</span> <span class='hs-varid'>reachablesG</span><span class='hs-layout'>,</span> <span class='hs-varid'>transposeG</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>outdegreeG</span><span class='hs-layout'>,</span> <span class='hs-varid'>indegreeG</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>vertexGroupsG</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyG</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>componentsG</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-varid'>findCycle</span><span class='hs-layout'>,</span>
<a name="line-22"></a>  
<a name="line-23"></a>        <span class='hs-comment'>-- For backwards compatability with the simpler version of Digraph</span>
<a name="line-24"></a>        <span class='hs-varid'>stronglyConnCompFromEdgedVertices</span><span class='hs-layout'>,</span> <span class='hs-varid'>stronglyConnCompFromEdgedVerticesR</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- No friendly interface yet, not used but exported to avoid warnings</span>
<a name="line-27"></a>        <span class='hs-varid'>tabulate</span><span class='hs-layout'>,</span> <span class='hs-varid'>preArr</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>components</span><span class='hs-layout'>,</span> <span class='hs-varid'>undirected</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>back</span><span class='hs-layout'>,</span> <span class='hs-varid'>cross</span><span class='hs-layout'>,</span> <span class='hs-varid'>forward</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>path</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>bcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>do_label</span><span class='hs-layout'>,</span> <span class='hs-varid'>bicomps</span><span class='hs-layout'>,</span> <span class='hs-varid'>collect</span>
<a name="line-32"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-37"></a><span class='hs-comment'>-- A version of the graph algorithms described in:</span>
<a name="line-38"></a><span class='hs-comment'>--</span>
<a name="line-39"></a><span class='hs-comment'>-- ``Lazy Depth-First Search and Linear IntGraph Algorithms in Haskell''</span>
<a name="line-40"></a><span class='hs-comment'>--   by David King and John Launchbury</span>
<a name="line-41"></a><span class='hs-comment'>--</span>
<a name="line-42"></a><span class='hs-comment'>-- Also included is some additional code for printing tree structures ...</span>
<a name="line-43"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-44"></a>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>minWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>count</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>expectJust</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>allM</span> <span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-comment'>-- Extensions</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>filterM</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftM</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftM2</span> <span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>ST</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-comment'>-- std interfaces</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>transpose</span><span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span><span class='hs-varop'>.</span><span class='hs-conid'>ST</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      Graphs and Graph Construction
%*                                                                      *
%************************************************************************

Note [Nodes, keys, vertices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 * A 'node' is a big blob of client-stuff

 * Each 'node' has a unique (client) 'key', but the latter 
	is in Ord and has fast comparison

 * Digraph then maps each 'key' to a Vertex (Int) which is
  	arranged densely in 0.n

\begin{code}
<pre><a name="line-1"></a><a name="Graph"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Graph</span> <span class='hs-layout'>{</span> 
<a name="line-2"></a>    <span class='hs-varid'>gr_int_graph</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span><span class='hs-layout'>,</span>
<a name="line-3"></a>    <span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>node</span><span class='hs-layout'>,</span>
<a name="line-4"></a>    <span class='hs-varid'>gr_node_to_vertex</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Vertex</span>
<a name="line-5"></a>  <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="Edge"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Edge</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Edge</span> <span class='hs-varid'>node</span> <span class='hs-varid'>node</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="Node"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>payload</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>key</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>	
<a name="line-10"></a>     <span class='hs-comment'>-- The payload is user data, just carried around in this module</span>
<a name="line-11"></a>     <span class='hs-comment'>-- The keys are ordered</span>
<a name="line-12"></a>     <span class='hs-comment'>-- The [key] are the dependencies of the node; </span>
<a name="line-13"></a>     <span class='hs-comment'>--    it's ok to have extra keys in the dependencies that</span>
<a name="line-14"></a>     <span class='hs-comment'>--	   are not the key of any Node in the graph</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="emptyGraph"></a><span class='hs-definition'>emptyGraph</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>a</span>
<a name="line-17"></a><span class='hs-definition'>emptyGraph</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Graph</span> <span class='hs-layout'>(</span><span class='hs-varid'>array</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-str'>"emptyGraph"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="graphFromVerticesAndAdjacency"></a><span class='hs-definition'>graphFromVerticesAndAdjacency</span>
<a name="line-20"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>key</span>
<a name="line-21"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>node</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- First component is source vertex key, </span>
<a name="line-23"></a>                         <span class='hs-comment'>-- second is target vertex key (thing depended on)</span>
<a name="line-24"></a>                         <span class='hs-comment'>-- Unlike the other interface I insist they correspond to</span>
<a name="line-25"></a>                         <span class='hs-comment'>-- actual vertices because the alternative hides bugs. I can't</span>
<a name="line-26"></a>                         <span class='hs-comment'>-- do the same thing for the other one for backcompat reasons.</span>
<a name="line-27"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Graph</span> <span class='hs-layout'>(</span><span class='hs-varid'>node</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-definition'>graphFromVerticesAndAdjacency</span> <span class='hs-conid'>[]</span>       <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyGraph</span>
<a name="line-29"></a><span class='hs-definition'>graphFromVerticesAndAdjacency</span> <span class='hs-varid'>vertices</span> <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>vertex_node</span> <span class='hs-layout'>(</span><span class='hs-varid'>key_vertex</span> <span class='hs-varop'>.</span> <span class='hs-varid'>key_extractor</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>key_extractor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span>
<a name="line-31"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span><span class='hs-layout'>,</span> <span class='hs-varid'>vertex_node</span><span class='hs-layout'>,</span> <span class='hs-varid'>key_vertex</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reduceNodesIntoVertices</span> <span class='hs-varid'>vertices</span> <span class='hs-varid'>key_extractor</span>
<a name="line-32"></a>        <span class='hs-varid'>key_vertex_pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"graphFromVerticesAndAdjacency"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>key_vertex</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> 
<a name="line-33"></a>                                  <span class='hs-varid'>expectJust</span> <span class='hs-str'>"graphFromVerticesAndAdjacency"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>key_vertex</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-34"></a>        <span class='hs-varid'>reduced_edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>key_vertex_pair</span> <span class='hs-varid'>edges</span>
<a name="line-35"></a>        <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildG</span> <span class='hs-varid'>bounds</span> <span class='hs-varid'>reduced_edges</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="graphFromEdgedVertices"></a><span class='hs-definition'>graphFromEdgedVertices</span>
<a name="line-38"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>key</span>
<a name="line-39"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- The graph; its ok for the</span>
<a name="line-40"></a>                                        <span class='hs-comment'>-- out-list to contain keys which arent</span>
<a name="line-41"></a>                                        <span class='hs-comment'>-- a vertex key, they are ignored</span>
<a name="line-42"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Graph</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-definition'>graphFromEdgedVertices</span> <span class='hs-conid'>[]</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyGraph</span>
<a name="line-44"></a><span class='hs-definition'>graphFromEdgedVertices</span> <span class='hs-varid'>edged_vertices</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>vertex_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>key_vertex</span> <span class='hs-varop'>.</span> <span class='hs-varid'>key_extractor</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>key_extractor</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span>
<a name="line-46"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span><span class='hs-layout'>,</span> <span class='hs-varid'>vertex_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>key_vertex</span><span class='hs-layout'>,</span> <span class='hs-varid'>numbered_nodes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reduceNodesIntoVertices</span> <span class='hs-varid'>edged_vertices</span> <span class='hs-varid'>key_extractor</span>
<a name="line-47"></a>        <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>array</span> <span class='hs-varid'>bounds</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>key_vertex</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>numbered_nodes</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="reduceNodesIntoVertices"></a><span class='hs-definition'>reduceNodesIntoVertices</span> 
<a name="line-50"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>key</span> 
<a name="line-51"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span> 
<a name="line-52"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>key</span><span class='hs-layout'>)</span> 
<a name="line-53"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bounds</span><span class='hs-layout'>,</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>node</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Vertex</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-definition'>reduceNodesIntoVertices</span> <span class='hs-varid'>nodes</span> <span class='hs-varid'>key_extractor</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span> <span class='hs-varid'>vertex_map</span><span class='hs-layout'>,</span> <span class='hs-varid'>key_vertex</span><span class='hs-layout'>,</span> <span class='hs-varid'>numbered_nodes</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>max_v</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>nodes</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-57"></a>    <span class='hs-varid'>bounds</span>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>max_v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vertex</span><span class='hs-layout'>,</span> <span class='hs-conid'>Vertex</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a>    <span class='hs-varid'>sorted_nodes</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>key_extractor</span><span class='hs-layout'>)</span> <span class='hs-varid'>nodes</span>
<a name="line-60"></a>    <span class='hs-varid'>numbered_nodes</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-conid'>(,)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>sorted_nodes</span>
<a name="line-61"></a>
<a name="line-62"></a>    <span class='hs-varid'>key_map</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>array</span> <span class='hs-varid'>bounds</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>key_extractor</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>numbered_nodes</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a>    <span class='hs-varid'>vertex_map</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>array</span> <span class='hs-varid'>bounds</span> <span class='hs-varid'>numbered_nodes</span>
<a name="line-64"></a>
<a name="line-65"></a>    <span class='hs-comment'>--key_vertex :: key -&gt; Maybe Vertex</span>
<a name="line-66"></a>    <span class='hs-comment'>-- returns Nothing for non-interesting vertices</span>
<a name="line-67"></a>    <span class='hs-varid'>key_vertex</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-num'>0</span> <span class='hs-varid'>max_v</span>
<a name="line-68"></a>      <span class='hs-keyword'>where</span>
<a name="line-69"></a>        <span class='hs-varid'>find</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-70"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mid</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>+</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>2</span>
<a name="line-71"></a>                               <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>key_map</span> <span class='hs-varop'>!</span> <span class='hs-varid'>mid</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-72"></a>                                    <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>find</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>mid</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-73"></a>                                    <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>mid</span>
<a name="line-74"></a>                                    <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-varid'>mid</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      SCC
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="WorkItem"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>WorkItem</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Tip of the path</span>
<a name="line-3"></a>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>	  	<span class='hs-comment'>-- Rest of the path; </span>
<a name="line-4"></a>     			<span class='hs-comment'>--  [a,b,c] means c depends on b, b depends on a</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="findCycle"></a><span class='hs-comment'>-- | Find a reasonably short cycle a-&gt;b-&gt;c-&gt;a, in a strongly</span>
<a name="line-7"></a><span class='hs-comment'>-- connected component.  The input nodes are presumed to be</span>
<a name="line-8"></a><span class='hs-comment'>-- a SCC, so you can start anywhere.</span>
<a name="line-9"></a><span class='hs-definition'>findCycle</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>payload</span> <span class='hs-varid'>key</span><span class='hs-varop'>.</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>key</span> 
<a name="line-10"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- The nodes.  The dependencies can</span>
<a name="line-11"></a>	     	     	  	    <span class='hs-comment'>-- contain extra keys, which are ignored</span>
<a name="line-12"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- A cycle, starting with node</span>
<a name="line-13"></a>	     			    <span class='hs-comment'>-- so each depends on the next</span>
<a name="line-14"></a><span class='hs-definition'>findCycle</span> <span class='hs-varid'>graph</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_work</span> <span class='hs-varid'>root_deps</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-16"></a>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>node</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>key</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-comment'>-- Find the node with fewest dependencies among the SCC modules</span>
<a name="line-21"></a>    <span class='hs-comment'>-- This is just a heuristic to find some plausible root module</span>
<a name="line-22"></a>    <span class='hs-varid'>root</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span>
<a name="line-23"></a>    <span class='hs-varid'>root</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>minWith</span> <span class='hs-varid'>snd</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>node</span><span class='hs-layout'>,</span> <span class='hs-varid'>count</span> <span class='hs-layout'>(</span><span class='hs-varop'>`</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span><span class='hs-varop'>`</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>deps</span><span class='hs-layout'>)</span> 
<a name="line-24"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>node</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>deps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-25"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>root_payload</span><span class='hs-layout'>,</span><span class='hs-varid'>root_key</span><span class='hs-layout'>,</span><span class='hs-varid'>root_deps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>root</span>
<a name="line-26"></a>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-comment'>-- 'go' implements Dijkstra's algorithm, more or less</span>
<a name="line-29"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-varid'>key</span>	<span class='hs-comment'>-- Visited</span>
<a name="line-30"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WorkItem</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Work list, items length n</span>
<a name="line-31"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WorkItem</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Work list, items length n+1</span>
<a name="line-32"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Returned cycle</span>
<a name="line-33"></a>       <span class='hs-comment'>-- Invariant: in a call (go visited ps qs),</span>
<a name="line-34"></a>       <span class='hs-comment'>--            visited = union (map tail (ps ++ qs))</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>       <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>	<span class='hs-comment'>-- No cycles</span>
<a name="line-37"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>visited</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>qs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>visited</span> <span class='hs-varid'>qs</span> <span class='hs-conid'>[]</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>visited</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>payload</span><span class='hs-layout'>,</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span><span class='hs-varid'>deps</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varid'>qs</span> 
<a name="line-39"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>root_key</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>root_payload</span> <span class='hs-conop'>:</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span>
<a name="line-40"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>key</span> <span class='hs-varop'>`</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span><span class='hs-varop'>`</span> <span class='hs-varid'>visited</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>visited</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>qs</span>
<a name="line-41"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>key</span> <span class='hs-varop'>`</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>notMember</span><span class='hs-varop'>`</span> <span class='hs-varid'>env</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>visited</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>qs</span>
<a name="line-42"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>key</span> <span class='hs-varid'>visited</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                                        <span class='hs-varid'>ps</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_qs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>qs</span><span class='hs-layout'>)</span>
<a name="line-44"></a>       <span class='hs-keyword'>where</span>
<a name="line-45"></a>	 <span class='hs-varid'>new_qs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_work</span> <span class='hs-varid'>deps</span> <span class='hs-layout'>(</span><span class='hs-varid'>payload</span> <span class='hs-conop'>:</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>    <span class='hs-varid'>new_work</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>key</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WorkItem</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a>    <span class='hs-varid'>new_work</span> <span class='hs-varid'>deps</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span><span class='hs-varop'>`</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      SCC
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="SCC"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SCC</span> <span class='hs-varid'>vertex</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>vertex</span>
<a name="line-2"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CyclicSCC</span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>SCC</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-6"></a>    <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="flattenSCCs"></a><span class='hs-definition'>flattenSCCs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-definition'>flattenSCCs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>flattenSCC</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="flattenSCC"></a><span class='hs-definition'>flattenSCC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SCC</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><span class='hs-definition'>flattenSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a><span class='hs-definition'>flattenSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vs</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCC</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NONREC"</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>nest</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"REC"</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>nest</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      Strongly Connected Component wrappers for Graph
%*                                                                      *
%************************************************************************

Note: the components are returned topologically sorted: later components
depend on earlier ones, but not vice versa i.e. later components only have 
edges going from them to earlier ones.

\begin{code}
<pre><a name="line-1"></a><a name="stronglyConnCompG"></a><span class='hs-definition'>stronglyConnCompG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>stronglyConnCompG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decodeSccs</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>forest</span>
<a name="line-3"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>forest</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Digraph.scc" #-}</span> <span class='hs-varid'>scc</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="decodeSccs"></a><span class='hs-definition'>decodeSccs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a><span class='hs-definition'>decodeSccs</span> <span class='hs-conid'>Graph</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gr_int_graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>graph</span><span class='hs-layout'>,</span> <span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vertex_fn</span> <span class='hs-layout'>}</span> <span class='hs-varid'>forest</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>decode</span> <span class='hs-varid'>forest</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>decode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>v</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mentions_itself</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>vertex_fn</span> <span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>vertex_fn</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-11"></a>    <span class='hs-varid'>decode</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-varid'>dec</span> <span class='hs-varid'>other</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-12"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>dec</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vertex_fn</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>dec</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ts</span>
<a name="line-13"></a>    <span class='hs-varid'>mentions_itself</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elem`</span> <span class='hs-layout'>(</span><span class='hs-varid'>graph</span> <span class='hs-varop'>!</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a>
<a name="line-16"></a><a name="stronglyConnCompFromEdgedVertices"></a><span class='hs-comment'>-- The following two versions are provided for backwards compatability:</span>
<a name="line-17"></a><span class='hs-definition'>stronglyConnCompFromEdgedVertices</span>
<a name="line-18"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>key</span>
<a name="line-19"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a><span class='hs-definition'>stronglyConnCompFromEdgedVertices</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>get_node</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>stronglyConnCompFromEdgedVerticesR</span>
<a name="line-23"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>get_node</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="stronglyConnCompFromEdgedVerticesR"></a><span class='hs-comment'>-- The "R" interface is used when you expect to apply SCC to</span>
<a name="line-26"></a><span class='hs-comment'>-- (some of) the result of SCC, so you dont want to lose the dependency info</span>
<a name="line-27"></a><span class='hs-definition'>stronglyConnCompFromEdgedVerticesR</span>
<a name="line-28"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>key</span>
<a name="line-29"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>key</span> <span class='hs-varid'>payload</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a><span class='hs-definition'>stronglyConnCompFromEdgedVerticesR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stronglyConnCompG</span> <span class='hs-varop'>.</span> <span class='hs-varid'>graphFromEdgedVertices</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      Misc wrappers for Graph
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="topologicalSortG"></a><span class='hs-definition'>topologicalSortG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>topologicalSortG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varid'>result</span>
<a name="line-3"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Digraph.topSort" #-}</span> <span class='hs-varid'>topSort</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="dfsTopSortG"></a><span class='hs-definition'>dfsTopSortG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a><span class='hs-definition'>dfsTopSortG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span>
<a name="line-7"></a>  <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flattenTree</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dfs</span> <span class='hs-varid'>g</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSort</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="reachableG"></a><span class='hs-definition'>reachableG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><span class='hs-definition'>reachableG</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>from</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varid'>result</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>from_vertex</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"reachableG"</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_node_to_vertex</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>from</span><span class='hs-layout'>)</span>
<a name="line-14"></a>        <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Digraph.reachable" #-}</span> <span class='hs-varid'>reachable</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>from_vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="reachablesG"></a><span class='hs-definition'>reachablesG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a><span class='hs-definition'>reachablesG</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>froms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varid'>result</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Digraph.reachable" #-}</span> 
<a name="line-19"></a>                 <span class='hs-varid'>reachable</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-20"></a>        <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_node_to_vertex</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varid'>froms</span> <span class='hs-keyglyph'>]</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="hasVertexG"></a><span class='hs-definition'>hasVertexG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-23"></a><span class='hs-definition'>hasVertexG</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gr_node_to_vertex</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>node</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="verticesG"></a><span class='hs-definition'>verticesG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a><span class='hs-definition'>verticesG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vertices</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="edgesG"></a><span class='hs-definition'>edgesG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Edge</span> <span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a><span class='hs-definition'>edgesG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>v1</span><span class='hs-layout'>,</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Edge</span> <span class='hs-layout'>(</span><span class='hs-varid'>v2n</span> <span class='hs-varid'>v1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>v2n</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>edges</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>v2n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="transposeG"></a><span class='hs-definition'>transposeG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span>
<a name="line-33"></a><span class='hs-definition'>transposeG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Graph</span> <span class='hs-layout'>(</span><span class='hs-varid'>transpose</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_node_to_vertex</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="outdegreeG"></a><span class='hs-definition'>outdegreeG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span>
<a name="line-36"></a><span class='hs-definition'>outdegreeG</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>degreeG</span> <span class='hs-varid'>outdegree</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="indegreeG"></a><span class='hs-definition'>indegreeG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span>
<a name="line-39"></a><span class='hs-definition'>indegreeG</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>degreeG</span> <span class='hs-varid'>indegree</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="degreeG"></a><span class='hs-definition'>degreeG</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span>
<a name="line-42"></a><span class='hs-definition'>degreeG</span> <span class='hs-varid'>degree</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>table</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>degree</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                            <span class='hs-keyword'>in</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span> <span class='hs-varid'>table</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>gr_node_to_vertex</span> <span class='hs-varid'>graph</span> <span class='hs-varid'>node</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="vertexGroupsG"></a><span class='hs-definition'>vertexGroupsG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-46"></a><span class='hs-definition'>vertexGroupsG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>result</span>
<a name="line-47"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vertexGroups</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="emptyG"></a><span class='hs-definition'>emptyG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-50"></a><span class='hs-definition'>emptyG</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>graphEmpty</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="componentsG"></a><span class='hs-definition'>componentsG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a><span class='hs-definition'>componentsG</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_vertex_to_node</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flattenTree</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>components</span> <span class='hs-layout'>(</span><span class='hs-varid'>gr_int_graph</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      Showing Graphs
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Graph</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-3"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>graph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-4"></a>                  <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Vertices:"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>verticesG</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-5"></a>                  <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Edges:"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>edgesG</span> <span class='hs-varid'>graph</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-6"></a>                <span class='hs-keyglyph'>]</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Edge</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Edge</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>from</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>to</span>
<a name="line-10"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      IntGraphs
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Vertex"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Vertex</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-2"></a><a name="Table"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Table</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Array</span> <span class='hs-conid'>Vertex</span> <span class='hs-varid'>a</span>
<a name="line-3"></a><a name="IntGraph"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IntGraph</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Table</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a><a name="Bounds"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Bounds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vertex</span><span class='hs-layout'>,</span> <span class='hs-conid'>Vertex</span><span class='hs-layout'>)</span>
<a name="line-5"></a><a name="IntEdge"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IntEdge</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vertex</span><span class='hs-layout'>,</span> <span class='hs-conid'>Vertex</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="vertices"></a><span class='hs-definition'>vertices</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>vertices</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>indices</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="edges"></a><span class='hs-definition'>edges</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IntEdge</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>edges</span> <span class='hs-varid'>g</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vertices</span> <span class='hs-varid'>g</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>g</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>]</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mapT"></a><span class='hs-definition'>mapT</span>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-varid'>b</span>
<a name="line-8"></a><span class='hs-definition'>mapT</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>array</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-varop'>!</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>indices</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>]</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="buildG"></a><span class='hs-definition'>buildG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bounds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IntEdge</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span>
<a name="line-11"></a><span class='hs-definition'>buildG</span> <span class='hs-varid'>bounds</span> <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>accumArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>bounds</span> <span class='hs-varid'>edges</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="transpose"></a><span class='hs-definition'>transpose</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span>
<a name="line-14"></a><span class='hs-definition'>transpose</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildG</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverseE</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="reverseE"></a><span class='hs-definition'>reverseE</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IntEdge</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a><span class='hs-definition'>reverseE</span> <span class='hs-varid'>g</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>]</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="outdegree"></a><span class='hs-definition'>outdegree</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span>
<a name="line-20"></a><span class='hs-definition'>outdegree</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapT</span> <span class='hs-varid'>numEdges</span>
<a name="line-21"></a>             <span class='hs-keyword'>where</span> <span class='hs-varid'>numEdges</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ws</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="indegree"></a><span class='hs-definition'>indegree</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span>
<a name="line-24"></a><span class='hs-definition'>indegree</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outdegree</span> <span class='hs-varop'>.</span> <span class='hs-varid'>transpose</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="graphEmpty"></a><span class='hs-definition'>graphEmpty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-27"></a><span class='hs-definition'>graphEmpty</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lo</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>hi</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>lo</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bounds</span> <span class='hs-varid'>g</span>
<a name="line-29"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*      Trees and forests
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Tree"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Node</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Forest</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2"></a><a name="Forest"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Forest</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="mapTree"></a><span class='hs-definition'>mapTree</span>              <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tree</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>mapTree</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapTree</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="flattenTree"></a><span class='hs-definition'>flattenTree</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-8"></a><span class='hs-definition'>flattenTree</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-conop'>:</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>flattenTree</span> <span class='hs-varid'>ts</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>showsPrec</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showTree</span> <span class='hs-varid'>t</span> <span class='hs-varop'>++</span> <span class='hs-varid'>s</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="showTree"></a><span class='hs-definition'>showTree</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-5"></a><span class='hs-definition'>showTree</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>drawTree</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mapTree</span> <span class='hs-varid'>show</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="drawTree"></a><span class='hs-definition'>drawTree</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tree</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-8"></a><span class='hs-definition'>drawTree</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlines</span> <span class='hs-varop'>.</span> <span class='hs-varid'>draw</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="draw"></a><span class='hs-definition'>draw</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tree</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a><span class='hs-definition'>draw</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grp</span> <span class='hs-varid'>this</span> <span class='hs-layout'>(</span><span class='hs-varid'>space</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>this</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>stLoop</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-12"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>this</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-str'>" "</span>
<a name="line-13"></a>
<a name="line-14"></a>       <span class='hs-varid'>space</span> <span class='hs-varid'>n</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-chr'>' '</span>
<a name="line-15"></a>
<a name="line-16"></a>       <span class='hs-varid'>stLoop</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>       <span class='hs-varid'>stLoop</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grp</span> <span class='hs-varid'>s2</span> <span class='hs-str'>"  "</span> <span class='hs-layout'>(</span><span class='hs-varid'>draw</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-18"></a>       <span class='hs-varid'>stLoop</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grp</span> <span class='hs-varid'>s3</span> <span class='hs-varid'>s4</span> <span class='hs-layout'>(</span><span class='hs-varid'>draw</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s4</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rsLoop</span> <span class='hs-varid'>ts</span>
<a name="line-19"></a>
<a name="line-20"></a>       <span class='hs-varid'>rsLoop</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-21"></a>       <span class='hs-varid'>rsLoop</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grp</span> <span class='hs-varid'>s5</span> <span class='hs-str'>"  "</span> <span class='hs-layout'>(</span><span class='hs-varid'>draw</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-22"></a>       <span class='hs-varid'>rsLoop</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grp</span> <span class='hs-varid'>s6</span> <span class='hs-varid'>s4</span> <span class='hs-layout'>(</span><span class='hs-varid'>draw</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s4</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>rsLoop</span> <span class='hs-varid'>ts</span>
<a name="line-23"></a>
<a name="line-24"></a>       <span class='hs-varid'>grp</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>rst</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span><span class='hs-conop'>:</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>rst</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a>       <span class='hs-keyglyph'>[</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>s3</span><span class='hs-layout'>,</span><span class='hs-varid'>s4</span><span class='hs-layout'>,</span><span class='hs-varid'>s5</span><span class='hs-layout'>,</span><span class='hs-varid'>s6</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"- "</span><span class='hs-layout'>,</span> <span class='hs-str'>"--"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-+"</span><span class='hs-layout'>,</span> <span class='hs-str'>" |"</span><span class='hs-layout'>,</span> <span class='hs-str'>" `"</span><span class='hs-layout'>,</span> <span class='hs-str'>" +"</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
%*      Depth first search
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Set"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>s</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>STArray</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Vertex</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="mkEmpty"></a><span class='hs-definition'>mkEmpty</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bounds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>mkEmpty</span> <span class='hs-varid'>bnds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newArray</span> <span class='hs-varid'>bnds</span> <span class='hs-conid'>False</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="contains"></a><span class='hs-definition'>contains</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Bool</span>
<a name="line-7"></a><span class='hs-definition'>contains</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readArray</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="include"></a><span class='hs-definition'>include</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-conid'>()</span>
<a name="line-10"></a><span class='hs-definition'>include</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeArray</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span> <span class='hs-conid'>True</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="dff"></a><span class='hs-definition'>dff</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span>
<a name="line-2"></a><span class='hs-definition'>dff</span> <span class='hs-varid'>g</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfs</span> <span class='hs-varid'>g</span> <span class='hs-layout'>(</span><span class='hs-varid'>vertices</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="dfs"></a><span class='hs-definition'>dfs</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span>
<a name="line-5"></a><span class='hs-definition'>dfs</span> <span class='hs-varid'>g</span> <span class='hs-varid'>vs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prune</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>generate</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="generate"></a><span class='hs-definition'>generate</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tree</span> <span class='hs-conid'>Vertex</span>
<a name="line-8"></a><span class='hs-definition'>generate</span> <span class='hs-varid'>g</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Node</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>generate</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>g</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="prune"></a><span class='hs-definition'>prune</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bounds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span>
<a name="line-11"></a><span class='hs-definition'>prune</span> <span class='hs-varid'>bnds</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmpty</span> <span class='hs-varid'>bnds</span>  <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-12"></a>                       <span class='hs-varid'>chop</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="chop"></a><span class='hs-definition'>chop</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>chop</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-16"></a><span class='hs-definition'>chop</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ts</span> <span class='hs-conop'>:</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-17"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>contains</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>visited</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-18"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>visited</span> <span class='hs-keyword'>then</span>
<a name="line-19"></a>                  <span class='hs-varid'>chop</span> <span class='hs-varid'>m</span> <span class='hs-varid'>us</span>
<a name="line-20"></a>                <span class='hs-keyword'>else</span>
<a name="line-21"></a>                  <span class='hs-varid'>include</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span>
<a name="line-22"></a>                  <span class='hs-varid'>chop</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ts</span>   <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>as</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-23"></a>                  <span class='hs-varid'>chop</span> <span class='hs-varid'>m</span> <span class='hs-varid'>us</span>   <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>bs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-24"></a>                  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>as</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
%*      Algorithms
%*                                                                      *
%************************************************************************

------------------------------------------------------------
-- Algorithm 1: depth first search numbering
------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="preorder"></a><span class='hs-definition'>preorder</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>preorder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>a</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-varid'>preorderF</span> <span class='hs-varid'>ts</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="preorderF"></a><span class='hs-definition'>preorderF</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Forest</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>preorderF</span> <span class='hs-varid'>ts</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>preorder</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="tabulate"></a><span class='hs-definition'>tabulate</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bounds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span>
<a name="line-8"></a><span class='hs-definition'>tabulate</span> <span class='hs-varid'>bnds</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>array</span> <span class='hs-varid'>bnds</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="preArr"></a><span class='hs-definition'>preArr</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bounds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span>
<a name="line-11"></a><span class='hs-definition'>preArr</span> <span class='hs-varid'>bnds</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tabulate</span> <span class='hs-varid'>bnds</span> <span class='hs-varop'>.</span> <span class='hs-varid'>preorderF</span>
</pre>\end{code}

------------------------------------------------------------
-- Algorithm 2: topological sorting
------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="postorder"></a><span class='hs-definition'>postorder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tree</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>postorder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>a</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>postorderF</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="postorderF"></a><span class='hs-definition'>postorderF</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Forest</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>postorderF</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varop'>.</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>postorder</span> <span class='hs-varid'>ts</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="postOrd"></a><span class='hs-definition'>postOrd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-8"></a><span class='hs-definition'>postOrd</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>postorderF</span> <span class='hs-layout'>(</span><span class='hs-varid'>dff</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="topSort"></a><span class='hs-definition'>topSort</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a><span class='hs-definition'>topSort</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>.</span> <span class='hs-varid'>postOrd</span>
</pre>\end{code}

------------------------------------------------------------
-- Algorithm 3: connected components
------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="components"></a><span class='hs-definition'>components</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span>
<a name="line-2"></a><span class='hs-definition'>components</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dff</span> <span class='hs-varop'>.</span> <span class='hs-varid'>undirected</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="undirected"></a><span class='hs-definition'>undirected</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span>
<a name="line-5"></a><span class='hs-definition'>undirected</span> <span class='hs-varid'>g</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildG</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>edges</span> <span class='hs-varid'>g</span> <span class='hs-varop'>++</span> <span class='hs-varid'>reverseE</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
</pre>\end{code}

------------------------------------------------------------
-- Algorithm 4: strongly connected components
------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="scc"></a><span class='hs-definition'>scc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-conid'>Vertex</span>
<a name="line-2"></a><span class='hs-definition'>scc</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfs</span> <span class='hs-varid'>g</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>postOrd</span> <span class='hs-layout'>(</span><span class='hs-varid'>transpose</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

------------------------------------------------------------
-- Algorithm 5: Classifying edges
------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="back"></a><span class='hs-definition'>back</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span>
<a name="line-2"></a><span class='hs-definition'>back</span> <span class='hs-varid'>g</span> <span class='hs-varid'>post</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapT</span> <span class='hs-varid'>select</span> <span class='hs-varid'>g</span>
<a name="line-3"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>select</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ws</span><span class='hs-layout'>,</span> <span class='hs-varid'>post</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>post</span><span class='hs-varop'>!</span><span class='hs-varid'>w</span> <span class='hs-keyglyph'>]</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="cross"></a><span class='hs-definition'>cross</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span>
<a name="line-6"></a><span class='hs-definition'>cross</span> <span class='hs-varid'>g</span> <span class='hs-varid'>pre</span> <span class='hs-varid'>post</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapT</span> <span class='hs-varid'>select</span> <span class='hs-varid'>g</span>
<a name="line-7"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>select</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ws</span><span class='hs-layout'>,</span> <span class='hs-varid'>post</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>post</span><span class='hs-varop'>!</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>pre</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>pre</span><span class='hs-varop'>!</span><span class='hs-varid'>w</span> <span class='hs-keyglyph'>]</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="forward"></a><span class='hs-definition'>forward</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span>
<a name="line-10"></a><span class='hs-definition'>forward</span> <span class='hs-varid'>g</span> <span class='hs-varid'>tree</span> <span class='hs-varid'>pre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapT</span> <span class='hs-varid'>select</span> <span class='hs-varid'>g</span>
<a name="line-11"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>select</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ws</span><span class='hs-layout'>,</span> <span class='hs-varid'>pre</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>pre</span><span class='hs-varop'>!</span><span class='hs-varid'>w</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>\\</span> <span class='hs-varid'>tree</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span>
</pre>\end{code}

------------------------------------------------------------
-- Algorithm 6: Finding reachable vertices
------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="reachable"></a><span class='hs-definition'>reachable</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>reachable</span> <span class='hs-varid'>g</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>preorderF</span> <span class='hs-layout'>(</span><span class='hs-varid'>dfs</span> <span class='hs-varid'>g</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="path"></a><span class='hs-definition'>path</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a><span class='hs-definition'>path</span> <span class='hs-varid'>g</span> <span class='hs-varid'>v</span> <span class='hs-varid'>w</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`elem`</span> <span class='hs-layout'>(</span><span class='hs-varid'>reachable</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}

------------------------------------------------------------
-- Algorithm 7: Biconnected components
------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="bcc"></a><span class='hs-definition'>bcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>bcc</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>bicomps</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_label</span> <span class='hs-varid'>g</span> <span class='hs-varid'>dnum</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>forest</span>
<a name="line-3"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>forest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dff</span> <span class='hs-varid'>g</span>
<a name="line-4"></a>       <span class='hs-varid'>dnum</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>preArr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-varid'>forest</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="do_label"></a><span class='hs-definition'>do_label</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Table</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tree</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tree</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vertex</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>do_label</span> <span class='hs-varid'>g</span> <span class='hs-varid'>dnum</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>dnum</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>lv</span><span class='hs-layout'>)</span> <span class='hs-varid'>us</span>
<a name="line-8"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_label</span> <span class='hs-varid'>g</span> <span class='hs-varid'>dnum</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>
<a name="line-9"></a>       <span class='hs-varid'>lv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>minimum</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>dnum</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dnum</span><span class='hs-varop'>!</span><span class='hs-varid'>w</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>g</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>                     <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lu</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>lu</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>us</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="bicomps"></a><span class='hs-definition'>bicomps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tree</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vertex</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Forest</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a><span class='hs-definition'>bicomps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-14"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-conid'>Node</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>ts</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="collect"></a><span class='hs-definition'>collect</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tree</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vertex</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tree</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>dv</span><span class='hs-layout'>,</span><span class='hs-varid'>lv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-18"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>collected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>ts</span>
<a name="line-19"></a>       <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>lw</span><span class='hs-layout'>,</span> <span class='hs-conid'>Node</span> <span class='hs-varid'>ws</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collected</span><span class='hs-layout'>,</span> <span class='hs-varid'>lw</span><span class='hs-varop'>&lt;</span><span class='hs-varid'>dv</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>       <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>lw</span><span class='hs-varop'>&lt;</span><span class='hs-varid'>dv</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>us</span> <span class='hs-keyword'>else</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>ws</span><span class='hs-layout'>)</span> <span class='hs-varid'>us</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>lw</span><span class='hs-layout'>,</span> <span class='hs-conid'>Node</span> <span class='hs-varid'>ws</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collected</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

------------------------------------------------------------
-- Algorithm 8: Total ordering on groups of vertices
------------------------------------------------------------

The plan here is to extract a list of groups of elements of the graph
such that each group has no dependence except on nodes in previous
groups (i.e. in particular they may not depend on nodes in their own
group) and is maximal such group.

Clearly we cannot provide a solution for cyclic graphs.

We proceed by iteratively removing elements with no outgoing edges
and their associated edges from the graph.

This probably isn't very efficient and certainly isn't very clever.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="vertexGroups"></a><span class='hs-definition'>vertexGroups</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a><span class='hs-definition'>vertexGroups</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runST</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmpty</span> <span class='hs-layout'>(</span><span class='hs-varid'>bounds</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>provided</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>vertexGroupsS</span> <span class='hs-varid'>provided</span> <span class='hs-varid'>g</span> <span class='hs-varid'>next_vertices</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>next_vertices</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noOutEdges</span> <span class='hs-varid'>g</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="noOutEdges"></a><span class='hs-definition'>noOutEdges</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a><span class='hs-definition'>noOutEdges</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vertices</span> <span class='hs-varid'>g</span><span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>g</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="vertexGroupsS"></a><span class='hs-definition'>vertexGroupsS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Vertex</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a><span class='hs-definition'>vertexGroupsS</span> <span class='hs-varid'>provided</span> <span class='hs-varid'>g</span> <span class='hs-varid'>to_provide</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>to_provide</span> 
<a name="line-12"></a>    <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> 
<a name="line-13"></a>          <span class='hs-varid'>all_provided</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allM</span> <span class='hs-layout'>(</span><span class='hs-varid'>provided</span> <span class='hs-varop'>`contains`</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>vertices</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>all_provided</span>
<a name="line-15"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-16"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>error</span> <span class='hs-str'>"vertexGroup: cyclic graph"</span> 
<a name="line-17"></a>        <span class='hs-layout'>}</span>
<a name="line-18"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> 
<a name="line-19"></a>          <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>include</span> <span class='hs-varid'>provided</span><span class='hs-layout'>)</span> <span class='hs-varid'>to_provide</span>
<a name="line-20"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>to_provide'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterM</span> <span class='hs-layout'>(</span><span class='hs-varid'>vertexReady</span> <span class='hs-varid'>provided</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>vertices</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vertexGroupsS</span> <span class='hs-varid'>provided</span> <span class='hs-varid'>g</span> <span class='hs-varid'>to_provide'</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>to_provide</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span> 
<a name="line-23"></a>        <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="vertexReady"></a><span class='hs-definition'>vertexReady</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Vertex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Bool</span>
<a name="line-26"></a><span class='hs-definition'>vertexReady</span> <span class='hs-varid'>provided</span> <span class='hs-varid'>g</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM2</span> <span class='hs-layout'>(</span><span class='hs-varop'>&amp;&amp;</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftM</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>provided</span> <span class='hs-varop'>`contains`</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>allM</span> <span class='hs-layout'>(</span><span class='hs-varid'>provided</span> <span class='hs-varop'>`contains`</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>g</span><span class='hs-varop'>!</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
