<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CoreTidy.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The AQUA Project, Glasgow University, 1996-1998
%

This module contains "tidying" code for *nested* expressions, bindings, rules.
The code for *top-level* bindings is in TidyPgm.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreTidy</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>tidyExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyVarOcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyRule</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyRules</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyUnfolding</span>
<a name="line-10"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span> <span class='hs-varid'>tidyType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyVarBndr</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span> <span class='hs-varid'>tidyCo</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyNameOcc</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Tidying expressions, rules}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tidyBind"></a><span class='hs-definition'>tidyBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-2"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-3"></a>	 <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>tidyBind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyLetBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-7"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>tidyBind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> 
<a name="line-11"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyLetBndr</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-varid'>prs</span>
<a name="line-12"></a>    <span class='hs-keyword'>in</span>
<a name="line-13"></a>    <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>	<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>rhss'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-14"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>bndrs'</span> <span class='hs-varid'>rhss'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>
<a name="line-17"></a><a name="tidyExpr"></a><span class='hs-comment'>------------  Expressions  --------------</span>
<a name="line-18"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-19"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>   	 <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Var</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span>
<a name="line-23"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 	 <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTickish</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span> 	<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-29"></a>    <span class='hs-conid'>Let</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span> 	<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-33"></a>    <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-34"></a>	 <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyAlt</span> <span class='hs-varid'>b</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-definition'>tidyExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span> 	<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-38"></a>    <span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="tidyAlt"></a><span class='hs-comment'>------------  Case alternatives  --------------</span>
<a name="line-41"></a><span class='hs-definition'>tidyAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreAlt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreAlt</span>
<a name="line-42"></a><span class='hs-definition'>tidyAlt</span> <span class='hs-sel'>_case_bndr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vs</span> 	<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-44"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="tidyTickish"></a><span class='hs-comment'>------------  Tickish  --------------</span>
<a name="line-47"></a><span class='hs-definition'>tidyTickish</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span>
<a name="line-48"></a><span class='hs-definition'>tidyTickish</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>ix</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>ix</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyVarOcc</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>tidyTickish</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>other_tickish</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_tickish</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="tidyRules"></a><span class='hs-comment'>------------  Rules  --------------</span>
<a name="line-52"></a><span class='hs-definition'>tidyRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a><span class='hs-definition'>tidyRules</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-54"></a><span class='hs-definition'>tidyRules</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>rule</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyRule</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rule</span>  		<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>rule</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-56"></a>    <span class='hs-varid'>tidyRules</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rules</span> 	<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>rules</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-57"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>rule</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="tidyRule"></a><span class='hs-definition'>tidyRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span>
<a name="line-60"></a><span class='hs-definition'>tidyRule</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule</span>
<a name="line-61"></a><span class='hs-definition'>tidyRule</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-62"></a>			  <span class='hs-varid'>ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rough</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_ns</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>		<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-64"></a>    <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>  	<span class='hs-varop'>=:</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-65"></a>    <span class='hs-varid'>rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> 
<a name="line-66"></a>	   <span class='hs-varid'>ru_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-67"></a>	   <span class='hs-varid'>ru_fn</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> 
<a name="line-68"></a>	   <span class='hs-varid'>ru_rough</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_ns</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Tidying non-top-level binders}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tidyNameOcc"></a><span class='hs-definition'>tidyNameOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-comment'>-- In rules and instances, we have Names, and we must tidy them too</span>
<a name="line-3"></a><span class='hs-comment'>-- Fortunately, we can lookup in the VarEnv with a name</span>
<a name="line-4"></a><span class='hs-definition'>tidyNameOcc</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-5"></a>				<span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span>
<a name="line-6"></a>				<span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>v</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="tidyVarOcc"></a><span class='hs-definition'>tidyVarOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span>
<a name="line-9"></a><span class='hs-definition'>tidyVarOcc</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>v</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="tidyBndr"></a><span class='hs-comment'>-- tidyBndr is used for lambda and case binders</span>
<a name="line-12"></a><span class='hs-definition'>tidyBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-definition'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="tidyBndrs"></a><span class='hs-definition'>tidyBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>tidyBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>vars</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="tidyLetBndr"></a><span class='hs-definition'>tidyLetBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span>	       <span class='hs-comment'>-- Knot-tied version for unfoldings</span>
<a name="line-21"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> 	       <span class='hs-comment'>-- The one to extend</span>
<a name="line-22"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-comment'>-- Used for local (non-top-level) let(rec)s</span>
<a name="line-24"></a><span class='hs-definition'>tidyLetBndr</span> <span class='hs-varid'>rec_tidy_env</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> 
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_occ_env</span><span class='hs-layout'>,</span><span class='hs-varid'>new_var_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>final_id</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-keyword'>where</span>
<a name="line-27"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_occ_env</span><span class='hs-layout'>,</span><span class='hs-varid'>var_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span>
<a name="line-28"></a>    <span class='hs-varid'>new_var_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>final_id</span>
<a name="line-29"></a>       <span class='hs-comment'>-- Override the env we get back from tidyId with the </span>
<a name="line-30"></a>       <span class='hs-comment'>-- new IdInfo so it gets propagated to the usage sites.</span>
<a name="line-31"></a>
<a name="line-32"></a>	<span class='hs-comment'>-- We need to keep around any interesting strictness and</span>
<a name="line-33"></a>	<span class='hs-comment'>-- demand info because later on we may need to use it when</span>
<a name="line-34"></a>	<span class='hs-comment'>-- converting to A-normal form.</span>
<a name="line-35"></a>	<span class='hs-comment'>-- eg.</span>
<a name="line-36"></a>	<span class='hs-comment'>--	f (g x),  where f is strict in its argument, will be converted</span>
<a name="line-37"></a>	<span class='hs-comment'>--	into  case (g x) of z -&gt; f z  by CorePrep, but only if f still</span>
<a name="line-38"></a>	<span class='hs-comment'>-- 	has its strictness info.</span>
<a name="line-39"></a>	<span class='hs-comment'>--</span>
<a name="line-40"></a>	<span class='hs-comment'>-- Similarly for the demand info - on a let binder, this tells </span>
<a name="line-41"></a>	<span class='hs-comment'>-- CorePrep to turn the let into a case.</span>
<a name="line-42"></a>	<span class='hs-comment'>--</span>
<a name="line-43"></a>	<span class='hs-comment'>-- Similarly arity info for eta expansion in CorePrep</span>
<a name="line-44"></a>	<span class='hs-comment'>-- </span>
<a name="line-45"></a>	<span class='hs-comment'>-- Set inline-prag info so that we preseve it across </span>
<a name="line-46"></a>	<span class='hs-comment'>-- separate compilation boundaries</span>
<a name="line-47"></a>    <span class='hs-varid'>final_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_id</span> <span class='hs-varop'>`setIdInfo`</span> <span class='hs-varid'>new_info</span>
<a name="line-48"></a>    <span class='hs-varid'>idinfo</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-49"></a>    <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>new_id</span>
<a name="line-50"></a>		<span class='hs-varop'>`setArityInfo`</span>		<span class='hs-varid'>exprArity</span> <span class='hs-varid'>rhs</span>
<a name="line-51"></a>                <span class='hs-varop'>`setStrictnessInfo`</span>	<span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>idinfo</span>
<a name="line-52"></a>                <span class='hs-varop'>`setDemandInfo`</span>	        <span class='hs-varid'>demandInfo</span> <span class='hs-varid'>idinfo</span>
<a name="line-53"></a>		<span class='hs-varop'>`setInlinePragInfo`</span>	<span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>idinfo</span>
<a name="line-54"></a>		<span class='hs-varop'>`setUnfoldingInfo`</span>	<span class='hs-varid'>new_unf</span>
<a name="line-55"></a>
<a name="line-56"></a>    <span class='hs-varid'>new_unf</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStableUnfolding</span> <span class='hs-varid'>unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyUnfolding</span> <span class='hs-varid'>rec_tidy_env</span> <span class='hs-varid'>unf</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"tidy_unf"</span><span class='hs-layout'>)</span>
<a name="line-57"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-58"></a>    <span class='hs-varid'>unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>idinfo</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="tidyIdBndr"></a><span class='hs-comment'>-- Non-top-level variables</span>
<a name="line-61"></a><span class='hs-definition'>tidyIdBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-definition'>tidyIdBndr</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Do this pattern match strictly, otherwise we end up holding on to</span>
<a name="line-64"></a>    <span class='hs-comment'>-- stuff in the OccName.</span>
<a name="line-65"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-66"></a>    <span class='hs-keyword'>let</span> 
<a name="line-67"></a>	<span class='hs-comment'>-- Give the Id a fresh print-name, *and* rename its type</span>
<a name="line-68"></a>	<span class='hs-comment'>-- The SrcLoc isn't important now, </span>
<a name="line-69"></a>	<span class='hs-comment'>-- though we could extract it from the Id</span>
<a name="line-70"></a>	<span class='hs-comment'>-- </span>
<a name="line-71"></a>        <span class='hs-varid'>ty'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-72"></a>        <span class='hs-varid'>name'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnique</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ'</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-73"></a>	<span class='hs-varid'>id'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalIdWithInfo</span> <span class='hs-varid'>name'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>new_info</span>
<a name="line-74"></a>	<span class='hs-varid'>var_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>var_env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>id'</span>
<a name="line-75"></a>
<a name="line-76"></a>	<span class='hs-comment'>-- Note [Tidy IdInfo]</span>
<a name="line-77"></a>        <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaIdInfo</span> <span class='hs-varop'>`setOccInfo`</span> <span class='hs-varid'>occInfo</span> <span class='hs-varid'>old_info</span>
<a name="line-78"></a>	<span class='hs-varid'>old_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span>
<a name="line-79"></a>    <span class='hs-keyword'>in</span>
<a name="line-80"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span>
<a name="line-81"></a>   <span class='hs-layout'>}</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="tidyUnfolding"></a><span class='hs-comment'>------------ Unfolding  --------------</span>
<a name="line-84"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-85"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>df</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>df</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>tidy_env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-87"></a>  <span class='hs-keyword'>where</span>
<a name="line-88"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyBndrs</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>bndrs</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-varid'>tidy_env</span> 
<a name="line-91"></a>              <span class='hs-varid'>unf</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf_rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-92"></a>              <span class='hs-varid'>unf_from_rhs</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStableSource</span> <span class='hs-varid'>src</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>unf_rhs</span> <span class='hs-layout'>}</span>	   <span class='hs-comment'>-- Preserves OccInfo</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf_from_rhs</span>
<a name="line-97"></a><span class='hs-definition'>tidyUnfolding</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>unf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unf</span>	<span class='hs-comment'>-- NoUnfolding or OtherCon</span>
</pre>\end{code}

Note [Tidy IdInfo]
~~~~~~~~~~~~~~~~~~
All nested Ids now have the same IdInfo, namely vanillaIdInfo, which
should save some space; except that we preserve occurrence info for
two reasons:

  (a) To make printing tidy core nicer

  (b) Because we tidy RULES and InlineRules, which may then propagate
      via --make into the compilation of the next module, and we want
      the benefit of that occurrence analysis when we use the rule or
      or inline the function.  In particular, it's vital not to lose
      loop-breaker info, else we get an infinite inlining loop
      
Note that tidyLetBndr puts more IdInfo back.


\begin{code}
<pre><a name="line-1"></a><a name="=:"></a><span class='hs-layout'>(</span><span class='hs-varop'>=:</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2"></a><a name="m"></a><span class='hs-definition'>m</span> <span class='hs-varop'>=:</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span>
</pre>\end{code}
</body>
</html>
