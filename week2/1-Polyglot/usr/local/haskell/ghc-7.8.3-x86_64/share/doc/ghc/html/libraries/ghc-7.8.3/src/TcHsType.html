<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcHsType.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[TcMonoType]{Typechecking user-specified @MonoTypes@}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcHsType</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsDeriv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsVectInst</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>	<span class='hs-varid'>tcHsInstHead</span><span class='hs-layout'>,</span> 
<a name="line-11"></a>	<span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-12"></a>
<a name="line-13"></a>                <span class='hs-comment'>-- Type checking type and class decls</span>
<a name="line-14"></a>	<span class='hs-varid'>kcLookupKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcTyClTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyClTyVars</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>tcHsConArgType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcDataKindSig</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>        <span class='hs-varid'>tcClassSigType</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>		<span class='hs-comment'>-- Kind-checking types</span>
<a name="line-19"></a>                <span class='hs-comment'>-- No kind generalisation, no checkValidType</span>
<a name="line-20"></a>	<span class='hs-conid'>KindCheckingStrategy</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcStrategy</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcStrategyFamDecl</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>kcHsTyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsTyVarBndrs</span><span class='hs-layout'>,</span> 
<a name="line-22"></a>        <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsOpenType</span><span class='hs-layout'>,</span>
<a name="line-23"></a>	<span class='hs-varid'>tcLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCheckLHsType</span><span class='hs-layout'>,</span> 
<a name="line-24"></a>        <span class='hs-varid'>tcHsContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsArgTys</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-varid'>kindGeneralize</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkKind</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>		<span class='hs-comment'>-- Sort-checking kinds</span>
<a name="line-29"></a>	<span class='hs-varid'>tcLHsKind</span><span class='hs-layout'>,</span> 
<a name="line-30"></a>
<a name="line-31"></a>		<span class='hs-comment'>-- Pattern type signatures</span>
<a name="line-32"></a>	<span class='hs-varid'>tcHsPatSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPatSig</span>
<a name="line-33"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcValidity</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span><span class='hs-layout'>(</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- For the mkNakedXXX stuff</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span> <span class='hs-layout'>(</span> <span class='hs-varid'>liftedTypeKindTyConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>constraintKindTyConName</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ExtensionFlag</span><span class='hs-layout'>(</span> <span class='hs-conid'>Opt_DataKinds</span> <span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span> <span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span><span class='hs-layout'>(</span> <span class='hs-varid'>ipClassName</span><span class='hs-layout'>,</span> <span class='hs-varid'>funTyConKey</span> <span class='hs-layout'>)</span>
</pre>\end{code}


	----------------------------
		General notes
	----------------------------

Generally speaking we now type-check types in three phases

  1.  kcHsType: kind check the HsType
	*includes* performing any TH type splices;
	so it returns a translated, and kind-annotated, type

  2.  dsHsType: convert from HsType to Type:
	perform zonking
	expand type synonyms [mkGenTyApps]
	hoist the foralls [tcHsType]

  3.  checkValidType: check the validity of the resulting type

Often these steps are done one after the other (tcHsSigType).
But in mutually recursive groups of type and class decls we do
	1 kind-check the whole group
	2 build TyCons/Classes in a knot-tied way
	3 check the validity of types in the now-unknotted TyCons/Classes

For example, when we find
	(forall a m. m a -> m a)
we bind a,m to kind varibles and kind-check (m a -> m a).  This makes
a get kind *, and m get kind *->*.  Now we typecheck (m a -> m a) in
an environment that binds a and m suitably.

The kind checker passed to tcHsTyVars needs to look at enough to
establish the kind of the tyvar:
  * For a group of type and class decls, it's just the group, not
	the rest of the program
  * For a tyvar bound in a pattern type signature, its the types
	mentioned in the other type signatures in that bunch of patterns
  * For a tyvar bound in a RULE, it's the type signatures on other
	universally quantified variables in the rule

Note that this may occasionally give surprising results.  For example:

	data T a b = MkT (a b)

Here we deduce			a::*->*,       b::*
But equally valid would be	a::(*->*)-> *, b::*->*


Validity checking
~~~~~~~~~~~~~~~~~
Some of the validity check could in principle be done by the kind checker, 
but not all:

- During desugaring, we normalise by expanding type synonyms.  Only
  after this step can we check things like type-synonym saturation
  e.g. 	type T k = k Int
	type S a = a
  Then (T S) is ok, because T is saturated; (T S) expands to (S Int);
  and then S is saturated.  This is a GHC extension.

- Similarly, also a GHC extension, we look through synonyms before complaining
  about the form of a class or instance declaration

- Ambiguity checks involve functional dependencies, and it's easier to wait
  until knots have been resolved before poking into them

Also, in a mutually recursive group of types, we can't look at the TyCon until we've
finished building the loop.  So to keep things simple, we postpone most validity
checking until step (3).

Knot tying
~~~~~~~~~~
During step (1) we might fault in a TyCon defined in another module, and it might
(via a loop) refer back to a TyCon defined in this module. So when we tie a big
knot around type declarations with ARecThing, so that the fault-in code can get
the TyCon being defined.


%************************************************************************
%*									*
              Check types AND do validity checking
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcHsSigType"></a><span class='hs-definition'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigTypeNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a>  <span class='hs-comment'>-- NB: it's important that the foralls that come from the top-level</span>
<a name="line-3"></a>  <span class='hs-comment'>--	 HsForAllTy in hs_ty occur *first* in the returned type.</span>
<a name="line-4"></a>  <span class='hs-comment'>--     See Note [Scoped] with TcSigInfo</span>
<a name="line-5"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprHsSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-varid'>tcHsSigTypeNC</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="tcHsSigTypeNC"></a><span class='hs-definition'>tcHsSigTypeNC</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>    <span class='hs-comment'>-- The "In the type..." context</span>
<a name="line-11"></a>                        <span class='hs-comment'>-- comes from the caller; hence "NC"</span>
<a name="line-12"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-13"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-14"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>k</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-15"></a>          <span class='hs-comment'>-- The kind is checked by checkValidType, and isn't necessarily</span>
<a name="line-16"></a>          <span class='hs-comment'>-- of kind * in a Template Haskell quote eg [t| Maybe |]</span>
<a name="line-17"></a>
<a name="line-18"></a>          <span class='hs-comment'>-- Generalise here: see Note [Kind generalisation]</span>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-20"></a>
<a name="line-21"></a>          <span class='hs-comment'>-- Zonk to expose kind information to checkValidType</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="tcHsInstHead"></a><span class='hs-comment'>-----------------</span>
<a name="line-27"></a><span class='hs-definition'>tcHsInstHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-comment'>-- Like tcHsSigTypeNC, but for an instance head.</span>
<a name="line-29"></a><span class='hs-definition'>tcHsInstHead</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>lhs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>    <span class='hs-comment'>-- The "In the type..." context comes from the caller</span>
<a name="line-31"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_inst_head</span> <span class='hs-varid'>hs_ty</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeAndFV</span> <span class='hs-varid'>inst_ty</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralize</span> <span class='hs-varid'>kvs</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>inst_ty</span><span class='hs-layout'>)</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidInstance</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>lhs_ty</span> <span class='hs-varid'>inst_ty</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="tc_inst_head"></a><span class='hs-definition'>tc_inst_head</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-38"></a><span class='hs-definition'>tc_inst_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>hs_ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsTyVarBndrs</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-40"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>hs_ctxt</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ekConstraint</span>    <span class='hs-comment'>-- Body for forall has kind Constraint</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-definition'>tc_inst_head</span> <span class='hs-varid'>hs_ty</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ekConstraint</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="tcHsDeriv"></a><span class='hs-comment'>-----------------</span>
<a name="line-48"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-comment'>-- Like tcHsSigTypeNC, but for the ...deriving( C t1 ty2 ) clause</span>
<a name="line-50"></a><span class='hs-comment'>-- Returns the C, [ty1, ty2, and the kind of C's *next* argument</span>
<a name="line-51"></a><span class='hs-comment'>-- E.g.    class C (a::*) (b::k-&gt;k)</span>
<a name="line-52"></a><span class='hs-comment'>--         data T a b = ... deriving( C Int )</span>
<a name="line-53"></a><span class='hs-comment'>--    returns ([k], C, [k, Int],  k-&gt;k)</span>
<a name="line-54"></a><span class='hs-comment'>-- Also checks that (C ty1 ty2 arg) :: Constraint</span>
<a name="line-55"></a><span class='hs-comment'>-- if arg has a suitable kind</span>
<a name="line-56"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-varid'>hs_ty</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-58"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKind</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varid'>constraintKind</span><span class='hs-layout'>)</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>ty</span>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>arg_kind</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-62"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-63"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span>
<a name="line-64"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal deriving item"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="tcHsVectInst"></a><span class='hs-comment'>-- Used for 'VECTORISE [SCALAR] instance' declarations</span>
<a name="line-67"></a><span class='hs-comment'>--</span>
<a name="line-68"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-varid'>ty</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsClassTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcClass</span> <span class='hs-varid'>cls_name</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferApps</span> <span class='hs-varid'>cls_name</span> <span class='hs-varid'>cls_kind</span> <span class='hs-varid'>tys</span>
<a name="line-73"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed instance type"</span><span class='hs-layout'>)</span>
</pre>\end{code}

	These functions are used during knot-tying in
	type and class declarations, when we have to
 	separate kind-checking, desugaring, and validity checking


%************************************************************************
%*									*
            The main kind checker: no validity checks here
%*									*
%************************************************************************
	
	First a couple of simple wrappers for kcHsType

\begin{code}
<pre><a name="line-1"></a><a name="tcClassSigType"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-varid'>lhs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>lhs_ty</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="tcHsConArgType"></a><span class='hs-definition'>tcHsConArgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NewOrData</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-8"></a><span class='hs-comment'>-- Permit a bang, but discard it</span>
<a name="line-9"></a><span class='hs-definition'>tcHsConArgType</span> <span class='hs-conid'>NewType</span>  <span class='hs-varid'>bty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBangType</span> <span class='hs-varid'>bty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-comment'>-- Newtypes can't have bangs, but we don't check that</span>
<a name="line-11"></a>  <span class='hs-comment'>-- until checkValidDataCon, so do not want to crash here</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>tcHsConArgType</span> <span class='hs-conid'>DataType</span> <span class='hs-varid'>bty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBangType</span> <span class='hs-varid'>bty</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-comment'>-- Can't allow an unlifted type for newtypes, because we're effectively</span>
<a name="line-15"></a>  <span class='hs-comment'>-- going to remove the constructor while coercing it to a lifted type.</span>
<a name="line-16"></a>  <span class='hs-comment'>-- And newtypes can't be bang'd</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="tcHsArgTys"></a><span class='hs-comment'>---------------------------</span>
<a name="line-19"></a><span class='hs-definition'>tcHsArgTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a><span class='hs-definition'>tcHsArgTys</span> <span class='hs-varid'>what</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span>
<a name="line-22"></a>               <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-varid'>what</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-23"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="tc_hs_arg_tys"></a><span class='hs-definition'>tc_hs_arg_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a><span class='hs-comment'>-- Just like tcHsArgTys but without the addTypeCtxt</span>
<a name="line-27"></a><span class='hs-definition'>tc_hs_arg_tys</span> <span class='hs-varid'>what</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-varid'>what</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-29"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="tcHsOpenType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-32"></a><span class='hs-definition'>tcHsOpenType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-33"></a><span class='hs-comment'>-- Used for type signatures</span>
<a name="line-34"></a><span class='hs-comment'>-- Do not do validity checking</span>
<a name="line-35"></a><span class='hs-definition'>tcHsOpenType</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekOpen</span>
<a name="line-36"></a><a name="tcHsLiftedType"></a><span class='hs-definition'>tcHsLiftedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="tcCheckLHsType"></a><span class='hs-comment'>-- Like tcHsType, but takes an expected kind</span>
<a name="line-39"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-40"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span> 
<a name="line-42"></a>    <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varid'>expectedKindMsg</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="tcLHsType"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-comment'>-- Called from outside: set the context</span>
<a name="line-46"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="tcCheckHsTypeAndGen"></a><span class='hs-comment'>---------------------------</span>
<a name="line-49"></a><span class='hs-definition'>tcCheckHsTypeAndGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-50"></a><span class='hs-comment'>-- Input type is HsType, not LhsType; the caller adds the context</span>
<a name="line-51"></a><span class='hs-comment'>-- Typecheck a type signature, and kind-generalise it</span>
<a name="line-52"></a><span class='hs-comment'>-- The result is not necessarily zonked, and has not been checked for validity</span>
<a name="line-53"></a><span class='hs-definition'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>expectedKindMsg</span><span class='hs-layout'>)</span>
<a name="line-55"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcCheckHsTypeAndGen"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeAndFV</span> <span class='hs-varid'>ty</span> 
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralize</span> <span class='hs-varid'>kvs</span>
<a name="line-58"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Like tcExpr, tc_hs_type takes an expected kind which it unifies with
the kind it figures out. When we don't know what kind to expect, we use
tc_lhs_type_fresh, to first create a new meta kind variable and use that as
the expected kind.

\begin{code}
<pre><a name="line-1"></a><a name="tc_infer_lhs_type"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-3"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-4"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kv</span> <span class='hs-varid'>expectedKindMsg</span><span class='hs-layout'>)</span>
<a name="line-5"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="tc_lhs_type"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-8"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-10"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_lhs_type:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="tc_lhs_types"></a><span class='hs-definition'>tc_lhs_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExpKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a><span class='hs-definition'>tc_lhs_types</span> <span class='hs-varid'>tys_w_kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>tc_lhs_type</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys_w_kinds</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="tc_fun_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-17"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-18"></a><span class='hs-comment'>-- We need to recognise (-&gt;) so that we can construct a FunTy, </span>
<a name="line-19"></a><span class='hs-comment'>-- *and* we need to do by looking at the Name, not the TyCon</span>
<a name="line-20"></a><span class='hs-comment'>-- (see Note [Zonking inside the knot]).  For example,</span>
<a name="line-21"></a><span class='hs-comment'>-- consider  f :: (-&gt;) Int Int  (Trac #7312)</span>
<a name="line-22"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>openTypeKind</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>openTypeKind</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="tc_hs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-29"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-30"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-31"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-32"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type: qq"</span>	<span class='hs-comment'>-- Eliminated by renamer</span>
<a name="line-33"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>_</span>
<a name="line-34"></a>    <span class='hs-comment'>-- While top-level bangs at this point are eliminated (eg !(Maybe Int)),</span>
<a name="line-35"></a>    <span class='hs-comment'>-- other kinds of bangs are not (eg ((!Maybe) Int)). These kinds of</span>
<a name="line-36"></a>    <span class='hs-comment'>-- bangs are invalid, so fail. (#7210)</span>
<a name="line-37"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected strictness annotation:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type: record"</span> <span class='hs-comment'>-- Unwrapped by con decls</span>
<a name="line-39"></a>      <span class='hs-comment'>-- Record types (which only show up temporarily in constructor </span>
<a name="line-40"></a>      <span class='hs-comment'>-- signatures) should have been removed by now</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>---------- Functions and applications</span>
<a name="line-43"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>name</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>exp_kind</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>l_op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>op</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckApps</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>l_op</span> <span class='hs-varid'>op_kind</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>exp_kind</span>
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTys</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>         <span class='hs-comment'>-- mkNakedAppTys: see Note [Zonking inside the knot]</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-61"></a><span class='hs-comment'>--  | L _ (HsTyVar fun) &lt;- fun_ty</span>
<a name="line-62"></a><span class='hs-comment'>--  , fun `hasKey` funTyConKey</span>
<a name="line-63"></a><span class='hs-comment'>--  , [fty1,fty2] &lt;- arg_tys</span>
<a name="line-64"></a><span class='hs-comment'>--  = tc_fun_type hs_ty fty1 fty2 exp_kind</span>
<a name="line-65"></a><span class='hs-comment'>--  | otherwise</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>fun_ty</span>
<a name="line-67"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckApps</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTys</span> <span class='hs-varid'>fun_ty'</span> <span class='hs-varid'>arg_tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-69"></a>         <span class='hs-comment'>-- mkNakedAppTys: see Note [Zonking inside the knot]</span>
<a name="line-70"></a>         <span class='hs-comment'>-- This looks fragile; how do we *know* that fun_ty isn't </span>
<a name="line-71"></a>         <span class='hs-comment'>-- a TyConApp, say (which is never supposed to appear in the</span>
<a name="line-72"></a>         <span class='hs-comment'>-- function position of an AppTy)?</span>
<a name="line-73"></a>  <span class='hs-keyword'>where</span>
<a name="line-74"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitHsAppTys</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-comment'>--------- Foralls</span>
<a name="line-77"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>context</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsTyVarBndrs</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-79"></a>    <span class='hs-comment'>-- Do not kind-generalise here!  See Note [Kind generalisation]</span>
<a name="line-80"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>context</span>
<a name="line-81"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>context</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>  <span class='hs-comment'>-- Plain forall, no context</span>
<a name="line-82"></a>                   <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>    <span class='hs-comment'>-- Why exp_kind?  See Note [Body kind of forall]</span>
<a name="line-83"></a>                <span class='hs-keyword'>else</span>     
<a name="line-84"></a>                   <span class='hs-comment'>-- If there is a context, then this forall is really a</span>
<a name="line-85"></a>                   <span class='hs-comment'>-- _function_, so the kind of the result really is *</span>
<a name="line-86"></a>                   <span class='hs-comment'>-- The body kind (result of the function can be * or #, hence ekOpen</span>
<a name="line-87"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-88"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekOpen</span> <span class='hs-layout'>}</span>
<a name="line-89"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>
<a name="line-91"></a><span class='hs-comment'>--------- Lists, arrays, and tuples</span>
<a name="line-92"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> 
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-94"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-95"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-96"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-97"></a>
<a name="line-98"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-100"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-101"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>parrTyCon</span>
<a name="line-102"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPArrTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-103"></a>
<a name="line-104"></a><span class='hs-comment'>-- See Note [Distinguishing tuple kinds] in HsTypes</span>
<a name="line-105"></a><span class='hs-comment'>-- See Note [Inferring tuple kinds]</span>
<a name="line-106"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedOrConstraintTuple</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_k</span> <span class='hs-sel'>_ctxt</span><span class='hs-layout'>)</span>
<a name="line-107"></a>     <span class='hs-comment'>-- (NB: not zonking before looking at exp_k, to avoid left-right bias)</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>exp_k</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>kinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>hs_tys</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>kinds</span>
<a name="line-113"></a>           <span class='hs-comment'>-- Infer each arg type separately, because errors can be</span>
<a name="line-114"></a>           <span class='hs-comment'>-- confusing if we give them a shared kind.  Eg Trac #7410</span>
<a name="line-115"></a>           <span class='hs-comment'>-- (Either Int, Int), we do not want to get an error saying</span>
<a name="line-116"></a>           <span class='hs-comment'>-- "the second argument of a tuple should have kind *-&gt;*"</span>
<a name="line-117"></a>
<a name="line-118"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tup_sort</span><span class='hs-layout'>)</span>
<a name="line-119"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kinds</span>
<a name="line-120"></a>                              <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-121"></a>                    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-122"></a>                    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>BoxedTuple</span><span class='hs-layout'>)</span>
<a name="line-123"></a>         <span class='hs-comment'>-- In the [] case, it's not clear what the kind is, so guess *</span>
<a name="line-124"></a>
<a name="line-125"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-126"></a>                     <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span>
<a name="line-127"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-128"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-129"></a>
<a name="line-130"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-131"></a>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-134"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-135"></a>  <span class='hs-keyword'>where</span>
<a name="line-136"></a>    <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-keyword'>of</span>  <span class='hs-comment'>-- Fourth case dealt with above</span>
<a name="line-137"></a>                  <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnboxedTuple</span>
<a name="line-138"></a>                  <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-139"></a>                  <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-140"></a>                  <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type HsTupleTy"</span>
<a name="line-141"></a>
<a name="line-142"></a>
<a name="line-143"></a><span class='hs-comment'>--------- Promoted lists and tuples</span>
<a name="line-144"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-sel'>_k</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>tys</span>
<a name="line-146"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>taus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>tks</span>
<a name="line-147"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In a promoted list"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tks</span>
<a name="line-148"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPromotedListTy</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-149"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_cons</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_nil</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>taus</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-150"></a>  <span class='hs-keyword'>where</span>
<a name="line-151"></a>    <span class='hs-varid'>mk_cons</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>consDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-152"></a>    <span class='hs-varid'>mk_nil</span>  <span class='hs-varid'>k</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>nilDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span>
<a name="line-153"></a>
<a name="line-154"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>tys</span>
<a name="line-156"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-157"></a>             <span class='hs-varid'>kind_con</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleTyCon</span>   <span class='hs-conid'>BoxedTuple</span> <span class='hs-varid'>n</span>
<a name="line-158"></a>             <span class='hs-varid'>ty_con</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleDataCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-varid'>n</span>
<a name="line-159"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>taus</span><span class='hs-layout'>,</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>tks</span>
<a name="line-160"></a>             <span class='hs-varid'>tup_k</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>kind_con</span> <span class='hs-varid'>ks</span>
<a name="line-161"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_k</span> <span class='hs-varid'>exp_kind</span>
<a name="line-162"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ty_con</span> <span class='hs-layout'>(</span><span class='hs-varid'>ks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>taus</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-163"></a>
<a name="line-164"></a><span class='hs-comment'>--------- Constraint types</span>
<a name="line-165"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ipTy</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-167"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ipTy</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-168"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ipClassName</span>
<a name="line-169"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrLitTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsIPNameFS</span> <span class='hs-varid'>n</span>
<a name="line-170"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-171"></a>       <span class='hs-layout'>}</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> 
<a name="line-174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>ty1</span>
<a name="line-175"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>ty2</span>
<a name="line-176"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>kind2</span>
<a name="line-177"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kind1</span> <span class='hs-varid'>msg_fn</span><span class='hs-layout'>)</span>
<a name="line-178"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-179"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>eqTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kind1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-180"></a>  <span class='hs-keyword'>where</span>
<a name="line-181"></a>    <span class='hs-varid'>msg_fn</span> <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The left argument of the equality had kind"</span><span class='hs-layout'>)</span>
<a name="line-182"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span>
<a name="line-183"></a>
<a name="line-184"></a><span class='hs-comment'>--------- Misc</span>
<a name="line-185"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig_k</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> 
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_k'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>sig_k</span>
<a name="line-187"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig_k'</span> <span class='hs-varid'>exp_kind</span>
<a name="line-188"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>sig_k'</span> <span class='hs-varid'>msg_fn</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-189"></a>  <span class='hs-keyword'>where</span>
<a name="line-190"></a>    <span class='hs-varid'>msg_fn</span> <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The signature specified kind"</span><span class='hs-layout'>)</span> 
<a name="line-191"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span>
<a name="line-192"></a>
<a name="line-193"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-194"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-195"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-196"></a>
<a name="line-197"></a>
<a name="line-198"></a><span class='hs-comment'>-- This should never happen; type splices are expanded by the renamer</span>
<a name="line-199"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected type splice:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-201"></a>
<a name="line-202"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type HsWrapTy"</span>  <span class='hs-comment'>-- We kind checked something twice</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNumTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-206"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>typeNatKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-207"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeNatKindCon</span>
<a name="line-208"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNumLitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-209"></a>
<a name="line-210"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrTy</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-211"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>typeSymbolKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-212"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeSymbolKindCon</span>
<a name="line-213"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStrLitTy</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="tupKindSort_maybe"></a><span class='hs-comment'>---------------------------</span>
<a name="line-216"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TupleSort</span>
<a name="line-217"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-varid'>k</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-219"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-220"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-221"></a>
<a name="line-222"></a><a name="tc_tuple"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-223"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-224"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_arg_tys</span> <span class='hs-varid'>cxt_doc</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span>
<a name="line-225"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-226"></a>  <span class='hs-keyword'>where</span>
<a name="line-227"></a>    <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-228"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-229"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-230"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>constraintKind</span>
<a name="line-231"></a>    <span class='hs-varid'>cxt_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-232"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span>
<a name="line-233"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an unboxed tuple"</span><span class='hs-layout'>)</span>
<a name="line-234"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a constraint tuple"</span><span class='hs-layout'>)</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="finish_tuple"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-237"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-238"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-239"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-240"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-241"></a>  <span class='hs-keyword'>where</span>
<a name="line-242"></a>    <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-varid'>tup_sort</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span>
<a name="line-243"></a>    <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-244"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unliftedTypeKind</span>
<a name="line-245"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-246"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>constraintKind</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="tcInferApps"></a><span class='hs-comment'>---------------------------</span>
<a name="line-249"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-250"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> 
<a name="line-251"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>			<span class='hs-comment'>-- Function kind</span>
<a name="line-252"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Arg types</span>
<a name="line-253"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Kind-checked args</span>
<a name="line-254"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-255"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_w_kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-256"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_types</span> <span class='hs-varid'>args_w_kinds</span>
<a name="line-257"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-258"></a>
<a name="line-259"></a><a name="tcCheckApps"></a><span class='hs-definition'>tcCheckApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> 
<a name="line-260"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- The type being checked (for err messages only)</span>
<a name="line-261"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>               <span class='hs-comment'>-- The function</span>
<a name="line-262"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Fun kind and arg types</span>
<a name="line-263"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> 	                  <span class='hs-comment'>-- Expected kind</span>
<a name="line-264"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-265"></a><span class='hs-definition'>tcCheckApps</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span> <span class='hs-varid'>exp_kind</span>
<a name="line-266"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferApps</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-267"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-268"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>}</span>
<a name="line-269"></a>
<a name="line-270"></a><a name="splitFunKind"></a><span class='hs-comment'>---------------------------</span>
<a name="line-271"></a><span class='hs-definition'>splitFunKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-conid'>ExpKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-272"></a><span class='hs-definition'>splitFunKind</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-273"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-num'>1</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-274"></a>  <span class='hs-keyword'>where</span>
<a name="line-275"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>      <span class='hs-varid'>fk</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fk</span><span class='hs-layout'>)</span>
<a name="line-276"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>arg_no</span> <span class='hs-varid'>fk</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-277"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_fk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunKind</span> <span class='hs-varid'>fk</span>
<a name="line-278"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_fk</span> <span class='hs-keyword'>of</span>
<a name="line-279"></a>                 <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>too_many_args</span> 
<a name="line-280"></a>                 <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ak</span><span class='hs-layout'>,</span><span class='hs-varid'>fk'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>aks</span><span class='hs-layout'>,</span> <span class='hs-varid'>rk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_no</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fk'</span> <span class='hs-varid'>args</span>
<a name="line-281"></a>                                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varid'>the_fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>ak</span> <span class='hs-varid'>arg_no</span>
<a name="line-282"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>aks</span><span class='hs-layout'>,</span> <span class='hs-varid'>rk</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-283"></a> 
<a name="line-284"></a>    <span class='hs-varid'>too_many_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>the_fun</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-285"></a>		    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is applied to too many type arguments"</span><span class='hs-layout'>)</span>
<a name="line-286"></a>
<a name="line-287"></a>
<a name="line-288"></a><a name="tcHsContext"></a><span class='hs-comment'>---------------------------</span>
<a name="line-289"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-290"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcHsLPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-291"></a>
<a name="line-292"></a><a name="tcHsLPredType"></a><span class='hs-definition'>tcHsLPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-293"></a><span class='hs-definition'>tcHsLPredType</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>ekConstraint</span>
<a name="line-294"></a>
<a name="line-295"></a><a name="tcTyVar"></a><span class='hs-comment'>---------------------------</span>
<a name="line-296"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-297"></a><span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-298"></a><span class='hs-comment'>-- in TcTyClsDecls</span>
<a name="line-299"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-varid'>name</span>         <span class='hs-comment'>-- Could be a tyvar, a tycon, or a datacon</span>
<a name="line-300"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-301"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-302"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-303"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span> 
<a name="line-304"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>tv</span>
<a name="line-305"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-306"></a>                             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used as a type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-307"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-308"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-309"></a>
<a name="line-310"></a>           <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_loopy_tc</span> <span class='hs-varid'>name</span>
<a name="line-311"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>inst_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-312"></a>                             <span class='hs-comment'>-- mkNakedTyConApp: see Note [Zonking inside the knot]</span>
<a name="line-313"></a>
<a name="line-314"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inst_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-315"></a>
<a name="line-316"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-317"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteDataCon_maybe</span> <span class='hs-varid'>dc</span>
<a name="line-318"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-319"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKinds</span>
<a name="line-320"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>inst_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-321"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-322"></a>                                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"comes from an un-promotable type"</span><span class='hs-layout'>)</span> 
<a name="line-323"></a>                                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-324"></a>
<a name="line-325"></a>           <span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-326"></a>
<a name="line-327"></a>           <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-328"></a>  <span class='hs-keyword'>where</span>
<a name="line-329"></a>    <span class='hs-varid'>get_loopy_tc</span> <span class='hs-varid'>name</span>
<a name="line-330"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-331"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-332"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc</span>
<a name="line-333"></a>                <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>aThingErr</span> <span class='hs-str'>"tcTyVar"</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-334"></a>
<a name="line-335"></a>    <span class='hs-varid'>inst_tycon</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-336"></a>    <span class='hs-comment'>-- Instantiate the polymorphic kind</span>
<a name="line-337"></a>    <span class='hs-comment'>-- Lazy in the TyCon</span>
<a name="line-338"></a>    <span class='hs-varid'>inst_tycon</span> <span class='hs-varid'>mk_tc_app</span> <span class='hs-varid'>kind</span>
<a name="line-339"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>kvs</span> 
<a name="line-340"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_tc_app</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki_body</span><span class='hs-layout'>)</span>
<a name="line-341"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-342"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk4"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-343"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>kvs</span>
<a name="line-344"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_tc_app</span> <span class='hs-varid'>ks</span><span class='hs-layout'>,</span> <span class='hs-varid'>substKiWith</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ks</span> <span class='hs-varid'>ki_body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-345"></a>      <span class='hs-keyword'>where</span> 
<a name="line-346"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>kind</span>
<a name="line-347"></a>
<a name="line-348"></a><a name="tcClass"></a><span class='hs-definition'>tcClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-349"></a><span class='hs-definition'>tcClass</span> <span class='hs-varid'>cls</span> 	<span class='hs-comment'>-- Must be a class</span>
<a name="line-350"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>cls</span>
<a name="line-351"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-352"></a>           <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>aThingErr</span> <span class='hs-str'>"tcClass"</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-353"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-354"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span> 
<a name="line-355"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-356"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"class"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span>
<a name="line-357"></a>
<a name="line-358"></a>
<a name="line-359"></a><a name="aThingErr"></a><span class='hs-definition'>aThingErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-360"></a><span class='hs-comment'>-- The type checker for types is sometimes called simply to</span>
<a name="line-361"></a><span class='hs-comment'>-- do *kind* checking; and in that case it ignores the type</span>
<a name="line-362"></a><span class='hs-comment'>-- returned. Which is a good thing since it may not be available yet!</span>
<a name="line-363"></a><span class='hs-definition'>aThingErr</span> <span class='hs-varid'>str</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"AThing evaluated unexpectedly"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Zonking inside the knot]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we are checking the argument types of a data constructor.  We
must zonk the types before making the DataCon, because once built we
can't change it.  So we must traverse the type.

BUT the parent TyCon is knot-tied, so we can't look at it yet. 

So we must be careful not to use "smart constructors" for types that
look at the TyCon or Class involved.  

  * Hence the use of mkNakedXXX functions. These do *not* enforce 
    the invariants (for example that we use (FunTy s t) rather 
    than (TyConApp (->) [s,t])).  

  * Ditto in zonkTcType (which may be applied more than once, eg to
    squeeze out kind meta-variables), we are careful not to look at
    the TyCon.

  * We arrange to call zonkSigType *once* right at the end, and it
    does establish the invariants.  But in exchange we can't look
    at the result (not even its structure) until we have emerged
    from the "knot".

  * TcHsSyn.zonkTcTypeToType also can safely check/establish
    invariants.

This is horribly delicate.  I hate it.  A good example of how
delicate it is can be seen in Trac #7903.

\begin{code}
<pre><a name="line-1"></a><a name="mkNakedTyConApp"></a><span class='hs-definition'>mkNakedTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-comment'>-- Builds a TyConApp </span>
<a name="line-3"></a><span class='hs-comment'>--   * without being strict in TyCon,</span>
<a name="line-4"></a><span class='hs-comment'>--   * without satisfying the invariants of TyConApp</span>
<a name="line-5"></a><span class='hs-comment'>-- A subsequent zonking will establish the invariants</span>
<a name="line-6"></a><span class='hs-definition'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="mkNakedAppTys"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-9"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-10"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>tys2</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="zonkSigType"></a><span class='hs-definition'>zonkSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-14"></a><span class='hs-comment'>-- Zonk the result of type-checking a user-written type signature</span>
<a name="line-15"></a><span class='hs-comment'>-- It may have kind variables in it, but no meta type variables</span>
<a name="line-16"></a><span class='hs-comment'>-- Because of knot-typing (see Note [Zonking inside the knot])</span>
<a name="line-17"></a><span class='hs-comment'>-- it may need to establish the Type invariants;</span>
<a name="line-18"></a><span class='hs-comment'>-- hence the use of mkTyConApp and mkAppTy</span>
<a name="line-19"></a><span class='hs-definition'>zonkSigType</span> <span class='hs-varid'>ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-23"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                <span class='hs-comment'>-- Key point: establish Type invariants!</span>
<a name="line-25"></a>                <span class='hs-comment'>-- See Note [Zonking inside the knot]</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-30"></a>                              <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-31"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>
<a name="line-34"></a>                              <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-35"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-36"></a>		<span class='hs-comment'>-- NB the mkAppTy; we might have instantiated a</span>
<a name="line-37"></a>		<span class='hs-comment'>-- type variable to a type constructor, so we need</span>
<a name="line-38"></a>		<span class='hs-comment'>-- to pull the TyConApp to the top.</span>
<a name="line-39"></a>
<a name="line-40"></a>	<span class='hs-comment'>-- The two interesting cases!</span>
<a name="line-41"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tyvar</span>
<a name="line-42"></a>		       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tyvar</span>
<a name="line-43"></a>		<span class='hs-comment'>-- Ordinary (non Tc) tyvars occur inside quantified types</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVarBndr</span> <span class='hs-varid'>tv</span>
<a name="line-46"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-47"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Body kind of a forall]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The body of a forall is usually a type, but in principle
there's no reason to prohibit *unlifted* types.
In fact, GHC can itself construct a function with an
unboxed tuple inside a for-all (via CPR analyis; see 
typecheck/should_compile/tc170).

Moreover in instance heads we get forall-types with
kind Constraint.  

Moreover if we have a signature
   f :: Int#
then we represent it as (HsForAll Implicit [] [] Int#).  And this must
be legal!  We can't drop the empty forall until *after* typechecking
the body because of kind polymorphism:
   Typeable :: forall k. k -> Constraint
   data Apply f t = Apply (f t)
   -- Apply :: forall k. (k -> *) -> k -> *
   instance Typeable Apply where ...
Then the dfun has type
   df :: forall k. Typeable ((k->*) -> k -> *) (Apply k)

   f :: Typeable Apply

   f :: forall (t:k->*) (a:k).  t a -> t a

   class C a b where
      op :: a b -> Typeable Apply

   data T a = MkT (Typeable Apply)
            | T2 a
      T :: * -> *
      MkT :: forall k. (Typeable ((k->*) -> k -> *) (Apply k)) -> T a

   f :: (forall (k:BOX). forall (t:: k->*) (a:k). t a -> t a) -> Int
   f :: (forall a. a -> Typeable Apply) -> Int

So we *must* keep the HsForAll on the instance type
   HsForAll Implicit [] [] (Typeable Apply)
so that we do kind generalisation on it.

Really we should check that it's a type of value kind
{*, Constraint, #}, but I'm not doing that yet
Example that should be rejected:  
         f :: (forall (a:*->*). a) Int

Note [Inferring tuple kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Give a tuple type (a,b,c), which the parser labels as HsBoxedOrConstraintTuple,
we try to figure out whether it's a tuple of kind * or Constraint.
  Step 1: look at the expected kind
  Step 2: infer argument kinds

If after Step 2 it's not clear from the arguments that it's
Constraint, then it must be *.  Once having decided that we re-check
the Check the arguments again to give good error messages
in eg. `(Maybe, Maybe)`

Note that we will still fail to infer the correct kind in this case:

  type T a = ((a,a), D a)
  type family D :: Constraint -> Constraint

While kind checking T, we do not yet know the kind of D, so we will default the
kind of T to * -> *. It works if we annotate `a` with kind `Constraint`.

Note [Desugaring types]
~~~~~~~~~~~~~~~~~~~~~~~
The type desugarer is phase 2 of dealing with HsTypes.  Specifically:

  * It transforms from HsType to Type

  * It zonks any kinds.  The returned type should have no mutable kind
    or type variables (hence returning Type not TcType):
      - any unconstrained kind variables are defaulted to AnyK just 
        as in TcHsSyn. 
      - there are no mutable type variables because we are 
        kind-checking a type
    Reason: the returned type may be put in a TyCon or DataCon where
    it will never subsequently be zonked.

You might worry about nested scopes:
        ..a:kappa in scope..
            let f :: forall b. T '[a,b] -> Int
In this case, f's type could have a mutable kind variable kappa in it;
and we might then default it to AnyK when dealing with f's type
signature.  But we don't expect this to happen because we can't get a
lexically scoped type variable with a mutable kind variable in it.  A
delicate point, this.  If it becomes an issue we might need to
distinguish top-level from nested uses.

Moreover
  * it cannot fail, 
  * it does no unifications
  * it does no validity checking, except for structural matters, such as
	(a) spurious ! annotations.
	(b) a class used as a type

Note [Kind of a type splice]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider these terms, each with TH type splice inside:
     [| e1 :: Maybe $(..blah..) |]
     [| e2 :: $(..blah..) |]
When kind-checking the type signature, we'll kind-check the splice
$(..blah..); we want to give it a kind that can fit in any context,
as if $(..blah..) :: forall k. k.  

In the e1 example, the context of the splice fixes kappa to *.  But
in the e2 example, we'll desugar the type, zonking the kind unification
variables as we go.  When we encounter the unconstrained kappa, we
want to default it to '*', not to AnyK.


Help functions for type applications
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

\begin{code}
<pre><a name="line-1"></a><a name="addTypeCtxt"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a>	<span class='hs-comment'>-- Wrap a context around only if we want to show that contexts.  </span>
<a name="line-3"></a>	<span class='hs-comment'>-- Omit invisble ones and ones user's won't grok</span>
<a name="line-4"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> 
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>thing</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
		Type-variable binders
%*									*
%************************************************************************

Note [Kind-checking strategies]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There are three main declarations that we have to kind check carefully in the
presence of -XPolyKinds: classes, datatypes, and data/type families. They each
have a different kind-checking strategy (labeled in the parentheses above each
section). This should potentially be cleaned up in the future, but this is how
it stands now (June 2013).

Classes (ParametricKinds):
  - kind-polymorphic by default
  - each un-annotated type variable is given a fresh meta kind variable
  - every explicit kind variable becomes a SigTv during inference
  - no generalisation is done while kind-checking the recursive group

  Taken together, this means that classes cannot participate in polymorphic
  recursion. Thus, the following is not definable:

  class Fugly (a :: k) where
    foo :: forall (b :: k -> *). Fugly b => b a

  But, because explicit kind variables are SigTvs, it is OK for the kind to
  be forced to be the same kind that is used in a separate declaration. See
  test case polykinds/T7020.hs.

Datatypes:
  Here we have two cases, whether or not a Full Kind Signature is provided.
  A Full Kind Signature means that there is a top-level :: in the definition
  of the datatype. For example:

  data T1 :: k -> Bool -> * where ...         -- YES
  data T2 (a :: k) :: Bool -> * where ...     -- YES
  data T3 (a :: k) (b :: Bool) :: * where ... -- YES
  data T4 (a :: k) (b :: Bool) where ...      -- NO

  Kind signatures are not allowed on datatypes declared in the H98 style,
  so those always have no Full Kind Signature.

  Full Kind Signature (FullKindSignature):
    - each un-annotated type variable defaults to *
    - every explicit kind variable becomes a skolem during type inference
    - these kind variables are generalised *before* kind-checking the group

    With these rules, polymorphic recursion is possible. This is essentially
    because of the generalisation step before kind-checking the group -- it
    gives the kind-checker enough flexibility to supply the right kind arguments
    to support polymorphic recursion.

  no Full Kind Signature (ParametricKinds):
    - kind-polymorphic by default
    - each un-annotated type variable is given a fresh meta kind variable
    - every explicit kind variable becomes a SigTv during inference
    - no generalisation is done while kind-checking the recursive group

    Thus, no polymorphic recursion in this case. See also Trac #6093 & #6049.

Type families:
  Here we have three cases: open top-level families, closed top-level families,
  and open associated types. (There are no closed associated types, for good
  reason.)

  Open top-level families (FullKindSignature):
    - All open top-level families are considered to have a Full Kind Signature
    - All arguments and the result default to *
    - All kind variables are skolems
    - All kind variables are generalised before kind-checking the group

    This behaviour supports kind-indexed type and data families, because we
    need to have generalised before kind-checking for this to work. For example:

    type family F (a :: k)
    type instance F Int = Bool
    type instance F Maybe = Char
    type instance F (x :: * -> * -> *) = Double

  Closed top-level families (NonParametricKinds):
    - kind-monomorphic by default
    - each un-annotated type variable is given a fresh meta kind variable
    - every explicit kind variable becomes a skolem during inference
    - all such skolems are generalised before kind-checking; other kind
      variables are not generalised
    - all unconstrained meta kind variables are defaulted to * at the
      end of kind checking

    This behaviour is to allow kind inference to occur in closed families, but
    without becoming too polymorphic. For example:

    type family F a where
      F Int = Bool
      F Bool = Char

    We would want F to have kind * -> * from this definition, although something
    like k1 -> k2 would be perfectly sound. The reason we want this restriction is
    that it is better to have (F Maybe) be a kind error than simply stuck.

    The kind inference gives us also

    type family Not b where
      Not False = True
      Not True  = False

    With an open family, the above would need kind annotations in its header.

    The tricky case is

    type family G a (b :: k) where
      G Int Int    = False
      G Bool Maybe = True

    We want this to work. But, we also want (G Maybe Maybe) to be a kind error
    (in the first argument). So, we need to generalise the skolem "k" but not
    the meta kind variable associated with "a".

  Associated families (FullKindSignature):
    - Kind-monomorphic by default
    - Result kind defaults to *
    - Each type variable is either in the class header or not:
      - Type variables in the class header are given the kind inherited from
        the class header (and checked against an annotation, if any)
      - Un-annotated type variables default to *
    - Each kind variable mentioned in the class header becomes a SigTv during
      kind inference.
    - Each kind variable not mentioned in the class header becomes a skolem during
      kind inference.
    - Only the skolem kind variables are generalised before kind checking.

    Here are some examples:
    
    class Foo1 a b where
      type Bar1 (a :: k) (b :: k)

    The kind of Foo1 will be k -> k -> Constraint. Kind annotations on associated
    type declarations propagate to the header because the type variables in Bar1's
    declaration inherit the (meta) kinds of the class header.

    class Foo2 a where
      type Bar2 a

    The kind of Bar2 will be k -> *.

    class Foo3 a where
      type Bar3 a (b :: k)
      meth :: Bar3 a Maybe -> ()

    The kind of Bar3 will be k1 -> k2 -> *. This only kind-checks because the kind
    of b is generalised before kind-checking.

    class Foo4 a where
      type Bar4 a b

    Here, the kind of Bar4 will be k -> * -> *, because b is not mentioned in the
    class header, so it defaults to *.

\begin{code}
<pre><a name="line-1"></a><a name="KindCheckingStrategy"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>KindCheckingStrategy</span>   <span class='hs-comment'>-- See Note [Kind-checking strategies]</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParametricKinds</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonParametricKinds</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FullKindSignature</span>
<a name="line-5"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="kcStrategy"></a><span class='hs-comment'>-- determine the appropriate strategy for a decl</span>
<a name="line-8"></a><span class='hs-definition'>kcStrategy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindCheckingStrategy</span>
<a name="line-9"></a><span class='hs-definition'>kcStrategy</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignType</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcStrategy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>kcStrategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamDecl</span> <span class='hs-varid'>fam_decl</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcStrategyFamDecl</span> <span class='hs-varid'>fam_decl</span>
<a name="line-12"></a><span class='hs-definition'>kcStrategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>SynDecl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParametricKinds</span>
<a name="line-13"></a><span class='hs-definition'>kcStrategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdDataDefn</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsDataDefn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dd_kindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m_ksig</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>m_ksig</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FullKindSignature</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParametricKinds</span>
<a name="line-16"></a><span class='hs-definition'>kcStrategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParametricKinds</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="kcStrategyFamDecl"></a><span class='hs-comment'>-- if the ClosedTypeFamily has no equations, do the defaulting to *, etc.</span>
<a name="line-19"></a><span class='hs-definition'>kcStrategyFamDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamilyDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindCheckingStrategy</span>
<a name="line-20"></a><span class='hs-definition'>kcStrategyFamDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamilyDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fdInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClosedTypeFamily</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonParametricKinds</span>
<a name="line-21"></a><span class='hs-definition'>kcStrategyFamDecl</span> <span class='hs-keyword'>_</span>                                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FullKindSignature</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="mkKindSigVar"></a><span class='hs-definition'>mkKindSigVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>KindVar</span>
<a name="line-24"></a><span class='hs-comment'>-- Use the specified name; don't clone it</span>
<a name="line-25"></a><span class='hs-definition'>mkKindSigVar</span> <span class='hs-varid'>n</span> 
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>n</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-28"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-29"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kvar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>k</span>
<a name="line-30"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kvar</span>
<a name="line-31"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>superKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="kcScopedKindVars"></a><span class='hs-definition'>kcScopedKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-34"></a><span class='hs-comment'>-- Given some tyvar binders like [a (b :: k -&gt; *) (c :: k)]</span>
<a name="line-35"></a><span class='hs-comment'>-- bind each scoped kind variable (k in this case) to a fresh</span>
<a name="line-36"></a><span class='hs-comment'>-- kind skolem variable</span>
<a name="line-37"></a><span class='hs-definition'>kcScopedKindVars</span> <span class='hs-varid'>kv_ns</span> <span class='hs-varid'>thing_inside</span> 
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>superKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv_ns</span>
<a name="line-39"></a>                     <span class='hs-comment'>-- NB: use mutable signature variables</span>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_ns</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span> 
<a name="line-41"></a>
<a name="line-42"></a><a name="kcHsTyVarBndrs"></a><span class='hs-definition'>kcHsTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KindCheckingStrategy</span>
<a name="line-43"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span> 
<a name="line-44"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- the result kind, possibly with other info</span>
<a name="line-45"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-comment'>-- Used in getInitialKind</span>
<a name="line-47"></a><span class='hs-definition'>kcHsTyVarBndrs</span> <span class='hs-varid'>strat</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>skolem_kvs</span>
<a name="line-49"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mkKindSigVar</span> <span class='hs-varid'>kv_ns</span>
<a name="line-50"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>superKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv_ns</span>
<a name="line-51"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_ns</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-52"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>kc_hs_tv</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendKindEnv</span> <span class='hs-varid'>nks</span> <span class='hs-varid'>thing_inside</span>
<a name="line-54"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>full_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkArrowKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>nks</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_kind</span>
<a name="line-55"></a>             <span class='hs-varid'>kvs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isMetaTyVar</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-56"></a>                         <span class='hs-varid'>varSetElems</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>full_kind</span>
<a name="line-57"></a>             <span class='hs-varid'>gen_kind</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>generalise</span>
<a name="line-58"></a>                         <span class='hs-keyword'>then</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>full_kind</span>
<a name="line-59"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>full_kind</span>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>gen_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>  <span class='hs-keyword'>where</span>
<a name="line-62"></a>    <span class='hs-comment'>-- See Note [Kind-checking strategies]</span>
<a name="line-63"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>skolem_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>default_to_star</span><span class='hs-layout'>,</span> <span class='hs-varid'>generalise</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>strat</span> <span class='hs-keyword'>of</span>
<a name="line-64"></a>          <span class='hs-conid'>ParametricKinds</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-65"></a>          <span class='hs-conid'>NonParametricKinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-66"></a>          <span class='hs-conid'>FullKindSignature</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-69"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-70"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>n</span>
<a name="line-71"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-72"></a>               	       <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-73"></a>               	       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>default_to_star</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-74"></a>               	         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-75"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-76"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> 
<a name="line-77"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>k</span>
<a name="line-78"></a>               <span class='hs-comment'>-- In an associated type decl, the type variable may already </span>
<a name="line-79"></a>               <span class='hs-comment'>-- be in scope; in that case we want to make sure its kind</span>
<a name="line-80"></a>               <span class='hs-comment'>-- matches the one declared here</span>
<a name="line-81"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>n</span>
<a name="line-82"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-83"></a>               <span class='hs-conid'>Nothing</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-84"></a>               <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkKind</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>ks</span>
<a name="line-85"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"check_in_scope"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-86"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="tcHsTyVarBndrs"></a><span class='hs-definition'>tcHsTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span> 
<a name="line-89"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-90"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span>
<a name="line-91"></a><span class='hs-comment'>-- Bind the kind variables to fresh skolem variables</span>
<a name="line-92"></a><span class='hs-comment'>-- and type variables to skolems, each with a meta-kind variable kind</span>
<a name="line-93"></a><span class='hs-definition'>tcHsTyVarBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mkKindSigVar</span> <span class='hs-varid'>kv_ns</span>
<a name="line-95"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> 
<a name="line-96"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcHsTyVarBndr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsTyVarBndrs {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span>
<a name="line-98"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-99"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs</span>
<a name="line-100"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-101"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsTyVarBndrs }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span>
<a name="line-103"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-104"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs</span>
<a name="line-105"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-106"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span>  <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="tcHsTyVarBndr"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-109"></a><span class='hs-comment'>-- Return a type variable </span>
<a name="line-110"></a><span class='hs-comment'>-- initialised with a kind variable.</span>
<a name="line-111"></a><span class='hs-comment'>-- Typically the Kind inside the HsTyVarBndr will be a tyvar with a mutable kind </span>
<a name="line-112"></a><span class='hs-comment'>-- in it.</span>
<a name="line-113"></a><span class='hs-comment'>--</span>
<a name="line-114"></a><span class='hs-comment'>-- If the variable is already in scope return it, instead of introducing a new</span>
<a name="line-115"></a><span class='hs-comment'>-- one. This can occur in </span>
<a name="line-116"></a><span class='hs-comment'>--   instance C (a,b) where</span>
<a name="line-117"></a><span class='hs-comment'>--     type F (a,b) c = ...</span>
<a name="line-118"></a><span class='hs-comment'>-- Here a,b will be in scope when processing the associated type instance for F.</span>
<a name="line-119"></a><span class='hs-comment'>-- See Note [Associated type tyvar names] in Class</span>
<a name="line-120"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tv</span><span class='hs-layout'>)</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsTyVarName</span> <span class='hs-varid'>hs_tv</span>
<a name="line-122"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>name</span>
<a name="line-123"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-124"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>;</span>
<a name="line-125"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-126"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_tv</span> <span class='hs-keyword'>of</span>
<a name="line-127"></a>                   <span class='hs-conid'>UserTyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-128"></a>                   <span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>kind</span>
<a name="line-129"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="kindGeneralize"></a><span class='hs-comment'>------------------</span>
<a name="line-132"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>
<a name="line-133"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-varid'>tkvs</span>
<a name="line-134"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyVars</span> <span class='hs-comment'>-- Already zonked</span>
<a name="line-135"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>tkvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-136"></a>                <span class='hs-comment'>-- ToDo: remove the (filter isKindVar)</span>
<a name="line-137"></a>                <span class='hs-comment'>-- Any type variables in tkvs will be in scope,</span>
<a name="line-138"></a>                <span class='hs-comment'>-- and hence in gbl_tvs, so after removing gbl_tvs</span>
<a name="line-139"></a>                <span class='hs-comment'>-- we should only have kind variables left</span>
<a name="line-140"></a>		<span class='hs-comment'>--</span>
<a name="line-141"></a> 		<span class='hs-comment'>-- BUT there is a smelly case (to be fixed when TH is reorganised)</span>
<a name="line-142"></a>		<span class='hs-comment'>--     f t = [| e :: $t |]</span>
<a name="line-143"></a>                <span class='hs-comment'>-- When typechecking the body of the bracket, we typecheck $t to a</span>
<a name="line-144"></a>                <span class='hs-comment'>-- unification variable 'alpha', with no biding forall.  We don't</span>
<a name="line-145"></a>                <span class='hs-comment'>-- want to kind-quantify it!</span>
</pre>\end{code}

Note [Kind generalisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We do kind generalisation only at the outer level of a type signature.
For example, consider
  T :: forall k. k -> *
  f :: (forall a. T a -> Int) -> Int
When kind-checking f's type signature we generalise the kind at
the outermost level, thus:
  f1 :: forall k. (forall (a:k). T k a -> Int) -> Int  -- YES!
and *not* at the inner forall:
  f2 :: (forall k. forall (a:k). T k a -> Int) -> Int  -- NO!
Reason: same as for HM inference on value level declarations,
we want to infer the most general type.  The f2 type signature
would be *less applicable* than f1, because it requires a more
polymorphic argument.

Note [Kinds of quantified type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tcTyVarBndrsGen quantifies over a specified list of type variables,
*and* over the kind variables mentioned in the kinds of those tyvars.

Note that we must zonk those kinds (obviously) but less obviously, we
must return type variables whose kinds are zonked too. Example
    (a :: k7)  where  k7 := k9 -> k9
We must return
    [k9, a:k9->k9]
and NOT 
    [k9, a:k7]
Reason: we're going to turn this into a for-all type, 
   forall k9. forall (a:k7). blah
which the type checker will then instantiate, and instantiate does not
look through unification variables!  

Hence using zonked_kinds when forming tvs'.

\begin{code}
<pre><a name="line-1"></a><a name="kcLookupKind"></a><span class='hs-comment'>--------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- getInitialKind has made a suitably-shaped kind for the type or class</span>
<a name="line-3"></a><span class='hs-comment'>-- Unpack it, and attribute those kinds to the type variables</span>
<a name="line-4"></a><span class='hs-comment'>-- Extend the env with bindings for the tyvars, taken from</span>
<a name="line-5"></a><span class='hs-comment'>-- the kind of the tycon/class.  Give it to the thing inside, and </span>
<a name="line-6"></a><span class='hs-comment'>-- check the result kind matches</span>
<a name="line-7"></a><span class='hs-definition'>kcLookupKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-8"></a><span class='hs-definition'>kcLookupKind</span> <span class='hs-varid'>nm</span> 
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>nm</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>           <span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-12"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-13"></a>           <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcLookupKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_ty_thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="kcTyClTyVars"></a><span class='hs-definition'>kcTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-16"></a><span class='hs-comment'>-- Used for the type variables of a type or class decl,</span>
<a name="line-17"></a><span class='hs-comment'>-- when doing the initial kind-check.  </span>
<a name="line-18"></a><span class='hs-definition'>kcTyClTyVars</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcScopedKindVars</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>$</span>
<a name="line-20"></a>    <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLookupKind</span> <span class='hs-varid'>name</span>
<a name="line-21"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ks</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_kind</span>
<a name="line-22"></a>                     <span class='hs-comment'>-- There should be enough arrows, because</span>
<a name="line-23"></a>                     <span class='hs-comment'>-- getInitialKinds used the tcdTyVars</span>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>name_ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>kc_tv</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>arg_ks</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendKindEnv</span> <span class='hs-varid'>name_ks</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>  <span class='hs-keyword'>where</span>
<a name="line-27"></a>    <span class='hs-comment'>-- getInitialKind has already gotten the kinds of these type</span>
<a name="line-28"></a>    <span class='hs-comment'>-- variables, but tiresomely we need to check them *again* </span>
<a name="line-29"></a>    <span class='hs-comment'>-- to match the kind variables they mention against the ones </span>
<a name="line-30"></a>    <span class='hs-comment'>-- we've freshly brought into scope</span>
<a name="line-31"></a>    <span class='hs-varid'>kc_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-32"></a>    <span class='hs-varid'>kc_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_k</span> 
<a name="line-33"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_k</span><span class='hs-layout'>)</span>
<a name="line-34"></a>    <span class='hs-varid'>kc_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>hs_k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_k</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>hs_k</span>
<a name="line-36"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>checkKind</span> <span class='hs-varid'>k</span> <span class='hs-varid'>exp_k</span>
<a name="line-37"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="tcTyClTyVars"></a><span class='hs-comment'>-----------------------</span>
<a name="line-40"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span>	<span class='hs-comment'>-- LHS of the type or class decl</span>
<a name="line-41"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-42"></a><span class='hs-comment'>-- Used for the type variables of a type or class decl,</span>
<a name="line-43"></a><span class='hs-comment'>-- on the second pass when constructing the final result</span>
<a name="line-44"></a><span class='hs-comment'>-- (tcTyClTyVars T [a,b] thing_inside) </span>
<a name="line-45"></a><span class='hs-comment'>--   where T : forall k1 k2 (a:k1 -&gt; *) (b:k1). k2 -&gt; *</span>
<a name="line-46"></a><span class='hs-comment'>--   calls thing_inside with arguments</span>
<a name="line-47"></a><span class='hs-comment'>--      [k1,k2,a,b] (k2 -&gt; *)</span>
<a name="line-48"></a><span class='hs-comment'>--   having also extended the type environment with bindings </span>
<a name="line-49"></a><span class='hs-comment'>--   for k1,k2,a,b</span>
<a name="line-50"></a><span class='hs-comment'>--</span>
<a name="line-51"></a><span class='hs-comment'>-- No need to freshen the k's because they are just skolem </span>
<a name="line-52"></a><span class='hs-comment'>-- constants here, and we are at top level anyway.</span>
<a name="line-53"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcScopedKindVars</span> <span class='hs-varid'>hs_kvs</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- Bind scoped kind vars to fresh kind univ vars</span>
<a name="line-55"></a>                              <span class='hs-comment'>-- There may be fewer of these than the kvs of</span>
<a name="line-56"></a>                              <span class='hs-comment'>-- the type constructor, of course</span>
<a name="line-57"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>tycon</span>
<a name="line-58"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-59"></a>                        <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kind</span>
<a name="line-60"></a>                        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcTyClTyVars"</span>
<a name="line-61"></a>                     <span class='hs-comment'>-- We only call tcTyClTyVars during typechecking in</span>
<a name="line-62"></a>                     <span class='hs-comment'>-- TcTyClDecls, where the local env is extended with</span>
<a name="line-63"></a>                     <span class='hs-comment'>-- the generalized_env (mapping Names to AThings).</span>
<a name="line-64"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>kind</span>
<a name="line-65"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span>
<a name="line-66"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>tc_hs_tv</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>kinds</span>
<a name="line-67"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-varid'>tc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-70"></a>    <span class='hs-varid'>tc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>hs_k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>hs_k</span>
<a name="line-71"></a>                                                  <span class='hs-layout'>;</span> <span class='hs-varid'>checkKind</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>tc_kind</span>
<a name="line-72"></a>                                                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="tcDataKindSig"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-75"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-76"></a><span class='hs-comment'>-- GADT decls can have a (perhaps partial) kind signature</span>
<a name="line-77"></a><span class='hs-comment'>--	e.g.  data T :: * -&gt; * -&gt; * where ...</span>
<a name="line-78"></a><span class='hs-comment'>-- This function makes up suitable (kinded) type variables for </span>
<a name="line-79"></a><span class='hs-comment'>-- the argument kinds, and checks that the result kind is indeed *.</span>
<a name="line-80"></a><span class='hs-comment'>-- We use it also to make up argument type variables for for data instances.</span>
<a name="line-81"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-varid'>kind</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badKindSig</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-83"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-84"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span> 
<a name="line-85"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span>
<a name="line-86"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mk_tv</span> <span class='hs-varid'>span</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span> <span class='hs-varid'>kind</span> 
<a name="line-87"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>dnames</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>  <span class='hs-keyword'>where</span>
<a name="line-89"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg_kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>kind</span>
<a name="line-90"></a>    <span class='hs-varid'>mk_tv</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-91"></a>	<span class='hs-keyword'>where</span>
<a name="line-92"></a>	   <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-93"></a>	   <span class='hs-varid'>occ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tvName</span> <span class='hs-varid'>str</span>
<a name="line-94"></a>	  
<a name="line-95"></a>    <span class='hs-varid'>dnames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-chr'>'$'</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>	<span class='hs-comment'>-- Note [Avoid name clashes for associated data types]</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class='hs-varid'>names</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-98"></a>    <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-str'>""</span> <span class='hs-conop'>:</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'a'</span><span class='hs-keyglyph'>..</span><span class='hs-chr'>'z'</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> 
<a name="line-99"></a>
<a name="line-100"></a><a name="badKindSig"></a><span class='hs-definition'>badKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-101"></a><span class='hs-definition'>badKindSig</span> <span class='hs-varid'>kind</span> 
<a name="line-102"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind signature on data type declaration has non-* return kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-103"></a>	<span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Avoid name clashes for associated data types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider    class C a b where
               data D b :: * -> *
When typechecking the decl for D, we'll invent an extra type variable for D,
to fill out its kind.  We *don't* want this type variable to be 'a', because
in an .hi file we'd get
            class C a b where
               data D b a 
which makes it look as if there are *two* type indices.  But there aren't!
So we use $a instead, which cannot clash with a user-written type variable.
Remember that type variable binders in interface files are just FastStrings,
not proper Names.

(The tidying phase can't help here because we don't tidy TyCons.  Another
alternative would be to record the number of indexing parameters in the 
interface file.)


%************************************************************************
%*									*
		Scoped type variables
%*									*
%************************************************************************


tcAddScopedTyVars is used for scoped type variables added by pattern
type signatures
	e.g.  \ ((x::a), (y::a)) -> x+y
They never have explicit kinds (because this is source-code only)
They are mutable (because they can get bound to a more specific type).

Usually we kind-infer and expand type splices, and then
tupecheck/desugar the type.  That doesn't work well for scoped type
variables, because they scope left-right in patterns.  (e.g. in the
example above, the 'a' in (y::a) is bound by the 'a' in (x::a).

The current not-very-good plan is to
  * find all the types in the patterns
  * find their free tyvars
  * do kind inference
  * bring the kinded type vars into scope
  * BUT throw away the kind-checked type
  	(we'll kind-check it again when we type-check the pattern)

This is bad because throwing away the kind checked type throws away
its splices.  But too bad for now.  [July 03]

Historical note:
    We no longer specify that these type variables must be univerally 
    quantified (lots of email on the subject).  If you want to put that 
    back in, you need to
	a) Do a checkSigTyVars after thing_inside
	b) More insidiously, don't pass in expected_ty, else
	   we unify with it too early and checkSigTyVars barfs
	   Instead you have to pass in a fresh ty var, and unify
	   it with expected_ty afterwards

\begin{code}
<pre><a name="line-1"></a><a name="tcHsPatSigType"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-2"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWithBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- The type signature</span>
<a name="line-3"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span>                   <span class='hs-comment'>-- The signature</span>
<a name="line-4"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-5"></a>				              <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-6"></a><span class='hs-comment'>-- Used for type-checking type signatures in</span>
<a name="line-7"></a><span class='hs-comment'>-- (a) patterns 	  e.g  f (x::Int) = e</span>
<a name="line-8"></a><span class='hs-comment'>-- (b) result signatures  e.g. g x :: Int = e</span>
<a name="line-9"></a><span class='hs-comment'>-- (c) RULE forall bndrs  e.g. forall (x::Int). f x = x</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswb_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprHsSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-13"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_kv</span> <span class='hs-varid'>sig_kvs</span>
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ktv_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_kvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-varid'>ktv_binds</span> <span class='hs-varop'>$</span>
<a name="line-17"></a>                    <span class='hs-varid'>tcHsLiftedType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>sig_ty</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span> 
<a name="line-20"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ktv_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>new_kv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tkv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>superKind</span>
<a name="line-23"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-24"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>new_tkv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>new_tkv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>   <span class='hs-comment'>-- See Note [Pattern signature binders]</span>
<a name="line-27"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-28"></a>          <span class='hs-conid'>RuleSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-29"></a>          <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>  <span class='hs-comment'>-- See Note [Unifying SigTvs]</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="tcPatSig"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-32"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWithBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-33"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-34"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span>	    <span class='hs-comment'>-- The type to use for "inside" the signature</span>
<a name="line-35"></a>		 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-36"></a>				    <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-37"></a>                 <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- Coercion due to unification with actual ty</span>
<a name="line-38"></a>                                    <span class='hs-comment'>-- Of shape:  res_ty ~ sig_ty</span>
<a name="line-39"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>res_ty</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span>
<a name="line-41"></a>    	<span class='hs-comment'>-- sig_tvs are the type variables free in 'sig', </span>
<a name="line-42"></a>	<span class='hs-comment'>-- and not already in scope. These are the ones</span>
<a name="line-43"></a>	<span class='hs-comment'>-- that should be brought into scope</span>
<a name="line-44"></a>
<a name="line-45"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-46"></a>		<span class='hs-comment'>-- Just do the subsumption check and return</span>
<a name="line-47"></a>                  <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubType</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-48"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-49"></a>        <span class='hs-layout'>}</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-50"></a>		<span class='hs-comment'>-- Type signature binds at least one scoped type variable</span>
<a name="line-51"></a>	
<a name="line-52"></a>		<span class='hs-comment'>-- A pattern binding cannot bind scoped type variables</span>
<a name="line-53"></a>                <span class='hs-comment'>-- It is more convenient to make the test here</span>
<a name="line-54"></a>                <span class='hs-comment'>-- than in the renamer</span>
<a name="line-55"></a>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-56"></a>				<span class='hs-conid'>BindPatSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-57"></a>				<span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-58"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>		<span class='hs-comment'>-- Check that all newly-in-scope tyvars are in fact</span>
<a name="line-61"></a>		<span class='hs-comment'>-- constrained by the pattern.  This catches tiresome</span>
<a name="line-62"></a>		<span class='hs-comment'>-- cases like	</span>
<a name="line-63"></a>		<span class='hs-comment'>--	type T a = Int</span>
<a name="line-64"></a>		<span class='hs-comment'>--	f :: Int -&gt; Int</span>
<a name="line-65"></a>		<span class='hs-comment'>-- 	f (x :: T a) = ...</span>
<a name="line-66"></a>		<span class='hs-comment'>-- Here 'a' doesn't get a binding.  Sigh</span>
<a name="line-67"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-68"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>exactTyVarsOfType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-69"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a>	<span class='hs-comment'>-- Now do a subsumption check of the pattern signature against res_ty</span>
<a name="line-72"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubType</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-73"></a>
<a name="line-74"></a>	<span class='hs-comment'>-- Phew!</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-76"></a>        <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="patBindSigErr"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-79"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span> 
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"You cannot bind scoped type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-81"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-82"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in a pattern binding signature"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Pattern signature binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   data T = forall a. T a (a->Int)
   f (T x (f :: a->Int) = blah)

Here 
 * The pattern (T p1 p2) creates a *skolem* type variable 'a_sk', 
   It must be a skolem so that that it retains its identity, and    
   TcErrors.getSkolemInfo can thereby find the binding site for the skolem.

 * The type signature pattern (f :: a->Int) binds "a" -> a_sig in the envt

 * Then unificaiton makes a_sig := a_sk

That's why we must make a_sig a MetaTv (albeit a SigTv), 
not a SkolemTv, so that it can unify to a_sk.

For RULE binders, though, things are a bit different (yuk).  
  RULE "foo" forall (x::a) (y::[a]).  f x y = ...
Here this really is the binding site of the type variable so we'd like
to use a skolem, so that we get a complaint if we unify two of them
together.

Note [Unifying SigTvs]
~~~~~~~~~~~~~~~~~~~~~~
ALAS we have no decent way of avoiding two SigTvs getting unified.  
Consider
  f (x::(a,b)) (y::c)) = [fst x, y]
Here we'd really like to complain that 'a' and 'c' are unified. But
for the reasons above we can't make a,b,c into skolems, so they
are just SigTvs that can unify.  And indeed, this would be ok,
  f x (y::c) = case x of
                 (x1 :: a1, True) -> [x,y]
                 (x1 :: a2, False) -> [x,y,y]
Here the type of x's first component is called 'a1' in one branch and
'a2' in the other.  We could try insisting on the same OccName, but
they definitely won't have the sane lexical Name. 

I think we could solve this by recording in a SigTv a list of all the 
in-scope varaibles that it should not unify with, but it's fiddly.


%************************************************************************
%*                                                                      *
        Checking kinds
%*                                                                      *
%************************************************************************

We would like to get a decent error message from
  (a) Under-applied type constructors
             f :: (Maybe, Maybe)
  (b) Over-applied type constructors
             f :: Int x -> Int x

\begin{code}
<pre><a name="line-1"></a><a name="ExpKind"></a><span class='hs-comment'>-- The ExpKind datatype means "expected kind" and contains </span>
<a name="line-2"></a><a name="ExpKind"></a><span class='hs-comment'>-- some info about just why that kind is expected, to improve</span>
<a name="line-3"></a><a name="ExpKind"></a><span class='hs-comment'>-- the error message on a mis-match</span>
<a name="line-4"></a><a name="ExpKind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-conid'>TcKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-5"></a>   <span class='hs-comment'>-- The second arg is function that takes a *tidied* version </span>
<a name="line-6"></a>   <span class='hs-comment'>-- of the first arg, and produces something like</span>
<a name="line-7"></a>   <span class='hs-comment'>--    "Expected kind k"</span>
<a name="line-8"></a>   <span class='hs-comment'>--    "Expected a constraint"</span>
<a name="line-9"></a>   <span class='hs-comment'>--    "The argument of Maybe should have kind k"</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyword'>where</span>
<a name="line-12"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>k</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>k</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="ekLifted"></a><span class='hs-definition'>ekLifted</span><span class='hs-layout'>,</span> <span class='hs-varid'>ekOpen</span><span class='hs-layout'>,</span> <span class='hs-varid'>ekConstraint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExpKind</span>
<a name="line-15"></a><span class='hs-definition'>ekLifted</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>expectedKindMsg</span>
<a name="line-16"></a><a name="ekOpen"></a><span class='hs-definition'>ekOpen</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>openTypeKind</span>   <span class='hs-varid'>expectedKindMsg</span>
<a name="line-17"></a><a name="ekConstraint"></a><span class='hs-definition'>ekConstraint</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>expectedKindMsg</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="expectedKindMsg"></a><span class='hs-definition'>expectedKindMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-20"></a><span class='hs-definition'>expectedKindMsg</span> <span class='hs-varid'>pkind</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected a constraint"</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenTypeKind</span>   <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected a type"</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="expArgKind"></a><span class='hs-comment'>-- Build an ExpKind for arguments</span>
<a name="line-26"></a><span class='hs-definition'>expArgKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span>
<a name="line-27"></a><span class='hs-definition'>expArgKind</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_no</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>msg_fn</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>msg_fn</span> <span class='hs-varid'>pkind</span> 
<a name="line-30"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>arg_no</span> 
<a name="line-31"></a>              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>exp</span>
<a name="line-32"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"should have kind"</span><span class='hs-layout'>)</span> 
<a name="line-33"></a>              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="unifyKinds"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-36"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>act_kinds</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_no</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-39"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>)</span>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>act_kinds</span><span class='hs-layout'>)</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="checkKind"></a><span class='hs-definition'>checkKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-44"></a><span class='hs-definition'>checkKind</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKindX</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyword'>of</span>
<a name="line-47"></a>           <span class='hs-conid'>Just</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-48"></a>           <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="checkExpectedKind"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-51"></a><span class='hs-comment'>-- A fancy wrapper for 'unifyKindX', which tries</span>
<a name="line-52"></a><span class='hs-comment'>-- to give decent error messages.</span>
<a name="line-53"></a><span class='hs-comment'>--      (checkExpectedKind ty act_kind exp_kind)</span>
<a name="line-54"></a><span class='hs-comment'>-- checks that the actual kind act_kind is compatible</span>
<a name="line-55"></a><span class='hs-comment'>--      with the expected kind exp_kind</span>
<a name="line-56"></a><span class='hs-comment'>-- The first argument, ty, is used only in the error message generation</span>
<a name="line-57"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varid'>ek_ctxt</span><span class='hs-layout'>)</span>
<a name="line-58"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKindX</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-59"></a>
<a name="line-60"></a>         <span class='hs-comment'>-- Kind unification only generates definite errors</span>
<a name="line-61"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-62"></a>          <span class='hs-conid'>Just</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>;</span>    <span class='hs-comment'>-- act_kind is a sub-kind of exp_kind</span>
<a name="line-63"></a>          <span class='hs-conid'>Just</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>;</span>    <span class='hs-comment'>-- The two are equal</span>
<a name="line-64"></a>          <span class='hs-sel'>_other</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-65"></a>
<a name="line-66"></a>      <span class='hs-layout'>{</span>  <span class='hs-comment'>-- So there's an error</span>
<a name="line-67"></a>         <span class='hs-comment'>-- Now to find out what sort</span>
<a name="line-68"></a>        <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-69"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>act_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-70"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-71"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-72"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-73"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_as</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-74"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>act_as</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>act_kind</span>
<a name="line-75"></a>            <span class='hs-varid'>n_exp_as</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>exp_as</span>
<a name="line-76"></a>            <span class='hs-varid'>n_act_as</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>act_as</span>
<a name="line-77"></a>            <span class='hs-varid'>n_diff_as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_act_as</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_exp_as</span>
<a name="line-78"></a>
<a name="line-79"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_exp_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>exp_kind</span>
<a name="line-80"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_act_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>act_kind</span>
<a name="line-81"></a>
<a name="line-82"></a>            <span class='hs-varid'>occurs_check</span> 
<a name="line-83"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>act_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>act_kind</span>
<a name="line-84"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_occ</span> <span class='hs-varid'>act_tv</span> <span class='hs-varid'>exp_kind</span>
<a name="line-85"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>exp_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>exp_kind</span>
<a name="line-86"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_occ</span> <span class='hs-varid'>exp_tv</span> <span class='hs-varid'>act_kind</span>
<a name="line-87"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-88"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-89"></a>
<a name="line-90"></a>            <span class='hs-varid'>check_occ</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>occurCheckExpand</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a>                                <span class='hs-conid'>OC_Occurs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-92"></a>                                <span class='hs-sel'>_bad</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-93"></a>
<a name="line-94"></a>            <span class='hs-varid'>err</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUnliftedTypeKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-95"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting a lifted type, but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-96"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is unlifted"</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnliftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-99"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting an unlifted type, but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is lifted"</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>occurs_check</span>   <span class='hs-comment'>-- Must precede the "more args expected" check</span>
<a name="line-103"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind occurs check"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>more_info</span>
<a name="line-104"></a>
<a name="line-105"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_exp_as</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_act_as</span>     <span class='hs-comment'>-- E.g. [Maybe]</span>
<a name="line-106"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-107"></a>                         <span class='hs-varid'>speakN</span> <span class='hs-varid'>n_diff_as</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"more argument"</span><span class='hs-layout'>)</span>
<a name="line-108"></a>                         <span class='hs-varop'>&lt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>n_diff_as</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>1</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'s'</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-109"></a>                         <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-110"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>more_info</span> <span class='hs-keyglyph'>]</span>
<a name="line-111"></a>
<a name="line-112"></a>                  <span class='hs-comment'>-- Now n_exp_as &gt;= n_act_as. In the next two cases,</span>
<a name="line-113"></a>                  <span class='hs-comment'>-- n_exp_as == 0, and hence so is n_act_as</span>
<a name="line-114"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-comment'>-- E.g. Monad [Int]</span>
<a name="line-115"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>more_info</span>
<a name="line-116"></a>
<a name="line-117"></a>            <span class='hs-varid'>more_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ek_ctxt</span> <span class='hs-varid'>tidy_exp_kind</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-118"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-119"></a>                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>tidy_act_kind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-120"></a>
<a name="line-121"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_act_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_exp_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>env1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span>
<a name="line-122"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-123"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Sort checking kinds
%*                                                                      *
%************************************************************************

tcLHsKind converts a user-written kind to an internal, sort-checked kind.
It does sort checking and desugaring at the same time, in one single pass.
It fails when the kinds are not well-formed (eg. data A :: * Int), or if there
are non-promotable or non-fully applied kinds.

\begin{code}
<pre><a name="line-1"></a><a name="tcLHsKind"></a><span class='hs-definition'>tcLHsKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2"></a><span class='hs-definition'>tcLHsKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-3"></a>              <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>k</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="tc_lhs_kind"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-6"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_hs_kind</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="tc_hs_kind"></a><span class='hs-comment'>-- The main worker</span>
<a name="line-9"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-10"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_kind_var_app</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span>
<a name="line-11"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_kind_app</span> <span class='hs-varid'>k</span> <span class='hs-conid'>[]</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-16"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappa_ki1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki1</span>
<a name="line-17"></a>     <span class='hs-varid'>kappa_ki2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki2</span>
<a name="line-18"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKind</span> <span class='hs-varid'>kappa_ki1</span> <span class='hs-varid'>kappa_ki2</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-21"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki</span>
<a name="line-22"></a>     <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-23"></a>     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPromotedListTy</span> <span class='hs-varid'>kappa</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-26"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>kis</span>
<a name="line-27"></a>     <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-28"></a>     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>kappas</span>
<a name="line-29"></a>  <span class='hs-keyword'>where</span> 
<a name="line-30"></a>     <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleTyCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-comment'>-- Argument not kind-shaped</span>
<a name="line-33"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tc_hs_kind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="tc_kind_app"></a><span class='hs-comment'>-- Special case for kind application</span>
<a name="line-36"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-37"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span> <span class='hs-varid'>kis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_kind_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ki1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ki2</span><span class='hs-conop'>:</span><span class='hs-varid'>kis</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>      <span class='hs-varid'>kis</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>kis</span>
<a name="line-39"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_kind_var_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>arg_kis</span> <span class='hs-layout'>}</span>
<a name="line-40"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-varid'>ki</span>                <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-41"></a>                                    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a kind constructor"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="tc_kind_var_app"></a><span class='hs-definition'>tc_kind_var_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-44"></a><span class='hs-comment'>-- Special case for * and Constraint kinds</span>
<a name="line-45"></a><span class='hs-comment'>-- They are kinds already, so we don't need to promote them</span>
<a name="line-46"></a><span class='hs-definition'>tc_kind_var_app</span> <span class='hs-varid'>name</span> <span class='hs-varid'>arg_kis</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>liftedTypeKindTyConName</span>
<a name="line-48"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>constraintKindTyConName</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-50"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be applied"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-51"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-52"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-53"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-54"></a>           <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_kind_var_app 1"</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-comment'>-- General case</span>
<a name="line-57"></a><span class='hs-definition'>tc_kind_var_app</span> <span class='hs-varid'>name</span> <span class='hs-varid'>arg_kis</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-60"></a>  	   <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-62"></a>  	           <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  	     	   <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>promotableTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-64"></a>  	     	       <span class='hs-conid'>Just</span> <span class='hs-varid'>prom_tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arg_kis</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>prom_tc</span>
<a name="line-65"></a>  	     	               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>prom_tc</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-66"></a>  	     	       <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tycon_err</span> <span class='hs-varid'>tc</span> <span class='hs-str'>"is not fully applied"</span>
<a name="line-67"></a>  	     	       <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tycon_err</span> <span class='hs-varid'>tc</span> <span class='hs-str'>"is not promotable"</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>
<a name="line-69"></a>  	   <span class='hs-comment'>-- A lexically scoped kind variable</span>
<a name="line-70"></a>  	   <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind_var</span> 
<a name="line-71"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isKindVar</span> <span class='hs-varid'>kind_var</span><span class='hs-layout'>)</span> 
<a name="line-72"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind_var</span><span class='hs-layout'>)</span>
<a name="line-73"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used as a kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-74"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Kind variables always have kind BOX, </span>
<a name="line-75"></a>                                  <span class='hs-comment'>-- so cannot be applied to anything</span>
<a name="line-76"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-77"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot appear in a function position"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-78"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-79"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>kind_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a>  	   <span class='hs-comment'>-- It is in scope, but not what we expected</span>
<a name="line-82"></a>  	   <span class='hs-conid'>AThing</span> <span class='hs-keyword'>_</span> 
<a name="line-83"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVarName</span> <span class='hs-varid'>name</span> 
<a name="line-84"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used in a kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-86"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-87"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used in a kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-89"></a>  	                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inside its own recursive group"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-90"></a>
<a name="line-91"></a>           <span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-92"></a>
<a name="line-93"></a>  	   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"promoted type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span>
<a name="line-94"></a>                <span class='hs-comment'>-- This really should not happen</span>
<a name="line-95"></a>     <span class='hs-layout'>}</span>
<a name="line-96"></a>  <span class='hs-keyword'>where</span> 
<a name="line-97"></a>   <span class='hs-varid'>tycon_err</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of kind"</span><span class='hs-layout'>)</span>
<a name="line-98"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="dataKindsErr"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-101"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-varid'>name</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal kind:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-103"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="promotionErr"></a><span class='hs-definition'>promotionErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-106"></a><span class='hs-definition'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot be used here"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-108"></a>                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-109"></a>  <span class='hs-keyword'>where</span>
<a name="line-110"></a>    <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>of</span>
<a name="line-111"></a>               <span class='hs-conid'>FamDataConPE</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"it comes from a data family instance"</span><span class='hs-layout'>)</span>
<a name="line-112"></a>               <span class='hs-conid'>NoDataKinds</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span><span class='hs-layout'>)</span>
<a name="line-113"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"it is defined and used in the same recursive group"</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
		Scoped type variables
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="pprHsSigCtxt"></a><span class='hs-definition'>pprHsSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>pprHsSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span> 
<a name="line-3"></a>				 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_sig</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span>
<a name="line-6"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConArgCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span>
<a name="line-7"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span>
<a name="line-8"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a>    <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="badPatSigTvs"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-13"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>                 <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>          	 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"should be bound by the pattern signature"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-17"></a>	  	 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but are actually discarded by a type synonym"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-18"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To fix this, expand the type synonym"</span><span class='hs-layout'>)</span> 
<a name="line-19"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[Note: I hope to lift this restriction in due course]"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="unifyKindMisMatch"></a><span class='hs-definition'>unifyKindMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-22"></a><span class='hs-definition'>unifyKindMisMatch</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-23"></a>    <span class='hs-varid'>ki1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ki1</span>
<a name="line-24"></a>    <span class='hs-varid'>ki2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ki2</span>
<a name="line-25"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki1'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>                      <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"against"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>                      <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki2'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-29"></a>    <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
</pre>\end{code}

</body>
</html>
