<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>stgSyn/StgSyn.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[StgSyn]{Shared term graph (STG) syntax for spineless-tagless code generation}

This data type represents programs just before code generation (conversion to
@Cmm@): basically, what we have is a stylised form of @CoreSyntax@, the style
being one that happens to be ideally suited to spineless tagless code
generation.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>StgSyn</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>        <span class='hs-conid'>GenStgArg</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-conid'>GenStgLiveVars</span><span class='hs-layout'>,</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-conid'>GenStgBinding</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenStgExpr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenStgRhs</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-conid'>GenStgAlt</span><span class='hs-layout'>,</span> <span class='hs-conid'>AltType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-8"></a>
<a name="line-9"></a>        <span class='hs-conid'>UpdateFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUpdatable</span><span class='hs-layout'>,</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-conid'>StgBinderInfo</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>noBinderInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stgSatOcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stgUnsatOcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>satCallsOnly</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>combineStgBinderInfo</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-comment'>-- a set of synonyms for the most common (only :-) parameterisation</span>
<a name="line-16"></a>        <span class='hs-conid'>StgArg</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgLiveVars</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-conid'>StgBinding</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgRhs</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgAlt</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-comment'>-- StgOp</span>
<a name="line-20"></a>        <span class='hs-conid'>StgOp</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-comment'>-- SRTs</span>
<a name="line-23"></a>        <span class='hs-conid'>SRT</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-comment'>-- utils</span>
<a name="line-26"></a>        <span class='hs-varid'>stgBindHasCafRefs</span><span class='hs-layout'>,</span> <span class='hs-varid'>stgArgHasCafRefs</span><span class='hs-layout'>,</span> <span class='hs-varid'>stgRhsArity</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>isDllConApp</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>stgArgType</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>        <span class='hs-varid'>pprStgBinding</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprStgBindings</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>pprStgLVs</span>
<a name="line-32"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bitmap</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>     <span class='hs-layout'>(</span> <span class='hs-conid'>AltCon</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>CostCentreStack</span><span class='hs-layout'>,</span> <span class='hs-conid'>CostCentre</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ForeignCall</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>     <span class='hs-layout'>(</span> <span class='hs-conid'>Literal</span><span class='hs-layout'>,</span> <span class='hs-varid'>literalType</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Packages</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>isDllName</span> <span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>     <span class='hs-layout'>(</span> <span class='hs-comment'>{- instances -}</span> <span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>PrimOp</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimCall</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>PrimRep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>        <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>typePrimRep</span> <span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span> <span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>IdSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{@GenStgBinding@}
%*                                                                      *
%************************************************************************

As usual, expressions are interesting; other things are boring. Here
are the boring things [except note the @GenStgRhs@], parameterised
with respect to binder and occurrence information (just as in
@CoreSyn@):

There is one SRT for each group of bindings.

\begin{code}
<pre><a name="line-1"></a><a name="GenStgBinding"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GenStgBinding</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenStgRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgRec</span>    <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenStgRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{@GenStgArg@}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="GenStgArg"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GenStgArg</span> <span class='hs-varid'>occ</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgVarArg</span>  <span class='hs-varid'>occ</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgLitArg</span>  <span class='hs-conid'>Literal</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="isDllConApp"></a><span class='hs-comment'>-- | Does this constructor application refer to</span>
<a name="line-6"></a><span class='hs-comment'>-- anything in a different *Windows* DLL?</span>
<a name="line-7"></a><span class='hs-comment'>-- If so, we can't allocate it statically</span>
<a name="line-8"></a><span class='hs-definition'>isDllConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-9"></a><span class='hs-definition'>isDllConApp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-10"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-conid'>OSMinGW32</span>
<a name="line-11"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDllName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_dll_arg</span> <span class='hs-varid'>args</span>
<a name="line-12"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-comment'>-- NB: typePrimRep is legit because any free variables won't have</span>
<a name="line-15"></a>    <span class='hs-comment'>-- unlifted type (there are no unlifted things at top level)</span>
<a name="line-16"></a>    <span class='hs-varid'>is_dll_arg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-17"></a>    <span class='hs-varid'>is_dll_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isAddrRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>typePrimRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                             <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isDllName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>this_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-19"></a>    <span class='hs-varid'>is_dll_arg</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="isAddrRep"></a><span class='hs-comment'>-- True of machine addresses; these are the things that don't</span>
<a name="line-24"></a><span class='hs-comment'>-- work across DLLs. The key point here is that VoidRep comes</span>
<a name="line-25"></a><span class='hs-comment'>-- out False, so that a top level nullary GADT constructor is</span>
<a name="line-26"></a><span class='hs-comment'>-- False for isDllConApp</span>
<a name="line-27"></a><span class='hs-comment'>--    data T a where</span>
<a name="line-28"></a><span class='hs-comment'>--      T1 :: T Int</span>
<a name="line-29"></a><span class='hs-comment'>-- gives</span>
<a name="line-30"></a><span class='hs-comment'>--    T1 :: forall a. (a~Int) -&gt; T a</span>
<a name="line-31"></a><span class='hs-comment'>-- and hence the top-level binding</span>
<a name="line-32"></a><span class='hs-comment'>--    $WT1 :: T Int</span>
<a name="line-33"></a><span class='hs-comment'>--    $WT1 = T1 Int (Coercion (Refl Int))</span>
<a name="line-34"></a><span class='hs-comment'>-- The coercion argument here gets VoidRep</span>
<a name="line-35"></a><span class='hs-definition'>isAddrRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-36"></a><span class='hs-definition'>isAddrRep</span> <span class='hs-conid'>AddrRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-37"></a><span class='hs-definition'>isAddrRep</span> <span class='hs-conid'>PtrRep</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-38"></a><span class='hs-definition'>isAddrRep</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="stgArgType"></a><span class='hs-comment'>-- | Type of an @StgArg@</span>
<a name="line-41"></a><span class='hs-comment'>--</span>
<a name="line-42"></a><span class='hs-comment'>-- Very half baked becase we have lost the type arguments.</span>
<a name="line-43"></a><span class='hs-definition'>stgArgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-44"></a><span class='hs-definition'>stgArgType</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>v</span>
<a name="line-45"></a><span class='hs-definition'>stgArgType</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLitArg</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>literalType</span> <span class='hs-varid'>lit</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{STG expressions}
%*                                                                      *
%************************************************************************

The @GenStgExpr@ data type is parameterised on binder and occurrence
info, as before.

%************************************************************************
%*                                                                      *
\subsubsection{@GenStgExpr@ application}
%*                                                                      *
%************************************************************************

An application is of a function to a list of atoms [not expressions].
Operationally, we want to push the arguments on the stack and call the
function. (If the arguments were expressions, we would have to build
their closures first.)

There is no constructor for a lone variable; it would appear as
@StgApp var [] _@.
\begin{code}
<pre><a name="line-1"></a><a name="GenStgLiveVars"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>GenStgLiveVars</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqSet</span> <span class='hs-varid'>occ</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="GenStgExpr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgApp</span>
<a name="line-5"></a>        <span class='hs-varid'>occ</span>             <span class='hs-comment'>-- function</span>
<a name="line-6"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenStgArg</span> <span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- arguments; may be empty</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{@StgConApp@ and @StgPrimApp@---saturated applications}
%*                                                                      *
%************************************************************************

There are a specialised forms of application, for constructors,
primitives, and literals.
\begin{code}
<pre><a name="line-1"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgLit</span>      <span class='hs-conid'>Literal</span>
<a name="line-2"></a>
<a name="line-3"></a>        <span class='hs-comment'>-- StgConApp is vital for returning unboxed tuples</span>
<a name="line-4"></a>        <span class='hs-comment'>-- which can't be let-bound first</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgConApp</span>   <span class='hs-conid'>DataCon</span>
<a name="line-6"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenStgArg</span> <span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Saturated</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgOpApp</span>    <span class='hs-conid'>StgOp</span>           <span class='hs-comment'>-- Primitive op or foreign call</span>
<a name="line-9"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenStgArg</span> <span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Saturated</span>
<a name="line-10"></a>                <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- Result type</span>
<a name="line-11"></a>                                <span class='hs-comment'>-- We need to know this so that we can</span>
<a name="line-12"></a>                                <span class='hs-comment'>-- assign result registers</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{@StgLam@}
%*                                                                      *
%************************************************************************

StgLam is used *only* during CoreToStg's work. Before CoreToStg has
finished it encodes (\x -> e) as (let f = \x -> e in f)

\begin{code}
<pre><a name="line-1"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgLam</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>bndr</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>        <span class='hs-conid'>StgExpr</span>    <span class='hs-comment'>-- Body of lambda</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsubsection{@GenStgExpr@: case-expressions}
%*                                                                      *
%************************************************************************

This has the same boxed/unboxed business as Core case expressions.
\begin{code}
<pre><a name="line-1"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgCase</span>
<a name="line-2"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-3"></a>                    <span class='hs-comment'>-- the thing to examine</span>
<a name="line-4"></a>
<a name="line-5"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgLiveVars</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-6"></a>                    <span class='hs-comment'>-- Live vars of whole case expression,</span>
<a name="line-7"></a>                    <span class='hs-comment'>-- plus everything that happens after the case</span>
<a name="line-8"></a>                    <span class='hs-comment'>-- i.e., those which mustn't be overwritten</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgLiveVars</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                    <span class='hs-comment'>-- Live vars of RHSs (plus what happens afterwards)</span>
<a name="line-12"></a>                    <span class='hs-comment'>-- i.e., those which must be saved before eval.</span>
<a name="line-13"></a>                    <span class='hs-comment'>--</span>
<a name="line-14"></a>                    <span class='hs-comment'>-- note that an alt's constructor's</span>
<a name="line-15"></a>                    <span class='hs-comment'>-- binder-variables are NOT counted in the</span>
<a name="line-16"></a>                    <span class='hs-comment'>-- free vars for the alt's RHS</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-varid'>bndr</span>        <span class='hs-comment'>-- binds the result of evaluating the scrutinee</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-conid'>SRT</span>         <span class='hs-comment'>-- The SRT for the continuation</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-conid'>AltType</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenStgAlt</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>                    <span class='hs-comment'>-- The DEFAULT case is always *first*</span>
<a name="line-26"></a>                    <span class='hs-comment'>-- if it is there at all</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{@GenStgExpr@: @let(rec)@-expressions}
%*                                                                      *
%************************************************************************

The various forms of let(rec)-expression encode most of the
interesting things we want to do.
\begin{enumerate}
\item
\begin{verbatim}
let-closure x = [free-vars] [args] expr
in e
\end{verbatim}
is equivalent to
\begin{verbatim}
let x = (\free-vars -> \args -> expr) free-vars
\end{verbatim}
\tr{args} may be empty (and is for most closures).  It isn't under
circumstances like this:
\begin{verbatim}
let x = (\y -> y+z)
\end{verbatim}
This gets mangled to
\begin{verbatim}
let-closure x = [z] [y] (y+z)
\end{verbatim}
The idea is that we compile code for @(y+z)@ in an environment in which
@z@ is bound to an offset from \tr{Node}, and @y@ is bound to an
offset from the stack pointer.

(A let-closure is an @StgLet@ with a @StgRhsClosure@ RHS.)

\item
\begin{verbatim}
let-constructor x = Constructor [args]
in e
\end{verbatim}

(A let-constructor is an @StgLet@ with a @StgRhsCon@ RHS.)

\item
Letrec-expressions are essentially the same deal as
let-closure/let-constructor, so we use a common structure and
distinguish between them with an @is_recursive@ boolean flag.

\item
\begin{verbatim}
let-unboxed u = an arbitrary arithmetic expression in unboxed values
in e
\end{verbatim}
All the stuff on the RHS must be fully evaluated.
No function calls either!

(We've backed away from this toward case-expressions with
suitably-magical alts ...)

\item
~[Advanced stuff here! Not to start with, but makes pattern matching
generate more efficient code.]

\begin{verbatim}
let-escapes-not fail = expr
in e'
\end{verbatim}
Here the idea is that @e'@ guarantees not to put @fail@ in a data structure,
or pass it to another function. All @e'@ will ever do is tail-call @fail@.
Rather than build a closure for @fail@, all we need do is to record the stack
level at the moment of the @let-escapes-not@; then entering @fail@ is just
a matter of adjusting the stack pointer back down to that point and entering
the code for it.

Another example:
\begin{verbatim}
f x y = let z = huge-expression in
        if y==1 then z else
        if y==2 then z else
        1
\end{verbatim}

(A let-escapes-not is an @StgLetNoEscape@.)

\item
We may eventually want:
\begin{verbatim}
let-literal x = Literal
in e
\end{verbatim}
\end{enumerate}

And so the code for let(rec)-things:
\begin{code}
<pre><a name="line-1"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgLet</span>
<a name="line-2"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgBinding</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- right hand sides (see below)</span>
<a name="line-3"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- body</span>
<a name="line-4"></a>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgLetNoEscape</span>                  <span class='hs-comment'>-- remember: ``advanced stuff''</span>
<a name="line-6"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgLiveVars</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Live in the whole let-expression</span>
<a name="line-7"></a>                                    <span class='hs-comment'>-- Mustn't overwrite these stack slots</span>
<a name="line-8"></a>                                    <span class='hs-comment'>-- _Doesn't_ include binders of the let(rec).</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgLiveVars</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Live in the right hand sides (only)</span>
<a name="line-11"></a>                                    <span class='hs-comment'>-- These are the ones which must be saved on</span>
<a name="line-12"></a>                                    <span class='hs-comment'>-- the stack if they aren't there already</span>
<a name="line-13"></a>                                    <span class='hs-comment'>-- _Does_ include binders of the let(rec) if recursive.</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgBinding</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- right hand sides (see below)</span>
<a name="line-16"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- body</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{@GenStgExpr@: @scc@ expressions}
%*                                                                      *
%************************************************************************

For @scc@ expressions we introduce a new STG construct.

\begin{code}
<pre><a name="line-1"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgSCC</span>
<a name="line-2"></a>        <span class='hs-conid'>CostCentre</span>             <span class='hs-comment'>-- label of SCC expression</span>
<a name="line-3"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>Bool</span>                  <span class='hs-comment'>-- bump the entry count?</span>
<a name="line-4"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>Bool</span>                  <span class='hs-comment'>-- push the cost centre?</span>
<a name="line-5"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- scc expression</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{@GenStgExpr@: @hpc@ expressions}
%*                                                                      *
%************************************************************************

Finally for @hpc@ expressions we introduce a new STG construct.

\begin{code}
<pre><a name="line-1"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgTick</span>
<a name="line-2"></a>        <span class='hs-conid'>Module</span>                 <span class='hs-comment'>-- the module of the source of this tick</span>
<a name="line-3"></a>        <span class='hs-conid'>Int</span>                    <span class='hs-comment'>-- tick number</span>
<a name="line-4"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- sub expression</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>-- END of GenStgExpr</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{STG right-hand sides}
%*                                                                      *
%************************************************************************

Here's the rest of the interesting stuff for @StgLet@s; the first
flavour is for closures:
\begin{code}
<pre><a name="line-1"></a><a name="GenStgRhs"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GenStgRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRhsClosure</span>
<a name="line-3"></a>        <span class='hs-conid'>CostCentreStack</span>         <span class='hs-comment'>-- CCS to be attached (default is CurrentCCS)</span>
<a name="line-4"></a>        <span class='hs-conid'>StgBinderInfo</span>           <span class='hs-comment'>-- Info about how this binder is used (see below)</span>
<a name="line-5"></a>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span>                   <span class='hs-comment'>-- non-global free vars; a list, rather than</span>
<a name="line-6"></a>                                <span class='hs-comment'>-- a set, because order is important</span>
<a name="line-7"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>UpdateFlag</span>             <span class='hs-comment'>-- ReEntrant | Updatable | SingleEntry</span>
<a name="line-8"></a>        <span class='hs-conid'>SRT</span>                     <span class='hs-comment'>-- The SRT reference</span>
<a name="line-9"></a>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>bndr</span><span class='hs-keyglyph'>]</span>                  <span class='hs-comment'>-- arguments; if empty, then not a function;</span>
<a name="line-10"></a>                                <span class='hs-comment'>-- as above, order is important.</span>
<a name="line-11"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- body</span>
</pre>\end{code}
An example may be in order.  Consider:
\begin{verbatim}
let t = \x -> \y -> ... x ... y ... p ... q in e
\end{verbatim}
Pulling out the free vars and stylising somewhat, we get the equivalent:
\begin{verbatim}
let t = (\[p,q] -> \[x,y] -> ... x ... y ... p ...q) p q
\end{verbatim}
Stg-operationally, the @[x,y]@ are on the stack, the @[p,q]@ are
offsets from @Node@ into the closure, and the code ptr for the closure
will be exactly that in parentheses above.

The second flavour of right-hand-side is for constructors (simple but important):
\begin{code}
<pre><a name="line-1"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgRhsCon</span>
<a name="line-2"></a>        <span class='hs-conid'>CostCentreStack</span>  <span class='hs-comment'>-- CCS to be attached (default is CurrentCCS).</span>
<a name="line-3"></a>                         <span class='hs-comment'>-- Top-level (static) ones will end up with</span>
<a name="line-4"></a>                         <span class='hs-comment'>-- DontCareCCS, because we don't count static</span>
<a name="line-5"></a>                         <span class='hs-comment'>-- data in heap profiles, and we don't set CCCS</span>
<a name="line-6"></a>                         <span class='hs-comment'>-- from static closure.</span>
<a name="line-7"></a>        <span class='hs-conid'>DataCon</span>          <span class='hs-comment'>-- constructor</span>
<a name="line-8"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenStgArg</span> <span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- args</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="stgRhsArity"></a><span class='hs-definition'>stgRhsArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-11"></a><span class='hs-definition'>stgRhsArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>)</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bndrs</span>
<a name="line-13"></a>  <span class='hs-comment'>-- The arity never includes type parameters, but they should have gone by now</span>
<a name="line-14"></a><span class='hs-definition'>stgRhsArity</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="stgBindHasCafRefs"></a><span class='hs-definition'>stgBindHasCafRefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GenStgBinding</span> <span class='hs-varid'>bndr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-17"></a><span class='hs-definition'>stgBindHasCafRefs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhsHasCafRefs</span> <span class='hs-varid'>rhs</span>
<a name="line-18"></a><span class='hs-definition'>stgBindHasCafRefs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>rhsHasCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="rhsHasCafRefs"></a><span class='hs-definition'>rhsHasCafRefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GenStgRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-21"></a><span class='hs-definition'>rhsHasCafRefs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>upd</span> <span class='hs-varid'>srt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUpdatable</span> <span class='hs-varid'>upd</span> <span class='hs-varop'>||</span> <span class='hs-varid'>nonEmptySRT</span> <span class='hs-varid'>srt</span>
<a name="line-23"></a><span class='hs-definition'>rhsHasCafRefs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>stgArgHasCafRefs</span> <span class='hs-varid'>args</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="stgArgHasCafRefs"></a><span class='hs-definition'>stgArgHasCafRefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GenStgArg</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-27"></a><span class='hs-definition'>stgArgHasCafRefs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-definition'>stgArgHasCafRefs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Here's the @StgBinderInfo@ type, and its combining op:
\begin{code}
<pre><a name="line-1"></a><a name="StgBinderInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoStgBinderInfo</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SatCallsOnly</span>        <span class='hs-comment'>-- All occurrences are *saturated* *function* calls</span>
<a name="line-4"></a>                        <span class='hs-comment'>-- This means we don't need to build an info table and</span>
<a name="line-5"></a>                        <span class='hs-comment'>-- slow entry code for the thing</span>
<a name="line-6"></a>                        <span class='hs-comment'>-- Thunks never get this value</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="noBinderInfo"></a><span class='hs-definition'>noBinderInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stgUnsatOcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stgSatOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-9"></a><span class='hs-definition'>noBinderInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoStgBinderInfo</span>
<a name="line-10"></a><a name="stgUnsatOcc"></a><span class='hs-definition'>stgUnsatOcc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoStgBinderInfo</span>
<a name="line-11"></a><a name="stgSatOcc"></a><span class='hs-definition'>stgSatOcc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SatCallsOnly</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="satCallsOnly"></a><span class='hs-definition'>satCallsOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgBinderInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-14"></a><span class='hs-definition'>satCallsOnly</span> <span class='hs-conid'>SatCallsOnly</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-15"></a><span class='hs-definition'>satCallsOnly</span> <span class='hs-conid'>NoStgBinderInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="combineStgBinderInfo"></a><span class='hs-definition'>combineStgBinderInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgBinderInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-18"></a><span class='hs-definition'>combineStgBinderInfo</span> <span class='hs-conid'>SatCallsOnly</span> <span class='hs-conid'>SatCallsOnly</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SatCallsOnly</span>
<a name="line-19"></a><span class='hs-definition'>combineStgBinderInfo</span> <span class='hs-keyword'>_</span>            <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoStgBinderInfo</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="pp_binder_info"></a><span class='hs-comment'>--------------</span>
<a name="line-22"></a><span class='hs-definition'>pp_binder_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgBinderInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-23"></a><span class='hs-definition'>pp_binder_info</span> <span class='hs-conid'>NoStgBinderInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-24"></a><span class='hs-definition'>pp_binder_info</span> <span class='hs-conid'>SatCallsOnly</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"sat-only"</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[Stg-case-alternatives]{STG case alternatives}
%*                                                                      *
%************************************************************************

Very like in @CoreSyntax@ (except no type-world stuff).

The type constructor is guaranteed not to be abstract; that is, we can
see its representation. This is important because the code generator
uses it to determine return conventions etc. But it's not trivial
where there's a moduule loop involved, because some versions of a type
constructor might not have all the constructors visible. So
mkStgAlgAlts (in CoreToStg) ensures that it gets the TyCon from the
constructors or literals (which are guaranteed to have the Real McCoy)
rather than from the scrutinee type.

\begin{code}
<pre><a name="line-1"></a><a name="GenStgAlt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>GenStgAlt</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltCon</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- alts: data constructor,</span>
<a name="line-3"></a>     <span class='hs-keyglyph'>[</span><span class='hs-varid'>bndr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- constructor's parameters,</span>
<a name="line-4"></a>     <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- "use mask", same length as</span>
<a name="line-5"></a>                        <span class='hs-comment'>-- parameters; a True in a</span>
<a name="line-6"></a>                        <span class='hs-comment'>-- param's position if it is</span>
<a name="line-7"></a>                        <span class='hs-comment'>-- used in the ...</span>
<a name="line-8"></a>     <span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- ...right-hand side.</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="AltType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>AltType</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PolyAlt</span>             <span class='hs-comment'>-- Polymorphic (a type variable)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UbxTupAlt</span> <span class='hs-conid'>Int</span>       <span class='hs-comment'>-- Unboxed tuple of this arity</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AlgAlt</span>    <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- Algebraic data type; the AltCons will be DataAlts</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PrimAlt</span>   <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- Primitive data type; the AltCons will be LitAlts</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[Stg]{The Plain STG parameterisation}
%*                                                                      *
%************************************************************************

This happens to be the only one we use at the moment.

\begin{code}
<pre><a name="line-1"></a><a name="StgBinding"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgBinding</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenStgBinding</span>  <span class='hs-conid'>Id</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><a name="StgArg"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgArg</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenStgArg</span>      <span class='hs-conid'>Id</span>
<a name="line-3"></a><a name="StgLiveVars"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgLiveVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenStgLiveVars</span> <span class='hs-conid'>Id</span>
<a name="line-4"></a><a name="StgExpr"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgExpr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenStgExpr</span>     <span class='hs-conid'>Id</span> <span class='hs-conid'>Id</span>
<a name="line-5"></a><a name="StgRhs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgRhs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenStgRhs</span>      <span class='hs-conid'>Id</span> <span class='hs-conid'>Id</span>
<a name="line-6"></a><a name="StgAlt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgAlt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenStgAlt</span>      <span class='hs-conid'>Id</span> <span class='hs-conid'>Id</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection[UpdateFlag-datatype]{@UpdateFlag@}
%*                                                                      *
%************************************************************************

This is also used in @LambdaFormInfo@ in the @ClosureInfo@ module.

A @ReEntrant@ closure may be entered multiple times, but should not be
updated or blackholed. An @Updatable@ closure should be updated after
evaluation (and may be blackholed during evaluation). A @SingleEntry@
closure will only be entered once, and so need not be updated but may
safely be blackholed.

\begin{code}
<pre><a name="line-1"></a><a name="UpdateFlag"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UpdateFlag</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReEntrant</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Updatable</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SingleEntry</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>UpdateFlag</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>u</span> <span class='hs-keyword'>of</span>
<a name="line-5"></a>                       <span class='hs-conid'>ReEntrant</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-chr'>'r'</span>
<a name="line-6"></a>                       <span class='hs-conid'>Updatable</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-chr'>'u'</span>
<a name="line-7"></a>                       <span class='hs-conid'>SingleEntry</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-chr'>'s'</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="isUpdatable"></a><span class='hs-definition'>isUpdatable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UpdateFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-10"></a><span class='hs-definition'>isUpdatable</span> <span class='hs-conid'>ReEntrant</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-11"></a><span class='hs-definition'>isUpdatable</span> <span class='hs-conid'>SingleEntry</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-12"></a><span class='hs-definition'>isUpdatable</span> <span class='hs-conid'>Updatable</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsubsection{StgOp}
%*                                                                      *
%************************************************************************

An StgOp allows us to group together PrimOps and ForeignCalls.
It's quite useful to move these around together, notably
in StgOpApp and COpStmt.

\begin{code}
<pre><a name="line-1"></a><a name="StgOp"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StgOp</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgPrimOp</span>  <span class='hs-conid'>PrimOp</span>
<a name="line-3"></a>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgPrimCallOp</span> <span class='hs-conid'>PrimCall</span>
<a name="line-5"></a>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StgFCallOp</span> <span class='hs-conid'>ForeignCall</span> <span class='hs-conid'>Unique</span>
<a name="line-7"></a>        <span class='hs-comment'>-- The Unique is occasionally needed by the C pretty-printer</span>
<a name="line-8"></a>        <span class='hs-comment'>-- (which lacks a unique supply), notably when generating a</span>
<a name="line-9"></a>        <span class='hs-comment'>-- typedef for foreign-export-dynamic</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsubsection[Static Reference Tables]{@SRT@}
%*                                                                      *
%************************************************************************

There is one SRT per top-level function group. Each local binding and
case expression within this binding group has a subrange of the whole
SRT, expressed as an offset and length.

In CoreToStg we collect the list of CafRefs at each SRT site, which is later
converted into the length and offset form by the SRT pass.

\begin{code}
<pre><a name="line-1"></a><a name="SRT"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SRT</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoSRT</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SRTEntries</span> <span class='hs-conid'>IdSet</span>
<a name="line-4"></a>        <span class='hs-comment'>-- generated by CoreToStg</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SRT</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span><span class='hs-comment'>{-offset-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span><span class='hs-comment'>{-length-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Bitmap</span><span class='hs-comment'>{-bitmap-}</span>
<a name="line-6"></a>        <span class='hs-comment'>-- generated by computeSRTs</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="nonEmptySRT"></a><span class='hs-definition'>nonEmptySRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SRT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-9"></a><span class='hs-definition'>nonEmptySRT</span> <span class='hs-conid'>NoSRT</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-10"></a><span class='hs-definition'>nonEmptySRT</span> <span class='hs-layout'>(</span><span class='hs-conid'>SRTEntries</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-definition'>nonEmptySRT</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="pprSRT"></a><span class='hs-definition'>pprSRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SRT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-14"></a><span class='hs-definition'>pprSRT</span> <span class='hs-layout'>(</span><span class='hs-conid'>NoSRT</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"_no_srt_"</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>pprSRT</span> <span class='hs-layout'>(</span><span class='hs-conid'>SRTEntries</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"SRT:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ids</span>
<a name="line-16"></a><span class='hs-definition'>pprSRT</span> <span class='hs-layout'>(</span><span class='hs-conid'>SRT</span> <span class='hs-varid'>off</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>off</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"*bitmap*"</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[Stg-pretty-printing]{Pretty-printing}
%*                                                                      *
%************************************************************************

Robin Popplestone asked for semi-colon separators on STG binds; here's
hoping he likes terminators instead...  Ditto for case alternatives.

\begin{code}
<pre><a name="line-1"></a><a name="pprGenStgBinding"></a><span class='hs-definition'>pprGenStgBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span>
<a name="line-2"></a>                 <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>GenStgBinding</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bdee</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-definition'>pprGenStgBinding</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LetBind</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>equals</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-6"></a>        <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>pprGenStgBinding</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"{- StgRec (begin) -}"</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span>
<a name="line-10"></a>           <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_bind</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ifPprDebug</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"{- StgRec (end) -}"</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>ppr_bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-13"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LetBind</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>equals</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-14"></a>             <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="pprStgBinding"></a><span class='hs-definition'>pprStgBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgBinding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-17"></a><span class='hs-definition'>pprStgBinding</span>  <span class='hs-varid'>bind</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprGenStgBinding</span> <span class='hs-varid'>bind</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="pprStgBindings"></a><span class='hs-definition'>pprStgBindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgBinding</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-20"></a><span class='hs-definition'>pprStgBindings</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprGenStgBinding</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenStgArg</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprStgArg</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span>
<a name="line-26"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenStgBinding</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-27"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprGenStgBinding</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprStgExpr</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span>
<a name="line-34"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenStgRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-35"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprStgRhs</span> <span class='hs-varid'>rhs</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="pprStgArg"></a><span class='hs-definition'>pprStgArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>GenStgArg</span> <span class='hs-varid'>bdee</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-38"></a><span class='hs-definition'>pprStgArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>var</span>
<a name="line-39"></a><span class='hs-definition'>pprStgArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLitArg</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="pprStgExpr"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span>
<a name="line-42"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>GenStgExpr</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bdee</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-43"></a><span class='hs-comment'>-- special case</span>
<a name="line-44"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>lit</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-comment'>-- general case</span>
<a name="line-47"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>func</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>func</span><span class='hs-layout'>)</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>interppSP</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgOpApp</span> <span class='hs-varid'>op</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprStgOp</span> <span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>interppSP</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLam</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'\\'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_list</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LambdaBind</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-58"></a>            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-&gt;"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-59"></a>         <span class='hs-varid'>pprStgExpr</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>]</span>
<a name="line-60"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>ppr_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fsep</span> <span class='hs-varop'>.</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-comment'>-- special case: let v = &lt;very specific thing&gt;</span>
<a name="line-63"></a><span class='hs-comment'>--               in</span>
<a name="line-64"></a><span class='hs-comment'>--               let ...</span>
<a name="line-65"></a><span class='hs-comment'>--               in</span>
<a name="line-66"></a><span class='hs-comment'>--               ...</span>
<a name="line-67"></a><span class='hs-comment'>--</span>
<a name="line-68"></a><span class='hs-comment'>-- Very special!  Suspicious! (SLPJ)</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-comment'>{-
<a name="line-71"></a>pprStgExpr (StgLet srt (StgNonRec bndr (StgRhsClosure cc bi free_vars upd_flag args rhs))
<a name="line-72"></a>                        expr@(StgLet _ _))
<a name="line-73"></a>  = ($$)
<a name="line-74"></a>      (hang (hcat [ptext (sLit "let { "), ppr bndr, ptext (sLit " = "),
<a name="line-75"></a>                          ppr cc,
<a name="line-76"></a>                          pp_binder_info bi,
<a name="line-77"></a>                          ptext (sLit " ["), ifPprDebug (interppSP free_vars), ptext (sLit "] \\"),
<a name="line-78"></a>                          ppr upd_flag, ptext (sLit " ["),
<a name="line-79"></a>                          interppSP args, char ']'])
<a name="line-80"></a>            8 (sep [hsep [ppr rhs, ptext (sLit "} in")]]))
<a name="line-81"></a>      (ppr expr)
<a name="line-82"></a>-}</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-comment'>-- special case: let ... in let ...</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLet</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>StgLet</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-87"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>$$</span><span class='hs-layout'>)</span>
<a name="line-88"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let {"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-89"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprGenStgBinding</span> <span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"} in"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-90"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-comment'>-- general case</span>
<a name="line-93"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLet</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let {"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprGenStgBinding</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-95"></a>           <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"} in "</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLetNoEscape</span> <span class='hs-varid'>lvs_whole</span> <span class='hs-varid'>lvs_rhss</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let-no-escape {"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-99"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprGenStgBinding</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-100"></a>           <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"} in "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-101"></a>                   <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span>
<a name="line-102"></a>                    <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span>
<a name="line-103"></a>                      <span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span>  <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-- lvs: ["</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>interppSP</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqSetToList</span> <span class='hs-varid'>lvs_whole</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-104"></a>                             <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"]; rhs lvs: ["</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>interppSP</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqSetToList</span> <span class='hs-varid'>lvs_rhss</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-105"></a>                             <span class='hs-varid'>char</span> <span class='hs-chr'>']'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-106"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgSCC</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>push</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>scc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprStgExpr</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>]</span>
<a name="line-110"></a>  <span class='hs-keyword'>where</span>
<a name="line-111"></a>    <span class='hs-varid'>scc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tick</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>push</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"_scc_"</span><span class='hs-layout'>)</span>
<a name="line-112"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tick</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"_tick_"</span><span class='hs-layout'>)</span>
<a name="line-113"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"_push_"</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-varid'>m</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"_tick_"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>  <span class='hs-varid'>pprModule</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-117"></a>          <span class='hs-varid'>pprStgExpr</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>]</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-definition'>pprStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>lvs_whole</span> <span class='hs-varid'>lvs_rhss</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"case"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-121"></a>           <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprStgExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span>
<a name="line-122"></a>             <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>alt_type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-123"></a>           <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprBndr</span> <span class='hs-conid'>CaseBind</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'{'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-124"></a>           <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span>
<a name="line-125"></a>           <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span>
<a name="line-126"></a>             <span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span>  <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-- lvs: ["</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>interppSP</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqSetToList</span> <span class='hs-varid'>lvs_whole</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-127"></a>                    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"]; rhs lvs: ["</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>interppSP</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqSetToList</span> <span class='hs-varid'>lvs_rhss</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-128"></a>                    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"]; "</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-129"></a>                    <span class='hs-varid'>pprMaybeSRT</span> <span class='hs-varid'>srt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-130"></a>           <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprStgAlt</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-131"></a>           <span class='hs-varid'>char</span> <span class='hs-chr'>'}'</span><span class='hs-keyglyph'>]</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="pprStgAlt"></a><span class='hs-definition'>pprStgAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>occ</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-134"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>GenStgAlt</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-135"></a><span class='hs-definition'>pprStgAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>params</span><span class='hs-layout'>,</span> <span class='hs-sel'>_use_mask</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprBndr</span> <span class='hs-conid'>CaseBind</span><span class='hs-layout'>)</span> <span class='hs-varid'>params</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-&gt;"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-137"></a>         <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-layout'>)</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="pprStgOp"></a><span class='hs-definition'>pprStgOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-140"></a><span class='hs-definition'>pprStgOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgPrimOp</span>  <span class='hs-varid'>op</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span>
<a name="line-141"></a><span class='hs-definition'>pprStgOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgPrimCallOp</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span>
<a name="line-142"></a><span class='hs-definition'>pprStgOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgFCallOp</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>AltType</span> <span class='hs-keyword'>where</span>
<a name="line-145"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>PolyAlt</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Polymorphic"</span><span class='hs-layout'>)</span>
<a name="line-146"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupAlt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"UbxTup"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-147"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AlgAlt</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Alg"</span><span class='hs-layout'>)</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span>
<a name="line-148"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Prim"</span><span class='hs-layout'>)</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="pprStgLVs"></a><span class='hs-definition'>pprStgLVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>GenStgLiveVars</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-151"></a><span class='hs-definition'>pprStgLVs</span> <span class='hs-varid'>lvs</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-153"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>userStyle</span> <span class='hs-varid'>sty</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isEmptyUniqSet</span> <span class='hs-varid'>lvs</span> <span class='hs-keyword'>then</span>
<a name="line-154"></a>        <span class='hs-varid'>empty</span>
<a name="line-155"></a>    <span class='hs-keyword'>else</span>
<a name="line-156"></a>        <span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"{-lvs:"</span><span class='hs-layout'>,</span> <span class='hs-varid'>interpp'SP</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqSetToList</span> <span class='hs-varid'>lvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-}"</span><span class='hs-keyglyph'>]</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="pprStgRhs"></a><span class='hs-definition'>pprStgRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>bdee</span><span class='hs-layout'>)</span>
<a name="line-159"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>GenStgRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bdee</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-comment'>-- special case</span>
<a name="line-162"></a><span class='hs-definition'>pprStgRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>bi</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>free_var</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>srt</span> <span class='hs-keyglyph'>[</span><span class='hs-comment'>{-no args-}</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>func</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cc</span><span class='hs-layout'>,</span>
<a name="line-164"></a>           <span class='hs-varid'>pp_binder_info</span> <span class='hs-varid'>bi</span><span class='hs-layout'>,</span>
<a name="line-165"></a>           <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>free_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-166"></a>           <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>" \\"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>upd_flag</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprMaybeSRT</span> <span class='hs-varid'>srt</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>" [] "</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>func</span> <span class='hs-keyglyph'>]</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-comment'>-- general case</span>
<a name="line-169"></a><span class='hs-definition'>pprStgRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>free_vars</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-170"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sdocWithDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-171"></a>    <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SccProfilingOn</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cc</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>,</span>
<a name="line-172"></a>                <span class='hs-varid'>pp_binder_info</span> <span class='hs-varid'>bi</span><span class='hs-layout'>,</span>
<a name="line-173"></a>                <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>interppSP</span> <span class='hs-varid'>free_vars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-174"></a>                <span class='hs-varid'>char</span> <span class='hs-chr'>'\\'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>upd_flag</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprMaybeSRT</span> <span class='hs-varid'>srt</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>interppSP</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-175"></a>         <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-definition'>pprStgRhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cc</span><span class='hs-layout'>,</span>
<a name="line-179"></a>           <span class='hs-varid'>space</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"! "</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>interppSP</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-180"></a>
<a name="line-181"></a><a name="pprMaybeSRT"></a><span class='hs-definition'>pprMaybeSRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SRT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-182"></a><span class='hs-definition'>pprMaybeSRT</span> <span class='hs-layout'>(</span><span class='hs-conid'>NoSRT</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-183"></a><span class='hs-definition'>pprMaybeSRT</span> <span class='hs-varid'>srt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"srt:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprSRT</span> <span class='hs-varid'>srt</span>
</pre>\end{code}

</body>
</html>
