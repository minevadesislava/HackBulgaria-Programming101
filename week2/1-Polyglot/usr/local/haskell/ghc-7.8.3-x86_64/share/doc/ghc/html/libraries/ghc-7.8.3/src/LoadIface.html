<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>iface/LoadIface.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Loading interface files

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>LoadIface</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>        <span class='hs-comment'>-- RnM/TcM functions</span>
<a name="line-4"></a>        <span class='hs-varid'>loadModuleInterface</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadModuleInterfaces</span><span class='hs-layout'>,</span> 
<a name="line-5"></a>        <span class='hs-varid'>loadSrcInterface</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadSrcInterface_maybe</span><span class='hs-layout'>,</span> 
<a name="line-6"></a>        <span class='hs-varid'>loadInterfaceForName</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadInterfaceForModule</span><span class='hs-layout'>,</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-comment'>-- IfM functions</span>
<a name="line-9"></a>        <span class='hs-varid'>loadInterface</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadWiredInHomeIface</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>        <span class='hs-varid'>loadSysInterface</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadUserInterface</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadPluginInterface</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>findAndReadIface</span><span class='hs-layout'>,</span> <span class='hs-varid'>readIface</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Used when reading the module's old interface</span>
<a name="line-12"></a>        <span class='hs-varid'>loadDecls</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Should move to TcIface and be renamed</span>
<a name="line-13"></a>        <span class='hs-varid'>initExternalPackageState</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-varid'>ifaceStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprModIface</span><span class='hs-layout'>,</span> <span class='hs-varid'>showIface</span>
<a name="line-16"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>   <span class='hs-conid'>TcIface</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcIfaceDecl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIfaceRules</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIfaceInst</span><span class='hs-layout'>,</span> 
<a name="line-21"></a>                                 <span class='hs-varid'>tcIfaceFamInst</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIfaceVectInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIfaceAnnotations</span> <span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IfaceSyn</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IfaceEnv</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelInfo</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>allThePrimOps</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>primOpOcc</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>seqId</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Rules</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Finder</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BinIface</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hooks</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        loadSrcInterface, loadOrphanModules, loadInterfaceForName

                These three are called from TcM-land    
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="loadSrcInterface"></a><span class='hs-comment'>-- | Load the interface corresponding to an @import@ directive in </span>
<a name="line-2"></a><span class='hs-comment'>-- source code.  On a failure, fail in the monad with an error message.</span>
<a name="line-3"></a><span class='hs-definition'>loadSrcInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-4"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span>
<a name="line-5"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span>     <span class='hs-comment'>-- {-# SOURCE #-} ?</span>
<a name="line-6"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span>    <span class='hs-comment'>-- "package", if any</span>
<a name="line-7"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>ModIface</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>loadSrcInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>want_boot</span> <span class='hs-varid'>maybe_pkg</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadSrcInterface_maybe</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>want_boot</span> <span class='hs-varid'>maybe_pkg</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>           <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>err</span>
<a name="line-13"></a>           <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>iface</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="loadSrcInterface_maybe"></a><span class='hs-comment'>-- | Like loadSrcInterface, but returns a MaybeErr</span>
<a name="line-16"></a><span class='hs-definition'>loadSrcInterface_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-17"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span>
<a name="line-18"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span>     <span class='hs-comment'>-- {-# SOURCE #-} ?</span>
<a name="line-19"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span>    <span class='hs-comment'>-- "package", if any</span>
<a name="line-20"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-definition'>loadSrcInterface_maybe</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>want_boot</span> <span class='hs-varid'>maybe_pkg</span>
<a name="line-23"></a>  <span class='hs-comment'>-- We must first find which Module this import refers to.  This involves</span>
<a name="line-24"></a>  <span class='hs-comment'>-- calling the Finder, which as a side effect will search the filesystem</span>
<a name="line-25"></a>  <span class='hs-comment'>-- and create a ModLocation.  If successful, loadIface will read the</span>
<a name="line-26"></a>  <span class='hs-comment'>-- interface; it will call the Finder again, but the ModLocation will be</span>
<a name="line-27"></a>  <span class='hs-comment'>-- cached from the first search.</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findImportedModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>maybe_pkg</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-31"></a>           <span class='hs-conid'>Found</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>initIfaceTcRn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>loadInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-varid'>want_boot</span><span class='hs-layout'>)</span>
<a name="line-32"></a>           <span class='hs-varid'>err</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-layout'>(</span><span class='hs-varid'>cannotFindInterface</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="loadModuleInterface"></a><span class='hs-comment'>-- | Load interface for a module.</span>
<a name="line-35"></a><span class='hs-definition'>loadModuleInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ModIface</span>
<a name="line-36"></a><span class='hs-definition'>loadModuleInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initIfaceTcRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadSysInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="loadModuleInterfaces"></a><span class='hs-comment'>-- | Load interfaces for a collection of modules.</span>
<a name="line-39"></a><span class='hs-definition'>loadModuleInterfaces</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-40"></a><span class='hs-definition'>loadModuleInterfaces</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mods</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initIfaceTcRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM_</span> <span class='hs-varid'>load</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>load</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loadSysInterface</span> <span class='hs-layout'>(</span><span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="loadInterfaceForName"></a><span class='hs-comment'>-- | Loads the interface for a given Name.</span>
<a name="line-47"></a><span class='hs-definition'>loadInterfaceForName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>ModIface</span>
<a name="line-48"></a><span class='hs-definition'>loadInterfaceForName</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>name</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> 
<a name="line-50"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-51"></a>        <span class='hs-comment'>-- Should not be called with a name from the module being compiled</span>
<a name="line-52"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-53"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>MASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>)</span>
<a name="line-54"></a>        <span class='hs-layout'>}</span>
<a name="line-55"></a>  <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> 
<a name="line-56"></a>    <span class='hs-varid'>initIfaceTcRn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>loadSysInterface</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-57"></a>  <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="loadInterfaceForModule"></a><span class='hs-comment'>-- | Loads the interface for a given Module.</span>
<a name="line-60"></a><span class='hs-definition'>loadInterfaceForModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>ModIface</span>
<a name="line-61"></a><span class='hs-definition'>loadInterfaceForModule</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>m</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-63"></a>    <span class='hs-comment'>-- Should not be called with this module</span>
<a name="line-64"></a>    <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-65"></a>      <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-66"></a>      <span class='hs-conid'>MASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>this_mod</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>)</span>
<a name="line-67"></a>    <span class='hs-varid'>initIfaceTcRn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>loadSysInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>m</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
                loadInterface

        The main function to load an interface
        for an imported module, and put it in
        the External Package State
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="loadWiredInHomeIface"></a><span class='hs-comment'>-- | An 'IfM' function to load the home interface for a wired-in thing,</span>
<a name="line-2"></a><span class='hs-comment'>-- so that we're sure that we see its instance declarations and rules</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [Loading instances for wired-in things] in TcIface</span>
<a name="line-4"></a><span class='hs-definition'>loadWiredInHomeIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span> <span class='hs-conid'>()</span>
<a name="line-5"></a><span class='hs-definition'>loadWiredInHomeIface</span> <span class='hs-varid'>name</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadSysInterface</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Need home interface for wired-in thing"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="loadSysInterface"></a><span class='hs-comment'>------------------</span>
<a name="line-12"></a><span class='hs-comment'>-- | Loads a system interface and throws an exception if it fails</span>
<a name="line-13"></a><span class='hs-definition'>loadSysInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span> <span class='hs-conid'>ModIface</span>
<a name="line-14"></a><span class='hs-definition'>loadSysInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loadInterfaceWithException</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> <span class='hs-conid'>ImportBySystem</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="loadUserInterface"></a><span class='hs-comment'>------------------</span>
<a name="line-17"></a><span class='hs-comment'>-- | Loads a user interface and throws an exception if it fails. The first parameter indicates</span>
<a name="line-18"></a><span class='hs-comment'>-- whether we should import the boot variant of the module</span>
<a name="line-19"></a><span class='hs-definition'>loadUserInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span> <span class='hs-conid'>ModIface</span>
<a name="line-20"></a><span class='hs-definition'>loadUserInterface</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> 
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loadInterfaceWithException</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="loadPluginInterface"></a><span class='hs-definition'>loadPluginInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span> <span class='hs-conid'>ModIface</span>
<a name="line-24"></a><span class='hs-definition'>loadPluginInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loadInterfaceWithException</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> <span class='hs-conid'>ImportByPlugin</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="loadInterfaceWithException"></a><span class='hs-comment'>------------------</span>
<a name="line-28"></a><span class='hs-comment'>-- | A wrapper for 'loadInterface' that throws an exception if it fails</span>
<a name="line-29"></a><span class='hs-definition'>loadInterfaceWithException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WhereFrom</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span> <span class='hs-conid'>ModIface</span>
<a name="line-30"></a><span class='hs-definition'>loadInterfaceWithException</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>where_from</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadInterface</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>where_from</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_iface</span> <span class='hs-keyword'>of</span> 
<a name="line-34"></a>            <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>            <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>iface</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="loadInterface"></a><span class='hs-comment'>------------------</span>
<a name="line-38"></a><span class='hs-definition'>loadInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WhereFrom</span>
<a name="line-39"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>(</span><span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-comment'>-- loadInterface looks in both the HPT and PIT for the required interface</span>
<a name="line-42"></a><span class='hs-comment'>-- If not found, it loads it, and puts it in the PIT (always). </span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-comment'>-- If it can't find a suitable interface file, we</span>
<a name="line-45"></a><span class='hs-comment'>--      a) modify the PackageIfaceTable to have an empty entry</span>
<a name="line-46"></a><span class='hs-comment'>--              (to avoid repeated complaints)</span>
<a name="line-47"></a><span class='hs-comment'>--      b) return (Left message)</span>
<a name="line-48"></a><span class='hs-comment'>--</span>
<a name="line-49"></a><span class='hs-comment'>-- It's not necessarily an error for there not to be an interface</span>
<a name="line-50"></a><span class='hs-comment'>-- file -- perhaps the module has changed, and that interface </span>
<a name="line-51"></a><span class='hs-comment'>-- is no longer used</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>loadInterface</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>from</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>       <span class='hs-comment'>-- Read the state</span>
<a name="line-55"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>eps</span><span class='hs-layout'>,</span><span class='hs-varid'>hpt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEpsAndHpt</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Considering whether to load"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>from</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a>                <span class='hs-comment'>-- Check whether we have the interface already</span>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-61"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupIfaceByModule</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-62"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span> 
<a name="line-63"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>   <span class='hs-comment'>-- Already loaded</span>
<a name="line-64"></a>                        <span class='hs-comment'>-- The (src_imp == mi_boot iface) test checks that the already-loaded</span>
<a name="line-65"></a>                        <span class='hs-comment'>-- interface isn't a boot iface.  This can conceivably happen,</span>
<a name="line-66"></a>                        <span class='hs-comment'>-- if an earlier import had a before we got to real imports.   I think.</span>
<a name="line-67"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-comment'>-- READ THE MODULE IN</span>
<a name="line-70"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>read_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>wantHiBootFile</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>eps</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>from</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-71"></a>                           <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-72"></a>                           <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>hi_boot_file</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>findAndReadIface</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>hi_boot_file</span>
<a name="line-73"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>read_result</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-74"></a>            <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-75"></a>                <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fake_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModIface</span> <span class='hs-varid'>mod</span>
<a name="line-76"></a>
<a name="line-77"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>updateEps_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>eps</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-78"></a>                        <span class='hs-varid'>eps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eps_PIT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendModuleEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_module</span> <span class='hs-varid'>fake_iface</span><span class='hs-layout'>)</span> <span class='hs-varid'>fake_iface</span> <span class='hs-layout'>}</span>
<a name="line-79"></a>                        <span class='hs-comment'>-- Not found, so add an empty iface to </span>
<a name="line-80"></a>                        <span class='hs-comment'>-- the EPS map so that we don't look again</span>
<a name="line-81"></a>                                
<a name="line-82"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-83"></a>
<a name="line-84"></a>        <span class='hs-comment'>-- Found and parsed!</span>
<a name="line-85"></a>        <span class='hs-comment'>-- We used to have a sanity check here that looked for:</span>
<a name="line-86"></a>        <span class='hs-comment'>--  * System importing ..</span>
<a name="line-87"></a>        <span class='hs-comment'>--  * a home package module ..</span>
<a name="line-88"></a>        <span class='hs-comment'>--  * that we know nothing about (mb_dep == Nothing)!</span>
<a name="line-89"></a>        <span class='hs-comment'>--</span>
<a name="line-90"></a>        <span class='hs-comment'>-- But this is no longer valid because thNameToGhcName allows users to</span>
<a name="line-91"></a>        <span class='hs-comment'>-- cause the system to load arbitrary interfaces (by supplying an appropriate</span>
<a name="line-92"></a>        <span class='hs-comment'>-- Template Haskell original-name).</span>
<a name="line-93"></a>            <span class='hs-conid'>Succeeded</span> <span class='hs-layout'>(</span><span class='hs-varid'>iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>file_path</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-94"></a>
<a name="line-95"></a>        <span class='hs-keyword'>let</span> 
<a name="line-96"></a>            <span class='hs-varid'>loc_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varid'>file_path</span>
<a name="line-97"></a>        <span class='hs-keyword'>in</span> 
<a name="line-98"></a>        <span class='hs-varid'>initIfaceLcl</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>loc_doc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-99"></a>
<a name="line-100"></a>        <span class='hs-comment'>--      Load the new ModIface into the External Package State</span>
<a name="line-101"></a>        <span class='hs-comment'>-- Even home-package interfaces loaded by loadInterface </span>
<a name="line-102"></a>        <span class='hs-comment'>--      (which only happens in OneShot mode; in Batch/Interactive </span>
<a name="line-103"></a>        <span class='hs-comment'>--      mode, home-package modules are loaded one by one into the HPT)</span>
<a name="line-104"></a>        <span class='hs-comment'>-- are put in the EPS.</span>
<a name="line-105"></a>        <span class='hs-comment'>--</span>
<a name="line-106"></a>        <span class='hs-comment'>-- The main thing is to add the ModIface to the PIT, but</span>
<a name="line-107"></a>        <span class='hs-comment'>-- we also take the</span>
<a name="line-108"></a>        <span class='hs-comment'>--      IfaceDecls, IfaceClsInst, IfaceFamInst, IfaceRules, IfaceVectInfo</span>
<a name="line-109"></a>        <span class='hs-comment'>-- out of the ModIface and put them into the big EPS pools</span>
<a name="line-110"></a>
<a name="line-111"></a>        <span class='hs-comment'>-- NB: *first* we do loadDecl, so that the provenance of all the locally-defined</span>
<a name="line-112"></a>        <span class='hs-comment'>---    names is done correctly (notably, whether this is an .hi file or .hi-boot file).</span>
<a name="line-113"></a>        <span class='hs-comment'>--     If we do loadExport first the wrong info gets into the cache (unless we</span>
<a name="line-114"></a>        <span class='hs-comment'>--      explicitly tag each export which seems a bit of a bore)</span>
<a name="line-115"></a>
<a name="line-116"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ignore_prags</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_IgnoreInterfacePragmas</span>
<a name="line-117"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_eps_decls</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadDecls</span> <span class='hs-varid'>ignore_prags</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_decls</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-118"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_eps_insts</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcIfaceInst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_insts</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-119"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_eps_fam_insts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcIfaceFamInst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_fam_insts</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-120"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_eps_rules</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIfaceRules</span> <span class='hs-varid'>ignore_prags</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_rules</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-121"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_eps_anns</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIfaceAnnotations</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_anns</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-122"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_eps_vect_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIfaceVectInfo</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameEnv</span> <span class='hs-varid'>new_eps_decls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_vect_info</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>final_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iface</span> <span class='hs-layout'>{</span>   
<a name="line-125"></a>                                <span class='hs-varid'>mi_decls</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"No mi_decls in PIT"</span><span class='hs-layout'>,</span>
<a name="line-126"></a>                                <span class='hs-varid'>mi_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"No mi_insts in PIT"</span><span class='hs-layout'>,</span>
<a name="line-127"></a>                                <span class='hs-varid'>mi_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"No mi_fam_insts in PIT"</span><span class='hs-layout'>,</span>
<a name="line-128"></a>                                <span class='hs-varid'>mi_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"No mi_rules in PIT"</span><span class='hs-layout'>,</span>
<a name="line-129"></a>                                <span class='hs-varid'>mi_anns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"No mi_anns in PIT"</span>
<a name="line-130"></a>                              <span class='hs-layout'>}</span>
<a name="line-131"></a>               <span class='hs-layout'>}</span>
<a name="line-132"></a>
<a name="line-133"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>updateEps_</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-134"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>elemModuleEnv</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>eps</span> <span class='hs-keyword'>else</span>
<a name="line-135"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>from</span> <span class='hs-keyword'>of</span>  <span class='hs-comment'>-- See Note [Care with plugin imports]</span>
<a name="line-136"></a>                <span class='hs-conid'>ImportByPlugin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>eps</span> <span class='hs-layout'>{</span>
<a name="line-137"></a>                  <span class='hs-varid'>eps_PIT</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendModuleEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>final_iface</span><span class='hs-layout'>,</span>
<a name="line-138"></a>                  <span class='hs-varid'>eps_PTE</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDeclsToPTE</span>   <span class='hs-layout'>(</span><span class='hs-varid'>eps_PTE</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_eps_decls</span><span class='hs-layout'>}</span>
<a name="line-139"></a>                <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>eps</span> <span class='hs-layout'>{</span>
<a name="line-140"></a>                  <span class='hs-varid'>eps_PIT</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendModuleEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>final_iface</span><span class='hs-layout'>,</span>
<a name="line-141"></a>                  <span class='hs-varid'>eps_PTE</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDeclsToPTE</span>   <span class='hs-layout'>(</span><span class='hs-varid'>eps_PTE</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_eps_decls</span><span class='hs-layout'>,</span>
<a name="line-142"></a>                  <span class='hs-varid'>eps_rule_base</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendRuleBaseList</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_rule_base</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> 
<a name="line-143"></a>                                                        <span class='hs-varid'>new_eps_rules</span><span class='hs-layout'>,</span>
<a name="line-144"></a>                  <span class='hs-varid'>eps_inst_env</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInstEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span>  
<a name="line-145"></a>                                                       <span class='hs-varid'>new_eps_insts</span><span class='hs-layout'>,</span>
<a name="line-146"></a>                  <span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendFamInstEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span>
<a name="line-147"></a>                                                          <span class='hs-varid'>new_eps_fam_insts</span><span class='hs-layout'>,</span>
<a name="line-148"></a>                  <span class='hs-varid'>eps_vect_info</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVectInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_vect_info</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> 
<a name="line-149"></a>                                                  <span class='hs-varid'>new_eps_vect_info</span><span class='hs-layout'>,</span>
<a name="line-150"></a>                  <span class='hs-varid'>eps_ann_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendAnnEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_ann_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span>
<a name="line-151"></a>                                                      <span class='hs-varid'>new_eps_anns</span><span class='hs-layout'>,</span>
<a name="line-152"></a>                  <span class='hs-varid'>eps_mod_fam_inst_env</span>
<a name="line-153"></a>                                   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-154"></a>                                       <span class='hs-varid'>fam_inst_env</span> <span class='hs-keyglyph'>=</span> 
<a name="line-155"></a>                                         <span class='hs-varid'>extendFamInstEnvList</span> <span class='hs-varid'>emptyFamInstEnv</span>
<a name="line-156"></a>                                                              <span class='hs-varid'>new_eps_fam_insts</span>
<a name="line-157"></a>                                     <span class='hs-keyword'>in</span>
<a name="line-158"></a>                                     <span class='hs-varid'>extendModuleEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_mod_fam_inst_env</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span>
<a name="line-159"></a>                                                     <span class='hs-varid'>mod</span>
<a name="line-160"></a>                                                     <span class='hs-varid'>fam_inst_env</span><span class='hs-layout'>,</span>
<a name="line-161"></a>                  <span class='hs-varid'>eps_stats</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addEpsInStats</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_stats</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> 
<a name="line-162"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>new_eps_decls</span><span class='hs-layout'>)</span>
<a name="line-163"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>new_eps_insts</span><span class='hs-layout'>)</span>
<a name="line-164"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>new_eps_rules</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-165"></a>
<a name="line-166"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Succeeded</span> <span class='hs-varid'>final_iface</span><span class='hs-layout'>)</span>
<a name="line-167"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="wantHiBootFile"></a><span class='hs-definition'>wantHiBootFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExternalPackageState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WhereFrom</span>
<a name="line-170"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-conid'>IsBootInterface</span>
<a name="line-171"></a><span class='hs-comment'>-- Figure out whether we want Foo.hi or Foo.hi-boot</span>
<a name="line-172"></a><span class='hs-definition'>wantHiBootFile</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>eps</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>from</span>
<a name="line-173"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>from</span> <span class='hs-keyword'>of</span>
<a name="line-174"></a>       <span class='hs-conid'>ImportByUser</span> <span class='hs-varid'>usr_boot</span> 
<a name="line-175"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>usr_boot</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>this_package</span>
<a name="line-176"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Failed</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSourceImport</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-177"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>usr_boot</span>
<a name="line-178"></a>
<a name="line-179"></a>       <span class='hs-conid'>ImportByPlugin</span>
<a name="line-180"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Succeeded</span> <span class='hs-conid'>False</span>
<a name="line-181"></a>
<a name="line-182"></a>       <span class='hs-conid'>ImportBySystem</span>
<a name="line-183"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>this_package</span>   <span class='hs-comment'>-- If the module to be imported is not from this package</span>
<a name="line-184"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Succeeded</span> <span class='hs-conid'>False</span>   <span class='hs-comment'>-- don't look it up in eps_is_boot, because that is keyed</span>
<a name="line-185"></a>                               <span class='hs-comment'>-- on the ModuleName of *home-package* modules only. </span>
<a name="line-186"></a>                               <span class='hs-comment'>-- We never import boot modules from other packages!</span>
<a name="line-187"></a>
<a name="line-188"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-189"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_is_boot</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-190"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>is_boot</span>
<a name="line-191"></a>                <span class='hs-conid'>Nothing</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Succeeded</span> <span class='hs-conid'>False</span>
<a name="line-192"></a>                     <span class='hs-comment'>-- The boot-ness of the requested interface, </span>
<a name="line-193"></a>                     <span class='hs-comment'>-- based on the dependencies in directly-imported modules</span>
<a name="line-194"></a>  <span class='hs-keyword'>where</span>
<a name="line-195"></a>    <span class='hs-varid'>this_package</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span>
<a name="line-196"></a>
<a name="line-197"></a><a name="badSourceImport"></a><span class='hs-definition'>badSourceImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-198"></a><span class='hs-definition'>badSourceImport</span> <span class='hs-varid'>mod</span>
<a name="line-199"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"You cannot {-# SOURCE #-} import a module from another package"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-200"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is from package"</span><span class='hs-layout'>)</span>
<a name="line-201"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Care with plugin imports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When dynamically loading a plugin (via loadPluginInterface) we
populate the same External Package State (EPS), even though plugin
modules are to link with the compiler itself, and not with the 
compiled program.  That's fine: mostly the EPS is just a cache for
the interace files on disk.

But it's NOT ok for the RULES or instance environment.  We do not want
to fire a RULE from the plugin on the code we are compiling, otherwise
the code we are compiling will have a reference to a RHS of the rule
that exists only in the compiler!  This actually happened to Daniel,
via a RULE arising from a specialisation of (^) in the plugin.

Solution: when loading plugins, do not extend the rule and instance
environments.  We are only interested in the type environment, so that
we can check that the plugin exports a function with the type that the
compiler expects.


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-----------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>--      Loading type/class/value decls</span>
<a name="line-3"></a><span class='hs-comment'>-- We pass the full Module name here, replete with</span>
<a name="line-4"></a><span class='hs-comment'>-- its package info, so that we can build a Name for</span>
<a name="line-5"></a><span class='hs-comment'>-- each binder with the right package info in it</span>
<a name="line-6"></a><span class='hs-comment'>-- All subsequent lookups, including crucially lookups during typechecking</span>
<a name="line-7"></a><span class='hs-comment'>-- the declaration itself, will find the fully-glorious Name</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-- We handle ATs specially.  They are not main declarations, but also not</span>
<a name="line-10"></a><span class='hs-comment'>-- implict things (in particular, adding them to `implicitTyThings' would mess</span>
<a name="line-11"></a><span class='hs-comment'>-- things up in the renaming/type checking of source programs).</span>
<a name="line-12"></a><span class='hs-comment'>-----------------------------------------------------</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="addDeclsToPTE"></a><span class='hs-definition'>addDeclsToPTE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageTypeEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageTypeEnv</span>
<a name="line-15"></a><span class='hs-definition'>addDeclsToPTE</span> <span class='hs-varid'>pte</span> <span class='hs-varid'>things</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnvList</span> <span class='hs-varid'>pte</span> <span class='hs-varid'>things</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="loadDecls"></a><span class='hs-definition'>loadDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-18"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a><span class='hs-definition'>loadDecls</span> <span class='hs-varid'>ignore_prags</span> <span class='hs-varid'>ver_decls</span>
<a name="line-21"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getIfModule</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>thingss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadDecl</span> <span class='hs-varid'>ignore_prags</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>ver_decls</span>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>thingss</span><span class='hs-layout'>)</span>
<a name="line-24"></a>        <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="loadDecl"></a><span class='hs-definition'>loadDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                    <span class='hs-comment'>-- Don't load pragmas into the decl pool</span>
<a name="line-27"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-28"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span>
<a name="line-29"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- The list can be poked eagerly, but the</span>
<a name="line-30"></a>                                    <span class='hs-comment'>-- TyThings are forkM'd thunks</span>
<a name="line-31"></a><span class='hs-definition'>loadDecl</span> <span class='hs-varid'>ignore_prags</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-sel'>_version</span><span class='hs-layout'>,</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>       <span class='hs-comment'>-- Populate the name cache with final versions of all </span>
<a name="line-33"></a>                <span class='hs-comment'>-- the names associated with the decl</span>
<a name="line-34"></a>          <span class='hs-varid'>main_name</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupOrig</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-comment'>-- Typecheck the thing, lazily</span>
<a name="line-37"></a>        <span class='hs-comment'>-- NB. Firstly, the laziness is there in case we never need the</span>
<a name="line-38"></a>        <span class='hs-comment'>-- declaration (in one-shot mode), and secondly it is there so that </span>
<a name="line-39"></a>        <span class='hs-comment'>-- we don't look up the occurrence of a name before calling mk_new_bndr</span>
<a name="line-40"></a>        <span class='hs-comment'>-- on the binder.  This is important because we must get the right name</span>
<a name="line-41"></a>        <span class='hs-comment'>-- which includes its nameParent.</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkM</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bumpDeclStats</span> <span class='hs-varid'>main_name</span>
<a name="line-44"></a>                                  <span class='hs-layout'>;</span> <span class='hs-varid'>tcIfaceDecl</span> <span class='hs-varid'>ignore_prags</span> <span class='hs-varid'>decl</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-comment'>-- Populate the type environment with the implicitTyThings too.</span>
<a name="line-47"></a>        <span class='hs-comment'>-- </span>
<a name="line-48"></a>        <span class='hs-comment'>-- Note [Tricky iface loop]</span>
<a name="line-49"></a>        <span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-50"></a>        <span class='hs-comment'>-- Summary: The delicate point here is that 'mini-env' must be</span>
<a name="line-51"></a>        <span class='hs-comment'>-- buildable from 'thing' without demanding any of the things</span>
<a name="line-52"></a>        <span class='hs-comment'>-- 'forkM'd by tcIfaceDecl.</span>
<a name="line-53"></a>        <span class='hs-comment'>--</span>
<a name="line-54"></a>        <span class='hs-comment'>-- In more detail: Consider the example</span>
<a name="line-55"></a>        <span class='hs-comment'>--      data T a = MkT { x :: T a }</span>
<a name="line-56"></a>        <span class='hs-comment'>-- The implicitTyThings of T are:  [ &lt;datacon MkT&gt;, &lt;selector x&gt;]</span>
<a name="line-57"></a>        <span class='hs-comment'>-- (plus their workers, wrappers, coercions etc etc)</span>
<a name="line-58"></a>        <span class='hs-comment'>-- </span>
<a name="line-59"></a>        <span class='hs-comment'>-- We want to return an environment </span>
<a name="line-60"></a>        <span class='hs-comment'>--      [ "MkT" -&gt; &lt;datacon MkT&gt;, "x" -&gt; &lt;selector x&gt;, ... ]</span>
<a name="line-61"></a>        <span class='hs-comment'>-- (where the "MkT" is the *Name* associated with MkT, etc.)</span>
<a name="line-62"></a>        <span class='hs-comment'>--</span>
<a name="line-63"></a>        <span class='hs-comment'>-- We do this by mapping the implict_names to the associated</span>
<a name="line-64"></a>        <span class='hs-comment'>-- TyThings.  By the invariant on ifaceDeclImplicitBndrs and</span>
<a name="line-65"></a>        <span class='hs-comment'>-- implicitTyThings, we can use getOccName on the implicit</span>
<a name="line-66"></a>        <span class='hs-comment'>-- TyThings to make this association: each Name's OccName should</span>
<a name="line-67"></a>        <span class='hs-comment'>-- be the OccName of exactly one implictTyThing.  So the key is</span>
<a name="line-68"></a>        <span class='hs-comment'>-- to define a "mini-env"</span>
<a name="line-69"></a>        <span class='hs-comment'>--</span>
<a name="line-70"></a>        <span class='hs-comment'>-- [ 'MkT' -&gt; &lt;datacon MkT&gt;, 'x' -&gt; &lt;selector x&gt;, ... ]</span>
<a name="line-71"></a>        <span class='hs-comment'>-- where the 'MkT' here is the *OccName* associated with MkT.</span>
<a name="line-72"></a>        <span class='hs-comment'>--</span>
<a name="line-73"></a>        <span class='hs-comment'>-- However, there is a subtlety: due to how type checking needs</span>
<a name="line-74"></a>        <span class='hs-comment'>-- to be staged, we can't poke on the forkM'd thunks inside the</span>
<a name="line-75"></a>        <span class='hs-comment'>-- implictTyThings while building this mini-env.  </span>
<a name="line-76"></a>        <span class='hs-comment'>-- If we poke these thunks too early, two problems could happen:</span>
<a name="line-77"></a>        <span class='hs-comment'>--    (1) When processing mutually recursive modules across</span>
<a name="line-78"></a>        <span class='hs-comment'>--        hs-boot boundaries, poking too early will do the</span>
<a name="line-79"></a>        <span class='hs-comment'>--        type-checking before the recursive knot has been tied,</span>
<a name="line-80"></a>        <span class='hs-comment'>--        so things will be type-checked in the wrong</span>
<a name="line-81"></a>        <span class='hs-comment'>--        environment, and necessary variables won't be in</span>
<a name="line-82"></a>        <span class='hs-comment'>--        scope.</span>
<a name="line-83"></a>        <span class='hs-comment'>--        </span>
<a name="line-84"></a>        <span class='hs-comment'>--    (2) Looking up one OccName in the mini_env will cause</span>
<a name="line-85"></a>        <span class='hs-comment'>--        others to be looked up, which might cause that</span>
<a name="line-86"></a>        <span class='hs-comment'>--        original one to be looked up again, and hence loop.</span>
<a name="line-87"></a>        <span class='hs-comment'>--</span>
<a name="line-88"></a>        <span class='hs-comment'>-- The code below works because of the following invariant:</span>
<a name="line-89"></a>        <span class='hs-comment'>-- getOccName on a TyThing does not force the suspended type</span>
<a name="line-90"></a>        <span class='hs-comment'>-- checks in order to extract the name. For example, we don't</span>
<a name="line-91"></a>        <span class='hs-comment'>-- poke on the "T a" type of &lt;selector x&gt; on the way to</span>
<a name="line-92"></a>        <span class='hs-comment'>-- extracting &lt;selector x&gt;'s OccName. Of course, there is no</span>
<a name="line-93"></a>        <span class='hs-comment'>-- reason in principle why getting the OccName should force the</span>
<a name="line-94"></a>        <span class='hs-comment'>-- thunks, but this means we need to be careful in</span>
<a name="line-95"></a>        <span class='hs-comment'>-- implicitTyThings and its helper functions.</span>
<a name="line-96"></a>        <span class='hs-comment'>--</span>
<a name="line-97"></a>        <span class='hs-comment'>-- All a bit too finely-balanced for my liking.</span>
<a name="line-98"></a>
<a name="line-99"></a>        <span class='hs-comment'>-- This mini-env and lookup function mediates between the</span>
<a name="line-100"></a>        <span class='hs-comment'>--'Name's n and the map from 'OccName's to the implicit TyThings</span>
<a name="line-101"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mini_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>implicitTyThings</span> <span class='hs-varid'>thing</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a>              <span class='hs-varid'>lookup</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>mini_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-103"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thing</span>
<a name="line-104"></a>                           <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-105"></a>                             <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"loadDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>main_name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>implicit_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupOrig</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifaceDeclImplicitBndrs</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-comment'>--         ; traceIf (text "Loading decl for " &lt;&gt; ppr main_name $$ ppr implicit_names)</span>
<a name="line-110"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>main_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span>
<a name="line-111"></a>                      <span class='hs-comment'>-- uses the invariant that implicit_names and</span>
<a name="line-112"></a>                      <span class='hs-comment'>-- implictTyThings are bijective</span>
<a name="line-113"></a>                      <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>implicit_names</span><span class='hs-keyglyph'>]</span>
<a name="line-114"></a>        <span class='hs-layout'>}</span>
<a name="line-115"></a>  <span class='hs-keyword'>where</span>
<a name="line-116"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="bumpDeclStats"></a><span class='hs-definition'>bumpDeclStats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfL</span> <span class='hs-conid'>()</span>         <span class='hs-comment'>-- Record that one more declaration has actually been used</span>
<a name="line-119"></a><span class='hs-definition'>bumpDeclStats</span> <span class='hs-varid'>name</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Loading decl for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-121"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>updateEps_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>eps</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>stats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eps_stats</span> <span class='hs-varid'>eps</span>
<a name="line-122"></a>                              <span class='hs-keyword'>in</span> <span class='hs-varid'>eps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eps_stats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stats</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n_decls_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_decls_out</span> <span class='hs-varid'>stats</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-123"></a>        <span class='hs-layout'>}</span>
</pre>\end{code}


%*********************************************************
%*                                                      *
\subsection{Reading an interface file}
%*                                                      *
%*********************************************************

Note [Home module load error]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the sought-for interface is in the current package (as determined
by -package-name flag) then it jolly well should already be in the HPT
because we process home-package modules in dependency order.  (Except
in one-shot mode; see notes with hsc_HPT decl in HscTypes).

It is possible (though hard) to get this error through user behaviour.
  * Suppose package P (modules P1, P2) depends on package Q (modules Q1,
    Q2, with Q2 importing Q1)
  * We compile both packages.  
  * Now we edit package Q so that it somehow depends on P
  * Now recompile Q with --make (without recompiling P).  
  * Then Q1 imports, say, P1, which in turn depends on Q2. So Q2
    is a home-package module which is not yet in the HPT!  Disaster.

This actually happened with P=base, Q=ghc-prim, via the AMP warnings.
See Trac #8320.

\begin{code}
<pre><a name="line-1"></a><a name="findAndReadIface"></a><span class='hs-definition'>findAndReadIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-2"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span>     <span class='hs-comment'>-- True  &lt;=&gt; Look for a .hi-boot file</span>
<a name="line-3"></a>                                        <span class='hs-comment'>-- False &lt;=&gt; Look for .hi file</span>
<a name="line-4"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>(</span><span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>        <span class='hs-comment'>-- Nothing &lt;=&gt; file not found, or unreadable, or illegible</span>
<a name="line-6"></a>        <span class='hs-comment'>-- Just x  &lt;=&gt; successfully found and parsed </span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-comment'>-- It *doesn't* add an error to the monad, because </span>
<a name="line-9"></a>        <span class='hs-comment'>-- sometimes it's ok to fail... see notes with loadInterface</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>findAndReadIface</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>hi_boot_file</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Reading"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-13"></a>                           <span class='hs-keyword'>if</span> <span class='hs-varid'>hi_boot_file</span> 
<a name="line-14"></a>                             <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[boot]"</span><span class='hs-layout'>)</span> 
<a name="line-15"></a>                             <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                           <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"interface for"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-17"></a>                           <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>semi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-18"></a>                     <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"reason:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc_str</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>       <span class='hs-comment'>-- Check for GHC.Prim, and return its static interface</span>
<a name="line-21"></a>       <span class='hs-keyword'>if</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>gHC_PRIM</span>
<a name="line-22"></a>           <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-23"></a>               <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHooked</span> <span class='hs-varid'>ghcPrimIfaceHook</span> <span class='hs-varid'>ghcPrimIface</span>
<a name="line-24"></a>               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Succeeded</span> <span class='hs-layout'>(</span><span class='hs-varid'>iface</span><span class='hs-layout'>,</span>
<a name="line-25"></a>                                   <span class='hs-str'>"&lt;built in interface for GHC.Prim&gt;"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-27"></a>               <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-28"></a>               <span class='hs-comment'>-- Look for the file</span>
<a name="line-29"></a>               <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTopEnv</span>
<a name="line-30"></a>               <span class='hs-varid'>mb_found</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>findExactModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-31"></a>               <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_found</span> <span class='hs-keyword'>of</span>
<a name="line-32"></a>                   <span class='hs-conid'>Found</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> 
<a name="line-33"></a>
<a name="line-34"></a>                       <span class='hs-comment'>-- Found file, so read it</span>
<a name="line-35"></a>                       <span class='hs-keyword'>let</span> <span class='hs-varid'>file_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBootSuffix_maybe</span> <span class='hs-varid'>hi_boot_file</span>
<a name="line-36"></a>                                                           <span class='hs-layout'>(</span><span class='hs-varid'>ml_hi_file</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a>                       <span class='hs-comment'>-- See Note [Home module load error]</span>
<a name="line-39"></a>                       <span class='hs-keyword'>if</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-40"></a>                          <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isOneShot</span> <span class='hs-layout'>(</span><span class='hs-varid'>ghcMode</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                           <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-layout'>(</span><span class='hs-varid'>homeModError</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                           <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>read_file</span> <span class='hs-varid'>file_path</span>
<a name="line-43"></a>                                   <span class='hs-varid'>checkBuildDynamicToo</span> <span class='hs-varid'>r</span>
<a name="line-44"></a>                                   <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-45"></a>                   <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>                       <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"...not found"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                       <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-48"></a>                       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-layout'>(</span><span class='hs-varid'>cannotFindInterface</span> <span class='hs-varid'>dflags</span> 
<a name="line-49"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-50"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>read_file</span> <span class='hs-varid'>file_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-51"></a>              <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"readIFace"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>file_path</span><span class='hs-layout'>)</span>
<a name="line-52"></a>              <span class='hs-varid'>read_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIface</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>file_path</span>
<a name="line-53"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>read_result</span> <span class='hs-keyword'>of</span>
<a name="line-54"></a>                <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-layout'>(</span><span class='hs-varid'>badIfaceFile</span> <span class='hs-varid'>file_path</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>                <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span> 
<a name="line-56"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-57"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrongIfaceModErr</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>file_path</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-58"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-59"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Succeeded</span> <span class='hs-layout'>(</span><span class='hs-varid'>iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>file_path</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>                            <span class='hs-comment'>-- Don't forget to fill in the package name...</span>
<a name="line-61"></a>          <span class='hs-varid'>checkBuildDynamicToo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Succeeded</span> <span class='hs-layout'>(</span><span class='hs-varid'>iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>filePath</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-62"></a>              <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-63"></a>              <span class='hs-varid'>whenGeneratingDynamicToo</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withDoDynamicToo</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-64"></a>                  <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canGenerateDynamicToo</span> <span class='hs-varid'>dflags</span>
<a name="line-65"></a>                      <span class='hs-varid'>dynFilePath</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBootSuffix_maybe</span> <span class='hs-varid'>hi_boot_file</span>
<a name="line-66"></a>                                  <span class='hs-varop'>$</span> <span class='hs-varid'>replaceExtension</span> <span class='hs-varid'>filePath</span> <span class='hs-layout'>(</span><span class='hs-varid'>dynHiSuf</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>read_file</span> <span class='hs-varid'>dynFilePath</span>
<a name="line-68"></a>                  <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-69"></a>                      <span class='hs-conid'>Succeeded</span> <span class='hs-layout'>(</span><span class='hs-varid'>dynIface</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-70"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mi_mod_hash</span> <span class='hs-varid'>iface</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mi_mod_hash</span> <span class='hs-varid'>dynIface</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-71"></a>                          <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-72"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-73"></a>                          <span class='hs-keyword'>do</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Dynamic hash doesn't match"</span><span class='hs-layout'>)</span>
<a name="line-74"></a>                             <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>ref</span> <span class='hs-conid'>False</span>
<a name="line-75"></a>                      <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-76"></a>                          <span class='hs-keyword'>do</span> <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Failed to load dynamic interface file:"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-77"></a>                             <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>ref</span> <span class='hs-conid'>False</span>
<a name="line-78"></a>          <span class='hs-varid'>checkBuildDynamicToo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
</pre>\end{code}

@readIface@ tries just the one file.

\begin{code}
<pre><a name="line-1"></a><a name="readIface"></a><span class='hs-definition'>readIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-2"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>(</span><span class='hs-conid'>MaybeErr</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-3"></a>        <span class='hs-comment'>-- Failed err    &lt;=&gt; file not found, or unreadable, or illegible</span>
<a name="line-4"></a>        <span class='hs-comment'>-- Succeeded iface &lt;=&gt; successfully found and parsed </span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>readIface</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-varid'>file_path</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryMostM</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>                 <span class='hs-varid'>readBinIface</span> <span class='hs-conid'>CheckHiWay</span> <span class='hs-conid'>QuietBinIFaceReading</span> <span class='hs-varid'>file_path</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-10"></a>            <span class='hs-conid'>Right</span> <span class='hs-varid'>iface</span> 
<a name="line-11"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>actual_mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-12"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                <span class='hs-keyword'>where</span>
<a name="line-14"></a>                  <span class='hs-varid'>actual_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span>
<a name="line-15"></a>                  <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hiModuleNameMismatchWarn</span> <span class='hs-varid'>wanted_mod</span> <span class='hs-varid'>actual_mod</span>
<a name="line-16"></a>
<a name="line-17"></a>            <span class='hs-conid'>Left</span> <span class='hs-varid'>exn</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Failed</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>showException</span> <span class='hs-varid'>exn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}


%*********************************************************
%*                                                       *
        Wired-in interface for GHC.Prim
%*                                                       *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="initExternalPackageState"></a><span class='hs-definition'>initExternalPackageState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExternalPackageState</span>
<a name="line-2"></a><span class='hs-definition'>initExternalPackageState</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EPS</span> <span class='hs-layout'>{</span> 
<a name="line-4"></a>      <span class='hs-varid'>eps_is_boot</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span>
<a name="line-5"></a>      <span class='hs-varid'>eps_PIT</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyPackageIfaceTable</span><span class='hs-layout'>,</span>
<a name="line-6"></a>      <span class='hs-varid'>eps_PTE</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTypeEnv</span><span class='hs-layout'>,</span>
<a name="line-7"></a>      <span class='hs-varid'>eps_inst_env</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInstEnv</span><span class='hs-layout'>,</span>
<a name="line-8"></a>      <span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>,</span>
<a name="line-9"></a>      <span class='hs-varid'>eps_rule_base</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRuleBase</span> <span class='hs-varid'>builtinRules</span><span class='hs-layout'>,</span>
<a name="line-10"></a>        <span class='hs-comment'>-- Initialise the EPS rule pool with the built-in rules</span>
<a name="line-11"></a>      <span class='hs-varid'>eps_mod_fam_inst_env</span>
<a name="line-12"></a>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModuleEnv</span><span class='hs-layout'>,</span>
<a name="line-13"></a>      <span class='hs-varid'>eps_vect_info</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noVectInfo</span><span class='hs-layout'>,</span>
<a name="line-14"></a>      <span class='hs-varid'>eps_ann_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyAnnEnv</span><span class='hs-layout'>,</span>
<a name="line-15"></a>      <span class='hs-varid'>eps_stats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EpsStats</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n_ifaces_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_decls_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_decls_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-16"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>n_insts_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_insts_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-17"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>n_rules_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>builtinRules</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_rules_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}


%*********************************************************
%*                                                       *
        Wired-in interface for GHC.Prim
%*                                                       *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="ghcPrimIface"></a><span class='hs-definition'>ghcPrimIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModIface</span>
<a name="line-2"></a><span class='hs-definition'>ghcPrimIface</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyModIface</span> <span class='hs-varid'>gHC_PRIM</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span>
<a name="line-4"></a>        <span class='hs-varid'>mi_exports</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ghcPrimExports</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>mi_decls</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>mi_fixities</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixities</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-varid'>mi_fix_fn</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIfaceFixCache</span> <span class='hs-varid'>fixities</span>
<a name="line-8"></a>    <span class='hs-layout'>}</span>           
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>fixities</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>seqId</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span> <span class='hs-num'>0</span> <span class='hs-conid'>InfixR</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- seq is infixr 0</span>
<a name="line-11"></a>             <span class='hs-conop'>:</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>mkFixity</span> <span class='hs-varid'>allThePrimOps</span>
<a name="line-12"></a>    <span class='hs-varid'>mkFixity</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOcc</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>primOpFixity</span> <span class='hs-varid'>op</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
\subsection{Statistics}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="ifaceStats"></a><span class='hs-definition'>ifaceStats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExternalPackageState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>ifaceStats</span> <span class='hs-varid'>eps</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Renamer stats: "</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>stats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eps_stats</span> <span class='hs-varid'>eps</span>
<a name="line-6"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> 
<a name="line-7"></a>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_ifaces_in</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"interfaces read"</span><span class='hs-layout'>,</span>
<a name="line-8"></a>         <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_decls_out</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"type/class/variable imported, out of"</span><span class='hs-layout'>,</span> 
<a name="line-9"></a>                <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_decls_in</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"read"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-10"></a>         <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_insts_out</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"instance decls imported, out of"</span><span class='hs-layout'>,</span>  
<a name="line-11"></a>                <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_insts_in</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"read"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-12"></a>         <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_rules_out</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"rule decls imported, out of"</span><span class='hs-layout'>,</span>  
<a name="line-13"></a>                <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_rules_in</span> <span class='hs-varid'>stats</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"read"</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a>        <span class='hs-keyglyph'>]</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Printing interfaces
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="showIface"></a><span class='hs-comment'>-- | Read binary interface, and print it out</span>
<a name="line-2"></a><span class='hs-definition'>showIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>showIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>   <span class='hs-comment'>-- skip the hi way check; we don't want to worry about profiled vs.</span>
<a name="line-5"></a>   <span class='hs-comment'>-- non-profiled interfaces, for example.</span>
<a name="line-6"></a>   <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initTcRnIf</span> <span class='hs-chr'>'s'</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>()</span> <span class='hs-conid'>()</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>       <span class='hs-varid'>readBinIface</span> <span class='hs-conid'>IgnoreHiWay</span> <span class='hs-conid'>TraceBinIFaceReading</span> <span class='hs-varid'>filename</span>
<a name="line-8"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-9"></a>   <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>SevDump</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultDumpStyle</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprModIface</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="pprModIface"></a><span class='hs-definition'>pprModIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-comment'>-- Show a ModIface</span>
<a name="line-3"></a><span class='hs-definition'>pprModIface</span> <span class='hs-varid'>iface</span>
<a name="line-4"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"interface"</span><span class='hs-layout'>)</span>
<a name="line-5"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_boot</span>
<a name="line-6"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>mi_orphan</span> <span class='hs-varid'>iface</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[orphan module]"</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-7"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>mi_finsts</span> <span class='hs-varid'>iface</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[family instance module]"</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-8"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>mi_hpc</span>    <span class='hs-varid'>iface</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[hpc]"</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>integer</span> <span class='hs-varid'>hiVersion</span>
<a name="line-10"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"interface hash:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_iface_hash</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"ABI hash:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_mod_hash</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"export-list hash:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_exp_hash</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"orphan hash:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_orphan_hash</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"flag hash:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_flag_hash</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"used TH splices:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_used_th</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"where"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"exports:"</span><span class='hs-layout'>)</span>
<a name="line-18"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprExport</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_exports</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprDeps</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-20"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprUsage</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_usages</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprIfaceAnnotation</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_anns</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-22"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprFixities</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_fixities</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-23"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprIfaceDecl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_decls</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_insts</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_fam_insts</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_rules</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprVectInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_vect_info</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-28"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_warns</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-29"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprTrustInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_trust</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-30"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>pprTrustPkg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_trust_pkg</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-31"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>pp_boot</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[boot]"</span><span class='hs-layout'>)</span>
<a name="line-34"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
</pre>\end{code}

When printing export lists, we print like this:
        Avail   f               f
        AvailTC C [C, x, y]     C(x,y)
        AvailTC C [x, y]        C!(x,y)         -- Exporting x, y but not C

\begin{code}
<pre><a name="line-1"></a><a name="pprExport"></a><span class='hs-definition'>pprExport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceExport</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>pprExport</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-3"></a><span class='hs-definition'>pprExport</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-4"></a><span class='hs-definition'>pprExport</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>n'</span><span class='hs-conop'>:</span><span class='hs-varid'>ns</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-varid'>n'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_export</span> <span class='hs-varid'>ns</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'|'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_export</span> <span class='hs-layout'>(</span><span class='hs-varid'>n'</span><span class='hs-conop'>:</span><span class='hs-varid'>ns</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>  
<a name="line-8"></a>    <span class='hs-varid'>pp_export</span> <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-9"></a>    <span class='hs-varid'>pp_export</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="pprUsage"></a><span class='hs-definition'>pprUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Usage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-12"></a><span class='hs-definition'>pprUsage</span> <span class='hs-varid'>usage</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>UsagePackageModule</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUsageImport</span> <span class='hs-varid'>usage</span> <span class='hs-varid'>usg_mod</span>
<a name="line-14"></a><span class='hs-definition'>pprUsage</span> <span class='hs-varid'>usage</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>UsageHomeModule</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUsageImport</span> <span class='hs-varid'>usage</span> <span class='hs-varid'>usg_mod_name</span> <span class='hs-varop'>$$</span>
<a name="line-16"></a>    <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span>
<a name="line-17"></a>        <span class='hs-varid'>maybe</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"exports: "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>usg_exports</span> <span class='hs-varid'>usage</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-18"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>usg_entities</span> <span class='hs-varid'>usage</span> <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>        <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>pprUsage</span> <span class='hs-varid'>usage</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>UsageFile</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"addDependentFile"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-22"></a>          <span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>usg_file_path</span> <span class='hs-varid'>usage</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="pprUsageImport"></a><span class='hs-definition'>pprUsageImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Usage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Usage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-25"></a><span class='hs-definition'>pprUsageImport</span> <span class='hs-varid'>usage</span> <span class='hs-varid'>usg_mod'</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"import"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>safe</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>usg_mod'</span> <span class='hs-varid'>usage</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>                       <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>usg_mod_hash</span> <span class='hs-varid'>usage</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-28"></a>    <span class='hs-keyword'>where</span>
<a name="line-29"></a>        <span class='hs-keyword'>safe</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>usg_safe</span> <span class='hs-varid'>usage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"safe"</span>
<a name="line-30"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>" -/ "</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="pprDeps"></a><span class='hs-definition'>pprDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Dependencies</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-33"></a><span class='hs-definition'>pprDeps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Deps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods</span><span class='hs-layout'>,</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dep_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs</span><span class='hs-layout'>,</span>
<a name="line-34"></a>                <span class='hs-varid'>dep_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"module dependencies:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_mod</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-36"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"package dependencies:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_pkg</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-37"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"orphans:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orphs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-38"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"family instance modules:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>finsts</span><span class='hs-layout'>)</span>
<a name="line-39"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-40"></a>  <span class='hs-keyword'>where</span>
<a name="line-41"></a>    <span class='hs-varid'>ppr_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod_name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_boot</span> <span class='hs-varid'>boot</span>
<a name="line-42"></a>    <span class='hs-varid'>ppr_pkg</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg</span><span class='hs-layout'>,</span><span class='hs-varid'>trust_req</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-43"></a>                               <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>trust_req</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"*"</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-44"></a>    <span class='hs-varid'>ppr_boot</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[boot]"</span>
<a name="line-45"></a>    <span class='hs-varid'>ppr_boot</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="pprIfaceDecl"></a><span class='hs-definition'>pprIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-48"></a><span class='hs-definition'>pprIfaceDecl</span> <span class='hs-layout'>(</span><span class='hs-varid'>ver</span><span class='hs-layout'>,</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ver</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="pprFixities"></a><span class='hs-definition'>pprFixities</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-52"></a><span class='hs-definition'>pprFixities</span> <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-53"></a><span class='hs-definition'>pprFixities</span> <span class='hs-varid'>fixes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"fixities"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>pprFix</span> <span class='hs-varid'>fixes</span>
<a name="line-54"></a>                  <span class='hs-keyword'>where</span>
<a name="line-55"></a>                    <span class='hs-varid'>pprFix</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ</span><span class='hs-layout'>,</span><span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fix</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span> 
<a name="line-56"></a>
<a name="line-57"></a><a name="pprVectInfo"></a><span class='hs-definition'>pprVectInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceVectInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-58"></a><span class='hs-definition'>pprVectInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceVectInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifaceVectInfoVar</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span>
<a name="line-59"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoTyCon</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycons</span>
<a name="line-60"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoTyConReuse</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyconsReuse</span>
<a name="line-61"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoParallelVars</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parallelVars</span>
<a name="line-62"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoParallelTyCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parallelTyCons</span>
<a name="line-63"></a>                           <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-64"></a>  <span class='hs-varid'>vcat</span> 
<a name="line-65"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"vectorised variables:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-66"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"vectorised tycons:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tycons</span><span class='hs-layout'>)</span>
<a name="line-67"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"vectorised reused tycons:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyconsReuse</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"parallel variables:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>parallelVars</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"parallel tycons:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>parallelTyCons</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>]</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="pprTrustInfo"></a><span class='hs-definition'>pprTrustInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceTrustInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-73"></a><span class='hs-definition'>pprTrustInfo</span> <span class='hs-varid'>trust</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"trusted:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>trust</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="pprTrustPkg"></a><span class='hs-definition'>pprTrustPkg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-76"></a><span class='hs-definition'>pprTrustPkg</span> <span class='hs-varid'>tpkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"require own pkg trusted:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tpkg</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Warnings</span> <span class='hs-keyword'>where</span>
<a name="line-79"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprWarns</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="pprWarns"></a><span class='hs-definition'>pprWarns</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Warnings</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-82"></a><span class='hs-definition'>pprWarns</span> <span class='hs-conid'>NoWarnings</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-83"></a><span class='hs-definition'>pprWarns</span> <span class='hs-layout'>(</span><span class='hs-conid'>WarnAll</span> <span class='hs-varid'>txt</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Warn all"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>txt</span>
<a name="line-84"></a><span class='hs-definition'>pprWarns</span> <span class='hs-layout'>(</span><span class='hs-conid'>WarnSome</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Warnings"</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprWarning</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-86"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>pprWarning</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>txt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>txt</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="pprIfaceAnnotation"></a><span class='hs-definition'>pprIfaceAnnotation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceAnnotation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-89"></a><span class='hs-definition'>pprIfaceAnnotation</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceAnnotation</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifAnnotatedTarget</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifAnnotatedValue</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>serialized</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>target</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"annotated by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>serialized</span>
</pre>\end{code}


%*********************************************************
%*                                                       *
\subsection{Errors}
%*                                                       *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="badIfaceFile"></a><span class='hs-definition'>badIfaceFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>badIfaceFile</span> <span class='hs-varid'>file</span> <span class='hs-varid'>err</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Bad interface file:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>file</span><span class='hs-layout'>,</span> 
<a name="line-4"></a>          <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-varid'>err</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="hiModuleNameMismatchWarn"></a><span class='hs-definition'>hiModuleNameMismatchWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-7"></a><span class='hs-definition'>hiModuleNameMismatchWarn</span> <span class='hs-varid'>requested_mod</span> <span class='hs-varid'>read_mod</span> <span class='hs-keyglyph'>=</span> 
<a name="line-8"></a>  <span class='hs-varid'>withPprStyle</span> <span class='hs-varid'>defaultUserStyle</span> <span class='hs-varop'>$</span>
<a name="line-9"></a>    <span class='hs-comment'>-- we want the Modules below to be qualified with package names,</span>
<a name="line-10"></a>    <span class='hs-comment'>-- so reset the PrintUnqualified setting.</span>
<a name="line-11"></a>    <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Something is amiss; requested module "</span><span class='hs-layout'>)</span>
<a name="line-12"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>requested_mod</span>
<a name="line-13"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"differs from name found in the interface file"</span><span class='hs-layout'>)</span>
<a name="line-14"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>read_mod</span>
<a name="line-15"></a>         <span class='hs-keyglyph'>]</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="wrongIfaceModErr"></a><span class='hs-definition'>wrongIfaceModErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-18"></a><span class='hs-definition'>wrongIfaceModErr</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>file_path</span> 
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Interface file"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>iface_file</span><span class='hs-layout'>,</span>
<a name="line-20"></a>         <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"contains module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span><span class='hs-layout'>,</span>
<a name="line-21"></a>         <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but we were expecting module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod_name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-22"></a>         <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable cause: the source code which generated"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-23"></a>             <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>iface_file</span><span class='hs-layout'>,</span>
<a name="line-24"></a>             <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has an incompatible module name"</span><span class='hs-layout'>)</span>
<a name="line-25"></a>            <span class='hs-keyglyph'>]</span>
<a name="line-26"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-27"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>iface_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>file_path</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="homeModError"></a><span class='hs-definition'>homeModError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-30"></a><span class='hs-comment'>-- See Note [Home module load error]</span>
<a name="line-31"></a><span class='hs-definition'>homeModError</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>location</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"attempting to use module "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-33"></a>    <span class='hs-varop'>&lt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>ml_hs_file</span> <span class='hs-varid'>location</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>space</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-35"></a>           <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-36"></a>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"which is not loaded"</span><span class='hs-layout'>)</span>
</pre>\end{code}

</body>
</html>
