<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>coreSyn/CorePrep.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow, 1994-2006
%

Core pass to saturate constructors and PrimOps

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CorePrep</span> <span class='hs-layout'>(</span>
<a name="line-4"></a>      <span class='hs-varid'>corePrepPgm</span><span class='hs-layout'>,</span> <span class='hs-varid'>corePrepExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cvtLitInteger</span><span class='hs-layout'>,</span>
<a name="line-5"></a>      <span class='hs-varid'>lookupMkIntegerName</span><span class='hs-layout'>,</span>
<a name="line-6"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccurAnal</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreMonad</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>endPass</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreToDo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSubst</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-conid'>FloatBind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- We use our own FloatBind here</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OrdList</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Config</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bits</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
</pre>\end{code}

-- ---------------------------------------------------------------------------
-- Overview
-- ---------------------------------------------------------------------------

The goal of this pass is to prepare for code generation.

1.  Saturate constructor and primop applications.

2.  Convert to A-normal form; that is, function arguments
    are always variables.

    * Use case for strict arguments:
        f E ==> case E of x -> f x
        (where f is strict)

    * Use let for non-trivial lazy arguments
        f E ==> let x = E in f x
        (were f is lazy and x is non-trivial)

3.  Similarly, convert any unboxed lets into cases.
    [I'm experimenting with leaving 'ok-for-speculation'
     rhss in let-form right up to this point.]

4.  Ensure that *value* lambdas only occur as the RHS of a binding
    (The code generator can't deal with anything else.)
    Type lambdas are ok, however, because the code gen discards them.

5.  [Not any more; nuked Jun 2002] Do the seq/par munging.

6.  Clone all local Ids.
    This means that all such Ids are unique, rather than the
    weaker guarantee of no clashes which the simplifier provides.
    And that is what the code generator needs.

    We don't clone TyVars or CoVars. The code gen doesn't need that,
    and doing so would be tiresome because then we'd need
    to substitute in types and coercions.

7.  Give each dynamic CCall occurrence a fresh unique; this is
    rather like the cloning step above.

8.  Inject bindings for the "implicit" Ids:
        * Constructor wrappers
        * Constructor workers
    We want curried definitions for all of these in case they
    aren't inlined by some caller.

9.  Replace (lazy e) by e.  See Note [lazyId magic] in MkId.lhs

10. Convert (LitInteger i t) into the core representation
    for the Integer i. Normally this uses mkInteger, but if
    we are using the integer-gmp implementation then there is a
    special case where we use the S# constructor for Integers that
    are in the range of Int.

This is all done modulo type applications and abstractions, so that
when type erasure is done for conversion to STG, we don't end up with
any trivial or useless bindings.


Invariants
~~~~~~~~~~
Here is the syntax of the Core produced by CorePrep:

    Trivial expressions
       triv ::= lit |  var
              | triv ty  |  /\a. triv
              | truv co  |  /\c. triv  |  triv |> co

    Applications
       app ::= lit  |  var  |  app triv  |  app ty  | app co | app |> co

    Expressions
       body ::= app
              | let(rec) x = rhs in body     -- Boxed only
              | case body of pat -> body
              | /\a. body | /\c. body
              | body |> co

    Right hand sides (only place where value lambdas can occur)
       rhs ::= /\a.rhs  |  \x.rhs  |  body

We define a synonym for each of these non-terminals.  Functions
with the corresponding name produce a result in that syntax.

\begin{code}
<pre><a name="line-1"></a><a name="CpeTriv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeTriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'triv'</span>
<a name="line-2"></a><a name="CpeApp"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeApp</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'app'</span>
<a name="line-3"></a><a name="CpeBody"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeBody</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'body'</span>
<a name="line-4"></a><a name="CpeRhs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CpeRhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- Non-terminal 'rhs'</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Top level stuff
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="corePrepPgm"></a><span class='hs-definition'>corePrepPgm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-2"></a><span class='hs-definition'>corePrepPgm</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>data_tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>    <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"CorePrep"</span>
<a name="line-4"></a>    <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'s'</span>
<a name="line-5"></a>    <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkInitialCorePrepEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-6"></a>
<a name="line-7"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>implicit_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDataConWorkers</span> <span class='hs-varid'>data_tycons</span>
<a name="line-8"></a>            <span class='hs-comment'>-- NB: we must feed mkImplicitBinds through corePrep too</span>
<a name="line-9"></a>            <span class='hs-comment'>-- so that they are suitably cloned and eta-expanded</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-varid'>binds_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initUs_</span> <span class='hs-varid'>us</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-12"></a>                      <span class='hs-varid'>floats1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>corePrepTopBinds</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>binds</span>
<a name="line-13"></a>                      <span class='hs-varid'>floats2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>corePrepTopBinds</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>implicit_binds</span>
<a name="line-14"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>deFloatTop</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-varid'>endPass</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>CorePrep</span> <span class='hs-varid'>binds_out</span> <span class='hs-conid'>[]</span>
<a name="line-17"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>binds_out</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="corePrepExpr"></a><span class='hs-definition'>corePrepExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-20"></a><span class='hs-definition'>corePrepExpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-21"></a>    <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"CorePrep"</span>
<a name="line-22"></a>    <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'s'</span>
<a name="line-23"></a>    <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkInitialCorePrepEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-24"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initUs_</span> <span class='hs-varid'>us</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-25"></a>    <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_prep</span> <span class='hs-str'>"CorePrep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>new_expr</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="corePrepTopBinds"></a><span class='hs-definition'>corePrepTopBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>Floats</span>
<a name="line-29"></a><span class='hs-comment'>-- Note [Floating out of top level bindings]</span>
<a name="line-30"></a><span class='hs-definition'>corePrepTopBinds</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>binds</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>initialCorePrepEnv</span> <span class='hs-varid'>binds</span>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>emptyFloats</span>
<a name="line-34"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBind</span> <span class='hs-conid'>TopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bind</span>
<a name="line-35"></a>                               <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>binds</span>
<a name="line-36"></a>                               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind'</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="mkDataConWorkers"></a><span class='hs-definition'>mkDataConWorkers</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a><span class='hs-comment'>-- See Note [Data constructor workers]</span>
<a name="line-40"></a><span class='hs-comment'>-- c.f. Note [Injecting implicit bindings] in TidyPgm</span>
<a name="line-41"></a><span class='hs-definition'>mkDataConWorkers</span> <span class='hs-varid'>data_tycons</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- The ice is thin here, but it works</span>
<a name="line-43"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>data_tycons</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- CorePrep will eta-expand it</span>
<a name="line-44"></a>      <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-45"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConWorkId</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Floating out of top level bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: we do need to float out of top-level bindings
Consider        x = length [True,False]
We want to get
                s1 = False : []
                s2 = True  : s1
                x  = length s2

We return a *list* of bindings, because we may start with
        x* = f (g y)
where x is demanded, in which case we want to finish with
        a = g y
        x* = f a
And then x will actually end up case-bound

Note [CafInfo and floating]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
What happens when we try to float bindings to the top level?  At this
point all the CafInfo is supposed to be correct, and we must make certain
that is true of the new top-level bindings.  There are two cases
to consider

a) The top-level binding is marked asCafRefs.  In that case we are
   basically fine.  The floated bindings had better all be lazy lets,
   so they can float to top level, but they'll all have HasCafRefs
   (the default) which is safe.

b) The top-level binding is marked NoCafRefs.  This really happens
   Example.  CoreTidy produces
      $fApplicativeSTM [NoCafRefs] = D:Alternative retry# ...blah...
   Now CorePrep has to eta-expand to
      $fApplicativeSTM = let sat = \xy. retry x y
                         in D:Alternative sat ...blah...
   So what we *want* is
      sat [NoCafRefs] = \xy. retry x y
      $fApplicativeSTM [NoCafRefs] = D:Alternative sat ...blah...

   So, gruesomely, we must set the NoCafRefs flag on the sat bindings,
   *and* substutite the modified 'sat' into the old RHS.

   It should be the case that 'sat' is itself [NoCafRefs] (a value, no
   cafs) else the original top-level binding would not itself have been
   marked [NoCafRefs].  The DEBUG check in CoreToStg for
   consistentCafInfo will find this.

This is all very gruesome and horrible. It would be better to figure
out CafInfo later, after CorePrep.  We'll do that in due course.
Meanwhile this horrible hack works.


Note [Data constructor workers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Create any necessary "implicit" bindings for data con workers.  We
create the rather strange (non-recursive!) binding

        $wC = \x y -> $wC x y

i.e. a curried constructor that allocates.  This means that we can
treat the worker for a constructor like any other function in the rest
of the compiler.  The point here is that CoreToStg will generate a
StgConApp for the RHS, rather than a call to the worker (which would
give a loop).  As Lennart says: the ice is thin here, but it works.

Hmm.  Should we create bindings for dictionary constructors?  They are
always fully applied, and the bindings are just there to support
partial applications. But it's easier to let them through.


Note [Dead code in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Imagine that we got an input program like this (see Trac #4962):

  f :: Show b => Int -> (Int, b -> Maybe Int -> Int)
  f x = (g True (Just x) + g () (Just x), g)
    where
      g :: Show a => a -> Maybe Int -> Int
      g _ Nothing = x
      g y (Just z) = if z > 100 then g y (Just (z + length (show y))) else g y unknown

After specialisation and SpecConstr, we would get something like this:

  f :: Show b => Int -> (Int, b -> Maybe Int -> Int)
  f x = (g$Bool_True_Just x + g$Unit_Unit_Just x, g)
    where
      {-# RULES g $dBool = g$Bool
                g $dUnit = g$Unit #-}
      g = ...
      {-# RULES forall x. g$Bool True (Just x) = g$Bool_True_Just x #-}
      g$Bool = ...
      {-# RULES forall x. g$Unit () (Just x) = g$Unit_Unit_Just x #-}
      g$Unit = ...
      g$Bool_True_Just = ...
      g$Unit_Unit_Just = ...

Note that the g$Bool and g$Unit functions are actually dead code: they
are only kept alive by the occurrence analyser because they are
referred to by the rules of g, which is being kept alive by the fact
that it is used (unspecialised) in the returned pair.

However, at the CorePrep stage there is no way that the rules for g
will ever fire, and it really seems like a shame to produce an output
program that goes to the trouble of allocating a closure for the
unreachable g$Bool and g$Unit functions.

The way we fix this is to:
 * In cloneBndr, drop all unfoldings/rules

 * In deFloatTop, run a simple dead code analyser on each top-level
   RHS to drop the dead local bindings. For that call to OccAnal, we
   disable the binder swap, else the occurrence analyser sometimes
   introduces new let bindings for cased binders, which lead to the bug
   in #5433.

The reason we don't just OccAnal the whole output of CorePrep is that
the tidier ensures that all top-level binders are GlobalIds, so they
don't show up in the free variables any longer. So if you run the
occurrence analyser on the output of CoreTidy (or later) you e.g. turn
this program:

  Rec {
  f = ... f ...
  }

Into this one:

  f = ... f ...

(Since f is not considered to be free in its own RHS.)


%************************************************************************
%*                                                                      *
                The main code
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="cpeBind"></a><span class='hs-definition'>cpeBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Floats</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>cpeBind</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dmd</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idDemandInfo</span> <span class='hs-varid'>bndr</span>
<a name="line-6"></a>             <span class='hs-varid'>is_unlifted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpePair</span> <span class='hs-varid'>top_lvl</span> <span class='hs-conid'>NonRecursive</span>
<a name="line-8"></a>                                          <span class='hs-varid'>dmd</span> 
<a name="line-9"></a>                                          <span class='hs-varid'>is_unlifted</span>
<a name="line-10"></a>                                          <span class='hs-varid'>env</span> <span class='hs-varid'>bndr1</span> <span class='hs-varid'>rhs</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFloat</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>bndr2</span> <span class='hs-varid'>rhs2</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-comment'>-- We want bndr'' in the envt, because it records</span>
<a name="line-14"></a>        <span class='hs-comment'>-- the evaluated-ness of the binder</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr2</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                 <span class='hs-varid'>addFloat</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>new_float</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>cpeBind</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span><span class='hs-varid'>rhss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpePair</span> <span class='hs-varid'>top_lvl</span> <span class='hs-conid'>Recursive</span> <span class='hs-varid'>topDmd</span> <span class='hs-conid'>False</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs1</span> <span class='hs-varid'>rhss</span>
<a name="line-22"></a>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip3</span> <span class='hs-varid'>stuff</span>
<a name="line-24"></a>             <span class='hs-varid'>all_pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrOL</span> <span class='hs-varid'>add_float</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs2</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rhss2</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>concatFloats</span> <span class='hs-varid'>floats_s</span><span class='hs-layout'>)</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnvList</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>bndrs2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>                 <span class='hs-varid'>unitFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>all_pairs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>        <span class='hs-comment'>-- Flatten all the floats, and the currrent</span>
<a name="line-30"></a>        <span class='hs-comment'>-- group into a single giant Rec</span>
<a name="line-31"></a>    <span class='hs-varid'>add_float</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>prs2</span>
<a name="line-32"></a>    <span class='hs-varid'>add_float</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-varid'>prs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prs2</span>
<a name="line-33"></a>    <span class='hs-varid'>add_float</span> <span class='hs-varid'>b</span>                       <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"cpeBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="cpePair"></a><span class='hs-comment'>---------------</span>
<a name="line-36"></a><span class='hs-definition'>cpePair</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-37"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-38"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-comment'>-- Used for all bindings</span>
<a name="line-40"></a><span class='hs-definition'>cpePair</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs</span>
<a name="line-42"></a>
<a name="line-43"></a>       <span class='hs-comment'>-- See if we are allowed to float this stuff out of the RHS</span>
<a name="line-44"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>float_from_rhs</span> <span class='hs-varid'>floats1</span> <span class='hs-varid'>rhs1</span>
<a name="line-45"></a>
<a name="line-46"></a>       <span class='hs-comment'>-- Make the arity match up</span>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats3</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-48"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>rhs1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>arity</span>
<a name="line-49"></a>               <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span>
<a name="line-50"></a>               <span class='hs-keyword'>else</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CorePrep: silly extra arguments:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                               <span class='hs-comment'>-- Note [Silly extra arguments]</span>
<a name="line-52"></a>                    <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-53"></a>                        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFloat</span> <span class='hs-varid'>topDmd</span> <span class='hs-conid'>False</span> <span class='hs-varid'>v</span> <span class='hs-varid'>rhs2</span>
<a name="line-54"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>addFloat</span> <span class='hs-varid'>floats2</span> <span class='hs-varid'>float</span>
<a name="line-55"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-comment'>-- Record if the binder is evaluated</span>
<a name="line-58"></a>        <span class='hs-comment'>-- and otherwise trim off the unfolding altogether</span>
<a name="line-59"></a>        <span class='hs-comment'>-- It's not used by the code generator; getting rid of it reduces</span>
<a name="line-60"></a>        <span class='hs-comment'>-- heap usage and, since we may be changing uniques, we'd have</span>
<a name="line-61"></a>        <span class='hs-comment'>-- to substitute to keep it right</span>
<a name="line-62"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-63"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-64"></a>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats3</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-66"></a>  <span class='hs-keyword'>where</span>
<a name="line-67"></a>    <span class='hs-varid'>is_strict_or_unlifted</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrictDmd</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_unlifted</span>
<a name="line-68"></a>
<a name="line-69"></a>    <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_dynFlags</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>bndr</span>        <span class='hs-comment'>-- We must match this arity</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-comment'>---------------------</span>
<a name="line-74"></a>    <span class='hs-varid'>float_from_rhs</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-75"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyFloats</span> <span class='hs-varid'>floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-76"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>float_top</span>    <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-77"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>float_nested</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-comment'>---------------------</span>
<a name="line-80"></a>    <span class='hs-varid'>float_nested</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-81"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>wantFloatNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>is_strict_or_unlifted</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-82"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-83"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dont_float</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-84"></a>
<a name="line-85"></a>    <span class='hs-comment'>---------------------</span>
<a name="line-86"></a>    <span class='hs-varid'>float_top</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>        <span class='hs-comment'>-- Urhgh!  See Note [CafInfo and floating]</span>
<a name="line-87"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-88"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>allLazyTop</span> <span class='hs-varid'>floats</span>
<a name="line-89"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a>      <span class='hs-comment'>-- So the top-level binding is marked NoCafRefs</span>
<a name="line-92"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>canFloatFromNoCaf</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-93"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-96"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dont_float</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-97"></a>
<a name="line-98"></a>    <span class='hs-comment'>---------------------</span>
<a name="line-99"></a>    <span class='hs-varid'>dont_float</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-100"></a>      <span class='hs-comment'>-- Non-empty floats, but do not want to float from rhs</span>
<a name="line-101"></a>      <span class='hs-comment'>-- So wrap the rhs in the floats</span>
<a name="line-102"></a>      <span class='hs-comment'>-- But: rhs1 might have lambdas, and we can't</span>
<a name="line-103"></a>      <span class='hs-comment'>--      put them inside a wrapBinds</span>
<a name="line-104"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBodyNF</span> <span class='hs-varid'>rhs</span>
<a name="line-105"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapBinds</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-106"></a>
<a name="line-107"></a><span class='hs-comment'>{- Note [Silly extra arguments]
<a name="line-108"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-109"></a>Suppose we had this
<a name="line-110"></a>        f{arity=1} = \x\y. e
<a name="line-111"></a>We *must* match the arity on the Id, so we have to generate
<a name="line-112"></a>        f' = \x\y. e
<a name="line-113"></a>        f  = \x. f' x
<a name="line-114"></a>
<a name="line-115"></a>It's a bizarre case: why is the arity on the Id wrong?  Reason
<a name="line-116"></a>(in the days of __inline_me__):
<a name="line-117"></a>        f{arity=0} = __inline_me__ (let v = expensive in \xy. e)
<a name="line-118"></a>When InlineMe notes go away this won't happen any more.  But
<a name="line-119"></a>it seems good for CorePrep to be robust.
<a name="line-120"></a>-}</span>
<a name="line-121"></a>
<a name="line-122"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-123"></a><span class='hs-comment'>--              CpeRhs: produces a result satisfying CpeRhs</span>
<a name="line-124"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="cpeRhsE"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-comment'>-- If</span>
<a name="line-128"></a><span class='hs-comment'>--      e  ===&gt;  (bs, e')</span>
<a name="line-129"></a><span class='hs-comment'>-- then</span>
<a name="line-130"></a><span class='hs-comment'>--      e = let bs in e'        (semantically, that is!)</span>
<a name="line-131"></a><span class='hs-comment'>--</span>
<a name="line-132"></a><span class='hs-comment'>-- For example</span>
<a name="line-133"></a><span class='hs-comment'>--      f (g x)   ===&gt;   ([v = g x], f v)</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-137"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInteger</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-138"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtLitInteger</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_dynFlags</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getMkIntegerId</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-139"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`App`</span> <span class='hs-keyword'>_</span> <span class='hs-varop'>`App`</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-143"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>lazyIdKey</span>          <span class='hs-comment'>-- Replace (lazy a) by a</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span>               <span class='hs-comment'>-- See Note [lazyId magic] in MkId</span>
<a name="line-145"></a>
<a name="line-146"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-147"></a>
<a name="line-148"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBind</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bind</span>
<a name="line-150"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>expr</span>
<a name="line-151"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_binds</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-152"></a>
<a name="line-153"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ignoreTickish</span> <span class='hs-varid'>tickish</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-156"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-comment'>-- Just SCCs actually</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-158"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish'</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-159"></a>  <span class='hs-keyword'>where</span>
<a name="line-160"></a>    <span class='hs-varid'>tickish'</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tickish</span>
<a name="line-161"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Breakpoint</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupCorePrepEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-162"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-163"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tickish</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-166"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-167"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-168"></a>
<a name="line-169"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-170"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span><span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>expr</span>
<a name="line-171"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>
<a name="line-172"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>body</span>
<a name="line-173"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>bndrs'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-174"></a>
<a name="line-175"></a><span class='hs-definition'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut</span>
<a name="line-177"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndr1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-178"></a>            <span class='hs-comment'>-- Record that the case binder is evaluated in the alternatives</span>
<a name="line-179"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr1</span>
<a name="line-180"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>sat_alt</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-181"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>bndr2</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-182"></a>  <span class='hs-keyword'>where</span>
<a name="line-183"></a>    <span class='hs-varid'>sat_alt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-184"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-185"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBodyNF</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>rhs</span>
<a name="line-186"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="cvtLitInteger"></a><span class='hs-definition'>cvtLitInteger</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-189"></a><span class='hs-comment'>-- Here we convert a literal Integer to the low-level</span>
<a name="line-190"></a><span class='hs-comment'>-- represenation. Exactly how we do this depends on the</span>
<a name="line-191"></a><span class='hs-comment'>-- library that implements Integer.  If it's GMP we</span>
<a name="line-192"></a><span class='hs-comment'>-- use the S# data constructor for small literals.</span>
<a name="line-193"></a><span class='hs-comment'>-- See Note [Integer literals] in Literal</span>
<a name="line-194"></a><span class='hs-definition'>cvtLitInteger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mk_integer</span> <span class='hs-varid'>i</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cIntegerLibraryType</span> <span class='hs-varop'>==</span> <span class='hs-conid'>IntegerGMP</span>
<a name="line-196"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>inIntRange</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span>       <span class='hs-comment'>-- Special case for small integers in GMP</span>
<a name="line-197"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>integerGmpSDataCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMachInt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-198"></a>
<a name="line-199"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-200"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>mk_integer</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>isNonNegative</span><span class='hs-layout'>,</span> <span class='hs-varid'>ints</span><span class='hs-keyglyph'>]</span>
<a name="line-201"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>isNonNegative</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>falseDataCon</span> <span class='hs-conid'>[]</span>
<a name="line-202"></a>                                 <span class='hs-keyword'>else</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>trueDataCon</span>  <span class='hs-conid'>[]</span>
<a name="line-203"></a>        <span class='hs-varid'>ints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkListExpr</span> <span class='hs-varid'>intTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>abs</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-204"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-205"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>low</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>.&amp;.</span> <span class='hs-varid'>mask</span>
<a name="line-206"></a>                  <span class='hs-varid'>high</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`shiftR`</span> <span class='hs-varid'>bits</span>
<a name="line-207"></a>              <span class='hs-keyword'>in</span> <span class='hs-varid'>mkConApp</span> <span class='hs-varid'>intDataCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMachInt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>low</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-conop'>:</span> <span class='hs-varid'>f</span> <span class='hs-varid'>high</span>
<a name="line-208"></a>        <span class='hs-varid'>bits</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>31</span>
<a name="line-209"></a>        <span class='hs-varid'>mask</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span> <span class='hs-varop'>^</span> <span class='hs-varid'>bits</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-210"></a>
<a name="line-211"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-212"></a><span class='hs-comment'>--              CpeBody: produces a result satisfying CpeBody</span>
<a name="line-213"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="cpeBodyNF"></a><span class='hs-definition'>cpeBodyNF</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeBody</span>
<a name="line-216"></a><span class='hs-definition'>cpeBodyNF</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-217"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-218"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapBinds</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-219"></a>
<a name="line-220"></a><a name="cpeBody"></a><span class='hs-comment'>--------</span>
<a name="line-221"></a><span class='hs-definition'>cpeBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeBody</span><span class='hs-layout'>)</span>
<a name="line-222"></a><span class='hs-definition'>cpeBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-223"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-224"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>rhs</span>
<a name="line-225"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="rhsToBodyNF"></a><span class='hs-comment'>--------</span>
<a name="line-228"></a><span class='hs-definition'>rhsToBodyNF</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeBody</span>
<a name="line-229"></a><span class='hs-definition'>rhsToBodyNF</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span><span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>rhs</span>
<a name="line-230"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapBinds</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-231"></a>
<a name="line-232"></a><a name="rhsToBody"></a><span class='hs-comment'>--------</span>
<a name="line-233"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeBody</span><span class='hs-layout'>)</span>
<a name="line-234"></a><span class='hs-comment'>-- Remove top level lambdas by let-binding</span>
<a name="line-235"></a>
<a name="line-236"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-237"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishScoped</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- we can only float out of non-scoped annotations</span>
<a name="line-238"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>expr</span>
<a name="line-239"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-240"></a>
<a name="line-241"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-242"></a>        <span class='hs-comment'>-- You can get things like</span>
<a name="line-243"></a>        <span class='hs-comment'>--      case e of { p -&gt; coerce t (\s -&gt; ...) }</span>
<a name="line-244"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBody</span> <span class='hs-varid'>e</span>
<a name="line-245"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-246"></a>
<a name="line-247"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-248"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>no_lam_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span>
<a name="line-249"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_lam_result</span><span class='hs-layout'>)</span>
<a name="line-250"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>bndrs</span>           <span class='hs-comment'>-- Type lambdas are ok</span>
<a name="line-251"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-252"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-comment'>-- Some value lambdas</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-254"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprArity</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-255"></a>             <span class='hs-varid'>float</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-256"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFloat</span> <span class='hs-varid'>float</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-257"></a>  <span class='hs-keyword'>where</span>
<a name="line-258"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span><span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>expr</span>
<a name="line-259"></a>
<a name="line-260"></a><span class='hs-definition'>rhsToBody</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-261"></a>
<a name="line-262"></a>
<a name="line-263"></a>
<a name="line-264"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-265"></a><span class='hs-comment'>--              CpeApp: produces a result satisfying CpeApp</span>
<a name="line-266"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="cpeApp"></a><span class='hs-definition'>cpeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-269"></a><span class='hs-comment'>-- May return a CpeRhs because of saturating primops</span>
<a name="line-270"></a><span class='hs-definition'>cpeApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-271"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>app</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span><span class='hs-layout'>,</span><span class='hs-varid'>depth</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>expr</span> <span class='hs-num'>0</span>
<a name="line-272"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- make sure we used all the strictness info</span>
<a name="line-273"></a>
<a name="line-274"></a>        <span class='hs-comment'>-- Now deal with the function</span>
<a name="line-275"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>head</span> <span class='hs-keyword'>of</span>
<a name="line-276"></a>           <span class='hs-conid'>Var</span> <span class='hs-varid'>fn_id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sat_app</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeSaturate</span> <span class='hs-varid'>fn_id</span> <span class='hs-varid'>app</span> <span class='hs-varid'>depth</span>
<a name="line-277"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>sat_app</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-278"></a>           <span class='hs-sel'>_other</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>app</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-279"></a>
<a name="line-280"></a>  <span class='hs-keyword'>where</span>
<a name="line-281"></a>    <span class='hs-comment'>-- Deconstruct and rebuild the application, floating any non-atomic</span>
<a name="line-282"></a>    <span class='hs-comment'>-- arguments to the outside.  We collect the type of the expression,</span>
<a name="line-283"></a>    <span class='hs-comment'>-- the head of the application, and the number of actual value arguments,</span>
<a name="line-284"></a>    <span class='hs-comment'>-- all of which are used to possibly saturate this application if it</span>
<a name="line-285"></a>    <span class='hs-comment'>-- has a constructor or primop at the head.</span>
<a name="line-286"></a>
<a name="line-287"></a>    <span class='hs-varid'>collect_args</span>
<a name="line-288"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-289"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>                     <span class='hs-comment'>-- Current app depth</span>
<a name="line-290"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CpeApp</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- The rebuilt expression</span>
<a name="line-291"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The head of the application,</span>
<a name="line-292"></a>                                   <span class='hs-comment'>-- and no. of args it was applied to</span>
<a name="line-293"></a>                   <span class='hs-conid'>Type</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- Type of the whole expr</span>
<a name="line-294"></a>                   <span class='hs-conid'>Floats</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Any floats we pulled out</span>
<a name="line-295"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Remaining argument demands</span>
<a name="line-296"></a>
<a name="line-297"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-298"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>hd</span><span class='hs-layout'>,</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>depth</span>
<a name="line-299"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>hd</span><span class='hs-layout'>,</span> <span class='hs-varid'>applyTy</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-300"></a>
<a name="line-301"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>arg_co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-302"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>hd</span><span class='hs-layout'>,</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>depth</span>
<a name="line-303"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>hd</span><span class='hs-layout'>,</span> <span class='hs-varid'>applyCo</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-304"></a>
<a name="line-305"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-306"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span><span class='hs-varid'>hd</span><span class='hs-layout'>,</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span><span class='hs-varid'>floats</span><span class='hs-layout'>,</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>depth</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-307"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-308"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss_rest</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ss</span> <span class='hs-keyword'>of</span>
<a name="line-309"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span><span class='hs-conop'>:</span><span class='hs-varid'>ss_rest</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ss1</span><span class='hs-layout'>,</span>     <span class='hs-varid'>ss_rest</span><span class='hs-layout'>)</span>
<a name="line-310"></a>                                   <span class='hs-conid'>[]</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>topDmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-311"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"cpeBody:collect_args"</span> <span class='hs-varop'>$</span>
<a name="line-312"></a>                                 <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>fun_ty</span>
<a name="line-313"></a>
<a name="line-314"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeArg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ss1</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_ty</span>
<a name="line-315"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hd</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fs</span> <span class='hs-varop'>`appendFloats`</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss_rest</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-316"></a>
<a name="line-317"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-318"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fiddleCCall</span> <span class='hs-varid'>v</span>
<a name="line-319"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v1</span>
<a name="line-320"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v2</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v2</span><span class='hs-layout'>,</span> <span class='hs-varid'>depth</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>v2</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>stricts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-321"></a>        <span class='hs-keyword'>where</span>
<a name="line-322"></a>          <span class='hs-varid'>stricts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idStrictness</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>of</span>
<a name="line-323"></a>                            <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>demands</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-324"></a>                              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>listLengthCmp</span> <span class='hs-varid'>demands</span> <span class='hs-varid'>depth</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>demands</span>
<a name="line-325"></a>                                    <span class='hs-comment'>-- length demands &lt;= depth</span>
<a name="line-326"></a>                              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-327"></a>                <span class='hs-comment'>-- If depth &lt; length demands, then we have too few args to</span>
<a name="line-328"></a>                <span class='hs-comment'>-- satisfy strictness  info so we have to  ignore all the</span>
<a name="line-329"></a>                <span class='hs-comment'>-- strictness info, e.g. + (error "urk")</span>
<a name="line-330"></a>                <span class='hs-comment'>-- Here, we can't evaluate the arg strictly, because this</span>
<a name="line-331"></a>                <span class='hs-comment'>-- partial application might be seq'd</span>
<a name="line-332"></a>
<a name="line-333"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-334"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-sel'>_ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-335"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hd</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>depth</span>
<a name="line-336"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>hd</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-337"></a>
<a name="line-338"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>depth</span>
<a name="line-339"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ignoreTickish</span> <span class='hs-varid'>tickish</span>   <span class='hs-comment'>-- Drop these notes altogether</span>
<a name="line-340"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collect_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>depth</span>  <span class='hs-comment'>-- They aren't used by the code generator</span>
<a name="line-341"></a>
<a name="line-342"></a>        <span class='hs-comment'>-- N-variable fun, better let-bind it</span>
<a name="line-343"></a>    <span class='hs-varid'>collect_args</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>depth</span>
<a name="line-344"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_floats</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeArg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>evalDmd</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>ty</span>
<a name="line-345"></a>                          <span class='hs-comment'>-- The evalDmd says that it's sure to be evaluated,</span>
<a name="line-346"></a>                          <span class='hs-comment'>-- so we'll end up case-binding it</span>
<a name="line-347"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun'</span><span class='hs-layout'>,</span> <span class='hs-varid'>depth</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-348"></a>        <span class='hs-keyword'>where</span>
<a name="line-349"></a>          <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>fun</span>
<a name="line-350"></a>
<a name="line-351"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-352"></a><span class='hs-comment'>--      CpeArg: produces a result satisfying CpeArg</span>
<a name="line-353"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-354"></a>
<a name="line-355"></a><a name="cpeArg"></a><span class='hs-comment'>-- This is where we arrange that a non-trivial argument is let-bound</span>
<a name="line-356"></a><span class='hs-definition'>cpeArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> 
<a name="line-357"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeTriv</span><span class='hs-layout'>)</span>
<a name="line-358"></a><span class='hs-definition'>cpeArg</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_ty</span>
<a name="line-359"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cpeRhsE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span>     <span class='hs-comment'>-- arg1 can be a lambda</span>
<a name="line-360"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>want_float</span> <span class='hs-varid'>floats1</span> <span class='hs-varid'>arg1</span>
<a name="line-361"></a>                            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span>
<a name="line-362"></a>                            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rhsToBodyNF</span> <span class='hs-varid'>arg1</span>
<a name="line-363"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFloats</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapBinds</span> <span class='hs-varid'>floats1</span> <span class='hs-varid'>body1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-364"></a>                <span class='hs-comment'>-- Else case: arg1 might have lambdas, and we can't</span>
<a name="line-365"></a>                <span class='hs-comment'>--            put them inside a wrapBinds</span>
<a name="line-366"></a>
<a name="line-367"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cpe_ExprIsTrivial</span> <span class='hs-varid'>arg2</span>    <span class='hs-comment'>-- Do not eta expand a trivial argument</span>
<a name="line-368"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats2</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span>
<a name="line-369"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-370"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-varid'>arg_ty</span>
<a name="line-371"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg3</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprArity</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg2</span>
<a name="line-372"></a>             <span class='hs-varid'>arg_float</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFloat</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>v</span> <span class='hs-varid'>arg3</span>
<a name="line-373"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>addFloat</span> <span class='hs-varid'>floats2</span> <span class='hs-varid'>arg_float</span><span class='hs-layout'>,</span> <span class='hs-varid'>varToCoreExpr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-374"></a>  <span class='hs-keyword'>where</span>
<a name="line-375"></a>    <span class='hs-varid'>is_unlifted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>arg_ty</span>
<a name="line-376"></a>    <span class='hs-varid'>is_strict</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrictDmd</span> <span class='hs-varid'>dmd</span>
<a name="line-377"></a>    <span class='hs-varid'>want_float</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wantFloatNested</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_strict</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_unlifted</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Floating unlifted arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider    C (let v* = expensive in v)

where the "*" indicates "will be demanded".  Usually v will have been
inlined by now, but let's suppose it hasn't (see Trac #2756).  Then we
do *not* want to get

     let v* = expensive in C v

because that has different strictness.  Hence the use of 'allLazy'.
(NB: the let v* turns into a FloatCase, in mkLocalNonRec.)


------------------------------------------------------------------------------
-- Building the saturated syntax
-- ---------------------------------------------------------------------------

maybeSaturate deals with saturating primops and constructors
The type is the type of the entire application

\begin{code}
<pre><a name="line-1"></a><a name="maybeSaturate"></a><span class='hs-definition'>maybeSaturate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeRhs</span>
<a name="line-2"></a><span class='hs-definition'>maybeSaturate</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>n_args</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>DataToTagOp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPrimOpId_maybe</span> <span class='hs-varid'>fn</span>     <span class='hs-comment'>-- DataToTag must have an evaluated arg</span>
<a name="line-4"></a>                                                <span class='hs-comment'>-- A gruesome special case</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>saturateDataToTag</span> <span class='hs-varid'>sat_expr</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hasNoBinding</span> <span class='hs-varid'>fn</span>        <span class='hs-comment'>-- There's no binding</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>sat_expr</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>expr</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>fn_arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>fn</span>
<a name="line-14"></a>    <span class='hs-varid'>excess_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn_arity</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_args</span>
<a name="line-15"></a>    <span class='hs-varid'>sat_expr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpeEtaExpand</span> <span class='hs-varid'>excess_arity</span> <span class='hs-varid'>expr</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="saturateDataToTag"></a><span class='hs-comment'>-------------</span>
<a name="line-18"></a><span class='hs-definition'>saturateDataToTag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CpeApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeApp</span>
<a name="line-19"></a><span class='hs-comment'>-- See Note [dataToTag magic]</span>
<a name="line-20"></a><span class='hs-definition'>saturateDataToTag</span> <span class='hs-varid'>sat_expr</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>eta_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eta_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectBinders</span> <span class='hs-varid'>sat_expr</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>eta_body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>eta_body</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLams</span> <span class='hs-varid'>eta_bndrs</span> <span class='hs-varid'>eta_body'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>  <span class='hs-keyword'>where</span>
<a name="line-25"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CpeApp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>CpeBody</span>
<a name="line-26"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>app</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>fun</span> <span class='hs-varop'>`App`</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-27"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>arg</span>         <span class='hs-comment'>-- Includes nullary constructors</span>
<a name="line-28"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>app</span>            <span class='hs-comment'>-- The arg is evaluated</span>
<a name="line-29"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-comment'>-- Arg not evaluated, so evaluate it</span>
<a name="line-30"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-31"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_id1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setIdUnfolding</span> <span class='hs-varid'>arg_id</span> <span class='hs-varid'>evaldUnfolding</span>
<a name="line-32"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_id1</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>app</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                            <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`App`</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>arg_id1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>app</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Scc notes can appear</span>
<a name="line-36"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>app'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>app</span>
<a name="line-37"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>app'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>eval_data2tag_arg</span> <span class='hs-varid'>other</span>     <span class='hs-comment'>-- Should not happen</span>
<a name="line-40"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"eval_data2tag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [dataToTag magic]
~~~~~~~~~~~~~~~~~~~~~~
Horrid: we must ensure that the arg of data2TagOp is evaluated
  (data2tag x) -->  (case x of y -> data2tag y)
(yuk yuk) take into account the lambdas we've now introduced

How might it not be evaluated?  Well, we might have floated it out
of the scope of a `seq`, or dropped the `seq` altogether.


%************************************************************************
%*                                                                      *
                Simple CoreSyn operations
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="ignoreTickish"></a><span class='hs-comment'>-- we don't ignore any Tickishes at the moment.</span>
<a name="line-2"></a><span class='hs-definition'>ignoreTickish</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a><span class='hs-definition'>ignoreTickish</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="cpe_ExprIsTrivial"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-6"></a><span class='hs-comment'>-- Version that doesn't consider an scc annotation to be trivial.</span>
<a name="line-7"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-8"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-9"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-10"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-11"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTypeArg</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>cpe_ExprIsTrivial</span> <span class='hs-varid'>e</span>
<a name="line-12"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickishIsCode</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>cpe_ExprIsTrivial</span> <span class='hs-varid'>e</span>
<a name="line-13"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe_ExprIsTrivial</span> <span class='hs-varid'>e</span>
<a name="line-14"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe_ExprIsTrivial</span> <span class='hs-varid'>body</span>
<a name="line-15"></a><span class='hs-definition'>cpe_ExprIsTrivial</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

-- -----------------------------------------------------------------------------
--      Eta reduction
-- -----------------------------------------------------------------------------

Note [Eta expansion]
~~~~~~~~~~~~~~~~~~~~~
Eta expand to match the arity claimed by the binder Remember,
CorePrep must not change arity

Eta expansion might not have happened already, because it is done by
the simplifier only when there at least one lambda already.

NB1:we could refrain when the RHS is trivial (which can happen
    for exported things).  This would reduce the amount of code
    generated (a little) and make things a little words for
    code compiled without -O.  The case in point is data constructor
    wrappers.

NB2: we have to be careful that the result of etaExpand doesn't
   invalidate any of the assumptions that CorePrep is attempting
   to establish.  One possible cause is eta expanding inside of
   an SCC note - we're now careful in etaExpand to make sure the
   SCC is pushed inside any new lambdas that are generated.

Note [Eta expansion and the CorePrep invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It turns out to be much much easier to do eta expansion
*after* the main CorePrep stuff.  But that places constraints
on the eta expander: given a CpeRhs, it must return a CpeRhs.

For example here is what we do not want:
                f = /\a -> g (h 3)      -- h has arity 2
After ANFing we get
                f = /\a -> let s = h 3 in g s
and now we do NOT want eta expansion to give
                f = /\a -> \ y -> (let s = h 3 in g s) y

Instead CoreArity.etaExpand gives
                f = /\a -> \y -> let s = h 3 in g s y

\begin{code}
<pre><a name="line-1"></a><a name="cpeEtaExpand"></a><span class='hs-definition'>cpeEtaExpand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span>
<a name="line-2"></a><span class='hs-definition'>cpeEtaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpand</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>expr</span>
</pre>\end{code}

-- -----------------------------------------------------------------------------
--      Eta reduction
-- -----------------------------------------------------------------------------

Why try eta reduction?  Hasn't the simplifier already done eta?
But the simplifier only eta reduces if that leaves something
trivial (like f, or f Int).  But for deLam it would be enough to
get to a partial application:
        case x of { p -> \xs. map f xs }
    ==> case x of { p -> map f }

\begin{code}
<pre><a name="line-1"></a><a name="tryEtaReducePrep"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBndr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ok_to_eta_reduce</span> <span class='hs-varid'>f</span>
<a name="line-4"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>n_remaining</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>
<a name="line-5"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>and</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>last_args</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fvs_remaining</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>remaining_expr</span>   <span class='hs-comment'>-- Don't turn value into a non-value</span>
<a name="line-8"></a>                               <span class='hs-comment'>-- else the behaviour with 'seq' changes</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>remaining_expr</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>expr</span>
<a name="line-12"></a>    <span class='hs-varid'>remaining_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-varid'>f</span> <span class='hs-varid'>remaining_args</span>
<a name="line-13"></a>    <span class='hs-varid'>fvs_remaining</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>remaining_expr</span>
<a name="line-14"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>remaining_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>last_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n_remaining</span> <span class='hs-varid'>args</span>
<a name="line-15"></a>    <span class='hs-varid'>n_remaining</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bndrs</span>
<a name="line-16"></a>
<a name="line-17"></a>    <span class='hs-varid'>ok</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>==</span> <span class='hs-varid'>arg</span>
<a name="line-18"></a>    <span class='hs-varid'>ok</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-19"></a>
<a name="line-20"></a>          <span class='hs-comment'>-- We can't eta reduce something which must be saturated.</span>
<a name="line-21"></a>    <span class='hs-varid'>ok_to_eta_reduce</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasNoBinding</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-22"></a>    <span class='hs-varid'>ok_to_eta_reduce</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- Safe. ToDo: generalise</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tryEtaReducePrep</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>of</span>
<a name="line-27"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-28"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-29"></a>  <span class='hs-keyword'>where</span>
<a name="line-30"></a>    <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>r</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-definition'>tryEtaReducePrep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Floats
%*                                                                      *
%************************************************************************

Note [Pin demand info on floats]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pin demand info on floated lets so that we can see the one-shot thunks.

\begin{code}
<pre><a name="line-1"></a><a name="FloatingBind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FloatingBind</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-conid'>CoreBind</span>    <span class='hs-comment'>-- Rhs of bindings are CpeRhss</span>
<a name="line-3"></a>                         <span class='hs-comment'>-- They are always of lifted type;</span>
<a name="line-4"></a>                         <span class='hs-comment'>-- unlifted ones are done with FloatCase</span>
<a name="line-5"></a>
<a name="line-6"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FloatCase</span>
<a name="line-7"></a>      <span class='hs-conid'>Id</span> <span class='hs-conid'>CpeBody</span>
<a name="line-8"></a>      <span class='hs-conid'>Bool</span>              <span class='hs-comment'>-- The bool indicates "ok-for-speculation"</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="Floats"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FloatingBind</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span>
<a name="line-14"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ok</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Floats</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Floats"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-18"></a>                         <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyword'>where</span>
<a name="line-21"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>OkToSpec</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"OkToSpec"</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"IfUnboxedOk"</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"NotOkToSpec"</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="OkToSpec"></a><span class='hs-comment'>-- Can we float these binds out of the rhs of a let?  We cache this decision</span>
<a name="line-26"></a><a name="OkToSpec"></a><span class='hs-comment'>-- to avoid having to recompute it in a non-linear way when there are</span>
<a name="line-27"></a><a name="OkToSpec"></a><span class='hs-comment'>-- deeply nested lets.</span>
<a name="line-28"></a><a name="OkToSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-29"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OkToSpec</span>           <span class='hs-comment'>-- Lazy bindings of lifted type</span>
<a name="line-30"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfUnboxedOk</span>        <span class='hs-comment'>-- A mixture of lazy lifted bindings and n</span>
<a name="line-31"></a>                        <span class='hs-comment'>-- ok-to-speculate unlifted bindings</span>
<a name="line-32"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NotOkToSpec</span>        <span class='hs-comment'>-- Some not-ok-to-speculate unlifted bindings</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="mkFloat"></a><span class='hs-definition'>mkFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatingBind</span>
<a name="line-35"></a><span class='hs-definition'>mkFloat</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>use_case</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatCase</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprOkForSpeculation</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_hnf</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bndr</span>                       <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-layout'>(</span><span class='hs-varid'>setIdDemandInfo</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                   <span class='hs-comment'>-- See Note [Pin demand info on floats]</span>
<a name="line-40"></a>  <span class='hs-keyword'>where</span>
<a name="line-41"></a>    <span class='hs-varid'>is_hnf</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>rhs</span>
<a name="line-42"></a>    <span class='hs-varid'>is_strict</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrictDmd</span> <span class='hs-varid'>dmd</span>
<a name="line-43"></a>    <span class='hs-varid'>use_case</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_unlifted</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_strict</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_hnf</span>
<a name="line-44"></a>                <span class='hs-comment'>-- Don't make a case for a value binding,</span>
<a name="line-45"></a>                <span class='hs-comment'>-- even if it's strict.  Otherwise we get</span>
<a name="line-46"></a>                <span class='hs-comment'>--      case (\x -&gt; e) of ...!</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="emptyFloats"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span>
<a name="line-49"></a><span class='hs-definition'>emptyFloats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-varid'>nilOL</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="isEmptyFloats"></a><span class='hs-definition'>isEmptyFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-52"></a><span class='hs-definition'>isEmptyFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNilOL</span> <span class='hs-varid'>bs</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="wrapBinds"></a><span class='hs-definition'>wrapBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeBody</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeBody</span>
<a name="line-55"></a><span class='hs-definition'>wrapBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrOL</span> <span class='hs-varid'>mk_bind</span> <span class='hs-varid'>body</span> <span class='hs-varid'>binds</span>
<a name="line-57"></a>  <span class='hs-keyword'>where</span>
<a name="line-58"></a>    <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-59"></a>    <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>        <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="addFloat"></a><span class='hs-definition'>addFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FloatingBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span>
<a name="line-62"></a><span class='hs-definition'>addFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>ok_to_spec</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_float</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-layout'>(</span><span class='hs-varid'>combine</span> <span class='hs-varid'>ok_to_spec</span> <span class='hs-layout'>(</span><span class='hs-varid'>check</span> <span class='hs-varid'>new_float</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>new_float</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyword'>where</span>
<a name="line-65"></a>    <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-66"></a>    <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ok_for_spec</span><span class='hs-layout'>)</span>
<a name="line-67"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ok_for_spec</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>IfUnboxedOk</span>
<a name="line-68"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>NotOkToSpec</span>
<a name="line-69"></a>        <span class='hs-comment'>-- The ok-for-speculation flag says that it's safe to</span>
<a name="line-70"></a>        <span class='hs-comment'>-- float this Case out of a let, and thereby do it more eagerly</span>
<a name="line-71"></a>        <span class='hs-comment'>-- We need the top-level flag because it's never ok to float</span>
<a name="line-72"></a>        <span class='hs-comment'>-- an unboxed binding to the top level</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="unitFloat"></a><span class='hs-definition'>unitFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatingBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span>
<a name="line-75"></a><span class='hs-definition'>unitFloat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addFloat</span> <span class='hs-varid'>emptyFloats</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="appendFloats"></a><span class='hs-definition'>appendFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span>
<a name="line-78"></a><span class='hs-definition'>appendFloats</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>spec1</span> <span class='hs-varid'>floats1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>spec2</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>)</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Floats</span> <span class='hs-layout'>(</span><span class='hs-varid'>combine</span> <span class='hs-varid'>spec1</span> <span class='hs-varid'>spec2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>floats1</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>floats2</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="concatFloats"></a><span class='hs-definition'>concatFloats</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Floats</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span>
<a name="line-82"></a><span class='hs-definition'>concatFloats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bs1</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>appOL</span> <span class='hs-varid'>bs1</span> <span class='hs-varid'>bs2</span><span class='hs-layout'>)</span> <span class='hs-varid'>nilOL</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="combine"></a><span class='hs-definition'>combine</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-85"></a><span class='hs-definition'>combine</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotOkToSpec</span>
<a name="line-86"></a><span class='hs-definition'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotOkToSpec</span>
<a name="line-87"></a><span class='hs-definition'>combine</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfUnboxedOk</span>
<a name="line-88"></a><span class='hs-definition'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfUnboxedOk</span>
<a name="line-89"></a><span class='hs-definition'>combine</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OkToSpec</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="deFloatTop"></a><span class='hs-definition'>deFloatTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-92"></a><span class='hs-comment'>-- For top level only; we don't expect any FloatCases</span>
<a name="line-93"></a><span class='hs-definition'>deFloatTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>floats</span><span class='hs-layout'>)</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrOL</span> <span class='hs-varid'>get</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>floats</span>
<a name="line-95"></a>  <span class='hs-keyword'>where</span>
<a name="line-96"></a>    <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occurAnalyseRHSs</span> <span class='hs-varid'>b</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bs</span>
<a name="line-97"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>b</span>            <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"corePrepPgm"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-98"></a>
<a name="line-99"></a>    <span class='hs-comment'>-- See Note [Dead code in CorePrep]</span>
<a name="line-100"></a>    <span class='hs-varid'>occurAnalyseRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurAnalyseExpr_NoBinderSwap</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-101"></a>    <span class='hs-varid'>occurAnalyseRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>xes</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rec</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>occurAnalyseExpr_NoBinderSwap</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xes</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-comment'>---------------------------------------------------------------------------</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="canFloatFromNoCaf"></a><span class='hs-definition'>canFloatFromNoCaf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span><span class='hs-layout'>,</span> <span class='hs-conid'>CpeRhs</span><span class='hs-layout'>)</span>
<a name="line-106"></a>       <span class='hs-comment'>-- Note [CafInfo and floating]</span>
<a name="line-107"></a><span class='hs-definition'>canFloatFromNoCaf</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-varid'>ok_to_spec</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ok_to_spec</span>           <span class='hs-comment'>-- Worth trying</span>
<a name="line-109"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptySubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>nilOL</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-varid'>fs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-113"></a>  <span class='hs-keyword'>where</span>
<a name="line-114"></a>    <span class='hs-varid'>subst_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CorePrep"</span><span class='hs-layout'>)</span>
<a name="line-115"></a>
<a name="line-116"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FloatingBind</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>FloatingBind</span><span class='hs-layout'>)</span>
<a name="line-118"></a>
<a name="line-119"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span>
<a name="line-120"></a>
<a name="line-121"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fbs_in</span><span class='hs-layout'>)</span>
<a name="line-122"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rhs_ok</span> <span class='hs-varid'>r</span>
<a name="line-123"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>new_fb</span><span class='hs-layout'>)</span> <span class='hs-varid'>fbs_in</span>
<a name="line-124"></a>      <span class='hs-keyword'>where</span>
<a name="line-125"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>set_nocaf_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>b</span>
<a name="line-126"></a>        <span class='hs-varid'>new_fb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-127"></a>
<a name="line-128"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fbs_in</span><span class='hs-layout'>)</span>
<a name="line-129"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>rhs_ok</span> <span class='hs-varid'>rs</span>
<a name="line-130"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fbs_out</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>new_fb</span><span class='hs-layout'>)</span> <span class='hs-varid'>fbs_in</span>
<a name="line-131"></a>      <span class='hs-keyword'>where</span>
<a name="line-132"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>prs</span>
<a name="line-133"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>set_nocaf_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bs</span>
<a name="line-134"></a>        <span class='hs-varid'>rs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_expr</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>rs</span>
<a name="line-135"></a>        <span class='hs-varid'>new_fb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs'</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>      <span class='hs-comment'>-- Encountered a caffy binding</span>
<a name="line-138"></a>
<a name="line-139"></a>    <span class='hs-comment'>------------</span>
<a name="line-140"></a>    <span class='hs-varid'>set_nocaf_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span>
<a name="line-141"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span>
<a name="line-142"></a>      <span class='hs-keyword'>where</span>
<a name="line-143"></a>        <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdCafInfo`</span> <span class='hs-conid'>NoCafRefs</span>
<a name="line-144"></a>
<a name="line-145"></a>    <span class='hs-comment'>------------</span>
<a name="line-146"></a>    <span class='hs-varid'>rhs_ok</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-147"></a>    <span class='hs-comment'>-- We can only float to top level from a NoCaf thing if</span>
<a name="line-148"></a>    <span class='hs-comment'>-- the new binding is static. However it can't mention</span>
<a name="line-149"></a>    <span class='hs-comment'>-- any non-static things or it would *already* be Caffy</span>
<a name="line-150"></a>    <span class='hs-varid'>rhs_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhsIsStatic</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="wantFloatNested"></a><span class='hs-definition'>wantFloatNested</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CpeRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-153"></a><span class='hs-definition'>wantFloatNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>strict_or_unlifted</span> <span class='hs-varid'>floats</span> <span class='hs-varid'>rhs</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isEmptyFloats</span> <span class='hs-varid'>floats</span>
<a name="line-155"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>strict_or_unlifted</span>
<a name="line-156"></a>  <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>allLazyNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-varid'>floats</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-157"></a>        <span class='hs-comment'>-- Why the test for allLazyNested?</span>
<a name="line-158"></a>        <span class='hs-comment'>--      v = f (x `divInt#` y)</span>
<a name="line-159"></a>        <span class='hs-comment'>-- we don't want to float the case, even if f has arity 2,</span>
<a name="line-160"></a>        <span class='hs-comment'>-- because floating the case would make it evaluated too early</span>
<a name="line-161"></a>
<a name="line-162"></a><a name="allLazyTop"></a><span class='hs-definition'>allLazyTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-163"></a><span class='hs-definition'>allLazyTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-164"></a><span class='hs-definition'>allLazyTop</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="allLazyNested"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Floats</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-167"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-keyword'>_</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>OkToSpec</span>    <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-168"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-keyword'>_</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>NotOkToSpec</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-169"></a><span class='hs-definition'>allLazyNested</span> <span class='hs-varid'>is_rec</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floats</span> <span class='hs-conid'>IfUnboxedOk</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNonRec</span> <span class='hs-varid'>is_rec</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Cloning
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>--                      The environment</span>
<a name="line-3"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="CorePrepEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CPE</span> <span class='hs-layout'>{</span>
<a name="line-6"></a>                       <span class='hs-varid'>cpe_dynFlags</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span><span class='hs-layout'>,</span>
<a name="line-7"></a>                       <span class='hs-varid'>cpe_env</span>         <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdEnv</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Clone local Ids</span>
<a name="line-8"></a>                       <span class='hs-varid'>cpe_mkIntegerId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-9"></a>                   <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="lookupMkIntegerName"></a><span class='hs-definition'>lookupMkIntegerName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Id</span>
<a name="line-12"></a><span class='hs-definition'>lookupMkIntegerName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-13"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>primPackageId</span>
<a name="line-14"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Can't use Integer in ghc-prim"</span>
<a name="line-15"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>integerPackageId</span>
<a name="line-16"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Can't use Integer in integer"</span>
<a name="line-17"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>tyThingId</span>
<a name="line-18"></a>         <span class='hs-varop'>$</span> <span class='hs-varid'>initTcForLookup</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLookupGlobal</span> <span class='hs-varid'>mkIntegerName</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="mkInitialCorePrepEnv"></a><span class='hs-definition'>mkInitialCorePrepEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-21"></a><span class='hs-definition'>mkInitialCorePrepEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-22"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mkIntegerId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupMkIntegerName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-23"></a>         <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CPE</span> <span class='hs-layout'>{</span>
<a name="line-24"></a>                      <span class='hs-varid'>cpe_dynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>,</span>
<a name="line-25"></a>                      <span class='hs-varid'>cpe_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>,</span>
<a name="line-26"></a>                      <span class='hs-varid'>cpe_mkIntegerId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIntegerId</span>
<a name="line-27"></a>                  <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="extendCorePrepEnv"></a><span class='hs-definition'>extendCorePrepEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-30"></a><span class='hs-definition'>extendCorePrepEnv</span> <span class='hs-varid'>cpe</span> <span class='hs-varid'>id</span> <span class='hs-varid'>id'</span>
<a name="line-31"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cpe_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_env</span> <span class='hs-varid'>cpe</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-varid'>id'</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="extendCorePrepEnvList"></a><span class='hs-definition'>extendCorePrepEnvList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CorePrepEnv</span>
<a name="line-34"></a><span class='hs-definition'>extendCorePrepEnvList</span> <span class='hs-varid'>cpe</span> <span class='hs-varid'>prs</span>
<a name="line-35"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cpe_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_env</span> <span class='hs-varid'>cpe</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="lookupCorePrepEnv"></a><span class='hs-definition'>lookupCorePrepEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-38"></a><span class='hs-definition'>lookupCorePrepEnv</span> <span class='hs-varid'>cpe</span> <span class='hs-varid'>id</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpe_env</span> <span class='hs-varid'>cpe</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span>
<a name="line-41"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>id'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id'</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="getMkIntegerId"></a><span class='hs-definition'>getMkIntegerId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-44"></a><span class='hs-definition'>getMkIntegerId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cpe_mkIntegerId</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-47"></a><span class='hs-comment'>-- Cloning binders</span>
<a name="line-48"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="cpCloneBndrs"></a><span class='hs-definition'>cpCloneBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-definition'>cpCloneBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="cpCloneBndr"></a><span class='hs-definition'>cpCloneBndr</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CorePrepEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-definition'>cpCloneBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLocalId</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoVar</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setVarUnique</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getUniqueM</span>
<a name="line-57"></a>
<a name="line-58"></a>       <span class='hs-comment'>-- We are going to OccAnal soon, so drop (now-useless) rules/unfoldings</span>
<a name="line-59"></a>       <span class='hs-comment'>-- so that we can drop more stuff as dead code.</span>
<a name="line-60"></a>       <span class='hs-comment'>-- See also Note [Dead code in CorePrep]</span>
<a name="line-61"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>bndr''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr'</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-62"></a>                          <span class='hs-varop'>`setIdSpecialisation`</span> <span class='hs-varid'>emptySpecInfo</span>
<a name="line-63"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCorePrepEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr''</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr''</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Top level things, which we don't want</span>
<a name="line-66"></a>                <span class='hs-comment'>-- to clone, have become GlobalIds by now</span>
<a name="line-67"></a>                <span class='hs-comment'>-- And we don't clone tyvars, or coercion variables</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-72"></a><span class='hs-comment'>-- Cloning ccall Ids; each must have a unique name,</span>
<a name="line-73"></a><span class='hs-comment'>-- to give the code generator a handle to hang it on</span>
<a name="line-74"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="fiddleCCall"></a><span class='hs-definition'>fiddleCCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>Id</span>
<a name="line-77"></a><span class='hs-definition'>fiddleCCall</span> <span class='hs-varid'>id</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFCallId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span> <span class='hs-varop'>`setVarUnique`</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getUniqueM</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-82"></a><span class='hs-comment'>-- Generating new binders</span>
<a name="line-83"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="newVar"></a><span class='hs-definition'>newVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSM</span> <span class='hs-conid'>Id</span>
<a name="line-86"></a><span class='hs-definition'>newVar</span> <span class='hs-varid'>ty</span>
<a name="line-87"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`seq`</span> <span class='hs-keyword'>do</span>
<a name="line-88"></a>     <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUniqueM</span>
<a name="line-89"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSysLocal</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"sat"</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
