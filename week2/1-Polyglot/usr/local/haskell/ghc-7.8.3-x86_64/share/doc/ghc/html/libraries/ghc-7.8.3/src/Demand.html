<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>basicTypes/Demand.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[Demand]{@Demand@: A decoupled implementation of a demand domain}

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Demand</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>        <span class='hs-conid'>StrDmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>UseDmd</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Count</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-4"></a>        <span class='hs-varid'>countOnce</span><span class='hs-layout'>,</span> <span class='hs-varid'>countMany</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- cardinality</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-conid'>Demand</span><span class='hs-layout'>,</span> <span class='hs-conid'>CleanDemand</span><span class='hs-layout'>,</span> 
<a name="line-7"></a>        <span class='hs-varid'>mkProdDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOnceUsedDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkManyUsedDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHeadStrict</span><span class='hs-layout'>,</span> <span class='hs-varid'>oneifyDmd</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-varid'>getUsage</span><span class='hs-layout'>,</span> <span class='hs-varid'>toCleanDmd</span><span class='hs-layout'>,</span> 
<a name="line-9"></a>        <span class='hs-varid'>absDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>topDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDmd</span><span class='hs-layout'>,</span>
<a name="line-10"></a>        <span class='hs-varid'>lubDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>bothDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>apply1Dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>apply2Dmd</span><span class='hs-layout'>,</span> 
<a name="line-11"></a>        <span class='hs-varid'>isTopDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBotDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAbsDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSeqDmd</span><span class='hs-layout'>,</span> 
<a name="line-12"></a>        <span class='hs-varid'>peelUseCall</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanUseDmd_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>strictenDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>bothCleanDmd</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-conid'>DmdType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTypeDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>lubDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>bothDmdType</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>nopDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDmdType</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>addDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>removeDmdTyArgs</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-conid'>BothDmdArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkBothDmdArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>toBothDmdArg</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDmdEnv</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>peelFV</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-conid'>DmdResult</span><span class='hs-layout'>,</span> <span class='hs-conid'>CPRResult</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>isBotRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTopRes</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>topRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>botRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>cprProdRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>vanillaCprProdRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>cprSumRes</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>appIsBottom</span><span class='hs-layout'>,</span> <span class='hs-varid'>isBottomingSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprIfaceStrictSig</span><span class='hs-layout'>,</span> 
<a name="line-26"></a>        <span class='hs-varid'>trimCPRInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>returnsCPR_maybe</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-conid'>StrictSig</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStrictSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkClosedStrictSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>nopSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>botSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>cprProdSig</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>isNopSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitStrictSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>increaseStrictSigArity</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>        <span class='hs-varid'>seqDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDemandList</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqStrictSig</span><span class='hs-layout'>,</span> 
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-varid'>evalDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanEvalDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanEvalProdDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrictDmd</span><span class='hs-layout'>,</span> 
<a name="line-33"></a>        <span class='hs-varid'>splitDmdTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitFVs</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>deferAfterIO</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>postProcessUnsat</span><span class='hs-layout'>,</span> <span class='hs-varid'>postProcessDmdTypeM</span><span class='hs-layout'>,</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-varid'>splitProdDmd_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>peelCallDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCallDmd</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>dmdTransformSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTransformDataConSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdTransformDictSelSig</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>argOneShots</span><span class='hs-layout'>,</span> <span class='hs-varid'>argsOneShots</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>        <span class='hs-varid'>isSingleUsed</span><span class='hs-layout'>,</span> <span class='hs-varid'>reuseEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapDemand</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapStrictSig</span><span class='hs-layout'>,</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-varid'>strictifyDictDmd</span>
<a name="line-44"></a>
<a name="line-45"></a>     <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Binary</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>            <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>isNewTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>splitDataProductType_maybe</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Strictness domain}
%*                                                                      *
%************************************************************************

        Lazy
         |
      HeadStr
      /     \
  SCall      SProd
      \      /
      HyperStr

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="StrDmd"></a><span class='hs-comment'>-- Vanilla strictness domain</span>
<a name="line-3"></a><a name="StrDmd"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StrDmd</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>             <span class='hs-comment'>-- Hyper-strict </span>
<a name="line-5"></a>                         <span class='hs-comment'>-- Bottom of the lattice</span>
<a name="line-6"></a>                         <span class='hs-comment'>-- Note [HyperStr and Use demands]</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SCall</span> <span class='hs-conid'>StrDmd</span>         <span class='hs-comment'>-- Call demand</span>
<a name="line-9"></a>                         <span class='hs-comment'>-- Used only for values of function type</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SProd</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Product</span>
<a name="line-12"></a>                         <span class='hs-comment'>-- Used only for values of product type</span>
<a name="line-13"></a>                         <span class='hs-comment'>-- Invariant: not all components are HyperStr (use HyperStr)</span>
<a name="line-14"></a>                         <span class='hs-comment'>--            not all components are Lazy     (use HeadStr)</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HeadStr</span>              <span class='hs-comment'>-- Head-Strict</span>
<a name="line-17"></a>                         <span class='hs-comment'>-- A polymorphic demand: used for values of all types,</span>
<a name="line-18"></a>                         <span class='hs-comment'>--                       including a type variable</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="MaybeStr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>            <span class='hs-comment'>-- Lazy</span>
<a name="line-23"></a>                                <span class='hs-comment'>-- Top of the lattice</span>
<a name="line-24"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Str</span> <span class='hs-conid'>StrDmd</span>
<a name="line-25"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="strBot"></a><span class='hs-comment'>-- Well-formedness preserving constructors for the Strictness domain</span>
<a name="line-28"></a><span class='hs-definition'>strBot</span><span class='hs-layout'>,</span> <span class='hs-varid'>strTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span>
<a name="line-29"></a><span class='hs-definition'>strBot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-conid'>HyperStr</span>
<a name="line-30"></a><a name="strTop"></a><span class='hs-definition'>strTop</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="mkSCall"></a><span class='hs-definition'>mkSCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-33"></a><span class='hs-definition'>mkSCall</span> <span class='hs-conid'>HyperStr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-34"></a><span class='hs-definition'>mkSCall</span> <span class='hs-varid'>s</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="mkSProd"></a><span class='hs-definition'>mkSProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-37"></a><span class='hs-definition'>mkSProd</span> <span class='hs-varid'>sx</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isHyperStr</span> <span class='hs-varid'>sx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isLazy</span>     <span class='hs-varid'>sx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="isLazy"></a><span class='hs-definition'>isLazy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-43"></a><span class='hs-definition'>isLazy</span> <span class='hs-conid'>Lazy</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-44"></a><span class='hs-definition'>isLazy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="isHyperStr"></a><span class='hs-definition'>isHyperStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-47"></a><span class='hs-definition'>isHyperStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HyperStr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-48"></a><span class='hs-definition'>isHyperStr</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-comment'>-- Pretty-printing</span>
<a name="line-51"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyword'>where</span>
<a name="line-52"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HyperStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'B'</span>
<a name="line-53"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'C'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HeadStr</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'S'</span>
<a name="line-55"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'S'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyword'>where</span>
<a name="line-58"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span>
<a name="line-59"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Lazy</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'L'</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="lubMaybeStr"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span>
<a name="line-62"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-conid'>Lazy</span>     <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>
<a name="line-63"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>Lazy</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span>
<a name="line-64"></a><span class='hs-definition'>lubMaybeStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`lubStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="lubStr"></a><span class='hs-definition'>lubStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-67"></a><span class='hs-definition'>lubStr</span> <span class='hs-conid'>HyperStr</span> <span class='hs-varid'>s</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-68"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-conid'>HyperStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span>
<a name="line-69"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HeadStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-70"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`lubStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-72"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span> <span class='hs-conid'>HyperStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span>
<a name="line-73"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HeadStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-74"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-75"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>lubMaybeStr</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-76"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-77"></a><span class='hs-definition'>lubStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-78"></a><span class='hs-definition'>lubStr</span> <span class='hs-conid'>HeadStr</span>   <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="bothMaybeStr"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeStr</span>
<a name="line-81"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-conid'>Lazy</span>     <span class='hs-varid'>s</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-82"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-varid'>s</span>        <span class='hs-conid'>Lazy</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> 
<a name="line-83"></a><span class='hs-definition'>bothMaybeStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`bothStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="bothStr"></a><span class='hs-definition'>bothStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span>
<a name="line-86"></a><span class='hs-definition'>bothStr</span> <span class='hs-conid'>HyperStr</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-87"></a><span class='hs-definition'>bothStr</span> <span class='hs-conid'>HeadStr</span> <span class='hs-varid'>s</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-88"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HyperStr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-89"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-conid'>HeadStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span>
<a name="line-90"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`bothStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-91"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>  <span class='hs-comment'>-- Weird</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>HyperStr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-94"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-conid'>HeadStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span>
<a name="line-95"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> 
<a name="line-96"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>bothMaybeStr</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-97"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>  <span class='hs-comment'>-- Weird</span>
<a name="line-98"></a><span class='hs-definition'>bothStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="seqStrDmd"></a><span class='hs-comment'>-- utility functions to deal with memory leaks</span>
<a name="line-101"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-102"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqStrDmdList</span> <span class='hs-varid'>ds</span>
<a name="line-103"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span> 
<a name="line-104"></a><span class='hs-definition'>seqStrDmd</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="seqStrDmdList"></a><span class='hs-definition'>seqStrDmdList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-107"></a><span class='hs-definition'>seqStrDmdList</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-108"></a><span class='hs-definition'>seqStrDmdList</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeStr</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqStrDmdList</span> <span class='hs-varid'>ds</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="seqMaybeStr"></a><span class='hs-definition'>seqMaybeStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-111"></a><span class='hs-definition'>seqMaybeStr</span> <span class='hs-conid'>Lazy</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-112"></a><span class='hs-definition'>seqMaybeStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqStrDmd</span> <span class='hs-varid'>s</span>
<a name="line-113"></a>
<a name="line-114"></a><a name="splitStrProdDmd"></a><span class='hs-comment'>-- Splitting polymorphic demands</span>
<a name="line-115"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span>
<a name="line-116"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>HyperStr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>strBot</span><span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>HeadStr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>strTop</span><span class='hs-layout'>)</span>
<a name="line-118"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ds</span>
<a name="line-119"></a><span class='hs-definition'>splitStrProdDmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-120"></a>      <span class='hs-comment'>-- This can happen when the programmer uses unsafeCoerce,</span>
<a name="line-121"></a>      <span class='hs-comment'>-- and we don't then want to crash the compiler (Trac #9208)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Absence domain}
%*                                                                      *
%************************************************************************

      Used
      /   \
  UCall   UProd
      \   /
      UHead
       |
      Abs

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="UseDmd"></a><span class='hs-comment'>-- Domain for genuine usage</span>
<a name="line-3"></a><a name="UseDmd"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UseDmd</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-conid'>Count</span> <span class='hs-conid'>UseDmd</span>   <span class='hs-comment'>-- Call demand for absence</span>
<a name="line-5"></a>                         <span class='hs-comment'>-- Used only for values of function type</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UProd</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Product </span>
<a name="line-8"></a>                         <span class='hs-comment'>-- Used only for values of product type</span>
<a name="line-9"></a>                         <span class='hs-comment'>-- See Note [Don't optimise UProd(Used) to Used]</span>
<a name="line-10"></a>                         <span class='hs-comment'>-- [Invariant] Not all components are Abs</span>
<a name="line-11"></a>                         <span class='hs-comment'>--             (in that case, use UHead)</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UHead</span>                <span class='hs-comment'>-- May be used; but its sub-components are </span>
<a name="line-14"></a>                         <span class='hs-comment'>-- definitely *not* used.  Roughly U(AAA)</span>
<a name="line-15"></a>                         <span class='hs-comment'>-- Eg the usage of x in x `seq` e</span>
<a name="line-16"></a>                         <span class='hs-comment'>-- A polymorphic demand: used for values of all types,</span>
<a name="line-17"></a>                         <span class='hs-comment'>--                       including a type variable</span>
<a name="line-18"></a>                         <span class='hs-comment'>-- Since (UCall _ Abs) is ill-typed, UHead doesn't</span>
<a name="line-19"></a>                         <span class='hs-comment'>-- make sense for lambdas</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Used</span>                 <span class='hs-comment'>-- May be used; and its sub-components may be used</span>
<a name="line-22"></a>                         <span class='hs-comment'>-- Top of the lattice</span>
<a name="line-23"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="MaybeUsed"></a><span class='hs-comment'>-- Extended usage demand for absence and counting</span>
<a name="line-26"></a><a name="MaybeUsed"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>                  <span class='hs-comment'>-- Definitely unused</span>
<a name="line-28"></a>                         <span class='hs-comment'>-- Bottom of the lattice</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Count</span> <span class='hs-conid'>UseDmd</span>     <span class='hs-comment'>-- May be used with some cardinality </span>
<a name="line-31"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="Count"></a><span class='hs-comment'>-- Abstract counting of usages</span>
<a name="line-34"></a><a name="Count"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>One</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Many</span>
<a name="line-35"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>     
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-comment'>-- Pretty-printing</span>
<a name="line-38"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyword'>where</span>
<a name="line-39"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Abs</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'A'</span>
<a name="line-40"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span> 
<a name="line-41"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span>  <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'1'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'*'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyword'>where</span>
<a name="line-44"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Used</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'U'</span>
<a name="line-45"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'C'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>UHead</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'H'</span>
<a name="line-47"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'U'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>','</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Count</span> <span class='hs-keyword'>where</span>
<a name="line-50"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>One</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'1'</span>
<a name="line-51"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>""</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="countOnce"></a><span class='hs-comment'>-- Well-formedness preserving constructors for the Absence domain</span>
<a name="line-54"></a><span class='hs-definition'>countOnce</span><span class='hs-layout'>,</span> <span class='hs-varid'>countMany</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Count</span>
<a name="line-55"></a><span class='hs-definition'>countOnce</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>One</span>
<a name="line-56"></a><a name="countMany"></a><span class='hs-definition'>countMany</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="useBot"></a><span class='hs-definition'>useBot</span><span class='hs-layout'>,</span> <span class='hs-varid'>useTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-59"></a><span class='hs-definition'>useBot</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-60"></a><a name="useTop"></a><span class='hs-definition'>useTop</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-conid'>Used</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="mkUCall"></a><span class='hs-definition'>mkUCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-63"></a><span class='hs-comment'>--mkUCall c Used = Used c </span>
<a name="line-64"></a><span class='hs-definition'>mkUCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>a</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="mkUProd"></a><span class='hs-definition'>mkUProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-67"></a><span class='hs-definition'>mkUProd</span> <span class='hs-varid'>ux</span> 
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UHead</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="lubCount"></a><span class='hs-definition'>lubCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span>
<a name="line-72"></a><span class='hs-definition'>lubCount</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-73"></a><span class='hs-definition'>lubCount</span> <span class='hs-conid'>Many</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-74"></a><span class='hs-definition'>lubCount</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> 
<a name="line-75"></a>
<a name="line-76"></a><a name="lubMaybeUsed"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-77"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-conid'>Abs</span> <span class='hs-varid'>x</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-78"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-varid'>x</span> <span class='hs-conid'>Abs</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-79"></a><span class='hs-definition'>lubMaybeUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCount</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubUse</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="lubUse"></a><span class='hs-definition'>lubUse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-82"></a><span class='hs-definition'>lubUse</span> <span class='hs-conid'>UHead</span>       <span class='hs-varid'>u</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-83"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span>
<a name="line-84"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubCount</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lubUse</span> <span class='hs-varid'>u1</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-86"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span> 
<a name="line-87"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux2</span><span class='hs-layout'>)</span>
<a name="line-88"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>lubMaybeUsed</span> <span class='hs-varid'>ux1</span> <span class='hs-varid'>ux2</span>
<a name="line-89"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-90"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-91"></a><span class='hs-comment'>-- lubUse (UProd {}) Used             = Used</span>
<a name="line-92"></a><span class='hs-definition'>lubUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>Used</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lubMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-definition'>lubUse</span> <span class='hs-conid'>Used</span>       <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lubMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-94"></a><span class='hs-definition'>lubUse</span> <span class='hs-conid'>Used</span> <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>  <span class='hs-comment'>-- Note [Used should win]</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-comment'>-- `both` is different from `lub` in its treatment of counting; if</span>
<a name="line-97"></a><span class='hs-comment'>-- `both` is computed for two used, the result always has</span>
<a name="line-98"></a><span class='hs-comment'>--  cardinality `Many` (except for the inner demands of UCall demand -- [TODO] explain).  </span>
<a name="line-99"></a><span class='hs-comment'>--  Also,  x `bothUse` x /= x (for anything but Abs).</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="bothMaybeUsed"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-102"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-conid'>Abs</span> <span class='hs-varid'>x</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-103"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-varid'>x</span> <span class='hs-conid'>Abs</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-104"></a><span class='hs-definition'>bothMaybeUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-varid'>bothUse</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-105"></a>
<a name="line-106"></a>
<a name="line-107"></a><a name="bothUse"></a><span class='hs-definition'>bothUse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-108"></a><span class='hs-definition'>bothUse</span> <span class='hs-conid'>UHead</span>       <span class='hs-varid'>u</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-109"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span>
<a name="line-110"></a>
<a name="line-111"></a><span class='hs-comment'>-- Exciting special treatment of inner demand for call demands: </span>
<a name="line-112"></a><span class='hs-comment'>--    use `lubUse` instead of `bothUse`!</span>
<a name="line-113"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-varid'>u1</span> <span class='hs-varop'>`lubUse`</span> <span class='hs-varid'>u2</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-116"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>UHead</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span> 
<a name="line-117"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux2</span><span class='hs-layout'>)</span>
<a name="line-118"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ux2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>bothMaybeUsed</span> <span class='hs-varid'>ux1</span> <span class='hs-varid'>ux2</span>
<a name="line-119"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-120"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>
<a name="line-121"></a><span class='hs-comment'>-- bothUse (UProd {}) Used             = Used  -- Note [Used should win]</span>
<a name="line-122"></a><span class='hs-definition'>bothUse</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`bothMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-123"></a><span class='hs-definition'>bothUse</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>Used</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`bothMaybeUsed`</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-definition'>bothUse</span> <span class='hs-conid'>Used</span> <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span>  <span class='hs-comment'>-- Note [Used should win]</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="peelUseCall"></a><span class='hs-definition'>peelUseCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Count</span><span class='hs-layout'>,</span> <span class='hs-conid'>UseDmd</span><span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-definition'>peelUseCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-128"></a><span class='hs-definition'>peelUseCall</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

Note [Don't optimise UProd(Used) to Used]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
These two UseDmds:
   UProd [Used, Used]   and    Used
are semantically equivalent, but we do not turn the former into
the latter, for a regrettable-subtle reason.  Suppose we did.
then
  f (x,y) = (y,x)
would get 
  StrDmd = Str  = SProd [Lazy, Lazy]
  UseDmd = Used = UProd [Used, Used]
But with the joint demand of <Str, Used> doesn't convey any clue
that there is a product involved, and so the worthSplittingFun
will not fire.  (We'd need to use the type as well to make it fire.)
Moreover, consider
  g h p@(_,_) = h p
This too would get <Str, Used>, but this time there really isn't any
point in w/w since the components of the pair are not used at all.

So the solution is: don't aggressively collapse UProd [Used,Used] to
Used; intead leave it as-is. In effect we are using the UseDmd to do a
little bit of boxity analysis.  Not very nice.

Note [Used should win]
~~~~~~~~~~~~~~~~~~~~~~
Both in lubUse and bothUse we want (Used `both` UProd us) to be Used.
Why?  Because Used carries the implication the whole thing is used,
box and all, so we don't want to w/w it.  If we use it both boxed and
unboxed, then we are definitely using the box, and so we are quite 
likely to pay a reboxing cost.  So we make Used win here.

Example is in the Buffer argument of GHC.IO.Handle.Internals.writeCharBuffer

Baseline: (A) Not making Used win (UProd wins)
Compare with: (B) making Used win for lub and both

            Min          -0.3%     -5.6%    -10.7%    -11.0%    -33.3%
            Max          +0.3%    +45.6%    +11.5%    +11.5%     +6.9%
 Geometric Mean          -0.0%     +0.5%     +0.3%     +0.2%     -0.8%

Baseline: (B) Making Used win for both lub and both
Compare with: (C) making Used win for both, but UProd win for lub

            Min          -0.1%     -0.3%     -7.9%     -8.0%     -6.5%
            Max          +0.1%     +1.0%    +21.0%    +21.0%     +0.5%
 Geometric Mean          +0.0%     +0.0%     -0.0%     -0.1%     -0.1%


\begin{code}
<pre><a name="line-1"></a><a name="markReusedDmd"></a><span class='hs-comment'>-- If a demand is used multiple times (i.e. reused), than any use-once</span>
<a name="line-2"></a><span class='hs-comment'>-- mentioned there, that is not protected by a UCall, can happen many times.</span>
<a name="line-3"></a><span class='hs-definition'>markReusedDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-4"></a><span class='hs-definition'>markReusedDmd</span> <span class='hs-conid'>Abs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-5"></a><span class='hs-definition'>markReusedDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-varid'>markReused</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="markReused"></a><span class='hs-definition'>markReused</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-8"></a><span class='hs-definition'>markReused</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>u</span>   <span class='hs-comment'>-- No need to recurse here</span>
<a name="line-9"></a><span class='hs-definition'>markReused</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>markReusedDmd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>markReused</span> <span class='hs-varid'>u</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="isUsedMU"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-13"></a><span class='hs-comment'>-- True &lt;=&gt; markReusedDmd d = d</span>
<a name="line-14"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-conid'>Abs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-15"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-16"></a><span class='hs-definition'>isUsedMU</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUsedU</span> <span class='hs-varid'>u</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="isUsedU"></a><span class='hs-definition'>isUsedU</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-19"></a><span class='hs-comment'>-- True &lt;=&gt; markReused d = d</span>
<a name="line-20"></a><span class='hs-definition'>isUsedU</span> <span class='hs-conid'>Used</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-21"></a><span class='hs-definition'>isUsedU</span> <span class='hs-conid'>UHead</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-22"></a><span class='hs-definition'>isUsedU</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isUsedMU</span> <span class='hs-varid'>us</span>
<a name="line-23"></a><span class='hs-definition'>isUsedU</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-24"></a><span class='hs-definition'>isUsedU</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- No need to recurse</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="seqUseDmd"></a><span class='hs-comment'>-- Squashing usage demand demands</span>
<a name="line-27"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-28"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeUsedList</span> <span class='hs-varid'>ds</span>
<a name="line-29"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqUseDmd</span> <span class='hs-varid'>d</span>
<a name="line-30"></a><span class='hs-definition'>seqUseDmd</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="seqMaybeUsedList"></a><span class='hs-definition'>seqMaybeUsedList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-33"></a><span class='hs-definition'>seqMaybeUsedList</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-34"></a><span class='hs-definition'>seqMaybeUsedList</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeUsed</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqMaybeUsedList</span> <span class='hs-varid'>ds</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="seqMaybeUsed"></a><span class='hs-definition'>seqMaybeUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-37"></a><span class='hs-definition'>seqMaybeUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqUseDmd</span> <span class='hs-varid'>u</span>
<a name="line-38"></a><span class='hs-definition'>seqMaybeUsed</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="splitUseProdDmd"></a><span class='hs-comment'>-- Splitting polymorphic Maybe-Used demands</span>
<a name="line-41"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span>
<a name="line-42"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>Used</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-conid'>UHead</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"splitUseProdDmd"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ds</span> <span class='hs-layout'>)</span>
<a name="line-45"></a>                                  <span class='hs-conid'>Just</span> <span class='hs-varid'>ds</span>
<a name="line-46"></a><span class='hs-definition'>splitUseProdDmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}
  
%************************************************************************
%*                                                                      *
\subsection{Joint domain for Strictness and Absence}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="JointDmd"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-layout'>}</span> 
<a name="line-3"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>-- Pretty-printing</span>
<a name="line-6"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>','</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="mkJointDmd"></a><span class='hs-comment'>-- Well-formedness preserving constructors for the joint domain</span>
<a name="line-10"></a><span class='hs-definition'>mkJointDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-11"></a><span class='hs-definition'>mkJointDmd</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="mkJointDmds"></a><span class='hs-definition'>mkJointDmds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeStr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeUsed</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a><span class='hs-definition'>mkJointDmds</span> <span class='hs-varid'>ss</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"mkJointDmds"</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>ss</span> <span class='hs-keyword'>as</span>
<a name="line-15"></a>     
<a name="line-16"></a><a name="absDmd"></a><span class='hs-definition'>absDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-17"></a><span class='hs-definition'>absDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-conid'>Lazy</span> <span class='hs-conid'>Abs</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="apply1Dmd"></a><span class='hs-definition'>apply1Dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>apply2Dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span>
<a name="line-20"></a><span class='hs-comment'>-- C1(U), C1(C1(U)) respectively</span>
<a name="line-21"></a><span class='hs-definition'>apply1Dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-conid'>Used</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a><a name="apply2Dmd"></a><span class='hs-definition'>apply2Dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-conid'>Used</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="topDmd"></a><span class='hs-definition'>topDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-25"></a><span class='hs-definition'>topDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-conid'>Lazy</span> <span class='hs-varid'>useTop</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="seqDmd"></a><span class='hs-definition'>seqDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-28"></a><span class='hs-definition'>seqDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-conid'>UHead</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="botDmd"></a><span class='hs-definition'>botDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-31"></a><span class='hs-definition'>botDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>strBot</span> <span class='hs-varid'>useBot</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="lubDmd"></a><span class='hs-definition'>lubDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-34"></a><span class='hs-definition'>lubDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-35"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`lubMaybeStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span> <span class='hs-varop'>`lubMaybeUsed`</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="bothDmd"></a><span class='hs-definition'>bothDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-38"></a><span class='hs-definition'>bothDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-39"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span> <span class='hs-varop'>`bothMaybeStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span> <span class='hs-varop'>`bothMaybeUsed`</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="isTopDmd"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-42"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-conid'>Used</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-43"></a><span class='hs-definition'>isTopDmd</span> <span class='hs-keyword'>_</span>                                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> 
<a name="line-44"></a>
<a name="line-45"></a><a name="isBotDmd"></a><span class='hs-definition'>isBotDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-46"></a><span class='hs-definition'>isBotDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-47"></a><span class='hs-definition'>isBotDmd</span> <span class='hs-keyword'>_</span>                                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> 
<a name="line-48"></a>  
<a name="line-49"></a><a name="isAbsDmd"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-50"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- The strictness part can be HyperStr </span>
<a name="line-51"></a><span class='hs-definition'>isAbsDmd</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- for a bottom demand</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="isSeqDmd"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-54"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>UHead</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-55"></a><span class='hs-definition'>isSeqDmd</span> <span class='hs-keyword'>_</span>                                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="seqDemand"></a><span class='hs-comment'>-- More utility functions for strictness</span>
<a name="line-58"></a><span class='hs-definition'>seqDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-59"></a><span class='hs-definition'>seqDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>y</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqMaybeStr</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqMaybeUsed</span> <span class='hs-varid'>y</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="seqDemandList"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-62"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-63"></a><span class='hs-definition'>seqDemandList</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqDemand</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqDemandList</span> <span class='hs-varid'>ds</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="isStrictDmd"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-66"></a><span class='hs-comment'>-- See Note [Strict demands]</span>
<a name="line-67"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-68"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-69"></a><span class='hs-definition'>isStrictDmd</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="isWeakDmd"></a><span class='hs-definition'>isWeakDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-72"></a><span class='hs-definition'>isWeakDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLazy</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUsedMU</span> <span class='hs-varid'>a</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="cleanUseDmd_maybe"></a><span class='hs-definition'>cleanUseDmd_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>UseDmd</span>
<a name="line-75"></a><span class='hs-definition'>cleanUseDmd_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ud</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ud</span>
<a name="line-76"></a><span class='hs-definition'>cleanUseDmd_maybe</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="splitFVs"></a><span class='hs-definition'>splitFVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- Thunk</span>
<a name="line-79"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-definition'>splitFVs</span> <span class='hs-varid'>is_thunk</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_thunk</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionVarEnv</span> <span class='hs-varid'>isWeakDmd</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-83"></a>  <span class='hs-keyword'>where</span>
<a name="line-84"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>dmd</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fv</span><span class='hs-layout'>)</span>
<a name="line-85"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Lazy</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>lazy_fv</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_fv</span><span class='hs-layout'>)</span>
<a name="line-86"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>lazy_fv</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-87"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>sig_fv</span>  <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span>    <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Clean demand for Strictness and Usage}
%*                                                                      *
%************************************************************************

This domain differst from JointDemand in the sence that pure absence
is taken away, i.e., we deal *only* with non-absent demands.

Note [Strict demands]
~~~~~~~~~~~~~~~~~~~~~
isStrictDmd returns true only of demands that are 
   both strict
   and  used
In particular, it is False for <HyperStr, Abs>, which can and does
arise in, say (Trac #7319)
   f x = raise# <some exception>
Then 'x' is not used, so f gets strictness <HyperStr,Abs> -> .
Now the w/w generates
   fx = let x <HyperStr,Abs> = absentError "unused"
        in raise <some exception>
At this point we really don't want to convert to
   fx = case absentError "unused" of x -> raise <some exception>
Since the program is going to diverge, this swaps one error for another,
but it's really a bad idea to *ever* evaluate an absent argument.
In Trac #7319 we get
   T7319.exe: Oops!  Entered absent arg w_s1Hd{v} [lid] [base:GHC.Base.String{tc 36u}]

Note [Dealing with call demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Call demands are constructed and deconstructed coherently for
strictness and absence. For instance, the strictness signature for the
following function

f :: (Int -> (Int, Int)) -> (Int, Bool)
f g = (snd (g 3), True)

should be: <L,C(U(AU))>m


\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="CleanDemand"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UseDmd</span> <span class='hs-layout'>}</span> 
<a name="line-3"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="mkCleanDmd"></a><span class='hs-definition'>mkCleanDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-9"></a><span class='hs-definition'>mkCleanDmd</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="bothCleanDmd"></a><span class='hs-definition'>bothCleanDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-12"></a><span class='hs-definition'>bothCleanDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>`bothStr`</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>`bothUse`</span> <span class='hs-varid'>a2</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="mkHeadStrict"></a><span class='hs-definition'>mkHeadStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-16"></a><span class='hs-definition'>mkHeadStrict</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-conid'>HeadStr</span> <span class='hs-varid'>a</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="oneifyDmd"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-19"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-20"></a><span class='hs-definition'>oneifyDmd</span> <span class='hs-varid'>jd</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>jd</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="mkOnceUsedDmd"></a><span class='hs-definition'>mkOnceUsedDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkManyUsedDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-23"></a><span class='hs-definition'>mkOnceUsedDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-24"></a><a name="mkManyUsedDmd"></a><span class='hs-definition'>mkManyUsedDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="getUsage"></a><span class='hs-definition'>getUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-27"></a><span class='hs-definition'>getUsage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ud</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="evalDmd"></a><span class='hs-definition'>evalDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span>
<a name="line-30"></a><span class='hs-comment'>-- Evaluated strictly, and used arbitrarily deeply</span>
<a name="line-31"></a><span class='hs-definition'>evalDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>)</span> <span class='hs-varid'>useTop</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="mkProdDmd"></a><span class='hs-definition'>mkProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-34"></a><span class='hs-definition'>mkProdDmd</span> <span class='hs-varid'>dx</span> 
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>up</span> 
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>strd</span> <span class='hs-varid'>dx</span>
<a name="line-38"></a>    <span class='hs-varid'>up</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUProd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>absd</span> <span class='hs-varid'>dx</span>   
<a name="line-39"></a>
<a name="line-40"></a><a name="mkCallDmd"></a><span class='hs-definition'>mkCallDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-41"></a><span class='hs-definition'>mkCallDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSCall</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUCall</span> <span class='hs-conid'>One</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="cleanEvalDmd"></a><span class='hs-definition'>cleanEvalDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-45"></a><span class='hs-definition'>cleanEvalDmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-conid'>HeadStr</span> <span class='hs-conid'>Used</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="cleanEvalProdDmd"></a><span class='hs-definition'>cleanEvalProdDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-48"></a><span class='hs-definition'>cleanEvalProdDmd</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCleanDmd</span> <span class='hs-conid'>HeadStr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>useTop</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="isSingleUsed"></a><span class='hs-definition'>isSingleUsed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-51"></a><span class='hs-definition'>isSingleUsed</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_used_once</span> <span class='hs-varid'>a</span>
<a name="line-52"></a>  <span class='hs-keyword'>where</span>
<a name="line-53"></a>    <span class='hs-varid'>is_used_once</span> <span class='hs-conid'>Abs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-54"></a>    <span class='hs-varid'>is_used_once</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-conid'>One</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-55"></a>    <span class='hs-varid'>is_used_once</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [Threshold demands]
~~~~~~~~~~~~~~~~~~~~~~~~
Threshold usage demand is generated to figure out if
cardinality-instrumented demands of a binding's free variables should
be unleashed. See also [Aggregated demand for cardinality].

Note [Replicating polymorphic demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some demands can be considered as polymorphic. Generally, it is
applicable to such beasts as tops, bottoms as well as Head-Used adn
Head-stricts demands. For instance,

S ~ S(L, ..., L)

Also, when top or bottom is occurred as a result demand, it in fact
can be expanded to saturate a callee's arity. 


\begin{code}
<pre><a name="line-1"></a><a name="splitProdDmd_maybe"></a><span class='hs-definition'>splitProdDmd_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>JointDmd</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- Split a product into its components, iff there is any</span>
<a name="line-3"></a><span class='hs-comment'>-- useful information to be extracted thereby</span>
<a name="line-4"></a><span class='hs-comment'>-- The demand is not necessarily strict!</span>
<a name="line-5"></a><span class='hs-definition'>splitProdDmd_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ux</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitUseProdDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span> <span class='hs-varid'>u</span>
<a name="line-8"></a>                                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-varid'>sx</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-9"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sx</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitStrProdDmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-10"></a>                                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-varid'>sx</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-11"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span>           <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span> <span class='hs-conid'>Lazy</span><span class='hs-layout'>)</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-12"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                   Demand results
%*                                                                      *
%************************************************************************


DmdResult:     Dunno CPRResult
               /
        Diverges


CPRResult:         NoCPR
                   /    \
            RetProd    RetSum ConTag


Product contructors return (Dunno (RetProd rs))
In a fixpoint iteration, start from Diverges
We have lubs, but not glbs; but that is ok.


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- Constructed Product Result                                             </span>
<a name="line-3"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="Termination"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Termination</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>    <span class='hs-comment'>-- Definitely diverges</span>
<a name="line-6"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Dunno</span> <span class='hs-varid'>r</span>     <span class='hs-comment'>-- Might diverge or converge</span>
<a name="line-7"></a>               <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="DmdResult"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Termination</span> <span class='hs-conid'>CPRResult</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="CPRResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>          <span class='hs-comment'>-- Top of the lattice</span>
<a name="line-12"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RetProd</span>        <span class='hs-comment'>-- Returns a constructor from a product type</span>
<a name="line-13"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RetSum</span> <span class='hs-conid'>ConTag</span>  <span class='hs-comment'>-- Returns a constructor from a data type</span>
<a name="line-14"></a>               <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="lubCPR"></a><span class='hs-definition'>lubCPR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CPRResult</span>
<a name="line-17"></a><span class='hs-definition'>lubCPR</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> 
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>t2</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetSum</span> <span class='hs-varid'>t1</span>
<a name="line-19"></a><span class='hs-definition'>lubCPR</span> <span class='hs-conid'>RetProd</span>     <span class='hs-conid'>RetProd</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetProd</span>
<a name="line-20"></a><span class='hs-definition'>lubCPR</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="lubDmdResult"></a><span class='hs-definition'>lubDmdResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-23"></a><span class='hs-definition'>lubDmdResult</span> <span class='hs-conid'>Diverges</span>       <span class='hs-varid'>r</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-24"></a><span class='hs-definition'>lubDmdResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span>     <span class='hs-conid'>Diverges</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-varid'>c1</span>
<a name="line-25"></a><span class='hs-definition'>lubDmdResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span>     <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-layout'>(</span><span class='hs-varid'>c1</span> <span class='hs-varop'>`lubCPR`</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-comment'>-- This needs to commute with defaultDmd, i.e.</span>
<a name="line-27"></a><span class='hs-comment'>-- defaultDmd (r1 `lubDmdResult` r2) = defaultDmd r1 `lubDmd` defaultDmd r2</span>
<a name="line-28"></a><span class='hs-comment'>-- (See Note [Default demand on free variables] for why)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="bothDmdResult"></a><span class='hs-definition'>bothDmdResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Termination</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-31"></a><span class='hs-comment'>-- See Note [Asymmetry of 'both' for DmdType and DmdResult]</span>
<a name="line-32"></a><span class='hs-definition'>bothDmdResult</span> <span class='hs-keyword'>_</span>              <span class='hs-conid'>Diverges</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-33"></a><span class='hs-definition'>bothDmdResult</span> <span class='hs-varid'>r</span>              <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-34"></a><span class='hs-comment'>-- This needs to commute with defaultDmd, i.e.</span>
<a name="line-35"></a><span class='hs-comment'>-- defaultDmd (r1 `bothDmdResult` r2) = defaultDmd r1 `bothDmd` defaultDmd r2</span>
<a name="line-36"></a><span class='hs-comment'>-- (See Note [Default demand on free variables] for why)</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyword'>where</span>
<a name="line-39"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Diverges</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'b'</span>
<a name="line-40"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyword'>where</span>
<a name="line-43"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoCPR</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-44"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'m'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-45"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RetProd</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'m'</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="seqDmdResult"></a><span class='hs-definition'>seqDmdResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-48"></a><span class='hs-definition'>seqDmdResult</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-49"></a><span class='hs-definition'>seqDmdResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCPRResult</span> <span class='hs-varid'>c</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="seqCPRResult"></a><span class='hs-definition'>seqCPRResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-52"></a><span class='hs-definition'>seqCPRResult</span> <span class='hs-conid'>NoCPR</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-53"></a><span class='hs-definition'>seqCPRResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-54"></a><span class='hs-definition'>seqCPRResult</span> <span class='hs-conid'>RetProd</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-55"></a>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-58"></a><span class='hs-comment'>-- Combined demand result                                             --</span>
<a name="line-59"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="topRes"></a><span class='hs-comment'>-- [cprRes] lets us switch off CPR analysis</span>
<a name="line-62"></a><span class='hs-comment'>-- by making sure that everything uses TopRes</span>
<a name="line-63"></a><span class='hs-definition'>topRes</span><span class='hs-layout'>,</span> <span class='hs-varid'>botRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span>
<a name="line-64"></a><span class='hs-definition'>topRes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-conid'>NoCPR</span>
<a name="line-65"></a><a name="botRes"></a><span class='hs-definition'>botRes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="cprSumRes"></a><span class='hs-definition'>cprSumRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConTag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-68"></a><span class='hs-definition'>cprSumRes</span> <span class='hs-varid'>tag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_CprOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-69"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RetSum</span> <span class='hs-varid'>tag</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="cprProdRes"></a><span class='hs-definition'>cprProdRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DmdType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-72"></a><span class='hs-definition'>cprProdRes</span> <span class='hs-sel'>_arg_tys</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_CprOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RetProd</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="vanillaCprProdRes"></a><span class='hs-definition'>vanillaCprProdRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-77"></a><span class='hs-definition'>vanillaCprProdRes</span> <span class='hs-sel'>_arity</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_CprOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RetProd</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="isTopRes"></a><span class='hs-definition'>isTopRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-82"></a><span class='hs-definition'>isTopRes</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-conid'>NoCPR</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-83"></a><span class='hs-definition'>isTopRes</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="isBotRes"></a><span class='hs-definition'>isBotRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-86"></a><span class='hs-definition'>isBotRes</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-87"></a><span class='hs-definition'>isBotRes</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="trimCPRInfo"></a><span class='hs-definition'>trimCPRInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-90"></a><span class='hs-definition'>trimCPRInfo</span> <span class='hs-varid'>trim_all</span> <span class='hs-varid'>trim_sums</span> <span class='hs-varid'>res</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trimR</span> <span class='hs-varid'>res</span>
<a name="line-92"></a>  <span class='hs-keyword'>where</span>
<a name="line-93"></a>    <span class='hs-varid'>trimR</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-layout'>(</span><span class='hs-varid'>trimC</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-94"></a>    <span class='hs-varid'>trimR</span> <span class='hs-conid'>Diverges</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-varid'>trimC</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>trim_all</span> <span class='hs-varop'>||</span> <span class='hs-varid'>trim_sums</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>
<a name="line-97"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span>
<a name="line-98"></a>    <span class='hs-varid'>trimC</span> <span class='hs-conid'>RetProd</span>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>trim_all</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>
<a name="line-99"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetProd</span>
<a name="line-100"></a>    <span class='hs-varid'>trimC</span> <span class='hs-conid'>NoCPR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoCPR</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="returnsCPR_maybe"></a><span class='hs-definition'>returnsCPR_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ConTag</span>
<a name="line-103"></a><span class='hs-definition'>returnsCPR_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>retCPR_maybe</span> <span class='hs-varid'>c</span>
<a name="line-104"></a><span class='hs-definition'>returnsCPR_maybe</span> <span class='hs-conid'>Diverges</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="retCPR_maybe"></a><span class='hs-definition'>retCPR_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ConTag</span>
<a name="line-107"></a><span class='hs-definition'>retCPR_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t</span>
<a name="line-108"></a><span class='hs-definition'>retCPR_maybe</span> <span class='hs-conid'>RetProd</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>fIRST_TAG</span>
<a name="line-109"></a><span class='hs-definition'>retCPR_maybe</span> <span class='hs-conid'>NoCPR</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="defaultDmd"></a><span class='hs-comment'>-- See Notes [Default demand on free variables]</span>
<a name="line-112"></a><span class='hs-comment'>-- and [defaultDmd vs. resTypeArgDmd]</span>
<a name="line-113"></a><span class='hs-definition'>defaultDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Termination</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-114"></a><span class='hs-definition'>defaultDmd</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>botDmd</span>
<a name="line-115"></a><span class='hs-definition'>defaultDmd</span> <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>absDmd</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="resTypeArgDmd"></a><span class='hs-definition'>resTypeArgDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-118"></a><span class='hs-comment'>-- TopRes and BotRes are polymorphic, so that</span>
<a name="line-119"></a><span class='hs-comment'>--      BotRes === Bot -&gt; BotRes === ...</span>
<a name="line-120"></a><span class='hs-comment'>--      TopRes === Top -&gt; TopRes === ...</span>
<a name="line-121"></a><span class='hs-comment'>-- This function makes that concrete</span>
<a name="line-122"></a><span class='hs-comment'>-- Also see Note [defaultDmd vs. resTypeArgDmd]</span>
<a name="line-123"></a><span class='hs-definition'>resTypeArgDmd</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>botDmd</span>
<a name="line-124"></a><span class='hs-definition'>resTypeArgDmd</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topDmd</span>
</pre>\end{code}

Note [defaultDmd and resTypeArgDmd]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

These functions are similar: They express the demand on something not
explicitly mentioned in the environment resp. the argument list. Yet they are
different:
 * Variables not mentioned in the free variables environment are definitely
   unused, so we can use absDmd there.
 * Further arguments *can* be used, of course. Hence topDmd is used.

Note [Worthy functions for Worker-Wrapper split]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For non-bottoming functions a worker-wrapper transformation takes into
account several possibilities to decide if the function is worthy for
splitting:

1. The result is of product type and the function is strict in some
(or even all) of its arguments. The check that the argument is used is
more of sanity nature, since strictness implies usage. Example:

f :: (Int, Int) -> Int
f p = (case p of (a,b) -> a) + 1

should be splitted to

f :: (Int, Int) -> Int
f p = case p of (a,b) -> $wf a

$wf :: Int -> Int
$wf a = a + 1

2. Sometimes it also makes sense to perform a WW split if the
strictness analysis cannot say for sure if the function is strict in
components of its argument. Then we reason according to the inferred
usage information: if the function uses its product argument's
components, the WW split can be beneficial. Example:

g :: Bool -> (Int, Int) -> Int
g c p = case p of (a,b) ->
          if c then a else b

The function g is strict in is argument p and lazy in its
components. However, both components are used in the RHS. The idea is
since some of the components (both in this case) are used in the
right-hand side, the product must presumable be taken apart.

Therefore, the WW transform splits the function g to

g :: Bool -> (Int, Int) -> Int
g c p = case p of (a,b) -> $wg c a b

$wg :: Bool -> Int -> Int -> Int
$wg c a b = if c then a else b

3. If an argument is absent, it would be silly to pass it to a
function, hence the worker with reduced arity is generated.


Note [Worker-wrapper for bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used not to split if the result is bottom.
[Justification:  there's no efficiency to be gained.]

But it's sometimes bad not to make a wrapper.  Consider
        fw = \x# -> let x = I# x# in case e of
                                        p1 -> error_fn x
                                        p2 -> error_fn x
                                        p3 -> the real stuff
The re-boxing code won't go away unless error_fn gets a wrapper too.
[We don't do reboxing now, but in general it's better to pass an
unboxed thing to f, and have it reboxed in the error cases....]

However we *don't* want to do this when the argument is not actually
taken apart in the function at all.  Otherwise we risk decomposing a
masssive tuple which is barely used.  Example:

        f :: ((Int,Int) -> String) -> (Int,Int) -> a
        f g pr = error (g pr)

        main = print (f fst (1, error "no"))

Here, f does not take 'pr' apart, and it's stupid to do so.
Imagine that it had millions of fields. This actually happened
in GHC itself where the tuple was DynFlags


%************************************************************************
%*                                                                      *
\subsection{Demand environments and types}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Demand"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JointDmd</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="DmdEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Demand</span>   <span class='hs-comment'>-- See Note [Default demand on free variables]</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="DmdType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> 
<a name="line-6"></a>                  <span class='hs-conid'>DmdEnv</span>        <span class='hs-comment'>-- Demand on explicitly-mentioned </span>
<a name="line-7"></a>                                <span class='hs-comment'>--      free variables</span>
<a name="line-8"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Demand on arguments</span>
<a name="line-9"></a>                  <span class='hs-conid'>DmdResult</span>     <span class='hs-comment'>-- See [Nature of result demand]</span>
</pre>\end{code}

Note [Nature of result demand]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A DmdResult contains information about termination (currently distinguishing
definite divergence and no information; it is possible to include definite
convergence here), and CPR information about the result.

The semantics of this depends on whether we are looking at a DmdType, i.e. the
demand put on by an expression _under a specific incoming demand_ on its
environment, or at a StrictSig describing a demand transformer.

For a
 * DmdType, the termination information is true given the demand it was
   generated with, while for
 * a StrictSig it is olds after applying enough arguments.

The CPR information, though, is valid after the number of arguments mentioned
in the type is given. Therefore, when forgetting the demand on arguments, as in
dmdAnalRhs, this needs to be considere (via removeDmdTyArgs).

Consider
  b2 x y = x `seq` y `seq` error (show x)
this has a strictness signature of
  <S><S>b
meaning that "b2 `seq` ()" and "b2 1 `seq` ()" might well terminate, but
for "b2 1 2 `seq` ()" we get definite divergence.

For comparision,
  b1 x = x `seq` error (show x)
has a strictness signature of
  <S>b
and "b1 1 `seq` ()" is known to terminate.

Now consider a function h with signature "<C(S)>", and the expression
  e1 = h b1
now h puts a demand of <C(S)> onto its argument, and the demand transformer
turns it into
  <S>b
Now the DmdResult "b" does apply to us, even though "b1 `seq` ()" does not
diverge, and we do not anything being passed to b.

Note [Asymmetry of 'both' for DmdType and DmdResult]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'both' for DmdTypes is *assymetrical*, because there is only one
result!  For example, given (e1 e2), we get a DmdType dt1 for e1, use
its arg demand to analyse e2 giving dt2, and then do (dt1 `bothType` dt2).
Similarly with 
  case e of { p -> rhs }
we get dt_scrut from the scrutinee and dt_rhs from the RHS, and then
compute (dt_rhs `bothType` dt_scrut).

We
 1. combine the information on the free variables,
 2. take the demand on arguments from the first argument
 3. combine the termination results, but
 4. take CPR info from the first argument.

3 and 4 are implementd in bothDmdResult.


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- Equality needed for fixpoints in DmdAnal</span>
<a name="line-2"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-3"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>res1</span><span class='hs-layout'>)</span>
<a name="line-4"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>res2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>ufmToList</span> <span class='hs-varid'>fv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ufmToList</span> <span class='hs-varid'>fv2</span>
<a name="line-5"></a>                              <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ds1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ds2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>res1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>res2</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="lubDmdType"></a><span class='hs-definition'>lubDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-8"></a><span class='hs-definition'>lubDmdType</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>lub_fv</span> <span class='hs-varid'>lub_ds</span> <span class='hs-varid'>lub_res</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ensureArgs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>d1</span>
<a name="line-13"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ensureArgs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>d2</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-varid'>lub_fv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_CD</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>fv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultDmd</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultDmd</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-16"></a>    <span class='hs-varid'>lub_ds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"lubDmdType"</span> <span class='hs-varid'>lubDmd</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span>
<a name="line-17"></a>    <span class='hs-varid'>lub_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lubDmdResult</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span>
</pre>\end{code}

Note [The need for BothDmdArg]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Previously, the right argument to bothDmdType, as well as the return value of
dmdAnalStar via postProcessDmdTypeM, was a DmdType. But bothDmdType only needs
to know about the free variables and termination information, but nothing about
the demand put on arguments, nor cpr information. So we make that explicit by
only passing the relevant information.


\begin{code}
<pre><a name="line-1"></a><a name="BothDmdArg"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>BothDmdArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Termination</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="mkBothDmdArg"></a><span class='hs-definition'>mkBothDmdArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BothDmdArg</span>
<a name="line-4"></a><span class='hs-definition'>mkBothDmdArg</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>Dunno</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="toBothDmdArg"></a><span class='hs-definition'>toBothDmdArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BothDmdArg</span>
<a name="line-7"></a><span class='hs-definition'>toBothDmdArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>go</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>  <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-conid'>()</span>
<a name="line-10"></a>  <span class='hs-varid'>go</span> <span class='hs-conid'>Diverges</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="bothDmdType"></a><span class='hs-definition'>bothDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BothDmdArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-13"></a><span class='hs-definition'>bothDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-14"></a>    <span class='hs-comment'>-- See Note [Asymmetry of 'both' for DmdType and DmdResult]</span>
<a name="line-15"></a>    <span class='hs-comment'>-- 'both' takes the argument/result info from its *first* arg,</span>
<a name="line-16"></a>    <span class='hs-comment'>-- using its second arg just for its free-var info.</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>both_fv</span> <span class='hs-varid'>ds1</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`bothDmdResult`</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>both_fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_CD</span> <span class='hs-varid'>bothDmd</span> <span class='hs-varid'>fv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultDmd</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultDmd</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-21"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> 
<a name="line-22"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"DmdType"</span><span class='hs-layout'>,</span>
<a name="line-23"></a>            <span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span>
<a name="line-24"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fv_elts</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span>
<a name="line-25"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_elt</span> <span class='hs-varid'>fv_elts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a>    <span class='hs-keyword'>where</span>
<a name="line-27"></a>      <span class='hs-varid'>pp_elt</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>uniq</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-&gt;"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dmd</span>
<a name="line-28"></a>      <span class='hs-varid'>fv_elts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ufmToList</span> <span class='hs-varid'>fv</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="emptyDmdEnv"></a><span class='hs-definition'>emptyDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Demand</span>
<a name="line-31"></a><span class='hs-definition'>emptyDmdEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="nopDmdType"></a><span class='hs-comment'>-- nopDmdType is the demand of doing nothing</span>
<a name="line-34"></a><span class='hs-comment'>-- (lazy, absent, no CPR information, no termination information).</span>
<a name="line-35"></a><span class='hs-comment'>-- Note that it is ''not'' the top of the lattice (which would be "may use everything"),</span>
<a name="line-36"></a><span class='hs-comment'>-- so it is (no longer) called topDmd</span>
<a name="line-37"></a><span class='hs-definition'>nopDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>botDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span>
<a name="line-38"></a><span class='hs-definition'>nopDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>topRes</span>
<a name="line-39"></a><a name="botDmdType"></a><span class='hs-definition'>botDmdType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>botRes</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="cprProdDmdType"></a><span class='hs-definition'>cprProdDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-42"></a><span class='hs-definition'>cprProdDmdType</span> <span class='hs-sel'>_arity</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-conid'>RetProd</span><span class='hs-layout'>)</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="isNopDmdType"></a><span class='hs-definition'>isNopDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-46"></a><span class='hs-definition'>isNopDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopRes</span> <span class='hs-varid'>res</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-48"></a><span class='hs-definition'>isNopDmdType</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="mkDmdType"></a><span class='hs-definition'>mkDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-51"></a><span class='hs-definition'>mkDmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="dmdTypeDepth"></a><span class='hs-definition'>dmdTypeDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-54"></a><span class='hs-definition'>dmdTypeDepth</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ds</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="removeDmdTyArgs"></a><span class='hs-comment'>-- Remove any demand on arguments. This is used in dmdAnalRhs on the body</span>
<a name="line-57"></a><span class='hs-definition'>removeDmdTyArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-58"></a><span class='hs-definition'>removeDmdTyArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ensureArgs</span> <span class='hs-num'>0</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="ensureArgs"></a><span class='hs-comment'>-- This makes sure we can use the demand type with n arguments,</span>
<a name="line-61"></a><span class='hs-comment'>-- It extends the argument list with the correct resTypeArgDmd</span>
<a name="line-62"></a><span class='hs-comment'>-- It also adjusts the DmdResult: Divergence survives additional arguments,</span>
<a name="line-63"></a><span class='hs-comment'>-- CPR information does not (and definite converge also would not).</span>
<a name="line-64"></a><span class='hs-definition'>ensureArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-65"></a><span class='hs-definition'>ensureArgs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-66"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds'</span> <span class='hs-varid'>r'</span>
<a name="line-67"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>d</span>
<a name="line-68"></a>        <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-69"></a>
<a name="line-70"></a>        <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>take</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-layout'>(</span><span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a>        <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Diverges</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-72"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-73"></a>                <span class='hs-comment'>-- See [Nature of result demand]</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="seqDmdType"></a><span class='hs-definition'>seqDmdType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-76"></a><span class='hs-definition'>seqDmdType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-77"></a>  <span class='hs-comment'>{- ??? env `seq` -}</span> <span class='hs-varid'>seqDemandList</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqDmdResult</span> <span class='hs-varid'>res</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="splitDmdTy"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Demand</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdType</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-comment'>-- Split off one function argument</span>
<a name="line-81"></a><span class='hs-comment'>-- We already have a suitable demand on all</span>
<a name="line-82"></a><span class='hs-comment'>-- free vars, so no need to add more!</span>
<a name="line-83"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-conop'>:</span><span class='hs-varid'>dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="deferAfterIO"></a><span class='hs-comment'>-- When e is evaluated after executing an IO action, and d is e's demand, then</span>
<a name="line-87"></a><span class='hs-comment'>-- what of this demand should we consider, given that the IO action can cleanly</span>
<a name="line-88"></a><span class='hs-comment'>-- exit?</span>
<a name="line-89"></a><span class='hs-comment'>-- * We have to kill all strictness demands (i.e. lub with a lazy demand)</span>
<a name="line-90"></a><span class='hs-comment'>-- * We can keep demand information (i.e. lub with an absent deman)</span>
<a name="line-91"></a><span class='hs-comment'>-- * We have to kill definite divergence</span>
<a name="line-92"></a><span class='hs-comment'>-- * We can keep CPR information.</span>
<a name="line-93"></a><span class='hs-comment'>-- See Note [IO hack in the demand analyser]</span>
<a name="line-94"></a><span class='hs-definition'>deferAfterIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-95"></a><span class='hs-definition'>deferAfterIO</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-96"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`lubDmdType`</span> <span class='hs-varid'>nopDmdType</span> <span class='hs-keyword'>of</span>
<a name="line-97"></a>        <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-layout'>(</span><span class='hs-varid'>defer_res</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-98"></a>  <span class='hs-keyword'>where</span>
<a name="line-99"></a>  <span class='hs-varid'>defer_res</span> <span class='hs-conid'>Diverges</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topRes</span>
<a name="line-100"></a>  <span class='hs-varid'>defer_res</span> <span class='hs-varid'>r</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="strictenDmd"></a><span class='hs-definition'>strictenDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span>
<a name="line-103"></a><span class='hs-definition'>strictenDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke_s</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke_u</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span>
<a name="line-105"></a>  <span class='hs-keyword'>where</span>
<a name="line-106"></a>    <span class='hs-varid'>poke_s</span> <span class='hs-conid'>Lazy</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span>
<a name="line-107"></a>    <span class='hs-varid'>poke_s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-108"></a>    <span class='hs-varid'>poke_u</span> <span class='hs-conid'>Abs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UHead</span>
<a name="line-109"></a>    <span class='hs-varid'>poke_u</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
</pre>\end{code}

Deferring and peeeling

\begin{code}
<pre><a name="line-1"></a><a name="DeferAndUse"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DeferAndUse</span>   <span class='hs-comment'>-- Describes how to degrade a result type</span>
<a name="line-2"></a>   <span class='hs-keyglyph'>=</span><span class='hs-layout'>(</span> <span class='hs-conid'>Bool</span>        <span class='hs-comment'>-- Lazify (defer) the type</span>
<a name="line-3"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Count</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Many =&gt; manify the type</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="DeferAndUseM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DeferAndUseM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DeferAndUse</span>
<a name="line-6"></a>  <span class='hs-comment'>-- Nothing &lt;=&gt; absent-ify the result type; it will never be used</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="toCleanDmd"></a><span class='hs-definition'>toCleanDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CleanDemand</span><span class='hs-layout'>,</span> <span class='hs-conid'>DeferAndUseM</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>toCleanDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr_ty</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- The normal case</span>
<a name="line-12"></a>                            <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span>      <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Lazy</span><span class='hs-layout'>,</span>   <span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- See Note [Analyzing with lazy demand and lambdas]</span>
<a name="line-15"></a>                            <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>      <span class='hs-conid'>Abs</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Analysing with absent demand]</span>
<a name="line-18"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>expr_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>One</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="postProcessDmdTypeM"></a><span class='hs-comment'>-- This is used in dmdAnalStar when post-processing</span>
<a name="line-22"></a><span class='hs-comment'>-- a function's argument demand. So we only care about what</span>
<a name="line-23"></a><span class='hs-comment'>-- does to free variables, and whether it terminates.</span>
<a name="line-24"></a><span class='hs-comment'>-- see Note [The need for BothDmdArg]</span>
<a name="line-25"></a><span class='hs-definition'>postProcessDmdTypeM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DeferAndUseM</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BothDmdArg</span>
<a name="line-26"></a><span class='hs-definition'>postProcessDmdTypeM</span> <span class='hs-conid'>Nothing</span>   <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyDmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Dunno</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-comment'>-- Incoming demand was Absent, so just discard all usage information</span>
<a name="line-28"></a>  <span class='hs-comment'>-- We only processed the thing at all to analyse the body</span>
<a name="line-29"></a>  <span class='hs-comment'>-- See Note [Always analyse in virgin pass]</span>
<a name="line-30"></a><span class='hs-definition'>postProcessDmdTypeM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>du</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>postProcessDmdEnv</span> <span class='hs-varid'>du</span> <span class='hs-varid'>fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>postProcessDmdResult</span> <span class='hs-varid'>du</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="postProcessDmdResult"></a><span class='hs-definition'>postProcessDmdResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DeferAndUse</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Termination</span> <span class='hs-conid'>()</span>
<a name="line-34"></a><span class='hs-definition'>postProcessDmdResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-conid'>()</span>
<a name="line-35"></a><span class='hs-definition'>postProcessDmdResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Dunno</span> <span class='hs-conid'>()</span>
<a name="line-36"></a><span class='hs-definition'>postProcessDmdResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conid'>Diverges</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Diverges</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="postProcessDmdEnv"></a><span class='hs-definition'>postProcessDmdEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DeferAndUse</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-39"></a><span class='hs-definition'>postProcessDmdEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>Many</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferReuseEnv</span> <span class='hs-varid'>env</span>
<a name="line-40"></a><span class='hs-definition'>postProcessDmdEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>Many</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reuseEnv</span> <span class='hs-varid'>env</span>
<a name="line-41"></a><span class='hs-definition'>postProcessDmdEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>One</span><span class='hs-layout'>)</span>  <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferEnv</span> <span class='hs-varid'>env</span>
<a name="line-42"></a><span class='hs-definition'>postProcessDmdEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>One</span><span class='hs-layout'>)</span>  <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-43"></a>
<a name="line-44"></a>
<a name="line-45"></a><a name="postProcessUnsat"></a><span class='hs-definition'>postProcessUnsat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DeferAndUse</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-46"></a><span class='hs-definition'>postProcessUnsat</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>Many</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferReuse</span> <span class='hs-varid'>ty</span>
<a name="line-47"></a><span class='hs-definition'>postProcessUnsat</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>Many</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reuseType</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a><span class='hs-definition'>postProcessUnsat</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>One</span><span class='hs-layout'>)</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferType</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a><span class='hs-definition'>postProcessUnsat</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>One</span><span class='hs-layout'>)</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="deferType"></a><span class='hs-definition'>deferType</span><span class='hs-layout'>,</span> <span class='hs-varid'>reuseType</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferReuse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-52"></a><span class='hs-definition'>deferType</span>  <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>deferEnv</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span>      <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>deferDmd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>      <span class='hs-varid'>topRes</span>
<a name="line-53"></a><a name="reuseType"></a><span class='hs-definition'>reuseType</span>  <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>reuseEnv</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span>      <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>reuseDmd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>      <span class='hs-varid'>res_ty</span>
<a name="line-54"></a><a name="deferReuse"></a><span class='hs-definition'>deferReuse</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>deferReuseEnv</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>deferReuseDmd</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>topRes</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="deferEnv"></a><span class='hs-definition'>deferEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>reuseEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferReuseEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-57"></a><span class='hs-definition'>deferEnv</span>      <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>deferDmd</span> <span class='hs-varid'>fv</span>
<a name="line-58"></a><a name="reuseEnv"></a><span class='hs-definition'>reuseEnv</span>      <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>reuseDmd</span> <span class='hs-varid'>fv</span>
<a name="line-59"></a><a name="deferReuseEnv"></a><span class='hs-definition'>deferReuseEnv</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>deferReuseDmd</span> <span class='hs-varid'>fv</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="deferDmd"></a><span class='hs-definition'>deferDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>reuseDmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferReuseDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span>
<a name="line-62"></a><span class='hs-definition'>deferDmd</span>      <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-conid'>Lazy</span> <span class='hs-varid'>a</span>
<a name="line-63"></a><a name="reuseDmd"></a><span class='hs-definition'>reuseDmd</span>      <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>d</span>    <span class='hs-layout'>(</span><span class='hs-varid'>markReusedDmd</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-64"></a><a name="deferReuseDmd"></a><span class='hs-definition'>deferReuseDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span><span class='hs-keyglyph'>=</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>a</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-conid'>Lazy</span> <span class='hs-layout'>(</span><span class='hs-varid'>markReusedDmd</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="peelCallDmd"></a><span class='hs-comment'>-- Peels one call level from the demand, and also returns</span>
<a name="line-67"></a><span class='hs-comment'>-- whether it was unsaturated (separately for strictness and usage)</span>
<a name="line-68"></a><span class='hs-definition'>peelCallDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CleanDemand</span><span class='hs-layout'>,</span> <span class='hs-conid'>DeferAndUse</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-comment'>-- Exploiting the fact that</span>
<a name="line-70"></a><span class='hs-comment'>-- on the strictness side      C(B) = B</span>
<a name="line-71"></a><span class='hs-comment'>-- and on the usage side       C(U) = U</span>
<a name="line-72"></a><span class='hs-definition'>peelCallDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-74"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span>       <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>   <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-75"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span>       <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>Many</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>   <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-77"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HyperStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>Many</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-78"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>        <span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span>  <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>   <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-79"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>        <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeadStr</span><span class='hs-layout'>,</span>  <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Used</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span>  <span class='hs-conid'>Many</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-80"></a>       <span class='hs-comment'>-- The _ cases for usage includes UHead which seems a bit wrong</span>
<a name="line-81"></a>       <span class='hs-comment'>-- because the body isn't used at all!</span>
<a name="line-82"></a>       <span class='hs-comment'>-- c.f. the Abs case in toCleanDmd</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="peelManyCalls"></a><span class='hs-comment'>-- Peels that multiple nestings of calls clean demand and also returns</span>
<a name="line-85"></a><span class='hs-comment'>-- whether it was unsaturated (separately for strictness and usage</span>
<a name="line-86"></a><span class='hs-comment'>-- see Note [Demands from unsaturated function calls]</span>
<a name="line-87"></a><span class='hs-definition'>peelManyCalls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DeferAndUse</span>
<a name="line-88"></a><span class='hs-definition'>peelManyCalls</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_str</span> <span class='hs-varid'>n</span> <span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>go_abs</span> <span class='hs-varid'>n</span> <span class='hs-varid'>abs</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyword'>where</span>
<a name="line-91"></a>    <span class='hs-varid'>go_str</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- True &lt;=&gt; unsaturated, defer</span>
<a name="line-92"></a>    <span class='hs-varid'>go_str</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-93"></a>    <span class='hs-varid'>go_str</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HyperStr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- == go_str (n-1) HyperStr, as HyperStr = Call(HyperStr)</span>
<a name="line-94"></a>    <span class='hs-varid'>go_str</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>d'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_str</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>d'</span>
<a name="line-95"></a>    <span class='hs-varid'>go_str</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span> <span class='hs-comment'>-- Many &lt;=&gt; unsaturated, or at least</span>
<a name="line-98"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>One</span>    <span class='hs-comment'>--          one UCall Many in the demand</span>
<a name="line-99"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-varid'>d'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_abs</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>d'</span>
<a name="line-100"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
</pre>\end{code}

Note [Demands from unsaturated function calls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Consider a demand transformer d1 -> d2 -> r for f.
If a sufficiently detailed demand is fed into this transformer,
e.g <C(C(S)), C1(C1(S))> arising from "f x1 x2" in a strict, use-once context,
then d1 and d2 is precisely the demand unleashed onto x1 and x2 (similar for
the free variable environment) and furthermore the result information r is the
one we want to use.

An anonymous lambda is also an unsaturated function all (needs one argument,
none given), so this applies to that case as well.

But the demand fed into f might be less than <C(C(S)), C1(C1(S))>. There are a few cases:
 * Not enough demand on the strictness side:
   - In that case, we need to zap all strictness in the demand on arguments and
     free variables.
   - Furthermore, we remove CPR information. It could be left, but given the incoming
     demand is not enough to evaluate so far we just do not bother.
   - And finally termination information: If r says that f diverges for sure,
     then this holds when the demand guarantees that two arguments are going to
     be passed. If the demand is lower, we may just as well converge.
     If we were tracking definite convegence, than that would still hold under
     a weaker demand than expected by the demand transformer.
 * Not enough demand from the usage side: The missing usage can be expanded
   using UCall Many, therefore this is subsumed by the third case:
 * At least one of the uses has a cardinality of Many.
   - Even if f puts a One demand on any of its argument or free variables, if
     we call f multiple times, we may evaluate this argument or free variable
     multiple times. So forget about any occurrence of "One" in the demand.

In dmdTransformSig, we call peelManyCalls to find out if we are in any of these
cases, and then call postProcessUnsat to reduce the demand appropriately.

Similarly, dmdTransformDictSelSig and dmdAnal, when analyzing a Lambda, use
peelCallDmd, which peels only one level, but also returns the demand put on the
body of the function.

\begin{code}
<pre><a name="line-1"></a><a name="peelFV"></a><span class='hs-definition'>peelFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>peelFV</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "rfv" (ppr id &lt;+&gt; ppr dmd $$ ppr fv)</span>
<a name="line-3"></a>                               <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv'</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>  <span class='hs-varid'>fv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fv</span> <span class='hs-varop'>`delVarEnv`</span> <span class='hs-varid'>id</span>
<a name="line-6"></a>  <span class='hs-comment'>-- See Note [Default demand on free variables]</span>
<a name="line-7"></a>  <span class='hs-varid'>dmd</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>defaultDmd</span> <span class='hs-varid'>res</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="addDemand"></a><span class='hs-definition'>addDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-10"></a><span class='hs-definition'>addDemand</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
</pre>\end{code}

Note [Default demand on free variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the variable is not mentioned in the environment of a demand type,
its demand is taken to be a result demand of the type.
    For the stricness component,
     if the result demand is a Diverges, then we use HyperStr
                                         else we use Lazy
    For the usage component, we use Absent.
So we use either absDmd or botDmd.

Also note the equations for lubDmdResult (resp. bothDmdResult) noted there.

Note [Always analyse in virgin pass]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Tricky point: make sure that we analyse in the 'virgin' pass. Consider
   rec { f acc x True  = f (...rec { g y = ...g... }...)
         f acc x False = acc }
In the virgin pass for 'f' we'll give 'f' a very strict (bottom) type.
That might mean that we analyse the sub-expression containing the 
E = "...rec g..." stuff in a bottom demand.  Suppose we *didn't analyse*
E, but just retuned botType.  

Then in the *next* (non-virgin) iteration for 'f', we might analyse E
in a weaker demand, and that will trigger doing a fixpoint iteration
for g.  But *because it's not the virgin pass* we won't start g's
iteration at bottom.  Disaster.  (This happened in $sfibToList' of 
nofib/spectral/fibheaps.)

So in the virgin pass we make sure that we do analyse the expression
at least once, to initialise its signatures.

Note [Analyzing with lazy demand and lambdas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The insight for analyzing lambdas follows from the fact that for
strictness S = C(L). This polymorphic expansion is critical for
cardinality analysis of the following example:

{-# NOINLINE build #-}
build g = (g (:) [], g (:) [])

h c z = build (\x ->
                let z1 = z ++ z
                 in if c
                    then \y -> x (y ++ z1)
                    else \y -> x (z1 ++ y))

One can see that `build` assigns to `g` demand <L,C(C1(U))>.
Therefore, when analyzing the lambda `(\x -> ...)`, we
expect each lambda \y -> ... to be annotated as "one-shot"
one. Therefore (\x -> \y -> x (y ++ z)) should be analyzed with a
demand <C(C(..), C(C1(U))>.

This is achieved by, first, converting the lazy demand L into the
strict S by the second clause of the analysis.

Note [Analysing with absent demand]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we analyse an expression with demand <L,A>.  The "A" means
"absent", so this expression will never be needed.  What should happen?
There are several wrinkles:

* We *do* want to analyse the expression regardless.
  Reason: Note [Always analyse in virgin pass]

  But we can post-process the results to ignore all the usage
  demands coming back. This is done by postProcessDmdTypeM.

* But in the case of an *unlifted type* we must be extra careful,
  because unlifted values are evaluated even if they are not used.
  Example (see Trac #9254):
     f :: (() -> (# Int#, () #)) -> ()
          -- Strictness signature is
          --    <C(S(LS)), 1*C1(U(A,1*U()))>
          -- I.e. calls k, but discards first component of result
     f k = case k () of (# _, r #) -> r

     g :: Int -> ()
     g y = f (\n -> (# case y of I# y2 -> y2, n #))

  Here f's strictness signature says (correctly) that it calls its
  argument function and ignores the first component of its result.
  This is correct in the sense that it'd be fine to (say) modify the
  function so that always returned 0# in the first component.

  But in function g, we *will* evaluate the 'case y of ...', because
  it has type Int#.  So 'y' will be evaluated.  So we must record this
  usage of 'y', else 'g' will say 'y' is absent, and will w/w so that
  'y' is bound to an aBSENT_ERROR thunk.

  An alternative would be to replace the 'case y of ...' with (say) 0#,
  but I have not tried that. It's not a common situation, but it is
  not theoretical: unsafePerformIO's implementation is very very like
  'f' above.


%************************************************************************
%*                                                                      *
                     Demand signatures
%*                                                                      *
%************************************************************************

In a let-bound Id we record its strictness info.  
In principle, this strictness info is a demand transformer, mapping
a demand on the Id into a DmdType, which gives
        a) the free vars of the Id's value
        b) the Id's arguments
        c) an indication of the result of applying 
           the Id to its arguments

However, in fact we store in the Id an extremely emascuated demand
transfomer, namely

                a single DmdType
(Nevertheless we dignify StrictSig as a distinct type.)

This DmdType gives the demands unleashed by the Id when it is applied
to as many arguments as are given in by the arg demands in the DmdType.
Also see Note [Nature of result demand] for the meaning of a DmdResult in a
strictness signature.

If an Id is applied to less arguments than its arity, it means that
the demand on the function at a call site is weaker than the vanilla
call demand, used for signature inference. Therefore we place a top
demand on all arguments. Otherwise, the demand is specified by Id's
signature.

For example, the demand transformer described by the demand signature
        StrictSig (DmdType {x -> <S,1*U>} <L,A><L,U(U,U)>m)
says that when the function is applied to two arguments, it
unleashes demand <S,1*U> on the free var x, <L,A> on the first arg,
and <L,U(U,U)> on the second, then returning a constructor.

If this same function is applied to one arg, all we can say is that it
uses x with <L,U>, and its arg with demand <L,U>.

\begin{code}
<pre><a name="line-1"></a><a name="StrictSig"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-conid'>DmdType</span>
<a name="line-2"></a>                  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mkStrictSig"></a><span class='hs-definition'>mkStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-8"></a><span class='hs-definition'>mkStrictSig</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="mkClosedStrictSig"></a><span class='hs-definition'>mkClosedStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-11"></a><span class='hs-definition'>mkClosedStrictSig</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="splitStrictSig"></a><span class='hs-definition'>splitStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdResult</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>splitStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="increaseStrictSigArity"></a><span class='hs-definition'>increaseStrictSigArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-17"></a><span class='hs-comment'>-- Add extra arguments to a strictness signature</span>
<a name="line-18"></a><span class='hs-definition'>increaseStrictSigArity</span> <span class='hs-varid'>arity_increase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>arity_increase</span> <span class='hs-varid'>topDmd</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="isNopSig"></a><span class='hs-definition'>isNopSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-22"></a><span class='hs-definition'>isNopSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNopDmdType</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="isBottomingSig"></a><span class='hs-definition'>isBottomingSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-25"></a><span class='hs-definition'>isBottomingSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>res</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="nopSig"></a><span class='hs-definition'>nopSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>botSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span>
<a name="line-28"></a><span class='hs-definition'>nopSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>nopDmdType</span>
<a name="line-29"></a><a name="botSig"></a><span class='hs-definition'>botSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>botDmdType</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="cprProdSig"></a><span class='hs-definition'>cprProdSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-32"></a><span class='hs-definition'>cprProdSig</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-varid'>cprProdDmdType</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="argsOneShots"></a><span class='hs-definition'>argsOneShots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>OneShotInfo</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-35"></a><span class='hs-definition'>argsOneShots</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n_val_args</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_ds</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>good_one_shot</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arg_ds</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProbOneShot</span>
<a name="line-40"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OneShotLam</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-43"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_d</span> <span class='hs-conop'>:</span> <span class='hs-varid'>arg_ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>argOneShots</span> <span class='hs-varid'>good_one_shot</span> <span class='hs-varid'>arg_d</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_ds</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-varid'>cons</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-46"></a>    <span class='hs-varid'>cons</span> <span class='hs-varid'>a</span>  <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="argOneShots"></a><span class='hs-definition'>argOneShots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OneShotInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OneShotInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-49"></a><span class='hs-definition'>argOneShots</span> <span class='hs-varid'>one_shot_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usg</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>usg</span> <span class='hs-keyword'>of</span>
<a name="line-51"></a>      <span class='hs-conid'>Use</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_usg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg_usg</span>
<a name="line-52"></a>      <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-53"></a>  <span class='hs-keyword'>where</span>
<a name="line-54"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span>  <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>one_shot_info</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>u</span>
<a name="line-55"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>Many</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoOneShotInfo</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>u</span>
<a name="line-56"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="dmdTransformSig"></a><span class='hs-definition'>dmdTransformSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-59"></a><span class='hs-comment'>-- (dmdTransformSig fun_sig dmd) considers a call to a function whose</span>
<a name="line-60"></a><span class='hs-comment'>-- signature is fun_sig, with demand dmd.  We return the demand</span>
<a name="line-61"></a><span class='hs-comment'>-- that the function places on its context (eg its args)</span>
<a name="line-62"></a><span class='hs-definition'>dmdTransformSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg_ds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cd</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>postProcessUnsat</span> <span class='hs-layout'>(</span><span class='hs-varid'>peelManyCalls</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>arg_ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>cd</span><span class='hs-layout'>)</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-64"></a>    <span class='hs-comment'>-- see Note [Demands from unsaturated function calls]</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="dmdTransformDataConSig"></a><span class='hs-definition'>dmdTransformDataConSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-67"></a><span class='hs-comment'>-- Same as dmdTransformSig but for a data constructor (worker), </span>
<a name="line-68"></a><span class='hs-comment'>-- which has a special kind of demand transformer.</span>
<a name="line-69"></a><span class='hs-comment'>-- If the constructor is saturated, we feed the demand on </span>
<a name="line-70"></a><span class='hs-comment'>-- the result into the constructor arguments.</span>
<a name="line-71"></a><span class='hs-definition'>dmdTransformDataConSig</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con_res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-72"></a>                             <span class='hs-layout'>(</span><span class='hs-conid'>CD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>str_dmds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_str</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>str</span>
<a name="line-74"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>abs_dmds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_abs</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>abs</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkJointDmds</span> <span class='hs-varid'>str_dmds</span> <span class='hs-varid'>abs_dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>con_res</span>
<a name="line-76"></a>                <span class='hs-comment'>-- Must remember whether it's a product, hence con_res, not TopRes</span>
<a name="line-77"></a>
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Not saturated</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopDmdType</span>
<a name="line-80"></a>  <span class='hs-keyword'>where</span>
<a name="line-81"></a>    <span class='hs-varid'>go_str</span> <span class='hs-num'>0</span> <span class='hs-varid'>dmd</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitStrProdDmd</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>dmd</span>
<a name="line-82"></a>    <span class='hs-varid'>go_str</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_str</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>s'</span>
<a name="line-83"></a>    <span class='hs-varid'>go_str</span> <span class='hs-varid'>n</span> <span class='hs-conid'>HyperStr</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_str</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-conid'>HyperStr</span>
<a name="line-84"></a>    <span class='hs-varid'>go_str</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-85"></a>
<a name="line-86"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-num'>0</span> <span class='hs-varid'>dmd</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUseProdDmd</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>dmd</span>
<a name="line-87"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-conid'>One</span> <span class='hs-varid'>u'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_abs</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>u'</span>
<a name="line-88"></a>    <span class='hs-varid'>go_abs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="dmdTransformDictSelSig"></a><span class='hs-definition'>dmdTransformDictSelSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CleanDemand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-91"></a><span class='hs-comment'>-- Like dmdTransformDataConSig, we have a special demand transformer</span>
<a name="line-92"></a><span class='hs-comment'>-- for dictionary selectors.  If the selector is saturated (ie has one</span>
<a name="line-93"></a><span class='hs-comment'>-- argument: the dictionary), we feed the demand on the result into</span>
<a name="line-94"></a><span class='hs-comment'>-- the indicated dictionary component.</span>
<a name="line-95"></a><span class='hs-definition'>dmdTransformDictSelSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dict_dmd</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cd</span>
<a name="line-96"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>cd'</span><span class='hs-layout'>,</span><span class='hs-varid'>defer_use</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peelCallDmd</span> <span class='hs-varid'>cd</span>
<a name="line-97"></a>   <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>jds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitProdDmd_maybe</span> <span class='hs-varid'>dict_dmd</span>
<a name="line-98"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>postProcessUnsat</span> <span class='hs-varid'>defer_use</span> <span class='hs-varop'>$</span>
<a name="line-99"></a>     <span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkOnceUsedDmd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkProdDmd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>enhance</span> <span class='hs-varid'>cd'</span><span class='hs-layout'>)</span> <span class='hs-varid'>jds</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>topRes</span>
<a name="line-100"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-101"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopDmdType</span>              <span class='hs-comment'>-- See Note [Demand transformer for a dictionary selector]</span>
<a name="line-102"></a>  <span class='hs-keyword'>where</span>
<a name="line-103"></a>    <span class='hs-varid'>enhance</span> <span class='hs-varid'>cd</span> <span class='hs-varid'>old</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbsDmd</span> <span class='hs-varid'>old</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old</span>
<a name="line-104"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOnceUsedDmd</span> <span class='hs-varid'>cd</span>  <span class='hs-comment'>-- This is the one!</span>
<a name="line-105"></a>
<a name="line-106"></a><span class='hs-definition'>dmdTransformDictSelSig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dmdTransformDictSelSig: no args"</span>
</pre>\end{code}

Note [Demand transformer for a dictionary selector]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we evaluate (op dict-expr) under demand 'd', then we can push the demand 'd'
into the appropriate field of the dictionary. What *is* the appropriate field?
We just look at the strictness signature of the class op, which will be
something like: U(AAASAAAAA).  Then replace the 'S' by the demand 'd'.

For single-method classes, which are represented by newtypes the signature 
of 'op' won't look like U(...), so the splitProdDmd_maybe will fail.
That's fine: if we are doing strictness analysis we are also doing inling,
so we'll have inlined 'op' into a cast.  So we can bale out in a conservative
way, returning nopDmdType.

It is (just.. Trac #8329) possible to be running strictness analysis *without*
having inlined class ops from single-method classes.  Suppose you are using
ghc --make; and the first module has a local -O0 flag.  So you may load a class
without interface pragmas, ie (currently) without an unfolding for the class
ops.   Now if a subsequent module in the --make sweep has a local -O flag
you might do strictness analysis, but there is no inlining for the class op.
This is weird, so I'm not worried about whether this optimises brilliantly; but
it should not fall over.

Note [Non-full application] 
~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
If a function having bottom as its demand result is applied to a less
number of arguments than its syntactic arity, we cannot say for sure
that it is going to diverge. This is the reason why we use the
function appIsBottom, which, given a strictness signature and a number
of arguments, says conservatively if the function is going to diverge
or not.

\begin{code}
<pre><a name="line-1"></a><a name="appIsBottom"></a><span class='hs-comment'>-- appIsBottom returns true if an application to n args would diverge</span>
<a name="line-2"></a><span class='hs-definition'>appIsBottom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a><span class='hs-definition'>appIsBottom</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>res</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lengthExceeds</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>n</span> 
<a name="line-5"></a><span class='hs-definition'>appIsBottom</span> <span class='hs-keyword'>_</span>                                 <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="seqStrictSig"></a><span class='hs-definition'>seqStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-8"></a><span class='hs-definition'>seqStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqDmdType</span> <span class='hs-varid'>ty</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="pprIfaceStrictSig"></a><span class='hs-comment'>-- Used for printing top-level strictness pragmas in interface files</span>
<a name="line-11"></a><span class='hs-definition'>pprIfaceStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-12"></a><span class='hs-definition'>pprIfaceStrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dmds</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res</span>
</pre>\end{code}

Zap absence or one-shot information, under control of flags

\begin{code}
<pre><a name="line-1"></a><a name="zapDemand"></a><span class='hs-definition'>zapDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-2"></a><span class='hs-definition'>zapDemand</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dmd</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kfs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>killFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zap_dmd</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>dmd</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="zapStrictSig"></a><span class='hs-definition'>zapStrictSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-7"></a><span class='hs-definition'>zapStrictSig</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>sig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kfs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>killFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrictSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_dmd</span> <span class='hs-varid'>kfs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="KillFlags"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="killFlags"></a><span class='hs-definition'>killFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>KillFlags</span>
<a name="line-14"></a><span class='hs-definition'>killFlags</span> <span class='hs-varid'>dflags</span> 
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>kill_abs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>kill_one_shot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>kill_abs</span><span class='hs-layout'>,</span> <span class='hs-varid'>kill_one_shot</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>    <span class='hs-varid'>kill_abs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KillAbsence</span> <span class='hs-varid'>dflags</span>
<a name="line-19"></a>    <span class='hs-varid'>kill_one_shot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KillOneShot</span> <span class='hs-varid'>dflags</span>
<a name="line-20"></a>      
<a name="line-21"></a><a name="zap_dmd"></a><span class='hs-definition'>zap_dmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-22"></a><span class='hs-definition'>zap_dmd</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zap_musg</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>u</span><span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="zap_musg"></a><span class='hs-definition'>zap_musg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeUsed</span>
<a name="line-25"></a><span class='hs-definition'>zap_musg</span> <span class='hs-layout'>(</span><span class='hs-varid'>kill_abs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conid'>Abs</span> 
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kill_abs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>useTop</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-28"></a><span class='hs-definition'>zap_musg</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Use</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_count</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="zap_count"></a><span class='hs-definition'>zap_count</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Count</span>
<a name="line-31"></a><span class='hs-definition'>zap_count</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>kill_one_shot</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kill_one_shot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Many</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="zap_usg"></a><span class='hs-definition'>zap_usg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KillFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UseDmd</span>
<a name="line-36"></a><span class='hs-definition'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_count</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-definition'>zap_usg</span> <span class='hs-varid'>kfs</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UProd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>zap_musg</span> <span class='hs-varid'>kfs</span><span class='hs-layout'>)</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-definition'>zap_usg</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>u</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="strictifyDictDmd"></a><span class='hs-comment'>-- If the argument is a used non-newtype dictionary, give it strict</span>
<a name="line-2"></a><span class='hs-comment'>-- demand. Also split the product type &amp; demand and recur in order to</span>
<a name="line-3"></a><span class='hs-comment'>-- similarly strictify the argument's contained used non-newtype</span>
<a name="line-4"></a><span class='hs-comment'>-- superclass dictionaries. We use the demand as our recursive measure</span>
<a name="line-5"></a><span class='hs-comment'>-- to guarantee termination.</span>
<a name="line-6"></a><span class='hs-definition'>strictifyDictDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-7"></a><span class='hs-definition'>strictifyDictDmd</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>absd</span> <span class='hs-varid'>dmd</span> <span class='hs-keyword'>of</span>
<a name="line-8"></a>  <span class='hs-conid'>Use</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span>
<a name="line-9"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-sel'>_arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_data_con</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_con_arg_tys</span><span class='hs-layout'>)</span>
<a name="line-10"></a>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitDataProductType_maybe</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-comment'>-- is a non-newtype dictionary</span>
<a name="line-12"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>seqDmd</span> <span class='hs-varop'>`bothDmd`</span> <span class='hs-comment'>-- main idea: ensure it's strict</span>
<a name="line-13"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>splitProdDmd_maybe</span> <span class='hs-varid'>dmd</span> <span class='hs-keyword'>of</span>
<a name="line-14"></a>         <span class='hs-comment'>-- superclass cycles should not be a problem, since the demand we are</span>
<a name="line-15"></a>         <span class='hs-comment'>-- consuming would also have to be infinite in order for us to diverge</span>
<a name="line-16"></a>         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dmd</span> <span class='hs-comment'>-- no components have interesting demand, so stop</span>
<a name="line-17"></a>                        <span class='hs-comment'>-- looking for superclass dicts</span>
<a name="line-18"></a>         <span class='hs-conid'>Just</span> <span class='hs-varid'>dmds</span>
<a name="line-19"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isAbsDmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>dmds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evalDmd</span>
<a name="line-20"></a>             <span class='hs-comment'>-- abstract to strict w/ arbitrary component use, since this</span>
<a name="line-21"></a>             <span class='hs-comment'>-- smells like reboxing; results in CBV boxed</span>
<a name="line-22"></a>             <span class='hs-comment'>--</span>
<a name="line-23"></a>             <span class='hs-comment'>-- TODO revisit this if we ever do boxity analysis</span>
<a name="line-24"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mkProdDmd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>strictifyDictDmd</span> <span class='hs-varid'>inst_con_arg_tys</span> <span class='hs-varid'>dmds</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>               <span class='hs-conid'>CD</span> <span class='hs-layout'>{</span><span class='hs-varid'>sd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>ud</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JD</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-26"></a>             <span class='hs-comment'>-- TODO could optimize with an aborting variant of zipWith since</span>
<a name="line-27"></a>             <span class='hs-comment'>-- the superclass dicts are always a prefix</span>
<a name="line-28"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dmd</span> <span class='hs-comment'>-- unused or not a dictionary</span>
</pre>\end{code}

Note [HyperStr and Use demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The information "HyperStr" needs to be in the strictness signature, and not in
the demand signature, because we still want to know about the demand on things. Consider

    f (x,y) True  = error (show x)
    f (x,y) False = x+1

The signature of f should be <S(SL),1*U(1*U(U),A)><S,1*U>m. If we were not
distinguishing the uses on x and y in the True case, we could either not figure
out how deeply we can unpack x, or that we do not have to pass y.


%************************************************************************
%*                                                                      *
                     Serialisation
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>StrDmd</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>HyperStr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-3"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>HeadStr</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-4"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-5"></a>                            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>s</span>
<a name="line-6"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span>
<a name="line-7"></a>                            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>sx</span>  
<a name="line-8"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-9"></a>         <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-10"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>           <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HyperStr</span>
<a name="line-12"></a>           <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HeadStr</span>
<a name="line-13"></a>           <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-14"></a>                   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SCall</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-15"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>sx</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-16"></a>                   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SProd</span> <span class='hs-varid'>sx</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>MaybeStr</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Lazy</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-20"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-21"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-22"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-23"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>s</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-26"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-27"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-28"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Lazy</span>
<a name="line-29"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-30"></a>                      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Str</span> <span class='hs-varid'>s</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>Count</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>One</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-34"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Many</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-35"></a>    
<a name="line-36"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-37"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>                   <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>One</span>
<a name="line-39"></a>                   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Many</span>   
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>MaybeUsed</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Abs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-43"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-44"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-45"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-46"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>c</span>
<a name="line-47"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>u</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-50"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-51"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-52"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Abs</span>       
<a name="line-53"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>c</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-54"></a>                      <span class='hs-varid'>u</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-55"></a>                      <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Use</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>UseDmd</span> <span class='hs-keyword'>where</span>
<a name="line-58"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Used</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-59"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-60"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>UHead</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-61"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-62"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-63"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-64"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>c</span>
<a name="line-65"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>u</span>
<a name="line-66"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-67"></a>            <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span>
<a name="line-68"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>ux</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-71"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-72"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-73"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Used</span>
<a name="line-74"></a>              <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UHead</span>
<a name="line-75"></a>              <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-76"></a>                      <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-77"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>UCall</span> <span class='hs-varid'>c</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-78"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ux</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-79"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>UProd</span> <span class='hs-varid'>ux</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>JointDmd</span> <span class='hs-keyword'>where</span>
<a name="line-82"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>JD</span> <span class='hs-layout'>{</span><span class='hs-varid'>strd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>absd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>y</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>y</span>
<a name="line-83"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-84"></a>              <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-85"></a>              <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-86"></a>              <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkJointDmd</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyword'>where</span>
<a name="line-89"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>aa</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-90"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>aa</span>
<a name="line-91"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-92"></a>          <span class='hs-varid'>aa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span>
<a name="line-93"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>aa</span><span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyword'>where</span>
<a name="line-96"></a>  <span class='hs-comment'>-- Ignore DmdEnv when spitting out the DmdType</span>
<a name="line-97"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>dr</span><span class='hs-layout'>)</span> 
<a name="line-98"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>ds</span> 
<a name="line-99"></a>            <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>dr</span>
<a name="line-100"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> 
<a name="line-101"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> 
<a name="line-102"></a>           <span class='hs-varid'>dr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> 
<a name="line-103"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>dr</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyword'>where</span>
<a name="line-106"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>c</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>Diverges</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-108"></a>
<a name="line-109"></a>  <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-110"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-111"></a>                  <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Dunno</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-112"></a>                  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Diverges</span> <span class='hs-layout'>}</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>CPRResult</span> <span class='hs-keyword'>where</span>
<a name="line-115"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span>
<a name="line-116"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>RetProd</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-117"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>NoCPR</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span>
<a name="line-118"></a>
<a name="line-119"></a>    <span class='hs-varid'>get</span>  <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-120"></a>            <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-121"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span> 
<a name="line-122"></a>              <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RetSum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-123"></a>              <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>RetProd</span>
<a name="line-124"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>NoCPR</span>
</pre>\end{code}
</body>
</html>
