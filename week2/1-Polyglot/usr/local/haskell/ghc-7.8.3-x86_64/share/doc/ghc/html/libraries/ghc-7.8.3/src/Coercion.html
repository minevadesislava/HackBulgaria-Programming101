<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/Coercion.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- | Module for (a) type kinds and (b) type coercions,</span>
<a name="line-2"></a><span class='hs-comment'>-- as used in System FC. See 'CoreSyn.Expr' for</span>
<a name="line-3"></a><span class='hs-comment'>-- more on System FC and how coercions fit into it.</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span>
<a name="line-6"></a>        <span class='hs-comment'>-- * Main data type</span>
<a name="line-7"></a>        <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-9"></a>        <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ltRole</span><span class='hs-layout'>,</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-comment'>-- ** Functions over coercions</span>
<a name="line-12"></a>        <span class='hs-varid'>coVarKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarRole</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>coercionType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflCo</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>isReflCo_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionRole</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>mkCoercionType</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-comment'>-- ** Constructing coercions</span>
<a name="line-18"></a>        <span class='hs-varid'>mkReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoVarCo</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>mkAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxInstLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxInstRHS</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>mkUnbranchedAxInstRHS</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>mkPiCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoCast</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>mkSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCoRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLRCo</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>mkInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCoFlexible</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunCo</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>mkForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnsafeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnivCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSubCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPhantomCo</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>mkNewTypeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeSubCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeSubCo2</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>mkAxiomRuleCo</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- ** Decomposition</span>
<a name="line-29"></a>        <span class='hs-varid'>instNewTyCon_maybe</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>topNormaliseNewType_maybe</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-varid'>decomposeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>splitAppCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>splitForAllCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>nthRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConRolesX</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>nextRole</span><span class='hs-layout'>,</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-comment'>-- ** Coercion variables</span>
<a name="line-39"></a>        <span class='hs-varid'>mkCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoVarType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarUnique</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>        <span class='hs-comment'>-- ** Free variables</span>
<a name="line-42"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionSize</span><span class='hs-layout'>,</span>
<a name="line-43"></a>
<a name="line-44"></a>        <span class='hs-comment'>-- ** Substitution</span>
<a name="line-45"></a>        <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-conid'>CvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupCoVar</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-varid'>isEmptyCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCvInScope</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVars</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>substCoWithTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWithTys</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>cvTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipOpenCvSubst</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>extendCvSubstAndInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVarBndr</span><span class='hs-layout'>,</span>
<a name="line-54"></a>
<a name="line-55"></a>        <span class='hs-comment'>-- ** Lifting</span>
<a name="line-56"></a>        <span class='hs-varid'>liftCoMatch</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstWith</span><span class='hs-layout'>,</span>
<a name="line-57"></a>
<a name="line-58"></a>        <span class='hs-comment'>-- ** Comparison</span>
<a name="line-59"></a>        <span class='hs-varid'>coreEqCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>coreEqCoercion2</span><span class='hs-layout'>,</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-comment'>-- ** Forcing evaluation of coercions</span>
<a name="line-62"></a>        <span class='hs-varid'>seqCo</span><span class='hs-layout'>,</span>
<a name="line-63"></a>
<a name="line-64"></a>        <span class='hs-comment'>-- * Pretty-printing</span>
<a name="line-65"></a>        <span class='hs-varid'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-varid'>pprCoAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranchHdr</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- * Tidying</span>
<a name="line-69"></a>        <span class='hs-varid'>tidyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCos</span><span class='hs-layout'>,</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-comment'>-- * Other</span>
<a name="line-72"></a>        <span class='hs-varid'>applyCo</span>
<a name="line-73"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>MatchEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchList</span> <span class='hs-layout'>)</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Type</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Binary</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>     <span class='hs-layout'>(</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>NamedThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>funTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqPrimTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqReprPrimTyConKey</span> <span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-layout'>(</span><span class='hs-varid'>traverse</span><span class='hs-layout'>,</span> <span class='hs-varid'>sequenceA</span><span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
            Coercions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- | A 'Coercion' is concrete evidence of the equality/convertibility</span>
<a name="line-2"></a><span class='hs-comment'>-- of two types.</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="Coercion"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-5"></a><a name="Coercion"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.lhs</span>
<a name="line-6"></a><a name="Coercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Coercion</span>
<a name="line-7"></a>  <span class='hs-comment'>-- Each constructor has a "role signature", indicating the way roles are</span>
<a name="line-8"></a>  <span class='hs-comment'>-- propagated through coercions. P, N, and R stand for coercions of the</span>
<a name="line-9"></a>  <span class='hs-comment'>-- given role. e stands for a coercion of a specific unknown role (think</span>
<a name="line-10"></a>  <span class='hs-comment'>-- "role polymorphism"). "e" stands for an explicit role parameter</span>
<a name="line-11"></a>  <span class='hs-comment'>-- indicating role e. _ stands for a parameter that is not a Role or</span>
<a name="line-12"></a>  <span class='hs-comment'>-- Coercion.</span>
<a name="line-13"></a>
<a name="line-14"></a>  <span class='hs-comment'>-- These ones mirror the shape of types</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Refl :: "e" -&gt; _ -&gt; e</span>
<a name="line-16"></a>    <span class='hs-conid'>Refl</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-17"></a>          <span class='hs-comment'>-- Invariant: applications of (Refl T) to a bunch of identity coercions</span>
<a name="line-18"></a>          <span class='hs-comment'>--            always show up as Refl.</span>
<a name="line-19"></a>          <span class='hs-comment'>-- For example  (Refl T) (Refl a) (Refl b) shows up as (Refl (T a b)).</span>
<a name="line-20"></a>
<a name="line-21"></a>          <span class='hs-comment'>-- Applications of (Refl T) to some coercions, at least one of</span>
<a name="line-22"></a>          <span class='hs-comment'>-- which is NOT the identity, show up as TyConAppCo.</span>
<a name="line-23"></a>          <span class='hs-comment'>-- (They may not be fully saturated however.)</span>
<a name="line-24"></a>          <span class='hs-comment'>-- ConAppCo coercions (like all coercions other than Refl)</span>
<a name="line-25"></a>          <span class='hs-comment'>-- are NEVER the identity.</span>
<a name="line-26"></a>
<a name="line-27"></a>          <span class='hs-comment'>-- Use (Refl Representational _), not (SubCo (Refl Nominal _))</span>
<a name="line-28"></a>
<a name="line-29"></a>  <span class='hs-comment'>-- These ones simply lift the correspondingly-named</span>
<a name="line-30"></a>  <span class='hs-comment'>-- Type constructors into Coercions</span>
<a name="line-31"></a>
<a name="line-32"></a>  <span class='hs-comment'>-- TyConAppCo :: "e" -&gt; _ -&gt; ?? -&gt; e</span>
<a name="line-33"></a>  <span class='hs-comment'>-- See Note [TyConAppCo roles]</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- lift TyConApp</span>
<a name="line-35"></a>               <span class='hs-comment'>-- The TyCon is never a synonym;</span>
<a name="line-36"></a>               <span class='hs-comment'>-- we expand synonyms eagerly</span>
<a name="line-37"></a>               <span class='hs-comment'>-- But it can be a type function</span>
<a name="line-38"></a>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>        <span class='hs-comment'>-- lift AppTy</span>
<a name="line-40"></a>          <span class='hs-comment'>-- AppCo :: e -&gt; N -&gt; e</span>
<a name="line-41"></a>
<a name="line-42"></a>  <span class='hs-comment'>-- See Note [Forall coercions]</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- forall a. g</span>
<a name="line-44"></a>         <span class='hs-comment'>-- :: _ -&gt; e -&gt; e</span>
<a name="line-45"></a>
<a name="line-46"></a>  <span class='hs-comment'>-- These are special</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-conid'>CoVar</span>      <span class='hs-comment'>-- :: _ -&gt; (N or R)</span>
<a name="line-48"></a>                       <span class='hs-comment'>-- result role depends on the tycon of the variable's type</span>
<a name="line-49"></a>
<a name="line-50"></a>    <span class='hs-comment'>-- AxiomInstCo :: e -&gt; _ -&gt; [N] -&gt; e</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>     <span class='hs-comment'>-- See also [CoAxiom index]</span>
<a name="line-53"></a>     <span class='hs-comment'>-- The coercion arguments always *precisely* saturate</span>
<a name="line-54"></a>     <span class='hs-comment'>-- arity of (that branch of) the CoAxiom.  If there are</span>
<a name="line-55"></a>     <span class='hs-comment'>-- any left over, we use AppCo.  See</span>
<a name="line-56"></a>     <span class='hs-comment'>-- See [Coercion axioms applied to coercions]</span>
<a name="line-57"></a>
<a name="line-58"></a>         <span class='hs-comment'>-- see Note [UnivCo]</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>      <span class='hs-comment'>-- :: "e" -&gt; _ -&gt; _ -&gt; e</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SymCo</span> <span class='hs-conid'>Coercion</span>             <span class='hs-comment'>-- :: e -&gt; e</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TransCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- :: e -&gt; e -&gt; e</span>
<a name="line-62"></a>
<a name="line-63"></a>    <span class='hs-comment'>-- The number of types and coercions should match exactly the expectations</span>
<a name="line-64"></a>    <span class='hs-comment'>-- of the CoAxiomRule (i.e., the rule is fully saturated).</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-66"></a>
<a name="line-67"></a>  <span class='hs-comment'>-- These are destructors</span>
<a name="line-68"></a>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NthCo</span>  <span class='hs-conid'>Int</span>         <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Zero-indexed; decomposes (T t0 ... tn)</span>
<a name="line-70"></a>    <span class='hs-comment'>-- :: _ -&gt; e -&gt; ?? (inverse of TyConAppCo, see Note [TyConAppCo roles])</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LRCo</span>   <span class='hs-conid'>LeftOrRight</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Decomposes (t_left t_right)</span>
<a name="line-72"></a>    <span class='hs-comment'>-- :: _ -&gt; N -&gt; N</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Type</span>
<a name="line-74"></a>    <span class='hs-comment'>-- :: e -&gt; _ -&gt; e</span>
<a name="line-75"></a>
<a name="line-76"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SubCo</span> <span class='hs-conid'>Coercion</span>                  <span class='hs-comment'>-- Turns a ~N into a ~R</span>
<a name="line-77"></a>    <span class='hs-comment'>-- :: N -&gt; R</span>
<a name="line-78"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="LeftOrRight"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-81"></a><a name="LeftOrRight"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.lhs</span>
<a name="line-82"></a><a name="LeftOrRight"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CLeft</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CRight</span>
<a name="line-83"></a>                 <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyword'>where</span>
<a name="line-86"></a>   <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>CLeft</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-87"></a>   <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>CRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-88"></a>
<a name="line-89"></a>   <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-90"></a>               <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a>                   <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>CLeft</span>
<a name="line-92"></a>                   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>CRight</span> <span class='hs-layout'>}</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="pickLR"></a><span class='hs-definition'>pickLR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-95"></a><span class='hs-definition'>pickLR</span> <span class='hs-conid'>CLeft</span>  <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-96"></a><span class='hs-definition'>pickLR</span> <span class='hs-conid'>CRight</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
</pre>\end{code}

Note [Refl invariant]
~~~~~~~~~~~~~~~~~~~~~
Coercions have the following invariant
     Refl is always lifted as far as possible.

You might think that a consequencs is:
     Every identity coercions has Refl at the root

But that's not quite true because of coercion variables.  Consider
     g         where g :: Int~Int
     Left h    where h :: Maybe Int ~ Maybe Int
etc.  So the consequence is only true of coercions that
have no coercion variables.

Note [Coercion axioms applied to coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The reason coercion axioms can be applied to coercions and not just
types is to allow for better optimization.  There are some cases where
we need to be able to "push transitivity inside" an axiom in order to
expose further opportunities for optimization.

For example, suppose we have

  C a : t[a] ~ F a
  g   : b ~ c

and we want to optimize

  sym (C b) ; t[g] ; C c

which has the kind

  F b ~ F c

(stopping through t[b] and t[c] along the way).

We'd like to optimize this to just F g -- but how?  The key is
that we need to allow axioms to be instantiated by *coercions*,
not just by types.  Then we can (in certain cases) push
transitivity inside the axiom instantiations, and then react
opposite-polarity instantiations of the same axiom.  In this
case, e.g., we match t[g] against the LHS of (C c)'s kind, to
obtain the substitution  a |-> g  (note this operation is sort
of the dual of lifting!) and hence end up with

  C g : t[b] ~ F c

which indeed has the same kind as  t[g] ; C c.

Now we have

  sym (C b) ; C g

which can be optimized to F g.

Note [CoAxiom index]
~~~~~~~~~~~~~~~~~~~~
A CoAxiom has 1 or more branches. Each branch has contains a list
of the free type variables in that branch, the LHS type patterns,
and the RHS type for that branch. When we apply an axiom to a list
of coercions, we must choose which branch of the axiom we wish to
use, as the different branches may have different numbers of free
type variables. (The number of type patterns is always the same
among branches, but that doesn't quite concern us here.)

The Int in the AxiomInstCo constructor is the 0-indexed number
of the chosen branch.

Note [Forall coercions]
~~~~~~~~~~~~~~~~~~~~~~~
Constructing coercions between forall-types can be a bit tricky.
Currently, the situation is as follows:

  ForAllCo TyVar Coercion

represents a coercion between polymorphic types, with the rule

           v : k       g : t1 ~ t2
  ----------------------------------------------
  ForAllCo v g : (all v:k . t1) ~ (all v:k . t2)

Note that it's only necessary to coerce between polymorphic types
where the type variables have identical kinds, because equality on
kinds is trivial.

Note [Predicate coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
   g :: a~b
How can we coerce between types
   ([c]~a) => [a] -> c
and
   ([c]~b) => [b] -> c
where the equality predicate *itself* differs?

Answer: we simply treat (~) as an ordinary type constructor, so these
types really look like

   ((~) [c] a) -> [a] -> c
   ((~) [c] b) -> [b] -> c

So the coercion between the two is obviously

   ((~) [c] g) -> [g] -> c

Another way to see this to say that we simply collapse predicates to
their representation type (see Type.coreView and Type.predTypeRep).

This collapse is done by mkPredCo; there is no PredCo constructor
in Coercion.  This is important because we need Nth to work on
predicates too:
    Nth 1 ((~) [c] g) = g
See Simplify.simplCoercionF, which generates such selections.

Note [Kind coercions]
~~~~~~~~~~~~~~~~~~~~~
Suppose T :: * -> *, and g :: A ~ B
Then the coercion
   TyConAppCo T [g]      T g : T A ~ T B

Now suppose S :: forall k. k -> *, and g :: A ~ B
Then the coercion
   TyConAppCo S [Refl *, g]   T <*> g : T * A ~ T * B

Notice that the arguments to TyConAppCo are coercions, but the first
represents a *kind* coercion. Now, we don't allow any non-trivial kind
coercions, so it's an invariant that any such kind coercions are Refl.
Lint checks this.

However it's inconvenient to insist that these kind coercions are always
*structurally* (Refl k), because the key function exprIsConApp_maybe
pushes coercions into constructor arguments, so
       C k ty e |> g
may turn into
       C (Nth 0 g) ....
Now (Nth 0 g) will optimise to Refl, but perhaps not instantly.

Note [Roles]
~~~~~~~~~~~~
Roles are a solution to the GeneralizedNewtypeDeriving problem, articulated
in Trac #1496. The full story is in docs/core-spec/core-spec.pdf. Also, see
http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation

Here is one way to phrase the problem:

Given:
newtype Age = MkAge Int
type family F x
type instance F Age = Bool
type instance F Int = Char

This compiles down to:
axAge :: Age ~ Int
axF1 :: F Age ~ Bool
axF2 :: F Int ~ Char

Then, we can make:
(sym (axF1) ; F axAge ; axF2) :: Bool ~ Char

Yikes!

The solution is _roles_, as articulated in "Generative Type Abstraction and
Type-level Computation" (POPL 2010), available at
http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf

The specification for roles has evolved somewhat since that paper. For the
current full details, see the documentation in docs/core-spec. Here are some
highlights.

We label every equality with a notion of type equivalence, of which there are
three options: Nominal, Representational, and Phantom. A ground type is
nominally equivalent only with itself. A newtype (which is considered a ground
type in Haskell) is representationally equivalent to its representation.
Anything is "phantomly" equivalent to anything else. We use "N", "R", and "P"
to denote the equivalences.

The axioms above would be:
axAge :: Age ~R Int
axF1 :: F Age ~N Bool
axF2 :: F Age ~N Char

Then, because transitivity applies only to coercions proving the same notion
of equivalence, the above construction is impossible.

However, there is still an escape hatch: we know that any two types that are
nominally equivalent are representationally equivalent as well. This is what
the form SubCo proves -- it "demotes" a nominal equivalence into a
representational equivalence. So, it would seem the following is possible:

sub (sym axF1) ; F axAge ; sub axF2 :: Bool ~R Char   -- WRONG

What saves us here is that the arguments to a type function F, lifted into a
coercion, *must* prove nominal equivalence. So, (F axAge) is ill-formed, and
we are safe.

Roles are attached to parameters to TyCons. When lifting a TyCon into a
coercion (through TyConAppCo), we need to ensure that the arguments to the
TyCon respect their roles. For example:

data T a b = MkT a (F b)

If we know that a1 ~R a2, then we know (T a1 b) ~R (T a2 b). But, if we know
that b1 ~R b2, we know nothing about (T a b1) and (T a b2)! This is because
the type function F branches on b's *name*, not representation. So, we say
that 'a' has role Representational and 'b' has role Nominal. The third role,
Phantom, is for parameters not used in the type's definition. Given the
following definition

data Q a = MkQ Int

the Phantom role allows us to say that (Q Bool) ~R (Q Char), because we
can construct the coercion Bool ~P Char (using UnivCo).

See the paper cited above for more examples and information.

Note [UnivCo]
~~~~~~~~~~~~~
The UnivCo ("universal coercion") serves two rather separate functions:
 - the implementation for unsafeCoerce#
 - placeholder for phantom parameters in a TyConAppCo

At Representational, it asserts that two (possibly unrelated)
types have the same representation and can be casted to one another.
This form is necessary for unsafeCoerce#.

For optimisation purposes, it is convenient to allow UnivCo to appear
at Nominal role. If we have

data Foo a = MkFoo (F a)   -- F is a type family

and we want an unsafe coercion from Foo Int to Foo Bool, then it would
be nice to have (TyConAppCo Foo (UnivCo Nominal Int Bool)). So, we allow
Nominal UnivCo's.

At Phantom role, it is used as an argument to TyConAppCo in the place
of a phantom parameter (a type parameter unused in the type definition).

For example:

data Q a = MkQ Int

We want a coercion for (Q Bool) ~R (Q Char).

(TyConAppCo Representational Q [UnivCo Phantom Bool Char]) does the trick.

Note [TyConAppCo roles]
~~~~~~~~~~~~~~~~~~~~~~~
The TyConAppCo constructor has a role parameter, indicating the role at
which the coercion proves equality. The choice of this parameter affects
the required roles of the arguments of the TyConAppCo. To help explain
it, assume the following definition:

newtype Age = MkAge Int

Nominal: All arguments must have role Nominal. Why? So that Foo Age ~N Foo Int
does *not* hold.

Representational: All arguments must have the roles corresponding to the
result of tyConRoles on the TyCon. This is the whole point of having
roles on the TyCon to begin with. So, we can have Foo Age ~R Foo Int,
if Foo's parameter has role R.

If a Representational TyConAppCo is over-saturated (which is otherwise fine),
the spill-over arguments must all be at Nominal. This corresponds to the
behavior for AppCo.

Phantom: All arguments must have role Phantom. This one isn't strictly
necessary for soundness, but this choice removes ambiguity.



The rules here also dictate what the parameters to mkTyConAppCo.

%************************************************************************
%*                                                                      *
\subsection{Coercion variables}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="coVarName"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varName</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="setCoVarUnique"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-5"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="setCoVarName"></a><span class='hs-definition'>setCoVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-8"></a><span class='hs-definition'>setCoVarName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarName</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="isCoVar"></a><span class='hs-definition'>isCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-definition'>isCoVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isCoVarType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="isCoVarType"></a><span class='hs-definition'>isCoVarType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-14"></a><span class='hs-definition'>isCoVarType</span> <span class='hs-varid'>ty</span>      <span class='hs-comment'>-- Tests for t1 ~# t2, the unboxed equality</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-16"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                       <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthAtLeast`</span> <span class='hs-num'>2</span>
<a name="line-18"></a>      <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="tyCoVarsOfCo"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-2"></a><span class='hs-comment'>-- Extracts type and coercion variables from a coercion</span>
<a name="line-3"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-4"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-5"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-6"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-7"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-8"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-9"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span>
<a name="line-10"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-11"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-12"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-13"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-14"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-15"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-16"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cs</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="tyCoVarsOfCos"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-19"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>cos</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="coVarsOfCo"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-22"></a><span class='hs-comment'>-- Extract *coerction* variables only.  Tiresome to repeat the code, but easy.</span>
<a name="line-23"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-24"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-25"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-26"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-27"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-28"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-29"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-30"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-31"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-32"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-33"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-34"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-35"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-36"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="coVarsOfCos"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-39"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>cos</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="coercionSize"></a><span class='hs-definition'>coercionSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-42"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span>
<a name="line-43"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-45"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-46"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-47"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty2</span>
<a name="line-49"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-50"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-51"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-52"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-53"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span>
<a name="line-54"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-55"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-56"></a>                                         <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                            Tidying coercions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tidyCo"></a><span class='hs-definition'>tidyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2"></a><span class='hs-definition'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-6"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-7"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-8"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-9"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tvp</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>envp</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-10"></a>                                <span class='hs-keyword'>where</span>
<a name="line-11"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>envp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-12"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-13"></a>                                  <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-14"></a>                                  <span class='hs-conid'>Just</span> <span class='hs-varid'>cv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv'</span>
<a name="line-15"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-16"></a>                                   <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span>
<a name="line-17"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty2</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-21"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tys1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-26"></a>                                      <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-27"></a>                                  <span class='hs-keyword'>in</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>`seqList`</span>
<a name="line-28"></a>                                     <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>cos1</span>
<a name="line-29"></a>
<a name="line-30"></a>
<a name="line-31"></a><a name="tidyCos"></a><span class='hs-definition'>tidyCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a><span class='hs-definition'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                   Pretty-printing coercions
%*                                                                      *
%************************************************************************

@pprCo@ is the standard @Coercion@ printer; the overloaded @ppr@
function is defined to use this.  @pprParendCo@ is the same, except it
puts parens around the type, except for the atomic cases.
@pprParendCo@ works just by setting the initial context precedence
very high.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCo</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="pprCo"></a><span class='hs-definition'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-5"></a><span class='hs-definition'>pprCo</span>       <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span>   <span class='hs-varid'>co</span>
<a name="line-6"></a><a name="pprParendCo"></a><span class='hs-definition'>pprParendCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="ppr_co"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-9"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_role</span> <span class='hs-varid'>r</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcApp</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>ppr_co</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_role</span> <span class='hs-varid'>r</span>
<a name="line-15"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-16"></a>                                  <span class='hs-varid'>pprCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co2</span>
<a name="line-17"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-18"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>index</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>index</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-24"></a>                           <span class='hs-keyword'>case</span> <span class='hs-varid'>trans_co_list</span> <span class='hs-varid'>co</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>                             <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"ppr_co"</span>
<a name="line-26"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co</span>
<a name="line-27"></a>                                             <span class='hs-conop'>:</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>';'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cos</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-29"></a>                          <span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"UnivCo"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-32"></a>                                           <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-33"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Sym"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-34"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Nth:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-35"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>sel</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-36"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Sub"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varop'>$</span>
<a name="line-38"></a>                                  <span class='hs-varid'>ppr_axiom_rule_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="ppr_axiom_rule_co"></a><span class='hs-definition'>ppr_axiom_rule_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-41"></a><span class='hs-definition'>ppr_axiom_rule_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrName</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppTs</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppPs</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-keyword'>where</span>
<a name="line-43"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-44"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>t</span>
<a name="line-45"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-varid'>ts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-46"></a>                <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-49"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>p</span>
<a name="line-50"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"("</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCo</span> <span class='hs-varid'>p</span> <span class='hs-varop'>$$</span>
<a name="line-51"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>","</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCo</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>$$</span>
<a name="line-52"></a>                  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a>
<a name="line-55"></a>
<a name="line-56"></a><a name="ppr_role"></a><span class='hs-definition'>ppr_role</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-57"></a><span class='hs-definition'>ppr_role</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>underscore</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_role</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>pp_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-59"></a>                    <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'N'</span>
<a name="line-60"></a>                    <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'R'</span>
<a name="line-61"></a>                    <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'P'</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="trans_co_list"></a><span class='hs-definition'>trans_co_list</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a><span class='hs-definition'>trans_co_list</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trans_co_list</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-varid'>trans_co_list</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-definition'>trans_co_list</span> <span class='hs-varid'>co</span>                <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cos</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyword'>where</span>
<a name="line-68"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CLeft</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Left"</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CRight</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Right"</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="ppr_fun_co"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-72"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprArrowChain</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>split</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyword'>where</span>
<a name="line-74"></a>    <span class='hs-varid'>split</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a>    <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-76"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-77"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span>
<a name="line-78"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="ppr_forall_co"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-81"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-83"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprForAll</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>rho</span><span class='hs-keyglyph'>]</span>
<a name="line-84"></a>  <span class='hs-keyword'>where</span>
<a name="line-85"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span>  <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span>
<a name="line-86"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-87"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span>               <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="pprCoAxiom"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"axiom"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ax</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span><span class='hs-layout'>)</span>
<a name="line-4"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCoAxBranch</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromBranchList</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="pprCoAxBranch"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-7"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-8"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-9"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprForAll</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="pprCoAxBranchHdr"></a><span class='hs-definition'>pprCoAxBranchHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-14"></a><span class='hs-definition'>pprCoAxBranchHdr</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>index</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-17"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-- Defined"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_loc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>        <span class='hs-varid'>ppr_loc</span> <span class='hs-varid'>loc</span>
<a name="line-20"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGoodSrcSpan</span> <span class='hs-varid'>loc</span>
<a name="line-21"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStart</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-24"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-25"></a>              <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Functions over Kinds
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="decomposeCo"></a><span class='hs-comment'>-- | This breaks a 'Coercion' with type @T A B C ~ T D E F@ into</span>
<a name="line-2"></a><span class='hs-comment'>-- a list of 'Coercion's of kinds @A ~ D@, @B ~ E@ and @E ~ F@. Hence:</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- &gt; decomposeCo 3 c = [nth 0 c, nth 1 c, nth 2 c]</span>
<a name="line-5"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>co</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-8"></a>           <span class='hs-comment'>-- Remember, Nth is zero-indexed</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="getCoVar_maybe"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Coercion'</span>
<a name="line-11"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-12"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv</span>
<a name="line-13"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="splitAppCo_maybe"></a><span class='hs-comment'>-- first result has role equal to input; second result is Nominal</span>
<a name="line-16"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-comment'>-- ^ Attempt to take a coercion application apart.</span>
<a name="line-18"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-21"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>cos</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unSubCo_maybe</span> <span class='hs-varid'>co'</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co''</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Never create unsaturated type family apps!</span>
<a name="line-24"></a>       <span class='hs-comment'>-- Use mkTyConAppCo to preserve the invariant</span>
<a name="line-25"></a>       <span class='hs-comment'>--  that identity coercions are always represented by Refl</span>
<a name="line-26"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="splitForAllCo_maybe"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-36"></a><span class='hs-comment'>-- and some coercion kind stuff</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="coVarKind"></a><span class='hs-definition'>coVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-definition'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-40"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_kind</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-41"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span><span class='hs-layout'>)</span>
<a name="line-42"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-43"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"coVarKind, non coercion variable"</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="coVarRole"></a><span class='hs-definition'>coVarRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-46"></a><span class='hs-definition'>coVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarRole: unknown tycon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a>  <span class='hs-keyword'>where</span>
<a name="line-55"></a>    <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-56"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>tc0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc0</span>
<a name="line-57"></a>           <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarRole: not tyconapp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="mkCoercionType"></a><span class='hs-comment'>-- | Makes a coercion type from two types: the types whose equality</span>
<a name="line-60"></a><span class='hs-comment'>-- is proven by the relevant 'Coercion'</span>
<a name="line-61"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-62"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span>
<a name="line-63"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReprPrimEqPred</span>
<a name="line-64"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkCoercionType"</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="isReflCo"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-67"></a><span class='hs-definition'>isReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-68"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="isReflCo_maybe"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-71"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span>
<a name="line-72"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
            Building coercions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkCoVarCo"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2"></a><span class='hs-comment'>-- cv :: s ~# t</span>
<a name="line-3"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>)</span> <span class='hs-varid'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="mkReflCo"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-10"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="mkAxInstCo"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-13"></a><span class='hs-comment'>-- mkAxInstCo can legitimately be called over-staturated;</span>
<a name="line-14"></a><span class='hs-comment'>-- i.e. with more type arguments than the coercion requires</span>
<a name="line-15"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeSubCo2</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-varid'>rtys</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-layout'>)</span>
<a name="line-18"></a>                     <span class='hs-varid'>maybeSubCo2</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>                     <span class='hs-varid'>foldl</span> <span class='hs-conid'>AppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>n_tys</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-23"></a>    <span class='hs-varid'>ax_br</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toBranchedAxiom</span> <span class='hs-varid'>ax</span>
<a name="line-24"></a>    <span class='hs-varid'>branch</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span>
<a name="line-25"></a>    <span class='hs-varid'>arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-26"></a>    <span class='hs-varid'>arg_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchRoles</span> <span class='hs-varid'>branch</span>
<a name="line-27"></a>    <span class='hs-varid'>rtys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_roles</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-28"></a>    <span class='hs-varid'>ax_role</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="mkUnbranchedAxInstCo"></a><span class='hs-comment'>-- to be used only with unbranched axioms</span>
<a name="line-31"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-32"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span> <span class='hs-varid'>tys</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="mkAxInstLHS"></a><span class='hs-definition'>mkAxInstLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-36"></a><span class='hs-comment'>-- Instantiate the axiom with specified types,</span>
<a name="line-37"></a><span class='hs-comment'>-- returning the instantiated RHS</span>
<a name="line-38"></a><span class='hs-comment'>-- A companion to mkAxInstCo:</span>
<a name="line-39"></a><span class='hs-comment'>--    mkAxInstRhs ax index tys = snd (coercionKind (mkAxInstCo ax index tys))</span>
<a name="line-40"></a><span class='hs-definition'>mkAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-42"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-44"></a>    <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="mkAxInstRHS"></a><span class='hs-definition'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-48"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-50"></a>    <span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="mkUnbranchedAxInstRHS"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-53"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="mkAppCo"></a><span class='hs-comment'>-- | Apply a 'Coercion' to another 'Coercion'.</span>
<a name="line-56"></a><span class='hs-comment'>-- The second coercion must be Nominal, unless the first is Phantom.</span>
<a name="line-57"></a><span class='hs-comment'>-- If the first is Phantom, then the second can be either Phantom or Nominal.</span>
<a name="line-58"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-59"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCoFlexible</span> <span class='hs-varid'>co1</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co2</span>
<a name="line-60"></a><span class='hs-comment'>-- Note, mkAppCo is careful to maintain invariants regarding</span>
<a name="line-61"></a><span class='hs-comment'>-- where Refl constructors appear; see the comments in the definition</span>
<a name="line-62"></a><span class='hs-comment'>-- of Coercion and the Note [Refl invariant] in types/TypeRep.lhs.</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="mkAppCoFlexible"></a><span class='hs-comment'>-- | Apply a 'Coercion' to another 'Coercion'.</span>
<a name="line-65"></a><span class='hs-comment'>-- The second 'Coercion's role is given, making this more flexible than</span>
<a name="line-66"></a><span class='hs-comment'>-- 'mkAppCo'.</span>
<a name="line-67"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-68"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co2</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-72"></a>    <span class='hs-comment'>-- Expand type synonyms; a TyConAppCo can't have a type synonym (Trac #9102)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-74"></a>  <span class='hs-keyword'>where</span>
<a name="line-75"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>maybeSubCo2</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span>
<a name="line-76"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>ty1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zip_roles</span> <span class='hs-varid'>rs</span> <span class='hs-varid'>tys</span>
<a name="line-77"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"zip_roles"</span> <span class='hs-comment'>-- but the roles are infinite...</span>
<a name="line-78"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-80"></a>      <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-81"></a>                          <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-82"></a>      <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-83"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>new_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-84"></a>              <span class='hs-varid'>co'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeSubCo2</span> <span class='hs-varid'>new_role</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-85"></a>      <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkPhantomCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-varid'>co1</span> <span class='hs-sel'>_r2</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-sel'>_r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-88"></a>                              <span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-89"></a>
<a name="line-90"></a>
<a name="line-91"></a><a name="mkAppCos"></a><span class='hs-comment'>-- | Applies multiple 'Coercion's to another 'Coercion', from left to right.</span>
<a name="line-92"></a><span class='hs-comment'>-- See also 'mkAppCo'.</span>
<a name="line-93"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-94"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="mkTyConAppCo"></a><span class='hs-comment'>-- | Apply a type constructor to a list of coercions. It is the</span>
<a name="line-97"></a><span class='hs-comment'>-- caller's responsibility to get the roles correct on argument coercions.</span>
<a name="line-98"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-99"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-100"></a>               <span class='hs-comment'>-- Expand type synonyms</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_co_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftover_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExpandTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tv_co_prs</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>leftover_cos</span>
<a name="line-103"></a>
<a name="line-104"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>cos</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-106"></a>
<a name="line-107"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="mkFunCo"></a><span class='hs-comment'>-- | Make a function 'Coercion' between two other 'Coercion's</span>
<a name="line-110"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-111"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="mkForAllCo"></a><span class='hs-comment'>-- | Make a 'Coercion' which binds a variable within an inner 'Coercion'</span>
<a name="line-114"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-115"></a><span class='hs-comment'>-- note that a TyVar should be used here, not a CoVar (nor a TcTyVar)</span>
<a name="line-116"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-varid'>tv</span>  <span class='hs-varid'>co</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="mkSymCo"></a><span class='hs-comment'>-- | Create a symmetric version of the given 'Coercion' that asserts</span>
<a name="line-122"></a><span class='hs-comment'>--   equality between the same types but in the other "direction", so</span>
<a name="line-123"></a><span class='hs-comment'>--   a kind of @t1 ~ t2@ becomes the kind @t2 ~ t1@.</span>
<a name="line-124"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-125"></a>
<a name="line-126"></a><span class='hs-comment'>-- Do a few simple optimizations, but don't bother pushing occurrences</span>
<a name="line-127"></a><span class='hs-comment'>-- of symmetry to the leaves; the optimizer will take care of that.</span>
<a name="line-128"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-129"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty1</span>
<a name="line-130"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-131"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="mkTransCo"></a><span class='hs-comment'>-- | Create a new 'Coercion' by composing the two given 'Coercion's transitively.</span>
<a name="line-134"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-135"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-136"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-137"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="mkNthCoRole"></a><span class='hs-comment'>-- the Role is the desired one. It is the caller's responsibility to make</span>
<a name="line-140"></a><span class='hs-comment'>-- sure this request is reasonable</span>
<a name="line-141"></a><span class='hs-definition'>mkNthCoRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-142"></a><span class='hs-definition'>mkNthCoRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-143"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeSubCo2</span> <span class='hs-varid'>role</span> <span class='hs-varid'>nth_role</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nth_co</span>
<a name="line-144"></a>  <span class='hs-keyword'>where</span>
<a name="line-145"></a>    <span class='hs-varid'>nth_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-146"></a>    <span class='hs-varid'>nth_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>nth_co</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="mkNthCo"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-149"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span>
<a name="line-150"></a>                        <span class='hs-conid'>Refl</span> <span class='hs-varid'>r'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-151"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-152"></a>        <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-153"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-sel'>_ty1</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-sel'>_ty2</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span>
<a name="line-154"></a>                      <span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-155"></a>                    <span class='hs-keyword'>where</span>
<a name="line-156"></a>                      <span class='hs-conid'>Pair</span> <span class='hs-sel'>_ty1</span> <span class='hs-sel'>_ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-157"></a>
<a name="line-158"></a>
<a name="line-159"></a><a name="mkLRCo"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-160"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitAppTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-161"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="ok_tc_app"></a><span class='hs-definition'>ok_tc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-164"></a><span class='hs-definition'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-165"></a>                   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n</span>
<a name="line-166"></a>                   <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="mkInstCo"></a><span class='hs-comment'>-- | Instantiates a 'Coercion' with a 'Type' argument.</span>
<a name="line-169"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-170"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="mkUnsafeCo"></a><span class='hs-comment'>-- | Manufacture a coercion from thin air. Needless to say, this is</span>
<a name="line-173"></a><span class='hs-comment'>--   not usually safe, but it is used when we know we are dealing with</span>
<a name="line-174"></a><span class='hs-comment'>--   bottom, which is one case in which it is safe.  This is also used</span>
<a name="line-175"></a><span class='hs-comment'>--   to implement the @unsafeCoerce#@ primitive.  Optimise by pushing</span>
<a name="line-176"></a><span class='hs-comment'>--   down through type constructors.</span>
<a name="line-177"></a><span class='hs-definition'>mkUnsafeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-178"></a><span class='hs-definition'>mkUnsafeCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-conid'>Representational</span>
<a name="line-179"></a>
<a name="line-180"></a><a name="mkUnivCo"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-181"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="mkAxiomRuleCo"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-186"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomRuleCo</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="mkSubCo"></a><span class='hs-comment'>-- input coercion is Nominal</span>
<a name="line-189"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-190"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty</span>
<a name="line-191"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-192"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-193"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-194"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-195"></a>             <span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span>
<a name="line-196"></a>
<a name="line-197"></a>
<a name="line-198"></a><a name="maybeSubCo"></a><span class='hs-comment'>-- takes a Nominal coercion and possibly casts it into a Representational one</span>
<a name="line-199"></a><span class='hs-definition'>maybeSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-200"></a><span class='hs-definition'>maybeSubCo</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-201"></a><span class='hs-definition'>maybeSubCo</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span>
<a name="line-202"></a><span class='hs-definition'>maybeSubCo</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"maybeSubCo Phantom"</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ppr</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="maybeSubCo2_maybe"></a><span class='hs-definition'>maybeSubCo2_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- desired role</span>
<a name="line-205"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- current role</span>
<a name="line-206"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-207"></a><span class='hs-definition'>maybeSubCo2_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkSubCo</span>
<a name="line-208"></a><span class='hs-definition'>maybeSubCo2_maybe</span> <span class='hs-conid'>Nominal</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>
<a name="line-209"></a><span class='hs-definition'>maybeSubCo2_maybe</span> <span class='hs-conid'>Phantom</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span>
<a name="line-210"></a><span class='hs-definition'>maybeSubCo2_maybe</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkPhantomCo</span>
<a name="line-211"></a><span class='hs-definition'>maybeSubCo2_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Phantom</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>
<a name="line-212"></a><span class='hs-definition'>maybeSubCo2_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="maybeSubCo2"></a><span class='hs-definition'>maybeSubCo2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- desired role</span>
<a name="line-215"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- current role</span>
<a name="line-216"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-217"></a><span class='hs-definition'>maybeSubCo2</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeSubCo2_maybe</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-219"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-220"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"maybeSubCo2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-221"></a>
<a name="line-222"></a><a name="unSubCo_maybe"></a><span class='hs-comment'>-- if co is Nominal, returns it; otherwise, unwraps a SubCo; otherwise, fails</span>
<a name="line-223"></a><span class='hs-definition'>unSubCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-224"></a><span class='hs-definition'>unSubCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-225"></a><span class='hs-definition'>unSubCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span>
<a name="line-226"></a><span class='hs-definition'>unSubCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-227"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>unSubCo_maybe</span> <span class='hs-varid'>cos</span>
<a name="line-228"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos'</span> <span class='hs-layout'>}</span>
<a name="line-229"></a><span class='hs-definition'>unSubCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-230"></a>  <span class='hs-comment'>-- We do *not* promote UnivCo Phantom, as that's unsafe.</span>
<a name="line-231"></a>  <span class='hs-comment'>-- UnivCo Nominal is no more unsafe than UnivCo Representational</span>
<a name="line-232"></a><span class='hs-definition'>unSubCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-233"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-234"></a><span class='hs-definition'>unSubCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="mkPhantomCo"></a><span class='hs-comment'>-- takes any coercion and turns it into a Phantom coercion</span>
<a name="line-237"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-238"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-varid'>co</span>
<a name="line-239"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty</span>
<a name="line-240"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-241"></a>  <span class='hs-comment'>-- don't optimise here... wait for OptCoercion</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="applyRole"></a><span class='hs-comment'>-- All input coercions are assumed to be Nominal,</span>
<a name="line-244"></a><span class='hs-comment'>-- or, if Role is Phantom, the Coercion can be Phantom, too.</span>
<a name="line-245"></a><span class='hs-definition'>applyRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-246"></a><span class='hs-definition'>applyRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-247"></a><span class='hs-definition'>applyRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span>
<a name="line-248"></a><span class='hs-definition'>applyRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPhantomCo</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="applyRoles"></a><span class='hs-comment'>-- Convert args to a TyConAppCo Nominal to the same TyConAppCo Representational</span>
<a name="line-251"></a><span class='hs-definition'>applyRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-252"></a><span class='hs-definition'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>applyRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="tyConRolesX"></a><span class='hs-comment'>-- the Role parameter is the Role of the TyConAppCo</span>
<a name="line-256"></a><span class='hs-comment'>-- defined here because this is intimiately concerned with the implementation</span>
<a name="line-257"></a><span class='hs-comment'>-- of TyConAppCo</span>
<a name="line-258"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-259"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span>
<a name="line-260"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-varid'>role</span>             <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repeat</span> <span class='hs-varid'>role</span>
<a name="line-261"></a>
<a name="line-262"></a><a name="nthRole"></a><span class='hs-definition'>nthRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-263"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-264"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Phantom</span>
<a name="line-265"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-266"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>n</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="ltRole"></a><span class='hs-comment'>-- is one role "less" than another?</span>
<a name="line-269"></a><span class='hs-definition'>ltRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-270"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-271"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-272"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-273"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-274"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-275"></a>
<a name="line-276"></a><a name="nextRole"></a><span class='hs-comment'>-- if we wish to apply `co` to some other coercion, what would be its best</span>
<a name="line-277"></a><span class='hs-comment'>-- role?</span>
<a name="line-278"></a><span class='hs-definition'>nextRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-279"></a><span class='hs-definition'>nextRole</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-280"></a><span class='hs-definition'>nextRole</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dropList</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-281"></a><span class='hs-definition'>nextRole</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-282"></a>
<a name="line-283"></a><span class='hs-comment'>-- See note [Newtype coercions] in TyCon</span>
<a name="line-284"></a>
<a name="line-285"></a><a name="mkNewTypeCo"></a><span class='hs-comment'>-- | Create a coercion constructor (axiom) suitable for the given</span>
<a name="line-286"></a><span class='hs-comment'>--   newtype 'TyCon'. The 'Name' should be that of a new coercion</span>
<a name="line-287"></a><span class='hs-comment'>--   'CoAxiom', the 'TyVar's the arguments expected by the @newtype@ and</span>
<a name="line-288"></a><span class='hs-comment'>--   the type the appropriate right hand side of the @newtype@, with</span>
<a name="line-289"></a><span class='hs-comment'>--   the free variables a subset of those 'TyVar's.</span>
<a name="line-290"></a><span class='hs-definition'>mkNewTypeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-291"></a><span class='hs-definition'>mkNewTypeCo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_unique</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>name</span>
<a name="line-293"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-294"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- See Note [Implicit axioms] in TyCon</span>
<a name="line-295"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-296"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_tc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span>
<a name="line-297"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>branch</span> <span class='hs-layout'>}</span>
<a name="line-298"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_loc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>name</span>
<a name="line-299"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_tvs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-300"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs</span>
<a name="line-301"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span>
<a name="line-302"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-303"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="mkPiCos"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-306"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-varid'>r</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiCo</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-varid'>vs</span>
<a name="line-307"></a>
<a name="line-308"></a><a name="mkPiCo"></a><span class='hs-definition'>mkPiCo</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-309"></a><span class='hs-definition'>mkPiCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-310"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-311"></a>
<a name="line-312"></a><a name="mkCoCast"></a><span class='hs-comment'>-- The first coercion *must* be Nominal.</span>
<a name="line-313"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-314"></a><span class='hs-comment'>-- (mkCoCast (c :: s1 ~# t1) (g :: (s1 ~# t1) ~# (s2 ~# t2)</span>
<a name="line-315"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-varid'>c</span> <span class='hs-varid'>g</span>
<a name="line-316"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>g1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>g2</span>
<a name="line-317"></a>  <span class='hs-keyword'>where</span>
<a name="line-318"></a>       <span class='hs-comment'>-- g  :: (s1 ~# s2) ~# (t1 ~#  t2)</span>
<a name="line-319"></a>       <span class='hs-comment'>-- g1 :: s1 ~# t1</span>
<a name="line-320"></a>       <span class='hs-comment'>-- g2 :: s2 ~# t2</span>
<a name="line-321"></a>    <span class='hs-keyglyph'>[</span><span class='hs-sel'>_reflk</span><span class='hs-layout'>,</span> <span class='hs-varid'>g1</span><span class='hs-layout'>,</span> <span class='hs-varid'>g2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposeCo</span> <span class='hs-num'>3</span> <span class='hs-varid'>g</span>
<a name="line-322"></a>            <span class='hs-comment'>-- Remember, (~#) :: forall k. k -&gt; k -&gt; *</span>
<a name="line-323"></a>            <span class='hs-comment'>-- so it takes *three* arguments, not two</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
            Newtypes
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="instNewTyCon_maybe"></a><span class='hs-comment'>-- | If @co :: T ts ~ rep_ty@ then:</span>
<a name="line-2"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><span class='hs-comment'>-- &gt; instNewTyCon_maybe T ts = Just (rep_ty, co)</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- Checks for a newtype, and for being saturated</span>
<a name="line-6"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwrapNewTyCon_maybe</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- Check for newtype</span>
<a name="line-9"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>                      <span class='hs-comment'>-- Check saturated</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="topNormaliseNewType_maybe"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-comment'>-- ^ Sometimes we want to look through a @newtype@ and get its associated coercion.</span>
<a name="line-16"></a><span class='hs-comment'>-- This function strips off @newtype@ layers enough to reveal something that isn't</span>
<a name="line-17"></a><span class='hs-comment'>-- a @newtype@.  Specifically, here's the invariant:</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-comment'>-- &gt; topNormaliseNewType_maybe rec_nts ty = Just (co, ty')</span>
<a name="line-20"></a><span class='hs-comment'>--</span>
<a name="line-21"></a><span class='hs-comment'>-- then (a)  @co : ty0 ~ ty'@.</span>
<a name="line-22"></a><span class='hs-comment'>--      (b)  ty' is not a newtype.</span>
<a name="line-23"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><span class='hs-comment'>-- The function returns @Nothing@ for non-@newtypes@,</span>
<a name="line-25"></a><span class='hs-comment'>-- or unsaturated applications</span>
<a name="line-26"></a><span class='hs-comment'>--</span>
<a name="line-27"></a><span class='hs-comment'>-- This function does *not* look through type families, because it has no access to</span>
<a name="line-28"></a><span class='hs-comment'>-- the type family environment. If you do have that at hand, consider to use</span>
<a name="line-29"></a><span class='hs-comment'>-- topNormaliseType_maybe, which should be a drop-in replacement for</span>
<a name="line-30"></a><span class='hs-comment'>-- topNormaliseNewType_maybe</span>
<a name="line-31"></a><span class='hs-comment'>--</span>
<a name="line-32"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>initRecTc</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>ty</span>
<a name="line-34"></a>  <span class='hs-keyword'>where</span>
<a name="line-35"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>mb_co1</span> <span class='hs-varid'>ty</span>
<a name="line-36"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-37"></a>       <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-38"></a>       <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_co1</span> <span class='hs-keyword'>of</span>
<a name="line-39"></a>                      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co2</span>
<a name="line-40"></a>                      <span class='hs-conid'>Just</span> <span class='hs-varid'>co1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-41"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-42"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span>
<a name="line-43"></a>           <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-44"></a>                  <span class='hs-comment'>-- Return Nothing overall if we get stuck</span>
<a name="line-45"></a>                  <span class='hs-comment'>-- so that the return invariant is satisfied</span>
<a name="line-46"></a>                  <span class='hs-comment'>-- See Note [Expanding newtypes] in TyCon</span>
<a name="line-47"></a>
<a name="line-48"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_co1</span>     <span class='hs-comment'>-- Progress, but stopped on a non-newtype</span>
<a name="line-49"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-comment'>-- No progress</span>
<a name="line-52"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                   Equality of coercions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="coreEqCoercion"></a><span class='hs-comment'>-- | Determines syntactic equality of coercions</span>
<a name="line-2"></a><span class='hs-definition'>coreEqCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a><span class='hs-definition'>coreEqCoercion</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="coreEqCoercion2"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-7"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq1</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq2</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>eq2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-8"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq1</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq2</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>eq2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co12</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co21</span> <span class='hs-varid'>co22</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co21</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co12</span> <span class='hs-varid'>co22</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv2</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rnOccR</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cv2</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>ind1</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con2</span> <span class='hs-varid'>ind2</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>con2</span>
<a name="line-22"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ind1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ind2</span>
<a name="line-23"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>ty11</span> <span class='hs-varid'>ty12</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty11</span> <span class='hs-varid'>ty21</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty12</span> <span class='hs-varid'>ty22</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co12</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co21</span> <span class='hs-varid'>co22</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co21</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co12</span> <span class='hs-varid'>co22</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-36"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>d2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>cs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>ts2</span> <span class='hs-varid'>cs2</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>a2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs1</span> <span class='hs-varid'>cs2</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                   Substitution of coercions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="CvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Coercion's for 'CoVar's (OR 'TyVar's, when</span>
<a name="line-2"></a><a name="CvSubstEnv"></a><span class='hs-comment'>--   doing a \"lifting\" substitution)</span>
<a name="line-3"></a><a name="CvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="emptyCvSubstEnv"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-6"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="CvSubst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CvSubst</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-conid'>InScopeSet</span>  <span class='hs-comment'>-- The in-scope type variables</span>
<a name="line-10"></a>            <span class='hs-conid'>TvSubstEnv</span>  <span class='hs-comment'>-- Substitution of types</span>
<a name="line-11"></a>            <span class='hs-conid'>CvSubstEnv</span>  <span class='hs-comment'>-- Substitution of coercions</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>where</span>
<a name="line-14"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>ins</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-15"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CvSubst"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In scope:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-17"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type env:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-18"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Coercion env:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="emptyCvSubst"></a><span class='hs-definition'>emptyCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span>
<a name="line-21"></a><span class='hs-definition'>emptyCvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="isEmptyCvSubst"></a><span class='hs-definition'>isEmptyCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-24"></a><span class='hs-definition'>isEmptyCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="getCvInScope"></a><span class='hs-definition'>getCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-27"></a><span class='hs-definition'>getCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="zapCvSubstEnv"></a><span class='hs-definition'>zapCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-30"></a><span class='hs-definition'>zapCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="cvTvSubst"></a><span class='hs-definition'>cvTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-33"></a><span class='hs-definition'>cvTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="tvCvSubst"></a><span class='hs-definition'>tvCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-36"></a><span class='hs-definition'>tvCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="extendTvSubst"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-39"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="extendTvSubstAndInScope"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-43"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-45"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-46"></a>            <span class='hs-varid'>cenv</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="extendCvSubstAndInScope"></a><span class='hs-definition'>extendCvSubstAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-49"></a><span class='hs-comment'>-- Also extends the in-scope set</span>
<a name="line-50"></a><span class='hs-definition'>extendCvSubstAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>co</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-52"></a>            <span class='hs-varid'>tenv</span>
<a name="line-53"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="substCoVarBndr"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-58"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>new_cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>    <span class='hs-comment'>-- When we substitute (co :: t1 ~ t2) we may get the identity (co :: t ~ t)</span>
<a name="line-61"></a>    <span class='hs-comment'>-- In that case, mkCoVarCo will return a ReflCoercion, and</span>
<a name="line-62"></a>    <span class='hs-comment'>-- we want to substitute that (not new_var) for old_var</span>
<a name="line-63"></a>    <span class='hs-varid'>new_co</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_var</span>
<a name="line-64"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varid'>new_co</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-67"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_co</span>
<a name="line-68"></a>
<a name="line-69"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_old_var</span>
<a name="line-70"></a>    <span class='hs-varid'>subst_old_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a>                  <span class='hs-comment'>-- It's important to do the substitution for coercions,</span>
<a name="line-72"></a>                  <span class='hs-comment'>-- because they can have free type variables</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="substTyVarBndr"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-75"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span> <span class='hs-keyword'>of</span>
<a name="line-77"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>tenv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>tenv'</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="mkCvSubst"></a><span class='hs-definition'>mkCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-80"></a><span class='hs-definition'>mkCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="zipOpenCvSubst"></a><span class='hs-definition'>zipOpenCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-83"></a><span class='hs-definition'>zipOpenCvSubst</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>cos</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>vs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipOpenCvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>vs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyCvSubst</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-87"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipVarEnv</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="substCoWithTy"></a><span class='hs-definition'>substCoWithTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-90"></a><span class='hs-definition'>substCoWithTy</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoWithTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="substCoWithTys"></a><span class='hs-definition'>substCoWithTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-93"></a><span class='hs-definition'>substCoWithTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>co</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"substCoWithTys"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-98"></a>    <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="substCo"></a><span class='hs-comment'>-- | Substitute within a 'Coercion'</span>
<a name="line-101"></a><span class='hs-definition'>substCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-102"></a><span class='hs-definition'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-103"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="substCos"></a><span class='hs-comment'>-- | Substitute within several 'Coercion's</span>
<a name="line-106"></a><span class='hs-definition'>substCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-107"></a><span class='hs-definition'>substCos</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cos</span>
<a name="line-108"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="substTy"></a><span class='hs-definition'>substTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-111"></a><span class='hs-definition'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvTvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="subst_co"></a><span class='hs-definition'>subst_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-114"></a><span class='hs-definition'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-116"></a>  <span class='hs-keyword'>where</span>
<a name="line-117"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-118"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span>
<a name="line-119"></a>
<a name="line-120"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-121"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span>
<a name="line-122"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-123"></a>                                  <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-124"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-125"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-126"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-127"></a>                                   <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span>
<a name="line-128"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span>
<a name="line-129"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-130"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty2</span>
<a name="line-131"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-132"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-133"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-134"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-135"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span>
<a name="line-136"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-137"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ts1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ts</span>
<a name="line-138"></a>                                     <span class='hs-varid'>cs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span>
<a name="line-139"></a>                                 <span class='hs-keyword'>in</span> <span class='hs-varid'>ts1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>cs1</span> <span class='hs-varop'>`seqList`</span>
<a name="line-140"></a>                                    <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>cs1</span>
<a name="line-141"></a>
<a name="line-142"></a>
<a name="line-143"></a>
<a name="line-144"></a><a name="substCoVar"></a><span class='hs-definition'>substCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-145"></a><span class='hs-definition'>substCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInScope</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv1</span> <span class='hs-layout'>)</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv1</span>
<a name="line-148"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"substCoVar not in scope"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="substCoVars"></a><span class='hs-definition'>substCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-152"></a><span class='hs-definition'>substCoVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="lookupTyVar"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-155"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="lookupCoVar"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-158"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                   "Lifting" substitution
           [(TyVar,Coercion)] -> Type -> Coercion
%*                                                                      *
%************************************************************************

Note [Lifting coercions over types: liftCoSubst]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The KPUSH rule deals with this situation
   data T a = MkK (a -> Maybe a)
   g :: T t1 ~ K t2
   x :: t1 -> Maybe t1

   case (K @t1 x) |> g of
     K (y:t2 -> Maybe t2) -> rhs

We want to push the coercion inside the constructor application.
So we do this

   g' :: t1~t2  =  Nth 0 g

   case K @t2 (x |> g' -> Maybe g') of
     K (y:t2 -> Maybe t2) -> rhs

The crucial operation is that we
  * take the type of K's argument: a -> Maybe a
  * and substitute g' for a
thus giving *coercion*.  This is what liftCoSubst does.

Note [Substituting kinds in liftCoSubst]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to take care with kind polymorphism.  Suppose
  K :: forall k (a:k). (forall b:k. a -> b) -> T k a

Now given  (K @kk1 @ty1 v) |> g) where
  g :: T kk1 ty1 ~ T kk2 ty2
we want to compute
   (forall b:k a->b) [ Nth 0 g/k, Nth 1 g/a ]
Notice that we MUST substitute for 'k'; this happens in
liftCoSubstTyVarBndr.  But what should we substitute?
We need to take b's kind 'k' and return a Kind, not a Coercion!

Happily we can do this because we know that all kind coercions
((Nth 0 g) in this case) are Refl.  So we need a special purpose
   subst_kind: LiftCoSubst -> Kind -> Kind
that expects a Refl coercion (or something equivalent to Refl)
when it looks up a kind variable.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [Lifting coercions over types: liftCoSubst]</span>
<a name="line-3"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="LiftCoSubst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LCS</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="LiftCoEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-8"></a>     <span class='hs-comment'>-- Maps *type variables* to *coercions*</span>
<a name="line-9"></a>     <span class='hs-comment'>-- That's the whole point of this function!</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="liftCoSubstWith"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-12"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>ty</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWith"</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="liftCoSubst"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-16"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-varid'>prs</span> <span class='hs-varid'>ty</span>
<a name="line-17"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>prs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-comment'>-- | The \"lifting\" operation which substitutes coercions for type</span>
<a name="line-22"></a><span class='hs-comment'>--   variables in a type to produce a coercion.</span>
<a name="line-23"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><span class='hs-comment'>--   For the inverse operation, see 'liftCoMatch'</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="ty_co_subst"></a><span class='hs-comment'>-- The Role parameter is the _desired_ role</span>
<a name="line-27"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-28"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span>
<a name="line-32"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tv</span>
<a name="line-33"></a>                                <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-34"></a>                             <span class='hs-comment'>-- A type variable from a non-cloned forall</span>
<a name="line-35"></a>                             <span class='hs-comment'>-- won't be in the substitution</span>
<a name="line-36"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-37"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span>
<a name="line-38"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                           <span class='hs-comment'>-- IA0_NOTE: Do we need to do anything</span>
<a name="line-40"></a>                           <span class='hs-comment'>-- about kind instantiations? I don't think</span>
<a name="line-41"></a>                           <span class='hs-comment'>-- so.  see Note [Kind coercions]</span>
<a name="line-42"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-43"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>v'</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-44"></a>                         <span class='hs-keyword'>where</span>
<a name="line-45"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-46"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>role</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-47"></a>                                <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-conid'>Phantom</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubstLeft</span>  <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-50"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubstRight</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
</pre>\end{code}

Note [liftCoSubstTyVar]
~~~~~~~~~~~~~~~~~~~~~~~
This function can fail (i.e., return Nothing) for two separate reasons:
 1) The variable is not in the substutition
 2) The coercion found is of too low a role

liftCoSubstTyVar is called from two places: in liftCoSubst (naturally), and
also in matchAxiom in OptCoercion. From liftCoSubst, the so-called lifting
lemma guarantees that the roles work out. If we fail for reason 2) in this
case, we really should panic -- something is deeply wrong. But, in matchAxiom,
failing for reason 2) is fine. matchAxiom is trying to find a set of coercions
that match, but it may fail, and this is healthy behavior. Bottom line: if
you find that liftCoSubst is doing weird things (like leaving out-of-scope
variables lying around), disable coercion optimization (bypassing matchAxiom)
and use maybeSubCo2 instead of maybeSubCo2_maybe. The panic will then happen,
and you may learn something useful.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="liftCoSubstTyVar"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-3"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tv</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>tv</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span>   <span class='hs-comment'>-- could theoretically take this as</span>
<a name="line-6"></a>                                         <span class='hs-comment'>-- a parameter, but painful</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>maybeSubCo2_maybe</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co_role</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- see Note [liftCoSubstTyVar]</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="liftCoSubstTyVarBndr"></a><span class='hs-definition'>liftCoSubstTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftCoSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>liftCoSubstTyVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-14"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>new_var1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_var</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-21"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-22"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var1</span>
<a name="line-23"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>new_var1</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_kind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="liftCoSubstLeft"></a><span class='hs-comment'>-- map every variable to the type on the *left* of its mapped coercion</span>
<a name="line-26"></a><span class='hs-definition'>liftCoSubstLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-27"></a><span class='hs-definition'>liftCoSubstLeft</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="liftCoSubstRight"></a><span class='hs-comment'>-- same, but to the type on the right</span>
<a name="line-31"></a><span class='hs-definition'>liftCoSubstRight</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-32"></a><span class='hs-definition'>liftCoSubstRight</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="subst_kind"></a><span class='hs-definition'>subst_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-36"></a><span class='hs-comment'>-- See Note [Substituting kinds in liftCoSubst]</span>
<a name="line-37"></a><span class='hs-definition'>subst_kind</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>kind</span>
<a name="line-39"></a>  <span class='hs-keyword'>where</span>
<a name="line-40"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span>
<a name="line-41"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_kv</span> <span class='hs-varid'>kv</span>
<a name="line-42"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-43"></a>                           <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-46"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-47"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>liftCoSubstTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-48"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-49"></a>                                 <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_kind</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>subst_kv</span> <span class='hs-varid'>kv</span>
<a name="line-52"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>kv</span>
<a name="line-53"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-54"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>pFst</span> <span class='hs-varid'>co_kind</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>pSnd</span> <span class='hs-varid'>co_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-layout'>)</span>
<a name="line-55"></a>        <span class='hs-varid'>pFst</span> <span class='hs-varid'>co_kind</span>
<a name="line-56"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-57"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="liftCoMatch"></a><span class='hs-comment'>-- | 'liftCoMatch' is sort of inverse to 'liftCoSubst'.  In particular, if</span>
<a name="line-2"></a><span class='hs-comment'>--   @liftCoMatch vars ty co == Just s@, then @tyCoSubst s ty == co@.</span>
<a name="line-3"></a><span class='hs-comment'>--   That is, it matches a type against a coercion of the same</span>
<a name="line-4"></a><span class='hs-comment'>--   "shape", and returns a lifting substitution which could have been</span>
<a name="line-5"></a><span class='hs-comment'>--   used to produce the given coercion from the given type.</span>
<a name="line-6"></a><span class='hs-definition'>liftCoMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LiftCoSubst</span>
<a name="line-7"></a><span class='hs-definition'>liftCoMatch</span> <span class='hs-varid'>tmpls</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-9"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-10"></a>      <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>menv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ME</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpls</span><span class='hs-layout'>,</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpls</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-14"></a>    <span class='hs-comment'>-- Like tcMatchTy, assume all the interesting variables</span>
<a name="line-15"></a>    <span class='hs-comment'>-- in ty are in tmpls</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="ty_co_match"></a><span class='hs-comment'>-- | 'ty_co_match' does all the actual work for 'liftCoMatch'.</span>
<a name="line-18"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-19"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-comment'>-- Match a type variable against a non-refl coercion</span>
<a name="line-23"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>cenv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>tv1'</span>      <span class='hs-comment'>-- tv1' is already bound to co1</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-layout'>(</span><span class='hs-varid'>nukeRnEnvL</span> <span class='hs-varid'>rn_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co</span>
<a name="line-26"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cenv</span>
<a name="line-27"></a>    <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>       <span class='hs-comment'>-- no match since tv1 matches two different coercions</span>
<a name="line-28"></a>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1'</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-varid'>menv</span>           <span class='hs-comment'>-- tv1' is a template var</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>inRnEnvR</span> <span class='hs-varid'>rn_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>      <span class='hs-comment'>-- occurs check failed</span>
<a name="line-32"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>tv1'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-33"></a>        <span class='hs-comment'>-- BAY: I don't think we need to do any kind matching here yet</span>
<a name="line-34"></a>        <span class='hs-comment'>-- (compare 'match'), but we probably will when moving to SHE.</span>
<a name="line-35"></a>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-comment'>-- tv1 is not a template ty var, so the only thing it</span>
<a name="line-37"></a>                 <span class='hs-comment'>-- can match is a reflexivity coercion for itself.</span>
<a name="line-38"></a>                 <span class='hs-comment'>-- But that case is dealt with already</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-40"></a>
<a name="line-41"></a>  <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>me_env</span> <span class='hs-varid'>menv</span>
<a name="line-43"></a>    <span class='hs-varid'>tv1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>tv1</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppCo_maybe</span> <span class='hs-varid'>co</span>      <span class='hs-comment'>-- c.f. Unify.match on AppTy</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>co1</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>co2</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_matches</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_matches</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>cos</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv'</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>menv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>menv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBndr2</span> <span class='hs-layout'>(</span><span class='hs-varid'>me_env</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span> <span class='hs-layout'>}</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushRefl</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co'</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="ty_co_matches"></a><span class='hs-definition'>ty_co_matches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-66"></a><span class='hs-definition'>ty_co_matches</span> <span class='hs-varid'>menv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="pushRefl"></a><span class='hs-definition'>pushRefl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-69"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-73"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-75"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-definition'>pushRefl</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
            Sequencing on coercions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="seqCo"></a><span class='hs-definition'>seqCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-4"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-5"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-6"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-7"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-8"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty2</span>
<a name="line-9"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-10"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-11"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-12"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-13"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-14"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-15"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqTypes</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cs</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="seqCos"></a><span class='hs-definition'>seqCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-18"></a><span class='hs-definition'>seqCos</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-19"></a><span class='hs-definition'>seqCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
             The kind of a type, and of a coercion
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="coercionType"></a><span class='hs-definition'>coercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>coercionType</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-3"></a>                    <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCoercionType</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>------------------</span>
<a name="line-6"></a><span class='hs-comment'>-- | If it is the case that</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- &gt; c :: (t1 ~ t2)</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-- i.e. the kind of @c@ relates @t1@ and @t2@, then @coercionKind c = Pair t1 t2@.</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="coercionKind"></a><span class='hs-definition'>coercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-13"></a><span class='hs-definition'>coercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-16"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-17"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toPair</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-21"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span>
<a name="line-22"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceA</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- Invariant of AxiomInstCo: cos should</span>
<a name="line-24"></a>                                         <span class='hs-comment'>-- exactly saturate the axiom branch</span>
<a name="line-25"></a>        <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys2</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-28"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-29"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-30"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-31"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitAppTy</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-32"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>aco</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>aco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-33"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-34"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-35"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>coaxrProves</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-36"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-37"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"coercionKind: Malformed coercion"</span>
<a name="line-38"></a>
<a name="line-39"></a>
<a name="line-40"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-41"></a>    <span class='hs-comment'>-- Collect up all the arguments and apply all at once</span>
<a name="line-42"></a>    <span class='hs-comment'>-- See Note [Nested InstCos]</span>
<a name="line-43"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-44"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span>             <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>`applyTys`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="coercionKinds"></a><span class='hs-comment'>-- | Apply 'coercionKind' to multiple 'Coercion's</span>
<a name="line-47"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>tys</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="coercionRole"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-51"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-52"></a>  <span class='hs-keyword'>where</span>
<a name="line-53"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-54"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-55"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-56"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-57"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-58"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-59"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-60"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-61"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-comment'>-- same as go co2</span>
<a name="line-62"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-63"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>ty1</span>
<a name="line-64"></a>                              <span class='hs-keyword'>in</span> <span class='hs-varid'>nthRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-65"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-66"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-67"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-68"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coaxrRole</span> <span class='hs-varid'>c</span>
</pre>\end{code}

Note [Nested InstCos]
~~~~~~~~~~~~~~~~~~~~~
In Trac #5631 we found that 70% of the entire compilation time was
being spent in coercionKind!  The reason was that we had
   (g @ ty1 @ ty2 .. @ ty100)    -- The "@s" are InstCos
where
   g :: forall a1 a2 .. a100. phi
If we deal with the InstCos one at a time, we'll do this:
   1.  Find the kind of (g @ ty1 .. @ ty99) : forall a100. phi'
   2.  Substitute phi'[ ty100/a100 ], a single tyvar->type subst
But this is a *quadratic* algorithm, and the blew up Trac #5631.
So it's very important to do the substitution simultaneously.

cf Type.applyTys (which in fact we call here)


\begin{code}
<pre><a name="line-1"></a><a name="applyCo"></a><span class='hs-definition'>applyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-comment'>-- Gives the type of (e co) where e :: (a~b) =&gt; ty</span>
<a name="line-3"></a><span class='hs-definition'>applyCo</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyCo</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span>
<a name="line-4"></a><span class='hs-definition'>applyCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a><span class='hs-definition'>applyCo</span> <span class='hs-keyword'>_</span>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"applyCo"</span>
</pre>\end{code}

Note [Kind coercions]
~~~~~~~~~~~~~~~~~~~~~
Kind coercions are only of the form: Refl kind. They are only used to
instantiate kind polymorphic type constructors in TyConAppCo. Remember
that kind instantiation only happens with TyConApp, not AppTy.
</body>
</html>
