<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/Type.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1998
%

Type - public interface

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- | Main functions for manipulating types and type-related things</span>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>(</span>
<a name="line-5"></a>        <span class='hs-comment'>-- Note some of this is just re-exports from TyCon..</span>
<a name="line-6"></a>
<a name="line-7"></a>        <span class='hs-comment'>-- * Main data types representing Types</span>
<a name="line-8"></a>        <span class='hs-comment'>-- $type_classification</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-comment'>-- $representation_types</span>
<a name="line-11"></a>        <span class='hs-conid'>TyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindOrType</span><span class='hs-layout'>,</span> <span class='hs-conid'>PredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTyVar</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-comment'>-- ** Constructing and deconstructing types</span>
<a name="line-15"></a>        <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTyVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>        <span class='hs-varid'>mkAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitAppTys</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>splitAppTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>repSplitAppTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-varid'>mkFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitFunTy_maybe</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>splitFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitFunTysN</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>funResultTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>funArgTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipFunTys</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-varid'>mkTyConApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConTy</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>tyConAppTyCon_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppArgs_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppArgs</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>splitTyConApp_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitTyConApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppArgN</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-varid'>mkForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllTy_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllTys</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>mkPiKinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiType</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiTypes</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>applyTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>applyTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>applyTysD</span><span class='hs-layout'>,</span> <span class='hs-varid'>isForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropForAlls</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-varid'>mkNumLitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNumLitTy</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>mkStrLitTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrLitTy</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-varid'>coAxNthLHS</span><span class='hs-layout'>,</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-comment'>-- (Newtypes)</span>
<a name="line-38"></a>        <span class='hs-varid'>newTyConInstRhs</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-comment'>-- Pred types</span>
<a name="line-41"></a>        <span class='hs-varid'>mkFamilyTyConApp</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>isDictLikeTy</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>mkEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoerciblePred</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPrimEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkReprPrimEqPred</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>mkClassPred</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>noParenPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>isClassPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEqPred</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>isIPPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIPPred_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIPTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIPClass</span><span class='hs-layout'>,</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-comment'>-- Deconstructing predicate types</span>
<a name="line-49"></a>        <span class='hs-conid'>PredTree</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>classifyPredType</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>getClassPredTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>getClassPredTys_maybe</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>getEqPredTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEqPredTys_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEqPredRole</span><span class='hs-layout'>,</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-comment'>-- ** Common type constructors</span>
<a name="line-54"></a>        <span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span>
<a name="line-55"></a>
<a name="line-56"></a>        <span class='hs-comment'>-- ** Predicates on types</span>
<a name="line-57"></a>        <span class='hs-varid'>isTypeVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isKindVar</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>isTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDictTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPredTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVoidTy</span><span class='hs-layout'>,</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-comment'>-- (Lifting and boxity)</span>
<a name="line-61"></a>        <span class='hs-varid'>isUnLiftedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnboxedTupleType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAlgType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isClosedAlgType</span><span class='hs-layout'>,</span>
<a name="line-62"></a>        <span class='hs-varid'>isPrimitiveType</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStrictType</span><span class='hs-layout'>,</span>
<a name="line-63"></a>
<a name="line-64"></a>        <span class='hs-comment'>-- * Main data types representing Kinds</span>
<a name="line-65"></a>        <span class='hs-comment'>-- $kind_subtyping</span>
<a name="line-66"></a>        <span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-conid'>SimpleKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaKindVar</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- ** Finding the kind of a type</span>
<a name="line-69"></a>        <span class='hs-varid'>typeKind</span><span class='hs-layout'>,</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-comment'>-- ** Common Kinds and SuperKinds</span>
<a name="line-72"></a>        <span class='hs-varid'>anyKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>unliftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>openTypeKind</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>constraintKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>superKind</span><span class='hs-layout'>,</span>
<a name="line-74"></a>
<a name="line-75"></a>        <span class='hs-comment'>-- ** Common Kind type constructors</span>
<a name="line-76"></a>        <span class='hs-varid'>liftedTypeKindTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>openTypeKindTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>unliftedTypeKindTyCon</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>constraintKindTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>anyKindTyCon</span><span class='hs-layout'>,</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-comment'>-- * Type free variables</span>
<a name="line-80"></a>        <span class='hs-varid'>tyVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeOverKinds</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>expandTypeSynonyms</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>typeSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>varSetElemsKvsFirst</span><span class='hs-layout'>,</span>
<a name="line-83"></a>
<a name="line-84"></a>        <span class='hs-comment'>-- * Type comparison</span>
<a name="line-85"></a>        <span class='hs-varid'>eqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTypeX</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpType</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpTypes</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>eqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqPredX</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmpPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTyVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-87"></a>
<a name="line-88"></a>        <span class='hs-comment'>-- * Forcing evaluation of types</span>
<a name="line-89"></a>        <span class='hs-varid'>seqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>seqTypes</span><span class='hs-layout'>,</span>
<a name="line-90"></a>
<a name="line-91"></a>        <span class='hs-comment'>-- * Other views onto Types</span>
<a name="line-92"></a>        <span class='hs-varid'>coreView</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcView</span><span class='hs-layout'>,</span>
<a name="line-93"></a>
<a name="line-94"></a>        <span class='hs-conid'>UnaryType</span><span class='hs-layout'>,</span> <span class='hs-conid'>RepType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>flattenRepType</span><span class='hs-layout'>,</span> <span class='hs-varid'>repType</span><span class='hs-layout'>,</span>
<a name="line-95"></a>        <span class='hs-varid'>tyConsOfType</span><span class='hs-layout'>,</span>
<a name="line-96"></a>
<a name="line-97"></a>        <span class='hs-comment'>-- * Type representation for the code generator</span>
<a name="line-98"></a>        <span class='hs-varid'>typePrimRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeRepArity</span><span class='hs-layout'>,</span>
<a name="line-99"></a>
<a name="line-100"></a>        <span class='hs-comment'>-- * Main type substitution data types</span>
<a name="line-101"></a>        <span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Representation widely visible</span>
<a name="line-102"></a>        <span class='hs-conid'>TvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Representation visible to a few friends</span>
<a name="line-103"></a>
<a name="line-104"></a>        <span class='hs-comment'>-- ** Manipulating type substitutions</span>
<a name="line-105"></a>        <span class='hs-varid'>emptyTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTvSubst</span><span class='hs-layout'>,</span>
<a name="line-106"></a>
<a name="line-107"></a>        <span class='hs-varid'>mkTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOpenTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipOpenTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTopTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTopTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>notElemTvSubst</span><span class='hs-layout'>,</span>
<a name="line-108"></a>        <span class='hs-varid'>getTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-109"></a>        <span class='hs-varid'>zapTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTvInScope</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>extendTvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvInScopeList</span><span class='hs-layout'>,</span>
<a name="line-111"></a>        <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstList</span><span class='hs-layout'>,</span>
<a name="line-112"></a>        <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTyEnv</span><span class='hs-layout'>,</span>
<a name="line-113"></a>        <span class='hs-varid'>isEmptyTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionTvSubst</span><span class='hs-layout'>,</span>
<a name="line-114"></a>
<a name="line-115"></a>        <span class='hs-comment'>-- ** Performing substitution on types and kinds</span>
<a name="line-116"></a>        <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTheta</span><span class='hs-layout'>,</span>
<a name="line-117"></a>        <span class='hs-varid'>substTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span>
<a name="line-118"></a>        <span class='hs-varid'>cloneTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>deShadowTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span>
<a name="line-119"></a>        <span class='hs-varid'>substKiWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substKisWith</span><span class='hs-layout'>,</span>
<a name="line-120"></a>
<a name="line-121"></a>        <span class='hs-comment'>-- * Pretty-printing</span>
<a name="line-122"></a>        <span class='hs-varid'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTypeApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyThing</span><span class='hs-layout'>,</span>
<a name="line-123"></a>        <span class='hs-varid'>pprTvBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTvBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprForAll</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSigmaType</span><span class='hs-layout'>,</span>
<a name="line-124"></a>        <span class='hs-varid'>pprEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprThetaArrowTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprClassPred</span><span class='hs-layout'>,</span>
<a name="line-125"></a>        <span class='hs-varid'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSourceTyCon</span><span class='hs-layout'>,</span>
<a name="line-126"></a>
<a name="line-127"></a>        <span class='hs-comment'>-- * Tidying type related things up for printing</span>
<a name="line-128"></a>        <span class='hs-varid'>tidyType</span><span class='hs-layout'>,</span>      <span class='hs-varid'>tidyTypes</span><span class='hs-layout'>,</span>
<a name="line-129"></a>        <span class='hs-varid'>tidyOpenType</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tidyOpenTypes</span><span class='hs-layout'>,</span>
<a name="line-130"></a>        <span class='hs-varid'>tidyOpenKind</span><span class='hs-layout'>,</span>
<a name="line-131"></a>        <span class='hs-varid'>tidyTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyFreeTyVars</span><span class='hs-layout'>,</span>
<a name="line-132"></a>        <span class='hs-varid'>tidyOpenTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyOpenTyVars</span><span class='hs-layout'>,</span>
<a name="line-133"></a>        <span class='hs-varid'>tidyTyVarOcc</span><span class='hs-layout'>,</span>
<a name="line-134"></a>        <span class='hs-varid'>tidyTopType</span><span class='hs-layout'>,</span>
<a name="line-135"></a>        <span class='hs-varid'>tidyKind</span><span class='hs-layout'>,</span>
<a name="line-136"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-comment'>-- We import the representation and primitive functions from TypeRep.</span>
<a name="line-141"></a><span class='hs-comment'>-- Many things are reexported, but not the representation!</span>
<a name="line-142"></a>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-145"></a>
<a name="line-146"></a><span class='hs-comment'>-- friends:</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TysWiredIn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>eqTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercibleTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeNatKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>typeSymbolKind</span> <span class='hs-layout'>)</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span> <span class='hs-layout'>(</span> <span class='hs-varid'>eqTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercibleTyConKey</span><span class='hs-layout'>,</span>
<a name="line-157"></a>                   <span class='hs-varid'>ipClassNameKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>openTypeKindTyConKey</span><span class='hs-layout'>,</span>
<a name="line-158"></a>                   <span class='hs-varid'>constraintKindTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftedTypeKindTyConKey</span> <span class='hs-layout'>)</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-comment'>-- others</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasKey</span> <span class='hs-layout'>)</span>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>RepArity</span> <span class='hs-layout'>)</span>
<a name="line-164"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>)</span>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>guard</span> <span class='hs-layout'>)</span>
<a name="line-171"></a>
<a name="line-172"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>3</span> <span class='hs-varop'>`mkFunTy`</span>      <span class='hs-comment'>-- Associates to the right</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- $type_classification</span>
<a name="line-2"></a><span class='hs-comment'>-- #type_classification#</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- Types are one of:</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- [Unboxed]            Iff its representation is other than a pointer</span>
<a name="line-7"></a><span class='hs-comment'>--                      Unboxed types are also unlifted.</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-- [Lifted]             Iff it has bottom as an element.</span>
<a name="line-10"></a><span class='hs-comment'>--                      Closures always have lifted types: i.e. any</span>
<a name="line-11"></a><span class='hs-comment'>--                      let-bound identifier in Core must have a lifted</span>
<a name="line-12"></a><span class='hs-comment'>--                      type. Operationally, a lifted object is one that</span>
<a name="line-13"></a><span class='hs-comment'>--                      can be entered.</span>
<a name="line-14"></a><span class='hs-comment'>--                      Only lifted types may be unified with a type variable.</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- [Algebraic]          Iff it is a type with one or more constructors, whether</span>
<a name="line-17"></a><span class='hs-comment'>--                      declared with @data@ or @newtype@.</span>
<a name="line-18"></a><span class='hs-comment'>--                      An algebraic type is one that can be deconstructed</span>
<a name="line-19"></a><span class='hs-comment'>--                      with a case expression. This is /not/ the same as</span>
<a name="line-20"></a><span class='hs-comment'>--                      lifted types, because we also include unboxed</span>
<a name="line-21"></a><span class='hs-comment'>--                      tuples in this classification.</span>
<a name="line-22"></a><span class='hs-comment'>--</span>
<a name="line-23"></a><span class='hs-comment'>-- [Data]               Iff it is a type declared with @data@, or a boxed tuple.</span>
<a name="line-24"></a><span class='hs-comment'>--</span>
<a name="line-25"></a><span class='hs-comment'>-- [Primitive]          Iff it is a built-in type that can't be expressed in Haskell.</span>
<a name="line-26"></a><span class='hs-comment'>--</span>
<a name="line-27"></a><span class='hs-comment'>-- Currently, all primitive types are unlifted, but that's not necessarily</span>
<a name="line-28"></a><span class='hs-comment'>-- the case: for example, @Int@ could be primitive.</span>
<a name="line-29"></a><span class='hs-comment'>--</span>
<a name="line-30"></a><span class='hs-comment'>-- Some primitive types are unboxed, such as @Int#@, whereas some are boxed</span>
<a name="line-31"></a><span class='hs-comment'>-- but unlifted (such as @ByteArray#@).  The only primitive types that we</span>
<a name="line-32"></a><span class='hs-comment'>-- classify as algebraic are the unboxed tuples.</span>
<a name="line-33"></a><span class='hs-comment'>--</span>
<a name="line-34"></a><span class='hs-comment'>-- Some examples of type classifications that may make this a bit clearer are:</span>
<a name="line-35"></a><span class='hs-comment'>--</span>
<a name="line-36"></a><span class='hs-comment'>-- @</span>
<a name="line-37"></a><span class='hs-comment'>-- Type         primitive       boxed           lifted          algebraic</span>
<a name="line-38"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-39"></a><span class='hs-comment'>-- Int#         Yes             No              No              No</span>
<a name="line-40"></a><span class='hs-comment'>-- ByteArray#   Yes             Yes             No              No</span>
<a name="line-41"></a><span class='hs-comment'>-- (\# a, b \#)   Yes             No              No              Yes</span>
<a name="line-42"></a><span class='hs-comment'>-- (  a, b  )   No              Yes             Yes             Yes</span>
<a name="line-43"></a><span class='hs-comment'>-- [a]          No              Yes             Yes             Yes</span>
<a name="line-44"></a><span class='hs-comment'>-- @</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-comment'>-- $representation_types</span>
<a name="line-47"></a><span class='hs-comment'>-- A /source type/ is a type that is a separate type as far as the type checker is</span>
<a name="line-48"></a><span class='hs-comment'>-- concerned, but which has a more low-level representation as far as Core-to-Core</span>
<a name="line-49"></a><span class='hs-comment'>-- passes and the rest of the back end is concerned.</span>
<a name="line-50"></a><span class='hs-comment'>--</span>
<a name="line-51"></a><span class='hs-comment'>-- You don't normally have to worry about this, as the utility functions in</span>
<a name="line-52"></a><span class='hs-comment'>-- this module will automatically convert a source into a representation type</span>
<a name="line-53"></a><span class='hs-comment'>-- if they are spotted, to the best of it's abilities. If you don't want this</span>
<a name="line-54"></a><span class='hs-comment'>-- to happen, use the equivalent functions from the "TcType" module.</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Type representation
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="coreView"></a><span class='hs-comment'>{-# INLINE coreView #-}</span>
<a name="line-2"></a><span class='hs-definition'>coreView</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-3"></a><span class='hs-comment'>-- ^ In Core, we \"look through\" non-recursive newtypes and 'PredTypes': this</span>
<a name="line-4"></a><span class='hs-comment'>-- function tries to obtain a different view of the supplied type given this</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- Strips off the /top layer only/ of a type to give</span>
<a name="line-7"></a><span class='hs-comment'>-- its underlying representation type.</span>
<a name="line-8"></a><span class='hs-comment'>-- Returns Nothing if there is nothing to look through.</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-- By being non-recursive and inlined, this case analysis gets efficiently</span>
<a name="line-11"></a><span class='hs-comment'>-- joined onto the case analysis that the caller is already doing</span>
<a name="line-12"></a><span class='hs-definition'>coreView</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreExpandTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-13"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-14"></a>               <span class='hs-comment'>-- Its important to use mkAppTys, rather than (foldl AppTy),</span>
<a name="line-15"></a>               <span class='hs-comment'>-- because the function part might well return a</span>
<a name="line-16"></a>               <span class='hs-comment'>-- partially-applied type constructor; indeed, usually will!</span>
<a name="line-17"></a><span class='hs-definition'>coreView</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="tcView"></a><span class='hs-comment'>-----------------------------------------------</span>
<a name="line-20"></a><span class='hs-comment'>{-# INLINE tcView #-}</span>
<a name="line-21"></a><span class='hs-definition'>tcView</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-22"></a><span class='hs-comment'>-- ^ Similar to 'coreView', but for the type checker, which just looks through synonyms</span>
<a name="line-23"></a><span class='hs-definition'>tcView</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExpandTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-24"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>tcView</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-26"></a>  <span class='hs-comment'>-- You might think that tcView belows in TcType rather than Type, but unfortunately</span>
<a name="line-27"></a>  <span class='hs-comment'>-- it is needed by Unify, which is turn imported by Coercion (for MatchEnv and matchList).</span>
<a name="line-28"></a>  <span class='hs-comment'>-- So we will leave it here to avoid module loops.</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="expandTypeSynonyms"></a><span class='hs-comment'>-----------------------------------------------</span>
<a name="line-31"></a><span class='hs-definition'>expandTypeSynonyms</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-32"></a><span class='hs-comment'>-- ^ Expand out all type synonyms.  Actually, it'd suffice to expand out</span>
<a name="line-33"></a><span class='hs-comment'>-- just the ones that discard type variables (e.g.  type Funny a = Int)</span>
<a name="line-34"></a><span class='hs-comment'>-- But we don't know which those are currently, so we just expand all.</span>
<a name="line-35"></a><span class='hs-definition'>expandTypeSynonyms</span> <span class='hs-varid'>ty</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExpandTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-40"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-41"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-42"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-43"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span>
<a name="line-44"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span>
<a name="line-45"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-46"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-47"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Constructor-specific functions}
%*                                                                      *
%************************************************************************


---------------------------------------------------------------------
                                TyVarTy
                                ~~~~~~~
\begin{code}
<pre><a name="line-1"></a><a name="getTyVar"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Type', and panics with the</span>
<a name="line-2"></a><span class='hs-comment'>-- given message if this is not a type variable type. See also 'getTyVar_maybe'</span>
<a name="line-3"></a><span class='hs-definition'>getTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-4"></a><span class='hs-definition'>getTyVar</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-5"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv</span>
<a name="line-6"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"getTyVar: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="isTyVarTy"></a><span class='hs-definition'>isTyVarTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-9"></a><span class='hs-definition'>isTyVarTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="getTyVar_maybe"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Type'</span>
<a name="line-12"></a><span class='hs-definition'>getTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyVar</span>
<a name="line-13"></a><span class='hs-definition'>getTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-14"></a><span class='hs-definition'>getTyVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span>
<a name="line-15"></a><span class='hs-definition'>getTyVar_maybe</span> <span class='hs-keyword'>_</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-16"></a>
</pre>\end{code}


---------------------------------------------------------------------
                                AppTy
                                ~~~~~
We need to be pretty careful with AppTy to make sure we obey the
invariant that a TyConApp is always visibly so.  mkAppTy maintains the
invariant: use it.

\begin{code}
<pre><a name="line-1"></a><a name="mkAppTy"></a><span class='hs-comment'>-- | Applies a type to another, as in e.g. @k a@</span>
<a name="line-2"></a><span class='hs-definition'>mkAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3"></a><span class='hs-definition'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>mkAppTy</span> <span class='hs-varid'>ty1</span>               <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-5"></a>        <span class='hs-comment'>-- Note that the TyConApp could be an</span>
<a name="line-6"></a>        <span class='hs-comment'>-- under-saturated type synonym.  GHC allows that; e.g.</span>
<a name="line-7"></a>        <span class='hs-comment'>--      type Foo k = k a -&gt; k a</span>
<a name="line-8"></a>        <span class='hs-comment'>--      type Id x = x</span>
<a name="line-9"></a>        <span class='hs-comment'>--      foo :: Foo Id -&gt; Foo Id</span>
<a name="line-10"></a>        <span class='hs-comment'>--</span>
<a name="line-11"></a>        <span class='hs-comment'>-- Here Id is partially applied in the type sig for Foo,</span>
<a name="line-12"></a>        <span class='hs-comment'>-- but once the type synonyms are expanded all is well</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="mkAppTys"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-15"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-16"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>mkAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>tys2</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="splitAppTy_maybe"></a><span class='hs-comment'>-------------</span>
<a name="line-20"></a><span class='hs-definition'>splitAppTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-comment'>-- ^ Attempt to take a type application apart, whether it is a</span>
<a name="line-22"></a><span class='hs-comment'>-- function, type constructor, or plain type application. Note</span>
<a name="line-23"></a><span class='hs-comment'>-- that type family applications are NEVER unsaturated by this!</span>
<a name="line-24"></a><span class='hs-definition'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-26"></a><span class='hs-definition'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="repSplitAppTy_maybe"></a><span class='hs-comment'>-------------</span>
<a name="line-29"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-comment'>-- ^ Does the AppTy split as in 'splitAppTy_maybe', but assumes that</span>
<a name="line-31"></a><span class='hs-comment'>-- any Core view stuff is already done</span>
<a name="line-32"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-36"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>tys</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Never create unsaturated type family apps!</span>
<a name="line-38"></a><span class='hs-definition'>repSplitAppTy_maybe</span> <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-39"></a><a name="splitAppTy"></a><span class='hs-comment'>-------------</span>
<a name="line-40"></a><span class='hs-definition'>splitAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-comment'>-- ^ Attempts to take a type application apart, as in 'splitAppTy_maybe',</span>
<a name="line-42"></a><span class='hs-comment'>-- and panics if this is not possible</span>
<a name="line-43"></a><span class='hs-definition'>splitAppTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>pr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pr</span>
<a name="line-45"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"splitAppTy"</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="splitAppTys"></a><span class='hs-comment'>-------------</span>
<a name="line-48"></a><span class='hs-definition'>splitAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-comment'>-- ^ Recursively splits a type as far as is possible, leaving a residual</span>
<a name="line-50"></a><span class='hs-comment'>-- type being applied to and the type arguments applied to it. Never fails,</span>
<a name="line-51"></a><span class='hs-comment'>-- even if that means returning an empty list of type applications.</span>
<a name="line-52"></a><span class='hs-definition'>splitAppTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-53"></a>  <span class='hs-keyword'>where</span>
<a name="line-54"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>args</span>
<a name="line-55"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>        <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-56"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-57"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- keep type families saturated</span>
<a name="line-58"></a>            <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-59"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-60"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tc_args1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tc_args</span>
<a name="line-61"></a>        <span class='hs-keyword'>in</span>
<a name="line-62"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tc_args1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-63"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>       <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span>
<a name="line-64"></a>                                               <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>funTyCon</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-65"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                     <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>orig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
</pre>\end{code}


                      LitTy
                      ~~~~~

\begin{code}
<pre><a name="line-1"></a><a name="mkNumLitTy"></a><span class='hs-definition'>mkNumLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>mkNumLitTy</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="isNumLitTy"></a><span class='hs-comment'>-- | Is this a numeric literal. We also look through type synonyms.</span>
<a name="line-5"></a><span class='hs-definition'>isNumLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Integer</span>
<a name="line-6"></a><span class='hs-definition'>isNumLitTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNumLitTy</span> <span class='hs-varid'>ty1</span>
<a name="line-7"></a><span class='hs-definition'>isNumLitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>NumTyLit</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>
<a name="line-8"></a><span class='hs-definition'>isNumLitTy</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="mkStrLitTy"></a><span class='hs-definition'>mkStrLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-11"></a><span class='hs-definition'>mkStrLitTy</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="isStrLitTy"></a><span class='hs-comment'>-- | Is this a symbol literal. We also look through type synonyms.</span>
<a name="line-14"></a><span class='hs-definition'>isStrLitTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span>
<a name="line-15"></a><span class='hs-definition'>isStrLitTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrLitTy</span> <span class='hs-varid'>ty1</span>
<a name="line-16"></a><span class='hs-definition'>isStrLitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrTyLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span>
<a name="line-17"></a><span class='hs-definition'>isStrLitTy</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-18"></a>
</pre>\end{code}


---------------------------------------------------------------------
                                FunTy
                                ~~~~~

\begin{code}
<pre><a name="line-1"></a><a name="mkFunTy"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-comment'>-- ^ Creates a function type from the given argument and result type</span>
<a name="line-3"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="mkFunTys"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-6"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="isFunTy"></a><span class='hs-definition'>isFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-9"></a><span class='hs-definition'>isFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="splitFunTy"></a><span class='hs-definition'>splitFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-comment'>-- ^ Attempts to extract the argument and result types from a type, and</span>
<a name="line-13"></a><span class='hs-comment'>-- panics if that is not possible. See also 'splitFunTy_maybe'</span>
<a name="line-14"></a><span class='hs-definition'>splitFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTy</span> <span class='hs-varid'>ty'</span>
<a name="line-15"></a><span class='hs-definition'>splitFunTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-definition'>splitFunTy</span> <span class='hs-varid'>other</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"splitFunTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="splitFunTy_maybe"></a><span class='hs-definition'>splitFunTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-comment'>-- ^ Attempts to extract the argument and result types from a type</span>
<a name="line-20"></a><span class='hs-definition'>splitFunTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-21"></a><span class='hs-definition'>splitFunTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-definition'>splitFunTy_maybe</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="splitFunTys"></a><span class='hs-definition'>splitFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>splitFunTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-26"></a>  <span class='hs-keyword'>where</span>
<a name="line-27"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span>
<a name="line-28"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span>
<a name="line-29"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>args</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="splitFunTysN"></a><span class='hs-definition'>splitFunTysN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-comment'>-- ^ Split off exactly the given number argument types, and panics if that is not possible</span>
<a name="line-33"></a><span class='hs-definition'>splitFunTysN</span> <span class='hs-num'>0</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-definition'>splitFunTysN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span>
<a name="line-35"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>splitFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-36"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>splitFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-37"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="zipFunTys"></a><span class='hs-comment'>-- | Splits off argument types from the given type and associating</span>
<a name="line-40"></a><span class='hs-comment'>-- them with the things in the input list from left to right. The</span>
<a name="line-41"></a><span class='hs-comment'>-- final result type is returned, along with the resulting pairs of</span>
<a name="line-42"></a><span class='hs-comment'>-- objects and types, albeit with the list of pairs in reverse order.</span>
<a name="line-43"></a><span class='hs-comment'>-- Panics if there are not enough argument types for the input list.</span>
<a name="line-44"></a><span class='hs-definition'>zipFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-definition'>zipFunTys</span> <span class='hs-varid'>orig_xs</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>orig_xs</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>orig_ty</span>
<a name="line-46"></a>  <span class='hs-keyword'>where</span>
<a name="line-47"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>acc</span> <span class='hs-conid'>[]</span>     <span class='hs-varid'>nty</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>nty</span><span class='hs-layout'>)</span>
<a name="line-48"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>xs</span>     <span class='hs-varid'>nty</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>nty</span> <span class='hs-varid'>ty'</span>
<a name="line-50"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>res</span> <span class='hs-varid'>res</span>
<a name="line-51"></a>    <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zipFunTys"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_xs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="funResultTy"></a><span class='hs-definition'>funResultTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-54"></a><span class='hs-comment'>-- ^ Extract the function result type and panic if that is not possible</span>
<a name="line-55"></a><span class='hs-definition'>funResultTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funResultTy</span> <span class='hs-varid'>ty'</span>
<a name="line-56"></a><span class='hs-definition'>funResultTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-sel'>_arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span>
<a name="line-57"></a><span class='hs-definition'>funResultTy</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"funResultTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="funArgTy"></a><span class='hs-definition'>funArgTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-60"></a><span class='hs-comment'>-- ^ Extract the function argument type and panic if that is not possible</span>
<a name="line-61"></a><span class='hs-definition'>funArgTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funArgTy</span> <span class='hs-varid'>ty'</span>
<a name="line-62"></a><span class='hs-definition'>funArgTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-sel'>_res</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg</span>
<a name="line-63"></a><span class='hs-definition'>funArgTy</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"funArgTy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

---------------------------------------------------------------------
                                TyConApp
                                ~~~~~~~~

\begin{code}
<pre><a name="line-1"></a><a name="mkTyConApp"></a><span class='hs-comment'>-- | A key function: builds a 'TyConApp' or 'FunTy' as apppropriate to</span>
<a name="line-2"></a><span class='hs-comment'>-- its arguments.  Applies its arguments to the constructor from left to right.</span>
<a name="line-3"></a><span class='hs-definition'>mkTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-4"></a><span class='hs-definition'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>-- splitTyConApp "looks through" synonyms, because they don't</span>
<a name="line-12"></a><span class='hs-comment'>-- mean a distinct type, but all other type-constructor applications</span>
<a name="line-13"></a><span class='hs-comment'>-- including functions are returned as Just ..</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="tyConAppTyCon_maybe"></a><span class='hs-comment'>-- | The same as @fst . splitTyConApp@</span>
<a name="line-16"></a><span class='hs-definition'>tyConAppTyCon_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCon</span>
<a name="line-17"></a><span class='hs-definition'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-18"></a><span class='hs-definition'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span>
<a name="line-19"></a><span class='hs-definition'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>funTyCon</span>
<a name="line-20"></a><span class='hs-definition'>tyConAppTyCon_maybe</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="tyConAppTyCon"></a><span class='hs-definition'>tyConAppTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-23"></a><span class='hs-definition'>tyConAppTyCon</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tyConAppTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="tyConAppArgs_maybe"></a><span class='hs-comment'>-- | The same as @snd . splitTyConApp@</span>
<a name="line-26"></a><span class='hs-definition'>tyConAppArgs_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a><span class='hs-definition'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-28"></a><span class='hs-definition'>tyConAppArgs_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span>
<a name="line-29"></a><span class='hs-definition'>tyConAppArgs_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a><span class='hs-definition'>tyConAppArgs_maybe</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-31"></a>
<a name="line-32"></a>
<a name="line-33"></a><a name="tyConAppArgs"></a><span class='hs-definition'>tyConAppArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-34"></a><span class='hs-definition'>tyConAppArgs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tyConAppArgs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="tyConAppArgN"></a><span class='hs-definition'>tyConAppArgN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-37"></a><span class='hs-comment'>-- Executing Nth</span>
<a name="line-38"></a><span class='hs-definition'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>n</span>
<a name="line-41"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tyConAppArgN"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="splitTyConApp"></a><span class='hs-comment'>-- | Attempts to tease a type apart into a type constructor and the application</span>
<a name="line-44"></a><span class='hs-comment'>-- of a number of arguments to that constructor. Panics if that is not possible.</span>
<a name="line-45"></a><span class='hs-comment'>-- See also 'splitTyConApp_maybe'</span>
<a name="line-46"></a><span class='hs-definition'>splitTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-definition'>splitTyConApp</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-48"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>stuff</span>
<a name="line-49"></a>                   <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"splitTyConApp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="splitTyConApp_maybe"></a><span class='hs-comment'>-- | Attempts to tease a type apart into a type constructor and the application</span>
<a name="line-52"></a><span class='hs-comment'>-- of a number of arguments to that constructor</span>
<a name="line-53"></a><span class='hs-definition'>splitTyConApp_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-definition'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty'</span>
<a name="line-55"></a><span class='hs-definition'>splitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-definition'>splitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-definition'>splitTyConApp_maybe</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="newTyConInstRhs"></a><span class='hs-definition'>newTyConInstRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-60"></a><span class='hs-comment'>-- ^ Unwrap one 'layer' of newtype on a type constructor and its</span>
<a name="line-61"></a><span class='hs-comment'>-- arguments, using an eta-reduced version of the @newtype@ if possible.</span>
<a name="line-62"></a><span class='hs-comment'>-- This requires tys to have at least @newTyConInstArity tycon@ elements.</span>
<a name="line-63"></a><span class='hs-definition'>newTyConInstRhs</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span>
<a name="line-64"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span>
<a name="line-65"></a>      <span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span>
<a name="line-66"></a>  <span class='hs-keyword'>where</span>
<a name="line-67"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newTyConEtadRhs</span> <span class='hs-varid'>tycon</span>
<a name="line-68"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
</pre>\end{code}


---------------------------------------------------------------------
                                SynTy
                                ~~~~~

Notes on type synonyms
~~~~~~~~~~~~~~~~~~~~~~
The various "split" functions (splitFunTy, splitRhoTy, splitForAllTy) try
to return type synonyms wherever possible. Thus

        type Foo a = a -> a

we want
        splitFunTys (a -> Foo a) = ([a], Foo a)
not                                ([a], a -> a)

The reason is that we then get better (shorter) type signatures in
interfaces.  Notably this plays a role in tcTySigs in TcBinds.lhs.


                Representation types
                ~~~~~~~~~~~~~~~~~~~~

Note [Nullary unboxed tuple]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We represent the nullary unboxed tuple as the unary (but void) type
Void#.  The reason for this is that the ReprArity is never
less than the Arity (as it would otherwise be for a function type like
(# #) -> Int).

As a result, ReprArity is always strictly positive if Arity is. This
is important because it allows us to distinguish at runtime between a
thunk and a function takes a nullary unboxed tuple as an argument!

\begin{code}
<pre><a name="line-1"></a><a name="UnaryType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UnaryType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="RepType"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RepType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UbxTupleRep</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnaryType</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- INVARIANT: never an empty list (see Note [Nullary unboxed tuple])</span>
<a name="line-4"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnaryRep</span> <span class='hs-conid'>UnaryType</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="flattenRepType"></a><span class='hs-definition'>flattenRepType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RepType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnaryType</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a><span class='hs-definition'>flattenRepType</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupleRep</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-8"></a><span class='hs-definition'>flattenRepType</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnaryRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="repType"></a><span class='hs-comment'>-- | Looks through:</span>
<a name="line-11"></a><span class='hs-comment'>--</span>
<a name="line-12"></a><span class='hs-comment'>--      1. For-alls</span>
<a name="line-13"></a><span class='hs-comment'>--      2. Synonyms</span>
<a name="line-14"></a><span class='hs-comment'>--      3. Predicates</span>
<a name="line-15"></a><span class='hs-comment'>--      4. All newtypes, including recursive ones, but not newtype families</span>
<a name="line-16"></a><span class='hs-comment'>--</span>
<a name="line-17"></a><span class='hs-comment'>-- It's useful in the back end of the compiler.</span>
<a name="line-18"></a><span class='hs-definition'>repType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RepType</span>
<a name="line-19"></a><span class='hs-definition'>repType</span> <span class='hs-varid'>ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>initRecTc</span> <span class='hs-varid'>ty</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecTcChecker</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RepType</span>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span>                       <span class='hs-comment'>-- Expand predicates and synonyms</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty'</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>          <span class='hs-comment'>-- Drop foralls</span>
<a name="line-28"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span>
<a name="line-29"></a>
<a name="line-30"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Expand newtypes</span>
<a name="line-31"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-32"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthAtLeast`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-33"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span>   <span class='hs-comment'>-- See Note [Expanding newtypes] in TyCon</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConInstRhs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-37"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span>
<a name="line-38"></a>         <span class='hs-keyword'>then</span> <span class='hs-conid'>UnaryRep</span> <span class='hs-varid'>voidPrimTy</span> <span class='hs-comment'>-- See Note [Nullary unboxed tuple]</span>
<a name="line-39"></a>         <span class='hs-keyword'>else</span> <span class='hs-conid'>UbxTupleRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenRepType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnaryRep</span> <span class='hs-varid'>ty</span>
<a name="line-42"></a>
<a name="line-43"></a>
<a name="line-44"></a><a name="tyConsOfType"></a><span class='hs-comment'>-- | All type constructors occurring in the type; looking through type</span>
<a name="line-45"></a><span class='hs-comment'>--   synonyms, but not newtypes.</span>
<a name="line-46"></a><span class='hs-comment'>--  When it finds a Class, it returns the class TyCon.</span>
<a name="line-47"></a><span class='hs-definition'>tyConsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a><span class='hs-definition'>tyConsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyword'>where</span>
<a name="line-51"></a>     <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>TyCon</span>  <span class='hs-comment'>-- The NameEnv does duplicate elim</span>
<a name="line-52"></a>     <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-53"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-54"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-55"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-56"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`plusNameEnv`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>b</span>
<a name="line-57"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`plusNameEnv`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>b</span>
<a name="line-58"></a>     <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-59"></a>
<a name="line-60"></a>     <span class='hs-varid'>go_tc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_s</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc</span>
<a name="line-61"></a>     <span class='hs-varid'>go_s</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusNameEnv</span> <span class='hs-varop'>.</span> <span class='hs-varid'>go</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>tys</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>-- ToDo: this could be moved to the code generator, using splitTyConApp instead</span>
<a name="line-64"></a><span class='hs-comment'>-- of inspecting the type directly.</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="typePrimRep"></a><span class='hs-comment'>-- | Discovers the primitive representation of a more abstract 'UnaryType'</span>
<a name="line-67"></a><span class='hs-definition'>typePrimRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnaryType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimRep</span>
<a name="line-68"></a><span class='hs-definition'>typePrimRep</span> <span class='hs-varid'>ty</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>repType</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-70"></a>      <span class='hs-conid'>UbxTupleRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"typePrimRep: UbxTupleRep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-71"></a>      <span class='hs-conid'>UnaryRep</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rep</span> <span class='hs-keyword'>of</span>
<a name="line-72"></a>        <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tyConPrimRep</span> <span class='hs-varid'>tc</span>
<a name="line-73"></a>        <span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PtrRep</span>
<a name="line-74"></a>        <span class='hs-conid'>AppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PtrRep</span>      <span class='hs-comment'>-- See Note [AppTy rep]</span>
<a name="line-75"></a>        <span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PtrRep</span>
<a name="line-76"></a>        <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"typePrimRep: UnaryRep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="typeRepArity"></a><span class='hs-definition'>typeRepArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RepArity</span>
<a name="line-79"></a><span class='hs-definition'>typeRepArity</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-80"></a><span class='hs-definition'>typeRepArity</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>repType</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-81"></a>  <span class='hs-conid'>UnaryRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenRepType</span> <span class='hs-layout'>(</span><span class='hs-varid'>repType</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeRepArity</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-82"></a>  <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"typeRepArity: arity greater than type can handle"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="isVoidTy"></a><span class='hs-definition'>isVoidTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-85"></a><span class='hs-comment'>-- True if the type has zero width</span>
<a name="line-86"></a><span class='hs-definition'>isVoidTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>repType</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-87"></a>                <span class='hs-conid'>UnaryRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isVoidRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [AppTy rep]
~~~~~~~~~~~~~~~~
Types of the form 'f a' must be of kind *, not #, so we are guaranteed
that they are represented by pointers.  The reason is that f must have
kind (kk -> kk) and kk cannot be unlifted; see Note [The kind invariant]
in TypeRep.

---------------------------------------------------------------------
                                ForAllTy
                                ~~~~~~~~

\begin{code}
<pre><a name="line-1"></a><a name="mkForAllTy"></a><span class='hs-definition'>mkForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>mkForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="mkForAllTys"></a><span class='hs-comment'>-- | Wraps foralls over the type using the provided 'TyVar's from left to right</span>
<a name="line-6"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-7"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tyvars</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="mkPiKinds"></a><span class='hs-definition'>mkPiKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-10"></a><span class='hs-comment'>-- mkPiKinds [k1, k2, (a:k1 -&gt; *)] k2</span>
<a name="line-11"></a><span class='hs-comment'>-- returns forall k1 k2. (k1 -&gt; *) -&gt; k2</span>
<a name="line-12"></a><span class='hs-definition'>mkPiKinds</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span>
<a name="line-13"></a><span class='hs-definition'>mkPiKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span>          <span class='hs-layout'>(</span><span class='hs-varid'>mkPiKinds</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiKinds</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="mkPiType"></a><span class='hs-definition'>mkPiType</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-18"></a><a name="mkPiTypes"></a><span class='hs-comment'>-- ^ Makes a @(-&gt;)@ type or a forall type, depending</span>
<a name="line-19"></a><span class='hs-comment'>-- on whether it is given a type variable or a term variable.</span>
<a name="line-20"></a><span class='hs-definition'>mkPiTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-21"></a><span class='hs-comment'>-- ^ 'mkPiType' for multiple type or value arguments</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>mkPiType</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-24"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>v</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>mkPiTypes</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkPiType</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>vs</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="isForAllTy"></a><span class='hs-definition'>isForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-30"></a><span class='hs-definition'>isForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-31"></a><span class='hs-definition'>isForAllTy</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="splitForAllTy_maybe"></a><span class='hs-comment'>-- | Attempts to take a forall type apart, returning the bound type variable</span>
<a name="line-34"></a><span class='hs-comment'>-- and the remainder of the type</span>
<a name="line-35"></a><span class='hs-definition'>splitForAllTy_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-definition'>splitForAllTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFAT_m</span> <span class='hs-varid'>ty</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>splitFAT_m</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFAT_m</span> <span class='hs-varid'>ty'</span>
<a name="line-39"></a>    <span class='hs-varid'>splitFAT_m</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span><span class='hs-layout'>(</span><span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-40"></a>    <span class='hs-varid'>splitFAT_m</span> <span class='hs-keyword'>_</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="splitForAllTys"></a><span class='hs-comment'>-- | Attempts to take a forall type apart, returning all the immediate such bound</span>
<a name="line-43"></a><span class='hs-comment'>-- type variables and the remainder of the type. Always suceeds, even if that means</span>
<a name="line-44"></a><span class='hs-comment'>-- returning an empty list of 'TyVar's</span>
<a name="line-45"></a><span class='hs-definition'>splitForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-definition'>splitForAllTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-47"></a>   <span class='hs-keyword'>where</span>
<a name="line-48"></a>     <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>tvs</span>
<a name="line-49"></a>     <span class='hs-varid'>split</span> <span class='hs-keyword'>_</span>       <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-50"></a>     <span class='hs-varid'>split</span> <span class='hs-varid'>orig_ty</span> <span class='hs-keyword'>_</span>                 <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="dropForAlls"></a><span class='hs-comment'>-- | Equivalent to @snd . splitForAllTys@</span>
<a name="line-53"></a><span class='hs-definition'>dropForAlls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-54"></a><span class='hs-definition'>dropForAlls</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

-- (mkPiType now in CoreUtils)

applyTy, applyTys
~~~~~~~~~~~~~~~~~

\begin{code}
<pre><a name="line-1"></a><a name="applyTy"></a><span class='hs-comment'>-- | Instantiate a forall type with one or more type arguments.</span>
<a name="line-2"></a><span class='hs-comment'>-- Used when we have a polymorphic function applied to type args:</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>-- &gt; f t1 t2</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- We use @applyTys type-of-f [t1,t2]@ to compute the type of the expression.</span>
<a name="line-7"></a><span class='hs-comment'>-- Panics if no application is possible.</span>
<a name="line-8"></a><span class='hs-definition'>applyTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindOrType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-9"></a><span class='hs-definition'>applyTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyTy</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>arg</span>
<a name="line-10"></a><span class='hs-definition'>applyTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty</span>
<a name="line-11"></a><span class='hs-definition'>applyTy</span> <span class='hs-keyword'>_</span>                <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"applyTy"</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="applyTys"></a><span class='hs-definition'>applyTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindOrType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-14"></a><span class='hs-comment'>-- ^ This function is interesting because:</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>--      1. The function may have more for-alls than there are args</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>--      2. Less obviously, it may have fewer for-alls</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- For case 2. think of:</span>
<a name="line-21"></a><span class='hs-comment'>--</span>
<a name="line-22"></a><span class='hs-comment'>-- &gt; applyTys (forall a.a) [forall b.b, Int]</span>
<a name="line-23"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><span class='hs-comment'>-- This really can happen, but only (I think) in situations involving</span>
<a name="line-25"></a><span class='hs-comment'>-- undefined.  For example:</span>
<a name="line-26"></a><span class='hs-comment'>--       undefined :: forall a. a</span>
<a name="line-27"></a><span class='hs-comment'>-- Term: undefined @(forall b. b-&gt;b) @Int</span>
<a name="line-28"></a><span class='hs-comment'>-- This term should have type (Int -&gt; Int), but notice that</span>
<a name="line-29"></a><span class='hs-comment'>-- there are more type args than foralls in 'undefined's type.</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-comment'>-- If you edit this function, you may need to update the GHC formalism</span>
<a name="line-32"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.lhs</span>
<a name="line-33"></a><span class='hs-definition'>applyTys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyTysD</span> <span class='hs-varid'>empty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>args</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="applyTysD"></a><span class='hs-definition'>applyTysD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>     <span class='hs-comment'>-- Debug version</span>
<a name="line-36"></a><span class='hs-definition'>applyTysD</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>orig_fun_ty</span> <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_fun_ty</span>
<a name="line-37"></a><span class='hs-definition'>applyTysD</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>orig_fun_ty</span> <span class='hs-varid'>arg_tys</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_args</span>     <span class='hs-comment'>-- The vastly common case</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>rho_ty</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_tvs</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n_args</span>      <span class='hs-comment'>-- Too many for-alls</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>n_args</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-42"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>n_args</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-comment'>-- Too many type args</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>n_tvs</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_fun_ty</span> <span class='hs-layout'>)</span>        <span class='hs-comment'>-- Zero case gives infnite loop!</span>
<a name="line-45"></a>    <span class='hs-varid'>applyTysD</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>n_tvs</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span>
<a name="line-46"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>n_tvs</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-47"></a>  <span class='hs-keyword'>where</span>
<a name="line-48"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>orig_fun_ty</span>
<a name="line-49"></a>    <span class='hs-varid'>n_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span>
<a name="line-50"></a>    <span class='hs-varid'>n_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                         Pred
%*                                                                      *
%************************************************************************

Predicates on PredType

\begin{code}
<pre><a name="line-1"></a><a name="noParenPred"></a><span class='hs-definition'>noParenPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-comment'>-- A predicate that can appear without parens before a "=&gt;"</span>
<a name="line-3"></a><span class='hs-comment'>--       C a =&gt; a -&gt; a</span>
<a name="line-4"></a><span class='hs-comment'>--       a~b =&gt; a -&gt; b</span>
<a name="line-5"></a><span class='hs-comment'>-- But   (?x::Int) =&gt; Int -&gt; Int</span>
<a name="line-6"></a><span class='hs-definition'>noParenPred</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isIPPred</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isClassPred</span> <span class='hs-varid'>p</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isEqPred</span> <span class='hs-varid'>p</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="isPredTy"></a><span class='hs-definition'>isPredTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-9"></a>  <span class='hs-comment'>-- NB: isPredTy is used when printing types, which can happen in debug printing</span>
<a name="line-10"></a>  <span class='hs-comment'>--     during type checking of not-fully-zonked types.  So it's not cool to say</span>
<a name="line-11"></a>  <span class='hs-comment'>--     isConstraintKind (typeKind ty) because absent zonking the type might </span>
<a name="line-12"></a>  <span class='hs-comment'>--     be ill-kinded, and typeKind crashes</span>
<a name="line-13"></a>  <span class='hs-comment'>--     Hence the rather tiresome story here</span>
<a name="line-14"></a><span class='hs-definition'>isPredTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindOrType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-17"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_k</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_k</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-varid'>go_k</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindOrType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-23"></a>    <span class='hs-comment'>-- True &lt;=&gt; kind is k1 -&gt; .. -&gt; kn -&gt; Constraint</span>
<a name="line-24"></a>    <span class='hs-varid'>go_k</span> <span class='hs-varid'>k</span>                <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>k</span>
<a name="line-25"></a>    <span class='hs-varid'>go_k</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>     <span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_k</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>args</span>
<a name="line-26"></a>    <span class='hs-varid'>go_k</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>kv</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>k2</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_k</span> <span class='hs-layout'>(</span><span class='hs-varid'>substKiWith</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-27"></a>    <span class='hs-varid'>go_k</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>                  <span class='hs-comment'>-- Typeable * Int :: Constraint</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="isClassPred"></a><span class='hs-definition'>isClassPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIPPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-30"></a><span class='hs-definition'>isClassPred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-31"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>tyCon</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-varid'>tyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-32"></a>    <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-33"></a><a name="isEqPred"></a><span class='hs-definition'>isEqPred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>tyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tyCon</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-35"></a>    <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="isIPPred"></a><span class='hs-definition'>isIPPred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isIPTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-39"></a>    <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="isIPTyCon"></a><span class='hs-definition'>isIPTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-42"></a><span class='hs-definition'>isIPTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ipClassNameKey</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="isIPClass"></a><span class='hs-definition'>isIPClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-45"></a><span class='hs-definition'>isIPClass</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>ipClassNameKey</span>
<a name="line-46"></a>  <span class='hs-comment'>-- Class and it corresponding TyCon have the same Unique</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="isIPPred_maybe"></a><span class='hs-definition'>isIPPred_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FastString</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>isIPPred_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-50"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-51"></a>     <span class='hs-varid'>guard</span> <span class='hs-layout'>(</span><span class='hs-varid'>isIPTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-52"></a>     <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isStrLitTy</span> <span class='hs-varid'>t1</span>
<a name="line-53"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
</pre>\end{code}

Make PredTypes

--------------------- Equality types ---------------------------------
\begin{code}
<pre><a name="line-1"></a><a name="mkEqPred"></a><span class='hs-comment'>-- | Creates a type equality predicate</span>
<a name="line-2"></a><span class='hs-definition'>mkEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-3"></a><span class='hs-definition'>mkEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-5"></a>    <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>eqTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="mkCoerciblePred"></a><span class='hs-definition'>mkCoerciblePred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-10"></a><span class='hs-definition'>mkCoerciblePred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>coercibleTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="mkPrimEqPred"></a><span class='hs-definition'>mkPrimEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-17"></a><span class='hs-definition'>mkPrimEqPred</span> <span class='hs-varid'>ty1</span>  <span class='hs-varid'>ty2</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>)</span>
<a name="line-19"></a>    <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>eqPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="mkReprPrimEqPred"></a><span class='hs-definition'>mkReprPrimEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-24"></a><span class='hs-definition'>mkReprPrimEqPred</span> <span class='hs-varid'>ty1</span>  <span class='hs-varid'>ty2</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>eqReprPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a>  <span class='hs-keyword'>where</span>
<a name="line-28"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
</pre>\end{code}

--------------------- Dictionary types ---------------------------------
\begin{code}
<pre><a name="line-1"></a><a name="mkClassPred"></a><span class='hs-definition'>mkClassPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-2"></a><span class='hs-definition'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="isDictTy"></a><span class='hs-definition'>isDictTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a><span class='hs-definition'>isDictTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isClassPred</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="isDictLikeTy"></a><span class='hs-definition'>isDictLikeTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-8"></a><span class='hs-comment'>-- Note [Dictionary-like types]</span>
<a name="line-9"></a><span class='hs-definition'>isDictLikeTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDictLikeTy</span> <span class='hs-varid'>ty'</span>
<a name="line-10"></a><span class='hs-definition'>isDictLikeTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-12"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isDictLikeTy</span> <span class='hs-varid'>tys</span>
<a name="line-13"></a>        <span class='hs-sel'>_other</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Note [Dictionary-like types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Being "dictionary-like" means either a dictionary type or a tuple thereof.
In GHC 6.10 we build implication constraints which construct such tuples,
and if we land up with a binding
    t :: (C [a], Eq [a])
    t = blah
then we want to treat t as cheap under "-fdicts-cheap" for example.
(Implication constraints are normally inlined, but sadly not if the
occurrence is itself inside an INLINE function!  Until we revise the
handling of implication constraints, that is.)  This turned out to
be important in getting good arities in DPH code.  Example:

    class C a
    class D a where { foo :: a -> a }
    instance C a => D (Maybe a) where { foo x = x }

    bar :: (C a, C b) => a -> b -> (Maybe a, Maybe b)
    {-# INLINE bar #-}
    bar x y = (foo (Just x), foo (Just y))

Then 'bar' should jolly well have arity 4 (two dicts, two args), but
we ended up with something like
   bar = __inline_me__ (\d1,d2. let t :: (D (Maybe a), D (Maybe b)) = ...
                                in \x,y. <blah>)

This is all a bit ad-hoc; eg it relies on knowing that implication
constraints build tuples.


Decomposing PredType

\begin{code}
<pre><a name="line-1"></a><a name="PredTree"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PredTree</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClassPred</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EqPred</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>
<a name="line-3"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TuplePred</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IrredPred</span> <span class='hs-conid'>PredType</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="classifyPredType"></a><span class='hs-definition'>classifyPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredTree</span>
<a name="line-7"></a><span class='hs-definition'>classifyPredType</span> <span class='hs-varid'>ev_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ev_ty</span> <span class='hs-keyword'>of</span>
<a name="line-8"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-9"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-10"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-11"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-12"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-13"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-14"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TuplePred</span> <span class='hs-varid'>tys</span>
<a name="line-15"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IrredPred</span> <span class='hs-varid'>ev_ty</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="getClassPredTys"></a><span class='hs-definition'>getClassPredTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>getClassPredTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-3"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-4"></a>        <span class='hs-conid'>Nothing</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getClassPredTys"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="getClassPredTys_maybe"></a><span class='hs-definition'>getClassPredTys_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>getClassPredTys_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-8"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-9"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="getEqPredTys"></a><span class='hs-definition'>getEqPredTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>getEqPredTys</span> <span class='hs-varid'>ty</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-14"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ty1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ty2</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-15"></a>        <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>coercibleTyConKey</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-16"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-17"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getEqPredTys"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="getEqPredTys_maybe"></a><span class='hs-definition'>getEqPredTys_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Role</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>getEqPredTys_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-22"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-23"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-24"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>coercibleTyConKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-25"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="getEqPredRole"></a><span class='hs-definition'>getEqPredRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-28"></a><span class='hs-definition'>getEqPredRole</span> <span class='hs-varid'>ty</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-30"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-31"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nominal</span>
<a name="line-32"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>coercibleTyConKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Representational</span>
<a name="line-33"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getEqPredRole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                   Size
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="typeSize"></a><span class='hs-definition'>typeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-3"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-4"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-5"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-6"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t</span>
<a name="line-7"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Type families}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkFamilyTyConApp"></a><span class='hs-definition'>mkFamilyTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-comment'>-- ^ Given a family instance TyCon and its arg types, return the</span>
<a name="line-3"></a><span class='hs-comment'>-- corresponding family type.  E.g:</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- &gt; data family T a</span>
<a name="line-6"></a><span class='hs-comment'>-- &gt; data instance T (Maybe b) = MkT b</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- Where the instance tycon is :RTL, so:</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-- &gt; mkFamilyTyConApp :RTL Int  =  T (Maybe Int)</span>
<a name="line-11"></a><span class='hs-definition'>mkFamilyTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-14"></a>        <span class='hs-varid'>fam_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-15"></a>                    <span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>fam_subst</span> <span class='hs-varid'>fam_tys</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="coAxNthLHS"></a><span class='hs-comment'>-- | Get the type on the LHS of a coercion induced by a type/data</span>
<a name="line-21"></a><span class='hs-comment'>-- family instance.</span>
<a name="line-22"></a><span class='hs-definition'>coAxNthLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-23"></a><span class='hs-definition'>coAxNthLHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-keyglyph'>=</span>
<a name="line-24"></a>  <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchLHS</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="pprSourceTyCon"></a><span class='hs-comment'>-- | Pretty prints a 'TyCon', using the family instance in case of a</span>
<a name="line-27"></a><span class='hs-comment'>-- representation tycon.  For example:</span>
<a name="line-28"></a><span class='hs-comment'>--</span>
<a name="line-29"></a><span class='hs-comment'>-- &gt; data T [a] = ...</span>
<a name="line-30"></a><span class='hs-comment'>--</span>
<a name="line-31"></a><span class='hs-comment'>-- In that case we want to print @T [a]@, where @T@ is the family 'TyCon'</span>
<a name="line-32"></a><span class='hs-definition'>pprSourceTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-33"></a><span class='hs-definition'>pprSourceTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varop'>`TyConApp`</span> <span class='hs-varid'>tys</span>        <span class='hs-comment'>-- can't be FunTyCon</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Liftedness}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="isUnLiftedType"></a><span class='hs-comment'>-- | See "Type#type_classification" for what an unlifted type is</span>
<a name="line-2"></a><span class='hs-definition'>isUnLiftedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a>        <span class='hs-comment'>-- isUnLiftedType returns True for forall'd unlifted types:</span>
<a name="line-4"></a>        <span class='hs-comment'>--      x :: forall a. Int#</span>
<a name="line-5"></a>        <span class='hs-comment'>-- I found bindings like these were getting floated to the top level.</span>
<a name="line-6"></a>        <span class='hs-comment'>-- They are pretty bogus types, mind you.  It would be better never to</span>
<a name="line-7"></a>        <span class='hs-comment'>-- construct them</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>isUnLiftedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>ty'</span>
<a name="line-10"></a><span class='hs-definition'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>ty</span>
<a name="line-11"></a><span class='hs-definition'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-12"></a><span class='hs-definition'>isUnLiftedType</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="isUnboxedTupleType"></a><span class='hs-definition'>isUnboxedTupleType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-15"></a><span class='hs-definition'>isUnboxedTupleType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-16"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-17"></a>                           <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="isAlgType"></a><span class='hs-comment'>-- | See "Type#type_classification" for what an algebraic type is.</span>
<a name="line-20"></a><span class='hs-comment'>-- Should only be applied to /types/, as opposed to e.g. partially</span>
<a name="line-21"></a><span class='hs-comment'>-- saturated type constructors</span>
<a name="line-22"></a><span class='hs-definition'>isAlgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-23"></a><span class='hs-definition'>isAlgType</span> <span class='hs-varid'>ty</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ty_args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>)</span>
<a name="line-26"></a>                            <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-27"></a>      <span class='hs-sel'>_other</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="isClosedAlgType"></a><span class='hs-comment'>-- | See "Type#type_classification" for what an algebraic type is.</span>
<a name="line-30"></a><span class='hs-comment'>-- Should only be applied to /types/, as opposed to e.g. partially</span>
<a name="line-31"></a><span class='hs-comment'>-- saturated type constructors. Closed type constructors are those</span>
<a name="line-32"></a><span class='hs-comment'>-- with a fixed right hand side, as opposed to e.g. associated types</span>
<a name="line-33"></a><span class='hs-definition'>isClosedAlgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-34"></a><span class='hs-definition'>isClosedAlgType</span> <span class='hs-varid'>ty</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-36"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-37"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>ty_args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-38"></a>      <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- | Computes whether an argument (or let right hand side) should</span>
<a name="line-2"></a><span class='hs-comment'>-- be computed strictly or lazily, based only on its type.</span>
<a name="line-3"></a><span class='hs-comment'>-- Currently, it's just 'isUnLiftedType'.</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="isStrictType"></a><span class='hs-definition'>isStrictType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-6"></a><span class='hs-definition'>isStrictType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedType</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="isPrimitiveType"></a><span class='hs-definition'>isPrimitiveType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-comment'>-- ^ Returns true of types that are opaque to Haskell.</span>
<a name="line-3"></a><span class='hs-comment'>-- Most of these are unlifted, but now that we interact with .NET, we</span>
<a name="line-4"></a><span class='hs-comment'>-- may have primtive (foreign-imported) types that are lifted</span>
<a name="line-5"></a><span class='hs-definition'>isPrimitiveType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-6"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ty_args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>)</span>
<a name="line-7"></a>                                              <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-8"></a>                        <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Sequencing on types}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="seqType"></a><span class='hs-definition'>seqType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-4"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t2</span>
<a name="line-5"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t2</span>
<a name="line-6"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqTypes</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a><span class='hs-definition'>seqType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="seqTypes"></a><span class='hs-definition'>seqTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-10"></a><span class='hs-definition'>seqTypes</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-11"></a><span class='hs-definition'>seqTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqTypes</span> <span class='hs-varid'>tys</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Comparision for types
        (We don't use instances so that we know where it happens)
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="eqKind"></a><span class='hs-definition'>eqKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-comment'>-- Watch out for horrible hack: See Note [Comparison with OpenTypeKind]</span>
<a name="line-3"></a><span class='hs-definition'>eqKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="eqType"></a><span class='hs-definition'>eqType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-6"></a><span class='hs-comment'>-- ^ Type equality on source types. Does not look through @newtypes@ or</span>
<a name="line-7"></a><span class='hs-comment'>-- 'PredType's, but it does look through type synonyms.</span>
<a name="line-8"></a><span class='hs-comment'>-- Watch out for horrible hack: See Note [Comparison with OpenTypeKind]</span>
<a name="line-9"></a><span class='hs-definition'>eqType</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqual</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cmpType</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="eqTypeX"></a><span class='hs-definition'>eqTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-12"></a><span class='hs-definition'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqual</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="eqTypes"></a><span class='hs-definition'>eqTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-15"></a><span class='hs-definition'>eqTypes</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqual</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cmpTypes</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="eqPred"></a><span class='hs-definition'>eqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-18"></a><span class='hs-definition'>eqPred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="eqPredX"></a><span class='hs-definition'>eqPredX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-21"></a><span class='hs-definition'>eqPredX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqual</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="eqTyVarBndrs"></a><span class='hs-definition'>eqTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>RnEnv2</span>
<a name="line-24"></a><span class='hs-comment'>-- Check that the tyvar lists are the same length</span>
<a name="line-25"></a><span class='hs-comment'>-- and have matching kinds; if so, extend the RnEnv2</span>
<a name="line-26"></a><span class='hs-comment'>-- Returns Nothing if they don't match</span>
<a name="line-27"></a><span class='hs-definition'>eqTyVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-28"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span>
<a name="line-29"></a><span class='hs-definition'>eqTyVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv1</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv2</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span>
<a name="line-30"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-31"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqTyVarBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>tvs2</span>
<a name="line-32"></a><span class='hs-definition'>eqTyVarBndrs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

Now here comes the real worker

\begin{code}
<pre><a name="line-1"></a><a name="cmpType"></a><span class='hs-definition'>cmpType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-2"></a><span class='hs-comment'>-- Watch out for horrible hack: See Note [Comparison with OpenTypeKind]</span>
<a name="line-3"></a><span class='hs-definition'>cmpType</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="cmpTypes"></a><span class='hs-definition'>cmpTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-8"></a><span class='hs-definition'>cmpTypes</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypesX</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>ts1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>ts2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="cmpPred"></a><span class='hs-definition'>cmpPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-13"></a><span class='hs-definition'>cmpPred</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="cmpTypeX"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>  <span class='hs-comment'>-- Main workhorse</span>
<a name="line-18"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2</span>
<a name="line-19"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2'</span>
<a name="line-20"></a><span class='hs-comment'>-- We expand predicate types, because in Core-land we have</span>
<a name="line-21"></a><span class='hs-comment'>-- lots of definitions like</span>
<a name="line-22"></a><span class='hs-comment'>--      fOrdBool :: Ord Bool</span>
<a name="line-23"></a><span class='hs-comment'>--      fOrdBool = D:Ord .. .. ..</span>
<a name="line-24"></a><span class='hs-comment'>-- So the RHS has a data type</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>rnOccR</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv2</span>
<a name="line-27"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-28"></a>                                                       <span class='hs-varop'>`thenCmp`</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-29"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>`thenCmp`</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-30"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varop'>`thenCmp`</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-31"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span> <span class='hs-varop'>`cmpTc`</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`thenCmp`</span> <span class='hs-varid'>cmpTypesX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-32"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span>          <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span>
<a name="line-33"></a>
<a name="line-34"></a>    <span class='hs-comment'>-- Deal with the rest: TyVarTy &lt; AppTy &lt; FunTy &lt; LitTy &lt; TyConApp &lt; ForAllTy &lt; PredTy</span>
<a name="line-35"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-38"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-41"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-42"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-45"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-46"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-47"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-50"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-51"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-52"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-53"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>cmpTypeX</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="cmpTypesX"></a><span class='hs-comment'>-------------</span>
<a name="line-58"></a><span class='hs-definition'>cmpTypesX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-59"></a><span class='hs-definition'>cmpTypesX</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>        <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-60"></a><span class='hs-definition'>cmpTypesX</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2</span><span class='hs-conop'>:</span><span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varop'>`thenCmp`</span> <span class='hs-varid'>cmpTypesX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-61"></a><span class='hs-definition'>cmpTypesX</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>        <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-62"></a><span class='hs-definition'>cmpTypesX</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span>         <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="cmpTc"></a><span class='hs-comment'>-------------</span>
<a name="line-65"></a><span class='hs-definition'>cmpTc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-66"></a><span class='hs-comment'>-- Here we treat * and Constraint as equal</span>
<a name="line-67"></a><span class='hs-comment'>-- See Note [Kind Constraint and kind *] in Kinds.lhs</span>
<a name="line-68"></a><span class='hs-comment'>--</span>
<a name="line-69"></a><span class='hs-comment'>-- Also we treat OpenTypeKind as equal to either * or #</span>
<a name="line-70"></a><span class='hs-comment'>-- See Note [Comparison with OpenTypeKind]</span>
<a name="line-71"></a><span class='hs-definition'>cmpTc</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tc2</span> 
<a name="line-72"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>u1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>openTypeKindTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSubOpenTypeKindKey</span> <span class='hs-varid'>u2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>u2</span> <span class='hs-varop'>==</span> <span class='hs-varid'>openTypeKindTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSubOpenTypeKindKey</span> <span class='hs-varid'>u1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nu1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>nu2</span>
<a name="line-75"></a>  <span class='hs-keyword'>where</span>
<a name="line-76"></a>    <span class='hs-varid'>u1</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConUnique</span> <span class='hs-varid'>tc1</span>
<a name="line-77"></a>    <span class='hs-varid'>nu1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>u1</span><span class='hs-varop'>==</span><span class='hs-varid'>constraintKindTyConKey</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>liftedTypeKindTyConKey</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>u1</span>
<a name="line-78"></a>    <span class='hs-varid'>u2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConUnique</span> <span class='hs-varid'>tc2</span>
<a name="line-79"></a>    <span class='hs-varid'>nu2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>u2</span><span class='hs-varop'>==</span><span class='hs-varid'>constraintKindTyConKey</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>liftedTypeKindTyConKey</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>u2</span>
</pre>\end{code}

Note [Comparison with OpenTypeKind]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In PrimOpWrappers we have things like
   PrimOpWrappers.mkWeak# = /\ a b c. Prim.mkWeak# a b c
where
   Prim.mkWeak# :: forall (a:Open) b c. a -> b -> c 
                                     -> State# RealWorld -> (# State# RealWorld, Weak# b #)
Now, eta reduction will turn the definition into
     PrimOpWrappers.mkWeak# = Prim.mkWeak#
which is kind-of OK, but now the types aren't really equal.  So HACK HACK
we pretend (in Core) that Open is equal to * or #.  I hate this.

Note [cmpTypeX]
~~~~~~~~~~~~~~~

When we compare foralls, we should look at the kinds. But if we do so,
we get a corelint error like the following (in
libraries/ghc-prim/GHC/PrimopWrappers.hs):

    Binder's type: forall (o_abY :: *).
                   o_abY
                   -> GHC.Prim.State# GHC.Prim.RealWorld
                   -> GHC.Prim.State# GHC.Prim.RealWorld
    Rhs type: forall (a_12 :: ?).
              a_12
              -> GHC.Prim.State# GHC.Prim.RealWorld
              -> GHC.Prim.State# GHC.Prim.RealWorld

This is why we don't look at the kind. Maybe we should look if the
kinds are compatible.

-- cmpTypeX env (ForAllTy tv1 t1)   (ForAllTy tv2 t2)
--   = cmpTypeX env (tyVarKind tv1) (tyVarKind tv2) `thenCmp`
--     cmpTypeX (rnBndr2 env tv1 tv2) t1 t2

%************************************************************************
%*                                                                      *
                Type substitutions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="emptyTvSubstEnv"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-2"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="composeTvSubst"></a><span class='hs-definition'>composeTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-5"></a><span class='hs-comment'>-- ^ @(compose env1 env2)(x)@ is @env1(env2(x))@; i.e. apply @env2@ then @env1@.</span>
<a name="line-6"></a><span class='hs-comment'>-- It assumes that both are idempotent.</span>
<a name="line-7"></a><span class='hs-comment'>-- Typically, @env1@ is the refinement to a base substitution @env2@</span>
<a name="line-8"></a><span class='hs-definition'>composeTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>env2</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env1</span> <span class='hs-varop'>`plusVarEnv`</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>env2</span>
<a name="line-10"></a>        <span class='hs-comment'>-- First apply env1 to the range of env2</span>
<a name="line-11"></a>        <span class='hs-comment'>-- Then combine the two, making sure that env1 loses if</span>
<a name="line-12"></a>        <span class='hs-comment'>-- both bind the same variable; that's why env1 is the</span>
<a name="line-13"></a>        <span class='hs-comment'>--  *left* argument to plusVarEnv, because the right arg wins</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>subst1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>env1</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="emptyTvSubst"></a><span class='hs-definition'>emptyTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span>
<a name="line-18"></a><span class='hs-definition'>emptyTvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>emptyTvSubstEnv</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="isEmptyTvSubst"></a><span class='hs-definition'>isEmptyTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-21"></a>         <span class='hs-comment'>-- See Note [Extending the TvSubstEnv]</span>
<a name="line-22"></a><span class='hs-definition'>isEmptyTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tenv</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="mkTvSubst"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-25"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="getTvSubstEnv"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-28"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="getTvInScope"></a><span class='hs-definition'>getTvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-31"></a><span class='hs-definition'>getTvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="isInScope"></a><span class='hs-definition'>isInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-34"></a><span class='hs-definition'>isInScope</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemInScopeSet`</span> <span class='hs-varid'>in_scope</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="notElemTvSubst"></a><span class='hs-definition'>notElemTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-37"></a><span class='hs-definition'>notElemTvSubst</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="setTvSubstEnv"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-40"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="zapTvSubstEnv"></a><span class='hs-definition'>zapTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-43"></a><span class='hs-definition'>zapTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="extendTvInScope"></a><span class='hs-definition'>extendTvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-46"></a><span class='hs-definition'>extendTvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="extendTvInScopeList"></a><span class='hs-definition'>extendTvInScopeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-49"></a><span class='hs-definition'>extendTvInScopeList</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetList</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="extendTvSubst"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-52"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="extendTvSubstList"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-55"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>tenv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="unionTvSubst"></a><span class='hs-definition'>unionTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-59"></a><span class='hs-comment'>-- Works when the ranges are disjoint</span>
<a name="line-60"></a><span class='hs-definition'>unionTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope1</span> <span class='hs-varid'>tenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope2</span> <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span> <span class='hs-varop'>`intersectsVarEnv`</span> <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-62"></a>    <span class='hs-conid'>TvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>in_scope2</span><span class='hs-layout'>)</span>
<a name="line-63"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span>     <span class='hs-varop'>`plusVarEnv`</span>   <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-comment'>-- mkOpenTvSubst and zipOpenTvSubst generate the in-scope set from</span>
<a name="line-66"></a><span class='hs-comment'>-- the types given; but it's just a thunk so with a bit of luck</span>
<a name="line-67"></a><span class='hs-comment'>-- it'll never be evaluated</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-comment'>-- Note [Generating the in-scope set for a substitution]</span>
<a name="line-70"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-71"></a><span class='hs-comment'>-- If we want to substitute [a -&gt; ty1, b -&gt; ty2] I used to</span>
<a name="line-72"></a><span class='hs-comment'>-- think it was enough to generate an in-scope set that includes</span>
<a name="line-73"></a><span class='hs-comment'>-- fv(ty1,ty2).  But that's not enough; we really should also take the</span>
<a name="line-74"></a><span class='hs-comment'>-- free vars of the type we are substituting into!  Example:</span>
<a name="line-75"></a><span class='hs-comment'>--      (forall b. (a,b,x)) [a -&gt; List b]</span>
<a name="line-76"></a><span class='hs-comment'>-- Then if we use the in-scope set {b}, there is a danger we will rename</span>
<a name="line-77"></a><span class='hs-comment'>-- the forall'd variable to 'x' by mistake, getting this:</span>
<a name="line-78"></a><span class='hs-comment'>--      (forall x. (List b, x, x)</span>
<a name="line-79"></a><span class='hs-comment'>-- Urk!  This means looking at all the calls to mkOpenTvSubst....</span>
<a name="line-80"></a>
<a name="line-81"></a>
<a name="line-82"></a><a name="mkOpenTvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TvSubst' from the types in the incoming</span>
<a name="line-83"></a><span class='hs-comment'>-- environment, hence "open"</span>
<a name="line-84"></a><span class='hs-definition'>mkOpenTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-85"></a><span class='hs-definition'>mkOpenTvSubst</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="zipOpenTvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TvSubst' from the types in the incoming</span>
<a name="line-88"></a><span class='hs-comment'>-- environment, hence "open"</span>
<a name="line-89"></a><span class='hs-definition'>zipOpenTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-90"></a><span class='hs-definition'>zipOpenTvSubst</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipOpenTvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubst</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="mkTopTvSubst"></a><span class='hs-comment'>-- | Called when doing top-level substitutions. Here we expect that the</span>
<a name="line-97"></a><span class='hs-comment'>-- free vars of the range of the substitution will be empty.</span>
<a name="line-98"></a><span class='hs-definition'>mkTopTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-99"></a><span class='hs-definition'>mkTopTvSubst</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="zipTopTvSubst"></a><span class='hs-definition'>zipTopTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-102"></a><span class='hs-definition'>zipTopTvSubst</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipTopTvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubst</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="zipTyEnv"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-109"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipTyEnv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip_ty_env</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="zip_ty_env"></a><span class='hs-comment'>-- Later substitutions in the list over-ride earlier ones,</span>
<a name="line-116"></a><span class='hs-comment'>-- but there should be no loops</span>
<a name="line-117"></a><span class='hs-definition'>zip_ty_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-118"></a><span class='hs-definition'>zip_ty_env</span> <span class='hs-conid'>[]</span>       <span class='hs-conid'>[]</span>       <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-119"></a><span class='hs-definition'>zip_ty_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip_ty_env</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-120"></a>        <span class='hs-comment'>-- There used to be a special case for when</span>
<a name="line-121"></a>        <span class='hs-comment'>--      ty == TyVarTy tv</span>
<a name="line-122"></a>        <span class='hs-comment'>-- (a not-uncommon case) in which case the substitution was dropped.</span>
<a name="line-123"></a>        <span class='hs-comment'>-- But the type-tidier changes the print-name of a type variable without</span>
<a name="line-124"></a>        <span class='hs-comment'>-- changing the unique, and that led to a bug.   Why?  Pre-tidying, we had</span>
<a name="line-125"></a>        <span class='hs-comment'>-- a type {Foo t}, where Foo is a one-method class.  So Foo is really a newtype.</span>
<a name="line-126"></a>        <span class='hs-comment'>-- And it happened that t was the type variable of the class.  Post-tiding,</span>
<a name="line-127"></a>        <span class='hs-comment'>-- it got turned into {Foo t2}.  The ext-core printer expanded this using</span>
<a name="line-128"></a>        <span class='hs-comment'>-- sourceTypeRep, but that said "Oh, t == t2" because they have the same unique,</span>
<a name="line-129"></a>        <span class='hs-comment'>-- and so generated a rep type mentioning t not t2.</span>
<a name="line-130"></a>        <span class='hs-comment'>--</span>
<a name="line-131"></a>        <span class='hs-comment'>-- Simplest fix is to nuke the "optimisation"</span>
<a name="line-132"></a><span class='hs-definition'>zip_ty_env</span> <span class='hs-varid'>tvs</span>      <span class='hs-varid'>tys</span>      <span class='hs-varid'>env</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"Var/Type length mismatch: "</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-133"></a><span class='hs-comment'>-- zip_ty_env _ _ env = env</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyword'>where</span>
<a name="line-136"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>ins</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-137"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"TvSubst"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-138"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In scope:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-139"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type env:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Performing type or kind substitutions
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="substTyWith"></a><span class='hs-comment'>-- | Type substitution making use of an 'TvSubst' that</span>
<a name="line-2"></a><span class='hs-comment'>-- is assumed to be open, see 'zipOpenTvSubst'</span>
<a name="line-3"></a><span class='hs-definition'>substTyWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-4"></a><span class='hs-definition'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-5"></a>                      <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipOpenTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="substKiWith"></a><span class='hs-definition'>substKiWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-8"></a><span class='hs-definition'>substKiWith</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="substTysWith"></a><span class='hs-comment'>-- | Type substitution making use of an 'TvSubst' that</span>
<a name="line-11"></a><span class='hs-comment'>-- is assumed to be open, see 'zipOpenTvSubst'</span>
<a name="line-12"></a><span class='hs-definition'>substTysWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a><span class='hs-definition'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-14"></a>                       <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipOpenTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="substKisWith"></a><span class='hs-definition'>substKisWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a><span class='hs-definition'>substKisWith</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTysWith</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="substTy"></a><span class='hs-comment'>-- | Substitute within a 'Type'</span>
<a name="line-20"></a><span class='hs-definition'>substTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-21"></a><span class='hs-definition'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-22"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="substTys"></a><span class='hs-comment'>-- | Substitute within several 'Type's</span>
<a name="line-25"></a><span class='hs-definition'>substTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a><span class='hs-definition'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-27"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="substTheta"></a><span class='hs-comment'>-- | Substitute within a 'ThetaType'</span>
<a name="line-30"></a><span class='hs-definition'>substTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-31"></a><span class='hs-definition'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>theta</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="deShadowTy"></a><span class='hs-comment'>-- | Remove any nested binders mentioning the 'TyVar's in the 'TyVarSet'</span>
<a name="line-36"></a><span class='hs-definition'>deShadowTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-37"></a><span class='hs-definition'>deShadowTy</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyTvSubstEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-39"></a>  <span class='hs-keyword'>where</span>
<a name="line-40"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varid'>tvs</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="subst_ty"></a><span class='hs-definition'>subst_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-43"></a><span class='hs-comment'>-- subst_ty is the main workhorse for type substitution</span>
<a name="line-44"></a><span class='hs-comment'>--</span>
<a name="line-45"></a><span class='hs-comment'>-- Note that the in_scope set is poked only if we hit a forall</span>
<a name="line-46"></a><span class='hs-comment'>-- so it may often never be fully computed</span>
<a name="line-47"></a><span class='hs-definition'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span>
<a name="line-51"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-52"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-53"></a>                           <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-56"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-57"></a>                <span class='hs-comment'>-- The mkAppTy smart constructor is important</span>
<a name="line-58"></a>                <span class='hs-comment'>-- we might be replacing (a Int), represented with App</span>
<a name="line-59"></a>                <span class='hs-comment'>-- by [Int], represented with TyConApp</span>
<a name="line-60"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-61"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-62"></a>                                 <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="substTyVar"></a><span class='hs-definition'>substTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-65"></a><span class='hs-definition'>substTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- See Note [Apply Once]</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span>
<a name="line-68"></a>  <span class='hs-comment'>-- We do not require that the tyvar is in scope</span>
<a name="line-69"></a>  <span class='hs-comment'>-- Reason: we do quite a bit of (substTyWith [tv] [ty] tau)</span>
<a name="line-70"></a>  <span class='hs-comment'>-- and it's a nuisance to bring all the free vars of tau into</span>
<a name="line-71"></a>  <span class='hs-comment'>-- scope --- and then force that thunk at every tyvar</span>
<a name="line-72"></a>  <span class='hs-comment'>-- Instead we have an ASSERT in substTyVarBndr to check for capture</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="substTyVars"></a><span class='hs-definition'>substTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a><span class='hs-definition'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="lookupTyVar"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-78"></a>        <span class='hs-comment'>-- See Note [Extending the TvSubst]</span>
<a name="line-79"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="substTyVarBndr"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-sel'>_no_capture</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>)</span>
<a name="line-84"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyword'>where</span>
<a name="line-86"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span>
<a name="line-87"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>    <span class='hs-sel'>_no_capture</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-90"></a>    <span class='hs-comment'>-- Assertion check that we are not capturing something in the substitution</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-93"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- verify that kind is closed</span>
<a name="line-94"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-95"></a>        <span class='hs-comment'>-- no_change means that the new_var is identical in</span>
<a name="line-96"></a>        <span class='hs-comment'>-- all respects to the old_var (same unique, same kind)</span>
<a name="line-97"></a>        <span class='hs-comment'>-- See Note [Extending the TvSubst]</span>
<a name="line-98"></a>        <span class='hs-comment'>--</span>
<a name="line-99"></a>        <span class='hs-comment'>-- In that case we don't need to extend the substitution</span>
<a name="line-100"></a>        <span class='hs-comment'>-- to map old to new.  But instead we must zap any</span>
<a name="line-101"></a>        <span class='hs-comment'>-- current substitution for the variable. For example:</span>
<a name="line-102"></a>        <span class='hs-comment'>--      (\x.e) with id_subst = [x |-&gt; e']</span>
<a name="line-103"></a>        <span class='hs-comment'>-- Here we must simply zap the substitution for x</span>
<a name="line-104"></a>
<a name="line-105"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_var</span>
<a name="line-106"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$</span> <span class='hs-varid'>updateTyVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-107"></a>        <span class='hs-comment'>-- The uniqAway part makes sure the new variable is not already in scope</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="cloneTyVarBndr"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>uniq</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-112"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-113"></a>  <span class='hs-keyword'>where</span>
<a name="line-114"></a>    <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>uniq</span>  <span class='hs-comment'>-- Simply set the unique; the kind</span>
<a name="line-115"></a>                                <span class='hs-comment'>-- has no type variables to worry about</span>
</pre>\end{code}

----------------------------------------------------
-- Kind Stuff

Kinds
~~~~~

For the description of subkinding in GHC, see
  http://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/TypeType#Kinds

\begin{code}
<pre><a name="line-1"></a><a name="MetaKindVar"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MetaKindVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVar</span>  <span class='hs-comment'>-- invariant: MetaKindVar will always be a</span>
<a name="line-2"></a>                          <span class='hs-comment'>-- TcTyVar with details MetaTv TauTv ...</span>
<a name="line-3"></a><span class='hs-comment'>-- meta kind var constructors and functions are in TcType</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="SimpleKind"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SimpleKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Kind</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        The kind of a type
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="typeKind"></a><span class='hs-definition'>typeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-2"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPromotedTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span> <span class='hs-varid'>superKind</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kindAppResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kindAppResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeLiteralKind</span> <span class='hs-varid'>l</span>
<a name="line-10"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span>
<a name="line-11"></a><span class='hs-definition'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-12"></a><span class='hs-definition'>typeKind</span> <span class='hs-sel'>_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-sel'>_arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-13"></a>    <span class='hs-comment'>-- Hack alert.  The kind of (Int -&gt; Int#) is liftedTypeKind (*),</span>
<a name="line-14"></a>    <span class='hs-comment'>--              not unliftedTypKind (#)</span>
<a name="line-15"></a>    <span class='hs-comment'>-- The only things that can be after a function arrow are</span>
<a name="line-16"></a>    <span class='hs-comment'>--   (a) types (of kind openTypeKind or its sub-kinds)</span>
<a name="line-17"></a>    <span class='hs-comment'>--   (b) kinds (of super-kind TY) (e.g. * -&gt; (* -&gt; *))</span>
<a name="line-18"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSuperKind</span> <span class='hs-varid'>k</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span>
<a name="line-19"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isSubOpenTypeKind</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-sel'>_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span> <span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-20"></a>    <span class='hs-keyword'>where</span>
<a name="line-21"></a>      <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>res</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="typeLiteralKind"></a><span class='hs-definition'>typeLiteralKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-24"></a><span class='hs-definition'>typeLiteralKind</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-25"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>    <span class='hs-conid'>NumTyLit</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>typeNatKind</span>
<a name="line-27"></a>    <span class='hs-conid'>StrTyLit</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>typeSymbolKind</span>
</pre>\end{code}

Kind inference
~~~~~~~~~~~~~~
During kind inference, a kind variable unifies only with
a "simple kind", sk
        sk ::= * | sk1 -> sk2
For example
        data T a = MkT a (T Int#)
fails.  We give T the kind (k -> *), and the kind variable k won't unify
with # (the kind of Int#).

Type inference
~~~~~~~~~~~~~~
When creating a fresh internal type variable, we give it a kind to express
constraints on it.  E.g. in (\x->e) we make up a fresh type variable for x,
with kind ??.

During unification we only bind an internal type variable to a type
whose kind is lower in the sub-kind hierarchy than the kind of the tyvar.

When unifying two internal type variables, we collect their kind constraints by
finding the GLB of the two.  Since the partial order is a tree, they only
have a glb if one is a sub-kind of the other.  In that case, we bind the
less-informative one to the more informative one.  Neat, eh?
</body>
</html>
