<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>deSugar/DsBinds.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Pattern-matching bindings (HsBinds and MonoBinds)

Handles @HsBinds@; those at the top level require different handling,
in that the @Rec@/@NonRec@/etc structure is thrown away (whereas at
lower levels it is preserved with @let@/@letrec@s).

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>DsBinds</span> <span class='hs-layout'>(</span> <span class='hs-varid'>dsTopLHsBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsLHsBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>decomposeRuleLhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsSpec</span><span class='hs-layout'>,</span>
<a name="line-9"></a>                 <span class='hs-varid'>dsHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsEvBinds</span>
<a name="line-10"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>	<span class='hs-conid'>DsExpr</span><span class='hs-layout'>(</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>	<span class='hs-conid'>Match</span><span class='hs-layout'>(</span> <span class='hs-varid'>matchWrapper</span> <span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMonad</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsGRHSs</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsUtils</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>		<span class='hs-comment'>-- lots of things</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>		<span class='hs-comment'>-- lots of things</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>Literal</span><span class='hs-layout'>(</span><span class='hs-conid'>MachStr</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSubst</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span> <span class='hs-layout'>(</span> <span class='hs-varid'>etaExpand</span> <span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUnfold</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span> <span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-33"></a>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>isTupleTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConDataCons_maybe</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>eqBoxDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercibleDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tupleCon</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>dataConWorkId</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>seqId</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Rules</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OrdList</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TopLevel</span> <span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span><span class='hs-layout'>(</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span><span class='hs-layout'>(</span> <span class='hs-varid'>getNth</span> <span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>when</span> <span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span><span class='hs-varid'>liftM</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[dsMonoBinds]{Desugaring a @MonoBinds@}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dsTopLHsBinds"></a><span class='hs-definition'>dsTopLHsBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>dsTopLHsBinds</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_lhs_binds</span> <span class='hs-varid'>binds</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="dsLHsBinds"></a><span class='hs-definition'>dsLHsBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>dsLHsBinds</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds_lhs_binds</span> <span class='hs-varid'>binds</span>
<a name="line-6"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="ds_lhs_binds"></a><span class='hs-comment'>------------------------</span>
<a name="line-9"></a><span class='hs-definition'>ds_lhs_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>ds_lhs_binds</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_bs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>dsLHsBind</span> <span class='hs-varid'>binds</span>
<a name="line-12"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldBag</span> <span class='hs-varid'>appOL</span> <span class='hs-varid'>id</span> <span class='hs-varid'>nilOL</span> <span class='hs-varid'>ds_bs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="dsLHsBind"></a><span class='hs-definition'>dsLHsBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>dsLHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putSrcSpanDs</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dsHsBind</span> <span class='hs-varid'>bind</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="dsHsBind"></a><span class='hs-definition'>dsHsBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>dsHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inline_regardless</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>core_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-22"></a>
<a name="line-23"></a>	        <span class='hs-comment'>-- Dictionary bindings are always VarBinds,</span>
<a name="line-24"></a>	        <span class='hs-comment'>-- so we only need do this here</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>var'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inline_regardless</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>var</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>mkCompulsoryUnfolding</span> <span class='hs-varid'>core_expr</span>
<a name="line-26"></a>	      	   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>var</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-layout'>(</span><span class='hs-varid'>makeCorePair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>var'</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-varid'>core_expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>dsHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span>
<a name="line-31"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>fun_co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_tick</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tick</span>
<a name="line-32"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inf</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-33"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunRhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>inf</span><span class='hs-layout'>)</span> <span class='hs-varid'>matches</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOptTickBox</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>body</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>co_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLams</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-comment'>{- pprTrace "dsHsBind" (ppr fun &lt;+&gt; ppr (idInlinePragma fun)) $ -}</span>
<a name="line-38"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-layout'>(</span><span class='hs-varid'>makeCorePair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fun</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>dsHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-41"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>pat_ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs_tick</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_ticks</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>body_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsGuarded</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>ty</span>
<a name="line-43"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOptTickBox</span> <span class='hs-varid'>rhs_tick</span> <span class='hs-varid'>body_expr</span>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sel_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSelectorBinds</span> <span class='hs-varid'>var_ticks</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body'</span>
<a name="line-45"></a>	  <span class='hs-comment'>-- We silently ignore inline pragmas; no makeCorePair</span>
<a name="line-46"></a>	  <span class='hs-comment'>-- Not so cool, but really doesn't matter</span>
<a name="line-47"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>toOL</span> <span class='hs-varid'>sel_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>
<a name="line-49"></a>	<span class='hs-comment'>-- A common case: one exported variable</span>
<a name="line-50"></a>	<span class='hs-comment'>-- Non-recursive bindings come through this way</span>
<a name="line-51"></a>	<span class='hs-comment'>-- So do self-recursive bindings, and recursive bindings</span>
<a name="line-52"></a>	<span class='hs-comment'>-- that have been chopped up with type signatures</span>
<a name="line-53"></a><span class='hs-definition'>dsHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-54"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>export</span><span class='hs-keyglyph'>]</span>
<a name="line-55"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>global</span>
<a name="line-57"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prags</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>export</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-59"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bind_prs</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds_lhs_binds</span> <span class='hs-varid'>binds</span>
<a name="line-60"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>core_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>bind_prs</span><span class='hs-layout'>)</span>
<a name="line-61"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ds_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsTcEvBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-62"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>wrap</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Usually the identity</span>
<a name="line-63"></a>			    <span class='hs-varid'>mkLams</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>dicts</span> <span class='hs-varop'>$</span> 
<a name="line-64"></a>	                    <span class='hs-varid'>mkCoreLets</span> <span class='hs-varid'>ds_binds</span> <span class='hs-varop'>$</span>
<a name="line-65"></a>                            <span class='hs-conid'>Let</span> <span class='hs-varid'>core_bind</span> <span class='hs-varop'>$</span>
<a name="line-66"></a>                            <span class='hs-conid'>Var</span> <span class='hs-varid'>local</span>
<a name="line-67"></a>    
<a name="line-68"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsSpecs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>prags</span>
<a name="line-69"></a>
<a name="line-70"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>   <span class='hs-varid'>global'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addIdSpecialisations</span> <span class='hs-varid'>global</span> <span class='hs-varid'>rules</span>
<a name="line-71"></a>		<span class='hs-varid'>main_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeCorePair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>global'</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDefaultMethod</span> <span class='hs-varid'>prags</span><span class='hs-layout'>)</span>
<a name="line-72"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>dictArity</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span> 
<a name="line-73"></a>    
<a name="line-74"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>main_bind</span> <span class='hs-varop'>`consOL`</span> <span class='hs-varid'>spec_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-definition'>dsHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-77"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span>
<a name="line-78"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-79"></a>         <span class='hs-comment'>-- See Note [Desugaring AbsBinds]</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-81"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bind_prs</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds_lhs_binds</span> <span class='hs-varid'>binds</span>
<a name="line-82"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>core_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rec</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>makeCorePair</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_inline</span> <span class='hs-varid'>lcl_id</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-varid'>rhs</span>
<a name="line-83"></a>                              <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcl_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromOL</span> <span class='hs-varid'>bind_prs</span> <span class='hs-keyglyph'>]</span>
<a name="line-84"></a>	      	<span class='hs-comment'>-- Monomorphic recursion possible, hence Rec</span>
<a name="line-85"></a>
<a name="line-86"></a>	      <span class='hs-varid'>locals</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>abe_mono</span> <span class='hs-varid'>exports</span>
<a name="line-87"></a>	      <span class='hs-varid'>tup_expr</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBigCoreVarTup</span> <span class='hs-varid'>locals</span>
<a name="line-88"></a>	      <span class='hs-varid'>tup_ty</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>tup_expr</span>
<a name="line-89"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ds_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsTcEvBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-90"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>poly_tup_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>dicts</span> <span class='hs-varop'>$</span>
<a name="line-91"></a>	      		     <span class='hs-varid'>mkCoreLets</span> <span class='hs-varid'>ds_binds</span> <span class='hs-varop'>$</span>
<a name="line-92"></a>			     <span class='hs-conid'>Let</span> <span class='hs-varid'>core_bind</span> <span class='hs-varop'>$</span>
<a name="line-93"></a>	 	     	     <span class='hs-varid'>tup_expr</span>
<a name="line-94"></a>
<a name="line-95"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>poly_tup_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>poly_tup_rhs</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mk_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>global</span>
<a name="line-98"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spec_prags</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-99"></a>	        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tup_id</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-varid'>tup_ty</span>
<a name="line-100"></a>	             <span class='hs-layout'>;</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>wrap</span> <span class='hs-varop'>$</span> 
<a name="line-101"></a>                                 <span class='hs-varid'>mkLams</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkLams</span> <span class='hs-varid'>dicts</span> <span class='hs-varop'>$</span>
<a name="line-102"></a>	      	     		 <span class='hs-varid'>mkTupleSelector</span> <span class='hs-varid'>locals</span> <span class='hs-varid'>local</span> <span class='hs-varid'>tup_id</span> <span class='hs-varop'>$</span>
<a name="line-103"></a>			         <span class='hs-varid'>mkVarApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>poly_tup_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span>
<a name="line-104"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs_for_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>poly_tup_id</span> <span class='hs-varid'>poly_tup_rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-105"></a>		     <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsSpecs</span> <span class='hs-varid'>rhs_for_spec</span> <span class='hs-varid'>spec_prags</span>
<a name="line-106"></a>		     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>global'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>global</span> <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>defaultInlinePragma</span><span class='hs-layout'>)</span>
<a name="line-107"></a>                                             <span class='hs-varop'>`addIdSpecialisations`</span> <span class='hs-varid'>rules</span>
<a name="line-108"></a>                           <span class='hs-comment'>-- Kill the INLINE pragma because it applies to</span>
<a name="line-109"></a>                           <span class='hs-comment'>-- the user written (local) function.  The global</span>
<a name="line-110"></a>                           <span class='hs-comment'>-- Id is just the selector.  Hmm.  </span>
<a name="line-111"></a>		     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>global'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varop'>`consOL`</span> <span class='hs-varid'>spec_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-112"></a>
<a name="line-113"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>export_binds_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mk_bind</span> <span class='hs-varid'>exports</span>
<a name="line-114"></a>
<a name="line-115"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>poly_tup_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>poly_tup_rhs</span><span class='hs-layout'>)</span> <span class='hs-varop'>`consOL`</span> 
<a name="line-116"></a>		    <span class='hs-varid'>concatOL</span> <span class='hs-varid'>export_binds_s</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-117"></a>  <span class='hs-keyword'>where</span>
<a name="line-118"></a>    <span class='hs-varid'>inline_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>Id</span>   <span class='hs-comment'>-- Maps a monomorphic local Id to one with</span>
<a name="line-119"></a>                             <span class='hs-comment'>-- the inline pragma from the source</span>
<a name="line-120"></a>                             <span class='hs-comment'>-- The type checker put the inline pragma</span>
<a name="line-121"></a>                             <span class='hs-comment'>-- on the *global* Id, so we need to transfer it</span>
<a name="line-122"></a>    <span class='hs-varid'>inline_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcl_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInlinePragma</span> <span class='hs-varid'>lcl_id</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-123"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbl_id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>exports</span>
<a name="line-124"></a>                          <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>gbl_id</span> <span class='hs-keyglyph'>]</span>
<a name="line-125"></a>
<a name="line-126"></a>    <span class='hs-varid'>add_inline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>    <span class='hs-comment'>-- tran</span>
<a name="line-127"></a>    <span class='hs-varid'>add_inline</span> <span class='hs-varid'>lcl_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>inline_env</span> <span class='hs-varid'>lcl_id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>lcl_id</span>
<a name="line-128"></a>
<a name="line-129"></a><span class='hs-definition'>dsHsBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsHsBind: PatSynBind"</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="makeCorePair"></a><span class='hs-comment'>------------------------</span>
<a name="line-132"></a><span class='hs-definition'>makeCorePair</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-133"></a><span class='hs-definition'>makeCorePair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>gbl_id</span> <span class='hs-varid'>is_default_method</span> <span class='hs-varid'>dict_arity</span> <span class='hs-varid'>rhs</span>
<a name="line-134"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_default_method</span>		      <span class='hs-comment'>-- Default methods are *always* inlined</span>
<a name="line-135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_id</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>mkCompulsoryUnfolding</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>inlinePragmaSpec</span> <span class='hs-varid'>inline_prag</span> <span class='hs-keyword'>of</span>
<a name="line-139"></a>      	  <span class='hs-conid'>EmptyInlineSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-140"></a>      	  <span class='hs-conid'>NoInline</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-141"></a>      	  <span class='hs-conid'>Inlinable</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_id</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>inlinable_unf</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-142"></a>          <span class='hs-conid'>Inline</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inline_pair</span>
<a name="line-143"></a>
<a name="line-144"></a>  <span class='hs-keyword'>where</span>
<a name="line-145"></a>    <span class='hs-varid'>inline_prag</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>gbl_id</span>
<a name="line-146"></a>    <span class='hs-varid'>inlinable_unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInlinableUnfolding</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rhs</span>
<a name="line-147"></a>    <span class='hs-varid'>inline_pair</span>
<a name="line-148"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inlinePragmaSat</span> <span class='hs-varid'>inline_prag</span>
<a name="line-149"></a>      	<span class='hs-comment'>-- Add an Unfolding for an INLINE (but not for NOINLINE)</span>
<a name="line-150"></a>	<span class='hs-comment'>-- And eta-expand the RHS; see Note [Eta-expanding INLINE things]</span>
<a name="line-151"></a>       <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>real_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dict_arity</span> <span class='hs-varop'>+</span> <span class='hs-varid'>arity</span>
<a name="line-152"></a>        <span class='hs-comment'>-- NB: The arity in the InlineRule takes account of the dictionaries</span>
<a name="line-153"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>gbl_id</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>mkInlineUnfolding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>real_arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-154"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>etaExpand</span> <span class='hs-varid'>real_arity</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-155"></a>
<a name="line-156"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-157"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"makeCorePair: arity missing"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>gbl_id</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-158"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>gbl_id</span> <span class='hs-varop'>`setIdUnfolding`</span> <span class='hs-varid'>mkInlineUnfolding</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-159"></a>
<a name="line-160"></a>
<a name="line-161"></a><a name="dictArity"></a><span class='hs-definition'>dictArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-162"></a><span class='hs-comment'>-- Don't count coercion variables in arity</span>
<a name="line-163"></a><span class='hs-definition'>dictArity</span> <span class='hs-varid'>dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>dicts</span>
</pre>\end{code}

[Desugaring AbsBinds]
~~~~~~~~~~~~~~~~~~~~~
In the general AbsBinds case we desugar the binding to this:

       tup a (d:Num a) = let fm = ...gm...
                             gm = ...fm...
                         in (fm,gm)
       f a d = case tup a d of { (fm,gm) -> fm }
       g a d = case tup a d of { (fm,gm) -> fm }

Note [Rules and inlining]
~~~~~~~~~~~~~~~~~~~~~~~~~
Common special case: no type or dictionary abstraction
This is a bit less trivial than you might suppose
The naive way woudl be to desguar to something like
	f_lcl = ...f_lcl...	-- The "binds" from AbsBinds
	M.f = f_lcl		-- Generated from "exports"
But we don't want that, because if M.f isn't exported,
it'll be inlined unconditionally at every call site (its rhs is 
trivial).  That would be ok unless it has RULES, which would 
thereby be completely lost.  Bad, bad, bad.

Instead we want to generate
	M.f = ...f_lcl...
	f_lcl = M.f
Now all is cool. The RULES are attached to M.f (by SimplCore), 
and f_lcl is rapidly inlined away.

This does not happen in the same way to polymorphic binds,
because they desugar to
	M.f = /\a. let f_lcl = ...f_lcl... in f_lcl
Although I'm a bit worried about whether full laziness might
float the f_lcl binding out and then inline M.f at its call site

Note [Specialising in no-dict case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Even if there are no tyvars or dicts, we may have specialisation pragmas.
Class methods can generate
      AbsBinds [] [] [( ... spec-prag]
         { AbsBinds [tvs] [dicts] ...blah }
So the overloading is in the nested AbsBinds. A good example is in GHC.Float:

  class  (Real a, Fractional a) => RealFrac a  where
    round :: (Integral b) => a -> b

  instance  RealFrac Float  where
    {-# SPECIALIZE round :: Float -> Int #-}

The top-level AbsBinds for $cround has no tyvars or dicts (because the 
instance does not).  But the method is locally overloaded!

Note [Abstracting over tyvars only]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When abstracting over type variable only (not dictionaries), we don't really need to
built a tuple and select from it, as we do in the general case. Instead we can take

	AbsBinds [a,b] [ ([a,b], fg, fl, _),
		         ([b],   gg, gl, _) ]
		{ fl = e1
		  gl = e2
		   h = e3 }

and desugar it to

	fg = /\ab. let B in e1
	gg = /\b. let a = () in let B in S(e2)
	h  = /\ab. let B in e3

where B is the *non-recursive* binding
	fl = fg a b
	gl = gg b
	h  = h a b    -- See (b); note shadowing!

Notice (a) g has a different number of type variables to f, so we must
	     use the mkArbitraryType thing to fill in the gaps.  
	     We use a type-let to do that.

	 (b) The local variable h isn't in the exports, and rather than
	     clone a fresh copy we simply replace h by (h a b), where
	     the two h's have different types!  Shadowing happens here,
	     which looks confusing but works fine.

	 (c) The result is *still* quadratic-sized if there are a lot of
	     small bindings.  So if there are more than some small
	     number (10), we filter the binding set B by the free
	     variables of the particular RHS.  Tiresome.

Why got to this trouble?  It's a common case, and it removes the
quadratic-sized tuple desugaring.  Less clutter, hopefullly faster
compilation, especially in a case where there are a *lot* of
bindings.


Note [Eta-expanding INLINE things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   foo :: Eq a => a -> a
   {-# INLINE foo #-}
   foo x = ...

If (foo d) ever gets floated out as a common sub-expression (which can
happen as a result of method sharing), there's a danger that we never 
get to do the inlining, which is a Terribly Bad thing given that the
user said "inline"!

To avoid this we pre-emptively eta-expand the definition, so that foo
has the arity with which it is declared in the source code.  In this
example it has arity 2 (one for the Eq and one for x). Doing this 
should mean that (foo d) is a PAP and we don't share it.

Note [Nested arities]
~~~~~~~~~~~~~~~~~~~~~
For reasons that are not entirely clear, method bindings come out looking like
this:

  AbsBinds [] [] [$cfromT <= [] fromT]
    $cfromT [InlPrag=INLINE] :: T Bool -> Bool
    { AbsBinds [] [] [fromT <= [] fromT_1]
        fromT :: T Bool -> Bool
        { fromT_1 ((TBool b)) = not b } } }

Note the nested AbsBind.  The arity for the InlineRule on $cfromT should be
gotten from the binding for fromT_1.

It might be better to have just one level of AbsBinds, but that requires more
thought!

Note [Implementing SPECIALISE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Example:
	f :: (Eq a, Ix b) => a -> b -> Bool
	{-# SPECIALISE f :: (Ix p, Ix q) => Int -> (p,q) -> Bool #-}
        f = <poly_rhs>

From this the typechecker generates

    AbsBinds [ab] [d1,d2] [([ab], f, f_mono, prags)] binds

    SpecPrag (wrap_fn :: forall a b. (Eq a, Ix b) => XXX
                      -> forall p q. (Ix p, Ix q) => XXX[ Int/a, (p,q)/b ])

Note that wrap_fn can transform *any* function with the right type prefix 
    forall ab. (Eq a, Ix b) => XXX
regardless of XXX.  It's sort of polymorphic in XXX.  This is
useful: we use the same wrapper to transform each of the class ops, as
well as the dict.

From these we generate:

    Rule: 	forall p, q, (dp:Ix p), (dq:Ix q). 
                    f Int (p,q) dInt ($dfInPair dp dq) = f_spec p q dp dq

    Spec bind:	f_spec = wrap_fn <poly_rhs>

Note that 

  * The LHS of the rule may mention dictionary *expressions* (eg
    $dfIxPair dp dq), and that is essential because the dp, dq are
    needed on the RHS.

  * The RHS of f_spec, <poly_rhs> has a *copy* of 'binds', so that it 
    can fully specialise it.

\begin{code}
<pre><a name="line-1"></a><a name="dsSpecs"></a><span class='hs-comment'>------------------------</span>
<a name="line-2"></a><span class='hs-definition'>dsSpecs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span>     <span class='hs-comment'>-- Its rhs</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSpecPrags</span>
<a name="line-4"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> 	<span class='hs-comment'>-- Binding for specialised Ids</span>
<a name="line-5"></a>	       <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>		<span class='hs-comment'>-- Rules for the Global Ids</span>
<a name="line-6"></a><span class='hs-comment'>-- See Note [Implementing SPECIALISE pragmas]</span>
<a name="line-7"></a><span class='hs-definition'>dsSpecs</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>IsDefaultMethod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nilOL</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-8"></a><span class='hs-definition'>dsSpecs</span> <span class='hs-varid'>poly_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrags</span> <span class='hs-varid'>sps</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapMaybeM</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>poly_rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>sps</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_binds_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatOL</span> <span class='hs-varid'>spec_binds_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="dsSpec"></a><span class='hs-definition'>dsSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoreExpr</span>  	<span class='hs-comment'>-- Just rhs =&gt; RULE is for a local binding</span>
<a name="line-14"></a>       	  			<span class='hs-comment'>-- Nothing =&gt; RULE is for an imported Id</span>
<a name="line-15"></a>				<span class='hs-comment'>-- 	      rhs is in the Id's unfolding</span>
<a name="line-16"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>TcSpecPrag</span>
<a name="line-17"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreRule</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>dsSpec</span> <span class='hs-varid'>mb_poly_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-varid'>poly_id</span> <span class='hs-varid'>spec_co</span> <span class='hs-varid'>spec_inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>isClassOpId_maybe</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putSrcSpanDs</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-21"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warnDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Ignoring useless SPECIALISE pragma for class method selector"</span><span class='hs-layout'>)</span> 
<a name="line-22"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>  <span class='hs-layout'>}</span>  <span class='hs-comment'>-- There is no point in trying to specialise a class op</span>
<a name="line-24"></a>       	 		    <span class='hs-comment'>-- Moreover, classops don't (currently) have an inl_sat arity set</span>
<a name="line-25"></a>			    <span class='hs-comment'>-- (it would be Just 0) and that in turn makes makeCorePair bleat</span>
<a name="line-26"></a>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_act_spec</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isNeverActive</span> <span class='hs-varid'>rule_act</span> 
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putSrcSpanDs</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-29"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warnDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Ignoring useless SPECIALISE pragma for NOINLINE function:"</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>  <span class='hs-layout'>}</span>  <span class='hs-comment'>-- Function is NOINLINE, and the specialiation inherits that</span>
<a name="line-32"></a>       	 		    <span class='hs-comment'>-- See Note [Activation pragmas for SPECIALISE]</span>
<a name="line-33"></a>
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putSrcSpanDs</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-36"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>poly_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>poly_id</span>
<a name="line-38"></a>             <span class='hs-varid'>spec_occ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSpecOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>poly_name</span><span class='hs-layout'>)</span>
<a name="line-39"></a>             <span class='hs-varid'>spec_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>spec_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>poly_name</span><span class='hs-layout'>)</span>
<a name="line-40"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_lhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>collectBinders</span>
<a name="line-41"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>spec_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>spec_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPiTypes</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>ds_lhs</span><span class='hs-layout'>)</span>
<a name="line-43"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>decomposeRuleLhs</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>ds_lhs</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-44"></a>           <span class='hs-conid'>Left</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warnDs</span> <span class='hs-varid'>msg</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-45"></a>           <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>rule_bndrs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>
<a name="line-47"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>spec_unf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>specUnfolding</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>args</span> <span class='hs-layout'>(</span><span class='hs-varid'>realIdUnfolding</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-49"></a>             <span class='hs-varid'>spec_id</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>spec_name</span> <span class='hs-varid'>spec_ty</span> 
<a name="line-50"></a>         	            <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>inl_prag</span>
<a name="line-51"></a>         	 	    <span class='hs-varop'>`setIdUnfolding`</span>  <span class='hs-varid'>spec_unf</span>
<a name="line-52"></a>             <span class='hs-varid'>rule</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mkRule</span> <span class='hs-conid'>False</span> <span class='hs-comment'>{- Not auto -}</span> <span class='hs-varid'>is_local_id</span>
<a name="line-53"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-str'>"SPEC "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showPpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>poly_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>       			<span class='hs-varid'>rule_act</span> <span class='hs-varid'>poly_name</span>
<a name="line-55"></a>       		        <span class='hs-varid'>rule_bndrs</span> <span class='hs-varid'>args</span>
<a name="line-56"></a>       			<span class='hs-layout'>(</span><span class='hs-varid'>mkVarApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>spec_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>spec_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>spec_co</span> <span class='hs-varid'>poly_rhs</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>spec_pair</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeCorePair</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>spec_id</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictArity</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>spec_rhs</span>
<a name="line-60"></a>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isInlinePragma</span> <span class='hs-varid'>id_inl</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnPointlessPragmas</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-62"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>warnDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>specOnInline</span> <span class='hs-varid'>poly_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>spec_pair</span><span class='hs-layout'>,</span> <span class='hs-varid'>rule</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-64"></a>       <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>  <span class='hs-keyword'>where</span>
<a name="line-66"></a>    <span class='hs-varid'>is_local_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_poly_rhs</span>
<a name="line-67"></a>    <span class='hs-varid'>poly_rhs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span>  <span class='hs-varid'>mb_poly_rhs</span>
<a name="line-68"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span>  	    <span class='hs-comment'>-- Local Id; this is its rhs</span>
<a name="line-69"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>unfolding</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeUnfoldingTemplate</span> <span class='hs-layout'>(</span><span class='hs-varid'>realIdUnfolding</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-70"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfolding</span>    <span class='hs-comment'>-- Imported Id; this is its unfolding</span>
<a name="line-71"></a>	       		    <span class='hs-comment'>-- Use realIdUnfolding so we get the unfolding </span>
<a name="line-72"></a>			    <span class='hs-comment'>-- even when it is a loop breaker. </span>
<a name="line-73"></a>			    <span class='hs-comment'>-- We want to specialise recursive functions!</span>
<a name="line-74"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dsImpSpecs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span>
<a name="line-75"></a>	                    <span class='hs-comment'>-- The type checker has checked that it *has* an unfolding</span>
<a name="line-76"></a>
<a name="line-77"></a>    <span class='hs-varid'>id_inl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>poly_id</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-comment'>-- See Note [Activation pragmas for SPECIALISE]</span>
<a name="line-80"></a>    <span class='hs-varid'>inl_prag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDefaultInlinePragma</span> <span class='hs-varid'>spec_inl</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spec_inl</span>
<a name="line-81"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_local_id</span>  <span class='hs-comment'>-- See Note [Specialising imported functions]</span>
<a name="line-82"></a>             	    		 <span class='hs-comment'>-- in OccurAnal</span>
<a name="line-83"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>isStrongLoopBreaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>idOccInfo</span> <span class='hs-varid'>poly_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>neverInlinePragma</span>
<a name="line-84"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_inl</span>
<a name="line-85"></a>     <span class='hs-comment'>-- Get the INLINE pragma from SPECIALISE declaration, or,</span>
<a name="line-86"></a>     <span class='hs-comment'>-- failing that, from the original Id</span>
<a name="line-87"></a>
<a name="line-88"></a>    <span class='hs-varid'>spec_prag_act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-varid'>spec_inl</span>
<a name="line-89"></a>
<a name="line-90"></a>    <span class='hs-comment'>-- See Note [Activation pragmas for SPECIALISE]</span>
<a name="line-91"></a>    <span class='hs-comment'>-- no_act_spec is True if the user didn't write an explicit</span>
<a name="line-92"></a>    <span class='hs-comment'>-- phase specification in the SPECIALISE pragma</span>
<a name="line-93"></a>    <span class='hs-varid'>no_act_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>inlinePragmaSpec</span> <span class='hs-varid'>spec_inl</span> <span class='hs-keyword'>of</span>
<a name="line-94"></a>                    <span class='hs-conid'>NoInline</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isNeverActive</span>  <span class='hs-varid'>spec_prag_act</span>
<a name="line-95"></a>                    <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isAlwaysActive</span> <span class='hs-varid'>spec_prag_act</span>
<a name="line-96"></a>    <span class='hs-varid'>rule_act</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_act_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlinePragmaActivation</span> <span class='hs-varid'>id_inl</span>   <span class='hs-comment'>-- Inherit</span>
<a name="line-97"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spec_prag_act</span>                   <span class='hs-comment'>-- Specified by user</span>
<a name="line-98"></a>
<a name="line-99"></a>
<a name="line-100"></a><a name="specUnfolding"></a><span class='hs-definition'>specUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span>
<a name="line-101"></a><span class='hs-definition'>specUnfolding</span> <span class='hs-varid'>new_bndrs</span> <span class='hs-varid'>new_args</span> <span class='hs-varid'>df</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>new_args</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>df</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_args</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_bndrs</span> <span class='hs-layout'>)</span>
<a name="line-103"></a>    <span class='hs-varid'>df</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"specUnfolding"</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>  <span class='hs-keyword'>where</span>
<a name="line-105"></a>    <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOpenSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>new_args</span><span class='hs-layout'>)</span>
<a name="line-106"></a>    <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprsFreeVars</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varop'>`extendVarSetList`</span> <span class='hs-varid'>new_bndrs</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-definition'>specUnfolding</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noUnfolding</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="specOnInline"></a><span class='hs-definition'>specOnInline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-111"></a><span class='hs-definition'>specOnInline</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SPECIALISE pragma on INLINE function probably won't fire:"</span><span class='hs-layout'>)</span> 
<a name="line-112"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
</pre>\end{code}


Note [Activation pragmas for SPECIALISE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
From a user SPECIALISE pragma for f, we generate
  a) A top-level binding    spec_fn = rhs
  b) A RULE                 f dOrd = spec_fn

We need two pragma-like things:

* spec_fn's inline pragma: inherited from f's inline pragma (ignoring 
                           activation on SPEC), unless overriden by SPEC INLINE

* Activation of RULE: from SPECIALISE pragma (if activation given)
                      otherwise from f's inline pragma

This is not obvious (see Trac #5237)!

Examples      Rule activation   Inline prag on spec'd fn
---------------------------------------------------------------------
SPEC [n] f :: ty            [n]   Always, or NOINLINE [n]
                                  copy f's prag

NOINLINE f
SPEC [n] f :: ty            [n]   NOINLINE
                                  copy f's prag

NOINLINE [k] f
SPEC [n] f :: ty            [n]   NOINLINE [k]
                                  copy f's prag

INLINE [k] f
SPEC [n] f :: ty            [n]   INLINE [k] 
                                  copy f's prag

SPEC INLINE [n] f :: ty     [n]   INLINE [n]
                                  (ignore INLINE prag on f,
                                  same activation for rule and spec'd fn)

NOINLINE [k] f
SPEC f :: ty                [n]   INLINE [k]


%************************************************************************
%*									*
\subsection{Adding inline pragmas}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="decomposeRuleLhs"></a><span class='hs-definition'>decomposeRuleLhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>SDoc</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- (decomposeRuleLhs bndrs lhs) takes apart the LHS of a RULE,</span>
<a name="line-3"></a><span class='hs-comment'>-- The 'bndrs' are the quantified binders of the rules, but decomposeRuleLhs</span>
<a name="line-4"></a><span class='hs-comment'>-- may add some extra dictionary binders (see Note [Constant rule dicts])</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- Returns Nothing if the LHS isn't of the expected shape</span>
<a name="line-7"></a><span class='hs-definition'>decomposeRuleLhs</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>lhs</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-comment'>-- Note [Simplifying the left-hand side of a RULE]</span>
<a name="line-9"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>collectArgs</span> <span class='hs-varid'>opt_lhs</span> <span class='hs-keyword'>of</span>
<a name="line-10"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_bndrs</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>args</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-13"></a>	        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDeadBinder</span> <span class='hs-varid'>bndr</span>	<span class='hs-comment'>-- Note [Matching seqId]</span>
<a name="line-14"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_bndrs</span> <span class='hs-varid'>seqId</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-15"></a>		<span class='hs-keyword'>where</span>
<a name="line-16"></a>		   <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>	   
<a name="line-18"></a>	<span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>bad_shape_msg</span>
<a name="line-19"></a> <span class='hs-keyword'>where</span>
<a name="line-20"></a>   <span class='hs-varid'>opt_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleOptExpr</span> <span class='hs-varid'>lhs</span>
<a name="line-21"></a>
<a name="line-22"></a>   <span class='hs-varid'>check_bndrs</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>args</span>
<a name="line-23"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>dead_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra_dict_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-24"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>dead_msg</span> <span class='hs-varid'>dead_bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>     <span class='hs-keyword'>where</span>
<a name="line-26"></a>       <span class='hs-varid'>arg_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprsFreeVars</span> <span class='hs-varid'>args</span>
<a name="line-27"></a>
<a name="line-28"></a>            <span class='hs-comment'>-- Check for dead binders: Note [Unused spec binders]</span>
<a name="line-29"></a>       <span class='hs-varid'>dead_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>arg_fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-30"></a>
<a name="line-31"></a>            <span class='hs-comment'>-- Add extra dict binders: Note [Constant rule dicts]</span>
<a name="line-32"></a>       <span class='hs-varid'>extra_dict_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-layout'>(</span><span class='hs-varid'>localiseName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_fvs</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-34"></a>         	          <span class='hs-layout'>,</span> <span class='hs-varid'>isDictId</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>]</span>
<a name="line-35"></a>
<a name="line-36"></a>
<a name="line-37"></a>   <span class='hs-varid'>bad_shape_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"RULE left-hand side too complicated to desugar"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                      <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>opt_lhs</span><span class='hs-layout'>)</span>
<a name="line-39"></a>   <span class='hs-varid'>dead_msg</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Forall'd"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>bndr</span>
<a name="line-40"></a>			     <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not bound in RULE lhs"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                      <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>opt_lhs</span><span class='hs-layout'>)</span>
<a name="line-42"></a>   <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>bndr</span>
<a name="line-43"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>bndr</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-44"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evVarPred_maybe</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-45"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Simplifying the left-hand side of a RULE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
simpleOptExpr occurrence-analyses and simplifies the lhs
and thereby
(a) sorts dict bindings into NonRecs and inlines them
(b) substitute trivial lets so that they don't get in the way
    Note that we substitute the function too; we might 
    have this as a LHS:  let f71 = M.f Int in f71
(c) does eta reduction

For (c) consider the fold/build rule, which without simplification
looked like:
	fold k z (build (/\a. g a))  ==>  ...
This doesn't match unless you do eta reduction on the build argument.
Similarly for a LHS like
	augment g (build h) 
we do not want to get
	augment (\a. g a) (build h)
otherwise we don't match when given an argument like
	augment (\a. h a a) (build h)

NB: tcSimplifyRuleLhs is very careful not to generate complicated
    dictionary expressions that we might have to match

Note [Matching seqId]
~~~~~~~~~~~~~~~~~~~
The desugarer turns (seq e r) into (case e of _ -> r), via a special-case hack
and this code turns it back into an application of seq!  
See Note [Rules for seq] in MkId for the details.

Note [Unused spec binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
	f :: a -> a
	{-# SPECIALISE f :: Eq a => a -> a #-}
It's true that this *is* a more specialised type, but the rule
we get is something like this:
	f_spec d = f
	RULE: f = f_spec d
Note that the rule is bogus, because it mentions a 'd' that is
not bound on the LHS!  But it's a silly specialisation anyway, because
the constraint is unused.  We could bind 'd' to (error "unused")
but it seems better to reject the program because it's almost certainly
a mistake.  That's what the isDeadBinder call detects.

Note [Constant rule dicts]
~~~~~~~~~~~~~~~~~~~~~~~~~~
When the LHS of a specialisation rule, (/\as\ds. f es) has a free dict, 
which is presumably in scope at the function definition site, we can quantify 
over it too.  *Any* dict with that type will do.

So for example when you have
	f :: Eq a => a -> a
	f = <rhs>
	{-# SPECIALISE f :: Int -> Int #-}

Then we get the SpecPrag
	SpecPrag (f Int dInt) 

And from that we want the rule
	
	RULE forall dInt. f Int dInt = f_spec
	f_spec = let f = <rhs> in f Int dInt

But be careful!  That dInt might be GHC.Base.$fOrdInt, which is an External
Name, and you can't bind them in a lambda or forall without getting things
confused.   Likewise it might have an InlineRule or something, which would be
utterly bogus. So we really make a fresh Id, with the same unique and type
as the old one, but with an Internal name and no IdInfo.


%************************************************************************
%*									*
		Desugaring evidence
%*									*
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="dsHsWrapper"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-conid'>WpHole</span> 	      <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>e</span>
<a name="line-3"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>      <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>App</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpLet</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span>  <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsTcEvBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-5"></a>                                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoreLets</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>e</span>
<a name="line-7"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-8"></a>                                  <span class='hs-varid'>dsTcCoercion</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCast</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>      <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>e</span> 
<a name="line-10"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>e</span> 
<a name="line-11"></a><span class='hs-definition'>dsHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>evtrm</span><span class='hs-layout'>)</span>   <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>evtrm</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="dsTcEvBinds"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-14"></a><span class='hs-definition'>dsTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a><span class='hs-definition'>dsTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsEvBinds"</span>    <span class='hs-comment'>-- Zonker has got rid of this</span>
<a name="line-16"></a><span class='hs-definition'>dsTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsEvBinds</span> <span class='hs-varid'>bs</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="dsEvBinds"></a><span class='hs-definition'>dsEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a><span class='hs-definition'>dsEvBinds</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>ds_scc</span> <span class='hs-layout'>(</span><span class='hs-varid'>sccEvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-varid'>ds_scc</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-22"></a>    <span class='hs-varid'>ds_scc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-varid'>ds_pair</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-varid'>ds_pair</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>v</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="sccEvBinds"></a><span class='hs-definition'>sccEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-conid'>EvBind</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a><span class='hs-definition'>sccEvBinds</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stronglyConnCompFromEdgedVertices</span> <span class='hs-varid'>edges</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mk_node</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>bs</span> 
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-varid'>mk_node</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-33"></a>    <span class='hs-varid'>mk_node</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>var</span> <span class='hs-varid'>term</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>term</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>
<a name="line-36"></a><a name="dsEvTerm"></a><span class='hs-comment'>---------------------------------------</span>
<a name="line-37"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-38"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> 
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>tm</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dsTcCoercion</span> <span class='hs-varid'>co</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkCast</span> <span class='hs-varid'>tm'</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>                        <span class='hs-comment'>-- 'v' is always a lifted evidence variable so it is</span>
<a name="line-44"></a>                        <span class='hs-comment'>-- unnecessary to call varToCoreExpr v here.</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-varid'>df</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tms'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>tms</span>
<a name="line-47"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>df</span> <span class='hs-varop'>`mkTyApps`</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`mkApps`</span> <span class='hs-varid'>tms'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Simple coercions]</span>
<a name="line-50"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsTcCoercion</span> <span class='hs-varid'>co</span> <span class='hs-varid'>mkEqBox</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-53"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>v</span>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>tm'</span>
<a name="line-55"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>scrut_ty</span>
<a name="line-56"></a>    	      <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-57"></a>    	      <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTemplateLocals</span> <span class='hs-varid'>tys</span>
<a name="line-58"></a>              <span class='hs-varid'>the_x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getNth</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>n</span>
<a name="line-59"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>)</span>
<a name="line-60"></a>          <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-61"></a>          <span class='hs-conid'>Case</span> <span class='hs-varid'>tm'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWildValBinder</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>the_x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>dc</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>the_x</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>tms</span><span class='hs-layout'>)</span> 
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tms'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>tms</span>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>tms'</span>
<a name="line-66"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWorkId</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkTyApps`</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`mkApps`</span> <span class='hs-varid'>tms'</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>  <span class='hs-keyword'>where</span> 
<a name="line-68"></a>    <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleCon</span> <span class='hs-conid'>ConstraintTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tms</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>d'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsEvTerm</span> <span class='hs-varid'>d</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getClassPredTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>d'</span><span class='hs-layout'>)</span>
<a name="line-73"></a>             <span class='hs-varid'>sc_sel_id</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classSCSelId</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>n</span>	<span class='hs-comment'>-- Zero-indexed</span>
<a name="line-74"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>sc_sel_id</span> <span class='hs-varop'>`mkTyApps`</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`App`</span> <span class='hs-varid'>d'</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>  <span class='hs-keyword'>where</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>errorId</span> <span class='hs-varop'>`mkTyApps`</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>`mkApps`</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>litMsg</span><span class='hs-keyglyph'>]</span>
<a name="line-78"></a>  <span class='hs-keyword'>where</span> 
<a name="line-79"></a>    <span class='hs-varid'>errorId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rUNTIME_ERROR_ID</span>
<a name="line-80"></a>    <span class='hs-varid'>litMsg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-conid'>MachStr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fastStringToByteString</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-definition'>dsEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-83"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-84"></a>    <span class='hs-conid'>EvNum</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkIntegerExpr</span> <span class='hs-varid'>n</span>
<a name="line-85"></a>    <span class='hs-conid'>EvStr</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkStringExprFS</span> <span class='hs-varid'>s</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="dsTcCoercion"></a><span class='hs-comment'>---------------------------------------</span>
<a name="line-88"></a><span class='hs-definition'>dsTcCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-89"></a><span class='hs-comment'>-- This is the crucial function that moves </span>
<a name="line-90"></a><span class='hs-comment'>-- from TcCoercions to Coercions; see Note [TcCoercions] in Coercion</span>
<a name="line-91"></a><span class='hs-comment'>-- e.g.  dsTcCoercion (trans g1 g2) k</span>
<a name="line-92"></a><span class='hs-comment'>--       = case g1 of EqBox g1# -&gt;</span>
<a name="line-93"></a><span class='hs-comment'>--         case g2 of EqBox g2# -&gt;</span>
<a name="line-94"></a><span class='hs-comment'>--         k (trans g1# g2#)</span>
<a name="line-95"></a><span class='hs-comment'>-- thing_inside will get a coercion at the role requested</span>
<a name="line-96"></a><span class='hs-definition'>dsTcCoercion</span> <span class='hs-varid'>co</span> <span class='hs-varid'>thing_inside</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqvs_covs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EqVar</span><span class='hs-layout'>,</span><span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-99"></a>             <span class='hs-varid'>eqvs_covs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_co_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfTcCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a>             <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>eqv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>cov</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cov</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqvs_covs</span><span class='hs-keyglyph'>]</span>
<a name="line-103"></a>             <span class='hs-varid'>result_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds_tc_coercion</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-104"></a>             <span class='hs-varid'>result_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>result_expr</span>
<a name="line-105"></a>
<a name="line-106"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_in_case</span> <span class='hs-varid'>result_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>result_expr</span> <span class='hs-varid'>eqvs_covs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>  <span class='hs-keyword'>where</span>
<a name="line-108"></a>    <span class='hs-varid'>mk_co_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-109"></a>    <span class='hs-varid'>mk_co_var</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUserLocal</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-110"></a>       <span class='hs-keyword'>where</span>
<a name="line-111"></a>         <span class='hs-varid'>eq_nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>eqv</span>
<a name="line-112"></a>         <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>eq_nm</span>
<a name="line-113"></a>         <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>eq_nm</span>
<a name="line-114"></a>         <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoercionType</span> <span class='hs-layout'>(</span><span class='hs-varid'>getEqPredRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-115"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEqPredTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span>
<a name="line-116"></a>
<a name="line-117"></a>    <span class='hs-varid'>wrap_in_case</span> <span class='hs-varid'>result_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cov</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-118"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getEqPredRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-119"></a>         <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>result_ty</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>eqBoxDataCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>cov</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-120"></a>         <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>result_ty</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>coercibleDataCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>cov</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-121"></a>         <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"wrap_in_case/phantom"</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="ds_tc_coercion"></a><span class='hs-definition'>ds_tc_coercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-124"></a><span class='hs-comment'>-- If the incoming TcCoercion if of type (a ~ b)   (resp.  Coercible a b)</span>
<a name="line-125"></a><span class='hs-comment'>--                 the result is of type (a ~# b)  (reps.  a ~# b)</span>
<a name="line-126"></a><span class='hs-comment'>-- The VarEnv maps EqVars of type (a ~ b) to Coercions of type (a ~# b) (resp. and so on)</span>
<a name="line-127"></a><span class='hs-comment'>-- No need for InScope set etc because the </span>
<a name="line-128"></a><span class='hs-definition'>ds_tc_coercion</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tc_co</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tc_co</span>
<a name="line-130"></a>  <span class='hs-keyword'>where</span>
<a name="line-131"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-132"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-133"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>leftCo</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span>
<a name="line-134"></a>                                      <span class='hs-varid'>rightRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nextRole</span> <span class='hs-varid'>leftCo</span> <span class='hs-keyword'>in</span>
<a name="line-135"></a>                                  <span class='hs-varid'>mkAppCoFlexible</span> <span class='hs-varid'>leftCo</span> <span class='hs-varid'>rightRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-136"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds_tc_coercion</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-137"></a>                              <span class='hs-keyword'>where</span>
<a name="line-138"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-139"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-140"></a>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-141"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPhantomCo</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-142"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-143"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-144"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-145"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-146"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-147"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_tc_coercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds_co_binds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-148"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCastCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-149"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_ev_id</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-150"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a>    <span class='hs-varid'>ds_co_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-153"></a>    <span class='hs-varid'>ds_co_binds</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>ds_scc</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>sccEvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-154"></a>    <span class='hs-varid'>ds_co_binds</span> <span class='hs-varid'>eb</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ds_co_binds"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>eb</span><span class='hs-layout'>)</span>
<a name="line-155"></a>
<a name="line-156"></a>    <span class='hs-varid'>ds_scc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SCC</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-157"></a>    <span class='hs-varid'>ds_scc</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ev_term</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-158"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCvSubstAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds_co_term</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ev_term</span><span class='hs-layout'>)</span>
<a name="line-159"></a>    <span class='hs-varid'>ds_scc</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ds_scc:cyclic"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_co</span><span class='hs-layout'>)</span>
<a name="line-160"></a>
<a name="line-161"></a>    <span class='hs-varid'>ds_co_term</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-162"></a>    <span class='hs-varid'>ds_co_term</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>tc_co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_tc_coercion</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tc_co</span>
<a name="line-163"></a>    <span class='hs-varid'>ds_co_term</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_ev_id</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-164"></a>    <span class='hs-varid'>ds_co_term</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds_co_term</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds_tc_coercion</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-165"></a>    <span class='hs-varid'>ds_co_term</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ds_co_term"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_co</span><span class='hs-layout'>)</span>
<a name="line-166"></a>
<a name="line-167"></a>    <span class='hs-varid'>ds_ev_id</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-168"></a>    <span class='hs-varid'>ds_ev_id</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-169"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>lookupCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-170"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ds_tc_coercion"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_co</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Simple coercions]
~~~~~~~~~~~~~~~~~~~~~~~
We have a special case for coercions that are simple variables.
Suppose   cv :: a ~ b   is in scope
Lacking the special case, if we see
	f a b cv
we'd desguar to
        f a b (case cv of EqBox (cv# :: a ~# b) -> EqBox cv#)
which is a bit stupid.  The special case does the obvious thing.

This turns out to be important when desugaring the LHS of a RULE
(see Trac #7837).  Suppose we have
    normalise        :: (a ~ Scalar a) => a -> a
    normalise_Double :: Double -> Double
    {-# RULES "normalise" normalise = normalise_Double #-}

Then the RULE we want looks like
     forall a, (cv:a~Scalar a). 
       normalise a cv = normalise_Double
But without the special case we generate the redundant box/unbox,
which simpleOpt (currently) doesn't remove. So the rule never matches.

Maybe simpleOpt should be smarter.  But it seems like a good plan
to simply never generate the redundant box/unbox in the first place.


</body>
</html>
