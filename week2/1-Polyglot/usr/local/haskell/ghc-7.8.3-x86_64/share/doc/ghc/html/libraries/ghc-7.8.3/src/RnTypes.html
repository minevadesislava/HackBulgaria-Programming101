<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>rename/RnTypes.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[RnSource]{Main pass of renamer}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RnTypes</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-comment'>-- Type related stuff</span>
<a name="line-3"></a>        <span class='hs-varid'>rnHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnContext</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>rnHsKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsMaybeKind</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>rnHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsInstType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnConDeclFields</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>newTyVarNameRn</span><span class='hs-layout'>,</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-comment'>-- Precence related stuff</span>
<a name="line-9"></a>        <span class='hs-varid'>mkOpAppRn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNegAppRn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOpFormRn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkConOpPatRn</span><span class='hs-layout'>,</span>
<a name="line-10"></a>        <span class='hs-varid'>checkPrecMatch</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkSectionPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnUnusedForAlls</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-comment'>-- Binding related stuff</span>
<a name="line-13"></a>        <span class='hs-varid'>bindSigTyVarsFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindHsTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnHsBndrSig</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>extractHsTyRdrTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>extractHsTysRdrTyVars</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>extractRdrKindSigVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>extractDataDefnKindVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterInScope</span>
<a name="line-16"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>runQuasiQuoteType</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>RnSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>rnSpliceType</span> <span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnHsDoc</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>rnLHsDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnMbLHsDoc</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>funTyConName</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>compareFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>funTyFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>negateFixity</span><span class='hs-layout'>,</span>
<a name="line-35"></a>                          <span class='hs-conid'>Fixity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityDirection</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>when</span> <span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
</pre>\end{code}

These type renamers are in a separate module, rather than in (say) RnSource,
to break several loop.

%*********************************************************
%*                                                      *
\subsection{Renaming types}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnHsSigType"></a><span class='hs-definition'>rnHsSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-2"></a>        <span class='hs-comment'>-- rnHsSigType is used for source-language type signatures,</span>
<a name="line-3"></a>        <span class='hs-comment'>-- which use *implicit* universal quantification.</span>
<a name="line-4"></a><span class='hs-definition'>rnHsSigType</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSigCtx</span> <span class='hs-varid'>doc_str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="rnLHsInstType"></a><span class='hs-definition'>rnLHsInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-comment'>-- Rename the type in an instance or standalone deriving decl</span>
<a name="line-8"></a><span class='hs-definition'>rnLHsInstType</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>ty</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericCtx</span> <span class='hs-varid'>doc_str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>good_inst_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badInstTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>good_inst_ty</span>
<a name="line-14"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsInstDeclTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-15"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isTcOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-16"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="badInstTy"></a><span class='hs-definition'>badInstTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-19"></a><span class='hs-definition'>badInstTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed instance:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
</pre>\end{code}

rnHsType is here because we call it from loadInstDecl, and I didn't
want a gratuitous knot.

\begin{code}
<pre><a name="line-1"></a><a name="rnLHsTyKi"></a><span class='hs-definition'>rnLHsTyKi</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>--  True &lt;=&gt; renaming a type, False &lt;=&gt; a kind</span>
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-5"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="rnLHsType"></a><span class='hs-definition'>rnLHsType</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>rnLHsType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-conid'>True</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="rnLHsKind"></a><span class='hs-definition'>rnLHsKind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>rnLHsKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-conid'>False</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="rnLHsMaybeKind"></a><span class='hs-definition'>rnLHsMaybeKind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-15"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-definition'>rnLHsMaybeKind</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>rnLHsMaybeKind</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsKind</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kind</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="rnHsType"></a><span class='hs-definition'>rnHsType</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-definition'>rnHsType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsTyKi</span> <span class='hs-conid'>True</span>
<a name="line-24"></a><a name="rnHsKind"></a><span class='hs-definition'>rnHsKind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>rnHsKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsTyKi</span> <span class='hs-conid'>False</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="rnHsTyKi"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Implicit</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lctxt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-31"></a>        <span class='hs-comment'>-- Implicit quantifiction in source code (no kinds on tyvars)</span>
<a name="line-32"></a>        <span class='hs-comment'>-- Given the signature  C =&gt; T  we universally quantify</span>
<a name="line-33"></a>        <span class='hs-comment'>-- over FV(T) \ {in-scope-tyvars}</span>
<a name="line-34"></a>    <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-35"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-36"></a>    <span class='hs-keyword'>let</span>
<a name="line-37"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>forall_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>forall_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterInScope</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varop'>$</span>
<a name="line-38"></a>                                   <span class='hs-varid'>extractHsTysRdrTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-39"></a>           <span class='hs-comment'>-- In for-all types we don't bring in scope</span>
<a name="line-40"></a>           <span class='hs-comment'>-- kind variables mentioned in kind signatures</span>
<a name="line-41"></a>           <span class='hs-comment'>-- (Well, not yet anyway....)</span>
<a name="line-42"></a>           <span class='hs-comment'>--    f :: Int -&gt; T (a::k)    -- Not allowed</span>
<a name="line-43"></a>
<a name="line-44"></a>           <span class='hs-comment'>-- The filterInScope is to ensure that we don't quantify over</span>
<a name="line-45"></a>           <span class='hs-comment'>-- type variables that are in scope; when GlasgowExts is off,</span>
<a name="line-46"></a>           <span class='hs-comment'>-- there usually won't be any, except for class signatures:</span>
<a name="line-47"></a>           <span class='hs-comment'>--   class C a where { op :: a -&gt; a }</span>
<a name="line-48"></a>        <span class='hs-varid'>tyvar_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>userHsTyVarBndrs</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>forall_tvs</span>
<a name="line-49"></a>
<a name="line-50"></a>    <span class='hs-varid'>rnForAll</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>Implicit</span> <span class='hs-varid'>forall_kvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsQTvs</span> <span class='hs-varid'>tyvar_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>lctxt</span> <span class='hs-varid'>ty</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Explicit</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>lctxt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>      <span class='hs-comment'>-- Explicit quantification.</span>
<a name="line-54"></a>         <span class='hs-comment'>-- Check that the forall'd tyvars are actually</span>
<a name="line-55"></a>         <span class='hs-comment'>-- mentioned in the type, and produce a warning if not</span>
<a name="line-56"></a>         <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mentioned</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractHsTysRdrTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tau</span><span class='hs-conop'>:</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-57"></a>             <span class='hs-varid'>in_type_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-58"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedForAlls</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_type_doc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>mentioned</span>
<a name="line-59"></a>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rnForAll</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>Explicit</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>lctxt</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnTyVar</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>rdr_name</span>
<a name="line-64"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-comment'>-- If we see (forall a . ty), without foralls on, the forall will give</span>
<a name="line-67"></a><span class='hs-comment'>-- a sensible error message, but we don't want to complain about the dot too</span>
<a name="line-68"></a><span class='hs-comment'>-- Hence the jiggery pokery with ty1</span>
<a name="line-69"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-71"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ops_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_TypeOperators</span>
<a name="line-72"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ops_ok</span>
<a name="line-73"></a>                 <span class='hs-keyword'>then</span> <span class='hs-varid'>rnTyVar</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>op</span>
<a name="line-74"></a>                 <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>opTyErr</span> <span class='hs-varid'>op</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-75"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnboundName</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- Avoid double complaint</span>
<a name="line-76"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>l_op'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>op'</span>
<a name="line-77"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTyFixityRn</span> <span class='hs-varid'>l_op'</span>
<a name="line-78"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-79"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-80"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHsOpTyRn</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>l_op'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-81"></a>                               <span class='hs-varid'>op'</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span>
<a name="line-82"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>op'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-86"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-90"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Record syntax is illegal here:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-95"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnConDeclFields</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>flds</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>
<a name="line-99"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-101"></a>        <span class='hs-comment'>-- Might find a for-all as the arg of a function type</span>
<a name="line-102"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-103"></a>        <span class='hs-comment'>-- Or as the result.  This happens when reading Prelude.hi</span>
<a name="line-104"></a>        <span class='hs-comment'>-- when we find return :: forall m. Monad m -&gt; forall a. a -&gt; m a</span>
<a name="line-105"></a>
<a name="line-106"></a>        <span class='hs-comment'>-- Check for fixity rearrangements</span>
<a name="line-107"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isType</span>
<a name="line-108"></a>                   <span class='hs-keyword'>then</span> <span class='hs-varid'>mkHsOpTyRn</span> <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>funTyConName</span> <span class='hs-varid'>funTyFixity</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span>
<a name="line-109"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>listTy</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-114"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>listTy</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-115"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-116"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-120"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind_sigs_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_KindSignatures</span>
<a name="line-121"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>kind_sigs_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSigErr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-122"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-123"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsKind</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>k</span>
<a name="line-124"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>k'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-125"></a>
<a name="line-126"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-128"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-129"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-comment'>-- Unboxed tuples are allowed to have poly-typed arguments.  These</span>
<a name="line-132"></a><span class='hs-comment'>-- sometimes crop up as a result of CPR worker-wrappering dictionaries.</span>
<a name="line-133"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tupleTy</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>tup_con</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-134"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-135"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>tupleTy</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-136"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-137"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>tup_con</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-138"></a>
<a name="line-139"></a><span class='hs-comment'>-- Perhaps we should use a separate extension here?</span>
<a name="line-140"></a><span class='hs-comment'>-- Ensure that a type-level integer is nonnegative (#8306, #8412)</span>
<a name="line-141"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tyLit</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-143"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>tyLit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-144"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>negLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-varid'>negLitErr</span><span class='hs-layout'>)</span>
<a name="line-145"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-146"></a>  <span class='hs-keyword'>where</span>
<a name="line-147"></a>    <span class='hs-varid'>negLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-148"></a>    <span class='hs-varid'>negLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNumTy</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>
<a name="line-149"></a>    <span class='hs-varid'>negLitErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal literal in type (type literals must not be negative):"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyLit</span>
<a name="line-150"></a>
<a name="line-151"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-153"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-154"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-158"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-159"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-162"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-163"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-164"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-165"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-169"></a>    <span class='hs-varid'>rnSpliceType</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>k</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>haddock_doc</span><span class='hs-layout'>)</span>
<a name="line-172"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-173"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-174"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>haddock_doc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsDoc</span> <span class='hs-varid'>haddock_doc</span>
<a name="line-175"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>haddock_doc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-varid'>qq</span><span class='hs-layout'>)</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-179"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runQuasiQuoteType</span> <span class='hs-varid'>qq</span>
<a name="line-180"></a>         <span class='hs-comment'>-- Wrap the result of the quasi-quoter in parens so that we don't</span>
<a name="line-181"></a>         <span class='hs-comment'>-- lose the outermost location set by runQuasiQuote (#7918) </span>
<a name="line-182"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rnHsType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-183"></a>
<a name="line-184"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-186"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-187"></a>    <span class='hs-comment'>-- The emptyFVs probably isn't quite right</span>
<a name="line-188"></a>    <span class='hs-comment'>-- but I don't think it matters</span>
<a name="line-189"></a>
<a name="line-190"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rnHsTyKi"</span>
<a name="line-192"></a>
<a name="line-193"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-194"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-195"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-196"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-197"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tys</span>
<a name="line-198"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-varid'>kis</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-201"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-202"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-203"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-204"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tys</span>
<a name="line-205"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-varid'>kis</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-206"></a>
<a name="line-207"></a><a name="rnTyVar"></a><span class='hs-comment'>--------------</span>
<a name="line-208"></a><span class='hs-definition'>rnTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>Name</span>
<a name="line-209"></a><span class='hs-definition'>rnTyVar</span> <span class='hs-varid'>is_type</span> <span class='hs-varid'>rdr_name</span>
<a name="line-210"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupTypeOccRn</span> <span class='hs-varid'>rdr_name</span>
<a name="line-211"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupKindOccRn</span> <span class='hs-varid'>rdr_name</span>
<a name="line-212"></a>
<a name="line-213"></a>
<a name="line-214"></a><a name="rnLHsTypes"></a><span class='hs-comment'>--------------</span>
<a name="line-215"></a><span class='hs-definition'>rnLHsTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-216"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-217"></a><span class='hs-definition'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="rnForAll"></a><span class='hs-definition'>rnForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExplicitFlag</span>
<a name="line-2"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>                <span class='hs-comment'>-- Kind variables</span>
<a name="line-3"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span>   <span class='hs-comment'>-- Type variables</span>
<a name="line-4"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-5"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>rnForAll</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsQTvBndrs</span> <span class='hs-varid'>forall_tyvars</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>        <span class='hs-comment'>-- One reason for this case is that a type like Int#</span>
<a name="line-11"></a>        <span class='hs-comment'>-- starts off as (HsForAllTy Nothing [] Int), in case</span>
<a name="line-12"></a>        <span class='hs-comment'>-- there is some quantification.  Now that we have quantified</span>
<a name="line-13"></a>        <span class='hs-comment'>-- and discovered there are no type variables, it's nicer to turn</span>
<a name="line-14"></a>        <span class='hs-comment'>-- it into plain Int.  If it were Int# instead of Int, we'd actually</span>
<a name="line-15"></a>        <span class='hs-comment'>-- get an error, because the body of a genuine for-all is</span>
<a name="line-16"></a>        <span class='hs-comment'>-- of kind *.</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindHsTyVars</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>new_tyvars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-20"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnContext</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ctxt</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>new_tyvars</span> <span class='hs-varid'>new_ctxt</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>        <span class='hs-comment'>-- Retain the same implicit/explicit flag as before</span>
<a name="line-24"></a>        <span class='hs-comment'>-- so that we can later print it correctly</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="bindSigTyVarsFV"></a><span class='hs-comment'>---------------</span>
<a name="line-27"></a><span class='hs-definition'>bindSigTyVarsFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-28"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-comment'>-- Used just before renaming the defn of a function</span>
<a name="line-31"></a><span class='hs-comment'>-- with a separate type signature, to bring its tyvars into scope</span>
<a name="line-32"></a><span class='hs-comment'>-- With no -XScopedTypeVariables, this is a no-op</span>
<a name="line-33"></a><span class='hs-definition'>bindSigTyVarsFV</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>scoped_tyvars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ScopedTypeVariables</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>scoped_tyvars</span> <span class='hs-keyword'>then</span>
<a name="line-36"></a>                <span class='hs-varid'>thing_inside</span>
<a name="line-37"></a>          <span class='hs-keyword'>else</span>
<a name="line-38"></a>                <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="bindHsTyVars"></a><span class='hs-comment'>---------------</span>
<a name="line-41"></a><span class='hs-definition'>bindHsTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span>
<a name="line-42"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>                 <span class='hs-comment'>-- Just _  =&gt; an associated type decl</span>
<a name="line-43"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>               <span class='hs-comment'>-- Kind variables from scope</span>
<a name="line-44"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span>   <span class='hs-comment'>-- Type variables</span>
<a name="line-45"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-comment'>-- (a) Bring kind variables into scope</span>
<a name="line-48"></a><span class='hs-comment'>--     both (i)  passed in (kv_bndrs)</span>
<a name="line-49"></a><span class='hs-comment'>--     and  (ii) mentioned in the kinds of tv_bndrs</span>
<a name="line-50"></a><span class='hs-comment'>-- (b) Bring type variables into scope</span>
<a name="line-51"></a><span class='hs-definition'>bindHsTyVars</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>kv_bndrs</span> <span class='hs-varid'>tv_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsQTvBndrs</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-54"></a>             <span class='hs-varid'>kvs_from_tv_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span>
<a name="line-55"></a>                                 <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractHsTyRdrTyVars</span> <span class='hs-varid'>kind</span>
<a name="line-56"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>]</span>
<a name="line-57"></a>             <span class='hs-varid'>all_kvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>kvs_from_tv_bndrs</span><span class='hs-layout'>)</span>
<a name="line-58"></a>             <span class='hs-varid'>all_kvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs'</span>
<a name="line-59"></a>
<a name="line-60"></a>             <span class='hs-varid'>overlap_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsLTyVarName</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span>
<a name="line-61"></a>                <span class='hs-comment'>-- These variables appear both as kind and type variables</span>
<a name="line-62"></a>                <span class='hs-comment'>-- in the same declaration; eg  type family  T (x :: *) (y :: x)</span>
<a name="line-63"></a>                <span class='hs-comment'>-- We disallow this: too confusing!</span>
<a name="line-64"></a>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>poly_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PolyKinds</span>
<a name="line-66"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_kind</span> <span class='hs-varop'>||</span> <span class='hs-varid'>null</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>badKindBndrs</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>overlap_kvs</span><span class='hs-layout'>)</span>
<a name="line-69"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>overlappingKindVars</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>overlap_kvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kv_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newLocalBndrRn</span> <span class='hs-varop'>.</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs</span>
<a name="line-73"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>kv_names</span> <span class='hs-varop'>$</span>
<a name="line-74"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_names_w_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLTyVarLocNames</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-75"></a>
<a name="line-76"></a>             <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-77"></a>             <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-78"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTyVarNameRn</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span>
<a name="line-79"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>             <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>rdr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-81"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_KindSignatures</span>
<a name="line-82"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>sig_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSigErr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-83"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTyVarNameRn</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span>
<a name="line-84"></a>                    <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsKind</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kind</span>
<a name="line-85"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a>       <span class='hs-comment'>-- Check for duplicate or shadowed tyvar bindrs</span>
<a name="line-88"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkDupRdrNames</span> <span class='hs-varid'>tv_names_w_loc</span>
<a name="line-89"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_assoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkShadowedRdrNames</span> <span class='hs-varid'>tv_names_w_loc</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-varid'>tvs</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>hsLTyVarName</span> <span class='hs-varid'>tv_bndrs'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-93"></a>                        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inner_rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-94"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"bhtv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span>
<a name="line-95"></a>                                 <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs_from_tv_bndrs</span>
<a name="line-96"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs'</span>
<a name="line-97"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rdrNameOcc</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs'</span>
<a name="line-98"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inner_rdr_env</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-99"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_names</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-100"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="newTyVarNameRn"></a><span class='hs-definition'>newTyVarNameRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>Name</span>
<a name="line-103"></a><span class='hs-definition'>newTyVarNameRn</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_assoc</span>    <span class='hs-comment'>-- Use the same Name as the parent class decl</span>
<a name="line-105"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocalRdrEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>rdr</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newLocalBndrRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="rnHsBndrSig"></a><span class='hs-comment'>--------------------------------</span>
<a name="line-111"></a><span class='hs-definition'>rnHsBndrSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span>
<a name="line-112"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWithBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-113"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWithBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-114"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-115"></a><span class='hs-definition'>rnHsBndrSig</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswb_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ScopedTypeVariables</span>
<a name="line-117"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>sig_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSigErr</span> <span class='hs-conid'>True</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-118"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractHsTyRdrTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-119"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>name_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-120"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tv_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalBndrsRn</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-121"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>name_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-122"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kv_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalBndrsRn</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kv_bndrs</span>
<a name="line-123"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv</span> <span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>name_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-124"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>kv_names</span> <span class='hs-varop'>$</span>
<a name="line-125"></a>         <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>tv_names</span> <span class='hs-varop'>$</span>
<a name="line-126"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-127"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswb_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_names</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-128"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="overlappingKindVars"></a><span class='hs-definition'>overlappingKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-131"></a><span class='hs-definition'>overlappingKindVars</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kvs</span>
<a name="line-132"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-133"></a>           <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"also used as type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>kvs</span>
<a name="line-134"></a>           <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>kvs</span>
<a name="line-135"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="badKindBndrs"></a><span class='hs-definition'>badKindBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-138"></a><span class='hs-definition'>badKindBndrs</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kvs</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>kvs</span>
<a name="line-140"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span>
<a name="line-141"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use PolyKinds"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-142"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="badSigErr"></a><span class='hs-definition'>badSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-145"></a><span class='hs-definition'>badSigErr</span> <span class='hs-varid'>is_type</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-147"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span>
<a name="line-148"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"signature:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-149"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span>
<a name="line-150"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-151"></a>  <span class='hs-keyword'>where</span>
<a name="line-152"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-153"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind"</span><span class='hs-layout'>)</span>
<a name="line-154"></a>    <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ScopedTypeVariables"</span><span class='hs-layout'>)</span>
<a name="line-155"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"KindSignatures"</span><span class='hs-layout'>)</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="dataKindsErr"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-158"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-varid'>is_type</span> <span class='hs-varid'>thing</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-160"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-161"></a>  <span class='hs-keyword'>where</span>
<a name="line-162"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-163"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind"</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Renaming associated types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Check that the RHS of the decl mentions only type variables
bound on the LHS.  For example, this is not ok
   class C a b where
      type F a x :: *
   instance C (p,q) r where
      type F (p,q) x = (x, r)   -- BAD: mentions 'r'
c.f. Trac #5515

What makes it tricky is that the *kind* variable from the class *are*
in scope (Trac #5862):
    class Category (x :: k -> k -> *) where
      type Ob x :: k -> Constraint
      id :: Ob x a => x a a
      (.) :: (Ob x a, Ob x b, Ob x c) => x b c -> x a b -> x a c
Here 'k' is in scope in the kind signature even though it's not
explicitly mentioned on the LHS of the type Ob declaration.

We could force you to mention k explicitly, thus
    class Category (x :: k -> k -> *) where
      type Ob (x :: k -> k -> *) :: k -> Constraint
but it seems tiresome to do so.


%*********************************************************
%*                                                      *
\subsection{Contexts and predicates}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="rnConDeclFields"></a><span class='hs-definition'>rnConDeclFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ConDeclField</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ConDeclField</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>rnConDeclFields</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>fields</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnField</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>fields</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="rnField"></a><span class='hs-definition'>rnField</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConDeclField</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>rnField</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>haddock_doc</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocatedTopBndrRn</span> <span class='hs-varid'>name</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_haddock_doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMbLHsDoc</span> <span class='hs-varid'>haddock_doc</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-varid'>new_name</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>new_haddock_doc</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="rnContext"></a><span class='hs-definition'>rnContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-definition'>rnContext</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>cxt</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Fixities and precedence parsing
%*                                                                      *
%************************************************************************

@mkOpAppRn@ deals with operator fixities.  The argument expressions
are assumed to be already correctly arranged.  It needs the fixities
recorded in the OpApp nodes, because fixity info applies to the things
the programmer actually wrote, so you can't find it out from the Name.

Furthermore, the second argument is guaranteed not to be another
operator application.  Why? Because the parser parses all
operator appications left-associatively, EXCEPT negation, which
we need to handle specially.
Infix types are read in a *right-associative* way, so that
        a `op` b `op` c
is always read in as
        a `op` (b `op` c)

mkHsOpTyRn rearranges where necessary.  The two arguments
have already been renamed and rearranged.  It's made rather tiresome
by the presence of ->, which is a separate syntactic construct.

\begin{code}
<pre><a name="line-1"></a><a name="mkHsOpTyRn"></a><span class='hs-comment'>---------------</span>
<a name="line-2"></a><span class='hs-comment'>-- Building (ty1 `op1` (ty21 `op2` ty22))</span>
<a name="line-3"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-4"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span>
<a name="line-5"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty21</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2</span><span class='hs-layout'>,</span> <span class='hs-varid'>op2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>fix2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTyFixityRn</span> <span class='hs-varid'>op2</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mk_hs_op_ty</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span>
<a name="line-10"></a>                      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2</span><span class='hs-layout'>,</span> <span class='hs-varid'>op2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_hs_op_ty</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span>
<a name="line-15"></a>                <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>funTyConName</span> <span class='hs-varid'>funTyFixity</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span> <span class='hs-varid'>loc2</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>              <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk1</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="mk_hs_op_ty"></a><span class='hs-comment'>---------------</span>
<a name="line-21"></a><span class='hs-definition'>mk_hs_op_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-22"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span>
<a name="line-23"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-24"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-25"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-definition'>mk_hs_op_ty</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span>
<a name="line-27"></a>            <span class='hs-varid'>mk2</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span> <span class='hs-varid'>loc2</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Rearrange to ((ty1 `op1` ty21) `op2` ty22)</span>
<a name="line-32"></a>                           <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty21</span>
<a name="line-33"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk2</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>  <span class='hs-keyword'>where</span>
<a name="line-35"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-36"></a>
<a name="line-37"></a>
<a name="line-38"></a><a name="mkOpAppRn"></a><span class='hs-comment'>---------------------------</span>
<a name="line-39"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>                       <span class='hs-comment'>-- Left operand; already rearranged</span>
<a name="line-40"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span>             <span class='hs-comment'>-- Operator and fixity</span>
<a name="line-41"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>                       <span class='hs-comment'>-- Right operand (not an OpApp, but might</span>
<a name="line-42"></a>                                                <span class='hs-comment'>-- be a NegApp)</span>
<a name="line-43"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-comment'>-- (e11 `op1` e12) `op2` e2</span>
<a name="line-46"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e11</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>e12</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-49"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-52"></a>    <span class='hs-varid'>new_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpAppRn</span> <span class='hs-varid'>e12</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-53"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e11</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>new_e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyword'>where</span>
<a name="line-55"></a>    <span class='hs-varid'>loc'</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>combineLocs</span> <span class='hs-varid'>e12</span> <span class='hs-varid'>e2</span>
<a name="line-56"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-comment'>---------------------------</span>
<a name="line-59"></a><span class='hs-comment'>--      (- neg_arg) `op` e2</span>
<a name="line-60"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>neg_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>negateName</span><span class='hs-layout'>,</span><span class='hs-varid'>negateFixity</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-63"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpAppRn</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-67"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>new_e</span><span class='hs-layout'>)</span> <span class='hs-varid'>neg_name</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-varid'>loc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combineLocs</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>e2</span>
<a name="line-70"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>negateFixity</span> <span class='hs-varid'>fix2</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-comment'>---------------------------</span>
<a name="line-73"></a><span class='hs-comment'>--      e1 `op` - neg_arg</span>
<a name="line-74"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>e2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- NegApp can occur on the right</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>associate_right</span>                 <span class='hs-comment'>-- We *want* right association</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>negateName</span><span class='hs-layout'>,</span> <span class='hs-varid'>negateFixity</span><span class='hs-layout'>)</span>
<a name="line-77"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-78"></a>  <span class='hs-keyword'>where</span>
<a name="line-79"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>negateFixity</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-comment'>---------------------------</span>
<a name="line-82"></a><span class='hs-comment'>--      Default case</span>
<a name="line-83"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>e2</span>                  <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>right_op_ok</span> <span class='hs-varid'>fix</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-85"></a>             <span class='hs-varid'>ppr</span> <span class='hs-varid'>e1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fix</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e2</span>
<a name="line-86"></a>    <span class='hs-layout'>)</span>
<a name="line-87"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="get_op"></a><span class='hs-comment'>----------------------------</span>
<a name="line-90"></a><span class='hs-definition'>get_op</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-91"></a><span class='hs-definition'>get_op</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-92"></a><span class='hs-definition'>get_op</span> <span class='hs-varid'>other</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"get_op"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="right_op_ok"></a><span class='hs-comment'>-- Parser left-associates everything, but</span>
<a name="line-95"></a><span class='hs-comment'>-- derived instances may have correctly-associated things to</span>
<a name="line-96"></a><span class='hs-comment'>-- in the right operarand.  So we just check that the right operand is OK</span>
<a name="line-97"></a><span class='hs-definition'>right_op_ok</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-98"></a><span class='hs-definition'>right_op_ok</span> <span class='hs-varid'>fix1</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fix2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varid'>error_please</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>associate_right</span>
<a name="line-100"></a>  <span class='hs-keyword'>where</span>
<a name="line-101"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>error_please</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-102"></a><span class='hs-definition'>right_op_ok</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="mkNegAppRn"></a><span class='hs-comment'>-- Parser initially makes negation bind more tightly than any other operator</span>
<a name="line-106"></a><span class='hs-comment'>-- And "deriving" code should respect this (use HsPar if not)</span>
<a name="line-107"></a><span class='hs-definition'>mkNegAppRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SyntaxExpr</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-definition'>mkNegAppRn</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>neg_name</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not_op_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>neg_arg</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-110"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>neg_name</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="not_op_app"></a><span class='hs-definition'>not_op_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-113"></a><span class='hs-definition'>not_op_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-114"></a><span class='hs-definition'>not_op_app</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="mkOpFormRn"></a><span class='hs-comment'>---------------------------</span>
<a name="line-117"></a><span class='hs-definition'>mkOpFormRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>Name</span>            <span class='hs-comment'>-- Left operand; already rearranged</span>
<a name="line-118"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span>     <span class='hs-comment'>-- Operator and fixity</span>
<a name="line-119"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>Name</span>             <span class='hs-comment'>-- Right operand (not an infix)</span>
<a name="line-120"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a><span class='hs-comment'>-- (e11 `op1` e12) `op2` e2</span>
<a name="line-123"></a><span class='hs-definition'>mkOpFormRn</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a11</span><span class='hs-layout'>,</span><span class='hs-varid'>a12</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-124"></a>        <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>a2</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-127"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op2</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a1</span><span class='hs-layout'>,</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-128"></a>
<a name="line-129"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpFormRn</span> <span class='hs-varid'>a12</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>a2</span>
<a name="line-131"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix1</span><span class='hs-layout'>)</span>
<a name="line-132"></a>                  <span class='hs-keyglyph'>[</span><span class='hs-varid'>a11</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_c</span><span class='hs-layout'>)</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-133"></a>        <span class='hs-comment'>-- TODO: locs are wrong</span>
<a name="line-134"></a>  <span class='hs-keyword'>where</span>
<a name="line-135"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-comment'>--      Default case</span>
<a name="line-138"></a><span class='hs-definition'>mkOpFormRn</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>arg2</span>                     <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-140"></a>
<a name="line-141"></a>
<a name="line-142"></a><a name="mkConOpPatRn"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-143"></a><span class='hs-definition'>mkConOpPatRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span>
<a name="line-144"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-145"></a>
<a name="line-146"></a><span class='hs-definition'>mkConOpPatRn</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>p1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p11</span> <span class='hs-varid'>p12</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>p2</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>fix1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>)</span>
<a name="line-148"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-149"></a>
<a name="line-150"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>nofix_error</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-151"></a>                <span class='hs-layout'>{</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-152"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op2</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-153"></a>
<a name="line-154"></a>          <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>associate_right</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-155"></a>                <span class='hs-layout'>{</span> <span class='hs-varid'>new_p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkConOpPatRn</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>p12</span> <span class='hs-varid'>p2</span>
<a name="line-156"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p11</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- XXX loc right?</span>
<a name="line-157"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op2</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-158"></a>
<a name="line-159"></a><span class='hs-definition'>mkConOpPatRn</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span>                         <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-160"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not_op_pat</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-161"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="not_op_pat"></a><span class='hs-definition'>not_op_pat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-164"></a><span class='hs-definition'>not_op_pat</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-165"></a><span class='hs-definition'>not_op_pat</span> <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="checkPrecMatch"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-168"></a><span class='hs-definition'>checkPrecMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-169"></a>  <span class='hs-comment'>-- Check precedence of a function binding written infix</span>
<a name="line-170"></a>  <span class='hs-comment'>--   eg  a `op` b `C` c = ...</span>
<a name="line-171"></a>  <span class='hs-comment'>-- See comments with rnExpr (OpApp ...) about "deriving"</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-definition'>checkPrecMatch</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check</span> <span class='hs-varid'>ms</span>
<a name="line-175"></a>  <span class='hs-keyword'>where</span>
<a name="line-176"></a>    <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>p1</span> <span class='hs-conop'>:</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l2</span> <span class='hs-varid'>p2</span> <span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-177"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>combineSrcSpans</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-178"></a>        <span class='hs-keyword'>do</span> <span class='hs-varid'>checkPrec</span> <span class='hs-varid'>op</span> <span class='hs-varid'>p1</span> <span class='hs-conid'>False</span>
<a name="line-179"></a>           <span class='hs-varid'>checkPrec</span> <span class='hs-varid'>op</span> <span class='hs-varid'>p2</span> <span class='hs-conid'>True</span>
<a name="line-180"></a>
<a name="line-181"></a>    <span class='hs-varid'>check</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-182"></a>        <span class='hs-comment'>-- This can happen.  Consider</span>
<a name="line-183"></a>        <span class='hs-comment'>--      a `op` True = ...</span>
<a name="line-184"></a>        <span class='hs-comment'>--      op          = ...</span>
<a name="line-185"></a>        <span class='hs-comment'>-- The infix flag comes from the first binding of the group</span>
<a name="line-186"></a>        <span class='hs-comment'>-- but the second eqn has no args (an error, but not discovered</span>
<a name="line-187"></a>        <span class='hs-comment'>-- until the type checker).  So we don't want to crash on the</span>
<a name="line-188"></a>        <span class='hs-comment'>-- second eqn.</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="checkPrec"></a><span class='hs-definition'>checkPrec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span> <span class='hs-conid'>()</span>
<a name="line-191"></a><span class='hs-definition'>checkPrec</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>right</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-192"></a>    <span class='hs-varid'>op_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>op_prec</span>  <span class='hs-varid'>op_dir</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>op</span>
<a name="line-193"></a>    <span class='hs-varid'>op1_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>op1_prec</span> <span class='hs-varid'>op1_dir</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>)</span>
<a name="line-194"></a>    <span class='hs-keyword'>let</span>
<a name="line-195"></a>        <span class='hs-varid'>inf_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>op1_prec</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>op_prec</span> <span class='hs-varop'>||</span>
<a name="line-196"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>op1_prec</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op_prec</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-197"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>op1_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixR</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>op_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixR</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>right</span> <span class='hs-varop'>||</span>
<a name="line-198"></a>                   <span class='hs-varid'>op1_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixL</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>op_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixL</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>right</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a>        <span class='hs-varid'>info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span>        <span class='hs-varid'>op_fix</span><span class='hs-layout'>)</span>
<a name="line-201"></a>        <span class='hs-varid'>info1</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span> <span class='hs-varid'>op1_fix</span><span class='hs-layout'>)</span>
<a name="line-202"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>infol</span><span class='hs-layout'>,</span> <span class='hs-varid'>infor</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>right</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>info1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>info1</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-203"></a>    <span class='hs-varid'>unless</span> <span class='hs-varid'>inf_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>precParseErr</span> <span class='hs-varid'>infol</span> <span class='hs-varid'>infor</span><span class='hs-layout'>)</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-definition'>checkPrec</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-206"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-207"></a>
<a name="line-208"></a><a name="checkSectionPrec"></a><span class='hs-comment'>-- Check precedence of (arg op) or (op arg) respectively</span>
<a name="line-209"></a><span class='hs-comment'>-- If arg is itself an operator application, then either</span>
<a name="line-210"></a><span class='hs-comment'>--   (a) its precedence must be higher than that of op</span>
<a name="line-211"></a><span class='hs-comment'>--   (b) its precedency &amp; associativity must be the same as that of op</span>
<a name="line-212"></a><span class='hs-definition'>checkSectionPrec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FixityDirection</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-213"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-214"></a><span class='hs-definition'>checkSectionPrec</span> <span class='hs-varid'>direction</span> <span class='hs-varid'>section</span> <span class='hs-varid'>op</span> <span class='hs-varid'>arg</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>of</span>
<a name="line-216"></a>        <span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_for_it</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix</span>
<a name="line-217"></a>        <span class='hs-conid'>NegApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_for_it</span> <span class='hs-varid'>negateName</span>  <span class='hs-varid'>negateFixity</span>
<a name="line-218"></a>        <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-219"></a>  <span class='hs-keyword'>where</span>
<a name="line-220"></a>    <span class='hs-varid'>op_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_op</span> <span class='hs-varid'>op</span>
<a name="line-221"></a>    <span class='hs-varid'>go_for_it</span> <span class='hs-varid'>arg_op</span> <span class='hs-varid'>arg_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>arg_prec</span> <span class='hs-varid'>assoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-222"></a>          <span class='hs-varid'>op_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>op_prec</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>op_name</span>
<a name="line-223"></a>          <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_prec</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>arg_prec</span>
<a name="line-224"></a>                  <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_prec</span> <span class='hs-varop'>==</span> <span class='hs-varid'>arg_prec</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>direction</span> <span class='hs-varop'>==</span> <span class='hs-varid'>assoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-225"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>sectionPrecErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_fix</span><span class='hs-layout'>)</span>
<a name="line-226"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>arg_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_fix</span><span class='hs-layout'>)</span> <span class='hs-varid'>section</span><span class='hs-layout'>)</span>
</pre>\end{code}

Precedence-related error messages

\begin{code}
<pre><a name="line-1"></a><a name="precParseErr"></a><span class='hs-definition'>precParseErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>precParseErr</span> <span class='hs-varid'>op1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>op2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n2</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>     <span class='hs-comment'>-- Avoid error cascade</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Precedence parsing error"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>      <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot mix"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-8"></a>               <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span>
<a name="line-9"></a>               <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the same infix expression"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="sectionPrecErr"></a><span class='hs-definition'>sectionPrecErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-12"></a><span class='hs-definition'>sectionPrecErr</span> <span class='hs-varid'>op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>section</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n2</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>     <span class='hs-comment'>-- Avoid error cascade</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The operator"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>op</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of a section"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-17"></a>         <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must have lower precedence than that of the operand,"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-18"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"namely"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>arg_op</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-19"></a>         <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the section:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>section</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="ppr_opfix"></a><span class='hs-definition'>ppr_opfix</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-22"></a><span class='hs-definition'>ppr_opfix</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_op</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span>
<a name="line-23"></a>   <span class='hs-keyword'>where</span>
<a name="line-24"></a>     <span class='hs-varid'>pp_op</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>==</span> <span class='hs-varid'>negateName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"prefix `-'"</span><span class='hs-layout'>)</span>
<a name="line-25"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
</pre>\end{code}

%*********************************************************
%*                                                      *
\subsection{Errors}
%*                                                      *
%*********************************************************

\begin{code}
<pre><a name="line-1"></a><a name="warnUnusedForAlls"></a><span class='hs-definition'>warnUnusedForAlls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>warnUnusedForAlls</span> <span class='hs-varid'>in_doc</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>mentioned_rdrs</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnUnusedMatches</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-varid'>add_warn</span> <span class='hs-varid'>bound_but_not_used</span>
<a name="line-5"></a>  <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-varid'>bound_names</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLTyVarLocNames</span> <span class='hs-varid'>bound</span>
<a name="line-7"></a>    <span class='hs-varid'>bound_but_not_used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>mentioned_rdrs</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>bound_names</span>
<a name="line-8"></a>
<a name="line-9"></a>    <span class='hs-varid'>add_warn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-10"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnAt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-11"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unused quantified type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-12"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>in_doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="opTyErr"></a><span class='hs-definition'>opTyErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-15"></a><span class='hs-definition'>opTyErr</span> <span class='hs-varid'>op</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal operator"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>         <span class='hs-num'>2</span> <span class='hs-varid'>extra</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dot_tv_RDR</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>forall_head</span> <span class='hs-varid'>ty1</span>
<a name="line-20"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>perhapsForallMsg</span>
<a name="line-21"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-22"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use TypeOperators to allow operators in types"</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-varid'>forall_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>forall_tv_RDR</span>
<a name="line-25"></a>    <span class='hs-varid'>forall_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>forall_head</span> <span class='hs-varid'>ty</span>
<a name="line-26"></a>    <span class='hs-varid'>forall_head</span> <span class='hs-sel'>_other</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-27"></a><span class='hs-definition'>opTyErr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"opTyErr: Not an op"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
      Finding the free type variables of a (HsType RdrName)
%*                                                                    *
%************************************************************************


Note [Kind and type-variable binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a type signature we may implicitly bind type varaible and, more
recently, kind variables.  For example:
  *   f :: a -> a
      f = ...
    Here we need to find the free type variables of (a -> a),
    so that we know what to quantify

  *   class C (a :: k) where ...
    This binds 'k' in ..., as well as 'a'

  *   f (x :: a -> [a]) = ....
    Here we bind 'a' in ....

  *   f (x :: T a -> T (b :: k)) = ...
    Here we bind both 'a' and the kind variable 'k'

  *   type instance F (T (a :: Maybe k)) = ...a...k...
    Here we want to constrain the kind of 'a', and bind 'k'.

In general we want to walk over a type, and find
  * Its free type variables
  * The free kind variables of any kind signatures in the type

Hence we returns a pair (kind-vars, type vars)
See also Note [HsBSig binder lists] in HsTypes

\begin{code}
<pre><a name="line-1"></a><a name="FreeKiTyVars"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="filterInScope"></a><span class='hs-definition'>filterInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-4"></a><span class='hs-definition'>filterInScope</span> <span class='hs-varid'>rdr_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOut</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterOut</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>rdr_env</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="extractHsTyRdrTyVars"></a><span class='hs-definition'>extractHsTyRdrTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-10"></a><span class='hs-comment'>-- extractHsTyRdrNames finds the free (kind, type) variables of a HsType</span>
<a name="line-11"></a><span class='hs-comment'>--                        or the free (sort, kind) variables of a HsKind</span>
<a name="line-12"></a><span class='hs-comment'>-- It's used when making the for-alls explicit.</span>
<a name="line-13"></a><span class='hs-comment'>-- See Note [Kind and type-variable binders]</span>
<a name="line-14"></a><span class='hs-definition'>extractHsTyRdrTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-16"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>nub</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="extractHsTysRdrTyVars"></a><span class='hs-definition'>extractHsTysRdrTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-19"></a><span class='hs-comment'>-- See Note [Kind and type-variable binders]</span>
<a name="line-20"></a><span class='hs-definition'>extractHsTysRdrTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-22"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>nub</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="extractRdrKindSigVars"></a><span class='hs-definition'>extractRdrKindSigVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a><span class='hs-definition'>extractRdrKindSigVars</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-26"></a><span class='hs-definition'>extractRdrKindSigVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lkind</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="extractDataDefnKindVars"></a><span class='hs-definition'>extractDataDefnKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDataDefn</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a><span class='hs-comment'>-- Get the scoped kind variables mentioned free in the constructor decls</span>
<a name="line-30"></a><span class='hs-comment'>-- Eg    data T a = T1 (S (a :: k) | forall (b::k). T2 (S b)</span>
<a name="line-31"></a><span class='hs-comment'>-- Here k should scope over the whole definition</span>
<a name="line-32"></a><span class='hs-definition'>extractDataDefnKindVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDataDefn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dd_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>dd_kindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ksig</span>
<a name="line-33"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>dd_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span><span class='hs-layout'>,</span> <span class='hs-varid'>dd_derivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derivs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extract_lctxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>          <span class='hs-varid'>extract_mb</span> <span class='hs-varid'>extract_lkind</span> <span class='hs-varid'>ksig</span> <span class='hs-varop'>$</span>
<a name="line-36"></a>          <span class='hs-varid'>extract_mb</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>derivs</span> <span class='hs-varop'>$</span>
<a name="line-37"></a>          <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_con</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons</span>
<a name="line-38"></a>  <span class='hs-keyword'>where</span>
<a name="line-39"></a>    <span class='hs-varid'>extract_con</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyGADT</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-40"></a>    <span class='hs-varid'>extract_con</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyH98</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qvs</span>
<a name="line-41"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-42"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extract_hs_tv_bndrs</span> <span class='hs-varid'>qvs</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>$</span>
<a name="line-43"></a>        <span class='hs-varid'>extract_lctxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span>
<a name="line-44"></a>        <span class='hs-varid'>extract_ltys</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsConDeclArgTys</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a>
<a name="line-47"></a><a name="extract_lctxt"></a><span class='hs-definition'>extract_lctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-48"></a><span class='hs-definition'>extract_lctxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="extract_ltys"></a><span class='hs-definition'>extract_ltys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-51"></a><span class='hs-definition'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>tys</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="extract_mb"></a><span class='hs-definition'>extract_mb</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-54"></a><span class='hs-definition'>extract_mb</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-55"></a><span class='hs-definition'>extract_mb</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-varid'>acc</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="extract_lkind"></a><span class='hs-definition'>extract_lkind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-58"></a><span class='hs-definition'>extract_lkind</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-59"></a>                                          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span>
<a name="line-60"></a>                                        <span class='hs-comment'>-- Kinds shouldn't have sort signatures!</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="extract_lty"></a><span class='hs-definition'>extract_lty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-63"></a><span class='hs-definition'>extract_lty</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-65"></a>      <span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tv</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_tv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>acc</span>
<a name="line-66"></a>      <span class='hs-conid'>HsBangTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-67"></a>      <span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cd_fld_type</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>flds</span>
<a name="line-68"></a>      <span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-69"></a>      <span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-70"></a>      <span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-71"></a>      <span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span>
<a name="line-72"></a>      <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-73"></a>      <span class='hs-conid'>HsIParamTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-74"></a>      <span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-75"></a>      <span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_tv</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-76"></a>      <span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-77"></a>      <span class='hs-conid'>HsCoreTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>  <span class='hs-comment'>-- The type is closed</span>
<a name="line-78"></a>      <span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>  <span class='hs-comment'>-- Quasi quotes mention no type variables</span>
<a name="line-79"></a>      <span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>  <span class='hs-comment'>-- Type splices mention no type variables</span>
<a name="line-80"></a>      <span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-81"></a>      <span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span>
<a name="line-82"></a>      <span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span>
<a name="line-83"></a>      <span class='hs-conid'>HsTyLit</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>
<a name="line-84"></a>      <span class='hs-conid'>HsWrapTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"extract_lty"</span>
<a name="line-85"></a>      <span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lkind</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-86"></a>      <span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_hs_tv_bndrs</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>$</span>
<a name="line-87"></a>                                   <span class='hs-varid'>extract_lctxt</span> <span class='hs-varid'>cx</span>   <span class='hs-varop'>$</span>
<a name="line-88"></a>                                   <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="extract_hs_tv_bndrs"></a><span class='hs-definition'>extract_hs_tv_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-91"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-92"></a><span class='hs-definition'>extract_hs_tv_bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-93"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>acc_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Note accumulator comes first</span>
<a name="line-94"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>body_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_tvs</span><span class='hs-layout'>)</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>body_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>acc_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>local_kvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_kvs</span><span class='hs-layout'>,</span>
<a name="line-99"></a>     <span class='hs-varid'>acc_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>local_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_tvs</span><span class='hs-layout'>)</span>
<a name="line-100"></a>  <span class='hs-keyword'>where</span>
<a name="line-101"></a>    <span class='hs-varid'>local_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>hsLTyVarName</span> <span class='hs-varid'>tvs</span>
<a name="line-102"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extract_lty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span><span class='hs-keyglyph'>]</span>
<a name="line-103"></a>       <span class='hs-comment'>-- These kind variables are bound here if not bound further out</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="extract_tv"></a><span class='hs-definition'>extract_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-106"></a><span class='hs-definition'>extract_tv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>acc</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>acc</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
</pre>\end{code}
</body>
</html>
