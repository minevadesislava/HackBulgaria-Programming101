<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>main/InteractiveEval.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><span class='hs-comment'>-- (c) The University of Glasgow, 2005-2007</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- Running statements interactively</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>InteractiveEval</span> <span class='hs-layout'>(</span>
<a name="line-10"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-11"></a>        <span class='hs-conid'>RunResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Status</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Resume</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>History</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>runStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>runStmtWithLocation</span><span class='hs-layout'>,</span> <span class='hs-varid'>runDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>runDeclsWithLocation</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>parseImportDecl</span><span class='hs-layout'>,</span> <span class='hs-conid'>SingleStep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>resume</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>abandon</span><span class='hs-layout'>,</span> <span class='hs-varid'>abandonAll</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>getResumeContext</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>getHistorySpan</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>getModBreaks</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>getHistoryModule</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>back</span><span class='hs-layout'>,</span> <span class='hs-varid'>forward</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>setContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>getContext</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>availsToGlobalRdrEnv</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>getNamesInScope</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>getRdrNamesInScope</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>moduleIsInterpreted</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>getInfo</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>exprType</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>typeKind</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>parseName</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>showModule</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>isModuleInterpreted</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>compileExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>dynCompileExpr</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-conid'>Term</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>obtainTermFromId</span><span class='hs-layout'>,</span> <span class='hs-varid'>obtainTermFromVal</span><span class='hs-layout'>,</span> <span class='hs-varid'>reconstructType</span>
<a name="line-34"></a><span class='hs-cpp'>#endif</span>
<a name="line-35"></a>        <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InteractiveEvalTypes</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcMonad</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscMain</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HValue</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-layout'>(</span> <span class='hs-conid'>FamInst</span><span class='hs-layout'>,</span> <span class='hs-varid'>orphNamesOfFamInst</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>     <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>           <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>             <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ByteCodeInstr</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Linker</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BreakArray</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RtClosureInspect</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Mem</span><span class='hs-varop'>.</span><span class='hs-conid'>Weak</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dynamic</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Either</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>find</span><span class='hs-layout'>)</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Safe</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Exts</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Array</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Exception</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-93"></a><span class='hs-comment'>-- running a statement interactively</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="getResumeContext"></a><span class='hs-definition'>getResumeContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Resume</span><span class='hs-keyglyph'>]</span>
<a name="line-96"></a><span class='hs-definition'>getResumeContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ic_resume</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsc_IC</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="SingleStep"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SingleStep</span>
<a name="line-99"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RunToCompletion</span>
<a name="line-100"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SingleStep</span>
<a name="line-101"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RunAndLogSteps</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="isStep"></a><span class='hs-definition'>isStep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SingleStep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-104"></a><span class='hs-definition'>isStep</span> <span class='hs-conid'>RunToCompletion</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-105"></a><span class='hs-definition'>isStep</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="mkHistory"></a><span class='hs-definition'>mkHistory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BreakInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>History</span>
<a name="line-108"></a><span class='hs-definition'>mkHistory</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hval</span> <span class='hs-varid'>bi</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-109"></a>    <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findEnclosingDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bi</span>
<a name="line-110"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>History</span> <span class='hs-varid'>hval</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>decls</span>
<a name="line-111"></a>
<a name="line-112"></a>
<a name="line-113"></a><a name="getHistoryModule"></a><span class='hs-definition'>getHistoryModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>History</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-114"></a><span class='hs-definition'>getHistoryModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakInfo_module</span> <span class='hs-varop'>.</span> <span class='hs-varid'>historyBreakInfo</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="getHistorySpan"></a><span class='hs-definition'>getHistorySpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>History</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-117"></a><span class='hs-definition'>getHistorySpan</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hist</span> <span class='hs-keyglyph'>=</span>
<a name="line-118"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>inf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>historyBreakInfo</span> <span class='hs-varid'>hist</span>
<a name="line-119"></a>       <span class='hs-varid'>num</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakInfo_number</span> <span class='hs-varid'>inf</span>
<a name="line-120"></a>   <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>breakInfo_module</span> <span class='hs-varid'>inf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-121"></a>       <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>modBreaks_locs</span> <span class='hs-layout'>(</span><span class='hs-varid'>getModBreaks</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>)</span> <span class='hs-varop'>!</span> <span class='hs-varid'>num</span>
<a name="line-122"></a>       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"getHistorySpan"</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="getModBreaks"></a><span class='hs-definition'>getModBreaks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HomeModInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModBreaks</span>
<a name="line-125"></a><span class='hs-definition'>getModBreaks</span> <span class='hs-varid'>hmi</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>linkable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>,</span>
<a name="line-127"></a>    <span class='hs-keyglyph'>[</span><span class='hs-conid'>BCOs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>modBreaks</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>linkableUnlinked</span> <span class='hs-varid'>linkable</span>
<a name="line-128"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modBreaks</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModBreaks</span> <span class='hs-comment'>-- probably object code</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="findEnclosingDecls"></a><span class='hs-comment'>{- | Finds the enclosing top level function name -}</span>
<a name="line-133"></a><span class='hs-comment'>-- ToDo: a better way to do this would be to keep hold of the decl_path computed</span>
<a name="line-134"></a><span class='hs-comment'>-- by the coverage pass, which gives the list of lexically-enclosing bindings</span>
<a name="line-135"></a><span class='hs-comment'>-- for each tick.</span>
<a name="line-136"></a><span class='hs-definition'>findEnclosingDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BreakInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-137"></a><span class='hs-definition'>findEnclosingDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>inf</span> <span class='hs-keyglyph'>=</span>
<a name="line-138"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"findEnclosingDecls"</span> <span class='hs-varop'>$</span>
<a name="line-139"></a>             <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>breakInfo_module</span> <span class='hs-varid'>inf</span><span class='hs-layout'>)</span>
<a name="line-140"></a>       <span class='hs-varid'>mb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getModBreaks</span> <span class='hs-varid'>hmi</span>
<a name="line-141"></a>   <span class='hs-keyword'>in</span> <span class='hs-varid'>modBreaks_decls</span> <span class='hs-varid'>mb</span> <span class='hs-varop'>!</span> <span class='hs-varid'>breakInfo_number</span> <span class='hs-varid'>inf</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="updateFixityEnv"></a><span class='hs-comment'>-- | Update fixity environment in the current interactive context.</span>
<a name="line-144"></a><span class='hs-definition'>updateFixityEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FixityEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-145"></a><span class='hs-definition'>updateFixityEnv</span> <span class='hs-varid'>fix_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-146"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-147"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-148"></a>  <span class='hs-varid'>setSession</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_fix_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix_env</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="runStmt"></a><span class='hs-comment'>-- | Run a statement in the current interactive context.  Statement</span>
<a name="line-151"></a><span class='hs-comment'>-- may bind multple values.</span>
<a name="line-152"></a><span class='hs-definition'>runStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SingleStep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>RunResult</span>
<a name="line-153"></a><span class='hs-definition'>runStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runStmtWithLocation</span> <span class='hs-str'>"&lt;interactive&gt;"</span> <span class='hs-num'>1</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="runStmtWithLocation"></a><span class='hs-comment'>-- | Run a statement in the current interactive context.  Passing debug information</span>
<a name="line-156"></a><span class='hs-comment'>--   Statement may bind multple values.</span>
<a name="line-157"></a><span class='hs-definition'>runStmtWithLocation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-158"></a>                       <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SingleStep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>RunResult</span>
<a name="line-159"></a><span class='hs-definition'>runStmtWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>step</span> <span class='hs-keyglyph'>=</span>
<a name="line-160"></a>  <span class='hs-keyword'>do</span>
<a name="line-161"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-162"></a>
<a name="line-163"></a>    <span class='hs-varid'>breakMVar</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newEmptyMVar</span>  <span class='hs-comment'>-- wait on this when we hit a breakpoint</span>
<a name="line-164"></a>    <span class='hs-varid'>statusMVar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newEmptyMVar</span>  <span class='hs-comment'>-- wait on this when a computation is running</span>
<a name="line-165"></a>
<a name="line-166"></a>    <span class='hs-comment'>-- Turn off -fwarn-unused-bindings when running a statement, to hide</span>
<a name="line-167"></a>    <span class='hs-comment'>-- warnings about the implicit bindings we introduce.</span>
<a name="line-168"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span> <span class='hs-comment'>-- use the interactive dflags</span>
<a name="line-169"></a>        <span class='hs-varid'>idflags'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_dflags</span> <span class='hs-varid'>ic</span> <span class='hs-varop'>`wopt_unset`</span> <span class='hs-conid'>Opt_WarnUnusedBinds</span>
<a name="line-170"></a>        <span class='hs-varid'>hsc_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span><span class='hs-layout'>{</span> <span class='hs-varid'>ic_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idflags'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-171"></a>
<a name="line-172"></a>    <span class='hs-comment'>-- compile to value (IO [HValue]), don't run</span>
<a name="line-173"></a>    <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscStmtWithLocation</span> <span class='hs-varid'>hsc_env'</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span>
<a name="line-174"></a>
<a name="line-175"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-176"></a>      <span class='hs-comment'>-- empty statement / comment</span>
<a name="line-177"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunOk</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyThings</span><span class='hs-layout'>,</span> <span class='hs-varid'>hval</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-180"></a>        <span class='hs-varid'>updateFixityEnv</span> <span class='hs-varid'>fix_env</span>
<a name="line-181"></a>
<a name="line-182"></a>        <span class='hs-varid'>status</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-183"></a>          <span class='hs-varid'>withVirtualCWD</span> <span class='hs-varop'>$</span>
<a name="line-184"></a>            <span class='hs-varid'>withBreakAction</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStep</span> <span class='hs-varid'>step</span><span class='hs-layout'>)</span> <span class='hs-varid'>idflags'</span> <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-185"></a>                <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sandboxIO</span> <span class='hs-varid'>idflags'</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>hval</span>
<a name="line-186"></a>
<a name="line-187"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-188"></a>            <span class='hs-varid'>bindings</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>ic</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a>            <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ghciHistSize</span> <span class='hs-varid'>idflags'</span>
<a name="line-191"></a>
<a name="line-192"></a>        <span class='hs-varid'>handleRunStatus</span> <span class='hs-varid'>step</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>bindings</span> <span class='hs-varid'>tyThings</span>
<a name="line-193"></a>                        <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>status</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyHistory</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="runDecls"></a><span class='hs-definition'>runDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-196"></a><span class='hs-definition'>runDecls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runDeclsWithLocation</span> <span class='hs-str'>"&lt;interactive&gt;"</span> <span class='hs-num'>1</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="runDeclsWithLocation"></a><span class='hs-definition'>runDeclsWithLocation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-199"></a><span class='hs-definition'>runDeclsWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span>
<a name="line-200"></a>  <span class='hs-keyword'>do</span>
<a name="line-201"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-202"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tyThings</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscDeclsWithLocation</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span>
<a name="line-203"></a>
<a name="line-204"></a>    <span class='hs-varid'>setSession</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>}</span>
<a name="line-205"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-206"></a>    <span class='hs-varid'>hsc_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rttiEnvironment</span> <span class='hs-varid'>hsc_env</span>
<a name="line-207"></a>    <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env'</span><span class='hs-layout'>)</span>
<a name="line-208"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tyThings</span><span class='hs-layout'>)</span>
<a name="line-209"></a>
<a name="line-210"></a>
<a name="line-211"></a><a name="withVirtualCWD"></a><span class='hs-definition'>withVirtualCWD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-212"></a><span class='hs-definition'>withVirtualCWD</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-213"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-214"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-215"></a>
<a name="line-216"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>set_cwd</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-217"></a>        <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getCurrentDirectory</span>
<a name="line-218"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>ic_cwd</span> <span class='hs-varid'>ic</span> <span class='hs-keyword'>of</span>
<a name="line-219"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setCurrentDirectory</span> <span class='hs-varid'>dir</span>
<a name="line-220"></a>           <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-221"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>dir</span>
<a name="line-222"></a>
<a name="line-223"></a>      <span class='hs-varid'>reset_cwd</span> <span class='hs-varid'>orig_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-224"></a>        <span class='hs-varid'>virt_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getCurrentDirectory</span>
<a name="line-225"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-226"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>old_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-227"></a>        <span class='hs-varid'>setSession</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span>  <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_IC</span><span class='hs-layout'>{</span> <span class='hs-varid'>ic_cwd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>virt_dir</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-228"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setCurrentDirectory</span> <span class='hs-varid'>orig_dir</span>
<a name="line-229"></a>
<a name="line-230"></a>  <span class='hs-varid'>gbracket</span> <span class='hs-varid'>set_cwd</span> <span class='hs-varid'>reset_cwd</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span>
<a name="line-231"></a>
<a name="line-232"></a><a name="parseImportDecl"></a><span class='hs-definition'>parseImportDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-233"></a><span class='hs-definition'>parseImportDecl</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscImport</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>expr</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="emptyHistory"></a><span class='hs-definition'>emptyHistory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoundedList</span> <span class='hs-conid'>History</span>
<a name="line-236"></a><span class='hs-definition'>emptyHistory</span> <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nilBL</span> <span class='hs-varid'>size</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="handleRunStatus"></a><span class='hs-definition'>handleRunStatus</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span>
<a name="line-239"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SingleStep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-240"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Status</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Status</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoundedList</span> <span class='hs-conid'>History</span>
<a name="line-241"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>RunResult</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-definition'>handleRunStatus</span> <span class='hs-varid'>step</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>bindings</span> <span class='hs-varid'>final_ids</span>
<a name="line-244"></a>               <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>status</span> <span class='hs-varid'>history</span>
<a name="line-245"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RunAndLogSteps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>step</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tracing</span>
<a name="line-246"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not_tracing</span>
<a name="line-247"></a> <span class='hs-keyword'>where</span>
<a name="line-248"></a>  <span class='hs-varid'>tracing</span>
<a name="line-249"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Break</span> <span class='hs-varid'>is_exception</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>info</span> <span class='hs-varid'>tid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>status</span>
<a name="line-250"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_exception</span>
<a name="line-251"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-252"></a>       <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-253"></a>       <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isBreakEnabled</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>info</span>
<a name="line-254"></a>       <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span>
<a name="line-255"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>not_tracing</span>
<a name="line-256"></a>           <span class='hs-comment'>-- This breakpoint is explicitly enabled; we want to stop</span>
<a name="line-257"></a>           <span class='hs-comment'>-- instead of just logging it.</span>
<a name="line-258"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-259"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>history'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHistory</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>info</span> <span class='hs-varop'>`consBL`</span> <span class='hs-varid'>history</span>
<a name="line-260"></a>                 <span class='hs-comment'>-- probably better make history strict here, otherwise</span>
<a name="line-261"></a>                 <span class='hs-comment'>-- our BoundedList will be pointless.</span>
<a name="line-262"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>evaluate</span> <span class='hs-varid'>history'</span>
<a name="line-263"></a>           <span class='hs-varid'>status</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withBreakAction</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-264"></a>                                     <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-265"></a>                     <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-266"></a>                        <span class='hs-varid'>putMVar</span> <span class='hs-varid'>breakMVar</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- awaken the stopped thread</span>
<a name="line-267"></a>                        <span class='hs-varid'>redirectInterrupts</span> <span class='hs-varid'>tid</span> <span class='hs-varop'>$</span>
<a name="line-268"></a>                          <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>statusMVar</span>   <span class='hs-comment'>-- and wait for the result</span>
<a name="line-269"></a>           <span class='hs-varid'>handleRunStatus</span> <span class='hs-conid'>RunAndLogSteps</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>bindings</span> <span class='hs-varid'>final_ids</span>
<a name="line-270"></a>                           <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>status</span> <span class='hs-varid'>history'</span>
<a name="line-271"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-272"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not_tracing</span>
<a name="line-273"></a>
<a name="line-274"></a>  <span class='hs-varid'>not_tracing</span>
<a name="line-275"></a>    <span class='hs-comment'>-- Hit a breakpoint</span>
<a name="line-276"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Break</span> <span class='hs-varid'>is_exception</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>info</span> <span class='hs-varid'>tid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>status</span>
<a name="line-277"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-278"></a>         <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-279"></a>         <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_info</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_exception</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-280"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>info</span>
<a name="line-281"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>hsc_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-282"></a>           <span class='hs-varid'>bindLocalsAtBreakpoint</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>mb_info</span>
<a name="line-283"></a>         <span class='hs-keyword'>let</span>
<a name="line-284"></a>           <span class='hs-varid'>resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Resume</span>
<a name="line-285"></a>             <span class='hs-layout'>{</span> <span class='hs-varid'>resumeStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeThreadId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tid</span>
<a name="line-286"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>resumeBreakMVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeStatMVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>statusMVar</span>
<a name="line-287"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>resumeBindings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeFinalIds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_ids</span>
<a name="line-288"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>resumeApStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>apStack</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeBreakInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_info</span>
<a name="line-289"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>resumeSpan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeHistory</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toListBL</span> <span class='hs-varid'>history</span>
<a name="line-290"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>resumeHistoryIx</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> <span class='hs-layout'>}</span>
<a name="line-291"></a>           <span class='hs-varid'>hsc_env2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pushResume</span> <span class='hs-varid'>hsc_env1</span> <span class='hs-varid'>resume</span>
<a name="line-292"></a>  
<a name="line-293"></a>         <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env2</span><span class='hs-layout'>)</span>
<a name="line-294"></a>         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunBreak</span> <span class='hs-varid'>tid</span> <span class='hs-varid'>names</span> <span class='hs-varid'>mb_info</span><span class='hs-layout'>)</span>
<a name="line-295"></a>  
<a name="line-296"></a>    <span class='hs-comment'>-- Completed with an exception</span>
<a name="line-297"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Complete</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>status</span>
<a name="line-298"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunException</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-299"></a>  
<a name="line-300"></a>    <span class='hs-comment'>-- Completed successfully</span>
<a name="line-301"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Complete</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>hvals</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>status</span>
<a name="line-302"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-303"></a>         <span class='hs-keyword'>let</span> <span class='hs-varid'>final_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInteractiveContext</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-304"></a>                                                 <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>AnId</span> <span class='hs-varid'>final_ids</span><span class='hs-layout'>)</span>
<a name="line-305"></a>             <span class='hs-varid'>final_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>final_ids</span>
<a name="line-306"></a>         <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Linker</span><span class='hs-varop'>.</span><span class='hs-varid'>extendLinkEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>final_names</span> <span class='hs-varid'>hvals</span><span class='hs-layout'>)</span>
<a name="line-307"></a>         <span class='hs-varid'>hsc_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rttiEnvironment</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span><span class='hs-varid'>hsc_IC</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>final_ic</span><span class='hs-layout'>}</span>
<a name="line-308"></a>         <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env'</span><span class='hs-layout'>)</span>
<a name="line-309"></a>         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RunOk</span> <span class='hs-varid'>final_names</span><span class='hs-layout'>)</span>
<a name="line-310"></a>  
<a name="line-311"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-312"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"handleRunStatus"</span>  <span class='hs-comment'>-- The above cases are in fact exhaustive</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="isBreakEnabled"></a><span class='hs-definition'>isBreakEnabled</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BreakInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-315"></a><span class='hs-definition'>isBreakEnabled</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>inf</span> <span class='hs-keyglyph'>=</span>
<a name="line-316"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>breakInfo_module</span> <span class='hs-varid'>inf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-317"></a>       <span class='hs-conid'>Just</span> <span class='hs-varid'>hmi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-318"></a>         <span class='hs-varid'>w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBreak</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-319"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>modBreaks_flags</span> <span class='hs-layout'>(</span><span class='hs-varid'>getModBreaks</span> <span class='hs-varid'>hmi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-320"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>breakInfo_number</span> <span class='hs-varid'>inf</span><span class='hs-layout'>)</span>
<a name="line-321"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>w</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-322"></a>       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-323"></a>         <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-324"></a>
<a name="line-325"></a>
<a name="line-326"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-str'>"&amp;rts_stop_next_breakpoint"</span> <span class='hs-varid'>stepFlag</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>CInt</span>
<a name="line-327"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-str'>"&amp;rts_stop_on_exception"</span>    <span class='hs-varid'>exceptionFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>CInt</span>
<a name="line-328"></a>
<a name="line-329"></a><a name="setStepFlag"></a><span class='hs-definition'>setStepFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-330"></a><span class='hs-definition'>setStepFlag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>stepFlag</span> <span class='hs-num'>1</span>
<a name="line-331"></a><a name="resetStepFlag"></a><span class='hs-definition'>resetStepFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-332"></a><span class='hs-definition'>resetStepFlag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>stepFlag</span> <span class='hs-num'>0</span>
<a name="line-333"></a>
<a name="line-334"></a><span class='hs-comment'>-- this points to the IO action that is executed when a breakpoint is hit</span>
<a name="line-335"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-str'>"&amp;rts_breakpoint_io_action"</span>
<a name="line-336"></a>   <span class='hs-varid'>breakPointIOAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StablePtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BreakInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-337"></a>
<a name="line-338"></a><a name="sandboxIO"></a><span class='hs-comment'>-- When running a computation, we redirect ^C exceptions to the running</span>
<a name="line-339"></a><span class='hs-comment'>-- thread.  ToDo: we might want a way to continue even if the target</span>
<a name="line-340"></a><span class='hs-comment'>-- thread doesn't die when it receives the exception... "this thread</span>
<a name="line-341"></a><span class='hs-comment'>-- is not responding".</span>
<a name="line-342"></a><span class='hs-comment'>--</span>
<a name="line-343"></a><span class='hs-comment'>-- Careful here: there may be ^C exceptions flying around, so we start the new</span>
<a name="line-344"></a><span class='hs-comment'>-- thread blocked (forkIO inherits mask from the parent, #1048), and unblock</span>
<a name="line-345"></a><span class='hs-comment'>-- only while we execute the user's code.  We can't afford to lose the final</span>
<a name="line-346"></a><span class='hs-comment'>-- putMVar, otherwise deadlock ensues. (#1583, #1922, #1946)</span>
<a name="line-347"></a><span class='hs-definition'>sandboxIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Status</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HValue</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Status</span>
<a name="line-348"></a><span class='hs-definition'>sandboxIO</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span>
<a name="line-349"></a>   <span class='hs-varid'>mask</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>restore</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- fork starts blocked</span>
<a name="line-350"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>runIt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-conid'>Complete</span> <span class='hs-varop'>$</span> <span class='hs-varid'>try</span> <span class='hs-layout'>(</span><span class='hs-varid'>restore</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rethrow</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-351"></a>     <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_GhciSandbox</span> <span class='hs-varid'>dflags</span>
<a name="line-352"></a>        <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runIt</span>
<a name="line-353"></a>                                   <span class='hs-varid'>putMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>res</span> <span class='hs-comment'>-- empty: can't block</span>
<a name="line-354"></a>                <span class='hs-varid'>redirectInterrupts</span> <span class='hs-varid'>tid</span> <span class='hs-varop'>$</span>
<a name="line-355"></a>                  <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>statusMVar</span>
<a name="line-356"></a>
<a name="line-357"></a>        <span class='hs-keyword'>else</span> <span class='hs-comment'>-- GLUT on OS X needs to run on the main thread. If you</span>
<a name="line-358"></a>             <span class='hs-comment'>-- try to use it from another thread then you just get a</span>
<a name="line-359"></a>             <span class='hs-comment'>-- white rectangle rendered. For this, or anything else</span>
<a name="line-360"></a>             <span class='hs-comment'>-- with such restrictions, you can turn the GHCi sandbox off</span>
<a name="line-361"></a>             <span class='hs-comment'>-- and things will be run in the main thread.</span>
<a name="line-362"></a>             <span class='hs-comment'>--</span>
<a name="line-363"></a>             <span class='hs-comment'>-- BUT, note that the debugging features (breakpoints,</span>
<a name="line-364"></a>             <span class='hs-comment'>-- tracing, etc.) need the expression to be running in a</span>
<a name="line-365"></a>             <span class='hs-comment'>-- separate thread, so debugging is only enabled when</span>
<a name="line-366"></a>             <span class='hs-comment'>-- using the sandbox.</span>
<a name="line-367"></a>             <span class='hs-varid'>runIt</span>
<a name="line-368"></a>
<a name="line-369"></a><a name="redirectInterrupts"></a><span class='hs-comment'>--</span>
<a name="line-370"></a><span class='hs-comment'>-- While we're waiting for the sandbox thread to return a result, if</span>
<a name="line-371"></a><span class='hs-comment'>-- the current thread receives an asynchronous exception we re-throw</span>
<a name="line-372"></a><span class='hs-comment'>-- it at the sandbox thread and continue to wait.</span>
<a name="line-373"></a><span class='hs-comment'>--</span>
<a name="line-374"></a><span class='hs-comment'>-- This is for two reasons:</span>
<a name="line-375"></a><span class='hs-comment'>--</span>
<a name="line-376"></a><span class='hs-comment'>--  * So that ^C interrupts runStmt (e.g. in GHCi), allowing the</span>
<a name="line-377"></a><span class='hs-comment'>--    computation to run its exception handlers before returning the</span>
<a name="line-378"></a><span class='hs-comment'>--    exception result to the caller of runStmt.</span>
<a name="line-379"></a><span class='hs-comment'>--</span>
<a name="line-380"></a><span class='hs-comment'>--  * clients of the GHC API can terminate a runStmt in progress</span>
<a name="line-381"></a><span class='hs-comment'>--    without knowing the ThreadId of the sandbox thread (#1381)</span>
<a name="line-382"></a><span class='hs-comment'>--</span>
<a name="line-383"></a><span class='hs-comment'>-- NB. use a weak pointer to the thread, so that the thread can still</span>
<a name="line-384"></a><span class='hs-comment'>-- be considered deadlocked by the RTS and sent a BlockedIndefinitely</span>
<a name="line-385"></a><span class='hs-comment'>-- exception.  A symptom of getting this wrong is that conc033(ghci)</span>
<a name="line-386"></a><span class='hs-comment'>-- will hang.</span>
<a name="line-387"></a><span class='hs-comment'>--</span>
<a name="line-388"></a><span class='hs-definition'>redirectInterrupts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThreadId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-389"></a><span class='hs-definition'>redirectInterrupts</span> <span class='hs-varid'>target</span> <span class='hs-varid'>wait</span>
<a name="line-390"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>wtid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkWeakThreadId</span> <span class='hs-varid'>target</span>
<a name="line-391"></a>       <span class='hs-varid'>wait</span> <span class='hs-varop'>`catch`</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-392"></a>          <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deRefWeak</span> <span class='hs-varid'>wtid</span>
<a name="line-393"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-394"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wait</span>
<a name="line-395"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>target</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>throwTo</span> <span class='hs-varid'>target</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>wait</span>
<a name="line-396"></a>
<a name="line-397"></a><a name="rethrow"></a><span class='hs-comment'>-- We want to turn ^C into a break when -fbreak-on-exception is on,</span>
<a name="line-398"></a><span class='hs-comment'>-- but it's an async exception and we only break for sync exceptions.</span>
<a name="line-399"></a><span class='hs-comment'>-- Idea: if we catch and re-throw it, then the re-throw will trigger</span>
<a name="line-400"></a><span class='hs-comment'>-- a break.  Great - but we don't want to re-throw all exceptions, because</span>
<a name="line-401"></a><span class='hs-comment'>-- then we'll get a double break for ordinary sync exceptions (you'd have</span>
<a name="line-402"></a><span class='hs-comment'>-- to :continue twice, which looks strange).  So if the exception is</span>
<a name="line-403"></a><span class='hs-comment'>-- not "Interrupted", we unset the exception flag before throwing.</span>
<a name="line-404"></a><span class='hs-comment'>--</span>
<a name="line-405"></a><span class='hs-definition'>rethrow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-406"></a><span class='hs-definition'>rethrow</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Exception</span><span class='hs-varop'>.</span><span class='hs-varid'>catch</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>se</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-407"></a>                   <span class='hs-comment'>-- If -fbreak-on-error, we break unconditionally,</span>
<a name="line-408"></a>                   <span class='hs-comment'>--  but with care of not breaking twice</span>
<a name="line-409"></a>                <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_BreakOnError</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-410"></a>                   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_BreakOnException</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-411"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>exceptionFlag</span> <span class='hs-num'>1</span>
<a name="line-412"></a>                    <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>se</span> <span class='hs-keyword'>of</span>
<a name="line-413"></a>                         <span class='hs-comment'>-- If it is a "UserInterrupt" exception, we allow</span>
<a name="line-414"></a>                         <span class='hs-comment'>--  a possible break by way of -fbreak-on-exception</span>
<a name="line-415"></a>                         <span class='hs-conid'>Just</span> <span class='hs-conid'>UserInterrupt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-416"></a>                         <span class='hs-comment'>-- In any other case, we don't want to break</span>
<a name="line-417"></a>                         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>exceptionFlag</span> <span class='hs-num'>0</span>
<a name="line-418"></a>
<a name="line-419"></a>                <span class='hs-conid'>Exception</span><span class='hs-varop'>.</span><span class='hs-varid'>throwIO</span> <span class='hs-varid'>se</span>
<a name="line-420"></a>
<a name="line-421"></a><a name="withBreakAction"></a><span class='hs-comment'>-- This function sets up the interpreter for catching breakpoints, and</span>
<a name="line-422"></a><span class='hs-comment'>-- resets everything when the computation has stopped running.  This</span>
<a name="line-423"></a><span class='hs-comment'>-- is a not-very-good way to ensure that only the interactive</span>
<a name="line-424"></a><span class='hs-comment'>-- evaluation should generate breakpoints.</span>
<a name="line-425"></a><span class='hs-definition'>withBreakAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExceptionMonad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-426"></a>                   <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Status</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-427"></a><span class='hs-definition'>withBreakAction</span> <span class='hs-varid'>step</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>act</span>
<a name="line-428"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbracket</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varid'>setBreakAction</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>resetBreakAction</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-429"></a> <span class='hs-keyword'>where</span>
<a name="line-430"></a>   <span class='hs-varid'>setBreakAction</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-431"></a>     <span class='hs-varid'>stablePtr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newStablePtr</span> <span class='hs-varid'>onBreak</span>
<a name="line-432"></a>     <span class='hs-varid'>poke</span> <span class='hs-varid'>breakPointIOAction</span> <span class='hs-varid'>stablePtr</span>
<a name="line-433"></a>     <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_BreakOnException</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>poke</span> <span class='hs-varid'>exceptionFlag</span> <span class='hs-num'>1</span>
<a name="line-434"></a>     <span class='hs-varid'>when</span> <span class='hs-varid'>step</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setStepFlag</span>
<a name="line-435"></a>     <span class='hs-varid'>return</span> <span class='hs-varid'>stablePtr</span>
<a name="line-436"></a>        <span class='hs-comment'>-- Breaking on exceptions is not enabled by default, since it</span>
<a name="line-437"></a>        <span class='hs-comment'>-- might be a bit surprising.  The exception flag is turned off</span>
<a name="line-438"></a>        <span class='hs-comment'>-- as soon as it is hit, or in resetBreakAction below.</span>
<a name="line-439"></a>
<a name="line-440"></a>   <span class='hs-varid'>onBreak</span> <span class='hs-varid'>is_exception</span> <span class='hs-varid'>info</span> <span class='hs-varid'>apStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-441"></a>     <span class='hs-varid'>tid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>myThreadId</span>
<a name="line-442"></a>     <span class='hs-varid'>putMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>Break</span> <span class='hs-varid'>is_exception</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>info</span> <span class='hs-varid'>tid</span><span class='hs-layout'>)</span>
<a name="line-443"></a>     <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>breakMVar</span>
<a name="line-444"></a>
<a name="line-445"></a>   <span class='hs-varid'>resetBreakAction</span> <span class='hs-varid'>stablePtr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-446"></a>     <span class='hs-varid'>poke</span> <span class='hs-varid'>breakPointIOAction</span> <span class='hs-varid'>noBreakStablePtr</span>
<a name="line-447"></a>     <span class='hs-varid'>poke</span> <span class='hs-varid'>exceptionFlag</span> <span class='hs-num'>0</span>
<a name="line-448"></a>     <span class='hs-varid'>resetStepFlag</span>
<a name="line-449"></a>     <span class='hs-varid'>freeStablePtr</span> <span class='hs-varid'>stablePtr</span>
<a name="line-450"></a>
<a name="line-451"></a><a name="noBreakStablePtr"></a><span class='hs-definition'>noBreakStablePtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StablePtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BreakInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-452"></a><span class='hs-definition'>noBreakStablePtr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newStablePtr</span> <span class='hs-varid'>noBreakAction</span>
<a name="line-453"></a>
<a name="line-454"></a><a name="noBreakAction"></a><span class='hs-definition'>noBreakAction</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BreakInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-455"></a><span class='hs-definition'>noBreakAction</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putStrLn</span> <span class='hs-str'>"*** Ignoring breakpoint"</span>
<a name="line-456"></a><span class='hs-definition'>noBreakAction</span> <span class='hs-conid'>True</span>  <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- exception: just continue</span>
<a name="line-457"></a>
<a name="line-458"></a><a name="resume"></a><span class='hs-definition'>resume</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpan</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SingleStep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>RunResult</span>
<a name="line-459"></a><span class='hs-definition'>resume</span> <span class='hs-varid'>canLogSpan</span> <span class='hs-varid'>step</span>
<a name="line-460"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-461"></a>   <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-462"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-463"></a>       <span class='hs-varid'>resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_resume</span> <span class='hs-varid'>ic</span>
<a name="line-464"></a>
<a name="line-465"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>resume</span> <span class='hs-keyword'>of</span>
<a name="line-466"></a>     <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-467"></a>           <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"not stopped at a breakpoint"</span><span class='hs-layout'>)</span>
<a name="line-468"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-469"></a>        <span class='hs-comment'>-- unbind the temporary locals by restoring the TypeEnv from</span>
<a name="line-470"></a>        <span class='hs-comment'>-- before the breakpoint, and drop this Resume from the</span>
<a name="line-471"></a>        <span class='hs-comment'>-- InteractiveContext.</span>
<a name="line-472"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>resume_tmp_te</span><span class='hs-layout'>,</span><span class='hs-varid'>resume_rdr_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resumeBindings</span> <span class='hs-varid'>r</span>
<a name="line-473"></a>            <span class='hs-varid'>ic'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tythings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resume_tmp_te</span><span class='hs-layout'>,</span>
<a name="line-474"></a>                       <span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resume_rdr_env</span><span class='hs-layout'>,</span>
<a name="line-475"></a>                       <span class='hs-varid'>ic_resume</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rs</span> <span class='hs-layout'>}</span>
<a name="line-476"></a>        <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-477"></a>
<a name="line-478"></a>        <span class='hs-comment'>-- remove any bindings created since the breakpoint from the</span>
<a name="line-479"></a>        <span class='hs-comment'>-- linker's environment</span>
<a name="line-480"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>new_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`notElem`</span> <span class='hs-varid'>resume_tmp_te</span><span class='hs-layout'>)</span>
<a name="line-481"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-482"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Linker</span><span class='hs-varop'>.</span><span class='hs-varid'>deleteFromLinkEnv</span> <span class='hs-varid'>new_names</span>
<a name="line-483"></a>
<a name="line-484"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStep</span> <span class='hs-varid'>step</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>setStepFlag</span>
<a name="line-485"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-486"></a>          <span class='hs-conid'>Resume</span> <span class='hs-layout'>{</span> <span class='hs-varid'>resumeStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeThreadId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tid</span>
<a name="line-487"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>resumeBreakMVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeStatMVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>statusMVar</span>
<a name="line-488"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>resumeBindings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeFinalIds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_ids</span>
<a name="line-489"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>resumeApStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>apStack</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeBreakInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>resumeSpan</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span>
<a name="line-490"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>resumeHistory</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hist</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-491"></a>               <span class='hs-varid'>withVirtualCWD</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-492"></a>                <span class='hs-varid'>withBreakAction</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStep</span> <span class='hs-varid'>step</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-493"></a>                                        <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-494"></a>                <span class='hs-varid'>status</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-495"></a>                             <span class='hs-varid'>putMVar</span> <span class='hs-varid'>breakMVar</span> <span class='hs-conid'>()</span>
<a name="line-496"></a>                                      <span class='hs-comment'>-- this awakens the stopped thread...</span>
<a name="line-497"></a>                             <span class='hs-varid'>redirectInterrupts</span> <span class='hs-varid'>tid</span> <span class='hs-varop'>$</span>
<a name="line-498"></a>                               <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>statusMVar</span>
<a name="line-499"></a>                                      <span class='hs-comment'>-- and wait for the result</span>
<a name="line-500"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>prevHistoryLst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromListBL</span> <span class='hs-num'>50</span> <span class='hs-varid'>hist</span>
<a name="line-501"></a>                    <span class='hs-varid'>hist'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-502"></a>                       <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>prevHistoryLst</span>
<a name="line-503"></a>                       <span class='hs-conid'>Just</span> <span class='hs-varid'>i</span>
<a name="line-504"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span><span class='hs-varid'>canLogSpan</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>prevHistoryLst</span>
<a name="line-505"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkHistory</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>i</span> <span class='hs-varop'>`consBL`</span>
<a name="line-506"></a>                                                        <span class='hs-varid'>fromListBL</span> <span class='hs-num'>50</span> <span class='hs-varid'>hist</span>
<a name="line-507"></a>                <span class='hs-varid'>handleRunStatus</span> <span class='hs-varid'>step</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>bindings</span> <span class='hs-varid'>final_ids</span>
<a name="line-508"></a>                                <span class='hs-varid'>breakMVar</span> <span class='hs-varid'>statusMVar</span> <span class='hs-varid'>status</span> <span class='hs-varid'>hist'</span>
<a name="line-509"></a>
<a name="line-510"></a><a name="back"></a><span class='hs-definition'>back</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>)</span>
<a name="line-511"></a><span class='hs-definition'>back</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moveHist</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-512"></a>
<a name="line-513"></a><a name="forward"></a><span class='hs-definition'>forward</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>)</span>
<a name="line-514"></a><span class='hs-definition'>forward</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moveHist</span> <span class='hs-layout'>(</span><span class='hs-varid'>subtract</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-515"></a>
<a name="line-516"></a><a name="moveHist"></a><span class='hs-definition'>moveHist</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>)</span>
<a name="line-517"></a><span class='hs-definition'>moveHist</span> <span class='hs-varid'>fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-518"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-519"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ic_resume</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-520"></a>     <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-521"></a>           <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"not stopped at a breakpoint"</span><span class='hs-layout'>)</span>
<a name="line-522"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-523"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>ix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resumeHistoryIx</span> <span class='hs-varid'>r</span>
<a name="line-524"></a>            <span class='hs-varid'>history</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resumeHistory</span> <span class='hs-varid'>r</span>
<a name="line-525"></a>            <span class='hs-varid'>new_ix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>ix</span>
<a name="line-526"></a>        <span class='hs-comment'>--</span>
<a name="line-527"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ix</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>history</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-528"></a>           <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"no more logged breakpoints"</span><span class='hs-layout'>)</span>
<a name="line-529"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ix</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-530"></a>           <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"already at the beginning of the history"</span><span class='hs-layout'>)</span>
<a name="line-531"></a>
<a name="line-532"></a>        <span class='hs-keyword'>let</span>
<a name="line-533"></a>          <span class='hs-varid'>update_ic</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>mb_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-534"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>hsc_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>bindLocalsAtBreakpoint</span> <span class='hs-varid'>hsc_env</span>
<a name="line-535"></a>                                                <span class='hs-varid'>apStack</span> <span class='hs-varid'>mb_info</span>
<a name="line-536"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env1</span>
<a name="line-537"></a>                <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-layout'>{</span> <span class='hs-varid'>resumeHistoryIx</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ix</span> <span class='hs-layout'>}</span>
<a name="line-538"></a>                <span class='hs-varid'>ic'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r'</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span> <span class='hs-layout'>}</span>
<a name="line-539"></a>
<a name="line-540"></a>            <span class='hs-varid'>modifySession</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env1</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-541"></a>
<a name="line-542"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_ix</span><span class='hs-layout'>,</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span>
<a name="line-543"></a>
<a name="line-544"></a>        <span class='hs-comment'>-- careful: we want apStack to be the AP_STACK itself, not a thunk</span>
<a name="line-545"></a>        <span class='hs-comment'>-- around it, hence the cases are carefully constructed below to</span>
<a name="line-546"></a>        <span class='hs-comment'>-- make this the case.  ToDo: this is v. fragile, do something better.</span>
<a name="line-547"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>new_ix</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-548"></a>           <span class='hs-keyword'>then</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-549"></a>                   <span class='hs-conid'>Resume</span> <span class='hs-layout'>{</span> <span class='hs-varid'>resumeApStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>apStack</span><span class='hs-layout'>,</span>
<a name="line-550"></a>                            <span class='hs-varid'>resumeBreakInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-551"></a>                          <span class='hs-varid'>update_ic</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>mb_info</span>
<a name="line-552"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>history</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ix</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-553"></a>                   <span class='hs-conid'>History</span> <span class='hs-varid'>apStack</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-554"></a>                          <span class='hs-varid'>update_ic</span> <span class='hs-varid'>apStack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-555"></a>
<a name="line-556"></a><a name="result_fs"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-557"></a><span class='hs-comment'>-- After stopping at a breakpoint, add free variables to the environment</span>
<a name="line-558"></a><span class='hs-definition'>result_fs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span>
<a name="line-559"></a><span class='hs-definition'>result_fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"_result"</span>
<a name="line-560"></a>
<a name="line-561"></a><a name="bindLocalsAtBreakpoint"></a><span class='hs-definition'>bindLocalsAtBreakpoint</span>
<a name="line-562"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-563"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HValue</span>
<a name="line-564"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BreakInfo</span>
<a name="line-565"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>HscEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>)</span>
<a name="line-566"></a>
<a name="line-567"></a><span class='hs-comment'>-- Nothing case: we stopped when an exception was raised, not at a</span>
<a name="line-568"></a><span class='hs-comment'>-- breakpoint.  We have no location information or local variables to</span>
<a name="line-569"></a><span class='hs-comment'>-- bind, all we can do is bind a local variable to the exception</span>
<a name="line-570"></a><span class='hs-comment'>-- value.</span>
<a name="line-571"></a><span class='hs-definition'>bindLocalsAtBreakpoint</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>apStack</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-572"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>exn_fs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"_exception"</span>
<a name="line-573"></a>       <span class='hs-varid'>exn_name</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>exn_fs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>exn_fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>span</span>
<a name="line-574"></a>       <span class='hs-varid'>e_fs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"e"</span>
<a name="line-575"></a>       <span class='hs-varid'>e_name</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>e_fs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarOccFS</span> <span class='hs-varid'>e_fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>span</span>
<a name="line-576"></a>       <span class='hs-varid'>e_tyvar</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRuntimeUnkTyVar</span> <span class='hs-varid'>e_name</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-577"></a>       <span class='hs-varid'>exn_id</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnId</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>mkVanillaGlobal</span> <span class='hs-varid'>exn_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>e_tyvar</span><span class='hs-layout'>)</span>
<a name="line-578"></a>
<a name="line-579"></a>       <span class='hs-varid'>ictxt0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-580"></a>       <span class='hs-varid'>ictxt1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInteractiveContext</span> <span class='hs-varid'>ictxt0</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>exn_id</span><span class='hs-keyglyph'>]</span>
<a name="line-581"></a>
<a name="line-582"></a>       <span class='hs-varid'>span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGeneralSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"&lt;exception thrown&gt;"</span><span class='hs-layout'>)</span>
<a name="line-583"></a>   <span class='hs-comment'>--</span>
<a name="line-584"></a>   <span class='hs-conid'>Linker</span><span class='hs-varop'>.</span><span class='hs-varid'>extendLinkEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>exn_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>apStack</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-585"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ictxt1</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>exn_name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span>
<a name="line-586"></a>
<a name="line-587"></a><span class='hs-comment'>-- Just case: we stopped at a breakpoint, we have information about the location</span>
<a name="line-588"></a><span class='hs-comment'>-- of the breakpoint and the free variables of the expression.</span>
<a name="line-589"></a><span class='hs-definition'>bindLocalsAtBreakpoint</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>apStack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-590"></a>
<a name="line-591"></a>   <span class='hs-keyword'>let</span>
<a name="line-592"></a>       <span class='hs-varid'>mod_name</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>breakInfo_module</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-593"></a>       <span class='hs-varid'>hmi</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"bindLocalsAtBreakpoint"</span> <span class='hs-varop'>$</span>
<a name="line-594"></a>                        <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod_name</span>
<a name="line-595"></a>       <span class='hs-varid'>breaks</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getModBreaks</span> <span class='hs-varid'>hmi</span>
<a name="line-596"></a>       <span class='hs-varid'>index</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakInfo_number</span> <span class='hs-varid'>info</span>
<a name="line-597"></a>       <span class='hs-varid'>vars</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakInfo_vars</span> <span class='hs-varid'>info</span>
<a name="line-598"></a>       <span class='hs-varid'>result_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>breakInfo_resty</span> <span class='hs-varid'>info</span>
<a name="line-599"></a>       <span class='hs-varid'>occs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modBreaks_vars</span> <span class='hs-varid'>breaks</span> <span class='hs-varop'>!</span> <span class='hs-varid'>index</span>
<a name="line-600"></a>       <span class='hs-varid'>span</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modBreaks_locs</span> <span class='hs-varid'>breaks</span> <span class='hs-varop'>!</span> <span class='hs-varid'>index</span>
<a name="line-601"></a>
<a name="line-602"></a>           <span class='hs-comment'>-- Filter out any unboxed ids;</span>
<a name="line-603"></a>           <span class='hs-comment'>-- we can't bind these at the prompt</span>
<a name="line-604"></a>       <span class='hs-varid'>pointers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isPointer</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-605"></a>       <span class='hs-varid'>isPointer</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnaryRep</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-606"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>PtrRep</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>typePrimRep</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-607"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-608"></a>
<a name="line-609"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>offsets</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pointers</span>
<a name="line-610"></a>
<a name="line-611"></a>       <span class='hs-varid'>free_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span><span class='hs-layout'>)</span>
<a name="line-612"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>result_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-613"></a>
<a name="line-614"></a>   <span class='hs-comment'>-- It might be that getIdValFromApStack fails, because the AP_STACK</span>
<a name="line-615"></a>   <span class='hs-comment'>-- has been accidentally evaluated, or something else has gone wrong.</span>
<a name="line-616"></a>   <span class='hs-comment'>-- So that we don't fall over in a heap when this happens, just don't</span>
<a name="line-617"></a>   <span class='hs-comment'>-- bind any free variables instead, and we emit a warning.</span>
<a name="line-618"></a>   <span class='hs-varid'>mb_hValues</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>getIdValFromApStack</span> <span class='hs-varid'>apStack</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>offsets</span><span class='hs-layout'>)</span>
<a name="line-619"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>filtered_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-sel'>_hv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>mb_hValues</span> <span class='hs-keyglyph'>]</span>
<a name="line-620"></a>   <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_hValues</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-621"></a>      <span class='hs-varid'>debugTraceMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-varop'>$</span>
<a name="line-622"></a>          <span class='hs-varid'>text</span> <span class='hs-str'>"Warning: _result has been evaluated, some bindings have been lost"</span>
<a name="line-623"></a>
<a name="line-624"></a>   <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'I'</span>
<a name="line-625"></a>   <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-626"></a>       <span class='hs-varid'>tv_subst</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newTyVars</span> <span class='hs-varid'>us1</span> <span class='hs-varid'>free_tvs</span>
<a name="line-627"></a>       <span class='hs-varid'>new_ids</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith3</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNewId</span> <span class='hs-varid'>tv_subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>filtered_ids</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span>
<a name="line-628"></a>       <span class='hs-varid'>names</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>new_ids</span>
<a name="line-629"></a>
<a name="line-630"></a>   <span class='hs-comment'>-- make an Id for _result.  We use the Unique of the FastString "_result";</span>
<a name="line-631"></a>   <span class='hs-comment'>-- we don't care about uniqueness here, because there will only be one</span>
<a name="line-632"></a>   <span class='hs-comment'>-- _result in scope at any time.</span>
<a name="line-633"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>result_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>result_fs</span><span class='hs-layout'>)</span>
<a name="line-634"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>result_fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>span</span>
<a name="line-635"></a>       <span class='hs-varid'>result_id</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>mkVanillaGlobal</span> <span class='hs-varid'>result_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>tv_subst</span> <span class='hs-varid'>result_ty</span><span class='hs-layout'>)</span>
<a name="line-636"></a>
<a name="line-637"></a>   <span class='hs-comment'>-- for each Id we're about to bind in the local envt:</span>
<a name="line-638"></a>   <span class='hs-comment'>--    - tidy the type variables</span>
<a name="line-639"></a>   <span class='hs-comment'>--    - globalise the Id (Ids are supposed to be Global, apparently).</span>
<a name="line-640"></a>   <span class='hs-comment'>--</span>
<a name="line-641"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>result_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPointer</span> <span class='hs-varid'>result_id</span>
<a name="line-642"></a>
<a name="line-643"></a>       <span class='hs-varid'>all_ids</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>result_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>result_id</span> <span class='hs-conop'>:</span> <span class='hs-varid'>new_ids</span>
<a name="line-644"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ids</span>
<a name="line-645"></a>       <span class='hs-varid'>id_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>all_ids</span>
<a name="line-646"></a>       <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tidy_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTypes</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>id_tys</span>
<a name="line-647"></a>       <span class='hs-varid'>final_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>setIdType</span> <span class='hs-varid'>all_ids</span> <span class='hs-varid'>tidy_tys</span>
<a name="line-648"></a>       <span class='hs-varid'>ictxt0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-649"></a>       <span class='hs-varid'>ictxt1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInteractiveContext</span> <span class='hs-varid'>ictxt0</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>AnId</span> <span class='hs-varid'>final_ids</span><span class='hs-layout'>)</span>
<a name="line-650"></a>
<a name="line-651"></a>   <span class='hs-conid'>Linker</span><span class='hs-varop'>.</span><span class='hs-varid'>extendLinkEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>hval</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>hval</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>names</span> <span class='hs-varid'>mb_hValues</span> <span class='hs-keyglyph'>]</span>
<a name="line-652"></a>   <span class='hs-varid'>when</span> <span class='hs-varid'>result_ok</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Linker</span><span class='hs-varop'>.</span><span class='hs-varid'>extendLinkEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>result_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>apStack</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-653"></a>   <span class='hs-varid'>hsc_env1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rttiEnvironment</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ictxt1</span> <span class='hs-layout'>}</span>
<a name="line-654"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_env1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>result_ok</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>result_name</span><span class='hs-conop'>:</span><span class='hs-varid'>names</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span>
<a name="line-655"></a>  <span class='hs-keyword'>where</span>
<a name="line-656"></a>        <span class='hs-comment'>-- We need a fresh Unique for each Id we bind, because the linker</span>
<a name="line-657"></a>        <span class='hs-comment'>-- state is single-threaded and otherwise we'd spam old bindings</span>
<a name="line-658"></a>        <span class='hs-comment'>-- whenever we stop at a breakpoint.  The InteractveContext is properly</span>
<a name="line-659"></a>        <span class='hs-comment'>-- saved/restored, but not the linker state.  See #1743, test break026.</span>
<a name="line-660"></a>   <span class='hs-varid'>mkNewId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-661"></a>   <span class='hs-varid'>mkNewId</span> <span class='hs-varid'>tv_subst</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>id</span> <span class='hs-varid'>uniq</span>
<a name="line-662"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>mkVanillaGlobalWithInfo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-663"></a>     <span class='hs-keyword'>where</span>
<a name="line-664"></a>         <span class='hs-varid'>loc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-665"></a>         <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-666"></a>         <span class='hs-varid'>ty</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>tv_subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-667"></a>
<a name="line-668"></a>   <span class='hs-varid'>newTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-669"></a>     <span class='hs-comment'>-- Similarly, clone the type variables mentioned in the types</span>
<a name="line-670"></a>     <span class='hs-comment'>-- we have here, *and* make them all RuntimeUnk tyars</span>
<a name="line-671"></a>   <span class='hs-varid'>newTyVars</span> <span class='hs-varid'>us</span> <span class='hs-varid'>tvs</span>
<a name="line-672"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopTvSubst</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRuntimeUnkTyVar</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-673"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span>
<a name="line-674"></a>                    <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>]</span>
<a name="line-675"></a>
<a name="line-676"></a><a name="rttiEnvironment"></a><span class='hs-definition'>rttiEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HscEnv</span>
<a name="line-677"></a><span class='hs-definition'>rttiEnvironment</span> <span class='hs-varid'>hsc_env</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>HscEnv</span><span class='hs-layout'>{</span><span class='hs-varid'>hsc_IC</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>ic</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-678"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>tmp_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>ic</span><span class='hs-keyglyph'>]</span>
<a name="line-679"></a>       <span class='hs-varid'>incompletelyTypedIds</span> <span class='hs-keyglyph'>=</span>
<a name="line-680"></a>           <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tmp_ids</span>
<a name="line-681"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>noSkolems</span> <span class='hs-varid'>id</span>
<a name="line-682"></a>               <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameFS</span><span class='hs-varop'>.</span><span class='hs-varid'>nameOccName</span><span class='hs-varop'>.</span><span class='hs-varid'>idName</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>result_fs</span><span class='hs-keyglyph'>]</span>
<a name="line-683"></a>   <span class='hs-varid'>hsc_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>improveTypes</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>incompletelyTypedIds</span><span class='hs-layout'>)</span>
<a name="line-684"></a>   <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env'</span>
<a name="line-685"></a>    <span class='hs-keyword'>where</span>
<a name="line-686"></a>     <span class='hs-varid'>noSkolems</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span>
<a name="line-687"></a>     <span class='hs-varid'>improveTypes</span> <span class='hs-varid'>hsc_env</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>HscEnv</span><span class='hs-layout'>{</span><span class='hs-varid'>hsc_IC</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>ic</span><span class='hs-layout'>}</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-688"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>tmp_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>ic</span><span class='hs-keyglyph'>]</span>
<a name="line-689"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmp_ids</span>
<a name="line-690"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>noSkolems</span> <span class='hs-varid'>id</span>
<a name="line-691"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env</span>
<a name="line-692"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-693"></a>           <span class='hs-varid'>mb_new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reconstructType</span> <span class='hs-varid'>hsc_env</span> <span class='hs-num'>10</span> <span class='hs-varid'>id</span>
<a name="line-694"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>old_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>id</span>
<a name="line-695"></a>           <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_new_ty</span> <span class='hs-keyword'>of</span>
<a name="line-696"></a>             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env</span>
<a name="line-697"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-698"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>improveRTTIType</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_ty</span> <span class='hs-varid'>new_ty</span> <span class='hs-keyword'>of</span>
<a name="line-699"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-700"></a>                        <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>":print failed to calculate the "</span>
<a name="line-701"></a>                                           <span class='hs-varop'>++</span> <span class='hs-str'>"improvement for a type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>hsc_env</span>
<a name="line-702"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-703"></a>                 <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-704"></a>                 <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_rtti</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-705"></a>                      <span class='hs-varid'>printInfoForUser</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>alwaysQualify</span> <span class='hs-varop'>$</span>
<a name="line-706"></a>                      <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"RTTI Improvement for"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>equals</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>]</span>
<a name="line-707"></a>
<a name="line-708"></a>                 <span class='hs-keyword'>let</span> <span class='hs-varid'>ic'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInteractiveContext</span>
<a name="line-709"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>substInteractiveContext</span> <span class='hs-varid'>ic</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-710"></a>                 <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span><span class='hs-varid'>hsc_IC</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>ic'</span><span class='hs-layout'>}</span>
<a name="line-711"></a>
<a name="line-712"></a><a name="getIdValFromApStack"></a><span class='hs-definition'>getIdValFromApStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>HValue</span><span class='hs-layout'>)</span>
<a name="line-713"></a><span class='hs-definition'>getIdValFromApStack</span> <span class='hs-varid'>apStack</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>stackDepth</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-714"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>getApStackVal</span><span class='hs-cpp'>#</span> <span class='hs-varid'>apStack</span> <span class='hs-layout'>(</span><span class='hs-varid'>stackDepth</span> <span class='hs-varop'>+#</span> <span class='hs-num'>1</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-715"></a>                                <span class='hs-comment'>-- The +1 is magic!  I don't know where it comes</span>
<a name="line-716"></a>                                <span class='hs-comment'>-- from, but this makes things line up.  --SDM</span>
<a name="line-717"></a>        <span class='hs-layout'>(</span><span class='hs-cpp'>#</span> <span class='hs-varid'>ok</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span> <span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-718"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>ok</span> <span class='hs-keyword'>of</span>
<a name="line-719"></a>              <span class='hs-num'>0</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-comment'>-- AP_STACK not found</span>
<a name="line-720"></a>              <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-721"></a>
<a name="line-722"></a><a name="pushResume"></a><span class='hs-definition'>pushResume</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Resume</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span>
<a name="line-723"></a><span class='hs-definition'>pushResume</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ictxt1</span> <span class='hs-layout'>}</span>
<a name="line-724"></a>  <span class='hs-keyword'>where</span>
<a name="line-725"></a>        <span class='hs-varid'>ictxt0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-726"></a>        <span class='hs-varid'>ictxt1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ictxt0</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resume</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ic_resume</span> <span class='hs-varid'>ictxt0</span> <span class='hs-layout'>}</span>
<a name="line-727"></a>
<a name="line-728"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-729"></a><span class='hs-comment'>-- Abandoning a resume context</span>
<a name="line-730"></a>
<a name="line-731"></a><a name="abandon"></a><span class='hs-definition'>abandon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-732"></a><span class='hs-definition'>abandon</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-733"></a>   <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-734"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-735"></a>       <span class='hs-varid'>resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_resume</span> <span class='hs-varid'>ic</span>
<a name="line-736"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>resume</span> <span class='hs-keyword'>of</span>
<a name="line-737"></a>      <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-738"></a>      <span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-739"></a>         <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-740"></a>         <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>abandon_</span> <span class='hs-varid'>r</span>
<a name="line-741"></a>         <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="abandonAll"></a><span class='hs-definition'>abandonAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-744"></a><span class='hs-definition'>abandonAll</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-745"></a>   <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-746"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-747"></a>       <span class='hs-varid'>resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_resume</span> <span class='hs-varid'>ic</span>
<a name="line-748"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>resume</span> <span class='hs-keyword'>of</span>
<a name="line-749"></a>      <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-750"></a>      <span class='hs-varid'>rs</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-751"></a>         <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_resume</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-752"></a>         <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>abandon_</span> <span class='hs-varid'>rs</span>
<a name="line-753"></a>         <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-754"></a>
<a name="line-755"></a><a name="abandon_"></a><span class='hs-comment'>-- when abandoning a computation we have to</span>
<a name="line-756"></a><span class='hs-comment'>--      (a) kill the thread with an async exception, so that the</span>
<a name="line-757"></a><span class='hs-comment'>--          computation itself is stopped, and</span>
<a name="line-758"></a><span class='hs-comment'>--      (b) fill in the MVar.  This step is necessary because any</span>
<a name="line-759"></a><span class='hs-comment'>--          thunks that were under evaluation will now be updated</span>
<a name="line-760"></a><span class='hs-comment'>--          with the partial computation, which still ends in takeMVar,</span>
<a name="line-761"></a><span class='hs-comment'>--          so any attempt to evaluate one of these thunks will block</span>
<a name="line-762"></a><span class='hs-comment'>--          unless we fill in the MVar.</span>
<a name="line-763"></a><span class='hs-comment'>--      (c) wait for the thread to terminate by taking its status MVar.  This</span>
<a name="line-764"></a><span class='hs-comment'>--          step is necessary to prevent race conditions with</span>
<a name="line-765"></a><span class='hs-comment'>--          -fbreak-on-exception (see #5975).</span>
<a name="line-766"></a><span class='hs-comment'>--  See test break010.</span>
<a name="line-767"></a><span class='hs-definition'>abandon_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Resume</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-768"></a><span class='hs-definition'>abandon_</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-769"></a>  <span class='hs-varid'>killThread</span> <span class='hs-layout'>(</span><span class='hs-varid'>resumeThreadId</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-770"></a>  <span class='hs-varid'>putMVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>resumeBreakMVar</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-conid'>()</span>
<a name="line-771"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>takeMVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>resumeStatMVar</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-772"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-773"></a>
<a name="line-774"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-775"></a><span class='hs-comment'>-- Bounded list, optimised for repeated cons</span>
<a name="line-776"></a>
<a name="line-777"></a><a name="BoundedList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BoundedList</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BL</span>
<a name="line-778"></a>                        <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>  <span class='hs-comment'>-- length</span>
<a name="line-779"></a>                        <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>  <span class='hs-comment'>-- bound</span>
<a name="line-780"></a>                        <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- left</span>
<a name="line-781"></a>                        <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- right,  list is (left ++ reverse right)</span>
<a name="line-782"></a>
<a name="line-783"></a><a name="nilBL"></a><span class='hs-definition'>nilBL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoundedList</span> <span class='hs-varid'>a</span>
<a name="line-784"></a><span class='hs-definition'>nilBL</span> <span class='hs-varid'>bound</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BL</span> <span class='hs-num'>0</span> <span class='hs-varid'>bound</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-785"></a>
<a name="line-786"></a><a name="consBL"></a><span class='hs-definition'>consBL</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoundedList</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoundedList</span> <span class='hs-varid'>a</span>
<a name="line-787"></a><span class='hs-definition'>consBL</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>BL</span> <span class='hs-varid'>len</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>left</span> <span class='hs-varid'>right</span><span class='hs-layout'>)</span>
<a name="line-788"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>bound</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BL</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>bound</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>left</span><span class='hs-layout'>)</span> <span class='hs-varid'>right</span>
<a name="line-789"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>right</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BL</span> <span class='hs-varid'>len</span>     <span class='hs-varid'>bound</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>      <span class='hs-varop'>$!</span> <span class='hs-varid'>tail</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>left</span><span class='hs-layout'>)</span>
<a name="line-790"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BL</span> <span class='hs-varid'>len</span>     <span class='hs-varid'>bound</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-varid'>left</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>right</span>
<a name="line-791"></a>
<a name="line-792"></a><a name="toListBL"></a><span class='hs-definition'>toListBL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BoundedList</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-793"></a><span class='hs-definition'>toListBL</span> <span class='hs-layout'>(</span><span class='hs-conid'>BL</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>left</span> <span class='hs-varid'>right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>left</span> <span class='hs-varop'>++</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>right</span>
<a name="line-794"></a>
<a name="line-795"></a><a name="fromListBL"></a><span class='hs-definition'>fromListBL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoundedList</span> <span class='hs-varid'>a</span>
<a name="line-796"></a><span class='hs-definition'>fromListBL</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BL</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>l</span> <span class='hs-conid'>[]</span>
<a name="line-797"></a>
<a name="line-798"></a><span class='hs-comment'>-- lenBL (BL len _ _ _) = len</span>
<a name="line-799"></a>
<a name="line-800"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-801"></a><span class='hs-comment'>-- | Set the interactive evaluation context.</span>
<a name="line-802"></a><span class='hs-comment'>--</span>
<a name="line-803"></a><span class='hs-comment'>-- (setContext imports) sets the ic_imports field (which in turn</span>
<a name="line-804"></a><span class='hs-comment'>-- determines what is in scope at the prompt) to 'imports', and</span>
<a name="line-805"></a><span class='hs-comment'>-- constructs the ic_rn_glb_env environment to reflect it.</span>
<a name="line-806"></a><span class='hs-comment'>--</span>
<a name="line-807"></a><span class='hs-comment'>-- We retain in scope all the things defined at the prompt, and kept</span>
<a name="line-808"></a><span class='hs-comment'>-- in ic_tythings.  (Indeed, they shadow stuff from ic_imports.)</span>
<a name="line-809"></a>
<a name="line-810"></a><a name="setContext"></a><span class='hs-definition'>setContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InteractiveImport</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-811"></a><span class='hs-definition'>setContext</span> <span class='hs-varid'>imports</span>
<a name="line-812"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSession</span>
<a name="line-813"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-814"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>all_env_err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findGlobalRdrEnv</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>imports</span>
<a name="line-815"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>all_env_err</span> <span class='hs-keyword'>of</span>
<a name="line-816"></a>           <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-817"></a>               <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>formatError</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-818"></a>           <span class='hs-conid'>Right</span> <span class='hs-varid'>all_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-819"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>old_ic</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-820"></a>             <span class='hs-varid'>final_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all_env</span> <span class='hs-varop'>`icExtendGblRdrEnv`</span> <span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>old_ic</span>
<a name="line-821"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>modifySession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-822"></a>         <span class='hs-varid'>hsc_env</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_imports</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imports</span>
<a name="line-823"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_rdr_env</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-824"></a>  <span class='hs-keyword'>where</span>
<a name="line-825"></a>    <span class='hs-varid'>formatError</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProgramError</span> <span class='hs-varop'>.</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-826"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"Cannot add module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-827"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"to context:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>err</span>
<a name="line-828"></a>
<a name="line-829"></a><a name="findGlobalRdrEnv"></a><span class='hs-definition'>findGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InteractiveImport</span><span class='hs-keyglyph'>]</span>
<a name="line-830"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>)</span>
<a name="line-831"></a><span class='hs-comment'>-- Compute the GlobalRdrEnv for the interactive context</span>
<a name="line-832"></a><span class='hs-definition'>findGlobalRdrEnv</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>imports</span>
<a name="line-833"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>idecls_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscRnImportDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>idecls</span>
<a name="line-834"></a>                    <span class='hs-comment'>-- This call also loads any orphan modules</span>
<a name="line-835"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>partitionEithers</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkEnv</span> <span class='hs-varid'>imods</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-836"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>imods_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>plusGlobalRdrEnv</span> <span class='hs-varid'>idecls_env</span> <span class='hs-varid'>imods_env</span><span class='hs-layout'>)</span>
<a name="line-837"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span> <span class='hs-layout'>}</span>
<a name="line-838"></a>  <span class='hs-keyword'>where</span>
<a name="line-839"></a>    <span class='hs-varid'>idecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-840"></a>    <span class='hs-varid'>idecls</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IIDecl</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>imports</span><span class='hs-keyglyph'>]</span>
<a name="line-841"></a>
<a name="line-842"></a>    <span class='hs-varid'>imods</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span>
<a name="line-843"></a>    <span class='hs-varid'>imods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IIModule</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>imports</span><span class='hs-keyglyph'>]</span>
<a name="line-844"></a>
<a name="line-845"></a>    <span class='hs-varid'>mkEnv</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mkTopLevEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-846"></a>      <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-847"></a>      <span class='hs-conid'>Right</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>env</span>
<a name="line-848"></a>
<a name="line-849"></a><a name="availsToGlobalRdrEnv"></a><span class='hs-definition'>availsToGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-850"></a><span class='hs-definition'>availsToGlobalRdrEnv</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>avails</span>
<a name="line-851"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGlobalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>gresFromAvails</span> <span class='hs-varid'>imp_prov</span> <span class='hs-varid'>avails</span><span class='hs-layout'>)</span>
<a name="line-852"></a>  <span class='hs-keyword'>where</span>
<a name="line-853"></a>      <span class='hs-comment'>-- We're building a GlobalRdrEnv as if the user imported</span>
<a name="line-854"></a>      <span class='hs-comment'>-- all the specified modules into the global interactive module</span>
<a name="line-855"></a>    <span class='hs-varid'>imp_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpAll</span><span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-856"></a>    <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_name</span><span class='hs-layout'>,</span>
<a name="line-857"></a>                         <span class='hs-varid'>is_qual</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-858"></a>                         <span class='hs-varid'>is_dloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcLocSpan</span> <span class='hs-varid'>interactiveSrcLoc</span> <span class='hs-layout'>}</span>
<a name="line-859"></a>
<a name="line-860"></a><a name="mkTopLevEnv"></a><span class='hs-definition'>mkTopLevEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HomePackageTable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>String</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-861"></a><span class='hs-definition'>mkTopLevEnv</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>modl</span>
<a name="line-862"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>modl</span> <span class='hs-keyword'>of</span>
<a name="line-863"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-str'>"not a home module"</span>
<a name="line-864"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-865"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>mi_globals</span> <span class='hs-layout'>(</span><span class='hs-varid'>hm_iface</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-866"></a>                <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-str'>"not interpreted"</span>
<a name="line-867"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>env</span>
<a name="line-868"></a>
<a name="line-869"></a><a name="getContext"></a><span class='hs-comment'>-- | Get the interactive evaluation context, consisting of a pair of the</span>
<a name="line-870"></a><span class='hs-comment'>-- set of modules from which we take the full top-level scope, and the set</span>
<a name="line-871"></a><span class='hs-comment'>-- of modules from which we take just the exports respectively.</span>
<a name="line-872"></a><span class='hs-definition'>getContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InteractiveImport</span><span class='hs-keyglyph'>]</span>
<a name="line-873"></a><span class='hs-definition'>getContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>HscEnv</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsc_IC</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>ic</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-874"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_imports</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span>
<a name="line-875"></a>
<a name="line-876"></a><a name="moduleIsInterpreted"></a><span class='hs-comment'>-- | Returns @True@ if the specified module is interpreted, and hence has</span>
<a name="line-877"></a><span class='hs-comment'>-- its full top-level scope available.</span>
<a name="line-878"></a><span class='hs-definition'>moduleIsInterpreted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-879"></a><span class='hs-definition'>moduleIsInterpreted</span> <span class='hs-varid'>modl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-880"></a> <span class='hs-keyword'>if</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>modl</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-881"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-882"></a>        <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>modl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-883"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>details</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_globals</span> <span class='hs-layout'>(</span><span class='hs-varid'>hm_iface</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-884"></a>                <span class='hs-sel'>_not_a_home_module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-885"></a>
<a name="line-886"></a><a name="getInfo"></a><span class='hs-comment'>-- | Looks up an identifier in the current interactive context (for :info)</span>
<a name="line-887"></a><span class='hs-comment'>-- Filter the instances by the ones whose tycons (or clases resp)</span>
<a name="line-888"></a><span class='hs-comment'>-- are in scope (qualified or otherwise).  Otherwise we list a whole lot too many!</span>
<a name="line-889"></a><span class='hs-comment'>-- The exact choice of which ones to show, and which to hide, is a judgement call.</span>
<a name="line-890"></a><span class='hs-comment'>--      (see Trac #1581)</span>
<a name="line-891"></a><span class='hs-definition'>getInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyThing</span><span class='hs-layout'>,</span><span class='hs-conid'>Fixity</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-892"></a><span class='hs-definition'>getInfo</span> <span class='hs-varid'>allInfo</span> <span class='hs-varid'>name</span>
<a name="line-893"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-894"></a>    <span class='hs-keyword'>do</span> <span class='hs-varid'>mb_stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscTcRnGetInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-895"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_stuff</span> <span class='hs-keyword'>of</span>
<a name="line-896"></a>         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-897"></a>         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-898"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-899"></a>
<a name="line-900"></a>           <span class='hs-comment'>-- Filter the instances based on whether the constituent names of their</span>
<a name="line-901"></a>           <span class='hs-comment'>-- instance heads are all in scope.</span>
<a name="line-902"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>cls_insts'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>plausible</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varop'>.</span> <span class='hs-varid'>orphNamesOfClsInst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls_insts</span>
<a name="line-903"></a>               <span class='hs-varid'>fam_insts'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>plausible</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varop'>.</span> <span class='hs-varid'>orphNamesOfFamInst</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_insts</span>
<a name="line-904"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_insts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_insts'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-905"></a>  <span class='hs-keyword'>where</span>
<a name="line-906"></a>    <span class='hs-varid'>plausible</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>names</span>
<a name="line-907"></a>          <span class='hs-comment'>-- Dfun involving only names that are in ic_rn_glb_env</span>
<a name="line-908"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allInfo</span>
<a name="line-909"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>all</span> <span class='hs-varid'>ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-910"></a>        <span class='hs-keyword'>where</span>   <span class='hs-comment'>-- A name is ok if it's in the rdr_env,</span>
<a name="line-911"></a>                <span class='hs-comment'>-- whether qualified or not</span>
<a name="line-912"></a>          <span class='hs-varid'>ok</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>       <span class='hs-comment'>-- The one we looked for in the first place!</span>
<a name="line-913"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBuiltInSyntax</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-914"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>gre_name</span><span class='hs-layout'>)</span>
<a name="line-915"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>lookupGRE_Name</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-916"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-917"></a>
<a name="line-918"></a><a name="getNamesInScope"></a><span class='hs-comment'>-- | Returns all names in scope in the current interactive context</span>
<a name="line-919"></a><span class='hs-definition'>getNamesInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-920"></a><span class='hs-definition'>getNamesInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-921"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>gre_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-922"></a>
<a name="line-923"></a><a name="getRdrNamesInScope"></a><span class='hs-definition'>getRdrNamesInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-924"></a><span class='hs-definition'>getRdrNamesInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-925"></a>  <span class='hs-keyword'>let</span>
<a name="line-926"></a>      <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-927"></a>      <span class='hs-varid'>gbl_rdrenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_rn_gbl_env</span> <span class='hs-varid'>ic</span>
<a name="line-928"></a>      <span class='hs-varid'>gbl_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>greToRdrNames</span> <span class='hs-varop'>$</span> <span class='hs-varid'>globalRdrEnvElts</span> <span class='hs-varid'>gbl_rdrenv</span>
<a name="line-929"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>gbl_names</span>
<a name="line-930"></a>
<a name="line-931"></a>
<a name="line-932"></a><a name="greToRdrNames"></a><span class='hs-comment'>-- ToDo: move to RdrName</span>
<a name="line-933"></a><span class='hs-definition'>greToRdrNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-934"></a><span class='hs-definition'>greToRdrNames</span> <span class='hs-conid'>GRE</span><span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov</span> <span class='hs-layout'>}</span>
<a name="line-935"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>prov</span> <span class='hs-keyword'>of</span>
<a name="line-936"></a>     <span class='hs-conid'>LocalDef</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>unqual</span><span class='hs-keyglyph'>]</span>
<a name="line-937"></a>     <span class='hs-conid'>Imported</span> <span class='hs-varid'>specs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>do_spec</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>is_decl</span> <span class='hs-varid'>specs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-938"></a>  <span class='hs-keyword'>where</span>
<a name="line-939"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-940"></a>    <span class='hs-varid'>unqual</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span>
<a name="line-941"></a>    <span class='hs-varid'>do_spec</span> <span class='hs-varid'>decl_spec</span>
<a name="line-942"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_qual</span> <span class='hs-varid'>decl_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>qual</span><span class='hs-keyglyph'>]</span>
<a name="line-943"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>unqual</span><span class='hs-layout'>,</span><span class='hs-varid'>qual</span><span class='hs-keyglyph'>]</span>
<a name="line-944"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>qual</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Qual</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_as</span> <span class='hs-varid'>decl_spec</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span>
<a name="line-945"></a>
<a name="line-946"></a><a name="parseName"></a><span class='hs-comment'>-- | Parses a string as an identifier, and returns the list of 'Name's that</span>
<a name="line-947"></a><span class='hs-comment'>-- the identifier can refer to in the current interactive context.</span>
<a name="line-948"></a><span class='hs-definition'>parseName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-949"></a><span class='hs-definition'>parseName</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-950"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscParseIdentifier</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>str</span>
<a name="line-951"></a>   <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscTcRnLookupRdrName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>rdr_name</span>
<a name="line-952"></a>
<a name="line-953"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-954"></a><span class='hs-comment'>-- Getting the type of an expression</span>
<a name="line-955"></a>
<a name="line-956"></a><a name="exprType"></a><span class='hs-comment'>-- | Get the type of an expression</span>
<a name="line-957"></a><span class='hs-comment'>-- Returns its most general type</span>
<a name="line-958"></a><span class='hs-definition'>exprType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Type</span>
<a name="line-959"></a><span class='hs-definition'>exprType</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-960"></a>   <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscTcExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>expr</span>
<a name="line-961"></a>   <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ty</span>
<a name="line-962"></a>
<a name="line-963"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-964"></a><span class='hs-comment'>-- Getting the kind of a type</span>
<a name="line-965"></a>
<a name="line-966"></a><a name="typeKind"></a><span class='hs-comment'>-- | Get the kind of a  type</span>
<a name="line-967"></a><span class='hs-definition'>typeKind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-968"></a><span class='hs-definition'>typeKind</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-969"></a>   <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscKcType</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>str</span>
<a name="line-970"></a>
<a name="line-971"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-972"></a><span class='hs-comment'>-- Compile an expression, run it and deliver the resulting HValue</span>
<a name="line-973"></a>
<a name="line-974"></a><a name="compileExpr"></a><span class='hs-definition'>compileExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>HValue</span>
<a name="line-975"></a><span class='hs-definition'>compileExpr</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-976"></a>  <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>hval</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscStmt</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-str'>"let __cmCompileExpr = "</span><span class='hs-varop'>++</span><span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-977"></a>  <span class='hs-varid'>updateFixityEnv</span> <span class='hs-varid'>fix_env</span>
<a name="line-978"></a>  <span class='hs-varid'>hvals</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>hval</span>
<a name="line-979"></a>  <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span><span class='hs-varid'>hvals</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-980"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>hv</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>hv</span>
<a name="line-981"></a>    <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"compileExpr"</span>
<a name="line-982"></a>
<a name="line-983"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-984"></a><span class='hs-comment'>-- Compile an expression, run it and return the result as a dynamic</span>
<a name="line-985"></a>
<a name="line-986"></a><a name="dynCompileExpr"></a><span class='hs-definition'>dynCompileExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Dynamic</span>
<a name="line-987"></a><span class='hs-definition'>dynCompileExpr</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-988"></a>    <span class='hs-varid'>iis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getContext</span>
<a name="line-989"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>importDecl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportDecl</span> <span class='hs-layout'>{</span>
<a name="line-990"></a>                         <span class='hs-varid'>ideclName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleName</span> <span class='hs-str'>"Data.Dynamic"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-991"></a>                         <span class='hs-varid'>ideclPkgQual</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>
<a name="line-992"></a>                         <span class='hs-varid'>ideclSource</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-993"></a>                         <span class='hs-varid'>ideclSafe</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-994"></a>                         <span class='hs-varid'>ideclQualified</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span>
<a name="line-995"></a>                         <span class='hs-varid'>ideclImplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-996"></a>                         <span class='hs-varid'>ideclAs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>
<a name="line-997"></a>                         <span class='hs-varid'>ideclHiding</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-998"></a>                     <span class='hs-layout'>}</span>
<a name="line-999"></a>    <span class='hs-varid'>setContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>IIDecl</span> <span class='hs-varid'>importDecl</span> <span class='hs-conop'>:</span> <span class='hs-varid'>iis</span><span class='hs-layout'>)</span>
<a name="line-1000"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"let __dynCompileExpr = Data.Dynamic.toDyn ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span>
<a name="line-1001"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>hvals</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1002"></a>                           <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscStmt</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stmt</span>
<a name="line-1003"></a>    <span class='hs-varid'>setContext</span> <span class='hs-varid'>iis</span>
<a name="line-1004"></a>    <span class='hs-varid'>updateFixityEnv</span> <span class='hs-varid'>fix_env</span>
<a name="line-1005"></a>
<a name="line-1006"></a>    <span class='hs-varid'>vals</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>hvals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Dynamic</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1007"></a>    <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span><span class='hs-varid'>vals</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1008"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-1009"></a>        <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dynCompileExpr"</span>
<a name="line-1010"></a>
<a name="line-1011"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-1012"></a><span class='hs-comment'>-- show a module and it's source/object filenames</span>
<a name="line-1013"></a>
<a name="line-1014"></a><a name="showModule"></a><span class='hs-definition'>showModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>String</span>
<a name="line-1015"></a><span class='hs-definition'>showModule</span> <span class='hs-varid'>mod_summary</span> <span class='hs-keyglyph'>=</span>
<a name="line-1016"></a>    <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1017"></a>        <span class='hs-varid'>interpreted</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isModuleInterpreted</span> <span class='hs-varid'>mod_summary</span>
<a name="line-1018"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1019"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>showModMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hscTarget</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>interpreted</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span>
<a name="line-1020"></a>
<a name="line-1021"></a><a name="isModuleInterpreted"></a><span class='hs-definition'>isModuleInterpreted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GhcMonad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-1022"></a><span class='hs-definition'>isModuleInterpreted</span> <span class='hs-varid'>mod_summary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withSession</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1023"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1024"></a>        <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"missing linkable"</span>
<a name="line-1025"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>mod_info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>obj_linkable</span><span class='hs-layout'>)</span>
<a name="line-1026"></a>                      <span class='hs-keyword'>where</span>
<a name="line-1027"></a>                         <span class='hs-varid'>obj_linkable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isObjectLinkable</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"showModule"</span> <span class='hs-layout'>(</span><span class='hs-varid'>hm_linkable</span> <span class='hs-varid'>mod_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1028"></a>
<a name="line-1029"></a><span class='hs-comment'>----------------------------------------------------------------------------</span>
<a name="line-1030"></a><span class='hs-comment'>-- RTTI primitives</span>
<a name="line-1031"></a>
<a name="line-1032"></a><a name="obtainTermFromVal"></a><span class='hs-definition'>obtainTermFromVal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Term</span>
<a name="line-1033"></a><span class='hs-definition'>obtainTermFromVal</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span>
<a name="line-1034"></a>              <span class='hs-varid'>cvObtainTerm</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeCoerce</span><span class='hs-cpp'>#</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1035"></a>
<a name="line-1036"></a><a name="obtainTermFromId"></a><span class='hs-definition'>obtainTermFromId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Term</span>
<a name="line-1037"></a><span class='hs-definition'>obtainTermFromId</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span>
<a name="line-1038"></a>              <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Linker</span><span class='hs-varop'>.</span><span class='hs-varid'>getHValue</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-1039"></a>              <span class='hs-varid'>cvObtainTerm</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>force</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>hv</span>
<a name="line-1040"></a>
<a name="line-1041"></a><a name="reconstructType"></a><span class='hs-comment'>-- Uses RTTI to reconstruct the type of an Id, making it less polymorphic</span>
<a name="line-1042"></a><span class='hs-definition'>reconstructType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1043"></a><span class='hs-definition'>reconstructType</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1044"></a>              <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Linker</span><span class='hs-varop'>.</span><span class='hs-varid'>getHValue</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-1045"></a>              <span class='hs-varid'>cvReconstructType</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>bound</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>hv</span>
<a name="line-1046"></a>
<a name="line-1047"></a><a name="mkRuntimeUnkTyVar"></a><span class='hs-definition'>mkRuntimeUnkTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-1048"></a><span class='hs-definition'>mkRuntimeUnkTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-conid'>RuntimeUnk</span>
<a name="line-1049"></a><span class='hs-cpp'>#endif /* GHCI */</span>
<a name="line-1050"></a>
</pre></body>
</html>
