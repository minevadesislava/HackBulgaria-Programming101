<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>parser/RdrHsSyn.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
o%
% (c) The University of Glasgow, 1996-2003

Functions over HsSyn specialised to RdrName.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RdrHsSyn</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-varid'>mkHsOpApp</span><span class='hs-layout'>,</span>
<a name="line-3"></a>        <span class='hs-varid'>mkHsIntegral</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHsFractional</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHsIsString</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>mkHsDo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSpliceDecl</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>mkRoleAnnotDecl</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>mkClassDecl</span><span class='hs-layout'>,</span> 
<a name="line-7"></a>        <span class='hs-varid'>mkTyData</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDataFamInst</span><span class='hs-layout'>,</span> 
<a name="line-8"></a>        <span class='hs-varid'>mkTySynonym</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyFamInstEqn</span><span class='hs-layout'>,</span>
<a name="line-9"></a>        <span class='hs-varid'>mkTyFamInst</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>        <span class='hs-varid'>mkFamDecl</span><span class='hs-layout'>,</span> 
<a name="line-11"></a>        <span class='hs-varid'>splitCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInlinePragma</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>mkRecConstrOrUpdate</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- HsExp -&gt; [HsFieldUpdate] -&gt; P HsExp</span>
<a name="line-13"></a>        <span class='hs-varid'>mkTyLit</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>mkTyClD</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInstD</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>        <span class='hs-varid'>cvBindGroup</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>cvBindsAndSigs</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>cvTopDecls</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>placeHolderPunRhs</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-comment'>-- Stuff to do with Foreign declarations</span>
<a name="line-22"></a>        <span class='hs-varid'>mkImport</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>parseCImport</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>mkExport</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>mkExtName</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- RdrName -&gt; CLabelString</span>
<a name="line-26"></a>        <span class='hs-varid'>mkGadtDecl</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- [Located RdrName] -&gt; LHsType RdrName -&gt; ConDecl RdrName</span>
<a name="line-27"></a>        <span class='hs-varid'>mkSimpleConDecl</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>mkDeprecatedGadtRecordDecl</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>        <span class='hs-comment'>-- Bunch of functions in the parser monad for</span>
<a name="line-31"></a>        <span class='hs-comment'>-- checking and constructing values</span>
<a name="line-32"></a>        <span class='hs-varid'>checkPrecP</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- Int -&gt; P Int</span>
<a name="line-33"></a>        <span class='hs-varid'>checkContext</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- HsType -&gt; P HsContext</span>
<a name="line-34"></a>        <span class='hs-varid'>checkPattern</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- HsExp -&gt; P HsPat</span>
<a name="line-35"></a>        <span class='hs-varid'>bang_RDR</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>checkPatterns</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- SrcLoc -&gt; [HsExp] -&gt; P [HsPat]</span>
<a name="line-37"></a>        <span class='hs-varid'>checkMonadComp</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- P (HsStmtContext RdrName)</span>
<a name="line-38"></a>        <span class='hs-varid'>checkCommand</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- LHsExpr RdrName -&gt; P (LHsCmd RdrName)</span>
<a name="line-39"></a>        <span class='hs-varid'>checkValDef</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- (SrcLoc, HsExp, HsRhs, [HsDecl]) -&gt; P HsDecl</span>
<a name="line-40"></a>        <span class='hs-varid'>checkValSig</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- (SrcLoc, HsExp, HsRhs, [HsDecl]) -&gt; P HsDecl</span>
<a name="line-41"></a>        <span class='hs-varid'>checkDoAndIfThenElse</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>checkRecordSyntax</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>parseErrorSDoc</span><span class='hs-layout'>,</span>
<a name="line-44"></a>
<a name="line-45"></a>        <span class='hs-comment'>-- Help with processing exports</span>
<a name="line-46"></a>        <span class='hs-conid'>ImpExpSubSpec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-varid'>mkModuleImpExp</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>mkTypeImpExp</span>
<a name="line-49"></a>
<a name="line-50"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>            <span class='hs-comment'>-- Lots of it</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>            <span class='hs-layout'>(</span> <span class='hs-conid'>FunDep</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>Role</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsFromRole</span> <span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRdrTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRdrTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnqual</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdrNameOcc</span><span class='hs-layout'>,</span> 
<a name="line-56"></a>                          <span class='hs-varid'>isRdrDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnqual</span><span class='hs-layout'>,</span> <span class='hs-varid'>getRdrName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setRdrNameSpace</span><span class='hs-layout'>,</span>
<a name="line-57"></a>                          <span class='hs-varid'>rdrNameSpace</span> <span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>tcClsName</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVarNameSpace</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>             <span class='hs-layout'>(</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>maxPrecedence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Activation</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>RuleMatchInfo</span><span class='hs-layout'>,</span>
<a name="line-61"></a>                          <span class='hs-conid'>InlinePragma</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InlineSpec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Origin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-layout'>)</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Lexer</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>unitTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitDataCon</span> <span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>srcDataName</span><span class='hs-layout'>,</span> <span class='hs-varid'>varName</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDataOcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTcOcc</span><span class='hs-layout'>,</span>
<a name="line-67"></a>                          <span class='hs-varid'>occNameString</span> <span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>forall_tv_RDR</span> <span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OrdList</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>OrdList</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromOL</span> <span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>              <span class='hs-layout'>(</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>consBag</span> <span class='hs-layout'>)</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;$&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>ParserCombinators</span><span class='hs-varop'>.</span><span class='hs-conid'>ReadP</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>ReadP</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>dataTypeOf</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromConstr</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataTypeConstrs</span> <span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Construction functions for Rdr stuff}
%*                                                                    *
%************************************************************************

mkClassDecl builds a RdrClassDecl, filling in the names for tycon and datacon
by deriving them from the name of the class.  We fill in the names for the
tycon and datacon corresponding to the class, by deriving them from the
name of the class itself.  This saves recording the names in the interface
file (which would be equally good).

Similarly for mkConDecl, mkClassOpSig and default-method names.

        *** See "THE NAMING STORY" in HsDecls ****

\begin{code}
<pre><a name="line-1"></a><a name="mkTyClD"></a><span class='hs-definition'>mkTyClD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsDecl</span> <span class='hs-varid'>n</span>
<a name="line-2"></a><span class='hs-definition'>mkTyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyClD</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="mkInstD"></a><span class='hs-definition'>mkInstD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LInstDecl</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsDecl</span> <span class='hs-varid'>n</span>
<a name="line-5"></a><span class='hs-definition'>mkInstD</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstD</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mkClassDecl"></a><span class='hs-definition'>mkClassDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-8"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-9"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDep</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>mkClassDecl</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>mcxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tycl_hdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fds</span> <span class='hs-varid'>where_cls</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats</span><span class='hs-layout'>,</span> <span class='hs-varid'>at_defs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvBindsAndSigs</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>where_cls</span><span class='hs-layout'>)</span>
<a name="line-15"></a>             <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>mcxt</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tparams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyClHdr</span> <span class='hs-varid'>tycl_hdr</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"class"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>whereDots</span>
<a name="line-18"></a>                               <span class='hs-varid'>cls</span> <span class='hs-varid'>tparams</span>      <span class='hs-comment'>-- Only type vars allowed</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span>
<a name="line-20"></a>                                    <span class='hs-varid'>tcdFDs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>fds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdSigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdMeths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span>
<a name="line-21"></a>                                    <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ats</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATDefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>at_defs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDocs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>docs</span><span class='hs-layout'>,</span>
<a name="line-22"></a>                                    <span class='hs-varid'>tcdFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="mkTyData"></a><span class='hs-definition'>mkTyData</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-25"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewOrData</span>
<a name="line-26"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CType</span>
<a name="line-27"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-28"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-29"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-definition'>mkTyData</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>cType</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>mcxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tycl_hdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ksig</span> <span class='hs-varid'>data_cons</span> <span class='hs-varid'>maybe_deriv</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tparams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyClHdr</span> <span class='hs-varid'>tycl_hdr</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_or_data</span><span class='hs-layout'>)</span> <span class='hs-varid'>equalsDots</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tparams</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>defn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkDataDefn</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>cType</span> <span class='hs-varid'>mcxt</span> <span class='hs-varid'>ksig</span> <span class='hs-varid'>data_cons</span> <span class='hs-varid'>maybe_deriv</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span>
<a name="line-37"></a>                                   <span class='hs-varid'>tcdDataDefn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defn</span><span class='hs-layout'>,</span>
<a name="line-38"></a>                                   <span class='hs-varid'>tcdFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="mkDataDefn"></a><span class='hs-definition'>mkDataDefn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NewOrData</span>
<a name="line-41"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CType</span>
<a name="line-42"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-43"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-44"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-46"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDataDefn</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-definition'>mkDataDefn</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>cType</span> <span class='hs-varid'>mcxt</span> <span class='hs-varid'>ksig</span> <span class='hs-varid'>data_cons</span> <span class='hs-varid'>maybe_deriv</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkDatatypeContext</span> <span class='hs-varid'>mcxt</span>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>mcxt</span>
<a name="line-50"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDataDefn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dd_ND</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_or_data</span><span class='hs-layout'>,</span> <span class='hs-varid'>dd_cType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cType</span>
<a name="line-51"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>dd_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cxt</span> 
<a name="line-52"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>dd_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>data_cons</span>
<a name="line-53"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>dd_kindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ksig</span>
<a name="line-54"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>dd_derivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe_deriv</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="mkTySynonym"></a><span class='hs-definition'>mkTySynonym</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-57"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>  <span class='hs-comment'>-- LHS</span>
<a name="line-58"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>  <span class='hs-comment'>-- RHS</span>
<a name="line-59"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-definition'>mkTySynonym</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>rhs</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tparams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyClHdr</span> <span class='hs-varid'>lhs</span>
<a name="line-62"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>equalsDots</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tparams</span>
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>SynDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span>
<a name="line-64"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>tcdRhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="mkTyFamInstEqn"></a><span class='hs-definition'>mkTyFamInstEqn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-67"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-68"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstEqn</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-definition'>mkTyFamInstEqn</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>rhs</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tparams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyClHdr</span> <span class='hs-varid'>lhs</span>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstEqn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tfie_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span>
<a name="line-72"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>tfie_pats</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWithBndrs</span> <span class='hs-varid'>tparams</span>
<a name="line-73"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>tfie_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="mkDataFamInst"></a><span class='hs-definition'>mkDataFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-76"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewOrData</span>
<a name="line-77"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CType</span>
<a name="line-78"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-79"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-80"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-82"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-83"></a><span class='hs-definition'>mkDataFamInst</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>cType</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>mcxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tycl_hdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ksig</span> <span class='hs-varid'>data_cons</span> <span class='hs-varid'>maybe_deriv</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tparams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyClHdr</span> <span class='hs-varid'>tycl_hdr</span>
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>defn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkDataDefn</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>cType</span> <span class='hs-varid'>mcxt</span> <span class='hs-varid'>ksig</span> <span class='hs-varid'>data_cons</span> <span class='hs-varid'>maybe_deriv</span>
<a name="line-86"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamInstD</span> <span class='hs-layout'>(</span>
<a name="line-87"></a>                  <span class='hs-conid'>DataFamInstDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfid_pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWithBndrs</span> <span class='hs-varid'>tparams</span>
<a name="line-88"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>dfid_defn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defn</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfid_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="mkTyFamInst"></a><span class='hs-definition'>mkTyFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-91"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LTyFamInstEqn</span> <span class='hs-conid'>RdrName</span>
<a name="line-92"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-definition'>mkTyFamInst</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>eqn</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tfid_eqn</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqn</span>
<a name="line-95"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>tfid_fvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="mkFamDecl"></a><span class='hs-definition'>mkFamDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-98"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamilyInfo</span> <span class='hs-conid'>RdrName</span>
<a name="line-99"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>   <span class='hs-comment'>-- LHS</span>
<a name="line-100"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Optional kind signature</span>
<a name="line-101"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-102"></a><span class='hs-definition'>mkFamDecl</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>ksig</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tparams</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyClHdr</span> <span class='hs-varid'>lhs</span>
<a name="line-104"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-varid'>equals_or_where</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tparams</span>
<a name="line-105"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamilyDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fdInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span>
<a name="line-106"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>fdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdKindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ksig</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>  <span class='hs-keyword'>where</span>
<a name="line-108"></a>    <span class='hs-varid'>equals_or_where</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-109"></a>                        <span class='hs-conid'>DataFamily</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span>
<a name="line-110"></a>                        <span class='hs-conid'>OpenTypeFamily</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span>
<a name="line-111"></a>                        <span class='hs-conid'>ClosedTypeFamily</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>whereDots</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="mkSpliceDecl"></a><span class='hs-definition'>mkSpliceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDecl</span> <span class='hs-conid'>RdrName</span>
<a name="line-114"></a><span class='hs-comment'>-- If the user wrote</span>
<a name="line-115"></a><span class='hs-comment'>--      [pads| ... ]   then return a QuasiQuoteD</span>
<a name="line-116"></a><span class='hs-comment'>--      $(e)           then return a SpliceD</span>
<a name="line-117"></a><span class='hs-comment'>-- but if she wrote, say,</span>
<a name="line-118"></a><span class='hs-comment'>--      f x            then behave as if she'd written $(f x)</span>
<a name="line-119"></a><span class='hs-comment'>--                     ie a SpliceD</span>
<a name="line-120"></a><span class='hs-definition'>mkSpliceDecl</span> <span class='hs-varid'>lexpr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsQuasiQuoteE</span> <span class='hs-varid'>qq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expr</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>QuasiQuoteD</span> <span class='hs-varid'>qq</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>splice</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_typed</span> <span class='hs-layout'>)</span>
<a name="line-123"></a>                                        <span class='hs-conid'>SpliceD</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-conid'>Explicit</span><span class='hs-layout'>)</span>
<a name="line-124"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpliceD</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpliceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>splice</span><span class='hs-layout'>)</span> <span class='hs-conid'>Implicit</span><span class='hs-layout'>)</span>
<a name="line-125"></a>  <span class='hs-keyword'>where</span>
<a name="line-126"></a>    <span class='hs-varid'>splice</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsSplice</span> <span class='hs-varid'>lexpr</span>
<a name="line-127"></a>
<a name="line-128"></a><a name="mkTyLit"></a><span class='hs-definition'>mkTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-definition'>mkTyLit</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-130"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>allowed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extension</span> <span class='hs-varid'>typeLiteralsEnabled</span>
<a name="line-131"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>allowed</span>
<a name="line-132"></a>       <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-133"></a>       <span class='hs-keyword'>else</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-134"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal literal in type (use DataKinds to enable):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-135"></a>              <span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="mkRoleAnnotDecl"></a><span class='hs-definition'>mkRoleAnnotDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-138"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span>                   <span class='hs-comment'>-- type being annotated</span>
<a name="line-139"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FastString</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- roles</span>
<a name="line-140"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRoleAnnotDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-141"></a><span class='hs-definition'>mkRoleAnnotDecl</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>roles</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>roles'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>parse_role</span> <span class='hs-varid'>roles</span>
<a name="line-143"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RoleAnnotDecl</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>roles'</span> <span class='hs-layout'>}</span>
<a name="line-144"></a>  <span class='hs-keyword'>where</span>
<a name="line-145"></a>    <span class='hs-varid'>role_data_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataTypeOf</span> <span class='hs-layout'>(</span><span class='hs-varid'>undefined</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-146"></a>    <span class='hs-varid'>all_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fromConstr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dataTypeConstrs</span> <span class='hs-varid'>role_data_type</span>
<a name="line-147"></a>    <span class='hs-varid'>possible_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>fsFromRole</span> <span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>role</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>all_roles</span><span class='hs-keyglyph'>]</span>
<a name="line-148"></a>
<a name="line-149"></a>    <span class='hs-varid'>parse_role</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc_role</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc_role</span> <span class='hs-conid'>Nothing</span>
<a name="line-150"></a>    <span class='hs-varid'>parse_role</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc_role</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-151"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>role</span> <span class='hs-varid'>possible_roles</span> <span class='hs-keyword'>of</span>
<a name="line-152"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>found_role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc_role</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>found_role</span>
<a name="line-153"></a>          <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span>
<a name="line-154"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>nearby</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fuzzyLookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>unpackFS</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapFst</span> <span class='hs-varid'>unpackFS</span> <span class='hs-varid'>possible_roles</span><span class='hs-layout'>)</span> <span class='hs-keyword'>in</span>
<a name="line-155"></a>            <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc_role</span>
<a name="line-156"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal role name"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-157"></a>               <span class='hs-varid'>suggestions</span> <span class='hs-varid'>nearby</span><span class='hs-layout'>)</span>
<a name="line-158"></a>
<a name="line-159"></a>    <span class='hs-varid'>suggestions</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-160"></a>    <span class='hs-varid'>suggestions</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you meant"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-161"></a>      <span class='hs-comment'>-- will this last case ever happen??</span>
<a name="line-162"></a>    <span class='hs-varid'>suggestions</span> <span class='hs-varid'>list</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you meant one of these:"</span><span class='hs-layout'>)</span>
<a name="line-163"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ppr</span><span class='hs-layout'>)</span> <span class='hs-varid'>list</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[cvBinds-etc]{Converting to @HsBinds@, etc.}
%*                                                                      *
%************************************************************************

Function definitions are restructured here. Each is assumed to be recursive
initially, and non recursive definitions are discovered by the dependency
analyser.


\begin{code}
<pre><a name="line-1"></a><a name="cvTopDecls"></a><span class='hs-comment'>--  | Groups together bindings for a single function</span>
<a name="line-2"></a><span class='hs-definition'>cvTopDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a><span class='hs-definition'>cvTopDecls</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>decls</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-7"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValD</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValD</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds'</span>
<a name="line-8"></a>                            <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l'</span> <span class='hs-varid'>b'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getMonoBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-9"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="cvBindGroup"></a><span class='hs-comment'>-- Declaration list may only contain value bindings and signatures.</span>
<a name="line-12"></a><span class='hs-definition'>cvBindGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>RdrName</span>
<a name="line-13"></a><span class='hs-definition'>cvBindGroup</span> <span class='hs-varid'>binding</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cvBindsAndSigs</span> <span class='hs-varid'>binding</span> <span class='hs-keyword'>of</span>
<a name="line-15"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>mbs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfam_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfam_insts</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 
<a name="line-16"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fam_ds</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tfam_insts</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>dfam_insts</span><span class='hs-layout'>)</span>
<a name="line-17"></a>            <span class='hs-conid'>ValBindsIn</span> <span class='hs-varid'>mbs</span> <span class='hs-varid'>sigs</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="cvBindsAndSigs"></a><span class='hs-definition'>cvBindsAndSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrdList</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFamilyDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>          <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyFamInstDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDataFamInstDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDocDecl</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-comment'>-- Input decls contain just value bindings and signatures</span>
<a name="line-23"></a><span class='hs-comment'>-- and in case of class or instance declarations also</span>
<a name="line-24"></a><span class='hs-comment'>-- associated type declarations. They might also contain Haddock comments.</span>
<a name="line-25"></a><span class='hs-definition'>cvBindsAndSigs</span>  <span class='hs-varid'>fb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>fb</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-keyword'>where</span>
<a name="line-27"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-28"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                           <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds</span>
<a name="line-30"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValD</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b'</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                           <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>b'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getMonoBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-32"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds'</span>
<a name="line-33"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamDecl</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-34"></a>                           <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds</span>
<a name="line-35"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamInstD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tfid_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tfi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>tfi</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                           <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds</span>
<a name="line-37"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstD</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamInstD</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dfid_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>dfi</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                           <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds</span>
<a name="line-39"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>DocD</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-40"></a>                           <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfis</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ds</span>
<a name="line-41"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"cvBindsAndSigs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-44"></a><span class='hs-comment'>-- Group function bindings into equation groups</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="getMonoBind"></a><span class='hs-definition'>getMonoBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-comment'>-- Suppose      (b',ds') = getMonoBind b ds</span>
<a name="line-49"></a><span class='hs-comment'>--      ds is a list of parsed bindings</span>
<a name="line-50"></a><span class='hs-comment'>--      b is a MonoBinds that has just been read off the front</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-comment'>-- Then b' is the result of grouping more equations from ds that</span>
<a name="line-53"></a><span class='hs-comment'>-- belong with b into a single MonoBinds, and ds' is the depleted</span>
<a name="line-54"></a><span class='hs-comment'>-- list of parsed bindings.</span>
<a name="line-55"></a><span class='hs-comment'>--</span>
<a name="line-56"></a><span class='hs-comment'>-- All Haddock comments between equations inside the group are</span>
<a name="line-57"></a><span class='hs-comment'>-- discarded.</span>
<a name="line-58"></a><span class='hs-comment'>--</span>
<a name="line-59"></a><span class='hs-comment'>-- No AndMonoBinds or EmptyMonoBinds here; just single equations</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-definition'>getMonoBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc1</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_id1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_infix1</span><span class='hs-layout'>,</span>
<a name="line-62"></a>                               <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mtchs1</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>has_args</span> <span class='hs-varid'>mtchs1</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>is_infix1</span> <span class='hs-varid'>mtchs1</span> <span class='hs-varid'>loc1</span> <span class='hs-varid'>binds</span> <span class='hs-conid'>[]</span>
<a name="line-65"></a>  <span class='hs-keyword'>where</span>
<a name="line-66"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>mtchs</span> <span class='hs-varid'>loc</span>
<a name="line-67"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValD</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_infix2</span><span class='hs-layout'>,</span>
<a name="line-68"></a>                                <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mtchs2</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-69"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>f2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_infix</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_infix2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mtchs2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>mtchs</span><span class='hs-layout'>)</span>
<a name="line-70"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>combineSrcSpans</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span> <span class='hs-conid'>[]</span>
<a name="line-71"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>mtchs</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>doc_decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-conid'>DocD</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>doc_decls</span>
<a name="line-72"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>doc_decls'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doc_decl</span> <span class='hs-conop'>:</span> <span class='hs-varid'>doc_decls</span>
<a name="line-73"></a>          <span class='hs-keyword'>in</span> <span class='hs-varid'>go</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>mtchs</span> <span class='hs-layout'>(</span><span class='hs-varid'>combineSrcSpans</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>doc_decls'</span>
<a name="line-74"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>mtchs</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>doc_decls</span>
<a name="line-75"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>makeFunBind</span> <span class='hs-varid'>fun_id1</span> <span class='hs-varid'>is_infix</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>mtchs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>doc_decls</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-76"></a>        <span class='hs-comment'>-- Reverse the final matches, to get it back in the right order</span>
<a name="line-77"></a>        <span class='hs-comment'>-- Do the same thing with the trailing doc comments</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-definition'>getMonoBind</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="has_args"></a><span class='hs-definition'>has_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LMatch</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-82"></a><span class='hs-definition'>has_args</span> <span class='hs-conid'>[]</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"RdrHsSyn:has_args"</span>
<a name="line-83"></a><span class='hs-definition'>has_args</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-84"></a>        <span class='hs-comment'>-- Don't group together FunBinds if they have</span>
<a name="line-85"></a>        <span class='hs-comment'>-- no arguments.  This is necessary now that variable bindings</span>
<a name="line-86"></a>        <span class='hs-comment'>-- with no arguments are now treated as FunBinds rather</span>
<a name="line-87"></a>        <span class='hs-comment'>-- than pattern bindings (tests/rename/should_fail/rnfail002).</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[PrefixToHS-utils]{Utilities for conversion}
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- splitCon</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- When parsing data declarations, we sometimes inadvertently parse</span>
<a name="line-5"></a><span class='hs-comment'>-- a constructor application as a type (eg. in data T a b = C a b `D` E a b)</span>
<a name="line-6"></a><span class='hs-comment'>-- This function splits up the type application, adds any pending</span>
<a name="line-7"></a><span class='hs-comment'>-- arguments, and converts the type constructor back into a data constructor.</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="splitCon"></a><span class='hs-definition'>splitCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-10"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsConDeclDetails</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-comment'>-- This gets given a "type" that should look like</span>
<a name="line-12"></a><span class='hs-comment'>--      C Int Bool</span>
<a name="line-13"></a><span class='hs-comment'>-- or   C { x::Int, y::Bool }</span>
<a name="line-14"></a><span class='hs-comment'>-- and returns the pieces</span>
<a name="line-15"></a><span class='hs-definition'>splitCon</span> <span class='hs-varid'>ty</span>
<a name="line-16"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-17"></a> <span class='hs-keyword'>where</span>
<a name="line-18"></a>   <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>t</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-19"></a>   <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-varid'>ts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConToDataCon</span> <span class='hs-varid'>l</span> <span class='hs-varid'>tc</span>
<a name="line-20"></a>                                        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_con</span><span class='hs-layout'>,</span> <span class='hs-varid'>mk_rest</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-21"></a>   <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRdrName</span> <span class='hs-varid'>unitDataCon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrefixCon</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                                         <span class='hs-comment'>-- See Note [Unit tuples] in HsTypes</span>
<a name="line-23"></a>   <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"parse error in constructor in data/newtype declaration:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>   <span class='hs-varid'>mk_rest</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecCon</span> <span class='hs-varid'>flds</span>
<a name="line-26"></a>   <span class='hs-varid'>mk_rest</span> <span class='hs-varid'>ts</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>ts</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="mkDeprecatedGadtRecordDecl"></a><span class='hs-definition'>mkDeprecatedGadtRecordDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-29"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span>
<a name="line-30"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ConDeclField</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-32"></a>                           <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDecl</span>  <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-comment'>-- This one uses the deprecated syntax</span>
<a name="line-34"></a><span class='hs-comment'>--    C { x,y ::Int } :: T a b</span>
<a name="line-35"></a><span class='hs-comment'>-- We give it a RecCon details right away</span>
<a name="line-36"></a><span class='hs-definition'>mkDeprecatedGadtRecordDecl</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>con_loc</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>flds</span> <span class='hs-varid'>res_ty</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConToDataCon</span> <span class='hs-varid'>con_loc</span> <span class='hs-varid'>con</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_old_rec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-39"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>con_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>data_con</span>
<a name="line-40"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>con_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implicit</span>
<a name="line-41"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>con_qvars</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsQTvs</span> <span class='hs-conid'>[]</span>
<a name="line-42"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-conid'>[]</span>
<a name="line-43"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecCon</span> <span class='hs-varid'>flds</span>
<a name="line-44"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyGADT</span> <span class='hs-varid'>res_ty</span>
<a name="line-45"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>con_doc</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="mkSimpleConDecl"></a><span class='hs-definition'>mkSimpleConDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsConDeclDetails</span> <span class='hs-conid'>RdrName</span>
<a name="line-49"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConDecl</span> <span class='hs-conid'>RdrName</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-definition'>mkSimpleConDecl</span> <span class='hs-varid'>name</span> <span class='hs-varid'>qvars</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>details</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_old_rec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-53"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>con_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-54"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>con_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Explicit</span>
<a name="line-55"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>con_qvars</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsQTvs</span> <span class='hs-varid'>qvars</span>
<a name="line-56"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cxt</span>
<a name="line-57"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span>
<a name="line-58"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyH98</span>
<a name="line-59"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>con_doc</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="mkGadtDecl"></a><span class='hs-definition'>mkGadtDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>     <span class='hs-comment'>-- Always a HsForAllTy</span>
<a name="line-63"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ConDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a><span class='hs-comment'>-- We allow C,D :: ty</span>
<a name="line-65"></a><span class='hs-comment'>-- and expand it as if it had been</span>
<a name="line-66"></a><span class='hs-comment'>--    C :: ty; D :: ty</span>
<a name="line-67"></a><span class='hs-comment'>-- (Just like type signatures in general.)</span>
<a name="line-68"></a><span class='hs-definition'>mkGadtDecl</span> <span class='hs-varid'>names</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>imp</span> <span class='hs-varid'>qvars</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mk_gadt_con</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span><span class='hs-keyglyph'>]</span>
<a name="line-70"></a>  <span class='hs-keyword'>where</span>
<a name="line-71"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>details</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- See Note [Sorting out the result type]</span>
<a name="line-72"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tau</span> <span class='hs-keyword'>of</span>
<a name="line-73"></a>          <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-varid'>flds</span><span class='hs-layout'>,</span>  <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-74"></a>          <span class='hs-sel'>_other</span>                                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a>    <span class='hs-varid'>mk_gadt_con</span> <span class='hs-varid'>name</span>
<a name="line-77"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_old_rec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-78"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>con_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-79"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>con_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp</span>
<a name="line-80"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>con_qvars</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qvars</span>
<a name="line-81"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cxt</span>
<a name="line-82"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span>
<a name="line-83"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyGADT</span> <span class='hs-varid'>res_ty</span>
<a name="line-84"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>con_doc</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-85"></a><span class='hs-definition'>mkGadtDecl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkGadtDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other_ty</span><span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="tyConToDataCon"></a><span class='hs-definition'>tyConToDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-definition'>tyConToDataCon</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tc</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>setRdrNameSpace</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>srcDataName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span>
<a name="line-93"></a>  <span class='hs-keyword'>where</span>
<a name="line-94"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Not a data constructor:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-95"></a>    <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>forall_tv_RDR</span>
<a name="line-96"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you intended to use ExistentialQuantification"</span>
<a name="line-97"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
</pre>\end{code}

Note [Sorting out the result type]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a GADT declaration which is not a record, we put the whole constr
type into the ResTyGADT for now; the renamer will unravel it once it
has sorted out operator fixities. Consider for example
     C :: a :*: b -> a :*: b -> a :+: b
Initially this type will parse as
      a :*: (b -> (a :*: (b -> (a :+: b))))

so it's hard to split up the arguments until we've done the precedence
resolution (in the renamer) On the other hand, for a record
        { x,y :: Int } -> a :*: b
there is no doubt.  AND we need to sort records out so that
we can bring x,y into scope.  So:
   * For PrefixCon we keep all the args in the ResTyGADT
   * For RecCon we do not

\begin{code}
<pre><a name="line-1"></a><a name="checkTyVars"></a><span class='hs-definition'>checkTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Check whether the given list of type parameters are all type variables</span>
<a name="line-3"></a><span class='hs-comment'>-- (possibly with a kind signature).</span>
<a name="line-4"></a><span class='hs-definition'>checkTyVars</span> <span class='hs-varid'>pp_what</span> <span class='hs-varid'>equals_or_where</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tparms</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>chk</span> <span class='hs-varid'>tparms</span>
<a name="line-5"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsQTvs</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>        <span class='hs-comment'>-- Check that the name space is correct!</span>
<a name="line-8"></a>    <span class='hs-varid'>chk</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrTyVar</span> <span class='hs-varid'>tv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>    <span class='hs-varid'>chk</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrTyVar</span> <span class='hs-varid'>tv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-varid'>chk</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-13"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span>
<a name="line-14"></a>          <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-15"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-16"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span><span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"declaration should have form"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a b c"</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals_or_where</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="whereDots"></a><span class='hs-definition'>whereDots</span><span class='hs-layout'>,</span> <span class='hs-varid'>equalsDots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-21"></a><span class='hs-definition'>whereDots</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"where ..."</span><span class='hs-layout'>)</span>
<a name="line-22"></a><a name="equalsDots"></a><span class='hs-definition'>equalsDots</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"= ..."</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="checkDatatypeContext"></a><span class='hs-definition'>checkDatatypeContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-conid'>()</span>
<a name="line-25"></a><span class='hs-definition'>checkDatatypeContext</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-26"></a><span class='hs-definition'>checkDatatypeContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>allowed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extension</span> <span class='hs-varid'>datatypeContextsEnabled</span>
<a name="line-28"></a>         <span class='hs-varid'>unless</span> <span class='hs-varid'>allowed</span> <span class='hs-varop'>$</span>
<a name="line-29"></a>             <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span>
<a name="line-30"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal datatype context (use DatatypeContexts):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-31"></a>                  <span class='hs-varid'>pprHsContext</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="checkRecordSyntax"></a><span class='hs-definition'>checkRecordSyntax</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-definition'>checkRecordSyntax</span> <span class='hs-varid'>lr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>allowed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extension</span> <span class='hs-varid'>traditionalRecordSyntaxEnabled</span>
<a name="line-36"></a>         <span class='hs-keyword'>if</span> <span class='hs-varid'>allowed</span>
<a name="line-37"></a>             <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>lr</span>
<a name="line-38"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span>
<a name="line-39"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal record syntax (use TraditionalRecordSyntax):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-40"></a>                       <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="checkTyClHdr"></a><span class='hs-definition'>checkTyClHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-43"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- the head symbol (type or class name)</span>
<a name="line-44"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- parameters of head symbol</span>
<a name="line-45"></a><span class='hs-comment'>-- Well-formedness check and decomposition of type and class heads.</span>
<a name="line-46"></a><span class='hs-comment'>-- Decomposes   T ty1 .. tyn   into    (T, [ty1, ..., tyn])</span>
<a name="line-47"></a><span class='hs-comment'>--              Int :*: Bool   into    (:*:, [Int, Bool])</span>
<a name="line-48"></a><span class='hs-comment'>-- returning the pieces</span>
<a name="line-49"></a><span class='hs-definition'>checkTyClHdr</span> <span class='hs-varid'>ty</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goL</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-51"></a>  <span class='hs-keyword'>where</span>
<a name="line-52"></a>    <span class='hs-varid'>goL</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> 
<a name="line-55"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrTc</span> <span class='hs-varid'>tc</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-56"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ltc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-57"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrTc</span> <span class='hs-varid'>tc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ltc</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>t2</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-58"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goL</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-59"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goL</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-varid'>t2</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-60"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRdrName</span> <span class='hs-varid'>unitTyCon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-61"></a>                                   <span class='hs-comment'>-- See Note [Unit tuples] in HsTypes</span>
<a name="line-62"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span>               <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Malformed head of type or class declaration:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="checkContext"></a><span class='hs-definition'>checkContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-definition'>checkContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>orig_t</span><span class='hs-layout'>)</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check</span> <span class='hs-varid'>orig_t</span>
<a name="line-67"></a> <span class='hs-keyword'>where</span>
<a name="line-68"></a>  <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- (Eq a, Ord b) shows up as a tuple type</span>
<a name="line-69"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- Ditto ()</span>
<a name="line-70"></a>
<a name="line-71"></a>  <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- to be sure HsParTy doesn't get into the way</span>
<a name="line-72"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a>  <span class='hs-varid'>check</span> <span class='hs-keyword'>_</span>
<a name="line-75"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>orig_t</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-comment'>-- -------------------------------------------------------------------------</span>
<a name="line-78"></a><span class='hs-comment'>-- Checking Patterns.</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-comment'>-- We parse patterns as expressions and check for valid patterns below,</span>
<a name="line-81"></a><span class='hs-comment'>-- converting the expression into a pattern at the same time.</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="checkPattern"></a><span class='hs-definition'>checkPattern</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-definition'>checkPattern</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="checkPatterns"></a><span class='hs-definition'>checkPatterns</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-87"></a><span class='hs-definition'>checkPatterns</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>es</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkPattern</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="checkLPat"></a><span class='hs-definition'>checkLPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-definition'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>l</span> <span class='hs-varid'>e</span> <span class='hs-conid'>[]</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="checkPat"></a><span class='hs-definition'>checkPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-93"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-94"></a><span class='hs-definition'>checkPat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrDataCon</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-definition'>checkPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span> <span class='hs-varid'>args</span>     <span class='hs-comment'>-- OK to let this happen even if bang-patterns</span>
<a name="line-97"></a>                        <span class='hs-comment'>-- are not enabled, because there is no valid</span>
<a name="line-98"></a>                        <span class='hs-comment'>-- non-bang-pattern parse of (C ! e)</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitBang</span> <span class='hs-varid'>e</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>args''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkPatterns</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>args'</span>
<a name="line-101"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>(</span><span class='hs-varid'>args''</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-102"></a><span class='hs-definition'>checkPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span>
<a name="line-104"></a>       <span class='hs-varid'>checkPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-105"></a><span class='hs-definition'>checkPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkAPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span>
<a name="line-107"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-definition'>checkPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patFail</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="checkAPat"></a><span class='hs-definition'>checkAPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-112"></a><span class='hs-definition'>checkAPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-113"></a> <span class='hs-varid'>pState</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPState</span>
<a name="line-114"></a> <span class='hs-keyword'>let</span> <span class='hs-varid'>dynflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pState</span>
<a name="line-115"></a> <span class='hs-keyword'>case</span> <span class='hs-varid'>e0</span> <span class='hs-keyword'>of</span>
<a name="line-116"></a>   <span class='hs-conid'>EWildPat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>WildPat</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span>
<a name="line-117"></a>   <span class='hs-conid'>HsVar</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarPat</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-118"></a>   <span class='hs-conid'>HsLit</span> <span class='hs-varid'>l</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitPat</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-119"></a>
<a name="line-120"></a>   <span class='hs-comment'>-- Overloaded numeric patterns (e.g. f 0 x = x)</span>
<a name="line-121"></a>   <span class='hs-comment'>-- Negation is recorded separately, so that the literal is zero or +ve</span>
<a name="line-122"></a>   <span class='hs-comment'>-- NB. Negative *primitive* literals are already handled by the lexer</span>
<a name="line-123"></a>   <span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>pos_lit</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNPat</span> <span class='hs-varid'>pos_lit</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-124"></a>   <span class='hs-conid'>NegApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>pos_lit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-125"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNPat</span> <span class='hs-varid'>pos_lit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-126"></a>
<a name="line-127"></a>   <span class='hs-conid'>SectionR</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>bang</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>        <span class='hs-comment'>-- (! x)</span>
<a name="line-128"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bang</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bang_RDR</span>
<a name="line-129"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bang_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extension</span> <span class='hs-varid'>bangPatEnabled</span>
<a name="line-130"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>bang_on</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>BangPat</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal bang-pattern (use BangPatterns):"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e0</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-132"></a>
<a name="line-133"></a>   <span class='hs-conid'>ELazyPat</span> <span class='hs-varid'>e</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>LazyPat</span><span class='hs-layout'>)</span>
<a name="line-134"></a>   <span class='hs-conid'>EAsPat</span> <span class='hs-varid'>n</span> <span class='hs-varid'>e</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>AsPat</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-135"></a>   <span class='hs-comment'>-- view pattern is well-formed if the pattern is</span>
<a name="line-136"></a>   <span class='hs-conid'>EViewPat</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>patE</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>patE</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ViewPat</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>p</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-137"></a>   <span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span>
<a name="line-138"></a>                            <span class='hs-comment'>-- Pattern signatures are parsed as sigtypes,</span>
<a name="line-139"></a>                            <span class='hs-comment'>-- but they aren't explicit forall points.  Hence</span>
<a name="line-140"></a>                            <span class='hs-comment'>-- we have to remove the implicit forall here.</span>
<a name="line-141"></a>                            <span class='hs-keyword'>let</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>of</span>
<a name="line-142"></a>                                       <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Implicit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-143"></a>                                       <span class='hs-varid'>other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>other</span>
<a name="line-144"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigPatIn</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWithBndrs</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-145"></a>
<a name="line-146"></a>   <span class='hs-comment'>-- n+k patterns</span>
<a name="line-147"></a>   <span class='hs-conid'>OpApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nloc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>plus</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-148"></a>         <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>OverLit</span> <span class='hs-layout'>{</span><span class='hs-varid'>ol_val</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsIntegral</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_NPlusKPatterns</span> <span class='hs-varid'>dynflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>plus</span> <span class='hs-varop'>==</span> <span class='hs-varid'>plus_RDR</span><span class='hs-layout'>)</span>
<a name="line-150"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNPlusKPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>nloc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a>   <span class='hs-conid'>OpApp</span> <span class='hs-varid'>l</span> <span class='hs-varid'>op</span> <span class='hs-sel'>_fix</span> <span class='hs-varid'>r</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>l</span>
<a name="line-153"></a>                            <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>r</span>
<a name="line-154"></a>                            <span class='hs-keyword'>case</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>of</span>
<a name="line-155"></a>                               <span class='hs-conid'>L</span> <span class='hs-varid'>cl</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-156"></a>                                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>l</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-157"></a>                               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patFail</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e0</span>
<a name="line-158"></a>
<a name="line-159"></a>   <span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ParPat</span><span class='hs-layout'>)</span>
<a name="line-160"></a>   <span class='hs-conid'>ExplicitList</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>es</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>
<a name="line-161"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-162"></a>   <span class='hs-conid'>ExplicitPArr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>es</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>
<a name="line-163"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrPat</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>)</span>
<a name="line-164"></a>
<a name="line-165"></a>   <span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>es</span> <span class='hs-varid'>b</span>
<a name="line-166"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>tupArgPresent</span> <span class='hs-varid'>es</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Present</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>es</span><span class='hs-keyglyph'>]</span>
<a name="line-167"></a>                                   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePat</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>b</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-168"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal tuple section in pattern:"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e0</span><span class='hs-layout'>)</span>
<a name="line-169"></a>
<a name="line-170"></a>   <span class='hs-conid'>RecordCon</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span>
<a name="line-171"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkPatField</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span>
<a name="line-172"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-173"></a>   <span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>is_typed</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_typed</span> 
<a name="line-174"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SplicePat</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-175"></a>   <span class='hs-conid'>HsQuasiQuoteE</span> <span class='hs-varid'>q</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>QuasiQuotePat</span> <span class='hs-varid'>q</span><span class='hs-layout'>)</span>
<a name="line-176"></a>   <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patFail</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e0</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="placeHolderPunRhs"></a><span class='hs-definition'>placeHolderPunRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-179"></a><span class='hs-comment'>-- The RHS of a punned record field will be filled in by the renamer</span>
<a name="line-180"></a><span class='hs-comment'>-- It's better not to make it an error, in case we want to print it when debugging</span>
<a name="line-181"></a><span class='hs-definition'>placeHolderPunRhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>pun_RDR</span><span class='hs-layout'>)</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="plus_RDR"></a><span class='hs-definition'>plus_RDR</span><span class='hs-layout'>,</span> <span class='hs-varid'>bang_RDR</span><span class='hs-layout'>,</span> <span class='hs-varid'>pun_RDR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span>
<a name="line-184"></a><span class='hs-definition'>plus_RDR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnqual</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"+"</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Hack</span>
<a name="line-185"></a><a name="bang_RDR"></a><span class='hs-definition'>bang_RDR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnqual</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"!"</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Hack</span>
<a name="line-186"></a><a name="pun_RDR"></a><span class='hs-definition'>pun_RDR</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnqual</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"pun-right-hand-side"</span><span class='hs-layout'>)</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="checkPatField"></a><span class='hs-definition'>checkPatField</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsRecField</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-189"></a><span class='hs-definition'>checkPatField</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>fld</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkLPat</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsRecFieldArg</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span>
<a name="line-190"></a>                           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="patFail"></a><span class='hs-definition'>patFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-varid'>a</span>
<a name="line-193"></a><span class='hs-definition'>patFail</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>err</span>
<a name="line-194"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Parse error in pattern:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span>
<a name="line-195"></a>             <span class='hs-varop'>$$</span> <span class='hs-varid'>msg</span>
<a name="line-196"></a>
<a name="line-197"></a>
<a name="line-198"></a><span class='hs-comment'>---------------------------------------------------------------------------</span>
<a name="line-199"></a><span class='hs-comment'>-- Check Equation Syntax</span>
<a name="line-200"></a>
<a name="line-201"></a><a name="checkValDef"></a><span class='hs-definition'>checkValDef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-202"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-203"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-204"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-205"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-206"></a>
<a name="line-207"></a><span class='hs-definition'>checkValDef</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>grhss</span>
<a name="line-208"></a>        <span class='hs-comment'>-- x :: ty = rhs  parses as a *pattern* binding</span>
<a name="line-209"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkPatBind</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>combineLocs</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>grhss</span>
<a name="line-210"></a>
<a name="line-211"></a><span class='hs-definition'>checkValDef</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>opt_sig</span> <span class='hs-varid'>grhss</span>
<a name="line-212"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_fun</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isFunLhs</span> <span class='hs-varid'>lhs</span>
<a name="line-213"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_fun</span> <span class='hs-keyword'>of</span>
<a name="line-214"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_infix</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkFunBind</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-215"></a>                                                <span class='hs-varid'>fun</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>opt_sig</span> <span class='hs-varid'>grhss</span>
<a name="line-216"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkPatBind</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>grhss</span> <span class='hs-layout'>}</span>
<a name="line-217"></a>
<a name="line-218"></a><a name="checkFunBind"></a><span class='hs-definition'>checkFunBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-219"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-220"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span>
<a name="line-221"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-222"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-223"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-224"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-225"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-226"></a><span class='hs-definition'>checkFunBind</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>lhs_loc</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>opt_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>rhs_span</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span>
<a name="line-227"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkPatterns</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>pats</span>
<a name="line-228"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>match_span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combineSrcSpans</span> <span class='hs-varid'>lhs_loc</span> <span class='hs-varid'>rhs_span</span>
<a name="line-229"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>makeFunBind</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>is_infix</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>match_span</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>opt_sig</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-230"></a>        <span class='hs-comment'>-- The span of the match covers the entire equation.</span>
<a name="line-231"></a>        <span class='hs-comment'>-- That isn't quite right, but it'll do for now.</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="makeFunBind"></a><span class='hs-definition'>makeFunBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LMatch</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBind</span> <span class='hs-varid'>id</span>
<a name="line-234"></a><span class='hs-comment'>-- Like HsUtils.mkFunBind, but we need to be able to set the fixity too</span>
<a name="line-235"></a><span class='hs-definition'>makeFunBind</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>ms</span>
<a name="line-236"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_infix</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMatchGroup</span> <span class='hs-conid'>FromSource</span> <span class='hs-varid'>ms</span><span class='hs-layout'>,</span>
<a name="line-237"></a>              <span class='hs-varid'>fun_co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_tick</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="checkPatBind"></a><span class='hs-definition'>checkPatBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-240"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-241"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-242"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-243"></a><span class='hs-definition'>checkPatBind</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span>
<a name="line-244"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkPattern</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>lhs</span>
<a name="line-245"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>placeHolderNames</span>
<a name="line-246"></a>                    <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="checkValSig"></a><span class='hs-definition'>checkValSig</span>
<a name="line-249"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-250"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-251"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Sig</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-252"></a><span class='hs-definition'>checkValSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnqual</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDataOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-255"></a><span class='hs-definition'>checkValSig</span> <span class='hs-varid'>lhs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-256"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Invalid type signature:"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-257"></a>                       <span class='hs-varid'>ppr</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"::"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-258"></a>                   <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-varid'>hint</span><span class='hs-layout'>)</span>
<a name="line-259"></a>  <span class='hs-keyword'>where</span>
<a name="line-260"></a>    <span class='hs-varid'>hint</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>foreign_RDR</span> <span class='hs-varop'>`looks_like`</span> <span class='hs-varid'>lhs</span>
<a name="line-261"></a>           <span class='hs-keyword'>then</span> <span class='hs-str'>"Perhaps you meant to use ForeignFunctionInterface?"</span>
<a name="line-262"></a>           <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>default_RDR</span> <span class='hs-varop'>`looks_like`</span> <span class='hs-varid'>lhs</span>
<a name="line-263"></a>                <span class='hs-keyword'>then</span> <span class='hs-str'>"Perhaps you meant to use DefaultSignatures?"</span>
<a name="line-264"></a>                <span class='hs-keyword'>else</span> <span class='hs-str'>"Should be of form &lt;variable&gt; :: &lt;type&gt;"</span>
<a name="line-265"></a>    <span class='hs-comment'>-- A common error is to forget the ForeignFunctionInterface flag</span>
<a name="line-266"></a>    <span class='hs-comment'>-- so check for that, and suggest.  cf Trac #3805</span>
<a name="line-267"></a>    <span class='hs-comment'>-- Sadly 'foreign import' still barfs 'parse error' because 'import' is a keyword</span>
<a name="line-268"></a>    <span class='hs-varid'>looks_like</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>s</span>
<a name="line-269"></a>    <span class='hs-varid'>looks_like</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>lhs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>looks_like</span> <span class='hs-varid'>s</span> <span class='hs-varid'>lhs</span>
<a name="line-270"></a>    <span class='hs-varid'>looks_like</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-271"></a>
<a name="line-272"></a>    <span class='hs-varid'>foreign_RDR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnqual</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"foreign"</span><span class='hs-layout'>)</span>
<a name="line-273"></a>    <span class='hs-varid'>default_RDR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnqual</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"default"</span><span class='hs-layout'>)</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="checkDoAndIfThenElse"></a><span class='hs-definition'>checkDoAndIfThenElse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-276"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-277"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-278"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-279"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-280"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-conid'>()</span>
<a name="line-281"></a><span class='hs-definition'>checkDoAndIfThenElse</span> <span class='hs-varid'>guardExpr</span> <span class='hs-varid'>semiThen</span> <span class='hs-varid'>thenExpr</span> <span class='hs-varid'>semiElse</span> <span class='hs-varid'>elseExpr</span>
<a name="line-282"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>semiThen</span> <span class='hs-varop'>||</span> <span class='hs-varid'>semiElse</span>
<a name="line-283"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>pState</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPState</span>
<a name="line-284"></a>         <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_DoAndIfThenElse</span> <span class='hs-layout'>(</span><span class='hs-varid'>dflags</span> <span class='hs-varid'>pState</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-285"></a>             <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>combineLocs</span> <span class='hs-varid'>guardExpr</span> <span class='hs-varid'>elseExpr</span><span class='hs-layout'>)</span>
<a name="line-286"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected semi-colons in conditional:"</span>
<a name="line-287"></a>                          <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-varid'>expr</span>
<a name="line-288"></a>                          <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you meant to use DoAndIfThenElse?"</span><span class='hs-layout'>)</span>
<a name="line-289"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-290"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>pprOptSemi</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>semi</span>
<a name="line-291"></a>          <span class='hs-varid'>pprOptSemi</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-292"></a>          <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"if"</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>guardExpr</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprOptSemi</span> <span class='hs-varid'>semiThen</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-293"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"then"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>thenExpr</span>  <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprOptSemi</span> <span class='hs-varid'>semiElse</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-294"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"else"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>elseExpr</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a>        <span class='hs-comment'>-- The parser left-associates, so there should</span>
<a name="line-2"></a>        <span class='hs-comment'>-- not be any OpApps inside the e's</span>
<a name="line-3"></a><a name="splitBang"></a><span class='hs-definition'>splitBang</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-comment'>-- Splits (f ! g a b) into (f, [(! g), a, b])</span>
<a name="line-5"></a><span class='hs-definition'>splitBang</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>l_arg</span> <span class='hs-varid'>bang</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r_arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bang_RDR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>l_arg</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>bang</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>argns</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span><span class='hs-varid'>argns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split_bang</span> <span class='hs-varid'>r_arg</span> <span class='hs-conid'>[]</span>
<a name="line-9"></a>    <span class='hs-varid'>split_bang</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split_bang</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-conop'>:</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-10"></a>    <span class='hs-varid'>split_bang</span> <span class='hs-varid'>e</span>                 <span class='hs-varid'>es</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-definition'>splitBang</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="isFunLhs"></a><span class='hs-definition'>isFunLhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-14"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-comment'>-- A variable binding is parsed as a FunBind.</span>
<a name="line-16"></a><span class='hs-comment'>-- Just (fun, is_infix, arg_pats) if e is a function LHS</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- The whole LHS is parsed as a single expression.</span>
<a name="line-19"></a><span class='hs-comment'>-- Any infix operators on the LHS will parse left-associatively</span>
<a name="line-20"></a><span class='hs-comment'>-- E.g.         f !x y !z</span>
<a name="line-21"></a><span class='hs-comment'>--      will parse (rather strangely) as</span>
<a name="line-22"></a><span class='hs-comment'>--              (f ! x y) ! z</span>
<a name="line-23"></a><span class='hs-comment'>--      It's up to isFunLhs to sort out the mess</span>
<a name="line-24"></a><span class='hs-comment'>--</span>
<a name="line-25"></a><span class='hs-comment'>-- a .!. !b</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>isFunLhs</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-conid'>[]</span>
<a name="line-28"></a> <span class='hs-keyword'>where</span>
<a name="line-29"></a>   <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>
<a name="line-30"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRdrDataCon</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>   <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-conop'>:</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-32"></a>   <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-varid'>es</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-varid'>es</span>
<a name="line-33"></a>
<a name="line-34"></a>        <span class='hs-comment'>-- For infix function defns, there should be only one infix *function*</span>
<a name="line-35"></a>        <span class='hs-comment'>-- (though there may be infix *datacons* involved too).  So we don't</span>
<a name="line-36"></a>        <span class='hs-comment'>-- need fixity info to figure out which function is being defined.</span>
<a name="line-37"></a>        <span class='hs-comment'>--      a `K1` b `op` c `K2` d</span>
<a name="line-38"></a>        <span class='hs-comment'>-- must parse as</span>
<a name="line-39"></a>        <span class='hs-comment'>--      (a `K1` b) `op` (c `K2` d)</span>
<a name="line-40"></a>        <span class='hs-comment'>-- The renamer checks later that the precedences would yield such a parse.</span>
<a name="line-41"></a>        <span class='hs-comment'>--</span>
<a name="line-42"></a>        <span class='hs-comment'>-- There is a complication to deal with bang patterns.</span>
<a name="line-43"></a>        <span class='hs-comment'>--</span>
<a name="line-44"></a>        <span class='hs-comment'>-- ToDo: what about this?</span>
<a name="line-45"></a>        <span class='hs-comment'>--              x + 1 `op` y = ...</span>
<a name="line-46"></a>
<a name="line-47"></a>   <span class='hs-varid'>go</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>es</span>
<a name="line-48"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>e'</span><span class='hs-layout'>,</span><span class='hs-varid'>es'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitBang</span> <span class='hs-varid'>e</span>
<a name="line-49"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bang_on</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extension</span> <span class='hs-varid'>bangPatEnabled</span>
<a name="line-50"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>bang_on</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>(</span><span class='hs-varid'>es'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-51"></a>               <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-52"></a>                <span class='hs-comment'>-- No bangs; behave just like the next case</span>
<a name="line-53"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRdrDataCon</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- We have found the function!</span>
<a name="line-54"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-comment'>-- Infix data con; keep going</span>
<a name="line-56"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>l</span> <span class='hs-varid'>es</span>
<a name="line-57"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_l</span> <span class='hs-keyword'>of</span>
<a name="line-58"></a>                 <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-conop'>:</span> <span class='hs-varid'>k</span> <span class='hs-conop'>:</span> <span class='hs-varid'>es'</span><span class='hs-layout'>)</span>
<a name="line-59"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-conop'>:</span> <span class='hs-varid'>op_app</span> <span class='hs-conop'>:</span> <span class='hs-varid'>es'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>                    <span class='hs-keyword'>where</span>
<a name="line-61"></a>                      <span class='hs-varid'>op_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-62"></a>                 <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>   <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-64"></a>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-comment'>---------------------------------------------------------------------------</span>
<a name="line-67"></a><span class='hs-comment'>-- Check for monad comprehensions</span>
<a name="line-68"></a><span class='hs-comment'>--</span>
<a name="line-69"></a><span class='hs-comment'>-- If the flag MonadComprehensions is set, return a `MonadComp' context,</span>
<a name="line-70"></a><span class='hs-comment'>-- otherwise use the usual `ListComp' context</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="checkMonadComp"></a><span class='hs-definition'>checkMonadComp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-73"></a><span class='hs-definition'>checkMonadComp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-74"></a>    <span class='hs-varid'>pState</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPState</span>
<a name="line-75"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_MonadComprehensions</span> <span class='hs-layout'>(</span><span class='hs-varid'>dflags</span> <span class='hs-varid'>pState</span><span class='hs-layout'>)</span>
<a name="line-76"></a>                <span class='hs-keyword'>then</span> <span class='hs-conid'>MonadComp</span>
<a name="line-77"></a>                <span class='hs-keyword'>else</span> <span class='hs-conid'>ListComp</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-comment'>-- -------------------------------------------------------------------------</span>
<a name="line-80"></a><span class='hs-comment'>-- Checking arrow syntax.</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-comment'>-- We parse arrow syntax as expressions and check for valid syntax below,</span>
<a name="line-83"></a><span class='hs-comment'>-- converting the expression into a pattern at the same time.</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="checkCommand"></a><span class='hs-definition'>checkCommand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-definition'>checkCommand</span> <span class='hs-varid'>lc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>locMap</span> <span class='hs-varid'>checkCmd</span> <span class='hs-varid'>lc</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="locMap"></a><span class='hs-definition'>locMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-definition'>locMap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>l</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="checkCmd"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmd</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-92"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArrApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>ptt</span> <span class='hs-varid'>haat</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-93"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdArrApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>ptt</span> <span class='hs-varid'>haat</span> <span class='hs-varid'>b</span>
<a name="line-94"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArrForm</span> <span class='hs-varid'>e</span> <span class='hs-varid'>mf</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-95"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>e</span> <span class='hs-varid'>mf</span> <span class='hs-varid'>args</span>
<a name="line-96"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-97"></a>    <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>e1</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>c</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>mg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-99"></a>    <span class='hs-varid'>checkCmdMatchGroup</span> <span class='hs-varid'>mg</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>mg'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>mg'</span><span class='hs-layout'>)</span>
<a name="line-100"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-101"></a>    <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-102"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>mg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-103"></a>    <span class='hs-varid'>checkCmdMatchGroup</span> <span class='hs-varid'>mg</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>mg'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>mg'</span><span class='hs-layout'>)</span>
<a name="line-104"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-varid'>cf</span> <span class='hs-varid'>ep</span> <span class='hs-varid'>et</span> <span class='hs-varid'>ee</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-105"></a>    <span class='hs-varid'>pt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>et</span>
<a name="line-106"></a>    <span class='hs-varid'>pe</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>ee</span>
<a name="line-107"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdIf</span> <span class='hs-varid'>cf</span> <span class='hs-varid'>ep</span> <span class='hs-varid'>pt</span> <span class='hs-varid'>pe</span>
<a name="line-108"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>lb</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-109"></a>    <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdLet</span> <span class='hs-varid'>lb</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>DoExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-111"></a>    <span class='hs-varid'>mapM</span> <span class='hs-varid'>checkCmdLStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdDo</span> <span class='hs-varid'>ss</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a><span class='hs-definition'>checkCmd</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>eLeft</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>eRight</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-114"></a>    <span class='hs-comment'>-- OpApp becomes a HsCmdArrForm with a (Just fixity) in it</span>
<a name="line-115"></a>    <span class='hs-varid'>c1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>eLeft</span>
<a name="line-116"></a>    <span class='hs-varid'>c2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>eRight</span>
<a name="line-117"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>arg1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>[]</span>
<a name="line-118"></a>        <span class='hs-varid'>arg2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>[]</span>
<a name="line-119"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-keyglyph'>]</span>
<a name="line-120"></a>
<a name="line-121"></a><span class='hs-definition'>checkCmd</span> <span class='hs-varid'>l</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmdFail</span> <span class='hs-varid'>l</span> <span class='hs-varid'>e</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="checkCmdLStmt"></a><span class='hs-definition'>checkCmdLStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdLStmt</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-definition'>checkCmdLStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>locMap</span> <span class='hs-varid'>checkCmdStmt</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="checkCmdStmt"></a><span class='hs-definition'>checkCmdStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExprStmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdStmt</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-definition'>checkCmdStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>e</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-128"></a>    <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LastStmt</span> <span class='hs-varid'>c</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-definition'>checkCmdStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>e</span> <span class='hs-varid'>b</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-130"></a>    <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>c</span> <span class='hs-varid'>b</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-definition'>checkCmdStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t</span> <span class='hs-varid'>g</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-132"></a>    <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>c</span> <span class='hs-varid'>t</span> <span class='hs-varid'>g</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-133"></a><span class='hs-definition'>checkCmdStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>bnds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LetStmt</span> <span class='hs-varid'>bnds</span>
<a name="line-134"></a><span class='hs-definition'>checkCmdStmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-135"></a>    <span class='hs-varid'>ss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>checkCmdLStmt</span> <span class='hs-varid'>stmts</span>
<a name="line-136"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>stmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ss</span> <span class='hs-layout'>}</span>
<a name="line-137"></a><span class='hs-definition'>checkCmdStmt</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmdStmtFail</span> <span class='hs-varid'>l</span> <span class='hs-varid'>stmt</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="checkCmdMatchGroup"></a><span class='hs-definition'>checkCmdMatchGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-definition'>checkCmdMatchGroup</span> <span class='hs-varid'>mg</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-141"></a>    <span class='hs-varid'>ms'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>locMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>const</span> <span class='hs-varid'>convert</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span>
<a name="line-142"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mg</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms'</span> <span class='hs-layout'>}</span>
<a name="line-143"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>convert</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>mty</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-144"></a>            <span class='hs-varid'>grhss'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkCmdGRHSs</span> <span class='hs-varid'>grhss</span>
<a name="line-145"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Match</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>mty</span> <span class='hs-varid'>grhss'</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="checkCmdGRHSs"></a><span class='hs-definition'>checkCmdGRHSs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-148"></a><span class='hs-definition'>checkCmdGRHSs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-149"></a>    <span class='hs-varid'>grhss'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>checkCmdGRHS</span> <span class='hs-varid'>grhss</span>
<a name="line-150"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss'</span> <span class='hs-varid'>binds</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="checkCmdGRHS"></a><span class='hs-definition'>checkCmdGRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LGRHS</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>LGRHS</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-153"></a><span class='hs-definition'>checkCmdGRHS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>locMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>const</span> <span class='hs-varid'>convert</span>
<a name="line-154"></a>  <span class='hs-keyword'>where</span> 
<a name="line-155"></a>    <span class='hs-varid'>convert</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-156"></a>        <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkCommand</span> <span class='hs-varid'>e</span>
<a name="line-157"></a><span class='hs-comment'>--        cmdStmts &lt;- mapM checkCmdLStmt stmts</span>
<a name="line-158"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRHS</span> <span class='hs-comment'>{- cmdStmts -}</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>c</span>
<a name="line-159"></a>
<a name="line-160"></a>
<a name="line-161"></a><a name="cmdFail"></a><span class='hs-definition'>cmdFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-varid'>a</span>
<a name="line-162"></a><span class='hs-definition'>cmdFail</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Parse error in command:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-163"></a><a name="cmdStmtFail"></a><span class='hs-definition'>cmdStmtFail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-varid'>a</span>
<a name="line-164"></a><span class='hs-definition'>cmdStmtFail</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> 
<a name="line-165"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Parse error in command statement:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-comment'>---------------------------------------------------------------------------</span>
<a name="line-168"></a><span class='hs-comment'>-- Miscellaneous utilities</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="checkPrecP"></a><span class='hs-definition'>checkPrecP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-conid'>Int</span>
<a name="line-171"></a><span class='hs-definition'>checkPrecP</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-172"></a> <span class='hs-keyglyph'>|</span> <span class='hs-num'>0</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>maxPrecedence</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>i</span>
<a name="line-173"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-174"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Precedence out of range: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="mkRecConstrOrUpdate"></a><span class='hs-definition'>mkRecConstrOrUpdate</span>
<a name="line-177"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-178"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-179"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>HsRecField</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-180"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-181"></a>
<a name="line-182"></a><span class='hs-definition'>mkRecConstrOrUpdate</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span><span class='hs-varid'>dd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrDataCon</span> <span class='hs-varid'>c</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_rec_fields</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-184"></a><span class='hs-definition'>mkRecConstrOrUpdate</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span><span class='hs-layout'>,</span><span class='hs-varid'>dd</span><span class='hs-layout'>)</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Empty record update of:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_rec_fields</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="mk_rec_fields"></a><span class='hs-definition'>mk_rec_fields</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsRecField</span> <span class='hs-varid'>id</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>id</span> <span class='hs-varid'>arg</span>
<a name="line-189"></a><span class='hs-definition'>mk_rec_fields</span> <span class='hs-varid'>fs</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_dotdot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-190"></a><span class='hs-definition'>mk_rec_fields</span> <span class='hs-varid'>fs</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_dotdot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="mkInlinePragma"></a><span class='hs-definition'>mkInlinePragma</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineSpec</span><span class='hs-layout'>,</span> <span class='hs-conid'>RuleMatchInfo</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Activation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InlinePragma</span>
<a name="line-193"></a><span class='hs-comment'>-- The (Maybe Activation) is because the user can omit </span>
<a name="line-194"></a><span class='hs-comment'>-- the activation spec (and usually does)</span>
<a name="line-195"></a><span class='hs-definition'>mkInlinePragma</span> <span class='hs-layout'>(</span><span class='hs-varid'>inl</span><span class='hs-layout'>,</span> <span class='hs-varid'>match_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_act</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InlinePragma</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inl_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl</span>
<a name="line-197"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>inl_sat</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-198"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>inl_act</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span>
<a name="line-199"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>inl_rule</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match_info</span> <span class='hs-layout'>}</span>
<a name="line-200"></a>  <span class='hs-keyword'>where</span>
<a name="line-201"></a>    <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_act</span> <span class='hs-keyword'>of</span>
<a name="line-202"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>act</span>
<a name="line-203"></a>            <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- No phase specified</span>
<a name="line-204"></a>                        <span class='hs-keyword'>case</span> <span class='hs-varid'>inl</span> <span class='hs-keyword'>of</span>
<a name="line-205"></a>                          <span class='hs-conid'>NoInline</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NeverActive</span>
<a name="line-206"></a>                          <span class='hs-sel'>_other</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AlwaysActive</span>
<a name="line-207"></a>
<a name="line-208"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-209"></a><span class='hs-comment'>-- utilities for foreign declarations</span>
<a name="line-210"></a>
<a name="line-211"></a><a name="mkImport"></a><span class='hs-comment'>-- construct a foreign import declaration</span>
<a name="line-212"></a><span class='hs-comment'>--</span>
<a name="line-213"></a><span class='hs-definition'>mkImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCallConv</span>
<a name="line-214"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Safety</span>
<a name="line-215"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>FastString</span><span class='hs-layout'>,</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-216"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-217"></a><span class='hs-definition'>mkImport</span> <span class='hs-varid'>cconv</span> <span class='hs-varid'>safety</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>entity</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cconv</span> <span class='hs-varop'>==</span> <span class='hs-conid'>PrimCallConv</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-219"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>funcTarget</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CFunction</span> <span class='hs-layout'>(</span><span class='hs-conid'>StaticTarget</span> <span class='hs-varid'>entity</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-220"></a>      <span class='hs-varid'>importSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CImport</span> <span class='hs-conid'>PrimCallConv</span> <span class='hs-varid'>safety</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>funcTarget</span>
<a name="line-221"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>noForeignImportCoercionYet</span> <span class='hs-varid'>importSpec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cconv</span> <span class='hs-varop'>==</span> <span class='hs-conid'>JavaScriptCallConv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-223"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>funcTarget</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CFunction</span> <span class='hs-layout'>(</span><span class='hs-conid'>StaticTarget</span> <span class='hs-varid'>entity</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-224"></a>      <span class='hs-varid'>importSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CImport</span> <span class='hs-conid'>JavaScriptCallConv</span> <span class='hs-varid'>safety</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>funcTarget</span>
<a name="line-225"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>noForeignImportCoercionYet</span> <span class='hs-varid'>importSpec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-226"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-227"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>parseCImport</span> <span class='hs-varid'>cconv</span> <span class='hs-varid'>safety</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkExtName</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unpackFS</span> <span class='hs-varid'>entity</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-228"></a>      <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Malformed entity string"</span><span class='hs-layout'>)</span>
<a name="line-229"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>importSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>noForeignImportCoercionYet</span> <span class='hs-varid'>importSpec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="parseCImport"></a><span class='hs-comment'>-- the string "foo" is ambigous: either a header or a C identifier.  The</span>
<a name="line-232"></a><span class='hs-comment'>-- C identifier case comes first in the alternatives below, so we pick</span>
<a name="line-233"></a><span class='hs-comment'>-- that one.</span>
<a name="line-234"></a><span class='hs-definition'>parseCImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCallConv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Safety</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-235"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ForeignImport</span>
<a name="line-236"></a><span class='hs-definition'>parseCImport</span> <span class='hs-varid'>cconv</span> <span class='hs-varid'>safety</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span>
<a name="line-237"></a> <span class='hs-varid'>listToMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span><span class='hs-varop'>.</span><span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-238"></a>     <span class='hs-varid'>readP_to_S</span> <span class='hs-varid'>parse</span> <span class='hs-varid'>str</span>
<a name="line-239"></a> <span class='hs-keyword'>where</span>
<a name="line-240"></a>   <span class='hs-varid'>parse</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-241"></a>       <span class='hs-varid'>skipSpaces</span>
<a name="line-242"></a>       <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>choice</span> <span class='hs-keyglyph'>[</span>
<a name="line-243"></a>          <span class='hs-varid'>string</span> <span class='hs-str'>"dynamic"</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunction</span> <span class='hs-conid'>DynamicTarget</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-244"></a>          <span class='hs-varid'>string</span> <span class='hs-str'>"wrapper"</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>CWrapper</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-245"></a>          <span class='hs-keyword'>do</span> <span class='hs-varid'>optional</span> <span class='hs-layout'>(</span><span class='hs-varid'>token</span> <span class='hs-str'>"static"</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>skipSpaces</span><span class='hs-layout'>)</span>
<a name="line-246"></a>             <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mk</span> <span class='hs-conid'>Nothing</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>cimp</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varop'>+++</span>
<a name="line-247"></a>              <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>munch1</span> <span class='hs-varid'>hdr_char</span>
<a name="line-248"></a>                  <span class='hs-varid'>skipSpaces</span>
<a name="line-249"></a>                  <span class='hs-varid'>mk</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Header</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>cimp</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-250"></a>         <span class='hs-keyglyph'>]</span>
<a name="line-251"></a>       <span class='hs-varid'>skipSpaces</span>
<a name="line-252"></a>       <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-253"></a>
<a name="line-254"></a>   <span class='hs-varid'>token</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>string</span> <span class='hs-varid'>str</span>
<a name="line-255"></a>                  <span class='hs-varid'>toks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>look</span>
<a name="line-256"></a>                  <span class='hs-keyword'>case</span> <span class='hs-varid'>toks</span> <span class='hs-keyword'>of</span>
<a name="line-257"></a>                      <span class='hs-varid'>c</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span>
<a name="line-258"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id_char</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pfail</span>
<a name="line-259"></a>                      <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-260"></a>
<a name="line-261"></a>   <span class='hs-varid'>mk</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CImport</span> <span class='hs-varid'>cconv</span> <span class='hs-varid'>safety</span>
<a name="line-262"></a>
<a name="line-263"></a>   <span class='hs-varid'>hdr_char</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSpace</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- header files are filenames, which can contain</span>
<a name="line-264"></a>                                <span class='hs-comment'>-- pretty much any char (depending on the platform),</span>
<a name="line-265"></a>                                <span class='hs-comment'>-- so just accept any non-space character</span>
<a name="line-266"></a>   <span class='hs-varid'>id_first_char</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isAlpha</span>    <span class='hs-varid'>c</span> <span class='hs-varop'>||</span> <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'_'</span>
<a name="line-267"></a>   <span class='hs-varid'>id_char</span>       <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isAlphaNum</span> <span class='hs-varid'>c</span> <span class='hs-varop'>||</span> <span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-chr'>'_'</span>
<a name="line-268"></a>
<a name="line-269"></a>   <span class='hs-varid'>cimp</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReadP</span><span class='hs-varop'>.</span><span class='hs-varid'>char</span> <span class='hs-chr'>'&amp;'</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>skipSpaces</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-conid'>CLabel</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>cid</span><span class='hs-layout'>)</span>
<a name="line-270"></a>             <span class='hs-varop'>+++</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>isFun</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cconv</span> <span class='hs-keyword'>of</span>
<a name="line-271"></a>                              <span class='hs-conid'>CApiConv</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-272"></a>                                  <span class='hs-varid'>option</span> <span class='hs-conid'>True</span>
<a name="line-273"></a>                                         <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>token</span> <span class='hs-str'>"value"</span>
<a name="line-274"></a>                                             <span class='hs-varid'>skipSpaces</span>
<a name="line-275"></a>                                             <span class='hs-varid'>return</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-276"></a>                              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-277"></a>                     <span class='hs-varid'>cid'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cid</span>
<a name="line-278"></a>                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunction</span> <span class='hs-layout'>(</span><span class='hs-conid'>StaticTarget</span> <span class='hs-varid'>cid'</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>isFun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-279"></a>          <span class='hs-keyword'>where</span>
<a name="line-280"></a>            <span class='hs-varid'>cid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>+++</span>
<a name="line-281"></a>                  <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>c</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>satisfy</span> <span class='hs-varid'>id_first_char</span>
<a name="line-282"></a>                      <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>&lt;-</span>  <span class='hs-varid'>many</span> <span class='hs-layout'>(</span><span class='hs-varid'>satisfy</span> <span class='hs-varid'>id_char</span><span class='hs-layout'>)</span>
<a name="line-283"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-284"></a>
<a name="line-285"></a>
<a name="line-286"></a><a name="mkExport"></a><span class='hs-comment'>-- construct a foreign export declaration</span>
<a name="line-287"></a><span class='hs-comment'>--</span>
<a name="line-288"></a><span class='hs-definition'>mkExport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCallConv</span>
<a name="line-289"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>FastString</span><span class='hs-layout'>,</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-290"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-291"></a><span class='hs-definition'>mkExport</span> <span class='hs-varid'>cconv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>entity</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-292"></a>  <span class='hs-conid'>ForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignExport</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>noForeignExportCoercionYet</span> <span class='hs-layout'>(</span><span class='hs-conid'>CExport</span> <span class='hs-layout'>(</span><span class='hs-conid'>CExportStatic</span> <span class='hs-varid'>entity'</span> <span class='hs-varid'>cconv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-293"></a>  <span class='hs-keyword'>where</span>
<a name="line-294"></a>    <span class='hs-varid'>entity'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nullFS</span> <span class='hs-varid'>entity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExtName</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-295"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entity</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="mkExtName"></a><span class='hs-comment'>-- Supplying the ext_name in a foreign decl is optional; if it</span>
<a name="line-298"></a><span class='hs-comment'>-- isn't there, the Haskell name is assumed. Note that no transformation</span>
<a name="line-299"></a><span class='hs-comment'>-- of the Haskell name is then performed, so if you foreign export (++),</span>
<a name="line-300"></a><span class='hs-comment'>-- it's external name will be "++". Too bad; it's important because we don't</span>
<a name="line-301"></a><span class='hs-comment'>-- want z-encoding (e.g. names with z's in them shouldn't be doubled)</span>
<a name="line-302"></a><span class='hs-comment'>--</span>
<a name="line-303"></a><span class='hs-definition'>mkExtName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CLabelString</span>
<a name="line-304"></a><span class='hs-definition'>mkExtName</span> <span class='hs-varid'>rdrNm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rdrNm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

--------------------------------------------------------------------------------
-- Help with module system imports/exports

\begin{code}
<pre><a name="line-1"></a><a name="ImpExpSubSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImpExpSubSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpExpAbs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImpExpAll</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImpExpList</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>]</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="mkModuleImpExp"></a><span class='hs-definition'>mkModuleImpExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImpExpSubSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IE</span> <span class='hs-conid'>RdrName</span>
<a name="line-4"></a><span class='hs-definition'>mkModuleImpExp</span> <span class='hs-varid'>name</span> <span class='hs-varid'>subs</span> <span class='hs-keyglyph'>=</span>
<a name="line-5"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>subs</span> <span class='hs-keyword'>of</span>
<a name="line-6"></a>    <span class='hs-conid'>ImpExpAbs</span> 
<a name="line-7"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVarNameSpace</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameSpace</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IEVar</span>       <span class='hs-varid'>name</span>
<a name="line-8"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IEThingAbs</span>  <span class='hs-varid'>nameT</span>
<a name="line-9"></a>    <span class='hs-conid'>ImpExpAll</span>                              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IEThingAll</span>  <span class='hs-varid'>nameT</span>
<a name="line-10"></a>    <span class='hs-conid'>ImpExpList</span> <span class='hs-varid'>xs</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IEThingWith</span> <span class='hs-varid'>nameT</span> <span class='hs-varid'>xs</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>nameT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setRdrNameSpace</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tcClsName</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="mkTypeImpExp"></a><span class='hs-definition'>mkTypeImpExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-definition'>mkTypeImpExp</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<a name="line-17"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>allowed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extension</span> <span class='hs-varid'>explicitNamespacesEnabled</span>
<a name="line-18"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>allowed</span>
<a name="line-19"></a>       <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varop'>`setRdrNameSpace`</span> <span class='hs-varid'>tcClsName</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-20"></a>       <span class='hs-keyword'>else</span> <span class='hs-varid'>parseErrorSDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-21"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal keyword 'type' (use ExplicitNamespaces to enable)"</span><span class='hs-layout'>)</span>
</pre>\end{code}

-----------------------------------------------------------------------------
-- Misc utils

\begin{code}
<pre><a name="line-1"></a><a name="parseErrorSDoc"></a><span class='hs-definition'>parseErrorSDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>P</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>parseErrorSDoc</span> <span class='hs-varid'>span</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failSpanMsgP</span> <span class='hs-varid'>span</span> <span class='hs-varid'>s</span>
</pre>\end{code}
</body>
</html>
