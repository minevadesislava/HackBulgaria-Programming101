<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>iface/MkIface.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006-2008
% (c) The GRASP/AQUA Project, Glasgow University, 1993-1998
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- | Module for constructing @ModIface@ values (interface files),</span>
<a name="line-2"></a><span class='hs-comment'>-- writing them to disk and comparing two versions to see if</span>
<a name="line-3"></a><span class='hs-comment'>-- recompilation is required.</span>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>MkIface</span> <span class='hs-layout'>(</span>
<a name="line-5"></a>        <span class='hs-varid'>mkUsedNames</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>mkDependencies</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-varid'>mkIface</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Build a ModIface from a ModGuts,</span>
<a name="line-8"></a>                        <span class='hs-comment'>-- including computing version information</span>
<a name="line-9"></a>
<a name="line-10"></a>        <span class='hs-varid'>mkIfaceTc</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-varid'>writeIfaceFile</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Write the interface file</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-varid'>checkOldIface</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- See if recompilation is required, by</span>
<a name="line-15"></a>                        <span class='hs-comment'>-- comparing version information</span>
<a name="line-16"></a>        <span class='hs-conid'>RecompileRequired</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>recompileRequired</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-varid'>tyThingToIfaceDecl</span> <span class='hs-comment'>-- Converting things to their Iface equivalents</span>
<a name="line-19"></a> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
</pre>\end{code}

  -----------------------------------------------
          Recompilation checking
  -----------------------------------------------

A complete description of how recompilation checking works can be
found in the wiki commentary:

 http://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/RecompilationAvoidance

Please read the above page for a top-down description of how this all
works.  Notes below cover specific issues related to the implementation.

Basic idea:

  * In the mi_usages information in an interface, we record the
    fingerprint of each free variable of the module

  * In mkIface, we compute the fingerprint of each exported thing A.f.
    For each external thing that A.f refers to, we include the fingerprint
    of the external reference when computing the fingerprint of A.f.  So
    if anything that A.f depends on changes, then A.f's fingerprint will
    change.
    Also record any dependent files added with
      * addDependentFile
      * #include
      * -optP-include

  * In checkOldIface we compare the mi_usages for the module with
    the actual fingerprint for all each thing recorded in mi_usages

\begin{code}
<pre><a name="line-1"></a><span class='hs-cpp'>#</span><span class='hs-varid'>include</span> <span class='hs-str'>"HsVersions.h"</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IfaceSyn</span>
<a name="line-4"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>LoadIface</span>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FlagChecker</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span> <span class='hs-varid'>tidyCo</span> <span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Finder</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BinIface</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>SuccessFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>             <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>eqListBy</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Binary</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Exception</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>
</pre>\end{code}



%************************************************************************
%*                                                                      *
\subsection{Completing an interface}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkIface"></a><span class='hs-definition'>mkIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span>    <span class='hs-comment'>-- The old fingerprint, if we have it</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModDetails</span>           <span class='hs-comment'>-- The trimmed, tidied interface</span>
<a name="line-4"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span>              <span class='hs-comment'>-- Usages, deprecations, etc</span>
<a name="line-5"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span>
<a name="line-6"></a>               <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The new one</span>
<a name="line-7"></a>                      <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- True &lt;=&gt; there was an old Iface, and the</span>
<a name="line-8"></a>                                <span class='hs-comment'>--          new one is identical, so no need</span>
<a name="line-9"></a>                                <span class='hs-comment'>--          to write it</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>mkIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>maybe_old_fingerprint</span> <span class='hs-varid'>mod_details</span>
<a name="line-12"></a>         <span class='hs-conid'>ModGuts</span><span class='hs-layout'>{</span>     <span class='hs-varid'>mg_module</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                      <span class='hs-varid'>mg_boot</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                      <span class='hs-varid'>mg_used_names</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_names</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                      <span class='hs-varid'>mg_used_th</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_th</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                      <span class='hs-varid'>mg_deps</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span><span class='hs-layout'>,</span>
<a name="line-17"></a>                      <span class='hs-varid'>mg_dir_imps</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir_imp_mods</span><span class='hs-layout'>,</span>
<a name="line-18"></a>                      <span class='hs-varid'>mg_rdr_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span>
<a name="line-19"></a>                      <span class='hs-varid'>mg_fix_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>,</span>
<a name="line-20"></a>                      <span class='hs-varid'>mg_warns</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warns</span><span class='hs-layout'>,</span>
<a name="line-21"></a>                      <span class='hs-varid'>mg_hpc_info</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpc_info</span><span class='hs-layout'>,</span>
<a name="line-22"></a>                      <span class='hs-varid'>mg_safe_haskell</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safe_mode</span><span class='hs-layout'>,</span>
<a name="line-23"></a>                      <span class='hs-varid'>mg_trust_pkg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>self_trust</span><span class='hs-layout'>,</span>
<a name="line-24"></a>                      <span class='hs-varid'>mg_dependent_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dependent_files</span>
<a name="line-25"></a>                    <span class='hs-layout'>}</span>
<a name="line-26"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIface_</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>maybe_old_fingerprint</span>
<a name="line-27"></a>                   <span class='hs-varid'>this_mod</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>used_names</span> <span class='hs-varid'>used_th</span> <span class='hs-varid'>deps</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>fix_env</span>
<a name="line-28"></a>                   <span class='hs-varid'>warns</span> <span class='hs-varid'>hpc_info</span> <span class='hs-varid'>dir_imp_mods</span> <span class='hs-varid'>self_trust</span> <span class='hs-varid'>dependent_files</span>
<a name="line-29"></a>                   <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>mod_details</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="mkIfaceTc"></a><span class='hs-comment'>-- | make an interface from the results of typechecking only.  Useful</span>
<a name="line-32"></a><span class='hs-comment'>-- for non-optimising compilation, or where we aren't generating any</span>
<a name="line-33"></a><span class='hs-comment'>-- object code at all ('HscNothing').</span>
<a name="line-34"></a><span class='hs-definition'>mkIfaceTc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-35"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span>  <span class='hs-comment'>-- The old fingerprint, if we have it</span>
<a name="line-36"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SafeHaskellMode</span>    <span class='hs-comment'>-- The safe haskell mode</span>
<a name="line-37"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModDetails</span>         <span class='hs-comment'>-- gotten from mkBootModDetails, probably</span>
<a name="line-38"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span>           <span class='hs-comment'>-- Usages, deprecations, etc</span>
<a name="line-39"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-definition'>mkIfaceTc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>maybe_old_fingerprint</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>mod_details</span>
<a name="line-41"></a>  <span class='hs-varid'>tc_result</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>{</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-42"></a>                      <span class='hs-varid'>tcg_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_src</span><span class='hs-layout'>,</span>
<a name="line-43"></a>                      <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imports</span><span class='hs-layout'>,</span>
<a name="line-44"></a>                      <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span>
<a name="line-45"></a>                      <span class='hs-varid'>tcg_fix_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>,</span>
<a name="line-46"></a>                      <span class='hs-varid'>tcg_warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warns</span><span class='hs-layout'>,</span>
<a name="line-47"></a>                      <span class='hs-varid'>tcg_hpc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_hpc_info</span><span class='hs-layout'>,</span>
<a name="line-48"></a>                      <span class='hs-varid'>tcg_th_splice_used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_splice_used</span><span class='hs-layout'>,</span>
<a name="line-49"></a>                      <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dependent_files</span>
<a name="line-50"></a>                    <span class='hs-layout'>}</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-52"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>used_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUsedNames</span> <span class='hs-varid'>tc_result</span>
<a name="line-53"></a>          <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkDependencies</span> <span class='hs-varid'>tc_result</span>
<a name="line-54"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>hpc_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyHpcInfo</span> <span class='hs-varid'>other_hpc_info</span>
<a name="line-55"></a>          <span class='hs-varid'>used_th</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>tc_splice_used</span>
<a name="line-56"></a>          <span class='hs-varid'>dep_files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>readIORef</span> <span class='hs-varid'>dependent_files</span><span class='hs-layout'>)</span>
<a name="line-57"></a>          <span class='hs-varid'>mkIface_</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>maybe_old_fingerprint</span>
<a name="line-58"></a>                   <span class='hs-varid'>this_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>isHsBoot</span> <span class='hs-varid'>hsc_src</span><span class='hs-layout'>)</span> <span class='hs-varid'>used_names</span> <span class='hs-varid'>used_th</span> <span class='hs-varid'>deps</span> <span class='hs-varid'>rdr_env</span>
<a name="line-59"></a>                   <span class='hs-varid'>fix_env</span> <span class='hs-varid'>warns</span> <span class='hs-varid'>hpc_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_mods</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span>
<a name="line-60"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span> <span class='hs-varid'>dep_files</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>mod_details</span>
<a name="line-61"></a>
<a name="line-62"></a>
<a name="line-63"></a><a name="mkUsedNames"></a><span class='hs-definition'>mkUsedNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-64"></a><span class='hs-definition'>mkUsedNames</span> <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>{</span> <span class='hs-varid'>tcg_dus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dus</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allUses</span> <span class='hs-varid'>dus</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="mkDependencies"></a><span class='hs-comment'>-- | Extract information from the rename and typecheck phases to produce</span>
<a name="line-67"></a><span class='hs-comment'>-- a dependencies information for the module being compiled.</span>
<a name="line-68"></a><span class='hs-definition'>mkDependencies</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Dependencies</span>
<a name="line-69"></a><span class='hs-definition'>mkDependencies</span>
<a name="line-70"></a>          <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>{</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span>
<a name="line-71"></a>                    <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imports</span><span class='hs-layout'>,</span>
<a name="line-72"></a>                    <span class='hs-varid'>tcg_th_used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>th_var</span>
<a name="line-73"></a>                  <span class='hs-layout'>}</span>
<a name="line-74"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-75"></a>      <span class='hs-comment'>-- Template Haskell used?</span>
<a name="line-76"></a>      <span class='hs-varid'>th_used</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>th_var</span>
<a name="line-77"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eltsUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_dep_mods</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-78"></a>                <span class='hs-comment'>-- M.hi-boot can be in the imp_dep_mods, but we must remove</span>
<a name="line-79"></a>                <span class='hs-comment'>-- it before recording the modules on which this one depends!</span>
<a name="line-80"></a>                <span class='hs-comment'>-- (We want to retain M.hi-boot in imp_dep_mods so that</span>
<a name="line-81"></a>                <span class='hs-comment'>--  loadHiBootInterface can see if M's direct imports depend</span>
<a name="line-82"></a>                <span class='hs-comment'>--  on M.hi-boot, and hence that we should do the hi-boot consistency</span>
<a name="line-83"></a>                <span class='hs-comment'>--  check.)</span>
<a name="line-84"></a>
<a name="line-85"></a>          <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>th_used</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertList</span> <span class='hs-varid'>thPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span>
<a name="line-86"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-varid'>imports</span>
<a name="line-87"></a>
<a name="line-88"></a>          <span class='hs-comment'>-- Set the packages required to be Safe according to Safe Haskell.</span>
<a name="line-89"></a>          <span class='hs-comment'>-- See Note [RnNames . Tracking Trust Transitively]</span>
<a name="line-90"></a>          <span class='hs-varid'>sorted_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stablePackageIdCmp</span> <span class='hs-varid'>pkgs</span>
<a name="line-91"></a>          <span class='hs-varid'>trust_pkgs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-varid'>imports</span>
<a name="line-92"></a>          <span class='hs-varid'>dep_pkgs'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>trust_pkgs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>sorted_pkgs</span>
<a name="line-93"></a>
<a name="line-94"></a>      <span class='hs-varid'>return</span> <span class='hs-conid'>Deps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dep_mods</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>stableModuleNameCmp</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>dep_mods</span><span class='hs-layout'>,</span>
<a name="line-95"></a>                    <span class='hs-varid'>dep_pkgs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_pkgs'</span><span class='hs-layout'>,</span>
<a name="line-96"></a>                    <span class='hs-varid'>dep_orphs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableModuleCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_orphs</span>  <span class='hs-varid'>imports</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-97"></a>                    <span class='hs-varid'>dep_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableModuleCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_finsts</span> <span class='hs-varid'>imports</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>                    <span class='hs-comment'>-- sort to get into canonical order</span>
<a name="line-99"></a>                    <span class='hs-comment'>-- NB. remember to use lexicographic ordering</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="mkIface_"></a><span class='hs-definition'>mkIface_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsBootInterface</span>
<a name="line-102"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Dependencies</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-103"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>FixItem</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Warnings</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HpcInfo</span>
<a name="line-104"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportedMods</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-105"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-106"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SafeHaskellMode</span>
<a name="line-107"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModDetails</span>
<a name="line-108"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-109"></a><span class='hs-definition'>mkIface_</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>maybe_old_fingerprint</span>
<a name="line-110"></a>         <span class='hs-varid'>this_mod</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>used_names</span> <span class='hs-varid'>used_th</span> <span class='hs-varid'>deps</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>src_warns</span>
<a name="line-111"></a>         <span class='hs-varid'>hpc_info</span> <span class='hs-varid'>dir_imp_mods</span> <span class='hs-varid'>pkg_trust_req</span> <span class='hs-varid'>dependent_files</span> <span class='hs-varid'>safe_mode</span>
<a name="line-112"></a>         <span class='hs-conid'>ModDetails</span><span class='hs-layout'>{</span>  <span class='hs-varid'>md_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span><span class='hs-layout'>,</span>
<a name="line-113"></a>                      <span class='hs-varid'>md_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span><span class='hs-layout'>,</span>
<a name="line-114"></a>                      <span class='hs-varid'>md_rules</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rules</span><span class='hs-layout'>,</span>
<a name="line-115"></a>                      <span class='hs-varid'>md_anns</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anns</span><span class='hs-layout'>,</span>
<a name="line-116"></a>                      <span class='hs-varid'>md_vect_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vect_info</span><span class='hs-layout'>,</span>
<a name="line-117"></a>                      <span class='hs-varid'>md_types</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>type_env</span><span class='hs-layout'>,</span>
<a name="line-118"></a>                      <span class='hs-varid'>md_exports</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span> <span class='hs-layout'>}</span>
<a name="line-119"></a><span class='hs-comment'>-- NB:  notice that mkIface does not look at the bindings</span>
<a name="line-120"></a><span class='hs-comment'>--      only at the TypeEnv.  The previous Tidy phase has</span>
<a name="line-121"></a><span class='hs-comment'>--      put exactly the info into the TypeEnv that we want</span>
<a name="line-122"></a><span class='hs-comment'>--      to expose in the interface</span>
<a name="line-123"></a>
<a name="line-124"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-125"></a>    <span class='hs-varid'>usages</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkUsageInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>dir_imp_mods</span> <span class='hs-varid'>used_names</span> <span class='hs-varid'>dependent_files</span>
<a name="line-126"></a>
<a name="line-127"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>entities</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeEnvElts</span> <span class='hs-varid'>type_env</span>
<a name="line-128"></a>        <span class='hs-varid'>decls</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tyThingToIfaceDecl</span> <span class='hs-varid'>entity</span>
<a name="line-129"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>entity</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>entities</span><span class='hs-layout'>,</span>
<a name="line-130"></a>                   <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>entity</span><span class='hs-layout'>,</span>
<a name="line-131"></a>                   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isImplicitTyThing</span> <span class='hs-varid'>entity</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-132"></a>                      <span class='hs-comment'>-- No implicit Ids and class tycons in the interface file</span>
<a name="line-133"></a>                   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-134"></a>                      <span class='hs-comment'>-- Nor wired-in things; the compiler knows about them anyhow</span>
<a name="line-135"></a>                   <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>name</span>  <span class='hs-keyglyph'>]</span>
<a name="line-136"></a>                      <span class='hs-comment'>-- Sigh: see Note [Root-main Id] in TcRnDriver</span>
<a name="line-137"></a>
<a name="line-138"></a>        <span class='hs-varid'>fixities</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>occ</span><span class='hs-layout'>,</span><span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FixItem</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-varid'>fix_env</span><span class='hs-keyglyph'>]</span>
<a name="line-139"></a>        <span class='hs-varid'>warns</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src_warns</span>
<a name="line-140"></a>        <span class='hs-varid'>iface_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreRuleToIfaceRule</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>rules</span>
<a name="line-141"></a>        <span class='hs-varid'>iface_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>instanceToIfaceInst</span> <span class='hs-varid'>insts</span>
<a name="line-142"></a>        <span class='hs-varid'>iface_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>famInstToIfaceFamInst</span> <span class='hs-varid'>fam_insts</span>
<a name="line-143"></a>        <span class='hs-varid'>iface_vect_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flattenVectInfo</span> <span class='hs-varid'>vect_info</span>
<a name="line-144"></a>        <span class='hs-varid'>trust_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSafeMode</span> <span class='hs-varid'>safe_mode</span>
<a name="line-145"></a>        <span class='hs-varid'>annotations</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkIfaceAnnotation</span> <span class='hs-varid'>anns</span>
<a name="line-146"></a>
<a name="line-147"></a>        <span class='hs-varid'>intermediate_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModIface</span> <span class='hs-layout'>{</span>
<a name="line-148"></a>              <span class='hs-varid'>mi_module</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-149"></a>              <span class='hs-varid'>mi_boot</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>,</span>
<a name="line-150"></a>              <span class='hs-varid'>mi_deps</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deps</span><span class='hs-layout'>,</span>
<a name="line-151"></a>              <span class='hs-varid'>mi_usages</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usages</span><span class='hs-layout'>,</span>
<a name="line-152"></a>              <span class='hs-varid'>mi_exports</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIfaceExports</span> <span class='hs-varid'>exports</span><span class='hs-layout'>,</span>
<a name="line-153"></a>
<a name="line-154"></a>              <span class='hs-comment'>-- Sort these lexicographically, so that</span>
<a name="line-155"></a>              <span class='hs-comment'>-- the result is stable across compilations</span>
<a name="line-156"></a>              <span class='hs-varid'>mi_insts</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_inst</span>     <span class='hs-varid'>iface_insts</span><span class='hs-layout'>,</span>
<a name="line-157"></a>              <span class='hs-varid'>mi_fam_insts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_fam_inst</span> <span class='hs-varid'>iface_fam_insts</span><span class='hs-layout'>,</span>
<a name="line-158"></a>              <span class='hs-varid'>mi_rules</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_rule</span>     <span class='hs-varid'>iface_rules</span><span class='hs-layout'>,</span>
<a name="line-159"></a>
<a name="line-160"></a>              <span class='hs-varid'>mi_vect_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iface_vect_info</span><span class='hs-layout'>,</span>
<a name="line-161"></a>
<a name="line-162"></a>              <span class='hs-varid'>mi_fixities</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixities</span><span class='hs-layout'>,</span>
<a name="line-163"></a>              <span class='hs-varid'>mi_warns</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warns</span><span class='hs-layout'>,</span>
<a name="line-164"></a>              <span class='hs-varid'>mi_anns</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotations</span><span class='hs-layout'>,</span>
<a name="line-165"></a>              <span class='hs-varid'>mi_globals</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeGlobalRdrEnv</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span>
<a name="line-166"></a>
<a name="line-167"></a>              <span class='hs-comment'>-- Left out deliberately: filled in by addFingerprints</span>
<a name="line-168"></a>              <span class='hs-varid'>mi_iface_hash</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fingerprint0</span><span class='hs-layout'>,</span>
<a name="line-169"></a>              <span class='hs-varid'>mi_mod_hash</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fingerprint0</span><span class='hs-layout'>,</span>
<a name="line-170"></a>              <span class='hs-varid'>mi_flag_hash</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fingerprint0</span><span class='hs-layout'>,</span>
<a name="line-171"></a>              <span class='hs-varid'>mi_exp_hash</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fingerprint0</span><span class='hs-layout'>,</span>
<a name="line-172"></a>              <span class='hs-varid'>mi_used_th</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_th</span><span class='hs-layout'>,</span>
<a name="line-173"></a>              <span class='hs-varid'>mi_orphan_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fingerprint0</span><span class='hs-layout'>,</span>
<a name="line-174"></a>              <span class='hs-varid'>mi_orphan</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Always set by addFingerprints, but</span>
<a name="line-175"></a>                                      <span class='hs-comment'>-- it's a strict field, so we can't omit it.</span>
<a name="line-176"></a>              <span class='hs-varid'>mi_finsts</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Ditto</span>
<a name="line-177"></a>              <span class='hs-varid'>mi_decls</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deliberatelyOmitted</span> <span class='hs-str'>"decls"</span><span class='hs-layout'>,</span>
<a name="line-178"></a>              <span class='hs-varid'>mi_hash_fn</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deliberatelyOmitted</span> <span class='hs-str'>"hash_fn"</span><span class='hs-layout'>,</span>
<a name="line-179"></a>              <span class='hs-varid'>mi_hpc</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isHpcUsed</span> <span class='hs-varid'>hpc_info</span><span class='hs-layout'>,</span>
<a name="line-180"></a>              <span class='hs-varid'>mi_trust</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trust_info</span><span class='hs-layout'>,</span>
<a name="line-181"></a>              <span class='hs-varid'>mi_trust_pkg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkg_trust_req</span><span class='hs-layout'>,</span>
<a name="line-182"></a>
<a name="line-183"></a>              <span class='hs-comment'>-- And build the cached values</span>
<a name="line-184"></a>              <span class='hs-varid'>mi_warn_fn</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIfaceWarnCache</span> <span class='hs-varid'>warns</span><span class='hs-layout'>,</span>
<a name="line-185"></a>              <span class='hs-varid'>mi_fix_fn</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIfaceFixCache</span> <span class='hs-varid'>fixities</span> <span class='hs-layout'>}</span>
<a name="line-186"></a>
<a name="line-187"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_change_at_all</span><span class='hs-layout'>)</span>
<a name="line-188"></a>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "versioninfo" #-}</span>
<a name="line-189"></a>                   <span class='hs-varid'>addFingerprints</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>maybe_old_fingerprint</span>
<a name="line-190"></a>                                   <span class='hs-varid'>intermediate_iface</span> <span class='hs-varid'>decls</span>
<a name="line-191"></a>
<a name="line-192"></a>    <span class='hs-comment'>-- Warn about orphans</span>
<a name="line-193"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>warn_orphs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnOrphans</span> <span class='hs-varid'>dflags</span>
<a name="line-194"></a>        <span class='hs-varid'>warn_auto_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnAutoOrphans</span> <span class='hs-varid'>dflags</span>
<a name="line-195"></a>        <span class='hs-varid'>orph_warnings</span>   <span class='hs-comment'>--- Laziness means no work done unless -fwarn-orphans</span>
<a name="line-196"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>warn_orphs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>warn_auto_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule_warns</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>inst_warns</span>
<a name="line-197"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-198"></a>        <span class='hs-varid'>errs_and_warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>orph_warnings</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>)</span>
<a name="line-199"></a>        <span class='hs-varid'>unqual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrintUnqualified</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rdr_env</span>
<a name="line-200"></a>        <span class='hs-varid'>inst_warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>instOrphWarn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unqual</span> <span class='hs-varid'>d</span>
<a name="line-201"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>insts</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>iface_insts</span>
<a name="line-202"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifInstOrph</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-203"></a>        <span class='hs-varid'>rule_warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ruleOrphWarn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unqual</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>r</span>
<a name="line-204"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>iface_rules</span>
<a name="line-205"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifRuleOrph</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-206"></a>                               <span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ifRuleAuto</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>warn_auto_orphs</span>
<a name="line-207"></a>                                                 <span class='hs-keyword'>else</span> <span class='hs-varid'>warn_orphs</span> <span class='hs-keyglyph'>]</span>
<a name="line-208"></a>
<a name="line-209"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>errorsFound</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>errs_and_warns</span>
<a name="line-210"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>errs_and_warns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>)</span>
<a name="line-211"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-212"></a>        <span class='hs-comment'>-- Debug printing</span>
<a name="line-213"></a>        <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_hi</span> <span class='hs-str'>"FINAL INTERFACE"</span>
<a name="line-214"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>pprModIface</span> <span class='hs-varid'>new_iface</span><span class='hs-layout'>)</span>
<a name="line-215"></a>
<a name="line-216"></a>        <span class='hs-comment'>-- bug #1617: on reload we weren't updating the PrintUnqualified</span>
<a name="line-217"></a>        <span class='hs-comment'>-- correctly.  This stems from the fact that the interface had</span>
<a name="line-218"></a>        <span class='hs-comment'>-- not changed, so addFingerprints returns the old ModIface</span>
<a name="line-219"></a>        <span class='hs-comment'>-- with the old GlobalRdrEnv (mi_globals).</span>
<a name="line-220"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>final_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_iface</span><span class='hs-layout'>{</span> <span class='hs-varid'>mi_globals</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeGlobalRdrEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-layout'>}</span>
<a name="line-221"></a>
<a name="line-222"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>errs_and_warns</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_change_at_all</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-223"></a>  <span class='hs-keyword'>where</span>
<a name="line-224"></a>     <span class='hs-varid'>cmp_rule</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>comparing</span> <span class='hs-varid'>ifRuleName</span>
<a name="line-225"></a>     <span class='hs-comment'>-- Compare these lexicographically by OccName, *not* by unique,</span>
<a name="line-226"></a>     <span class='hs-comment'>-- because the latter is not stable across compilations:</span>
<a name="line-227"></a>     <span class='hs-varid'>cmp_inst</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>comparing</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ifDFun</span><span class='hs-layout'>)</span>
<a name="line-228"></a>     <span class='hs-varid'>cmp_fam_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>comparing</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ifFamInstTcName</span><span class='hs-layout'>)</span>
<a name="line-229"></a>
<a name="line-230"></a>     <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-231"></a>
<a name="line-232"></a>     <span class='hs-comment'>-- We only fill in mi_globals if the module was compiled to byte</span>
<a name="line-233"></a>     <span class='hs-comment'>-- code.  Otherwise, the compiler may not have retained all the</span>
<a name="line-234"></a>     <span class='hs-comment'>-- top-level bindings and they won't be in the TypeEnv (see</span>
<a name="line-235"></a>     <span class='hs-comment'>-- Desugar.addExportFlagsAndRules).  The mi_globals field is used</span>
<a name="line-236"></a>     <span class='hs-comment'>-- by GHCi to decide whether the module has its full top-level</span>
<a name="line-237"></a>     <span class='hs-comment'>-- scope available. (#5534)</span>
<a name="line-238"></a>     <span class='hs-varid'>maybeGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-239"></a>     <span class='hs-varid'>maybeGlobalRdrEnv</span> <span class='hs-varid'>rdr_env</span>
<a name="line-240"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>targetRetainsAllBindings</span> <span class='hs-layout'>(</span><span class='hs-varid'>hscTarget</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rdr_env</span>
<a name="line-241"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-242"></a>
<a name="line-243"></a>     <span class='hs-varid'>deliberatelyOmitted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-244"></a>     <span class='hs-varid'>deliberatelyOmitted</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"Deliberately omitted: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-245"></a>
<a name="line-246"></a>     <span class='hs-varid'>ifFamInstTcName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifFamInstFam</span>
<a name="line-247"></a>
<a name="line-248"></a>     <span class='hs-varid'>flattenVectInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>VectInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>vectInfoVar</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vVar</span>
<a name="line-249"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>vectInfoTyCon</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vTyCon</span>
<a name="line-250"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>vectInfoParallelVars</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vParallelVars</span>
<a name="line-251"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>vectInfoParallelTyCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vParallelTyCons</span>
<a name="line-252"></a>                               <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-253"></a>       <span class='hs-conid'>IfaceVectInfo</span>
<a name="line-254"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>ifaceVectInfoVar</span>            <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span>  <span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span>  <span class='hs-varid'>vVar</span><span class='hs-keyglyph'>]</span>
<a name="line-255"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoTyCon</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>t</span>   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>t_v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-varid'>vTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>t_v</span><span class='hs-keyglyph'>]</span>
<a name="line-256"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoTyConReuse</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>t</span>   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>t_v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-varid'>vTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>t_v</span><span class='hs-keyglyph'>]</span>
<a name="line-257"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoParallelVars</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>vParallelVars</span><span class='hs-keyglyph'>]</span>
<a name="line-258"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>ifaceVectInfoParallelTyCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>vParallelTyCons</span>
<a name="line-259"></a>       <span class='hs-layout'>}</span>
<a name="line-260"></a>
<a name="line-261"></a><a name="writeIfaceFile"></a><span class='hs-comment'>-----------------------------</span>
<a name="line-262"></a><span class='hs-definition'>writeIfaceFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-263"></a><span class='hs-definition'>writeIfaceFile</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hi_file_path</span> <span class='hs-varid'>new_iface</span>
<a name="line-264"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>createDirectoryIfMissing</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeDirectory</span> <span class='hs-varid'>hi_file_path</span><span class='hs-layout'>)</span>
<a name="line-265"></a>         <span class='hs-varid'>writeBinIface</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hi_file_path</span> <span class='hs-varid'>new_iface</span>
<a name="line-266"></a>
<a name="line-267"></a>
<a name="line-268"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-269"></a><span class='hs-comment'>-- Look up parents and versions of Names</span>
<a name="line-270"></a>
<a name="line-271"></a><span class='hs-comment'>-- This is like a global version of the mi_hash_fn field in each ModIface.</span>
<a name="line-272"></a><span class='hs-comment'>-- Given a Name, it finds the ModIface, and then uses mi_hash_fn to get</span>
<a name="line-273"></a><span class='hs-comment'>-- the parent and version info.</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="mkHashFun"></a><span class='hs-definition'>mkHashFun</span>
<a name="line-276"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>                       <span class='hs-comment'>-- needed to look up versions</span>
<a name="line-277"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExternalPackageState</span>         <span class='hs-comment'>-- ditto</span>
<a name="line-278"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span>
<a name="line-279"></a><span class='hs-definition'>mkHashFun</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>eps</span>
<a name="line-280"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-281"></a>      <span class='hs-keyword'>let</span>
<a name="line-282"></a>        <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-283"></a>        <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-284"></a>        <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupIfaceByModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>pit</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>`orElse`</span>
<a name="line-285"></a>                   <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"lookupVers2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-286"></a>      <span class='hs-keyword'>in</span>
<a name="line-287"></a>        <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_hash_fn</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>`orElse`</span>
<a name="line-288"></a>                  <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"lookupVers1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-289"></a>  <span class='hs-keyword'>where</span>
<a name="line-290"></a>      <span class='hs-varid'>hpt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span>
<a name="line-291"></a>      <span class='hs-varid'>pit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span>
<a name="line-292"></a>
<a name="line-293"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-294"></a><span class='hs-comment'>-- Compute fingerprints for the interface</span>
<a name="line-295"></a>
<a name="line-296"></a><a name="addFingerprints"></a><span class='hs-definition'>addFingerprints</span>
<a name="line-297"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-298"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-comment'>-- the old fingerprint, if any</span>
<a name="line-299"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span>          <span class='hs-comment'>-- The new interface (lacking decls)</span>
<a name="line-300"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceDecl</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- The new decls</span>
<a name="line-301"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Updated interface</span>
<a name="line-302"></a>               <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- True &lt;=&gt; no changes at all;</span>
<a name="line-303"></a>                             <span class='hs-comment'>-- no need to write Iface</span>
<a name="line-304"></a>
<a name="line-305"></a><span class='hs-definition'>addFingerprints</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mb_old_fingerprint</span> <span class='hs-varid'>iface0</span> <span class='hs-varid'>new_decls</span>
<a name="line-306"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-307"></a>   <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span>
<a name="line-308"></a>   <span class='hs-keyword'>let</span>
<a name="line-309"></a>        <span class='hs-comment'>-- The ABI of a declaration represents everything that is made</span>
<a name="line-310"></a>        <span class='hs-comment'>-- visible about the declaration that a client can depend on.</span>
<a name="line-311"></a>        <span class='hs-comment'>-- see IfaceDeclABI below.</span>
<a name="line-312"></a>       <span class='hs-varid'>declABI</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDeclABI</span>
<a name="line-313"></a>       <span class='hs-varid'>declABI</span> <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>extras</span><span class='hs-layout'>)</span>
<a name="line-314"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>extras</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>declExtras</span> <span class='hs-varid'>fix_fn</span> <span class='hs-varid'>ann_fn</span> <span class='hs-varid'>non_orph_rules</span> <span class='hs-varid'>non_orph_insts</span>
<a name="line-315"></a>                                  <span class='hs-varid'>non_orph_fis</span> <span class='hs-varid'>decl</span>
<a name="line-316"></a>
<a name="line-317"></a>       <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IfaceDeclABI</span><span class='hs-layout'>,</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Unique</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-318"></a>       <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>abi</span><span class='hs-layout'>,</span> <span class='hs-varid'>getUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-319"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_decls</span>
<a name="line-320"></a>               <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>abi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>declABI</span> <span class='hs-varid'>decl</span>
<a name="line-321"></a>               <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>localOccs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>freeNamesDeclABI</span> <span class='hs-varid'>abi</span>
<a name="line-322"></a>               <span class='hs-keyglyph'>]</span>
<a name="line-323"></a>
<a name="line-324"></a>       <span class='hs-varid'>name_module</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span>
<a name="line-325"></a>       <span class='hs-varid'>localOccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getParent</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getOccName</span><span class='hs-layout'>)</span>
<a name="line-326"></a>                        <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>name_module</span><span class='hs-layout'>)</span>
<a name="line-327"></a>                        <span class='hs-varop'>.</span> <span class='hs-varid'>nameSetToList</span>
<a name="line-328"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>getParent</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>parent_map</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>occ</span>
<a name="line-329"></a>
<a name="line-330"></a>        <span class='hs-comment'>-- maps OccNames to their parents in the current module.</span>
<a name="line-331"></a>        <span class='hs-comment'>-- e.g. a reference to a constructor must be turned into a reference</span>
<a name="line-332"></a>        <span class='hs-comment'>-- to the TyCon for the purposes of calculating dependencies.</span>
<a name="line-333"></a>       <span class='hs-varid'>parent_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccEnv</span> <span class='hs-conid'>OccName</span>
<a name="line-334"></a>       <span class='hs-varid'>parent_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extend</span> <span class='hs-varid'>emptyOccEnv</span> <span class='hs-varid'>new_decls</span>
<a name="line-335"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>extend</span> <span class='hs-varid'>d</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<a name="line-336"></a>                  <span class='hs-varid'>extendOccEnvList</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ifaceDeclImplicitBndrs</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>]</span>
<a name="line-337"></a>                  <span class='hs-keyword'>where</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifName</span> <span class='hs-varid'>d</span>
<a name="line-338"></a>
<a name="line-339"></a>        <span class='hs-comment'>-- strongly-connected groups of declarations, in dependency order</span>
<a name="line-340"></a>       <span class='hs-varid'>groups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stronglyConnCompFromEdgedVertices</span> <span class='hs-varid'>edges</span>
<a name="line-341"></a>
<a name="line-342"></a>       <span class='hs-varid'>global_hash_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHashFun</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>eps</span>
<a name="line-343"></a>
<a name="line-344"></a>        <span class='hs-comment'>-- how to output Names when generating the data to fingerprint.</span>
<a name="line-345"></a>        <span class='hs-comment'>-- Here we want to output the fingerprint for each top-level</span>
<a name="line-346"></a>        <span class='hs-comment'>-- Name, whether it comes from the current module or another</span>
<a name="line-347"></a>        <span class='hs-comment'>-- module.  In this way, the fingerprint for a declaration will</span>
<a name="line-348"></a>        <span class='hs-comment'>-- change if the fingerprint for anything it refers to (transitively)</span>
<a name="line-349"></a>        <span class='hs-comment'>-- changes.</span>
<a name="line-350"></a>       <span class='hs-varid'>mk_put_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-351"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BinHandle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span>  <span class='hs-conid'>()</span>
<a name="line-352"></a>       <span class='hs-varid'>mk_put_name</span> <span class='hs-varid'>local_env</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>name</span>
<a name="line-353"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>name</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>putNameLiterally</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>name</span>
<a name="line-354"></a>           <span class='hs-comment'>-- wired-in names don't have fingerprints</span>
<a name="line-355"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-356"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span>
<a name="line-357"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>hash</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>global_hash_fn</span> <span class='hs-varid'>name</span>
<a name="line-358"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>local_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-359"></a>                           <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"urk! lookup local fingerprint"</span>
<a name="line-360"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- (undefined,fingerprint0))</span>
<a name="line-361"></a>                <span class='hs-comment'>-- This panic indicates that we got the dependency</span>
<a name="line-362"></a>                <span class='hs-comment'>-- analysis wrong, because we needed a fingerprint for</span>
<a name="line-363"></a>                <span class='hs-comment'>-- an entity that wasn't in the environment.  To debug</span>
<a name="line-364"></a>                <span class='hs-comment'>-- it, turn the panic into a trace, uncomment the</span>
<a name="line-365"></a>                <span class='hs-comment'>-- pprTraces below, run the compile again, and inspect</span>
<a name="line-366"></a>                <span class='hs-comment'>-- the output and the generated .hi file with</span>
<a name="line-367"></a>                <span class='hs-comment'>-- --show-iface.</span>
<a name="line-368"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>hash</span>
<a name="line-369"></a>
<a name="line-370"></a>        <span class='hs-comment'>-- take a strongly-connected group of declarations and compute</span>
<a name="line-371"></a>        <span class='hs-comment'>-- its fingerprint.</span>
<a name="line-372"></a>
<a name="line-373"></a>       <span class='hs-varid'>fingerprint_group</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-374"></a>                             <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span><span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-375"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SCC</span> <span class='hs-conid'>IfaceDeclABI</span>
<a name="line-376"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-377"></a>                                <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span><span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-378"></a>
<a name="line-379"></a>       <span class='hs-varid'>fingerprint_group</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>decls_w_hashes</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-varid'>abi</span><span class='hs-layout'>)</span>
<a name="line-380"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>hash_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_put_name</span> <span class='hs-varid'>local_env</span>
<a name="line-381"></a>                   <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abiDecl</span> <span class='hs-varid'>abi</span>
<a name="line-382"></a>               <span class='hs-comment'>-- pprTrace "fingerprinting" (ppr (ifName decl) ) $ do</span>
<a name="line-383"></a>               <span class='hs-varid'>hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>computeFingerprint</span> <span class='hs-varid'>hash_fn</span> <span class='hs-varid'>abi</span>
<a name="line-384"></a>               <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extend_hash_env</span> <span class='hs-varid'>local_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>hash</span><span class='hs-layout'>,</span><span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-385"></a>               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>hash</span><span class='hs-layout'>,</span><span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>decls_w_hashes</span><span class='hs-layout'>)</span>
<a name="line-386"></a>
<a name="line-387"></a>       <span class='hs-varid'>fingerprint_group</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>decls_w_hashes</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>abis</span><span class='hs-layout'>)</span>
<a name="line-388"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>abiDecl</span> <span class='hs-varid'>abis</span>
<a name="line-389"></a>               <span class='hs-varid'>local_env1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>extend_hash_env</span> <span class='hs-varid'>local_env</span>
<a name="line-390"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>fingerprint0</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls</span><span class='hs-layout'>)</span>
<a name="line-391"></a>               <span class='hs-keyword'>let</span> <span class='hs-varid'>hash_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_put_name</span> <span class='hs-varid'>local_env1</span>
<a name="line-392"></a>               <span class='hs-comment'>-- pprTrace "fingerprinting" (ppr (map ifName decls) ) $ do</span>
<a name="line-393"></a>               <span class='hs-keyword'>let</span> <span class='hs-varid'>stable_abis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>cmp_abiNames</span> <span class='hs-varid'>abis</span>
<a name="line-394"></a>                <span class='hs-comment'>-- put the cycle in a canonical order</span>
<a name="line-395"></a>               <span class='hs-varid'>hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>computeFingerprint</span> <span class='hs-varid'>hash_fn</span> <span class='hs-varid'>stable_abis</span>
<a name="line-396"></a>               <span class='hs-keyword'>let</span> <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>hash</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls</span>
<a name="line-397"></a>               <span class='hs-varid'>local_env2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>extend_hash_env</span> <span class='hs-varid'>local_env</span> <span class='hs-varid'>pairs</span>
<a name="line-398"></a>               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>decls_w_hashes</span><span class='hs-layout'>)</span>
<a name="line-399"></a>
<a name="line-400"></a>       <span class='hs-comment'>-- we have fingerprinted the whole declaration, but we now need</span>
<a name="line-401"></a>       <span class='hs-comment'>-- to assign fingerprints to all the OccNames that it binds, to</span>
<a name="line-402"></a>       <span class='hs-comment'>-- use when referencing those OccNames in later declarations.</span>
<a name="line-403"></a>       <span class='hs-comment'>--</span>
<a name="line-404"></a>       <span class='hs-varid'>extend_hash_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span>
<a name="line-405"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span><span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>)</span>
<a name="line-406"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-407"></a>       <span class='hs-varid'>extend_hash_env</span> <span class='hs-varid'>env0</span> <span class='hs-layout'>(</span><span class='hs-varid'>hash</span><span class='hs-layout'>,</span><span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-408"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>fp</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>fp</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>env0</span>
<a name="line-409"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>ifaceDeclFingerprints</span> <span class='hs-varid'>hash</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-410"></a>
<a name="line-411"></a>   <span class='hs-comment'>--</span>
<a name="line-412"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>local_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>decls_w_hashes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-413"></a>       <span class='hs-varid'>foldM</span> <span class='hs-varid'>fingerprint_group</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyOccEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>groups</span>
<a name="line-414"></a>
<a name="line-415"></a>   <span class='hs-comment'>-- when calculating fingerprints, we always need to use canonical</span>
<a name="line-416"></a>   <span class='hs-comment'>-- ordering for lists of things.  In particular, the mi_deps has various</span>
<a name="line-417"></a>   <span class='hs-comment'>-- lists of modules and suchlike, so put these all in canonical order:</span>
<a name="line-418"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>sorted_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortDependencies</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-419"></a>
<a name="line-420"></a>   <span class='hs-comment'>-- the export hash of a module depends on the orphan hashes of the</span>
<a name="line-421"></a>   <span class='hs-comment'>-- orphan modules below us in the dependency tree.  This is the way</span>
<a name="line-422"></a>   <span class='hs-comment'>-- that changes in orphans get propagated all the way up the</span>
<a name="line-423"></a>   <span class='hs-comment'>-- dependency tree.  We only care about orphan modules in the current</span>
<a name="line-424"></a>   <span class='hs-comment'>-- package, because changes to orphans outside this package will be</span>
<a name="line-425"></a>   <span class='hs-comment'>-- tracked by the usage on the ABI hash of package modules that we import.</span>
<a name="line-426"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>orph_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>this_pkg</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>modulePackageId</span><span class='hs-layout'>)</span>
<a name="line-427"></a>                   <span class='hs-varop'>$</span> <span class='hs-varid'>dep_orphs</span> <span class='hs-varid'>sorted_deps</span>
<a name="line-428"></a>   <span class='hs-varid'>dep_orphan_hashes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getOrphanHashes</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>orph_mods</span>
<a name="line-429"></a>
<a name="line-430"></a>   <span class='hs-varid'>orphan_hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>computeFingerprint</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_put_name</span> <span class='hs-varid'>local_env</span><span class='hs-layout'>)</span>
<a name="line-431"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ifDFun</span> <span class='hs-varid'>orph_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>orph_rules</span><span class='hs-layout'>,</span> <span class='hs-varid'>orph_fis</span><span class='hs-layout'>)</span>
<a name="line-432"></a>
<a name="line-433"></a>   <span class='hs-comment'>-- the export list hash doesn't depend on the fingerprints of</span>
<a name="line-434"></a>   <span class='hs-comment'>-- the Names it mentions, only the Names themselves, hence putNameLiterally.</span>
<a name="line-435"></a>   <span class='hs-varid'>export_hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>computeFingerprint</span> <span class='hs-varid'>putNameLiterally</span>
<a name="line-436"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>mi_exports</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>,</span>
<a name="line-437"></a>                       <span class='hs-varid'>orphan_hash</span><span class='hs-layout'>,</span>
<a name="line-438"></a>                       <span class='hs-varid'>dep_orphan_hashes</span><span class='hs-layout'>,</span>
<a name="line-439"></a>                       <span class='hs-varid'>dep_pkgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-440"></a>                        <span class='hs-comment'>-- dep_pkgs: see "Package Version Changes" on</span>
<a name="line-441"></a>                        <span class='hs-comment'>-- wiki/Commentary/Compiler/RecompilationAvoidance</span>
<a name="line-442"></a>                       <span class='hs-varid'>mi_trust</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-443"></a>                        <span class='hs-comment'>-- Make sure change of Safe Haskell mode causes recomp.</span>
<a name="line-444"></a>
<a name="line-445"></a>   <span class='hs-comment'>-- put the declarations in a canonical order, sorted by OccName</span>
<a name="line-446"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>sorted_decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span>
<a name="line-447"></a>                          <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ifName</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decls_w_hashes</span><span class='hs-keyglyph'>]</span>
<a name="line-448"></a>
<a name="line-449"></a>   <span class='hs-comment'>-- the flag hash depends on:</span>
<a name="line-450"></a>   <span class='hs-comment'>--   - (some of) dflags</span>
<a name="line-451"></a>   <span class='hs-comment'>-- it returns two hashes, one that shouldn't change</span>
<a name="line-452"></a>   <span class='hs-comment'>-- the abi hash and one that should</span>
<a name="line-453"></a>   <span class='hs-varid'>flag_hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fingerprintDynFlags</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>putNameLiterally</span>
<a name="line-454"></a>
<a name="line-455"></a>   <span class='hs-comment'>-- the ABI hash depends on:</span>
<a name="line-456"></a>   <span class='hs-comment'>--   - decls</span>
<a name="line-457"></a>   <span class='hs-comment'>--   - export list</span>
<a name="line-458"></a>   <span class='hs-comment'>--   - orphans</span>
<a name="line-459"></a>   <span class='hs-comment'>--   - deprecations</span>
<a name="line-460"></a>   <span class='hs-comment'>--   - vect info</span>
<a name="line-461"></a>   <span class='hs-comment'>--   - flag abi hash</span>
<a name="line-462"></a>   <span class='hs-varid'>mod_hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>computeFingerprint</span> <span class='hs-varid'>putNameLiterally</span>
<a name="line-463"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>sorted_decls</span><span class='hs-layout'>,</span>
<a name="line-464"></a>                       <span class='hs-varid'>export_hash</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- includes orphan_hash</span>
<a name="line-465"></a>                       <span class='hs-varid'>mi_warns</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>,</span>
<a name="line-466"></a>                       <span class='hs-varid'>mi_vect_info</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-467"></a>
<a name="line-468"></a>   <span class='hs-comment'>-- The interface hash depends on:</span>
<a name="line-469"></a>   <span class='hs-comment'>--   - the ABI hash, plus</span>
<a name="line-470"></a>   <span class='hs-comment'>--   - the module level annotations,</span>
<a name="line-471"></a>   <span class='hs-comment'>--   - usages</span>
<a name="line-472"></a>   <span class='hs-comment'>--   - deps (home and external packages, dependent files)</span>
<a name="line-473"></a>   <span class='hs-comment'>--   - hpc</span>
<a name="line-474"></a>   <span class='hs-varid'>iface_hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>computeFingerprint</span> <span class='hs-varid'>putNameLiterally</span>
<a name="line-475"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>mod_hash</span><span class='hs-layout'>,</span>
<a name="line-476"></a>                       <span class='hs-varid'>ann_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOcc</span> <span class='hs-str'>"module"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- See mkIfaceAnnCache</span>
<a name="line-477"></a>                       <span class='hs-varid'>mi_usages</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>,</span>
<a name="line-478"></a>                       <span class='hs-varid'>sorted_deps</span><span class='hs-layout'>,</span>
<a name="line-479"></a>                       <span class='hs-varid'>mi_hpc</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-480"></a>
<a name="line-481"></a>   <span class='hs-keyword'>let</span>
<a name="line-482"></a>    <span class='hs-varid'>no_change_at_all</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface_hash</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mb_old_fingerprint</span>
<a name="line-483"></a>
<a name="line-484"></a>    <span class='hs-varid'>final_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iface0</span> <span class='hs-layout'>{</span>
<a name="line-485"></a>                <span class='hs-varid'>mi_mod_hash</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_hash</span><span class='hs-layout'>,</span>
<a name="line-486"></a>                <span class='hs-varid'>mi_iface_hash</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iface_hash</span><span class='hs-layout'>,</span>
<a name="line-487"></a>                <span class='hs-varid'>mi_exp_hash</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>export_hash</span><span class='hs-layout'>,</span>
<a name="line-488"></a>                <span class='hs-varid'>mi_orphan_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphan_hash</span><span class='hs-layout'>,</span>
<a name="line-489"></a>                <span class='hs-varid'>mi_flag_hash</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flag_hash</span><span class='hs-layout'>,</span>
<a name="line-490"></a>                <span class='hs-varid'>mi_orphan</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span>   <span class='hs-varid'>null</span> <span class='hs-varid'>orph_rules</span>
<a name="line-491"></a>                                      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>orph_insts</span>
<a name="line-492"></a>                                      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>orph_fis</span>
<a name="line-493"></a>                                      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isNoIfaceVectInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_vect_info</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-494"></a>                <span class='hs-varid'>mi_finsts</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mi_fam_insts</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>,</span>
<a name="line-495"></a>                <span class='hs-varid'>mi_decls</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sorted_decls</span><span class='hs-layout'>,</span>
<a name="line-496"></a>                <span class='hs-varid'>mi_hash_fn</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>local_env</span> <span class='hs-layout'>}</span>
<a name="line-497"></a>   <span class='hs-comment'>--</span>
<a name="line-498"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_change_at_all</span><span class='hs-layout'>)</span>
<a name="line-499"></a>
<a name="line-500"></a>  <span class='hs-keyword'>where</span>
<a name="line-501"></a>    <span class='hs-varid'>this_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface0</span>
<a name="line-502"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-503"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-504"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>non_orph_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>orph_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOrphMap</span> <span class='hs-varid'>ifInstOrph</span>    <span class='hs-layout'>(</span><span class='hs-varid'>mi_insts</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-505"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>non_orph_rules</span><span class='hs-layout'>,</span> <span class='hs-varid'>orph_rules</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOrphMap</span> <span class='hs-varid'>ifRuleOrph</span>    <span class='hs-layout'>(</span><span class='hs-varid'>mi_rules</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-506"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>non_orph_fis</span><span class='hs-layout'>,</span>   <span class='hs-varid'>orph_fis</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOrphMap</span> <span class='hs-varid'>ifFamInstOrph</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_fam_insts</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-507"></a>    <span class='hs-varid'>fix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_fix_fn</span> <span class='hs-varid'>iface0</span>
<a name="line-508"></a>    <span class='hs-varid'>ann_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIfaceAnnCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_anns</span> <span class='hs-varid'>iface0</span><span class='hs-layout'>)</span>
<a name="line-509"></a>
<a name="line-510"></a><a name="getOrphanHashes"></a><span class='hs-definition'>getOrphanHashes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Fingerprint</span><span class='hs-keyglyph'>]</span>
<a name="line-511"></a><span class='hs-definition'>getOrphanHashes</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-512"></a>  <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span>
<a name="line-513"></a>  <span class='hs-keyword'>let</span>
<a name="line-514"></a>    <span class='hs-varid'>hpt</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span>
<a name="line-515"></a>    <span class='hs-varid'>pit</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span>
<a name="line-516"></a>    <span class='hs-varid'>dflags</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-517"></a>    <span class='hs-varid'>get_orph_hash</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span>
<a name="line-518"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupIfaceByModule</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>pit</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-519"></a>            <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"moduleOrphanHash"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-520"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mi_orphan_hash</span> <span class='hs-varid'>iface</span>
<a name="line-521"></a>  <span class='hs-comment'>--</span>
<a name="line-522"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>get_orph_hash</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span>
<a name="line-523"></a>
<a name="line-524"></a>
<a name="line-525"></a><a name="sortDependencies"></a><span class='hs-definition'>sortDependencies</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Dependencies</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Dependencies</span>
<a name="line-526"></a><span class='hs-definition'>sortDependencies</span> <span class='hs-varid'>d</span>
<a name="line-527"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Deps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dep_mods</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>compare</span> <span class='hs-varop'>`on`</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleNameFS</span><span class='hs-varop'>.</span><span class='hs-varid'>fst</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_mods</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-528"></a>          <span class='hs-varid'>dep_pkgs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>stablePackageIdCmp</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_pkgs</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-529"></a>          <span class='hs-varid'>dep_orphs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableModuleCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_orphs</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-530"></a>          <span class='hs-varid'>dep_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableModuleCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_finsts</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="mkIfaceAnnCache"></a><span class='hs-comment'>-- | Creates cached lookup for the 'mi_anns' field of ModIface</span>
<a name="line-2"></a><span class='hs-comment'>-- Hackily, we use "module" as the OccName for any module-level annotations</span>
<a name="line-3"></a><span class='hs-definition'>mkIfaceAnnCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceAnnotation</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AnnPayload</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a><span class='hs-definition'>mkIfaceAnnCache</span> <span class='hs-varid'>anns</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>pair</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceAnnotation</span> <span class='hs-varid'>target</span> <span class='hs-varid'>value</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-8"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>target</span> <span class='hs-keyword'>of</span>
<a name="line-9"></a>          <span class='hs-conid'>NamedTarget</span> <span class='hs-varid'>occn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occn</span>
<a name="line-10"></a>          <span class='hs-conid'>ModuleTarget</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOcc</span> <span class='hs-str'>"module"</span>
<a name="line-11"></a>      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>value</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-comment'>-- flipping (++), so the first argument is always short</span>
<a name="line-13"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccEnv_C</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pair</span> <span class='hs-varid'>anns</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
          The ABI of an IfaceDecl
%*                                                                      *
%************************************************************************

Note [The ABI of an IfaceDecl]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The ABI of a declaration consists of:

   (a) the full name of the identifier (inc. module and package,
       because these are used to construct the symbol name by which
       the identifier is known externally).

   (b) the declaration itself, as exposed to clients.  That is, the
       definition of an Id is included in the fingerprint only if
       it is made available as an unfolding in the interface.

   (c) the fixity of the identifier
   (d) for Ids: rules
   (e) for classes: instances, fixity & rules for methods
   (f) for datatypes: instances, fixity & rules for constrs

Items (c)-(f) are not stored in the IfaceDecl, but instead appear
elsewhere in the interface file.  But they are *fingerprinted* with
the declaration itself. This is done by grouping (c)-(f) in IfaceDeclExtras,
and fingerprinting that as part of the declaration.

\begin{code}
<pre><a name="line-1"></a><a name="IfaceDeclABI"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfaceDeclABI</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceDecl</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceDeclExtras</span><span class='hs-layout'>)</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="IfaceDeclExtras"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfaceDeclExtras</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceIdExtras</span> <span class='hs-conid'>IfaceIdExtras</span>
<a name="line-5"></a>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfaceDataExtras</span>
<a name="line-7"></a>       <span class='hs-conid'>Fixity</span>                   <span class='hs-comment'>-- Fixity of the tycon itself</span>
<a name="line-8"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceInstABI</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Local class and family instances of this tycon</span>
<a name="line-9"></a>                                <span class='hs-comment'>-- See Note [Orphans] in IfaceSyn</span>
<a name="line-10"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>AnnPayload</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Annotations of the type itself</span>
<a name="line-11"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceIdExtras</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- For each constructor: fixity, RULES and annotations</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfaceClassExtras</span>
<a name="line-14"></a>       <span class='hs-conid'>Fixity</span>                   <span class='hs-comment'>-- Fixity of the class itself</span>
<a name="line-15"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceInstABI</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Local instances of this class *or*</span>
<a name="line-16"></a>                                <span class='hs-comment'>--   of its associated data types</span>
<a name="line-17"></a>                                <span class='hs-comment'>-- See Note [Orphans] in IfaceSyn</span>
<a name="line-18"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>AnnPayload</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Annotations of the type itself</span>
<a name="line-19"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceIdExtras</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- For each class method: fixity, RULES and annotations</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfaceSynExtras</span>   <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceInstABI</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AnnPayload</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfaceOtherDeclExtras</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="IfaceIdExtras"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfaceIdExtras</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdExtras</span>
<a name="line-27"></a>       <span class='hs-conid'>Fixity</span>                   <span class='hs-comment'>-- Fixity of the Id</span>
<a name="line-28"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceRule</span><span class='hs-keyglyph'>]</span>              <span class='hs-comment'>-- Rules for the Id</span>
<a name="line-29"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>AnnPayload</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Annotations for the Id</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="IfaceInstABI"></a><span class='hs-comment'>-- When hashing a class or family instance, we hash only the</span>
<a name="line-32"></a><a name="IfaceInstABI"></a><span class='hs-comment'>-- DFunId or CoAxiom, because that depends on all the</span>
<a name="line-33"></a><a name="IfaceInstABI"></a><span class='hs-comment'>-- information about the instance.</span>
<a name="line-34"></a><a name="IfaceInstABI"></a><span class='hs-comment'>--</span>
<a name="line-35"></a><a name="IfaceInstABI"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfaceInstABI</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfExtName</span>   <span class='hs-comment'>-- Name of DFunId or CoAxiom that is evidence for the instance</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="abiDecl"></a><span class='hs-definition'>abiDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceDeclABI</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-38"></a><span class='hs-definition'>abiDecl</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decl</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="cmp_abiNames"></a><span class='hs-definition'>cmp_abiNames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceDeclABI</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDeclABI</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-41"></a><span class='hs-definition'>cmp_abiNames</span> <span class='hs-varid'>abi1</span> <span class='hs-varid'>abi2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifName</span> <span class='hs-layout'>(</span><span class='hs-varid'>abiDecl</span> <span class='hs-varid'>abi1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`compare`</span>
<a name="line-42"></a>                         <span class='hs-varid'>ifName</span> <span class='hs-layout'>(</span><span class='hs-varid'>abiDecl</span> <span class='hs-varid'>abi2</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="freeNamesDeclABI"></a><span class='hs-definition'>freeNamesDeclABI</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceDeclABI</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-45"></a><span class='hs-definition'>freeNamesDeclABI</span> <span class='hs-layout'>(</span><span class='hs-sel'>_mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>extras</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-46"></a>  <span class='hs-varid'>freeNamesIfDecl</span> <span class='hs-varid'>decl</span> <span class='hs-varop'>`unionNameSets`</span> <span class='hs-varid'>freeNamesDeclExtras</span> <span class='hs-varid'>extras</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="freeNamesDeclExtras"></a><span class='hs-definition'>freeNamesDeclExtras</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceDeclExtras</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-49"></a><span class='hs-definition'>freeNamesDeclExtras</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceIdExtras</span> <span class='hs-varid'>id_extras</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>freeNamesIdExtras</span> <span class='hs-varid'>id_extras</span>
<a name="line-51"></a><span class='hs-definition'>freeNamesDeclExtras</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceDataExtras</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>insts</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyNameSets</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>insts</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>freeNamesIdExtras</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>freeNamesDeclExtras</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceClassExtras</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>insts</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyNameSets</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>insts</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>freeNamesIdExtras</span> <span class='hs-varid'>subs</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-definition'>freeNamesDeclExtras</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceSynExtras</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>insts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>insts</span>
<a name="line-57"></a><span class='hs-definition'>freeNamesDeclExtras</span> <span class='hs-conid'>IfaceOtherDeclExtras</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameSet</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="freeNamesIdExtras"></a><span class='hs-definition'>freeNamesIdExtras</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceIdExtras</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-61"></a><span class='hs-definition'>freeNamesIdExtras</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdExtras</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rules</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyNameSets</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>freeNamesIfRule</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>IfaceDeclExtras</span> <span class='hs-keyword'>where</span>
<a name="line-64"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>IfaceOtherDeclExtras</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-65"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceIdExtras</span>  <span class='hs-varid'>extras</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_id_extras</span> <span class='hs-varid'>extras</span>
<a name="line-66"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceSynExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>finsts</span> <span class='hs-varid'>anns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fix</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>finsts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>anns</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceDataExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>insts</span> <span class='hs-varid'>anns</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fix</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_insts</span> <span class='hs-varid'>insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>anns</span><span class='hs-layout'>,</span>
<a name="line-68"></a>                                                <span class='hs-varid'>ppr_id_extras_s</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>]</span>
<a name="line-69"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceClassExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>insts</span> <span class='hs-varid'>anns</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fix</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_insts</span> <span class='hs-varid'>insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>anns</span><span class='hs-layout'>,</span>
<a name="line-70"></a>                                                 <span class='hs-varid'>ppr_id_extras_s</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>]</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="ppr_insts"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceInstABI</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-73"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"&lt;insts&gt;"</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="ppr_id_extras_s"></a><span class='hs-definition'>ppr_id_extras_s</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceIdExtras</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-76"></a><span class='hs-definition'>ppr_id_extras_s</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_id_extras</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="ppr_id_extras"></a><span class='hs-definition'>ppr_id_extras</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceIdExtras</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-79"></a><span class='hs-definition'>ppr_id_extras</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>anns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fix</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>anns</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-comment'>-- This instance is used only to compute fingerprints</span>
<a name="line-82"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>IfaceDeclExtras</span> <span class='hs-keyword'>where</span>
<a name="line-83"></a>  <span class='hs-varid'>get</span> <span class='hs-sel'>_bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"no get for IfaceDeclExtras"</span>
<a name="line-84"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceIdExtras</span> <span class='hs-varid'>extras</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-85"></a>   <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>extras</span>
<a name="line-86"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceDataExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>insts</span> <span class='hs-varid'>anns</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-87"></a>   <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>2</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>fix</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>insts</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>anns</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>cons</span>
<a name="line-88"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceClassExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>insts</span> <span class='hs-varid'>anns</span> <span class='hs-varid'>methods</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-89"></a>   <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>3</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>fix</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>insts</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>anns</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>methods</span>
<a name="line-90"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceSynExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>finsts</span> <span class='hs-varid'>anns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-91"></a>   <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>4</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>fix</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>finsts</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>anns</span>
<a name="line-92"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>IfaceOtherDeclExtras</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>5</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>IfaceIdExtras</span> <span class='hs-keyword'>where</span>
<a name="line-95"></a>  <span class='hs-varid'>get</span> <span class='hs-sel'>_bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"no get for IfaceIdExtras"</span>
<a name="line-96"></a>  <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdExtras</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>anns</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>fix</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>rules</span><span class='hs-layout'>;</span> <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>anns</span> <span class='hs-layout'>}</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="declExtras"></a><span class='hs-definition'>declExtras</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span>
<a name="line-99"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AnnPayload</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-100"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceRule</span><span class='hs-keyglyph'>]</span>
<a name="line-101"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceClsInst</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceFamInst</span><span class='hs-keyglyph'>]</span>
<a name="line-103"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-104"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDeclExtras</span>
<a name="line-105"></a>
<a name="line-106"></a><span class='hs-definition'>declExtras</span> <span class='hs-varid'>fix_fn</span> <span class='hs-varid'>ann_fn</span> <span class='hs-varid'>rule_env</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>fi_env</span> <span class='hs-varid'>decl</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>decl</span> <span class='hs-keyword'>of</span>
<a name="line-108"></a>      <span class='hs-conid'>IfaceId</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceIdExtras</span> <span class='hs-layout'>(</span><span class='hs-varid'>id_extras</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-109"></a>      <span class='hs-conid'>IfaceData</span><span class='hs-layout'>{</span><span class='hs-varid'>ifCons</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>cons</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-110"></a>                     <span class='hs-conid'>IfaceDataExtras</span> <span class='hs-layout'>(</span><span class='hs-varid'>fix_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-111"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ifFamInstAxiom</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupOccEnvL</span> <span class='hs-varid'>fi_env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-112"></a>                         <span class='hs-varid'>map</span> <span class='hs-varid'>ifDFun</span>         <span class='hs-layout'>(</span><span class='hs-varid'>lookupOccEnvL</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-113"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>ann_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-114"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>id_extras</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ifConOcc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>visibleIfConDecls</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-115"></a>      <span class='hs-conid'>IfaceClass</span><span class='hs-layout'>{</span><span class='hs-varid'>ifSigs</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifATs</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>ats</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-116"></a>                     <span class='hs-conid'>IfaceClassExtras</span> <span class='hs-layout'>(</span><span class='hs-varid'>fix_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-117"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ifDFun</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>at_extras</span> <span class='hs-varid'>ats</span><span class='hs-layout'>)</span>
<a name="line-118"></a>                                    <span class='hs-varop'>++</span> <span class='hs-varid'>lookupOccEnvL</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-119"></a>                           <span class='hs-comment'>-- Include instances of the associated types</span>
<a name="line-120"></a>                           <span class='hs-comment'>-- as well as instances of the class (Trac #5147)</span>
<a name="line-121"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>ann_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-122"></a>                        <span class='hs-keyglyph'>[</span><span class='hs-varid'>id_extras</span> <span class='hs-varid'>op</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfaceClassOp</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sigs</span><span class='hs-keyglyph'>]</span>
<a name="line-123"></a>      <span class='hs-conid'>IfaceSyn</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceSynExtras</span> <span class='hs-layout'>(</span><span class='hs-varid'>fix_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-124"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ifFamInstAxiom</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupOccEnvL</span> <span class='hs-varid'>fi_env</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-125"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>ann_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-126"></a>      <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceOtherDeclExtras</span>
<a name="line-127"></a>  <span class='hs-keyword'>where</span>
<a name="line-128"></a>        <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifName</span> <span class='hs-varid'>decl</span>
<a name="line-129"></a>        <span class='hs-varid'>id_extras</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdExtras</span> <span class='hs-layout'>(</span><span class='hs-varid'>fix_fn</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupOccEnvL</span> <span class='hs-varid'>rule_env</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ann_fn</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-130"></a>        <span class='hs-varid'>at_extras</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceAT</span> <span class='hs-varid'>decl</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnvL</span> <span class='hs-varid'>inst_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-131"></a>
<a name="line-132"></a>
<a name="line-133"></a><a name="lookupOccEnvL"></a><span class='hs-definition'>lookupOccEnvL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-134"></a><span class='hs-definition'>lookupOccEnvL</span> <span class='hs-varid'>env</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>k</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="putNameLiterally"></a><span class='hs-comment'>-- used when we want to fingerprint a structure without depending on the</span>
<a name="line-137"></a><span class='hs-comment'>-- fingerprints of external Names that it refers to.</span>
<a name="line-138"></a><span class='hs-definition'>putNameLiterally</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BinHandle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-139"></a><span class='hs-definition'>putNameLiterally</span> <span class='hs-varid'>bh</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span>
<a name="line-140"></a>  <span class='hs-keyword'>do</span>
<a name="line-141"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-142"></a>    <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-comment'>{-
<a name="line-145"></a>-- for testing: use the md5sum command to generate fingerprints and
<a name="line-146"></a>-- compare the results against our built-in version.
<a name="line-147"></a>  fp' &lt;- oldMD5 dflags bh
<a name="line-148"></a>  if fp /= fp' then pprPanic "computeFingerprint" (ppr fp &lt;+&gt; ppr fp')
<a name="line-149"></a>               else return fp
<a name="line-150"></a>
<a name="line-151"></a>oldMD5 dflags bh = do
<a name="line-152"></a>  tmp &lt;- newTempName dflags "bin"
<a name="line-153"></a>  writeBinMem bh tmp
<a name="line-154"></a>  tmp2 &lt;- newTempName dflags "md5"
<a name="line-155"></a>  let cmd = "md5sum " ++ tmp ++ " &gt;" ++ tmp2
<a name="line-156"></a>  r &lt;- system cmd
<a name="line-157"></a>  case r of
<a name="line-158"></a>    ExitFailure _ -&gt; throwGhcExceptionIO (PhaseFailed cmd r)
<a name="line-159"></a>    ExitSuccess -&gt; do
<a name="line-160"></a>        hash_str &lt;- readFile tmp2
<a name="line-161"></a>        return $! readHexFingerprint hash_str
<a name="line-162"></a>-}</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="instOrphWarn"></a><span class='hs-definition'>instOrphWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrintUnqualified</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WarnMsg</span>
<a name="line-165"></a><span class='hs-definition'>instOrphWarn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unqual</span> <span class='hs-varid'>inst</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWarnMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>inst</span><span class='hs-layout'>)</span> <span class='hs-varid'>unqual</span> <span class='hs-varop'>$</span>
<a name="line-167"></a>    <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Orphan instance:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprInstanceHdr</span> <span class='hs-varid'>inst</span><span class='hs-layout'>)</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="ruleOrphWarn"></a><span class='hs-definition'>ruleOrphWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrintUnqualified</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WarnMsg</span>
<a name="line-170"></a><span class='hs-definition'>ruleOrphWarn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unqual</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>rule</span>
<a name="line-171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWarnMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>silly_loc</span> <span class='hs-varid'>unqual</span> <span class='hs-varop'>$</span>
<a name="line-172"></a>    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Orphan rule:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rule</span>
<a name="line-173"></a>  <span class='hs-keyword'>where</span>
<a name="line-174"></a>    <span class='hs-varid'>silly_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcLocSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-175"></a>    <span class='hs-comment'>-- We don't have a decent SrcSpan for a Rule, not even the CoreRule</span>
<a name="line-176"></a>    <span class='hs-comment'>-- Could readily be fixed by adding a SrcSpan to CoreRule, if we wanted to</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="mkOrphMap"></a><span class='hs-comment'>----------------------</span>
<a name="line-179"></a><span class='hs-comment'>-- mkOrphMap partitions instance decls or rules into</span>
<a name="line-180"></a><span class='hs-comment'>--      (a) an OccEnv for ones that are not orphans,</span>
<a name="line-181"></a><span class='hs-comment'>--          mapping the local OccName to a list of its decls</span>
<a name="line-182"></a><span class='hs-comment'>--      (b) a list of orphan decls</span>
<a name="line-183"></a><span class='hs-definition'>mkOrphMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>OccName</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- (Just occ) for a non-orphan decl, keyed by occ</span>
<a name="line-184"></a>                                        <span class='hs-comment'>-- Nothing for an orphan decl</span>
<a name="line-185"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>decl</span><span class='hs-keyglyph'>]</span>                     <span class='hs-comment'>-- Sorted into canonical order</span>
<a name="line-186"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>decl</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- Non-orphan decls associated with their key;</span>
<a name="line-187"></a>                                        <span class='hs-comment'>--      each sublist in canonical order</span>
<a name="line-188"></a>              <span class='hs-keyglyph'>[</span><span class='hs-varid'>decl</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>                   <span class='hs-comment'>-- Orphan decls; in canonical order</span>
<a name="line-189"></a><span class='hs-definition'>mkOrphMap</span> <span class='hs-varid'>get_key</span> <span class='hs-varid'>decls</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyOccEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls</span>
<a name="line-191"></a>  <span class='hs-keyword'>where</span>
<a name="line-192"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>non_orphs</span><span class='hs-layout'>,</span> <span class='hs-varid'>orphs</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span>
<a name="line-193"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_key</span> <span class='hs-varid'>d</span>
<a name="line-194"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendOccEnv_Acc</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>singleton</span> <span class='hs-varid'>non_orphs</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>orphs</span><span class='hs-layout'>)</span>
<a name="line-195"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>non_orphs</span><span class='hs-layout'>,</span> <span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>orphs</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
       Keeping track of what we've slurped, and fingerprints
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkUsageInfo"></a><span class='hs-definition'>mkUsageInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportedMods</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Usage</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>mkUsageInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>dir_imp_mods</span> <span class='hs-varid'>used_names</span> <span class='hs-varid'>dependent_files</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>    <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span>
<a name="line-5"></a>    <span class='hs-varid'>hashes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>getFileHash</span> <span class='hs-varid'>dependent_files</span>
<a name="line-6"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mod_usages</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_mod_usage_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span>
<a name="line-7"></a>                                       <span class='hs-varid'>dir_imp_mods</span> <span class='hs-varid'>used_names</span>
<a name="line-8"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>usages</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_usages</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>UsageFile</span> <span class='hs-layout'>{</span> <span class='hs-varid'>usg_file_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span>
<a name="line-9"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>usg_file_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hash</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>hash</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>dependent_files</span> <span class='hs-varid'>hashes</span> <span class='hs-keyglyph'>]</span>
<a name="line-11"></a>    <span class='hs-varid'>usages</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>return</span> <span class='hs-varid'>usages</span>
<a name="line-12"></a>    <span class='hs-comment'>-- seq the list of Usages returned: occasionally these</span>
<a name="line-13"></a>    <span class='hs-comment'>-- don't get evaluated for a while and we can end up hanging on to</span>
<a name="line-14"></a>    <span class='hs-comment'>-- the entire collection of Ifaces.</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="mk_mod_usage_info"></a><span class='hs-definition'>mk_mod_usage_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageIfaceTable</span>
<a name="line-17"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span>
<a name="line-18"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-19"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportedMods</span>
<a name="line-20"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-21"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Usage</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a><span class='hs-definition'>mk_mod_usage_info</span> <span class='hs-varid'>pit</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>direct_imports</span> <span class='hs-varid'>used_names</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>mkUsage</span> <span class='hs-varid'>usage_mods</span>
<a name="line-24"></a>  <span class='hs-keyword'>where</span>
<a name="line-25"></a>    <span class='hs-varid'>hpt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span>
<a name="line-26"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-27"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-varid'>used_mods</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleEnvKeys</span> <span class='hs-varid'>ent_map</span>
<a name="line-30"></a>    <span class='hs-varid'>dir_imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleEnvKeys</span> <span class='hs-varid'>direct_imports</span>
<a name="line-31"></a>    <span class='hs-varid'>all_mods</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_mods</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`notElem`</span> <span class='hs-varid'>used_mods</span><span class='hs-layout'>)</span> <span class='hs-varid'>dir_imp_mods</span>
<a name="line-32"></a>    <span class='hs-varid'>usage_mods</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableModuleCmp</span> <span class='hs-varid'>all_mods</span>
<a name="line-33"></a>                        <span class='hs-comment'>-- canonical order is imported, to avoid interface-file</span>
<a name="line-34"></a>                        <span class='hs-comment'>-- wobblage.</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-comment'>-- ent_map groups together all the things imported and used</span>
<a name="line-37"></a>    <span class='hs-comment'>-- from a particular module</span>
<a name="line-38"></a>    <span class='hs-varid'>ent_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OccName</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a>    <span class='hs-varid'>ent_map</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldNameSet</span> <span class='hs-varid'>add_mv</span> <span class='hs-varid'>emptyModuleEnv</span> <span class='hs-varid'>used_names</span>
<a name="line-40"></a>     <span class='hs-keyword'>where</span>
<a name="line-41"></a>      <span class='hs-varid'>add_mv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>mv_map</span>
<a name="line-42"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWiredInName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mv_map</span>  <span class='hs-comment'>-- ignore wired-in names</span>
<a name="line-43"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-44"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-45"></a>             <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isSystemName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>mv_map</span>
<a name="line-46"></a>                <span class='hs-comment'>-- See Note [Internal used_names]</span>
<a name="line-47"></a>
<a name="line-48"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- This lambda function is really just a</span>
<a name="line-49"></a>                         <span class='hs-comment'>-- specialised (++); originally came about to</span>
<a name="line-50"></a>                         <span class='hs-comment'>-- avoid quadratic behaviour (trac #2680)</span>
<a name="line-51"></a>                         <span class='hs-varid'>extendModuleEnvWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varid'>mv_map</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>occ</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>                <span class='hs-keyword'>where</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-53"></a>
<a name="line-54"></a>    <span class='hs-comment'>-- We want to create a Usage for a home module if</span>
<a name="line-55"></a>    <span class='hs-comment'>--  a) we used something from it; has something in used_names</span>
<a name="line-56"></a>    <span class='hs-comment'>--  b) we imported it, even if we used nothing from it</span>
<a name="line-57"></a>    <span class='hs-comment'>--     (need to recompile if its export list changes: export_fprint)</span>
<a name="line-58"></a>    <span class='hs-varid'>mkUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Usage</span>
<a name="line-59"></a>    <span class='hs-varid'>mkUsage</span> <span class='hs-varid'>mod</span>
<a name="line-60"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>maybe_iface</span>           <span class='hs-comment'>-- We can't depend on it if we didn't</span>
<a name="line-61"></a>                                        <span class='hs-comment'>-- load its interface.</span>
<a name="line-62"></a>      <span class='hs-varop'>||</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_mod</span>                <span class='hs-comment'>-- We don't care about usages of</span>
<a name="line-63"></a>                                        <span class='hs-comment'>-- things in *this* module</span>
<a name="line-64"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-65"></a>
<a name="line-66"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>this_pkg</span>
<a name="line-67"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>UsagePackageModule</span><span class='hs-layout'>{</span> <span class='hs-varid'>usg_mod</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span>
<a name="line-68"></a>                                 <span class='hs-varid'>usg_mod_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_hash</span><span class='hs-layout'>,</span>
<a name="line-69"></a>                                 <span class='hs-varid'>usg_safe</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_safe</span> <span class='hs-layout'>}</span>
<a name="line-70"></a>        <span class='hs-comment'>-- for package modules, we record the module hash only</span>
<a name="line-71"></a>
<a name="line-72"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>used_occs</span>
<a name="line-73"></a>          <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>export_hash</span>
<a name="line-74"></a>          <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_direct_import</span>
<a name="line-75"></a>          <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>finsts_mod</span><span class='hs-layout'>)</span>
<a name="line-76"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>                 <span class='hs-comment'>-- Record no usage info</span>
<a name="line-77"></a>        <span class='hs-comment'>-- for directly-imported modules, we always want to record a usage</span>
<a name="line-78"></a>        <span class='hs-comment'>-- on the orphan hash.  This is what triggers a recompilation if</span>
<a name="line-79"></a>        <span class='hs-comment'>-- an orphan is added or removed somewhere below us in the future.</span>
<a name="line-80"></a>
<a name="line-81"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-82"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>UsageHomeModule</span> <span class='hs-layout'>{</span>
<a name="line-83"></a>                      <span class='hs-varid'>usg_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span>
<a name="line-84"></a>                      <span class='hs-varid'>usg_mod_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_hash</span><span class='hs-layout'>,</span>
<a name="line-85"></a>                      <span class='hs-varid'>usg_exports</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>export_hash</span><span class='hs-layout'>,</span>
<a name="line-86"></a>                      <span class='hs-varid'>usg_entities</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>ent_hashs</span><span class='hs-layout'>,</span>
<a name="line-87"></a>                      <span class='hs-varid'>usg_safe</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_safe</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>      <span class='hs-keyword'>where</span>
<a name="line-89"></a>        <span class='hs-varid'>maybe_iface</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupIfaceByModule</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hpt</span> <span class='hs-varid'>pit</span> <span class='hs-varid'>mod</span>
<a name="line-90"></a>                <span class='hs-comment'>-- In one-shot mode, the interfaces for home-package</span>
<a name="line-91"></a>                <span class='hs-comment'>-- modules accumulate in the PIT not HPT.  Sigh.</span>
<a name="line-92"></a>
<a name="line-93"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe_iface</span>
<a name="line-94"></a>        <span class='hs-varid'>finsts_mod</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_finsts</span>    <span class='hs-varid'>iface</span>
<a name="line-95"></a>        <span class='hs-varid'>hash_env</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_hash_fn</span>   <span class='hs-varid'>iface</span>
<a name="line-96"></a>        <span class='hs-varid'>mod_hash</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_mod_hash</span>  <span class='hs-varid'>iface</span>
<a name="line-97"></a>        <span class='hs-varid'>export_hash</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>depend_on_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_exp_hash</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-98"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-99"></a>
<a name="line-100"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>is_direct_import</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_safe</span><span class='hs-layout'>)</span>
<a name="line-101"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupModuleEnv</span> <span class='hs-varid'>direct_imports</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>of</span>
<a name="line-102"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>safe</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-sel'>_xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-keyword'>safe</span><span class='hs-layout'>)</span>
<a name="line-103"></a>                <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkUsage: empty direct import"</span> <span class='hs-varid'>empty</span>
<a name="line-104"></a>                <span class='hs-conid'>Nothing</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>safeImplicitImpsReq</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-105"></a>                <span class='hs-comment'>-- Nothing case is for implicit imports like 'System.IO' when 'putStrLn'</span>
<a name="line-106"></a>                <span class='hs-comment'>-- is used in the source code. We require them to be safe in Safe Haskell</span>
<a name="line-107"></a>
<a name="line-108"></a>        <span class='hs-varid'>used_occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupModuleEnv</span> <span class='hs-varid'>ent_map</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-109"></a>
<a name="line-110"></a>        <span class='hs-comment'>-- Making a Map here ensures that (a) we remove duplicates</span>
<a name="line-111"></a>        <span class='hs-comment'>-- when we have usages on several subordinates of a single parent,</span>
<a name="line-112"></a>        <span class='hs-comment'>-- and (b) that the usages emerge in a canonical order, which</span>
<a name="line-113"></a>        <span class='hs-comment'>-- is why we use Map rather than OccEnv: Map works</span>
<a name="line-114"></a>        <span class='hs-comment'>-- using Ord on the OccNames, which is a lexicographic ordering.</span>
<a name="line-115"></a>        <span class='hs-varid'>ent_hashs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>OccName</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-116"></a>        <span class='hs-varid'>ent_hashs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>lookup_occ</span> <span class='hs-varid'>used_occs</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>        <span class='hs-varid'>lookup_occ</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span>
<a name="line-119"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>hash_env</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>of</span>
<a name="line-120"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkUsage"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>used_names</span><span class='hs-layout'>)</span>
<a name="line-121"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span>
<a name="line-122"></a>
<a name="line-123"></a>        <span class='hs-varid'>depend_on_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_direct_import</span>
<a name="line-124"></a>        <span class='hs-comment'>{- True
<a name="line-125"></a>              Even if we used 'import M ()', we have to register a
<a name="line-126"></a>              usage on the export list because we are sensitive to
<a name="line-127"></a>              changes in orphan instances/rules.
<a name="line-128"></a>           False
<a name="line-129"></a>              In GHC 6.8.x we always returned true, and in
<a name="line-130"></a>              fact it recorded a dependency on *all* the
<a name="line-131"></a>              modules underneath in the dependency tree.  This
<a name="line-132"></a>              happens to make orphans work right, but is too
<a name="line-133"></a>              expensive: it'll read too many interface files.
<a name="line-134"></a>              The 'isNothing maybe_iface' check above saved us
<a name="line-135"></a>              from generating many of these usages (at least in
<a name="line-136"></a>              one-shot mode), but that's even more bogus!
<a name="line-137"></a>        -}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="mkIfaceAnnotation"></a><span class='hs-definition'>mkIfaceAnnotation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Annotation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceAnnotation</span>
<a name="line-2"></a><span class='hs-definition'>mkIfaceAnnotation</span> <span class='hs-layout'>(</span><span class='hs-conid'>Annotation</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ann_target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span> <span class='hs-varid'>ann_value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>payload</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAnnotation</span> <span class='hs-layout'>{</span>
<a name="line-4"></a>        <span class='hs-varid'>ifAnnotatedTarget</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>target</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>ifAnnotatedValue</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>payload</span>
<a name="line-6"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="mkIfaceExports"></a><span class='hs-definition'>mkIfaceExports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfaceExport</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Sort to make canonical</span>
<a name="line-2"></a><span class='hs-definition'>mkIfaceExports</span> <span class='hs-varid'>exports</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableAvailCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>sort_subs</span> <span class='hs-varid'>exports</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span>
<a name="line-6"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Avail</span> <span class='hs-varid'>n</span>
<a name="line-7"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-conid'>[]</span>
<a name="line-8"></a>    <span class='hs-varid'>sort_subs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-varid'>m</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableNameCmp</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-10"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AvailTC</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortBy</span> <span class='hs-varid'>stableNameCmp</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-comment'>-- Maintain the AvailTC Invariant</span>
</pre>\end{code}

Note [Orignal module]
~~~~~~~~~~~~~~~~~~~~~
Consider this:
        module X where { data family T }
        module Y( T(..) ) where { import X; data instance T Int = MkT Int }
The exported Avail from Y will look like
        X.T{X.T, Y.MkT}
That is, in Y,
  - only MkT is brought into scope by the data instance;
  - but the parent (used for grouping and naming in T(..) exports) is X.T
  - and in this case we export X.T too

In the result of MkIfaceExports, the names are grouped by defining module,
so we may need to split up a single Avail into multiple ones.

Note [Internal used_names]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Most of the used_names are External Names, but we can have Internal
Names too: see Note [Binders in Template Haskell] in Convert, and
Trac #5362 for an example.  Such Names are always
  - Such Names are always for locally-defined things, for which we
    don't gather usage info, so we can just ignore them in ent_map
  - They are always System Names, hence the assert, just as a double check.


%************************************************************************
%*                                                                      *
        Load the old interface file for this module (unless
        we have it already), and check whether it is up to date
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="RecompileRequired"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UpToDate</span>
<a name="line-3"></a>       <span class='hs-comment'>-- ^ everything is up to date, recompilation is not required</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MustCompile</span>
<a name="line-5"></a>       <span class='hs-comment'>-- ^ The .hs file has been touched, or the .o/.hi file does not exist</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecompBecause</span> <span class='hs-conid'>String</span>
<a name="line-7"></a>       <span class='hs-comment'>-- ^ The .o/.hi files are up to date, but something else has changed</span>
<a name="line-8"></a>       <span class='hs-comment'>-- to force recompilation; the String says what (one-line summary)</span>
<a name="line-9"></a>   <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="recompileRequired"></a><span class='hs-definition'>recompileRequired</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecompileRequired</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-12"></a><span class='hs-definition'>recompileRequired</span> <span class='hs-conid'>UpToDate</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-13"></a><span class='hs-definition'>recompileRequired</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-14"></a>
<a name="line-15"></a>
<a name="line-16"></a>
<a name="line-17"></a><a name="checkOldIface"></a><span class='hs-comment'>-- | Top level function to check if the version of an old interface file</span>
<a name="line-18"></a><span class='hs-comment'>-- is equivalent to the current source file the user asked us to compile.</span>
<a name="line-19"></a><span class='hs-comment'>-- If the same, we can avoid recompilation. We return a tuple where the</span>
<a name="line-20"></a><span class='hs-comment'>-- first element is a bool saying if we should recompile the object file</span>
<a name="line-21"></a><span class='hs-comment'>-- and the second is maybe the interface file, where Nothng means to</span>
<a name="line-22"></a><span class='hs-comment'>-- rebuild the interface file not use the exisitng one.</span>
<a name="line-23"></a><span class='hs-definition'>checkOldIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-24"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span>
<a name="line-25"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SourceModified</span>
<a name="line-26"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span>         <span class='hs-comment'>-- Old interface from compilation manager, if any</span>
<a name="line-27"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompileRequired</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>checkOldIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>source_modified</span> <span class='hs-varid'>maybe_iface</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-31"></a>        <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-32"></a>            <span class='hs-str'>"Checking old interface for "</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>showPpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span>
<a name="line-33"></a>        <span class='hs-varid'>initIfaceCheck</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-34"></a>            <span class='hs-varid'>check_old_iface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>source_modified</span> <span class='hs-varid'>maybe_iface</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="check_old_iface"></a><span class='hs-definition'>check_old_iface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SourceModified</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span>
<a name="line-37"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompileRequired</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-definition'>check_old_iface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>src_modified</span> <span class='hs-varid'>maybe_iface</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-40"></a>        <span class='hs-varid'>getIface</span> <span class='hs-keyglyph'>=</span>
<a name="line-41"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_iface</span> <span class='hs-keyword'>of</span>
<a name="line-42"></a>                <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-43"></a>                    <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"We already have the old interface for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>                    <span class='hs-varid'>return</span> <span class='hs-varid'>maybe_iface</span>
<a name="line-45"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loadIface</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-varid'>loadIface</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-48"></a>             <span class='hs-keyword'>let</span> <span class='hs-varid'>iface_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msHiFilePath</span> <span class='hs-varid'>mod_summary</span>
<a name="line-49"></a>             <span class='hs-varid'>read_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIface</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span> <span class='hs-varid'>iface_path</span>
<a name="line-50"></a>             <span class='hs-keyword'>case</span> <span class='hs-varid'>read_result</span> <span class='hs-keyword'>of</span>
<a name="line-51"></a>                 <span class='hs-conid'>Failed</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-52"></a>                     <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"FYI: cannot read old interface file:"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-53"></a>                     <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-54"></a>                 <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-55"></a>                     <span class='hs-varid'>traceIf</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Read the interface file"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>iface_path</span><span class='hs-layout'>)</span>
<a name="line-56"></a>                     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span>
<a name="line-57"></a>
<a name="line-58"></a>        <span class='hs-varid'>src_changed</span>
<a name="line-59"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ForceRecomp</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-60"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SourceModified</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>src_modified</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-61"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-62"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span>
<a name="line-63"></a>        <span class='hs-varid'>when</span> <span class='hs-varid'>src_changed</span> <span class='hs-varop'>$</span>
<a name="line-64"></a>            <span class='hs-varid'>traceHiDiffs</span> <span class='hs-layout'>(</span><span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Source file changed or recompilation check turned off"</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>src_changed</span> <span class='hs-keyword'>of</span>
<a name="line-67"></a>            <span class='hs-comment'>-- If the source has changed and we're in interactive mode,</span>
<a name="line-68"></a>            <span class='hs-comment'>-- avoid reading an interface; just return the one we might</span>
<a name="line-69"></a>            <span class='hs-comment'>-- have been supplied with.</span>
<a name="line-70"></a>            <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isObjectTarget</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscTarget</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-71"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MustCompile</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_iface</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a>            <span class='hs-comment'>-- Try and read the old interface for the current module</span>
<a name="line-74"></a>            <span class='hs-comment'>-- from the .hi file left from the last time we compiled it</span>
<a name="line-75"></a>            <span class='hs-conid'>True</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-76"></a>                <span class='hs-varid'>maybe_iface'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getIface</span>
<a name="line-77"></a>                <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MustCompile</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_iface'</span><span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a>            <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-80"></a>                <span class='hs-varid'>maybe_iface'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getIface</span>
<a name="line-81"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_iface'</span> <span class='hs-keyword'>of</span>
<a name="line-82"></a>                    <span class='hs-comment'>-- We can't retrieve the iface</span>
<a name="line-83"></a>                    <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MustCompile</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a>                    <span class='hs-comment'>-- We have got the old iface; check its versions</span>
<a name="line-86"></a>                    <span class='hs-comment'>-- even in the SourceUnmodifiedAndStable case we</span>
<a name="line-87"></a>                    <span class='hs-comment'>-- should check versions because some packages</span>
<a name="line-88"></a>                    <span class='hs-comment'>-- might have changed or gone away.</span>
<a name="line-89"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkVersions</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>iface</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="checkVersions"></a><span class='hs-comment'>-- | Check if a module is still the same 'version'.</span>
<a name="line-92"></a><span class='hs-comment'>--</span>
<a name="line-93"></a><span class='hs-comment'>-- This function is called in the recompilation checker after we have</span>
<a name="line-94"></a><span class='hs-comment'>-- determined that the module M being checked hasn't had any changes</span>
<a name="line-95"></a><span class='hs-comment'>-- to its source file since we last compiled M. So at this point in general</span>
<a name="line-96"></a><span class='hs-comment'>-- two things may have changed that mean we should recompile M:</span>
<a name="line-97"></a><span class='hs-comment'>--   * The interface export by a dependency of M has changed.</span>
<a name="line-98"></a><span class='hs-comment'>--   * The compiler flags specified this time for M have changed</span>
<a name="line-99"></a><span class='hs-comment'>--     in a manner that is significant for recompilaiton.</span>
<a name="line-100"></a><span class='hs-comment'>-- We return not just if we should recompile the object file but also</span>
<a name="line-101"></a><span class='hs-comment'>-- if we should rebuild the interface file.</span>
<a name="line-102"></a><span class='hs-definition'>checkVersions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-103"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span>
<a name="line-104"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span>       <span class='hs-comment'>-- Old interface</span>
<a name="line-105"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompileRequired</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-106"></a><span class='hs-definition'>checkVersions</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>iface</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceHiDiffs</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Considering whether compilation is required for"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-108"></a>                        <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>recomp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkFlagHash</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>iface</span>
<a name="line-111"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>recompileRequired</span> <span class='hs-varid'>recomp</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>recomp</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>recomp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkDependencies</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>iface</span>
<a name="line-113"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>recompileRequired</span> <span class='hs-varid'>recomp</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>recomp</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-114"></a>
<a name="line-115"></a>       <span class='hs-comment'>-- Source code unchanged and no errors yet... carry on</span>
<a name="line-116"></a>       <span class='hs-comment'>--</span>
<a name="line-117"></a>       <span class='hs-comment'>-- First put the dependent-module info, read from the old</span>
<a name="line-118"></a>       <span class='hs-comment'>-- interface, into the envt, so that when we look for</span>
<a name="line-119"></a>       <span class='hs-comment'>-- interfaces we look for the right one (.hi or .hi-boot)</span>
<a name="line-120"></a>       <span class='hs-comment'>--</span>
<a name="line-121"></a>       <span class='hs-comment'>-- It's just temporary because either the usage check will succeed</span>
<a name="line-122"></a>       <span class='hs-comment'>-- (in which case we are done with this module) or it'll fail (in which</span>
<a name="line-123"></a>       <span class='hs-comment'>-- case we'll compile the module from scratch anyhow).</span>
<a name="line-124"></a>       <span class='hs-comment'>--</span>
<a name="line-125"></a>       <span class='hs-comment'>-- We do this regardless of compilation mode, although in --make mode</span>
<a name="line-126"></a>       <span class='hs-comment'>-- all the dependent modules should be in the HPT already, so it's</span>
<a name="line-127"></a>       <span class='hs-comment'>-- quite redundant</span>
<a name="line-128"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updateEps_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>eps</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>eps</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eps_is_boot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_deps</span> <span class='hs-layout'>}</span>
<a name="line-129"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>recomp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkList</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>checkModUsage</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mi_usages</span> <span class='hs-varid'>iface</span><span class='hs-keyglyph'>]</span>
<a name="line-130"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>recomp</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-131"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-132"></a>  <span class='hs-keyword'>where</span>
<a name="line-133"></a>    <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-134"></a>    <span class='hs-comment'>-- This is a bit of a hack really</span>
<a name="line-135"></a>    <span class='hs-varid'>mod_deps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span>
<a name="line-136"></a>    <span class='hs-varid'>mod_deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModDeps</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-137"></a>
<a name="line-138"></a><a name="checkFlagHash"></a><span class='hs-comment'>-- | Check the flags haven't changed</span>
<a name="line-139"></a><span class='hs-definition'>checkFlagHash</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-140"></a><span class='hs-definition'>checkFlagHash</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-141"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>old_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_flag_hash</span> <span class='hs-varid'>iface</span>
<a name="line-142"></a>    <span class='hs-varid'>new_hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fingerprintDynFlags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-143"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>mi_module</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-144"></a>                                             <span class='hs-varid'>putNameLiterally</span>
<a name="line-145"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>old_hash</span> <span class='hs-varop'>==</span> <span class='hs-varid'>new_hash</span> <span class='hs-keyword'>of</span>
<a name="line-146"></a>        <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>up_to_date</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"Module flags unchanged"</span><span class='hs-layout'>)</span>
<a name="line-147"></a>        <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>out_of_date_hash</span> <span class='hs-str'>"flags changed"</span>
<a name="line-148"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"  Module flags have changed"</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                     <span class='hs-varid'>old_hash</span> <span class='hs-varid'>new_hash</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="checkDependencies"></a><span class='hs-comment'>-- If the direct imports of this module are resolved to targets that</span>
<a name="line-152"></a><span class='hs-comment'>-- are not among the dependencies of the previous interface file,</span>
<a name="line-153"></a><span class='hs-comment'>-- then we definitely need to recompile.  This catches cases like</span>
<a name="line-154"></a><span class='hs-comment'>--   - an exposed package has been upgraded</span>
<a name="line-155"></a><span class='hs-comment'>--   - we are compiling with different package flags</span>
<a name="line-156"></a><span class='hs-comment'>--   - a home module that was shadowing a package module has been removed</span>
<a name="line-157"></a><span class='hs-comment'>--   - a new home module has been added that shadows a package module</span>
<a name="line-158"></a><span class='hs-comment'>-- See bug #1372.</span>
<a name="line-159"></a><span class='hs-comment'>--</span>
<a name="line-160"></a><span class='hs-comment'>-- Returns True if recompilation is required.</span>
<a name="line-161"></a><span class='hs-definition'>checkDependencies</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-162"></a><span class='hs-definition'>checkDependencies</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>summary</span> <span class='hs-varid'>iface</span>
<a name="line-163"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>dep_missing</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_imps</span> <span class='hs-varid'>summary</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ms_srcimps</span> <span class='hs-varid'>summary</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-164"></a>  <span class='hs-keyword'>where</span>
<a name="line-165"></a>   <span class='hs-varid'>prev_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-166"></a>   <span class='hs-varid'>prev_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-167"></a>
<a name="line-168"></a>   <span class='hs-varid'>this_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-169"></a>
<a name="line-170"></a>   <span class='hs-varid'>dep_missing</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ideclName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>ideclPkgQual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkg</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-171"></a>     <span class='hs-varid'>find_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findImportedModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>pkg</span>
<a name="line-172"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>++</span> <span class='hs-str'>" changed"</span>
<a name="line-173"></a>     <span class='hs-keyword'>case</span> <span class='hs-varid'>find_res</span> <span class='hs-keyword'>of</span>
<a name="line-174"></a>        <span class='hs-conid'>Found</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mod</span>
<a name="line-175"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_pkg</span>
<a name="line-176"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>`notElem`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>prev_dep_mods</span>
<a name="line-177"></a>                 <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>traceHiDiffs</span> <span class='hs-varop'>$</span>
<a name="line-178"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>"imported module "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-179"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>" not among previous dependencies"</span>
<a name="line-180"></a>                         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompBecause</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span>
<a name="line-181"></a>                 <span class='hs-keyword'>else</span>
<a name="line-182"></a>                         <span class='hs-varid'>return</span> <span class='hs-conid'>UpToDate</span>
<a name="line-183"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-184"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>pkg</span> <span class='hs-varop'>`notElem`</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>prev_dep_pkgs</span><span class='hs-layout'>)</span>
<a name="line-185"></a>                 <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>traceHiDiffs</span> <span class='hs-varop'>$</span>
<a name="line-186"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>"imported module "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-187"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>" is from package "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-188"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>", which is not among previous dependencies"</span>
<a name="line-189"></a>                         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompBecause</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span>
<a name="line-190"></a>                 <span class='hs-keyword'>else</span>
<a name="line-191"></a>                         <span class='hs-varid'>return</span> <span class='hs-conid'>UpToDate</span>
<a name="line-192"></a>           <span class='hs-keyword'>where</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modulePackageId</span> <span class='hs-varid'>mod</span>
<a name="line-193"></a>        <span class='hs-sel'>_otherwise</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompBecause</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="needInterface"></a><span class='hs-definition'>needInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span><span class='hs-layout'>)</span>
<a name="line-196"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-197"></a><span class='hs-definition'>needInterface</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>continue</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-comment'>-- Load the imported interface if possible</span>
<a name="line-199"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>doc_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"need version info for"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-keyglyph'>]</span>
<a name="line-200"></a>    <span class='hs-varid'>traceHiDiffs</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Checking usages for module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-201"></a>
<a name="line-202"></a>    <span class='hs-varid'>mb_iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadInterface</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>mod</span> <span class='hs-conid'>ImportBySystem</span>
<a name="line-203"></a>        <span class='hs-comment'>-- Load the interface, but don't complain on failure;</span>
<a name="line-204"></a>        <span class='hs-comment'>-- Instead, get an Either back which we can test</span>
<a name="line-205"></a>
<a name="line-206"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_iface</span> <span class='hs-keyword'>of</span>
<a name="line-207"></a>      <span class='hs-conid'>Failed</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-208"></a>        <span class='hs-varid'>traceHiDiffs</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't load interface for module"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-209"></a>                           <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-210"></a>        <span class='hs-varid'>return</span> <span class='hs-conid'>MustCompile</span>
<a name="line-211"></a>                  <span class='hs-comment'>-- Couldn't find or parse a module mentioned in the</span>
<a name="line-212"></a>                  <span class='hs-comment'>-- old interface file.  Don't complain: it might</span>
<a name="line-213"></a>                  <span class='hs-comment'>-- just be that the current module doesn't need that</span>
<a name="line-214"></a>                  <span class='hs-comment'>-- import and it's been deleted</span>
<a name="line-215"></a>      <span class='hs-conid'>Succeeded</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>continue</span> <span class='hs-varid'>iface</span>
<a name="line-216"></a>
<a name="line-217"></a>
<a name="line-218"></a><a name="checkModUsage"></a><span class='hs-comment'>-- | Given the usage information extracted from the old</span>
<a name="line-219"></a><span class='hs-comment'>-- M.hi file for the module being compiled, figure out</span>
<a name="line-220"></a><span class='hs-comment'>-- whether M needs to be recompiled.</span>
<a name="line-221"></a><span class='hs-definition'>checkModUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Usage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-222"></a><span class='hs-definition'>checkModUsage</span> <span class='hs-sel'>_this_pkg</span> <span class='hs-conid'>UsagePackageModule</span><span class='hs-layout'>{</span>
<a name="line-223"></a>                                <span class='hs-varid'>usg_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span>
<a name="line-224"></a>                                <span class='hs-varid'>usg_mod_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_mod_hash</span> <span class='hs-layout'>}</span>
<a name="line-225"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needInterface</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-226"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" changed"</span>
<a name="line-227"></a>    <span class='hs-varid'>checkModuleFingerprint</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>old_mod_hash</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_mod_hash</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-228"></a>        <span class='hs-comment'>-- We only track the ABI hash of package modules, rather than</span>
<a name="line-229"></a>        <span class='hs-comment'>-- individual entity usages, so if the ABI hash changes we must</span>
<a name="line-230"></a>        <span class='hs-comment'>-- recompile.  This is safe but may entail more recompilation when</span>
<a name="line-231"></a>        <span class='hs-comment'>-- a dependent package has changed.</span>
<a name="line-232"></a>
<a name="line-233"></a><span class='hs-definition'>checkModUsage</span> <span class='hs-varid'>this_pkg</span> <span class='hs-conid'>UsageHomeModule</span><span class='hs-layout'>{</span>
<a name="line-234"></a>                                <span class='hs-varid'>usg_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_name</span><span class='hs-layout'>,</span>
<a name="line-235"></a>                                <span class='hs-varid'>usg_mod_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_mod_hash</span><span class='hs-layout'>,</span>
<a name="line-236"></a>                                <span class='hs-varid'>usg_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe_old_export_hash</span><span class='hs-layout'>,</span>
<a name="line-237"></a>                                <span class='hs-varid'>usg_entities</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_decl_hash</span> <span class='hs-layout'>}</span>
<a name="line-238"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-239"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModule</span> <span class='hs-varid'>this_pkg</span> <span class='hs-varid'>mod_name</span>
<a name="line-240"></a>    <span class='hs-varid'>needInterface</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-241"></a>
<a name="line-242"></a>    <span class='hs-keyword'>let</span>
<a name="line-243"></a>        <span class='hs-varid'>new_mod_hash</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_mod_hash</span>    <span class='hs-varid'>iface</span>
<a name="line-244"></a>        <span class='hs-varid'>new_decl_hash</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_hash_fn</span>     <span class='hs-varid'>iface</span>
<a name="line-245"></a>        <span class='hs-varid'>new_export_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_exp_hash</span>    <span class='hs-varid'>iface</span>
<a name="line-246"></a>
<a name="line-247"></a>        <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleNameString</span> <span class='hs-varid'>mod_name</span> <span class='hs-varop'>++</span> <span class='hs-str'>" changed"</span>
<a name="line-248"></a>
<a name="line-249"></a>        <span class='hs-comment'>-- CHECK MODULE</span>
<a name="line-250"></a>    <span class='hs-varid'>recompile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkModuleFingerprint</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>old_mod_hash</span> <span class='hs-varid'>new_mod_hash</span>
<a name="line-251"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>recompileRequired</span> <span class='hs-varid'>recompile</span><span class='hs-layout'>)</span>
<a name="line-252"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>UpToDate</span>
<a name="line-253"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-254"></a>
<a name="line-255"></a>        <span class='hs-comment'>-- CHECK EXPORT LIST</span>
<a name="line-256"></a>        <span class='hs-varid'>checkMaybeHash</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>maybe_old_export_hash</span> <span class='hs-varid'>new_export_hash</span>
<a name="line-257"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"  Export list changed"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-258"></a>
<a name="line-259"></a>        <span class='hs-comment'>-- CHECK ITEMS ONE BY ONE</span>
<a name="line-260"></a>        <span class='hs-varid'>recompile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkList</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>checkEntityUsage</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>new_decl_hash</span> <span class='hs-varid'>u</span>
<a name="line-261"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_decl_hash</span><span class='hs-keyglyph'>]</span>
<a name="line-262"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>recompileRequired</span> <span class='hs-varid'>recompile</span>
<a name="line-263"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>recompile</span>     <span class='hs-comment'>-- This one failed, so just bail out now</span>
<a name="line-264"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>up_to_date</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"  Great!  The bits I use are up to date"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-265"></a>
<a name="line-266"></a>
<a name="line-267"></a><span class='hs-definition'>checkModUsage</span> <span class='hs-sel'>_this_pkg</span> <span class='hs-conid'>UsageFile</span><span class='hs-layout'>{</span> <span class='hs-varid'>usg_file_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>file</span><span class='hs-layout'>,</span>
<a name="line-268"></a>                                   <span class='hs-varid'>usg_file_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_hash</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-269"></a>  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-270"></a>    <span class='hs-varid'>handleIO</span> <span class='hs-varid'>handle</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-271"></a>      <span class='hs-varid'>new_hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFileHash</span> <span class='hs-varid'>file</span>
<a name="line-272"></a>      <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_hash</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>new_hash</span><span class='hs-layout'>)</span>
<a name="line-273"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>recomp</span>
<a name="line-274"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>UpToDate</span>
<a name="line-275"></a> <span class='hs-keyword'>where</span>
<a name="line-276"></a>   <span class='hs-varid'>recomp</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecompBecause</span> <span class='hs-layout'>(</span><span class='hs-varid'>file</span> <span class='hs-varop'>++</span> <span class='hs-str'>" changed"</span><span class='hs-layout'>)</span>
<a name="line-277"></a>   <span class='hs-varid'>handle</span> <span class='hs-keyglyph'>=</span>
<a name="line-278"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-279"></a>       <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"UsageFile"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-varid'>recomp</span>
<a name="line-280"></a><span class='hs-cpp'>#else</span>
<a name="line-281"></a>       <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>recomp</span> <span class='hs-comment'>-- if we can't find the file, just recompile, don't fail</span>
<a name="line-282"></a><span class='hs-cpp'>#endif</span>
<a name="line-283"></a>
<a name="line-284"></a><a name="checkModuleFingerprint"></a><span class='hs-comment'>------------------------</span>
<a name="line-285"></a><span class='hs-definition'>checkModuleFingerprint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-286"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-287"></a><span class='hs-definition'>checkModuleFingerprint</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>old_mod_hash</span> <span class='hs-varid'>new_mod_hash</span>
<a name="line-288"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_mod_hash</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_mod_hash</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>up_to_date</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Module fingerprint unchanged"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-290"></a>
<a name="line-291"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>out_of_date_hash</span> <span class='hs-varid'>reason</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"  Module fingerprint has changed"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-293"></a>                     <span class='hs-varid'>old_mod_hash</span> <span class='hs-varid'>new_mod_hash</span>
<a name="line-294"></a>
<a name="line-295"></a><a name="checkMaybeHash"></a><span class='hs-comment'>------------------------</span>
<a name="line-296"></a><span class='hs-definition'>checkMaybeHash</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-297"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-298"></a><span class='hs-definition'>checkMaybeHash</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>maybe_old_hash</span> <span class='hs-varid'>new_hash</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>continue</span>
<a name="line-299"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>hash</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_old_hash</span><span class='hs-layout'>,</span> <span class='hs-varid'>hash</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>new_hash</span>
<a name="line-300"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>out_of_date_hash</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>hash</span> <span class='hs-varid'>new_hash</span>
<a name="line-301"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-302"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>continue</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="checkEntityUsage"></a><span class='hs-comment'>------------------------</span>
<a name="line-305"></a><span class='hs-definition'>checkEntityUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>
<a name="line-306"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-307"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccName</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span>
<a name="line-308"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-309"></a><span class='hs-definition'>checkEntityUsage</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>new_hash</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>old_hash</span><span class='hs-layout'>)</span>
<a name="line-310"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>new_hash</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-311"></a>
<a name="line-312"></a>        <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span>        <span class='hs-comment'>-- We used it before, but it ain't there now</span>
<a name="line-313"></a>                          <span class='hs-varid'>out_of_date</span> <span class='hs-varid'>reason</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No longer exported:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-314"></a>
<a name="line-315"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_hash</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- It's there, but is it up to date?</span>
<a name="line-316"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_hash</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_hash</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>traceHiDiffs</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"  Up to date"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_hash</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-317"></a>                                       <span class='hs-varid'>return</span> <span class='hs-conid'>UpToDate</span>
<a name="line-318"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>out_of_date_hash</span> <span class='hs-varid'>reason</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"  Out of date:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-319"></a>                                                     <span class='hs-varid'>old_hash</span> <span class='hs-varid'>new_hash</span>
<a name="line-320"></a>
<a name="line-321"></a><a name="up_to_date"></a><span class='hs-definition'>up_to_date</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-322"></a><span class='hs-definition'>up_to_date</span>  <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceHiDiffs</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>UpToDate</span>
<a name="line-323"></a>
<a name="line-324"></a><a name="out_of_date"></a><span class='hs-definition'>out_of_date</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-325"></a><span class='hs-definition'>out_of_date</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceHiDiffs</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompBecause</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="out_of_date_hash"></a><span class='hs-definition'>out_of_date_hash</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-328"></a><span class='hs-definition'>out_of_date_hash</span> <span class='hs-varid'>reason</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>old_hash</span> <span class='hs-varid'>new_hash</span>
<a name="line-329"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>out_of_date</span> <span class='hs-varid'>reason</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>old_hash</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-&gt;"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_hash</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-330"></a>
<a name="line-331"></a><a name="checkList"></a><span class='hs-comment'>----------------------</span>
<a name="line-332"></a><span class='hs-definition'>checkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>RecompileRequired</span>
<a name="line-333"></a><span class='hs-comment'>-- This helper is used in two places</span>
<a name="line-334"></a><span class='hs-definition'>checkList</span> <span class='hs-conid'>[]</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>UpToDate</span>
<a name="line-335"></a><span class='hs-definition'>checkList</span> <span class='hs-layout'>(</span><span class='hs-varid'>check</span><span class='hs-conop'>:</span><span class='hs-varid'>checks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>recompile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>check</span>
<a name="line-336"></a>                              <span class='hs-keyword'>if</span> <span class='hs-varid'>recompileRequired</span> <span class='hs-varid'>recompile</span>
<a name="line-337"></a>                                <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>recompile</span>
<a name="line-338"></a>                                <span class='hs-keyword'>else</span> <span class='hs-varid'>checkList</span> <span class='hs-varid'>checks</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Converting things to their Iface equivalents
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tyThingToIfaceDecl"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-2"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idToIfaceDecl</span> <span class='hs-varid'>id</span>
<a name="line-3"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConToIfaceDecl</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>tycon</span>
<a name="line-4"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomToIfaceDecl</span> <span class='hs-varid'>ax</span>
<a name="line-5"></a><span class='hs-definition'>tyThingToIfaceDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-varid'>cl</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cl</span> <span class='hs-keyword'>of</span>
<a name="line-6"></a>    <span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dataConToIfaceDecl</span> <span class='hs-varid'>dc</span> <span class='hs-comment'>-- for ppr purposes only</span>
<a name="line-7"></a>    <span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>patSynToIfaceDecl</span> <span class='hs-varid'>ps</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="idToIfaceDecl"></a><span class='hs-comment'>--------------------------</span>
<a name="line-10"></a><span class='hs-definition'>idToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-11"></a><span class='hs-comment'>-- The Id is already tidied, so that locally-bound names</span>
<a name="line-12"></a><span class='hs-comment'>-- (lambdas, for-alls) already have non-clashing OccNames</span>
<a name="line-13"></a><span class='hs-comment'>-- We can't tidy it here, locally, because it may have</span>
<a name="line-14"></a><span class='hs-comment'>-- free variables in its type or IdInfo</span>
<a name="line-15"></a><span class='hs-definition'>idToIfaceDecl</span> <span class='hs-varid'>id</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span>
<a name="line-17"></a>              <span class='hs-varid'>ifType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-18"></a>              <span class='hs-varid'>ifIdDetails</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceIdDetails</span> <span class='hs-layout'>(</span><span class='hs-varid'>idDetails</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-19"></a>              <span class='hs-varid'>ifIdInfo</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="dataConToIfaceDecl"></a><span class='hs-comment'>--------------------------</span>
<a name="line-22"></a><span class='hs-definition'>dataConToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-23"></a><span class='hs-definition'>dataConToIfaceDecl</span> <span class='hs-varid'>dataCon</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>dataCon</span><span class='hs-layout'>,</span>
<a name="line-25"></a>              <span class='hs-varid'>ifType</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>dataCon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-26"></a>              <span class='hs-varid'>ifIdDetails</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfVanillaId</span><span class='hs-layout'>,</span>
<a name="line-27"></a>              <span class='hs-varid'>ifIdInfo</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoInfo</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="patSynToIfaceDecl"></a><span class='hs-comment'>--------------------------</span>
<a name="line-30"></a><span class='hs-definition'>patSynToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PatSyn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-31"></a><span class='hs-definition'>patSynToIfaceDecl</span> <span class='hs-varid'>ps</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfacePatSyn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ps</span>
<a name="line-33"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatMatcher</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matcher</span>
<a name="line-34"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatWrapper</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapper</span>
<a name="line-35"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatIsInfix</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynIsInfix</span> <span class='hs-varid'>ps</span>
<a name="line-36"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatUnivTvs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>univ_tvs'</span>
<a name="line-37"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatExTvs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>ex_tvs'</span>
<a name="line-38"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatProvCtxt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>prov_theta</span>
<a name="line-39"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatReqCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>req_theta</span>
<a name="line-40"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatArgs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-41"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ifPatTy</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-42"></a>                <span class='hs-layout'>}</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>req_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynSig</span> <span class='hs-varid'>ps</span>
<a name="line-45"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>univ_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndrs</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-46"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndrs</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-varid'>matcher</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynMatcher</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-49"></a>    <span class='hs-varid'>wrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>idName</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynWrapper</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>
<a name="line-52"></a><a name="coAxiomToIfaceDecl"></a><span class='hs-comment'>--------------------------</span>
<a name="line-53"></a><span class='hs-definition'>coAxiomToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-54"></a><span class='hs-comment'>-- We *do* tidy Axioms, because they are not (and cannot</span>
<a name="line-55"></a><span class='hs-comment'>-- conveniently be) built in tidy form</span>
<a name="line-56"></a><span class='hs-definition'>coAxiomToIfaceDecl</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span>
<a name="line-57"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>role</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-58"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-59"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ifTyCon</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-60"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ifRole</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>role</span>
<a name="line-61"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ifAxBranches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brListMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchToIfaceBranch</span>
<a name="line-62"></a>                                            <span class='hs-varid'>emptyTidyEnv</span>
<a name="line-63"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>brListMap</span> <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span>
<a name="line-64"></a> <span class='hs-keyword'>where</span>
<a name="line-65"></a>   <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>ax</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="coAxBranchToIfaceBranch"></a><span class='hs-comment'>-- 2nd parameter is the list of branch LHSs, for conversion from incompatible branches</span>
<a name="line-68"></a><span class='hs-comment'>-- to incompatible indices</span>
<a name="line-69"></a><span class='hs-comment'>-- See [Storing compatibility] in CoAxiom</span>
<a name="line-70"></a><span class='hs-definition'>coAxBranchToIfaceBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceAxBranch</span>
<a name="line-71"></a><span class='hs-definition'>coAxBranchToIfaceBranch</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>lhs_s</span>
<a name="line-72"></a>                        <span class='hs-varid'>branch</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>incomps</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchToIfaceBranch'</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>branch</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifaxbIncomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iface_incomps</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>  <span class='hs-keyword'>where</span>
<a name="line-75"></a>    <span class='hs-varid'>iface_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"iface_incomps"</span>
<a name="line-76"></a>                        <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>findIndex</span> <span class='hs-varid'>lhs_s</span>
<a name="line-77"></a>                          <span class='hs-varop'>.</span> <span class='hs-varid'>eqTypes</span><span class='hs-layout'>)</span>
<a name="line-78"></a>                        <span class='hs-varop'>.</span> <span class='hs-varid'>coAxBranchLHS</span><span class='hs-layout'>)</span> <span class='hs-varid'>incomps</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="coAxBranchToIfaceBranch'"></a><span class='hs-comment'>-- use this one for standalone branches without incompatibles</span>
<a name="line-81"></a><span class='hs-definition'>coAxBranchToIfaceBranch'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceAxBranch</span>
<a name="line-82"></a><span class='hs-definition'>coAxBranchToIfaceBranch'</span> <span class='hs-varid'>env0</span>
<a name="line-83"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-84"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifaxbTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-86"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbLHS</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span>
<a name="line-87"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbRoles</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span>
<a name="line-88"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbRHS</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>rhs</span>
<a name="line-89"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>ifaxbIncomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>  <span class='hs-keyword'>where</span>
<a name="line-91"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyClTyVarBndrs</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>tvs</span>
<a name="line-92"></a>    <span class='hs-comment'>-- Don't re-bind in-scope tyvars</span>
<a name="line-93"></a>    <span class='hs-comment'>-- See Note [CoAxBranch type variables] in CoAxiom</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="tyConToIfaceDecl"></a><span class='hs-comment'>-----------------</span>
<a name="line-96"></a><span class='hs-definition'>tyConToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-97"></a><span class='hs-comment'>-- We *do* tidy TyCons, because they are not (and cannot</span>
<a name="line-98"></a><span class='hs-comment'>-- conveniently be) built in tidy form</span>
<a name="line-99"></a><span class='hs-definition'>tyConToIfaceDecl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tycon</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classToIfaceDecl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>clas</span>
<a name="line-102"></a>
<a name="line-103"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>syn_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>synTyConRhs_maybe</span> <span class='hs-varid'>tycon</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceSyn</span> <span class='hs-layout'>{</span>  <span class='hs-varid'>ifName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-105"></a>                <span class='hs-varid'>ifTyVars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span>
<a name="line-106"></a>                <span class='hs-varid'>ifRoles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-107"></a>                <span class='hs-varid'>ifSynRhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>to_ifsyn_rhs</span> <span class='hs-varid'>syn_rhs</span><span class='hs-layout'>,</span>
<a name="line-108"></a>                <span class='hs-varid'>ifSynKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>synTyConResKind</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-112"></a>                <span class='hs-varid'>ifCType</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConCType</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-113"></a>                <span class='hs-varid'>ifTyVars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span>
<a name="line-114"></a>                <span class='hs-varid'>ifRoles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-115"></a>                <span class='hs-varid'>ifCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-116"></a>                <span class='hs-varid'>ifCons</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-varid'>algTyConRhs</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-117"></a>                <span class='hs-varid'>ifRec</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boolToRecFlag</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRecursiveTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-118"></a>                <span class='hs-varid'>ifGadtSyntax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGadtSyntaxTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-119"></a>                <span class='hs-varid'>ifPromotable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>promotableTyCon_maybe</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-120"></a>                <span class='hs-varid'>ifAxiom</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>coAxiomName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-121"></a>
<a name="line-122"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForeignTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceForeign</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifName</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-124"></a>                   <span class='hs-varid'>ifExtName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConExtName</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>}</span>
<a name="line-125"></a>
<a name="line-126"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"toIfaceDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-127"></a>  <span class='hs-keyword'>where</span>
<a name="line-128"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyClTyVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-129"></a>
<a name="line-130"></a>    <span class='hs-varid'>to_ifsyn_rhs</span> <span class='hs-conid'>OpenSynFamilyTyCon</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceOpenSynFamilyTyCon</span>
<a name="line-131"></a>    <span class='hs-varid'>to_ifsyn_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosedSynFamilyTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-132"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceClosedSynFamilyTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-133"></a>    <span class='hs-varid'>to_ifsyn_rhs</span> <span class='hs-conid'>AbstractClosedSynFamilyTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAbstractClosedSynFamilyTyCon</span>
<a name="line-134"></a>    <span class='hs-varid'>to_ifsyn_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>SynonymTyCon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-135"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceSynonymTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a>    <span class='hs-varid'>to_ifsyn_rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuiltInSynFamTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"toIfaceDecl: BuiltInFamTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-138"></a>
<a name="line-139"></a>
<a name="line-140"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewTyCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfNewTyCon</span>  <span class='hs-layout'>(</span><span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-141"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataTyCon</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfDataTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span>
<a name="line-142"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataFamilyTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfDataFamTyCon</span>
<a name="line-143"></a>    <span class='hs-varid'>ifaceConDecls</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbstractTyCon</span> <span class='hs-varid'>distinct</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfAbstractTyCon</span> <span class='hs-varid'>distinct</span>
<a name="line-144"></a>        <span class='hs-comment'>-- The last case happens when a TyCon has been trimmed during tidying</span>
<a name="line-145"></a>        <span class='hs-comment'>-- Furthermore, tyThingToIfaceDecl is also used</span>
<a name="line-146"></a>        <span class='hs-comment'>-- in TcRnDriver for GHCi, when browsing a module, in which case the</span>
<a name="line-147"></a>        <span class='hs-comment'>-- AbstractTyCon case is perfectly sensible.</span>
<a name="line-148"></a>
<a name="line-149"></a>    <span class='hs-varid'>ifaceConDecl</span> <span class='hs-varid'>data_con</span>
<a name="line-150"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfCon</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>ifConOcc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-151"></a>                    <span class='hs-varid'>ifConInfix</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConIsInfix</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>,</span>
<a name="line-152"></a>                    <span class='hs-varid'>ifConWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId_maybe</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-153"></a>                    <span class='hs-varid'>ifConUnivTvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>univ_tvs'</span><span class='hs-layout'>,</span>
<a name="line-154"></a>                    <span class='hs-varid'>ifConExTvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span>
<a name="line-155"></a>                    <span class='hs-varid'>ifConEqSpec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>to_eq_spec</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span>
<a name="line-156"></a>                    <span class='hs-varid'>ifConCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span>
<a name="line-157"></a>                    <span class='hs-varid'>ifConArgTys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span>
<a name="line-158"></a>                    <span class='hs-varid'>ifConFields</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span>
<a name="line-159"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-160"></a>                    <span class='hs-varid'>ifConStricts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceBang</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConRepBangs</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-161"></a>        <span class='hs-keyword'>where</span>
<a name="line-162"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>data_con</span>
<a name="line-163"></a>
<a name="line-164"></a>          <span class='hs-comment'>-- Start with 'emptyTidyEnv' not 'env1', because the type of the</span>
<a name="line-165"></a>          <span class='hs-comment'>-- data constructor is fully standalone</span>
<a name="line-166"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>univ_tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndrs</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-167"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndrs</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-168"></a>          <span class='hs-varid'>to_eq_spec</span> <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyVar</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-169"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>spec</span><span class='hs-keyglyph'>]</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="toIfaceBang"></a><span class='hs-definition'>toIfaceBang</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceBang</span>
<a name="line-172"></a><span class='hs-definition'>toIfaceBang</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>HsNoBang</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfNoBang</span>
<a name="line-173"></a><span class='hs-definition'>toIfaceBang</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfUnpack</span>
<a name="line-174"></a><span class='hs-definition'>toIfaceBang</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfUnpackCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-175"></a><span class='hs-definition'>toIfaceBang</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>HsStrict</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfStrict</span>
<a name="line-176"></a><span class='hs-definition'>toIfaceBang</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>HsUserBang</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"toIfaceBang"</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="classToIfaceDecl"></a><span class='hs-definition'>classToIfaceDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceDecl</span>
<a name="line-179"></a><span class='hs-definition'>classToIfaceDecl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>clas</span>
<a name="line-180"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceClass</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifCtxt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceContext</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>sc_theta</span><span class='hs-layout'>,</span>
<a name="line-181"></a>                 <span class='hs-varid'>ifName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-182"></a>                 <span class='hs-varid'>ifTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTvBndrs</span> <span class='hs-varid'>clas_tyvars'</span><span class='hs-layout'>,</span>
<a name="line-183"></a>                 <span class='hs-varid'>ifRoles</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-184"></a>                 <span class='hs-varid'>ifFDs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceFD</span> <span class='hs-varid'>clas_fds</span><span class='hs-layout'>,</span>
<a name="line-185"></a>                 <span class='hs-varid'>ifATs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceAT</span> <span class='hs-varid'>clas_ats</span><span class='hs-layout'>,</span>
<a name="line-186"></a>                 <span class='hs-varid'>ifSigs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceClassOp</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>,</span>
<a name="line-187"></a>                 <span class='hs-varid'>ifMinDef</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>getOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>classMinimalDef</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-188"></a>                 <span class='hs-varid'>ifRec</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boolToRecFlag</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRecursiveTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-189"></a>  <span class='hs-keyword'>where</span>
<a name="line-190"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>clas_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas_fds</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas_ats</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>)</span>
<a name="line-191"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>clas</span>
<a name="line-192"></a>    <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span>
<a name="line-193"></a>
<a name="line-194"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas_tyvars'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>clas_tyvars</span>
<a name="line-195"></a>
<a name="line-196"></a>    <span class='hs-varid'>toIfaceAT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClassATItem</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceAT</span>
<a name="line-197"></a>    <span class='hs-varid'>toIfaceAT</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-198"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceAT</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConToIfaceDecl</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchToIfaceBranch'</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a>    <span class='hs-varid'>toIfaceClassOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>def_meth</span><span class='hs-layout'>)</span>
<a name="line-201"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>sel_tyvars</span> <span class='hs-varop'>==</span> <span class='hs-varid'>clas_tyvars</span><span class='hs-layout'>)</span>
<a name="line-202"></a>          <span class='hs-conid'>IfaceClassOp</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toDmSpec</span> <span class='hs-varid'>def_meth</span><span class='hs-layout'>)</span>
<a name="line-203"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span>
<a name="line-204"></a>        <span class='hs-keyword'>where</span>
<a name="line-205"></a>                <span class='hs-comment'>-- Be careful when splitting the type, because of things</span>
<a name="line-206"></a>                <span class='hs-comment'>-- like         class Foo a where</span>
<a name="line-207"></a>                <span class='hs-comment'>--                op :: (?x :: String) =&gt; a -&gt; a</span>
<a name="line-208"></a>                <span class='hs-comment'>-- and          class Baz a where</span>
<a name="line-209"></a>                <span class='hs-comment'>--                op :: (Ord a) =&gt; a -&gt; a</span>
<a name="line-210"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>sel_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-211"></a>          <span class='hs-varid'>op_ty</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funResultTy</span> <span class='hs-varid'>rho_ty</span>
<a name="line-212"></a>
<a name="line-213"></a>    <span class='hs-varid'>toDmSpec</span> <span class='hs-conid'>NoDefMeth</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoDM</span>
<a name="line-214"></a>    <span class='hs-varid'>toDmSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenDefMeth</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GenericDM</span>
<a name="line-215"></a>    <span class='hs-varid'>toDmSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DefMeth</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VanillaDM</span>
<a name="line-216"></a>
<a name="line-217"></a>    <span class='hs-varid'>toIfaceFD</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tidyTyVar</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span>
<a name="line-218"></a>                              <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tidyTyVar</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span>
<a name="line-219"></a>
<a name="line-220"></a><a name="tidyToIfaceType"></a><span class='hs-comment'>--------------------------</span>
<a name="line-221"></a><span class='hs-definition'>tidyToIfaceType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceType</span>
<a name="line-222"></a><span class='hs-definition'>tidyToIfaceType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-223"></a>
<a name="line-224"></a><a name="tidyToIfaceContext"></a><span class='hs-definition'>tidyToIfaceContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceContext</span>
<a name="line-225"></a><span class='hs-definition'>tidyToIfaceContext</span> <span class='hs-varid'>env</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="tidyTyClTyVarBndrs"></a><span class='hs-definition'>tidyTyClTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-228"></a><span class='hs-definition'>tidyTyClTyVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyClTyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvs</span>
<a name="line-229"></a>
<a name="line-230"></a><a name="tidyTyClTyVarBndr"></a><span class='hs-definition'>tidyTyClTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-231"></a><span class='hs-comment'>-- If the type variable "binder" is in scope, don't re-bind it</span>
<a name="line-232"></a><span class='hs-comment'>-- In a class decl, for example, the ATD binders mention</span>
<a name="line-233"></a><span class='hs-comment'>-- (amd must mention) the class tyvars</span>
<a name="line-234"></a><span class='hs-definition'>tidyTyClTyVarBndr</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-235"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-236"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="tidyTyVar"></a><span class='hs-definition'>tidyTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-239"></a><span class='hs-definition'>tidyTyVar</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>tv</span>
<a name="line-240"></a>   <span class='hs-comment'>-- TcType.tidyTyVarOcc messes around with FlatSkols</span>
<a name="line-241"></a>
<a name="line-242"></a><a name="getFS"></a><span class='hs-definition'>getFS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NamedThing</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span>
<a name="line-243"></a><span class='hs-definition'>getFS</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="instanceToIfaceInst"></a><span class='hs-comment'>--------------------------</span>
<a name="line-246"></a><span class='hs-definition'>instanceToIfaceInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClsInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceClsInst</span>
<a name="line-247"></a><span class='hs-definition'>instanceToIfaceInst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClsInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_dfun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oflag</span>
<a name="line-248"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>is_cls_nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span>
<a name="line-249"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>is_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-250"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>cls_name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>className</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>)</span>
<a name="line-251"></a>    <span class='hs-conid'>IfaceClsInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifDFun</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_name</span><span class='hs-layout'>,</span>
<a name="line-252"></a>                <span class='hs-varid'>ifOFlag</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oflag</span><span class='hs-layout'>,</span>
<a name="line-253"></a>                <span class='hs-varid'>ifInstCls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span>
<a name="line-254"></a>                <span class='hs-varid'>ifInstTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>do_rough</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>,</span>
<a name="line-255"></a>                <span class='hs-varid'>ifInstOrph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span> <span class='hs-layout'>}</span>
<a name="line-256"></a>  <span class='hs-keyword'>where</span>
<a name="line-257"></a>    <span class='hs-varid'>do_rough</span> <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-258"></a>    <span class='hs-varid'>do_rough</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon_name</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-259"></a>
<a name="line-260"></a>    <span class='hs-varid'>dfun_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>dfun_id</span>
<a name="line-261"></a>    <span class='hs-varid'>mod</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>dfun_name</span> <span class='hs-layout'>)</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>dfun_name</span>
<a name="line-262"></a>    <span class='hs-varid'>is_local</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>name</span>
<a name="line-263"></a>
<a name="line-264"></a>        <span class='hs-comment'>-- Compute orphanhood.  See Note [Orphans] in IfaceSyn</span>
<a name="line-265"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTvsFds</span> <span class='hs-varid'>cls</span>
<a name="line-266"></a>    <span class='hs-varid'>arg_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>filterNameSet</span> <span class='hs-varid'>is_local</span> <span class='hs-layout'>(</span><span class='hs-varid'>orphNamesOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span><span class='hs-keyglyph'>]</span>
<a name="line-267"></a>
<a name="line-268"></a>    <span class='hs-comment'>-- See Note [When exactly is an instance decl an orphan?] in IfaceSyn</span>
<a name="line-269"></a>    <span class='hs-varid'>orph</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_local</span> <span class='hs-varid'>cls_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>)</span>
<a name="line-270"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_ns</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>mb_ns</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varid'>head</span> <span class='hs-varid'>mb_ns</span>
<a name="line-271"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-272"></a>
<a name="line-273"></a>    <span class='hs-varid'>mb_ns</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>OccName</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- One for each fundep; a locally-defined name</span>
<a name="line-274"></a>                                <span class='hs-comment'>-- that is not in the "determined" arguments</span>
<a name="line-275"></a>    <span class='hs-varid'>mb_ns</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>choose_one</span> <span class='hs-varid'>arg_names</span><span class='hs-keyglyph'>]</span>
<a name="line-276"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>fds</span>
<a name="line-277"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-sel'>_ltvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rtvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>choose_one</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ns</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>arg_names</span>
<a name="line-278"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>rtvs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-279"></a>
<a name="line-280"></a>    <span class='hs-varid'>choose_one</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameSet</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>OccName</span>
<a name="line-281"></a>    <span class='hs-varid'>choose_one</span> <span class='hs-varid'>nss</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionManyNameSets</span> <span class='hs-varid'>nss</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-282"></a>                        <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-283"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-284"></a>
<a name="line-285"></a><a name="famInstToIfaceFamInst"></a><span class='hs-comment'>--------------------------</span>
<a name="line-286"></a><span class='hs-definition'>famInstToIfaceFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceFamInst</span>
<a name="line-287"></a><span class='hs-definition'>famInstToIfaceFamInst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_axiom</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>,</span>
<a name="line-288"></a>                                 <span class='hs-varid'>fi_fam</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span><span class='hs-layout'>,</span>
<a name="line-289"></a>                                 <span class='hs-varid'>fi_tcs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roughs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-290"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceFamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifFamInstAxiom</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>axiom</span>
<a name="line-291"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifFamInstFam</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span>
<a name="line-292"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifFamInstTys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>do_rough</span> <span class='hs-varid'>roughs</span>
<a name="line-293"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ifFamInstOrph</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span> <span class='hs-layout'>}</span>
<a name="line-294"></a>  <span class='hs-keyword'>where</span>
<a name="line-295"></a>    <span class='hs-varid'>do_rough</span> <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-296"></a>    <span class='hs-varid'>do_rough</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon_name</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-297"></a>
<a name="line-298"></a>    <span class='hs-varid'>fam_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>axiom</span>
<a name="line-299"></a>    <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-300"></a>          <span class='hs-varid'>nameModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomName</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span>
<a name="line-301"></a>    <span class='hs-varid'>is_local</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>name</span>
<a name="line-302"></a>
<a name="line-303"></a>    <span class='hs-varid'>lhs_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterNameSet</span> <span class='hs-varid'>is_local</span> <span class='hs-layout'>(</span><span class='hs-varid'>orphNamesOfCoCon</span> <span class='hs-varid'>axiom</span><span class='hs-layout'>)</span>
<a name="line-304"></a>
<a name="line-305"></a>    <span class='hs-varid'>orph</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_local</span> <span class='hs-varid'>fam_decl</span>
<a name="line-306"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>fam_decl</span><span class='hs-layout'>)</span>
<a name="line-307"></a>
<a name="line-308"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyNameSet</span> <span class='hs-varid'>lhs_names</span><span class='hs-layout'>)</span>
<a name="line-309"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>lhs_names</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-310"></a>
<a name="line-311"></a>
<a name="line-312"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-313"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-314"></a>
<a name="line-315"></a><a name="toIfaceLetBndr"></a><span class='hs-comment'>--------------------------</span>
<a name="line-316"></a><span class='hs-definition'>toIfaceLetBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceLetBndr</span>
<a name="line-317"></a><span class='hs-definition'>toIfaceLetBndr</span> <span class='hs-varid'>id</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfLetBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-318"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-319"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceIdInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-320"></a>  <span class='hs-comment'>-- Put into the interface file any IdInfo that CoreTidy.tidyLetBndr</span>
<a name="line-321"></a>  <span class='hs-comment'>-- has left on the Id.  See Note [IdInfo on nested let-bindings] in IfaceSyn</span>
<a name="line-322"></a>
<a name="line-323"></a><a name="toIfaceIdDetails"></a><span class='hs-comment'>--------------------------</span>
<a name="line-324"></a><span class='hs-definition'>toIfaceIdDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceIdDetails</span>
<a name="line-325"></a><span class='hs-definition'>toIfaceIdDetails</span> <span class='hs-conid'>VanillaId</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfVanillaId</span>
<a name="line-326"></a><span class='hs-definition'>toIfaceIdDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFunId</span> <span class='hs-varid'>ns</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfDFunId</span> <span class='hs-varid'>ns</span>
<a name="line-327"></a><span class='hs-definition'>toIfaceIdDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecSelId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sel_naughty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-328"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sel_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfRecSelId</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-329"></a><span class='hs-definition'>toIfaceIdDetails</span> <span class='hs-varid'>other</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"toIfaceIdDetails"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-330"></a>                                                  <span class='hs-conid'>IfVanillaId</span>   <span class='hs-comment'>-- Unexpected</span>
<a name="line-331"></a>
<a name="line-332"></a><a name="toIfaceIdInfo"></a><span class='hs-definition'>toIfaceIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceIdInfo</span>
<a name="line-333"></a><span class='hs-definition'>toIfaceIdInfo</span> <span class='hs-varid'>id_info</span>
<a name="line-334"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>catMaybes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arity_hsinfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>caf_hsinfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>strict_hsinfo</span><span class='hs-layout'>,</span>
<a name="line-335"></a>                    <span class='hs-varid'>inline_hsinfo</span><span class='hs-layout'>,</span>  <span class='hs-varid'>unfold_hsinfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-336"></a>       <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NoInfo</span>
<a name="line-337"></a>       <span class='hs-varid'>infos</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HasInfo</span> <span class='hs-varid'>infos</span>
<a name="line-338"></a>               <span class='hs-comment'>-- NB: strictness and arity must appear in the list before unfolding</span>
<a name="line-339"></a>               <span class='hs-comment'>-- See TcIface.tcUnfolding</span>
<a name="line-340"></a>  <span class='hs-keyword'>where</span>
<a name="line-341"></a>    <span class='hs-comment'>------------  Arity  --------------</span>
<a name="line-342"></a>    <span class='hs-varid'>arity_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityInfo</span> <span class='hs-varid'>id_info</span>
<a name="line-343"></a>    <span class='hs-varid'>arity_hsinfo</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity_info</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-344"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArity</span> <span class='hs-varid'>arity_info</span><span class='hs-layout'>)</span>
<a name="line-345"></a>
<a name="line-346"></a>    <span class='hs-comment'>------------ Caf Info --------------</span>
<a name="line-347"></a>    <span class='hs-varid'>caf_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafInfo</span> <span class='hs-varid'>id_info</span>
<a name="line-348"></a>    <span class='hs-varid'>caf_hsinfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>caf_info</span> <span class='hs-keyword'>of</span>
<a name="line-349"></a>                   <span class='hs-conid'>NoCafRefs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>HsNoCafRefs</span>
<a name="line-350"></a>                   <span class='hs-sel'>_other</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-351"></a>
<a name="line-352"></a>    <span class='hs-comment'>------------  Strictness  --------------</span>
<a name="line-353"></a>        <span class='hs-comment'>-- No point in explicitly exporting TopSig</span>
<a name="line-354"></a>    <span class='hs-varid'>sig_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strictnessInfo</span> <span class='hs-varid'>id_info</span>
<a name="line-355"></a>    <span class='hs-varid'>strict_hsinfo</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNopSig</span> <span class='hs-varid'>sig_info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrictness</span> <span class='hs-varid'>sig_info</span><span class='hs-layout'>)</span>
<a name="line-356"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-357"></a>
<a name="line-358"></a>    <span class='hs-comment'>------------  Unfolding  --------------</span>
<a name="line-359"></a>    <span class='hs-varid'>unfold_hsinfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfUnfolding</span> <span class='hs-varid'>loop_breaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>unfoldingInfo</span> <span class='hs-varid'>id_info</span><span class='hs-layout'>)</span>
<a name="line-360"></a>    <span class='hs-varid'>loop_breaker</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrongLoopBreaker</span> <span class='hs-layout'>(</span><span class='hs-varid'>occInfo</span> <span class='hs-varid'>id_info</span><span class='hs-layout'>)</span>
<a name="line-361"></a>
<a name="line-362"></a>    <span class='hs-comment'>------------  Inline prag  --------------</span>
<a name="line-363"></a>    <span class='hs-varid'>inline_prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inlinePragInfo</span> <span class='hs-varid'>id_info</span>
<a name="line-364"></a>    <span class='hs-varid'>inline_hsinfo</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDefaultInlinePragma</span> <span class='hs-varid'>inline_prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-365"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsInline</span> <span class='hs-varid'>inline_prag</span><span class='hs-layout'>)</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="toIfUnfolding"></a><span class='hs-comment'>--------------------------</span>
<a name="line-368"></a><span class='hs-definition'>toIfUnfolding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unfolding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>IfaceInfoItem</span>
<a name="line-369"></a><span class='hs-definition'>toIfUnfolding</span> <span class='hs-varid'>lb</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uf_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span>
<a name="line-370"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>uf_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>src</span><span class='hs-layout'>,</span> <span class='hs-varid'>uf_guidance</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>guidance</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-371"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsUnfold</span> <span class='hs-varid'>lb</span> <span class='hs-varop'>$</span>
<a name="line-372"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>src</span> <span class='hs-keyword'>of</span>
<a name="line-373"></a>        <span class='hs-conid'>InlineStable</span>
<a name="line-374"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>guidance</span> <span class='hs-keyword'>of</span>
<a name="line-375"></a>               <span class='hs-conid'>UnfWhen</span> <span class='hs-varid'>unsat_ok</span> <span class='hs-varid'>boring_ok</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfInlineRule</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>unsat_ok</span> <span class='hs-varid'>boring_ok</span> <span class='hs-varid'>if_rhs</span>
<a name="line-376"></a>               <span class='hs-sel'>_other</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfCoreUnfold</span> <span class='hs-conid'>True</span> <span class='hs-varid'>if_rhs</span>
<a name="line-377"></a>        <span class='hs-conid'>InlineCompulsory</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfCompulsory</span> <span class='hs-varid'>if_rhs</span>
<a name="line-378"></a>        <span class='hs-conid'>InlineRhs</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfCoreUnfold</span> <span class='hs-conid'>False</span> <span class='hs-varid'>if_rhs</span>
<a name="line-379"></a>        <span class='hs-comment'>-- Yes, even if guidance is UnfNever, expose the unfolding</span>
<a name="line-380"></a>        <span class='hs-comment'>-- If we didn't want to expose the unfolding, TidyPgm would</span>
<a name="line-381"></a>        <span class='hs-comment'>-- have stuck in NoUnfolding.  For supercompilation we want</span>
<a name="line-382"></a>        <span class='hs-comment'>-- to see that unfolding!</span>
<a name="line-383"></a>  <span class='hs-keyword'>where</span>
<a name="line-384"></a>    <span class='hs-varid'>if_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-385"></a>
<a name="line-386"></a><span class='hs-definition'>toIfUnfolding</span> <span class='hs-varid'>lb</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFunUnfolding</span> <span class='hs-layout'>{</span> <span class='hs-varid'>df_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>df_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-387"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnfold</span> <span class='hs-varid'>lb</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfDFunUnfold</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceBndr</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-388"></a>      <span class='hs-comment'>-- No need to serialise the data constructor;</span>
<a name="line-389"></a>      <span class='hs-comment'>-- we can recover it from the type of the dfun</span>
<a name="line-390"></a>
<a name="line-391"></a><span class='hs-definition'>toIfUnfolding</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-392"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-393"></a>
<a name="line-394"></a><a name="coreRuleToIfaceRule"></a><span class='hs-comment'>--------------------------</span>
<a name="line-395"></a><span class='hs-definition'>coreRuleToIfaceRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceRule</span>
<a name="line-396"></a><span class='hs-definition'>coreRuleToIfaceRule</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuiltinRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-397"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"toHsRule: builtin"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-398"></a>    <span class='hs-varid'>bogusIfaceRule</span> <span class='hs-varid'>fn</span>
<a name="line-399"></a>
<a name="line-400"></a><span class='hs-definition'>coreRuleToIfaceRule</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>rule</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Rule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ru_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span>
<a name="line-401"></a>                                     <span class='hs-varid'>ru_act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span>
<a name="line-402"></a>                                     <span class='hs-varid'>ru_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ru_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-403"></a>                                     <span class='hs-varid'>ru_auto</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>auto</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-404"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifRuleName</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifActivation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span>
<a name="line-405"></a>                <span class='hs-varid'>ifRuleBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceBndr</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span>
<a name="line-406"></a>                <span class='hs-varid'>ifRuleHead</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span>
<a name="line-407"></a>                <span class='hs-varid'>ifRuleArgs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>do_arg</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span>
<a name="line-408"></a>                <span class='hs-varid'>ifRuleRhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span>
<a name="line-409"></a>                <span class='hs-varid'>ifRuleAuto</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>auto</span><span class='hs-layout'>,</span>
<a name="line-410"></a>                <span class='hs-varid'>ifRuleOrph</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orph</span> <span class='hs-layout'>}</span>
<a name="line-411"></a>  <span class='hs-keyword'>where</span>
<a name="line-412"></a>        <span class='hs-comment'>-- For type args we must remove synonyms from the outermost</span>
<a name="line-413"></a>        <span class='hs-comment'>-- level.  Reason: so that when we read it back in we'll</span>
<a name="line-414"></a>        <span class='hs-comment'>-- construct the same ru_rough field as we have right now;</span>
<a name="line-415"></a>        <span class='hs-comment'>-- see tcIfaceRule</span>
<a name="line-416"></a>    <span class='hs-varid'>do_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>deNoteType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-417"></a>    <span class='hs-varid'>do_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceCo</span>   <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-418"></a>    <span class='hs-varid'>do_arg</span> <span class='hs-varid'>arg</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>arg</span>
<a name="line-419"></a>
<a name="line-420"></a>        <span class='hs-comment'>-- Compute orphanhood.  See Note [Orphans] in IfaceSyn</span>
<a name="line-421"></a>        <span class='hs-comment'>-- A rule is an orphan only if none of the variables</span>
<a name="line-422"></a>        <span class='hs-comment'>-- mentioned on its left-hand side are locally defined</span>
<a name="line-423"></a>    <span class='hs-varid'>lhs_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ruleLhsOrphNames</span> <span class='hs-varid'>rule</span><span class='hs-layout'>)</span>
<a name="line-424"></a>
<a name="line-425"></a>    <span class='hs-varid'>orph</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameIsLocalOrFrom</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_names</span> <span class='hs-keyword'>of</span>
<a name="line-426"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-427"></a>                        <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-428"></a>
<a name="line-429"></a><a name="bogusIfaceRule"></a><span class='hs-definition'>bogusIfaceRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceRule</span>
<a name="line-430"></a><span class='hs-definition'>bogusIfaceRule</span> <span class='hs-varid'>id_name</span>
<a name="line-431"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ifRuleName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"bogus"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifActivation</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NeverActive</span><span class='hs-layout'>,</span>
<a name="line-432"></a>        <span class='hs-varid'>ifRuleBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifRuleHead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifRuleArgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-433"></a>        <span class='hs-varid'>ifRuleRhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceExt</span> <span class='hs-varid'>id_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifRuleOrph</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>ifRuleAuto</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-434"></a>
<a name="line-435"></a><a name="toIfaceExpr"></a><span class='hs-comment'>---------------------</span>
<a name="line-436"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceExpr</span>
<a name="line-437"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceVar</span> <span class='hs-varid'>v</span>
<a name="line-438"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceLit</span> <span class='hs-varid'>l</span>
<a name="line-439"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-440"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceCo</span>   <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-441"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>x</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceLam</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceBndr</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-442"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceApp</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-443"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>s</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-444"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-keyword'>as</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceECase</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-445"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFS</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceAlt</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-446"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceLet</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceBind</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-447"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-448"></a><span class='hs-definition'>toIfaceExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-449"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>toIfaceTickish</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceTick</span> <span class='hs-varid'>t'</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-450"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>e</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="toIfaceTickish"></a><span class='hs-comment'>---------------------</span>
<a name="line-453"></a><span class='hs-definition'>toIfaceTickish</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tickish</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>IfaceTickish</span>
<a name="line-454"></a><span class='hs-definition'>toIfaceTickish</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProfNote</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>push</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceSCC</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>push</span><span class='hs-layout'>)</span>
<a name="line-455"></a><span class='hs-definition'>toIfaceTickish</span> <span class='hs-layout'>(</span><span class='hs-conid'>HpcTick</span> <span class='hs-varid'>modl</span> <span class='hs-varid'>ix</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceHpcTick</span> <span class='hs-varid'>modl</span> <span class='hs-varid'>ix</span><span class='hs-layout'>)</span>
<a name="line-456"></a><span class='hs-definition'>toIfaceTickish</span> <span class='hs-layout'>(</span><span class='hs-conid'>Breakpoint</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> 
<a name="line-457"></a>   <span class='hs-comment'>-- Ignore breakpoints, since they are relevant only to GHCi, and </span>
<a name="line-458"></a>   <span class='hs-comment'>-- should not be serialised (Trac #8333)</span>
<a name="line-459"></a>
<a name="line-460"></a><a name="toIfaceBind"></a><span class='hs-comment'>---------------------</span>
<a name="line-461"></a><span class='hs-definition'>toIfaceBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bind</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceBinding</span>
<a name="line-462"></a><span class='hs-definition'>toIfaceBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceNonRec</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceLetBndr</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-463"></a><span class='hs-definition'>toIfaceBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceRec</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>toIfaceLetBndr</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prs</span><span class='hs-keyglyph'>]</span>
<a name="line-464"></a>
<a name="line-465"></a><a name="toIfaceAlt"></a><span class='hs-comment'>---------------------</span>
<a name="line-466"></a><span class='hs-definition'>toIfaceAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-467"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfaceConAlt</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FastString</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfaceExpr</span><span class='hs-layout'>)</span>
<a name="line-468"></a><span class='hs-definition'>toIfaceAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceCon</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getFS</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-469"></a>
<a name="line-470"></a><a name="toIfaceCon"></a><span class='hs-comment'>---------------------</span>
<a name="line-471"></a><span class='hs-definition'>toIfaceCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AltCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceConAlt</span>
<a name="line-472"></a><span class='hs-definition'>toIfaceCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceDataAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-473"></a><span class='hs-definition'>toIfaceCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitAlt</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceLitAlt</span> <span class='hs-varid'>l</span>
<a name="line-474"></a><span class='hs-definition'>toIfaceCon</span> <span class='hs-conid'>DEFAULT</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceDefault</span>
<a name="line-475"></a>
<a name="line-476"></a><a name="toIfaceApp"></a><span class='hs-comment'>---------------------</span>
<a name="line-477"></a><span class='hs-definition'>toIfaceApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Expr</span> <span class='hs-conid'>CoreBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Arg</span> <span class='hs-conid'>CoreBndr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceExpr</span>
<a name="line-478"></a><span class='hs-definition'>toIfaceApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceApp</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-479"></a><span class='hs-definition'>toIfaceApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-480"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isDataConWorkId_maybe</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>of</span>
<a name="line-481"></a>        <span class='hs-comment'>-- We convert the *worker* for tuples into IfaceTuples</span>
<a name="line-482"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>saturated</span>
<a name="line-483"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleTyConSort</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tup_args</span>
<a name="line-484"></a>          <span class='hs-keyword'>where</span>
<a name="line-485"></a>            <span class='hs-varid'>val_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropWhile</span> <span class='hs-varid'>isTypeArg</span> <span class='hs-keyword'>as</span>
<a name="line-486"></a>            <span class='hs-varid'>saturated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>val_args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>v</span>
<a name="line-487"></a>            <span class='hs-varid'>tup_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>val_args</span>
<a name="line-488"></a>            <span class='hs-varid'>tc</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span>
<a name="line-489"></a>
<a name="line-490"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkIfaceApps</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-491"></a>
<a name="line-492"></a><span class='hs-definition'>toIfaceApp</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIfaceApps</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-493"></a>
<a name="line-494"></a><a name="mkIfaceApps"></a><span class='hs-definition'>mkIfaceApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IfaceExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceExpr</span>
<a name="line-495"></a><span class='hs-definition'>mkIfaceApps</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceApp</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceExpr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span>
<a name="line-496"></a>
<a name="line-497"></a><a name="toIfaceVar"></a><span class='hs-comment'>---------------------</span>
<a name="line-498"></a><span class='hs-definition'>toIfaceVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceExpr</span>
<a name="line-499"></a><span class='hs-definition'>toIfaceVar</span> <span class='hs-varid'>v</span>
<a name="line-500"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>fcall</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isFCallId_maybe</span> <span class='hs-varid'>v</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceFCall</span> <span class='hs-varid'>fcall</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-501"></a>       <span class='hs-comment'>-- Foreign calls have special syntax</span>
<a name="line-502"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceExt</span> <span class='hs-varid'>name</span>
<a name="line-503"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfaceLcl</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFS</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-504"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>v</span>
</pre>\end{code}
</body>
</html>
