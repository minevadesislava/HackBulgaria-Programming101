<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>nativeGen/Size.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>-- | Sizes on this architecture</span>
<a name="line-9"></a><span class='hs-comment'>-- 	A Size is a combination of width and class</span>
<a name="line-10"></a><span class='hs-comment'>-- </span>
<a name="line-11"></a><span class='hs-comment'>-- 	TODO: 	Rename this to "Format" instead of "Size" to reflect</span>
<a name="line-12"></a><span class='hs-comment'>--		the fact that it represents floating point vs integer.</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>--	TODO: 	Signed vs unsigned?</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>--	TODO:	This module is currenly shared by all architectures because</span>
<a name="line-17"></a><span class='hs-comment'>--		NCGMonad need to know about it to make a VReg. It would be better</span>
<a name="line-18"></a><span class='hs-comment'>--		to have architecture specific formats, and do the overloading</span>
<a name="line-19"></a><span class='hs-comment'>--		properly. eg SPARC doesn't care about FF80.</span>
<a name="line-20"></a><span class='hs-comment'>--</span>
<a name="line-21"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Size</span> <span class='hs-layout'>(</span>
<a name="line-22"></a>    <span class='hs-conid'>Size</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-23"></a>    <span class='hs-varid'>intSize</span><span class='hs-layout'>,</span>
<a name="line-24"></a>    <span class='hs-varid'>floatSize</span><span class='hs-layout'>,</span>
<a name="line-25"></a>    <span class='hs-varid'>isFloatSize</span><span class='hs-layout'>,</span>
<a name="line-26"></a>    <span class='hs-varid'>cmmTypeSize</span><span class='hs-layout'>,</span>
<a name="line-27"></a>    <span class='hs-varid'>sizeToWidth</span><span class='hs-layout'>,</span>
<a name="line-28"></a>    <span class='hs-varid'>sizeInBytes</span>
<a name="line-29"></a><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>where</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Cmm</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-comment'>-- It looks very like the old MachRep, but it's now of purely local</span>
<a name="line-37"></a><span class='hs-comment'>-- significance, here in the native code generator.  You can change it</span>
<a name="line-38"></a><span class='hs-comment'>-- without global consequences.</span>
<a name="line-39"></a><span class='hs-comment'>--</span>
<a name="line-40"></a><span class='hs-comment'>-- A major use is as an opcode qualifier; thus the opcode </span>
<a name="line-41"></a><span class='hs-comment'>--	mov.l a b</span>
<a name="line-42"></a><span class='hs-comment'>-- might be encoded </span>
<a name="line-43"></a><span class='hs-comment'>-- 	MOV II32 a b</span>
<a name="line-44"></a><span class='hs-comment'>-- where the Size field encodes the ".l" part.</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-comment'>-- ToDo: it's not clear to me that we need separate signed-vs-unsigned sizes</span>
<a name="line-47"></a><span class='hs-comment'>-- 	  here.  I've removed them from the x86 version, we'll see what happens --SDM</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-comment'>-- ToDo: quite a few occurrences of Size could usefully be replaced by Width</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="Size"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Size</span>
<a name="line-52"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>II8</span> 
<a name="line-53"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>II16</span> 
<a name="line-54"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>II32</span> 
<a name="line-55"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>II64</span> 
<a name="line-56"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>FF32</span> 
<a name="line-57"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>FF64</span> 
<a name="line-58"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>FF80</span>
<a name="line-59"></a>	<span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>
<a name="line-62"></a><a name="intSize"></a><span class='hs-comment'>-- | Get the integer size of this width.</span>
<a name="line-63"></a><span class='hs-definition'>intSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Size</span>
<a name="line-64"></a><span class='hs-definition'>intSize</span> <span class='hs-varid'>width</span>
<a name="line-65"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>width</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a> 	<span class='hs-conid'>W8</span> 	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>II8</span>
<a name="line-67"></a>	<span class='hs-conid'>W16</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>II16</span>
<a name="line-68"></a>	<span class='hs-conid'>W32</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>II32</span>
<a name="line-69"></a>	<span class='hs-conid'>W64</span> 	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>II64</span>
<a name="line-70"></a>	<span class='hs-varid'>other</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Size.intSize"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a>
<a name="line-73"></a><a name="floatSize"></a><span class='hs-comment'>-- | Get the float size of this width.</span>
<a name="line-74"></a><span class='hs-definition'>floatSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Width</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Size</span>
<a name="line-75"></a><span class='hs-definition'>floatSize</span> <span class='hs-varid'>width</span>
<a name="line-76"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>width</span> <span class='hs-keyword'>of</span>
<a name="line-77"></a> 	<span class='hs-conid'>W32</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FF32</span>
<a name="line-78"></a>	<span class='hs-conid'>W64</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FF64</span>
<a name="line-79"></a>	<span class='hs-varid'>other</span> 	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Size.floatSize"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a>
<a name="line-82"></a><a name="isFloatSize"></a><span class='hs-comment'>-- | Check if a size represents a floating point value.</span>
<a name="line-83"></a><span class='hs-definition'>isFloatSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-84"></a><span class='hs-definition'>isFloatSize</span> <span class='hs-varid'>size</span>
<a name="line-85"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>size</span> <span class='hs-keyword'>of</span>
<a name="line-86"></a> 	<span class='hs-conid'>FF32</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-87"></a>	<span class='hs-conid'>FF64</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-88"></a>	<span class='hs-conid'>FF80</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-89"></a>	<span class='hs-keyword'>_</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-90"></a>
<a name="line-91"></a>
<a name="line-92"></a><a name="cmmTypeSize"></a><span class='hs-comment'>-- | Convert a Cmm type to a Size.</span>
<a name="line-93"></a><span class='hs-definition'>cmmTypeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Size</span>
<a name="line-94"></a><span class='hs-definition'>cmmTypeSize</span> <span class='hs-varid'>ty</span> 
<a name="line-95"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFloatType</span> <span class='hs-varid'>ty</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeWidth</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-96"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>intSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeWidth</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a>
<a name="line-99"></a><a name="sizeToWidth"></a><span class='hs-comment'>-- | Get the Width of a Size.</span>
<a name="line-100"></a><span class='hs-definition'>sizeToWidth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Width</span>
<a name="line-101"></a><span class='hs-definition'>sizeToWidth</span> <span class='hs-varid'>size</span>
<a name="line-102"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>size</span> <span class='hs-keyword'>of</span>
<a name="line-103"></a> 	<span class='hs-conid'>II8</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W8</span>
<a name="line-104"></a>	<span class='hs-conid'>II16</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W16</span>
<a name="line-105"></a>	<span class='hs-conid'>II32</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W32</span>
<a name="line-106"></a>	<span class='hs-conid'>II64</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W64</span>
<a name="line-107"></a>	<span class='hs-conid'>FF32</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W32</span>
<a name="line-108"></a>	<span class='hs-conid'>FF64</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W64</span>
<a name="line-109"></a>	<span class='hs-conid'>FF80</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>W80</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="sizeInBytes"></a><span class='hs-definition'>sizeInBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-112"></a><span class='hs-definition'>sizeInBytes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>widthInBytes</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sizeToWidth</span>
</pre></body>
</html>
