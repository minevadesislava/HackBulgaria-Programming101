<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/Unify.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Unify</span> <span class='hs-layout'>(</span> 
<a name="line-9"></a>	<span class='hs-comment'>-- Matching of types: </span>
<a name="line-10"></a>	<span class='hs-comment'>--	the "tc" prefix indicates that matching always</span>
<a name="line-11"></a>	<span class='hs-comment'>--	respects newtypes (rather than looking through them)</span>
<a name="line-12"></a>	<span class='hs-varid'>tcMatchTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMatchTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMatchTyX</span><span class='hs-layout'>,</span> 
<a name="line-13"></a>	<span class='hs-varid'>ruleMatchTyX</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMatchPreds</span><span class='hs-layout'>,</span> 
<a name="line-14"></a>
<a name="line-15"></a>	<span class='hs-conid'>MatchEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchList</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>
<a name="line-17"></a>	<span class='hs-varid'>typesCantMatch</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-comment'>-- Side-effect free unification</span>
<a name="line-20"></a>        <span class='hs-varid'>tcUnifyTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUnifyTys</span><span class='hs-layout'>,</span> <span class='hs-conid'>BindFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-conid'>UnifyResultM</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>UnifyResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcUnifyTysFG</span>
<a name="line-23"></a>
<a name="line-24"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftM</span><span class='hs-layout'>,</span> <span class='hs-varid'>ap</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-layout'>(</span><span class='hs-conid'>Applicative</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
		Matching
%*									*
%************************************************************************


Matching is much tricker than you might think.

1. The substitution we generate binds the *template type variables*
   which are given to us explicitly.

2. We want to match in the presence of foralls; 
	e.g 	(forall a. t1) ~ (forall b. t2)

   That is what the RnEnv2 is for; it does the alpha-renaming
   that makes it as if a and b were the same variable.
   Initialising the RnEnv2, so that it can generate a fresh
   binder when necessary, entails knowing the free variables of
   both types.

3. We must be careful not to bind a template type variable to a
   locally bound variable.  E.g.
	(forall a. x) ~ (forall b. b)
   where x is the template type variable.  Then we do not want to
   bind x to a/b!  This is a kind of occurs check.
   The necessary locals accumulate in the RnEnv2.


\begin{code}
<pre><a name="line-1"></a><a name="MatchEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MatchEnv</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ME</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span>	<span class='hs-comment'>-- Template variables</span>
<a name="line-3"></a> 	<span class='hs-layout'>,</span> <span class='hs-varid'>me_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span>	<span class='hs-comment'>-- Renaming envt for nested foralls</span>
<a name="line-4"></a>	<span class='hs-layout'>}</span>			<span class='hs-comment'>--   In-scope set includes template variables</span>
<a name="line-5"></a>    <span class='hs-comment'>-- Nota Bene: MatchEnv isn't specific to Types.  It is used</span>
<a name="line-6"></a>    <span class='hs-comment'>--            for matching terms and coercions as well as types</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="tcMatchTy"></a><span class='hs-definition'>tcMatchTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span>		<span class='hs-comment'>-- Template tyvars</span>
<a name="line-9"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>		<span class='hs-comment'>-- Template</span>
<a name="line-10"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>		<span class='hs-comment'>-- Target</span>
<a name="line-11"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubst</span>	<span class='hs-comment'>-- One-shot; in principle the template</span>
<a name="line-12"></a>				<span class='hs-comment'>-- variables could be free in the target</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>tcMatchTy</span> <span class='hs-varid'>tmpls</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>of</span>
<a name="line-16"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>subst_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_env</span><span class='hs-layout'>)</span>
<a name="line-17"></a>	<span class='hs-conid'>Nothing</span>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>menv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ME</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpls</span><span class='hs-layout'>,</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpls</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-21"></a>	<span class='hs-comment'>-- We're assuming that all the interesting </span>
<a name="line-22"></a>	<span class='hs-comment'>-- tyvars in tys1 are in tmpls</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="tcMatchTys"></a><span class='hs-definition'>tcMatchTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span>		<span class='hs-comment'>-- Template tyvars</span>
<a name="line-25"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Template</span>
<a name="line-26"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Target</span>
<a name="line-27"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubst</span>	<span class='hs-comment'>-- One-shot; in principle the template</span>
<a name="line-28"></a>				<span class='hs-comment'>-- variables could be free in the target</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>tcMatchTys</span> <span class='hs-varid'>tmpls</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>match_tys</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyword'>of</span>
<a name="line-32"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>subst_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_env</span><span class='hs-layout'>)</span>
<a name="line-33"></a>	<span class='hs-conid'>Nothing</span>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-34"></a>  <span class='hs-keyword'>where</span>
<a name="line-35"></a>    <span class='hs-varid'>menv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ME</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpls</span><span class='hs-layout'>,</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>}</span>
<a name="line-36"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpls</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-37"></a>	<span class='hs-comment'>-- We're assuming that all the interesting </span>
<a name="line-38"></a>	<span class='hs-comment'>-- tyvars in tys1 are in tmpls</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="tcMatchTyX"></a><span class='hs-comment'>-- This is similar, but extends a substitution</span>
<a name="line-41"></a><span class='hs-definition'>tcMatchTyX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> 		<span class='hs-comment'>-- Template tyvars</span>
<a name="line-42"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>		<span class='hs-comment'>-- Substitution to extend</span>
<a name="line-43"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>		<span class='hs-comment'>-- Template</span>
<a name="line-44"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>		<span class='hs-comment'>-- Target</span>
<a name="line-45"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubst</span>
<a name="line-46"></a><span class='hs-definition'>tcMatchTyX</span> <span class='hs-varid'>tmpls</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst_env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>of</span>
<a name="line-48"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>subst_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_env</span><span class='hs-layout'>)</span>
<a name="line-49"></a>	<span class='hs-conid'>Nothing</span>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-50"></a>  <span class='hs-keyword'>where</span>
<a name="line-51"></a>    <span class='hs-varid'>menv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ME</span> <span class='hs-layout'>{</span><span class='hs-varid'>me_tmpls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpls</span><span class='hs-layout'>,</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="tcMatchPreds"></a><span class='hs-definition'>tcMatchPreds</span>
<a name="line-54"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>			<span class='hs-comment'>-- Bind these</span>
<a name="line-55"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-56"></a>   	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-57"></a><span class='hs-definition'>tcMatchPreds</span> <span class='hs-varid'>tmpls</span> <span class='hs-varid'>ps1</span> <span class='hs-varid'>ps2</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchList</span> <span class='hs-layout'>(</span><span class='hs-varid'>match</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>ps1</span> <span class='hs-varid'>ps2</span>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>    <span class='hs-varid'>menv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ME</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tmpls</span><span class='hs-layout'>,</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>in_scope_tyvars</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>    <span class='hs-varid'>in_scope_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>ps1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>ps2</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="ruleMatchTyX"></a><span class='hs-comment'>-- This one is called from the expression matcher, which already has a MatchEnv in hand</span>
<a name="line-64"></a><span class='hs-definition'>ruleMatchTyX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span> 
<a name="line-65"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>		<span class='hs-comment'>-- Substitution to extend</span>
<a name="line-66"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>		<span class='hs-comment'>-- Template</span>
<a name="line-67"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>		<span class='hs-comment'>-- Target</span>
<a name="line-68"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>ruleMatchTyX</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>	<span class='hs-comment'>-- Rename for export</span>
</pre>\end{code}

Now the internals of matching

\begin{code}
<pre><a name="line-1"></a><a name="match"></a><span class='hs-definition'>match</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span>	<span class='hs-comment'>-- For the most part this is pushed downwards</span>
<a name="line-2"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> 	<span class='hs-comment'>-- Substitution so far:</span>
<a name="line-3"></a>			<span class='hs-comment'>--   Domain is subset of template tyvars</span>
<a name="line-4"></a>			<span class='hs-comment'>--   Free vars of range is subset of </span>
<a name="line-5"></a>			<span class='hs-comment'>--	in-scope set of the RnEnv2</span>
<a name="line-6"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>	<span class='hs-comment'>-- Template and target respectively</span>
<a name="line-7"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-10"></a>			 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1'</span>	<span class='hs-comment'>-- tv1' is already bound</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-layout'>(</span><span class='hs-varid'>nukeRnEnvL</span> <span class='hs-varid'>rn_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-15"></a>	<span class='hs-comment'>-- ty1 has no locally-bound variables, hence nukeRnEnvL</span>
<a name="line-16"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span>
<a name="line-17"></a>    <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>	<span class='hs-comment'>-- ty2 doesn't match</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1'</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-varid'>menv</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>inRnEnvR</span> <span class='hs-varid'>rn_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>	<span class='hs-comment'>-- Occurs check</span>
<a name="line-22"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match_kind</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-23"></a>			<span class='hs-comment'>-- Note [Matching kinds]</span>
<a name="line-24"></a>	    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>tv1'</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-comment'>-- tv1 is not a template tyvar</span>
<a name="line-27"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty2</span> <span class='hs-keyword'>of</span>
<a name="line-28"></a>	<span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rnOccR</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span>
<a name="line-29"></a>	<span class='hs-keyword'>_</span>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>me_env</span> <span class='hs-varid'>menv</span>
<a name="line-32"></a>    <span class='hs-varid'>tv1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>tv1</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> 
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match_kind</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv'</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>		<span class='hs-comment'>-- Use the magic of rnBndr2 to go under the binders</span>
<a name="line-38"></a>    <span class='hs-varid'>menv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>menv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBndr2</span> <span class='hs-layout'>(</span><span class='hs-varid'>me_env</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> 
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match_tys</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-42"></a><span class='hs-definition'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty2a</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span> 
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span>
<a name="line-44"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span> <span class='hs-layout'>}</span>
<a name="line-45"></a><span class='hs-definition'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-47"></a>	<span class='hs-comment'>-- 'repSplit' used because the tcView stuff is done above</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-definition'>match</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>subst</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>match</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="match_kind"></a><span class='hs-comment'>--------------</span>
<a name="line-57"></a><span class='hs-definition'>match_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-58"></a><span class='hs-comment'>-- Match the kind of the template tyvar with the kind of Type</span>
<a name="line-59"></a><span class='hs-comment'>-- Note [Matching kinds]</span>
<a name="line-60"></a><span class='hs-definition'>match_kind</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k2</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>k1</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>subst</span>
<a name="line-63"></a>
<a name="line-64"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-comment'>-- Note [Matching kinds]</span>
<a name="line-68"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-69"></a><span class='hs-comment'>-- For ordinary type variables, we don't want (m a) to match (n b) </span>
<a name="line-70"></a><span class='hs-comment'>-- if say (a::*) and (b::*-&gt;*).  This is just a yes/no issue. </span>
<a name="line-71"></a><span class='hs-comment'>--</span>
<a name="line-72"></a><span class='hs-comment'>-- For coercion kinds matters are more complicated.  If we have a </span>
<a name="line-73"></a><span class='hs-comment'>-- coercion template variable co::a~[b], where a,b are presumably also</span>
<a name="line-74"></a><span class='hs-comment'>-- template type variables, then we must match co's kind against the </span>
<a name="line-75"></a><span class='hs-comment'>-- kind of the actual argument, so as to give bindings to a,b.  </span>
<a name="line-76"></a><span class='hs-comment'>--</span>
<a name="line-77"></a><span class='hs-comment'>-- In fact I have no example in mind that *requires* this kind-matching</span>
<a name="line-78"></a><span class='hs-comment'>-- to instantiate template type variables, but it seems like the right</span>
<a name="line-79"></a><span class='hs-comment'>-- thing to do.  C.f. Note [Matching variable types] in Rules.lhs</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="match_tys"></a><span class='hs-comment'>--------------</span>
<a name="line-82"></a><span class='hs-definition'>match_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-83"></a><span class='hs-definition'>match_tys</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchList</span> <span class='hs-layout'>(</span><span class='hs-varid'>match</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="matchList"></a><span class='hs-comment'>--------------</span>
<a name="line-86"></a><span class='hs-definition'>matchList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-87"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>env</span>
<a name="line-88"></a><span class='hs-definition'>matchList</span> <span class='hs-keyword'>_</span>  <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span>     <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span>
<a name="line-89"></a><span class='hs-definition'>matchList</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-90"></a>				      <span class='hs-layout'>;</span> <span class='hs-varid'>matchList</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>subst'</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>}</span>
<a name="line-91"></a><span class='hs-definition'>matchList</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>     <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}


%************************************************************************
%*									*
		GADTs
%*									*
%************************************************************************

Note [Pruning dead case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider	data T a where
		   T1 :: T Int
		   T2 :: T a

		newtype X = MkX Int
		newtype Y = MkY Char

		type family F a
		type instance F Bool = Int

Now consider	case x of { T1 -> e1; T2 -> e2 }

The question before the house is this: if I know something about the type
of x, can I prune away the T1 alternative?

Suppose x::T Char.  It's impossible to construct a (T Char) using T1, 
	Answer = YES we can prune the T1 branch (clearly)

Suppose x::T (F a), where 'a' is in scope.  Then 'a' might be instantiated
to 'Bool', in which case x::T Int, so
	ANSWER = NO (clearly)

Suppose x::T X.  Then *in Haskell* it's impossible to construct a (non-bottom) 
value of type (T X) using T1.  But *in FC* it's quite possible.  The newtype
gives a coercion
	CoX :: X ~ Int
So (T CoX) :: T X ~ T Int; hence (T1 `cast` sym (T CoX)) is a non-bottom value
of type (T X) constructed with T1.  Hence
	ANSWER = NO we can't prune the T1 branch (surprisingly)

Furthermore, this can even happen; see Trac #1251.  GHC's newtype-deriving
mechanism uses a cast, just as above, to move from one dictionary to another,
in effect giving the programmer access to CoX.

Finally, suppose x::T Y.  Then *even in FC* we can't construct a
non-bottom value of type (T Y) using T1.  That's because we can get
from Y to Char, but not to Int.


Here's a related question.  	data Eq a b where EQ :: Eq a a
Consider
	case x of { EQ -> ... }

Suppose x::Eq Int Char.  Is the alternative dead?  Clearly yes.

What about x::Eq Int a, in a context where we have evidence that a~Char.
Then again the alternative is dead.   


			Summary

We are really doing a test for unsatisfiability of the type
constraints implied by the match. And that is clearly, in general, a
hard thing to do.  

However, since we are simply dropping dead code, a conservative test
suffices.  There is a continuum of tests, ranging from easy to hard, that
drop more and more dead code.

For now we implement a very simple test: type variables match
anything, type functions (incl newtypes) match anything, and only
distinct data types fail to match.  We can elaborate later.

\begin{code}
<pre><a name="line-1"></a><a name="typesCantMatch"></a><span class='hs-definition'>typesCantMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>typesCantMatch</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>s</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span>
<a name="line-3"></a>  <span class='hs-keyword'>where</span>
<a name="line-4"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-6"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2</span>
<a name="line-7"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2'</span>
<a name="line-8"></a>
<a name="line-9"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-10"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span>
<a name="line-11"></a>
<a name="line-12"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-13"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDistinctTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isDistinctTyCon</span> <span class='hs-varid'>tc2</span>
<a name="line-14"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>tc2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>typesCantMatch</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"typesCantMatch"</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDistinctTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-17"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDistinctTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-18"></a>	<span class='hs-comment'>-- tc can't be FunTyCon by invariant</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-21"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>f2</span><span class='hs-layout'>,</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-22"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span>
<a name="line-23"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>f2</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-24"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>f1</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-25"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>cant_match</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>y</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-varid'>cant_match</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>      <span class='hs-comment'>-- Safe!</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-comment'>-- Things we could add;</span>
<a name="line-32"></a><span class='hs-comment'>--	foralls</span>
<a name="line-33"></a><span class='hs-comment'>--	look through newtypes</span>
<a name="line-34"></a><span class='hs-comment'>--	take account of tyvar bindings (EQ example above)</span>
</pre>\end{code}


%************************************************************************
%*									*
             Unification
%*                                                                      *
%************************************************************************

Note [Fine-grained unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Do the types (x, x) and ([y], y) unify? The answer is seemingly "no" --
no substitution to finite types makes these match. But, a substitution to
*infinite* types can unify these two types: [x |-> [[[...]]], y |-> [[[...]]] ].
Why do we care? Consider these two type family instances:

type instance F x x   = Int
type instance F [y] y = Bool

If we also have

type instance Looper = [Looper]

then the instances potentially overlap. The solution is to use unification
over infinite terms. This is possible (see [1] for lots of gory details), but
a full algorithm is a little more power than we need. Instead, we make a
conservative approximation and just omit the occurs check.

[1]: http://research.microsoft.com/en-us/um/people/simonpj/papers/ext-f/axioms-extended.pdf

tcUnifyTys considers an occurs-check problem as the same as general unification
failure.

tcUnifyTysFG ("fine-grained") returns one of three results: success, occurs-check
failure ("MaybeApart"), or general failure ("SurelyApart").

See also Trac #8162.

It's worth noting that unification in the presence of infinite types is not
complete. This means that, sometimes, a closed type family does not reduce
when it should. See test case indexed-types/should_fail/Overlap15 for an
example.

Note [The substitution in MaybeApart]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The constructor MaybeApart carries data with it, typically a TvSubstEnv. Why?
Because consider unifying these:

(a, a, Int) ~ (b, [b], Bool)

If we go left-to-right, we start with [a |-> b]. Then, on the middle terms, we
apply the subst we have so far and discover that we need [b |-> [b]]. Because
this fails the occurs check, we say that the types are MaybeApart (see above
Note [Fine-grained unification]). But, we can't stop there! Because if we
continue, we discover that Int is SurelyApart from Bool, and therefore the
types are apart. This has practical consequences for the ability for closed
type family applications to reduce. See test case
indexed-types/should_compile/Overlap14.

Note [Unifying with skolems]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we discover that two types unify if and only if a skolem variable is
substituted, we can't properly unify the types. But, that skolem variable
may later be instantiated with a unifyable type. So, we return maybeApart
in these cases.

\begin{code}
<pre><a name="line-1"></a><a name="tcUnifyTy"></a><span class='hs-definition'>tcUnifyTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- All tyvars are bindable</span>
<a name="line-2"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubst</span>	<span class='hs-comment'>-- A regular one-shot (idempotent) substitution</span>
<a name="line-3"></a><span class='hs-comment'>-- Simple unification of two types; all type variables are bindable</span>
<a name="line-4"></a><span class='hs-definition'>tcUnifyTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>initUM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>BindMe</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unify</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-6"></a>      <span class='hs-conid'>Unifiable</span> <span class='hs-varid'>subst_env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>niFixTvSubst</span> <span class='hs-varid'>subst_env</span><span class='hs-layout'>)</span>
<a name="line-7"></a>      <span class='hs-sel'>_other</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="tcUnifyTys"></a><span class='hs-comment'>-----------------</span>
<a name="line-10"></a><span class='hs-definition'>tcUnifyTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BindFlag</span><span class='hs-layout'>)</span>
<a name="line-11"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubst</span>	<span class='hs-comment'>-- A regular one-shot (idempotent) substitution</span>
<a name="line-13"></a><span class='hs-comment'>-- The two types may have common type variables, and indeed do so in the</span>
<a name="line-14"></a><span class='hs-comment'>-- second call to tcUnifyTys in FunDeps.checkClsFD</span>
<a name="line-15"></a><span class='hs-definition'>tcUnifyTys</span> <span class='hs-varid'>bind_fn</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcUnifyTysFG</span> <span class='hs-varid'>bind_fn</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyword'>of</span>
<a name="line-17"></a>      <span class='hs-conid'>Unifiable</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span>
<a name="line-18"></a>      <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="UnifyResult"></a><span class='hs-comment'>-- This type does double-duty. It is used in the UM (unifier monad) and to</span>
<a name="line-21"></a><a name="UnifyResult"></a><span class='hs-comment'>-- return the final result. See Note [Fine-grained unification]</span>
<a name="line-22"></a><a name="UnifyResult"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UnifyResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnifyResultM</span> <span class='hs-conid'>TvSubst</span>
<a name="line-23"></a><a name="UnifyResultM"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UnifyResultM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unifiable</span> <span class='hs-varid'>a</span>        <span class='hs-comment'>-- the subst that unifies the types</span>
<a name="line-24"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MaybeApart</span> <span class='hs-varid'>a</span>       <span class='hs-comment'>-- the subst has as much as we know</span>
<a name="line-25"></a>                                         <span class='hs-comment'>-- it must be part of an most general unifier</span>
<a name="line-26"></a>                                         <span class='hs-comment'>-- See Note [The substitution in MaybeApart]</span>
<a name="line-27"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SurelyApart</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="tcUnifyTysFG"></a><span class='hs-comment'>-- See Note [Fine-grained unification]</span>
<a name="line-30"></a><span class='hs-definition'>tcUnifyTysFG</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BindFlag</span><span class='hs-layout'>)</span>
<a name="line-31"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnifyResult</span>
<a name="line-33"></a><span class='hs-definition'>tcUnifyTysFG</span> <span class='hs-varid'>bind_fn</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initUM</span> <span class='hs-varid'>bind_fn</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyList</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-36"></a>
<a name="line-37"></a>	<span class='hs-comment'>-- Find the fixed point of the resulting non-idempotent substitution</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>niFixTvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
                Non-idempotent substitution
%*									*
%************************************************************************

Note [Non-idempotent substitution]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During unification we use a TvSubstEnv that is
  (a) non-idempotent
  (b) loop-free; ie repeatedly applying it yields a fixed point

Note [Finding the substitution fixpoint]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Finding the fixpoint of a non-idempotent substitution arising from a
unification is harder than it looks, because of kinds.  Consider
   T k (H k (f:k)) ~ T * (g:*)
If we unify, we get the substitution
   [ k -> *
   , g -> H k (f:k) ]
To make it idempotent we don't want to get just
   [ k -> *
   , g -> H * (f:k) ]
We also want to substitute inside f's kind, to get
   [ k -> *
   , g -> H k (f:*) ]
If we don't do this, we may apply the substitition to something,
and get an ill-formed type, i.e. one where typeKind will fail.
This happened, for example, in Trac #9106.

This is the reason for extending env with [f:k -> f:*], in the
definition of env' in niFixTvSubst

\begin{code}
<pre><a name="line-1"></a><a name="niFixTvSubst"></a><span class='hs-definition'>niFixTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-2"></a><span class='hs-comment'>-- Find the idempotent fixed point of the non-idempotent substitution</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [Finding the substitution fixpoint]</span>
<a name="line-4"></a><span class='hs-comment'>-- ToDo: use laziness instead of iteration?</span>
<a name="line-5"></a><span class='hs-definition'>niFixTvSubst</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>env</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>f</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not_fixpoint</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-8"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst</span>
<a name="line-9"></a>        <span class='hs-keyword'>where</span>
<a name="line-10"></a>          <span class='hs-varid'>not_fixpoint</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarSet</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>in_domain</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-varid'>all_range_tvs</span>
<a name="line-11"></a>          <span class='hs-varid'>in_domain</span> <span class='hs-varid'>tv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>env</span>
<a name="line-12"></a>
<a name="line-13"></a>          <span class='hs-varid'>range_tvs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarsOfType</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>env</span>
<a name="line-14"></a>          <span class='hs-varid'>all_range_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closeOverKinds</span> <span class='hs-varid'>range_tvs</span>
<a name="line-15"></a>          <span class='hs-varid'>subst</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-varid'>all_range_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-16"></a>
<a name="line-17"></a>             <span class='hs-comment'>-- env' extends env by replacing any free type with </span>
<a name="line-18"></a>             <span class='hs-comment'>-- that same tyvar with a substituted kind</span>
<a name="line-19"></a>             <span class='hs-comment'>-- See note [Finding the substitution fixpoint]</span>
<a name="line-20"></a>          <span class='hs-varid'>env'</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>rtv</span> <span class='hs-varop'>$</span>
<a name="line-21"></a>                                                       <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>rtv</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rtv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>range_tvs</span>
<a name="line-23"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_domain</span> <span class='hs-varid'>rtv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-24"></a>          <span class='hs-varid'>subst'</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-varid'>all_range_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>env'</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="niSubstTvSet"></a><span class='hs-definition'>niSubstTvSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-27"></a><span class='hs-comment'>-- Apply the non-idempotent substitution to a set of type variables,</span>
<a name="line-28"></a><span class='hs-comment'>-- remembering that the substitution isn't necessarily idempotent</span>
<a name="line-29"></a><span class='hs-comment'>-- This is used in the occurs check, before extending the substitution</span>
<a name="line-30"></a><span class='hs-definition'>niSubstTvSet</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>get</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>tvs</span>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>	       <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv</span>
<a name="line-35"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>niSubstTvSet</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
		The workhorse
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="unify"></a><span class='hs-definition'>unify</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span>	<span class='hs-comment'>-- An existing substitution to extend</span>
<a name="line-2"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> 	<span class='hs-comment'>-- Types to be unified, and witness of their equality</span>
<a name="line-3"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>TvSubstEnv</span>		<span class='hs-comment'>-- Just the extended substitution, </span>
<a name="line-4"></a>				<span class='hs-comment'>-- Nothing if unification failed</span>
<a name="line-5"></a><span class='hs-comment'>-- We do not require the incoming substitution to be idempotent,</span>
<a name="line-6"></a><span class='hs-comment'>-- nor guarantee that the outgoing one is.  That's fixed up by</span>
<a name="line-7"></a><span class='hs-comment'>-- the wrappers.</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-- Respects newtypes, PredTypes</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>-- in unify, any NewTcApps/Preds should be taken at face value</span>
<a name="line-12"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-13"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-16"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tyc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tyc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> 
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tyc2</span>                                   
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unify_tys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty2a</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span> 
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span>
<a name="line-24"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a>	<span class='hs-comment'>-- Applications need a bit of care!</span>
<a name="line-27"></a>	<span class='hs-comment'>-- They can match FunTy and TyConApp, so use splitAppTy_maybe</span>
<a name="line-28"></a>	<span class='hs-comment'>-- NB: we've already dealt with type variables and Notes,</span>
<a name="line-29"></a>	<span class='hs-comment'>-- so if one type is an App the other one jolly well better be too</span>
<a name="line-30"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty2a</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>subst</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-definition'>unify</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>surelyApart</span>
<a name="line-43"></a>	<span class='hs-comment'>-- ForAlls??</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="unify_tys"></a><span class='hs-comment'>------------------------------</span>
<a name="line-46"></a><span class='hs-definition'>unify_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-47"></a><span class='hs-definition'>unify_tys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifyList</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="unifyList"></a><span class='hs-definition'>unifyList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-50"></a><span class='hs-definition'>unifyList</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>orig_xs</span> <span class='hs-varid'>orig_ys</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>orig_xs</span> <span class='hs-varid'>orig_ys</span>
<a name="line-52"></a>  <span class='hs-keyword'>where</span>
<a name="line-53"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span>     <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>subst</span>
<a name="line-54"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span>
<a name="line-55"></a>				<span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span> <span class='hs-layout'>}</span>
<a name="line-56"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>surelyApart</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="uVar"></a><span class='hs-comment'>---------------------------------</span>
<a name="line-59"></a><span class='hs-definition'>uVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span>	<span class='hs-comment'>-- An existing substitution to extend</span>
<a name="line-60"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>           <span class='hs-comment'>-- Type variable to be unified</span>
<a name="line-61"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- with this type</span>
<a name="line-62"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-definition'>uVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty</span>
<a name="line-65"></a> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Check to see whether tv1 is refined by the substitution</span>
<a name="line-66"></a>   <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-67"></a>     <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ty</span>     <span class='hs-comment'>-- Yes, call back into unify'</span>
<a name="line-68"></a>     <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnrefined</span> <span class='hs-varid'>subst</span>       <span class='hs-comment'>-- No, continue</span>
<a name="line-69"></a>			    <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="uUnrefined"></a><span class='hs-definition'>uUnrefined</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span>          <span class='hs-comment'>-- An existing substitution to extend</span>
<a name="line-72"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>               <span class='hs-comment'>-- Type variable to be unified</span>
<a name="line-73"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>                <span class='hs-comment'>-- with this type</span>
<a name="line-74"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>                <span class='hs-comment'>-- (version w/ expanded synonyms)</span>
<a name="line-75"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-comment'>-- We know that tv1 isn't refined</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-definition'>uUnrefined</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty2'</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty2'</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnrefined</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty2''</span>	<span class='hs-comment'>-- Unwrap synonyms</span>
<a name="line-82"></a>		<span class='hs-comment'>-- This is essential, in case we have</span>
<a name="line-83"></a>		<span class='hs-comment'>--	type Foo a = a</span>
<a name="line-84"></a>		<span class='hs-comment'>-- and then unify a ~ Foo a</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-definition'>uUnrefined</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-87"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv2</span>		<span class='hs-comment'>-- Same type variable</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>subst</span>
<a name="line-89"></a>
<a name="line-90"></a>    <span class='hs-comment'>-- Check to see whether tv2 is refined</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv2</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnrefined</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ty'</span>
<a name="line-93"></a>
<a name="line-94"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-95"></a>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- So both are unrefined; unify the kinds</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-98"></a>
<a name="line-99"></a>           <span class='hs-comment'>-- And then bind one or the other, </span>
<a name="line-100"></a>           <span class='hs-comment'>-- depending on which is bindable</span>
<a name="line-101"></a>	   <span class='hs-comment'>-- NB: unlike TcUnify we do not have an elaborate sub-kinding </span>
<a name="line-102"></a>	   <span class='hs-comment'>--     story.  That is relevant only during type inference, and</span>
<a name="line-103"></a>           <span class='hs-comment'>--     (I very much hope) is not relevant here.</span>
<a name="line-104"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvBindFlag</span> <span class='hs-varid'>tv1</span>
<a name="line-105"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvBindFlag</span> <span class='hs-varid'>tv2</span>
<a name="line-106"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span>
<a name="line-107"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1</span><span class='hs-layout'>,</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-108"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Skolem</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skolem</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybeApart</span> <span class='hs-varid'>subst'</span> <span class='hs-comment'>-- See Note [Unification with skolems]</span>
<a name="line-109"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>BindMe</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-110"></a>           <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>BindMe</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-definition'>uUnrefined</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty2'</span>	<span class='hs-comment'>-- ty2 is not a type variable</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>niSubstTvSet</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeApart</span> <span class='hs-varid'>subst</span>                    <span class='hs-comment'>-- Occurs check</span>
<a name="line-115"></a>                                        <span class='hs-comment'>-- See Note [Fine-grained unification]</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-117"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-118"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bindTv</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>	<span class='hs-comment'>-- Bind tyvar to the synonym if poss</span>
<a name="line-119"></a>  <span class='hs-keyword'>where</span>
<a name="line-120"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span>
<a name="line-121"></a>    <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2'</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="bindTv"></a><span class='hs-definition'>bindTv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-124"></a><span class='hs-definition'>bindTv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>	<span class='hs-comment'>-- ty is not a type variable</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvBindFlag</span> <span class='hs-varid'>tv</span>
<a name="line-126"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-127"></a>	    <span class='hs-conid'>Skolem</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybeApart</span> <span class='hs-varid'>subst</span> <span class='hs-comment'>-- See Note [Unification with skolems]</span>
<a name="line-128"></a>	    <span class='hs-conid'>BindMe</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-129"></a>	<span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
		Binding decisions
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="BindFlag"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BindFlag</span> 
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BindMe</span>	<span class='hs-comment'>-- A regular type variable</span>
<a name="line-3"></a>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Skolem</span>	<span class='hs-comment'>-- This type variable is a skolem constant</span>
<a name="line-5"></a>		<span class='hs-comment'>-- Don't bind it; it only matches itself</span>
</pre>\end{code}


%************************************************************************
%*									*
		Unification monad
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="UM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>UM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unUM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BindFlag</span><span class='hs-layout'>)</span>
<a name="line-2"></a>		         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnifyResultM</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>UM</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>      <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>UM</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>      <span class='hs-varid'>pure</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-9"></a>      <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>UM</span> <span class='hs-keyword'>where</span>
<a name="line-12"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-sel'>_tvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unifiable</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-varid'>fail</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-sel'>_tvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SurelyApart</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- failed pattern match</span>
<a name="line-14"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unUM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tvs</span> <span class='hs-keyword'>of</span>
<a name="line-15"></a>			   <span class='hs-conid'>Unifiable</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unUM</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-16"></a>                           <span class='hs-conid'>MaybeApart</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-17"></a>                             <span class='hs-keyword'>case</span> <span class='hs-varid'>unUM</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-keyword'>of</span>
<a name="line-18"></a>                               <span class='hs-conid'>Unifiable</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeApart</span> <span class='hs-varid'>v'</span>
<a name="line-19"></a>                               <span class='hs-varid'>other</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>other</span>
<a name="line-20"></a>                           <span class='hs-conid'>SurelyApart</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SurelyApart</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="initUM"></a><span class='hs-definition'>initUM</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BindFlag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnifyResultM</span> <span class='hs-varid'>a</span>
<a name="line-23"></a><span class='hs-definition'>initUM</span> <span class='hs-varid'>badtvs</span> <span class='hs-varid'>um</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unUM</span> <span class='hs-varid'>um</span> <span class='hs-varid'>badtvs</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="tvBindFlag"></a><span class='hs-definition'>tvBindFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>BindFlag</span>
<a name="line-26"></a><span class='hs-definition'>tvBindFlag</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tv_fn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unifiable</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_fn</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="maybeApart"></a><span class='hs-definition'>maybeApart</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UM</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-29"></a><span class='hs-definition'>maybeApart</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-sel'>_tv_fn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeApart</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="surelyApart"></a><span class='hs-definition'>surelyApart</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UM</span> <span class='hs-varid'>a</span>
<a name="line-32"></a><span class='hs-definition'>surelyApart</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-sel'>_tv_fn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SurelyApart</span><span class='hs-layout'>)</span>
</pre>\end{code}

</body>
</html>
