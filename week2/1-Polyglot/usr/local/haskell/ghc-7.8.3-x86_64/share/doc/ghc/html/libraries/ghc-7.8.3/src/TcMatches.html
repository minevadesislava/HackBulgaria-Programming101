<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcMatches.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

TcMatches: Typecheck some @Matches@

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcMatches</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcMatchesFun</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGRHSsPat</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMatchesCase</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMatchLambda</span><span class='hs-layout'>,</span>
<a name="line-9"></a>		   <span class='hs-conid'>TcMatchCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcStmtChecker</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcExprStmtChecker</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCmdStmtChecker</span><span class='hs-layout'>,</span>
<a name="line-10"></a>		   <span class='hs-varid'>tcStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcStmtsAndThen</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcDoStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcBody</span><span class='hs-layout'>,</span>
<a name="line-11"></a>		   <span class='hs-varid'>tcDoStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGuardStmt</span>
<a name="line-12"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>	<span class='hs-conid'>TcExpr</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcSyntaxOp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferRhoNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferRho</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCheckId</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                                <span class='hs-varid'>tcMonoExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcMonoExprNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcPat</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcBinds</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-comment'>-- Create chunkified tuple tybes for monad comprehensions</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection{tcMatchesFun, tcMatchesCase}
%*									*
%************************************************************************

@tcMatchesFun@ typechecks a @[Match]@ list which occurs in a
@FunMonoBind@.  The second argument is the name of the function, which
is used in error messages.  It checks that all the equations have the
same number of arguments before using @tcMatches@ to do the work.

Note [Polymorphic expected type for tcMatchesFun]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tcMatchesFun may be given a *sigma* (polymorphic) type
so it must be prepared to use tcGen to skolemise it.
See Note [sig_tau may be polymorphic] in TcPat.

\begin{code}
<pre><a name="line-1"></a><a name="tcMatchesFun"></a><span class='hs-definition'>tcMatchesFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-3"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>     <span class='hs-comment'>-- Expected type of function</span>
<a name="line-4"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>                                <span class='hs-comment'>-- Returns type of body</span>
<a name="line-6"></a><span class='hs-definition'>tcMatchesFun</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>inf</span> <span class='hs-varid'>matches</span> <span class='hs-varid'>exp_ty</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>  <span class='hs-comment'>-- Check that they all have the same no of arguments</span>
<a name="line-8"></a>	   <span class='hs-comment'>-- Location is in the monad, set the caller so that </span>
<a name="line-9"></a>	   <span class='hs-comment'>-- any inter-equation error messages get some vaguely</span>
<a name="line-10"></a>	   <span class='hs-comment'>-- sensible location.	Note: we have to do this odd</span>
<a name="line-11"></a>	   <span class='hs-comment'>-- ann-grabbing, because we don't always have annotations in</span>
<a name="line-12"></a>	   <span class='hs-comment'>-- hand when we call tcMatchesFun...</span>
<a name="line-13"></a>          <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcMatchesFun"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_name</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_ty</span><span class='hs-layout'>)</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkArgs</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>matches</span>
<a name="line-15"></a>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_gen</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>group</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-17"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGen</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>fun_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>exp_rho</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-18"></a>	          <span class='hs-comment'>-- Note [Polymorphic expected type for tcMatchesFun]</span>
<a name="line-19"></a>               <span class='hs-varid'>matchFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>exp_rho</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-20"></a>	       <span class='hs-varid'>tcMatches</span> <span class='hs-varid'>match_ctxt</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varid'>matches</span> 
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap_gen</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap_fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>group</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>  <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchGroupArity</span> <span class='hs-varid'>matches</span>
<a name="line-24"></a>    <span class='hs-varid'>herald</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The equation(s) for"</span><span class='hs-layout'>)</span>
<a name="line-25"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"have"</span><span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-varid'>match_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_what</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunRhs</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>inf</span><span class='hs-layout'>,</span> <span class='hs-varid'>mc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcBody</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@tcMatchesCase@ doesn't do the argument-count check because the
parser guarantees that each equation has exactly one argument.

\begin{code}
<pre><a name="line-1"></a><a name="tcMatchesCase"></a><span class='hs-definition'>tcMatchesCase</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> 
<a name="line-2"></a>                 <span class='hs-conid'>TcMatchCtxt</span> <span class='hs-varid'>body</span>                             <span class='hs-comment'>-- Case context</span>
<a name="line-3"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>                                    <span class='hs-comment'>-- Type of scrutinee</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- The case alternatives</span>
<a name="line-5"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>                                    <span class='hs-comment'>-- Type of whole case expressions</span>
<a name="line-6"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Translated alternatives</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>tcMatchesCase</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>scrut_ty</span> <span class='hs-varid'>matches</span> <span class='hs-varid'>res_ty</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyMatchGroup</span> <span class='hs-varid'>matches</span>   <span class='hs-comment'>-- Allow empty case expressions</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>scrut_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mg_origin</span> <span class='hs-varid'>matches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatches</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>scrut_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>matches</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="tcMatchLambda"></a><span class='hs-definition'>tcMatchLambda</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> 
<a name="line-16"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>tcMatchLambda</span> <span class='hs-varid'>match</span> <span class='hs-varid'>res_ty</span> 
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>n_pats</span> <span class='hs-varid'>res_ty</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-19"></a>    <span class='hs-varid'>tcMatches</span> <span class='hs-varid'>match_ctxt</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varid'>match</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-varid'>n_pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchGroupArity</span> <span class='hs-varid'>match</span>
<a name="line-22"></a>    <span class='hs-varid'>herald</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The lambda expression"</span><span class='hs-layout'>)</span>
<a name="line-23"></a>	        	 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSetDepth</span> <span class='hs-layout'>(</span><span class='hs-conid'>PartWay</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-24"></a>                             <span class='hs-varid'>pprMatches</span> <span class='hs-layout'>(</span><span class='hs-conid'>LambdaExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-varid'>match</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-25"></a>			<span class='hs-comment'>-- The pprSetDepth makes the abstraction print briefly</span>
<a name="line-26"></a>		<span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a>    <span class='hs-varid'>match_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_what</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LambdaExpr</span><span class='hs-layout'>,</span>
<a name="line-28"></a>		      <span class='hs-varid'>mc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcBody</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@tcGRHSsPat@ typechecks @[GRHSs]@ that occur in a @PatMonoBind@.

\begin{code}
<pre><a name="line-1"></a><a name="tcGRHSsPat"></a><span class='hs-definition'>tcGRHSsPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-comment'>-- Used for pattern bindings</span>
<a name="line-4"></a><span class='hs-definition'>tcGRHSsPat</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcGRHSs</span> <span class='hs-varid'>match_ctxt</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>res_ty</span>
<a name="line-5"></a>  <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-varid'>match_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_what</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PatBindRhs</span><span class='hs-layout'>,</span>
<a name="line-7"></a>		      <span class='hs-varid'>mc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcBody</span> <span class='hs-layout'>}</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="matchFunTys"></a><span class='hs-definition'>matchFunTys</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>	<span class='hs-comment'>-- See Note [Herald for matchExpecteFunTys] in TcUnify</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>-- Written in CPS style for historical reasons; </span>
<a name="line-9"></a><span class='hs-comment'>-- could probably be un-CPSd, like matchExpectedTyConApp</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>matchFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>res_ty</span>
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>res_ty</span>
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>coToHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection{tcMatch}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcMatches"></a><span class='hs-definition'>tcMatches</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TcMatchCtxt</span> <span class='hs-varid'>body</span>
<a name="line-2"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Expected pattern types</span>
<a name="line-3"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>          <span class='hs-comment'>-- Expected result-type of the Match.</span>
<a name="line-4"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="TcMatchCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcMatchCtxt</span> <span class='hs-varid'>body</span>   <span class='hs-comment'>-- c.f. TcStmtCtxt, also in this module</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mc_what</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- What kind of thing this is</span>
<a name="line-9"></a>         <span class='hs-varid'>mc_body</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- Type checker for a body of</span>
<a name="line-10"></a>                                                <span class='hs-comment'>-- an alternative</span>
<a name="line-11"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-12"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>tcMatches</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>	<span class='hs-comment'>-- Ensure that rhs_ty is filled in</span>
<a name="line-16"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>matches'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMatch</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>matches</span>
<a name="line-17"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="tcMatch"></a><span class='hs-comment'>-------------</span>
<a name="line-20"></a><span class='hs-definition'>tcMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TcMatchCtxt</span> <span class='hs-varid'>body</span>
<a name="line-21"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Expected pattern types</span>
<a name="line-22"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>            <span class='hs-comment'>-- Expected result-type of the Match.</span>
<a name="line-23"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LMatch</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LMatch</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>tcMatch</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varid'>match</span> 
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_match</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>match</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>tc_match</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varid'>match</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>maybe_rhs_sig</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span>
<a name="line-30"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_match_ctxt</span> <span class='hs-varid'>match</span> <span class='hs-varop'>$</span>
<a name="line-31"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>grhss'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPats</span> <span class='hs-layout'>(</span><span class='hs-varid'>mc_what</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varop'>$</span>
<a name="line-32"></a>    			        <span class='hs-varid'>tc_grhss</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>maybe_rhs_sig</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-33"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>pats'</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>grhss'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a>    <span class='hs-varid'>tc_grhss</span> <span class='hs-varid'>ctxt</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>rhs_ty</span> 
<a name="line-36"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcGRHSs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>rhs_ty</span>	<span class='hs-comment'>-- No result signature</span>
<a name="line-37"></a>
<a name="line-38"></a>	<span class='hs-comment'>-- Result type sigs are no longer supported</span>
<a name="line-39"></a>    <span class='hs-varid'>tc_grhss</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-40"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_ghrss"</span>  	<span class='hs-comment'>-- Rejected by renamer</span>
<a name="line-41"></a>
<a name="line-42"></a>	<span class='hs-comment'>-- For (\x -&gt; e), tcExpr has already said "In the expresssion \x-&gt;e"</span>
<a name="line-43"></a>	<span class='hs-comment'>-- so we don't want to add "In the lambda abstraction \x-&gt;e"</span>
<a name="line-44"></a>    <span class='hs-varid'>add_match_ctxt</span> <span class='hs-varid'>match</span> <span class='hs-varid'>thing_inside</span>
<a name="line-45"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mc_what</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-46"></a>	    <span class='hs-conid'>LambdaExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thing_inside</span>
<a name="line-47"></a>	    <span class='hs-varid'>m_ctxt</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprMatchInCtxt</span> <span class='hs-varid'>m_ctxt</span> <span class='hs-varid'>match</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="tcGRHSs"></a><span class='hs-comment'>-------------</span>
<a name="line-50"></a><span class='hs-definition'>tcGRHSs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcMatchCtxt</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-51"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-comment'>-- Notice that we pass in the full res_ty, so that we get</span>
<a name="line-54"></a><span class='hs-comment'>-- good inference from simple things like</span>
<a name="line-55"></a><span class='hs-comment'>--	f = \(x::forall a.a-&gt;a) -&gt; &lt;stuff&gt;</span>
<a name="line-56"></a><span class='hs-comment'>-- We used to force it to be a monotype when there was more than one guard</span>
<a name="line-57"></a><span class='hs-comment'>-- but we don't need to do that any more</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-definition'>tcGRHSs</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>grhss'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLocalBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>$</span>
<a name="line-61"></a>			      <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>grhss</span>
<a name="line-62"></a>
<a name="line-63"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss'</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="tcGRHS"></a><span class='hs-comment'>-------------</span>
<a name="line-66"></a><span class='hs-definition'>tcGRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcMatchCtxt</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHS</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-67"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>tcGRHS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>guards</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>guards'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-varid'>stmt_ctxt</span> <span class='hs-varid'>tcGuardStmt</span> <span class='hs-varid'>guards</span> <span class='hs-varid'>res_ty</span> <span class='hs-varop'>$</span>
<a name="line-71"></a>			     <span class='hs-varid'>mc_body</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rhs</span>
<a name="line-72"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>guards'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-73"></a>  <span class='hs-keyword'>where</span>
<a name="line-74"></a>    <span class='hs-varid'>stmt_ctxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PatGuard</span> <span class='hs-layout'>(</span><span class='hs-varid'>mc_what</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{@tcDoStmts@ typechecks a {\em list} of do statements}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcDoStmts"></a><span class='hs-definition'>tcDoStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span> 
<a name="line-2"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-4"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Returns a HsDo</span>
<a name="line-5"></a><span class='hs-definition'>tcDoStmts</span> <span class='hs-conid'>ListComp</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedListTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>list_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkListTy</span> <span class='hs-varid'>elt_ty</span>
<a name="line-8"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>stmts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmts</span> <span class='hs-conid'>ListComp</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLcStmt</span> <span class='hs-varid'>listTyCon</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>elt_ty</span>
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>ListComp</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>list_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>tcDoStmts</span> <span class='hs-conid'>PArrComp</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedPArrTy</span> <span class='hs-varid'>res_ty</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>parr_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPArrTy</span> <span class='hs-varid'>elt_ty</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>stmts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmts</span> <span class='hs-conid'>PArrComp</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLcStmt</span> <span class='hs-varid'>parrTyCon</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>elt_ty</span>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>PArrComp</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>parr_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-definition'>tcDoStmts</span> <span class='hs-conid'>DoExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>stmts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmts</span> <span class='hs-conid'>DoExpr</span> <span class='hs-varid'>tcDoStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>DoExpr</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-definition'>tcDoStmts</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>stmts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmts</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>tcDoStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>MDoExpr</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>tcDoStmts</span> <span class='hs-conid'>MonadComp</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>stmts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmts</span> <span class='hs-conid'>MonadComp</span> <span class='hs-varid'>tcMcStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span> 
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>MonadComp</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>tcDoStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcDoStmts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprStmtContext</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="tcBody"></a><span class='hs-definition'>tcBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-definition'>tcBody</span> <span class='hs-varid'>body</span> <span class='hs-varid'>res_ty</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcBody"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-34"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>body</span> <span class='hs-varid'>res_ty</span>
<a name="line-35"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>body'</span> 
<a name="line-36"></a>        <span class='hs-layout'>}</span> 
</pre>\end{code}


%************************************************************************
%*									*
\subsection{tcStmts}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="TcExprStmtChecker"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcExprStmtChecker</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcStmtChecker</span> <span class='hs-conid'>HsExpr</span>
<a name="line-3"></a><a name="TcCmdStmtChecker"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcCmdStmtChecker</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcStmtChecker</span> <span class='hs-conid'>HsCmd</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="TcStmtChecker"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcStmtChecker</span> <span class='hs-varid'>body</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>forall</span> <span class='hs-varid'>thing</span><span class='hs-varop'>.</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-7"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>                    <span class='hs-comment'>-- Result type for comprehension</span>
<a name="line-9"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Checker for what follows the stmt</span>
<a name="line-10"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stmt</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="tcStmts"></a><span class='hs-definition'>tcStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-13"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcStmtChecker</span> <span class='hs-varid'>body</span>   <span class='hs-comment'>-- NB: higher-rank type</span>
<a name="line-14"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-16"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a><span class='hs-definition'>tcStmts</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt_chk</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt_chk</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>                        <span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>stmts'</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="tcStmtsAndThen"></a><span class='hs-definition'>tcStmtsAndThen</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span>
<a name="line-23"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcStmtChecker</span> <span class='hs-varid'>body</span>    <span class='hs-comment'>-- NB: higher-rank type</span>
<a name="line-24"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span>
<a name="line-26"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-27"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-comment'>-- Note the higher-rank type.  stmt_chk is applied at different</span>
<a name="line-30"></a><span class='hs-comment'>-- types in the equations for tcStmts</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-definition'>tcStmtsAndThen</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>res_ty</span>
<a name="line-34"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-comment'>-- LetStmts are handled uniformly, regardless of context</span>
<a name="line-37"></a><span class='hs-definition'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt_chk</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span><span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLocalBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>$</span>
<a name="line-39"></a>				      <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt_chk</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-40"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>-- For the vanilla case, handle the location-setting part</span>
<a name="line-43"></a><span class='hs-definition'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt_chk</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> 
<a name="line-45"></a>		<span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>		 		    <span class='hs-varop'>$</span>
<a name="line-46"></a>    		<span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprStmtInCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>	    <span class='hs-varop'>$</span>
<a name="line-47"></a>		<span class='hs-varid'>stmt_chk</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>res_ty</span>		    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>res_ty'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-48"></a>		<span class='hs-varid'>popErrCtxt</span> 				    <span class='hs-varop'>$</span>
<a name="line-49"></a>		<span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>stmt_chk</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty'</span>  <span class='hs-varop'>$</span>
<a name="line-50"></a>		<span class='hs-varid'>thing_inside</span>
<a name="line-51"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>stmt'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-54"></a><span class='hs-comment'>--	        Pattern guards</span>
<a name="line-55"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="tcGuardStmt"></a><span class='hs-definition'>tcGuardStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcExprStmtChecker</span>
<a name="line-58"></a><span class='hs-definition'>tcGuardStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>guard</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>guard'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>guard</span> <span class='hs-varid'>boolTy</span>
<a name="line-60"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>thing</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>res_ty</span>
<a name="line-61"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>guard'</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>boolTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-definition'>tcGuardStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRhoNC</span> <span class='hs-varid'>rhs</span>	<span class='hs-comment'>-- Stmt has a context already</span>
<a name="line-65"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varop'>$</span>
<a name="line-66"></a>                            <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>res_ty</span>
<a name="line-67"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>tcGuardStmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcGuardStmt: unexpected Stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-74"></a><span class='hs-comment'>--	     List comprehensions and PArrays</span>
<a name="line-75"></a><span class='hs-comment'>--	         (no rebindable syntax)</span>
<a name="line-76"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-comment'>-- Dealt with separately, rather than by tcMcStmt, because</span>
<a name="line-79"></a><span class='hs-comment'>--   a) PArr isn't (yet) an instance of Monad, so the generality seems overkill</span>
<a name="line-80"></a><span class='hs-comment'>--   b) We have special desugaring rules for list comprehensions,</span>
<a name="line-81"></a><span class='hs-comment'>--      which avoid creating intermediate lists.  They in turn </span>
<a name="line-82"></a><span class='hs-comment'>--      assume that the bind/return operations are the regular</span>
<a name="line-83"></a><span class='hs-comment'>--      polymorphic ones, and in particular don't have any</span>
<a name="line-84"></a><span class='hs-comment'>--      coercion matching stuff in them.  It's hard to avoid the</span>
<a name="line-85"></a><span class='hs-comment'>--      potential for non-trivial coercions in tcMcStmt</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="tcLcStmt"></a><span class='hs-definition'>tcLcStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>       <span class='hs-comment'>-- The list/Parray type constructor ([] or PArray)</span>
<a name="line-88"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcExprStmtChecker</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-definition'>tcLcStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>body</span> <span class='hs-varid'>elt_ty</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"tcLcStmt: thing_inside"</span><span class='hs-layout'>)</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-comment'>-- A generator, pat &lt;- rhs</span>
<a name="line-96"></a><span class='hs-definition'>tcLcStmt</span> <span class='hs-varid'>m_tc</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-97"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>pat_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-98"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>m_tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pat_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-99"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varop'>$</span>
<a name="line-100"></a>                            <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>elt_ty</span>
<a name="line-101"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-comment'>-- A boolean guard</span>
<a name="line-104"></a><span class='hs-definition'>tcLcStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>rhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>rhs'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>boolTy</span>
<a name="line-106"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>elt_ty</span>
<a name="line-107"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>boolTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-comment'>-- ParStmt: See notes with tcMcStmt</span>
<a name="line-110"></a><span class='hs-definition'>tcLcStmt</span> <span class='hs-varid'>m_tc</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>bndr_stmts_s</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>bndr_stmts_s</span>
<a name="line-112"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>pairs'</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-113"></a>  <span class='hs-keyword'>where</span>
<a name="line-114"></a>    <span class='hs-comment'>-- loop :: [([LStmt Name], [Name])] -&gt; TcM ([([LStmt TcId], [TcId])], thing)</span>
<a name="line-115"></a>    <span class='hs-varid'>loop</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>elt_ty</span>
<a name="line-116"></a>		 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>		<span class='hs-comment'>-- matching in the branches</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>names</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-119"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-120"></a>		<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLcStmt</span> <span class='hs-varid'>m_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-sel'>_elt_ty'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-121"></a>		   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocalIds</span> <span class='hs-varid'>names</span>
<a name="line-122"></a>		      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>pairs</span>
<a name="line-123"></a>		      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-124"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-125"></a>
<a name="line-126"></a><span class='hs-definition'>tcLcStmt</span> <span class='hs-varid'>m_tc</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span>
<a name="line-127"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>bindersMap</span>
<a name="line-128"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_bndr_names</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>bindersMap</span>
<a name="line-130"></a>             <span class='hs-varid'>unused_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcLcStmt: inner ty"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bindersMap</span><span class='hs-layout'>)</span>
<a name="line-131"></a>       	     <span class='hs-comment'>-- The inner 'stmts' lack a LastStmt, so the element type</span>
<a name="line-132"></a>	     <span class='hs-comment'>--  passed in to tcStmtsAndThen is never looked at</span>
<a name="line-133"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>by'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-134"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLcStmt</span> <span class='hs-varid'>m_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>unused_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-135"></a>	       <span class='hs-layout'>{</span> <span class='hs-varid'>by'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>by</span> <span class='hs-keyword'>of</span>
<a name="line-136"></a>                           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-137"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferRho</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>e_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-138"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>bndr_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocalIds</span> <span class='hs-varid'>bndr_names</span>
<a name="line-139"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>by'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-140"></a>
<a name="line-141"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>m_app</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>m_tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-142"></a>
<a name="line-143"></a>       <span class='hs-comment'>--------------- Typecheck the 'using' function -------------</span>
<a name="line-144"></a>       <span class='hs-comment'>-- using :: ((a,b,c)-&gt;t) -&gt; m (a,b,c) -&gt; m (a,b,c)m      (ThenForm)</span>
<a name="line-145"></a>       <span class='hs-comment'>--       :: ((a,b,c)-&gt;t) -&gt; m (a,b,c) -&gt; m (m (a,b,c)))  (GroupForm)</span>
<a name="line-146"></a>
<a name="line-147"></a>         <span class='hs-comment'>-- n_app :: Type -&gt; Type   -- Wraps a 'ty' into '[ty]' for GroupForm</span>
<a name="line-148"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>form</span> <span class='hs-keyword'>of</span>
<a name="line-149"></a>                       <span class='hs-conid'>ThenForm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-150"></a>  		       <span class='hs-keyword'>_</span> 	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m_app</span>
<a name="line-151"></a>
<a name="line-152"></a>             <span class='hs-varid'>by_arrow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>     <span class='hs-comment'>-- Wraps 'ty' to '(a-&gt;t) -&gt; ty' if the By is present</span>
<a name="line-153"></a>             <span class='hs-varid'>by_arrow</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>by'</span> <span class='hs-keyword'>of</span>
<a name="line-154"></a>                          <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-155"></a>                          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>e_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>alphaTy</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>e_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>ty</span>
<a name="line-156"></a>
<a name="line-157"></a>             <span class='hs-varid'>tup_ty</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBigCoreVarTupTy</span> <span class='hs-varid'>bndr_ids</span>
<a name="line-158"></a>             <span class='hs-varid'>poly_arg_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m_app</span> <span class='hs-varid'>alphaTy</span>
<a name="line-159"></a>	     <span class='hs-varid'>poly_res_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_app</span> <span class='hs-varid'>alphaTy</span><span class='hs-layout'>)</span>
<a name="line-160"></a>	     <span class='hs-varid'>using_poly_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>alphaTyVar</span> <span class='hs-varop'>$</span> <span class='hs-varid'>by_arrow</span> <span class='hs-varop'>$</span> 
<a name="line-161"></a>                             <span class='hs-varid'>poly_arg_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>poly_res_ty</span>
<a name="line-162"></a>
<a name="line-163"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>using'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>using</span> <span class='hs-varid'>using_poly_ty</span>
<a name="line-164"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>tup_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>using'</span> 
<a name="line-165"></a>
<a name="line-166"></a>	     <span class='hs-comment'>-- 'stmts' returns a result of type (m1_ty tuple_ty),</span>
<a name="line-167"></a>	     <span class='hs-comment'>-- typically something like [(Int,Bool,Int)]</span>
<a name="line-168"></a>	     <span class='hs-comment'>-- We don't know what tuple_ty is yet, so we use a variable</span>
<a name="line-169"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mk_n_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span>
<a name="line-170"></a>             <span class='hs-varid'>mk_n_bndr</span> <span class='hs-varid'>n_bndr_name</span> <span class='hs-varid'>bndr_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>n_bndr_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-171"></a>
<a name="line-172"></a>             <span class='hs-comment'>-- Ensure that every old binder of type `b` is linked up with its</span>
<a name="line-173"></a>             <span class='hs-comment'>-- new binder which should have type `n b`</span>
<a name="line-174"></a>	     <span class='hs-comment'>-- See Note [GroupStmt binder map] in HsExpr</span>
<a name="line-175"></a>             <span class='hs-varid'>n_bndr_ids</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_n_bndr</span> <span class='hs-varid'>n_bndr_names</span> <span class='hs-varid'>bndr_ids</span>
<a name="line-176"></a>             <span class='hs-varid'>bindersMap'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr_ids</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>n_bndr_ids</span>
<a name="line-177"></a>
<a name="line-178"></a>       <span class='hs-comment'>-- Type check the thing in the environment with </span>
<a name="line-179"></a>       <span class='hs-comment'>-- these new binders and return the result</span>
<a name="line-180"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendIdEnv</span> <span class='hs-varid'>n_bndr_ids</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span>
<a name="line-181"></a>
<a name="line-182"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyTransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersMap'</span> 
<a name="line-183"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_using</span> 
<a name="line-184"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-185"></a>    
<a name="line-186"></a><span class='hs-definition'>tcLcStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcLcStmt: unexpected Stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-188"></a>
<a name="line-189"></a>
<a name="line-190"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-191"></a><span class='hs-comment'>--	     Monad comprehensions </span>
<a name="line-192"></a><span class='hs-comment'>--	  (supports rebindable syntax)</span>
<a name="line-193"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="tcMcStmt"></a><span class='hs-definition'>tcMcStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcExprStmtChecker</span>
<a name="line-196"></a>
<a name="line-197"></a><span class='hs-definition'>tcMcStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>return_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>a_ty</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-199"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>return_op</span>
<a name="line-200"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>a_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-201"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>body'</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>body</span> <span class='hs-varid'>a_ty</span>
<a name="line-202"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"tcMcStmt: thing_inside"</span><span class='hs-layout'>)</span>
<a name="line-203"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>return_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-comment'>-- Generators for monad comprehensions ( pat &lt;- rhs )</span>
<a name="line-206"></a><span class='hs-comment'>--</span>
<a name="line-207"></a><span class='hs-comment'>--   [ body | q &lt;- gen ]  -&gt;  gen :: m a</span>
<a name="line-208"></a><span class='hs-comment'>--                            q   ::   a</span>
<a name="line-209"></a><span class='hs-comment'>--</span>
<a name="line-210"></a>
<a name="line-211"></a><span class='hs-definition'>tcMcStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-212"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>rhs_ty</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-213"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>pat_ty</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-214"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-215"></a>
<a name="line-216"></a>	   <span class='hs-comment'>-- (&gt;&gt;=) :: rhs_ty -&gt; (pat_ty -&gt; new_res_ty) -&gt; res_ty</span>
<a name="line-217"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bind_op'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>bind_op</span> 
<a name="line-218"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>new_res_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-219"></a>
<a name="line-220"></a>           <span class='hs-comment'>-- If (but only if) the pattern can fail, typecheck the 'fail' operator</span>
<a name="line-221"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fail_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isIrrefutableHsPat</span> <span class='hs-varid'>pat</span> 
<a name="line-222"></a>                      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>noSyntaxExpr</span>
<a name="line-223"></a>                      <span class='hs-keyword'>else</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>fail_op</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>stringTy</span> <span class='hs-varid'>new_res_ty</span><span class='hs-layout'>)</span>
<a name="line-224"></a>
<a name="line-225"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-226"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varop'>$</span>
<a name="line-227"></a>                           <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_res_ty</span>
<a name="line-228"></a>
<a name="line-229"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>bind_op'</span> <span class='hs-varid'>fail_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-230"></a>
<a name="line-231"></a><span class='hs-comment'>-- Boolean expressions.</span>
<a name="line-232"></a><span class='hs-comment'>--</span>
<a name="line-233"></a><span class='hs-comment'>--   [ body | stmts, expr ]  -&gt;  expr :: m Bool</span>
<a name="line-234"></a><span class='hs-comment'>--</span>
<a name="line-235"></a><span class='hs-definition'>tcMcStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>then_op</span> <span class='hs-varid'>guard_op</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-236"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-comment'>-- Deal with rebindable syntax:</span>
<a name="line-237"></a>          <span class='hs-comment'>--    guard_op :: test_ty -&gt; rhs_ty</span>
<a name="line-238"></a>          <span class='hs-comment'>--    then_op  :: rhs_ty -&gt; new_res_ty -&gt; res_ty</span>
<a name="line-239"></a>          <span class='hs-comment'>-- Where test_ty is, for example, Bool</span>
<a name="line-240"></a>          <span class='hs-varid'>test_ty</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-241"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs_ty</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-242"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-243"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>test_ty</span>
<a name="line-244"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>guard_op'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>guard_op</span>
<a name="line-245"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>test_ty</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span>
<a name="line-246"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>then_op'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>then_op</span>
<a name="line-247"></a>		                   <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_res_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-248"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>thing</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_res_ty</span>
<a name="line-249"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>then_op'</span> <span class='hs-varid'>guard_op'</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-250"></a>
<a name="line-251"></a><span class='hs-comment'>-- Grouping statements</span>
<a name="line-252"></a><span class='hs-comment'>--</span>
<a name="line-253"></a><span class='hs-comment'>--   [ body | stmts, then group by e using f ]</span>
<a name="line-254"></a><span class='hs-comment'>--     -&gt;  e :: t</span>
<a name="line-255"></a><span class='hs-comment'>--         f :: forall a. (a -&gt; t) -&gt; m a -&gt; m (m a)</span>
<a name="line-256"></a><span class='hs-comment'>--   [ body | stmts, then group using f ]</span>
<a name="line-257"></a><span class='hs-comment'>--     -&gt;  f :: forall a. m a -&gt; m (m a)</span>
<a name="line-258"></a>
<a name="line-259"></a><span class='hs-comment'>-- We type [ body | (stmts, group by e using f), ... ]</span>
<a name="line-260"></a><span class='hs-comment'>--     f &lt;optional by&gt; [ (a,b,c) | stmts ] &gt;&gt;= \(a,b,c) -&gt; ...body....</span>
<a name="line-261"></a><span class='hs-comment'>--</span>
<a name="line-262"></a><span class='hs-comment'>-- We type the functions as follows:</span>
<a name="line-263"></a><span class='hs-comment'>--     f &lt;optional by&gt; :: m1 (a,b,c) -&gt; m2 (a,b,c)		(ThenForm)</span>
<a name="line-264"></a><span class='hs-comment'>--     	 	       :: m1 (a,b,c) -&gt; m2 (n (a,b,c))		(GroupForm)</span>
<a name="line-265"></a><span class='hs-comment'>--     (&gt;&gt;=) :: m2 (a,b,c)     -&gt; ((a,b,c)   -&gt; res) -&gt; res	(ThenForm)</span>
<a name="line-266"></a><span class='hs-comment'>--           :: m2 (n (a,b,c)) -&gt; (n (a,b,c) -&gt; res) -&gt; res	(GroupForm)</span>
<a name="line-267"></a><span class='hs-comment'>-- </span>
<a name="line-268"></a><span class='hs-definition'>tcMcStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersMap</span>
<a name="line-269"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span>
<a name="line-270"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>trS_ret</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span> 
<a name="line-271"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>trS_fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap_op</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-272"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>star_star_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varop'>`mkArrowKind`</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-273"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>m1_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>star_star_kind</span>
<a name="line-274"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>m2_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>star_star_kind</span>
<a name="line-275"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tup_ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-276"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>by_e_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>  <span class='hs-comment'>-- The type of the 'by' expression (if any)</span>
<a name="line-277"></a>
<a name="line-278"></a>         <span class='hs-comment'>-- n_app :: Type -&gt; Type   -- Wraps a 'ty' into '(n ty)' for GroupForm</span>
<a name="line-279"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>n_app</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>form</span> <span class='hs-keyword'>of</span>
<a name="line-280"></a>                    <span class='hs-conid'>ThenForm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-281"></a>		    <span class='hs-keyword'>_</span> 	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>star_star_kind</span>
<a name="line-282"></a>                      	           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_ty</span> <span class='hs-varop'>`mkAppTy`</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-283"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>by_arrow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>     
<a name="line-284"></a>             <span class='hs-comment'>-- (by_arrow res) produces ((alpha-&gt;e_ty) -&gt; res)     ('by' present)</span>
<a name="line-285"></a>             <span class='hs-comment'>--                          or res                    ('by' absent) </span>
<a name="line-286"></a>             <span class='hs-varid'>by_arrow</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>by</span> <span class='hs-keyword'>of</span>
<a name="line-287"></a>                          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-288"></a>                          <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>alphaTy</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>by_e_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>res</span>
<a name="line-289"></a>
<a name="line-290"></a>             <span class='hs-varid'>poly_arg_ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m1_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>alphaTy</span>
<a name="line-291"></a>             <span class='hs-varid'>using_arg_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m1_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>tup_ty</span>
<a name="line-292"></a>	     <span class='hs-varid'>poly_res_ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m2_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>n_app</span> <span class='hs-varid'>alphaTy</span>
<a name="line-293"></a>	     <span class='hs-varid'>using_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m2_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>n_app</span> <span class='hs-varid'>tup_ty</span>
<a name="line-294"></a>	     <span class='hs-varid'>using_poly_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>alphaTyVar</span> <span class='hs-varop'>$</span> <span class='hs-varid'>by_arrow</span> <span class='hs-varop'>$</span> 
<a name="line-295"></a>                             <span class='hs-varid'>poly_arg_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>poly_res_ty</span>
<a name="line-296"></a>
<a name="line-297"></a>	     <span class='hs-comment'>-- 'stmts' returns a result of type (m1_ty tuple_ty),</span>
<a name="line-298"></a>	     <span class='hs-comment'>-- typically something like [(Int,Bool,Int)]</span>
<a name="line-299"></a>	     <span class='hs-comment'>-- We don't know what tuple_ty is yet, so we use a variable</span>
<a name="line-300"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_bndr_names</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>bindersMap</span>
<a name="line-301"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>return_op'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-302"></a>            <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tcMcStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>using_arg_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>res_ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-303"></a>	        <span class='hs-layout'>{</span> <span class='hs-varid'>by'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>by</span> <span class='hs-keyword'>of</span>
<a name="line-304"></a>                           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-305"></a>                           <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>e</span> <span class='hs-varid'>by_e_ty</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-306"></a>
<a name="line-307"></a>                <span class='hs-comment'>-- Find the Ids (and hence types) of all old binders</span>
<a name="line-308"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>bndr_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocalIds</span> <span class='hs-varid'>bndr_names</span>
<a name="line-309"></a>
<a name="line-310"></a>                <span class='hs-comment'>-- 'return' is only used for the binders, so we know its type.</span>
<a name="line-311"></a>                <span class='hs-comment'>--   return :: (a,b,c,..) -&gt; m (a,b,c,..)</span>
<a name="line-312"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>return_op</span> <span class='hs-varop'>$</span> 
<a name="line-313"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>mkBigCoreVarTupTy</span> <span class='hs-varid'>bndr_ids</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>res_ty'</span>
<a name="line-314"></a>
<a name="line-315"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>return_op'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-316"></a>
<a name="line-317"></a>       <span class='hs-comment'>--------------- Typecheck the 'bind' function -------------</span>
<a name="line-318"></a>       <span class='hs-comment'>-- (&gt;&gt;=) :: m2 (n (a,b,c)) -&gt; ( n (a,b,c) -&gt; new_res_ty ) -&gt; res_ty</span>
<a name="line-319"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-320"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bind_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>bind_op</span> <span class='hs-varop'>$</span>
<a name="line-321"></a>                                <span class='hs-varid'>using_res_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_app</span> <span class='hs-varid'>tup_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>new_res_ty</span><span class='hs-layout'>)</span>
<a name="line-322"></a>                                             <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>res_ty</span>
<a name="line-323"></a>
<a name="line-324"></a>       <span class='hs-comment'>--------------- Typecheck the 'fmap' function -------------</span>
<a name="line-325"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fmap_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>form</span> <span class='hs-keyword'>of</span>
<a name="line-326"></a>                       <span class='hs-conid'>ThenForm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>noSyntaxExpr</span>
<a name="line-327"></a>                       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>fmap_op</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-328"></a>                            <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>alphaTyVar</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>betaTyVar</span> <span class='hs-varop'>$</span>
<a name="line-329"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>alphaTy</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>betaTy</span><span class='hs-layout'>)</span>
<a name="line-330"></a>                            <span class='hs-varop'>`mkFunTy`</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_app</span> <span class='hs-varid'>alphaTy</span><span class='hs-layout'>)</span>
<a name="line-331"></a>                            <span class='hs-varop'>`mkFunTy`</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_app</span> <span class='hs-varid'>betaTy</span><span class='hs-layout'>)</span>
<a name="line-332"></a>
<a name="line-333"></a>       <span class='hs-comment'>--------------- Typecheck the 'using' function -------------</span>
<a name="line-334"></a>       <span class='hs-comment'>-- using :: ((a,b,c)-&gt;t) -&gt; m1 (a,b,c) -&gt; m2 (n (a,b,c))</span>
<a name="line-335"></a>
<a name="line-336"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>using'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-varid'>using</span> <span class='hs-varid'>using_poly_ty</span>
<a name="line-337"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>tup_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>using'</span> 
<a name="line-338"></a>
<a name="line-339"></a>       <span class='hs-comment'>--------------- Bulding the bindersMap ----------------</span>
<a name="line-340"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mk_n_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span>
<a name="line-341"></a>             <span class='hs-varid'>mk_n_bndr</span> <span class='hs-varid'>n_bndr_name</span> <span class='hs-varid'>bndr_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>n_bndr_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-342"></a>
<a name="line-343"></a>             <span class='hs-comment'>-- Ensure that every old binder of type `b` is linked up with its</span>
<a name="line-344"></a>             <span class='hs-comment'>-- new binder which should have type `n b`</span>
<a name="line-345"></a>	     <span class='hs-comment'>-- See Note [GroupStmt binder map] in HsExpr</span>
<a name="line-346"></a>             <span class='hs-varid'>n_bndr_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_n_bndr</span> <span class='hs-varid'>n_bndr_names</span> <span class='hs-varid'>bndr_ids</span>
<a name="line-347"></a>             <span class='hs-varid'>bindersMap'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr_ids</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>n_bndr_ids</span>
<a name="line-348"></a>
<a name="line-349"></a>       <span class='hs-comment'>-- Type check the thing in the environment with </span>
<a name="line-350"></a>       <span class='hs-comment'>-- these new binders and return the result</span>
<a name="line-351"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendIdEnv</span> <span class='hs-varid'>n_bndr_ids</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_res_ty</span><span class='hs-layout'>)</span>
<a name="line-352"></a>
<a name="line-353"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersMap'</span> 
<a name="line-354"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_using</span> 
<a name="line-355"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>trS_ret</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op'</span>
<a name="line-356"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>trS_fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-357"></a>
<a name="line-358"></a><span class='hs-comment'>-- A parallel set of comprehensions</span>
<a name="line-359"></a><span class='hs-comment'>--	[ (g x, h x) | ... ; let g v = ...</span>
<a name="line-360"></a><span class='hs-comment'>--		     | ... ; let h v = ... ]</span>
<a name="line-361"></a><span class='hs-comment'>--</span>
<a name="line-362"></a><span class='hs-comment'>-- It's possible that g,h are overloaded, so we need to feed the LIE from the</span>
<a name="line-363"></a><span class='hs-comment'>-- (g x, h x) up through both lots of bindings (so we get the bindLocalMethods).</span>
<a name="line-364"></a><span class='hs-comment'>-- Similarly if we had an existential pattern match:</span>
<a name="line-365"></a><span class='hs-comment'>--</span>
<a name="line-366"></a><span class='hs-comment'>--	data T = forall a. Show a =&gt; C a</span>
<a name="line-367"></a><span class='hs-comment'>--</span>
<a name="line-368"></a><span class='hs-comment'>--	[ (show x, show y) | ... ; C x &lt;- ...</span>
<a name="line-369"></a><span class='hs-comment'>--			   | ... ; C y &lt;- ... ]</span>
<a name="line-370"></a><span class='hs-comment'>--</span>
<a name="line-371"></a><span class='hs-comment'>-- Then we need the LIE from (show x, show y) to be simplified against</span>
<a name="line-372"></a><span class='hs-comment'>-- the bindings for x and y.  </span>
<a name="line-373"></a><span class='hs-comment'>-- </span>
<a name="line-374"></a><span class='hs-comment'>-- It's difficult to do this in parallel, so we rely on the renamer to </span>
<a name="line-375"></a><span class='hs-comment'>-- ensure that g,h and x,y don't duplicate, and simply grow the environment.</span>
<a name="line-376"></a><span class='hs-comment'>-- So the binders of the first parallel group will be in scope in the second</span>
<a name="line-377"></a><span class='hs-comment'>-- group.  But that's fine; there's no shadowing to worry about.</span>
<a name="line-378"></a><span class='hs-comment'>--</span>
<a name="line-379"></a><span class='hs-comment'>-- Note: The `mzip` function will get typechecked via:</span>
<a name="line-380"></a><span class='hs-comment'>--</span>
<a name="line-381"></a><span class='hs-comment'>--   ParStmt [st1::t1, st2::t2, st3::t3]</span>
<a name="line-382"></a><span class='hs-comment'>--   </span>
<a name="line-383"></a><span class='hs-comment'>--   mzip :: m st1</span>
<a name="line-384"></a><span class='hs-comment'>--        -&gt; (m st2 -&gt; m st3 -&gt; m (st2, st3))   -- recursive call</span>
<a name="line-385"></a><span class='hs-comment'>--        -&gt; m (st1, (st2, st3))</span>
<a name="line-386"></a><span class='hs-comment'>--</span>
<a name="line-387"></a><span class='hs-definition'>tcMcStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>bndr_stmts_s</span> <span class='hs-varid'>mzip_op</span> <span class='hs-varid'>bind_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-388"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>star_star_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varop'>`mkArrowKind`</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-389"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>m_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>star_star_kind</span>
<a name="line-390"></a>
<a name="line-391"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mzip_ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>betaTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-392"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>m_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>alphaTy</span><span class='hs-layout'>)</span>
<a name="line-393"></a>                        <span class='hs-varop'>`mkFunTy`</span>
<a name="line-394"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>m_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>betaTy</span><span class='hs-layout'>)</span>
<a name="line-395"></a>                        <span class='hs-varop'>`mkFunTy`</span>
<a name="line-396"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>m_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>mkBoxedTupleTy</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>betaTy</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-397"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mzip_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unLoc</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>tcPolyExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>mzip_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>mzip_ty</span>
<a name="line-398"></a>
<a name="line-399"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>blocks'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>m_ty</span> <span class='hs-varid'>bndr_stmts_s</span>
<a name="line-400"></a>
<a name="line-401"></a>       <span class='hs-comment'>-- Typecheck bind:</span>
<a name="line-402"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkBigCoreVarTupTy</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ParStmtBlock</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>blocks'</span><span class='hs-keyglyph'>]</span>
<a name="line-403"></a>             <span class='hs-varid'>tuple_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_tuple_ty</span> <span class='hs-varid'>tys</span>
<a name="line-404"></a>
<a name="line-405"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bind_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>bind_op</span> <span class='hs-varop'>$</span>
<a name="line-406"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>m_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>tuple_ty</span><span class='hs-layout'>)</span>
<a name="line-407"></a>                        <span class='hs-varop'>`mkFunTy`</span> <span class='hs-layout'>(</span><span class='hs-varid'>tuple_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-408"></a>                        <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>res_ty</span>
<a name="line-409"></a>
<a name="line-410"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>blocks'</span> <span class='hs-varid'>mzip_op'</span> <span class='hs-varid'>bind_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-411"></a>
<a name="line-412"></a>  <span class='hs-keyword'>where</span> 
<a name="line-413"></a>    <span class='hs-varid'>mk_tuple_ty</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr1</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tn</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkBoxedTupleTy</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tn</span><span class='hs-layout'>,</span> <span class='hs-varid'>tm</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-414"></a>
<a name="line-415"></a>       <span class='hs-comment'>-- loop :: Type                                  -- m_ty</span>
<a name="line-416"></a>       <span class='hs-comment'>--      -&gt; [([LStmt Name], [Name])]</span>
<a name="line-417"></a>       <span class='hs-comment'>--      -&gt; TcM ([([LStmt TcId], [TcId])], thing)</span>
<a name="line-418"></a>    <span class='hs-varid'>loop</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>res_ty</span>
<a name="line-419"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>           <span class='hs-comment'>-- matching in the branches</span>
<a name="line-420"></a>
<a name="line-421"></a>    <span class='hs-varid'>loop</span> <span class='hs-varid'>m_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>names</span> <span class='hs-varid'>return_op</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-422"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- type dummy since we don't know all binder types yet</span>
<a name="line-423"></a>             <span class='hs-varid'>id_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>
<a name="line-424"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>m_tup_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m_ty</span> <span class='hs-varop'>`mkAppTy`</span> <span class='hs-varid'>mkBigCoreTupTy</span> <span class='hs-varid'>id_tys</span>
<a name="line-425"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>return_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-426"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tcMcStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>m_tup_ty</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>m_tup_ty'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-427"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocalIds</span> <span class='hs-varid'>names</span>
<a name="line-428"></a>    		      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tup_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBigCoreVarTupTy</span> <span class='hs-varid'>ids</span>
<a name="line-429"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>MCompOrigin</span> <span class='hs-varid'>return_op</span>
<a name="line-430"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>tup_ty</span> <span class='hs-varop'>`mkFunTy`</span> <span class='hs-varid'>m_tup_ty'</span><span class='hs-layout'>)</span>
<a name="line-431"></a>                      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>m_ty</span> <span class='hs-varid'>pairs</span>
<a name="line-432"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>return_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-433"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts'</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>return_op'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-434"></a>
<a name="line-435"></a><span class='hs-definition'>tcMcStmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-436"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcMcStmt: unexpected Stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-437"></a>
<a name="line-438"></a>
<a name="line-439"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-440"></a><span class='hs-comment'>--	     Do-notation</span>
<a name="line-441"></a><span class='hs-comment'>--	  (supports rebindable syntax)</span>
<a name="line-442"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-443"></a>
<a name="line-444"></a><a name="tcDoStmt"></a><span class='hs-definition'>tcDoStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcExprStmtChecker</span>
<a name="line-445"></a>
<a name="line-446"></a><span class='hs-definition'>tcDoStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-447"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>body</span> <span class='hs-varid'>res_ty</span>
<a name="line-448"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"tcDoStmt: thing_inside"</span><span class='hs-layout'>)</span>
<a name="line-449"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-450"></a>
<a name="line-451"></a><span class='hs-definition'>tcDoStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-452"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Deal with rebindable syntax:</span>
<a name="line-453"></a>		<span class='hs-comment'>--	 (&gt;&gt;=) :: rhs_ty -&gt; (pat_ty -&gt; new_res_ty) -&gt; res_ty</span>
<a name="line-454"></a>		<span class='hs-comment'>-- This level of generality is needed for using do-notation</span>
<a name="line-455"></a>		<span class='hs-comment'>-- in full generality; see Trac #1537</span>
<a name="line-456"></a>
<a name="line-457"></a>		<span class='hs-comment'>-- I'd like to put this *after* the tcSyntaxOp </span>
<a name="line-458"></a>                <span class='hs-comment'>-- (see Note [Treat rebindable syntax first], but that breaks </span>
<a name="line-459"></a>		<span class='hs-comment'>-- the rigidity info for GADTs.  When we move to the new story</span>
<a name="line-460"></a>                <span class='hs-comment'>-- for GADTs, we can move this after tcSyntaxOp</span>
<a name="line-461"></a>          <span class='hs-varid'>rhs_ty</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-462"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>pat_ty</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-463"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-464"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>bind_op'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>DoOrigin</span> <span class='hs-varid'>bind_op</span> 
<a name="line-465"></a>			     <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varid'>new_res_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-466"></a>
<a name="line-467"></a>		<span class='hs-comment'>-- If (but only if) the pattern can fail, </span>
<a name="line-468"></a>		<span class='hs-comment'>-- typecheck the 'fail' operator</span>
<a name="line-469"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>fail_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isIrrefutableHsPat</span> <span class='hs-varid'>pat</span> 
<a name="line-470"></a>		      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>noSyntaxExpr</span>
<a name="line-471"></a>		      <span class='hs-keyword'>else</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>DoOrigin</span> <span class='hs-varid'>fail_op</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>stringTy</span> <span class='hs-varid'>new_res_ty</span><span class='hs-layout'>)</span>
<a name="line-472"></a>
<a name="line-473"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-474"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>pat_ty</span> <span class='hs-varop'>$</span>
<a name="line-475"></a>                           <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_res_ty</span>
<a name="line-476"></a>
<a name="line-477"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>bind_op'</span> <span class='hs-varid'>fail_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-478"></a>
<a name="line-479"></a>
<a name="line-480"></a><span class='hs-definition'>tcDoStmt</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>then_op</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-481"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>   	<span class='hs-comment'>-- Deal with rebindable syntax; </span>
<a name="line-482"></a>                <span class='hs-comment'>--   (&gt;&gt;) :: rhs_ty -&gt; new_res_ty -&gt; res_ty</span>
<a name="line-483"></a>		<span class='hs-comment'>-- See also Note [Treat rebindable syntax first]</span>
<a name="line-484"></a>          <span class='hs-varid'>rhs_ty</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-485"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-486"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>then_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>DoOrigin</span> <span class='hs-varid'>then_op</span> 
<a name="line-487"></a>			   <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_res_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-488"></a>
<a name="line-489"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMonoExprNC</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-490"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_res_ty</span>
<a name="line-491"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>then_op'</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-492"></a>
<a name="line-493"></a><span class='hs-definition'>tcDoStmt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>later_names</span>
<a name="line-494"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ret_op</span>
<a name="line-495"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>recS_mfix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mfix_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_bind_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-496"></a>         <span class='hs-varid'>res_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-497"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tup_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_names</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>rec_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>later_names</span>
<a name="line-498"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tup_elt_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tup_names</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-499"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tup_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>tup_names</span> <span class='hs-varid'>tup_elt_tys</span>
<a name="line-500"></a>	      <span class='hs-varid'>tup_ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBigCoreTupTy</span> <span class='hs-varid'>tup_elt_tys</span>
<a name="line-501"></a>
<a name="line-502"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendIdEnv</span> <span class='hs-varid'>tup_ids</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-503"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>stmts_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-504"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tup_rets</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-505"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcStmtsAndThen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tcDoStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>stmts_ty</span>   <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inner_res_ty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-506"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tup_rets</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>tcCheckId</span> <span class='hs-varid'>tup_names</span> <span class='hs-varid'>tup_elt_tys</span>
<a name="line-507"></a>                             <span class='hs-comment'>-- Unify the types of the "final" Ids (which may </span>
<a name="line-508"></a>                             <span class='hs-comment'>-- be polymorphic) with those of "knot-tied" Ids</span>
<a name="line-509"></a>		      <span class='hs-layout'>;</span> <span class='hs-varid'>ret_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>DoOrigin</span> <span class='hs-varid'>ret_op</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>tup_ty</span> <span class='hs-varid'>inner_res_ty</span><span class='hs-layout'>)</span>
<a name="line-510"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tup_rets</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-511"></a>
<a name="line-512"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mfix_res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-513"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mfix_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>DoOrigin</span> <span class='hs-varid'>mfix_op</span>
<a name="line-514"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>tup_ty</span> <span class='hs-varid'>stmts_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>mfix_res_ty</span><span class='hs-layout'>)</span>
<a name="line-515"></a>
<a name="line-516"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>new_res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-517"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bind_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSyntaxOp</span> <span class='hs-conid'>DoOrigin</span> <span class='hs-varid'>bind_op</span> 
<a name="line-518"></a>			         <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mfix_res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>tup_ty</span> <span class='hs-varid'>new_res_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-519"></a>
<a name="line-520"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_res_ty</span>
<a name="line-521"></a>  
<a name="line-522"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rec_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeList</span> <span class='hs-varid'>rec_names</span> <span class='hs-varid'>tup_ids</span>
<a name="line-523"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>later_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocalIds</span> <span class='hs-varid'>later_names</span>
<a name="line-524"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcdo"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rec_ids</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>rec_ids</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-525"></a>                                 <span class='hs-varid'>ppr</span> <span class='hs-varid'>later_ids</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>later_ids</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-526"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>later_ids</span>
<a name="line-527"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ret_op'</span> 
<a name="line-528"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>recS_mfix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mfix_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_bind_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op'</span>
<a name="line-529"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_rets</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_rets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tup_rets</span>
<a name="line-530"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-531"></a>        <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-532"></a>
<a name="line-533"></a><span class='hs-definition'>tcDoStmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-534"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcDoStmt: unexpected Stmt"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Treat rebindable syntax first]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When typechecking
	do { bar; ... } :: IO ()
we want to typecheck 'bar' in the knowledge that it should be an IO thing,
pushing info from the context into the RHS.  To do this, we check the
rebindable syntax first, and push that information into (tcMonoExprNC rhs).
Otherwise the error shows up when cheking the rebindable syntax, and
the expected/inferred stuff is back to front (see Trac #3613).


%************************************************************************
%*									*
\subsection{Errors and contexts}
%*									*
%************************************************************************

@sameNoOfArgs@ takes a @[RenamedMatch]@ and decides whether the same
number of args are used in each equation.

\begin{code}
<pre><a name="line-1"></a><a name="checkArgs"></a><span class='hs-definition'>checkArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>checkArgs</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-4"></a><span class='hs-definition'>checkArgs</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match1</span><span class='hs-conop'>:</span><span class='hs-varid'>matches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-5"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>bad_matches</span> 
<a name="line-6"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-7"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-8"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Equations for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-9"></a>			  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"have different numbers of arguments"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-10"></a>			<span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>match1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-11"></a>			<span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>bad_matches</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>n_args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args_in_match</span> <span class='hs-varid'>match1</span>
<a name="line-14"></a>    <span class='hs-varid'>bad_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>args_in_match</span> <span class='hs-varid'>m</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n_args1</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-varid'>args_in_match</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LMatch</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-17"></a>    <span class='hs-varid'>args_in_match</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>pats</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>pats</span>
</pre>\end{code}

</body>
</html>
