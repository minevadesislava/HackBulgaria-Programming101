<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>basicTypes/RdrName.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE DeriveDataTypeable #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- |</span>
<a name="line-4"></a><span class='hs-comment'>-- #name_types#</span>
<a name="line-5"></a><span class='hs-comment'>-- GHC uses several kinds of name internally:</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-- * 'OccName.OccName': see "OccName#name_types"</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-- * 'RdrName.RdrName' is the type of names that come directly from the parser. They</span>
<a name="line-10"></a><span class='hs-comment'>--   have not yet had their scoping and binding resolved by the renamer and can be</span>
<a name="line-11"></a><span class='hs-comment'>--   thought of to a first approximation as an 'OccName.OccName' with an optional module</span>
<a name="line-12"></a><span class='hs-comment'>--   qualifier</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- * 'Name.Name': see "Name#name_types"</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- * 'Id.Id': see "Id#name_types"</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- * 'Var.Var': see "Var#name_types"</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span>
<a name="line-21"></a>        <span class='hs-comment'>-- * The main type</span>
<a name="line-22"></a>        <span class='hs-conid'>RdrName</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Constructors exported only to BinIface</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-comment'>-- ** Construction</span>
<a name="line-25"></a>        <span class='hs-varid'>mkRdrUnqual</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRdrQual</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>mkUnqual</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVarUnqual</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkQual</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOrig</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>nameRdrName</span><span class='hs-layout'>,</span> <span class='hs-varid'>getRdrName</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- ** Destruction</span>
<a name="line-30"></a>        <span class='hs-varid'>rdrNameOcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>rdrNameSpace</span><span class='hs-layout'>,</span> <span class='hs-varid'>setRdrNameSpace</span><span class='hs-layout'>,</span> <span class='hs-varid'>demoteRdrName</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>isRdrDataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRdrTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRdrTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>isQual</span><span class='hs-layout'>,</span> <span class='hs-varid'>isQual_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnqual</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>isOrig</span><span class='hs-layout'>,</span> <span class='hs-varid'>isOrig_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isExact</span><span class='hs-layout'>,</span> <span class='hs-varid'>isExact_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSrcRdrName</span><span class='hs-layout'>,</span>
<a name="line-33"></a>
<a name="line-34"></a>        <span class='hs-comment'>-- * Local mapping of 'RdrName' to 'Name.Name'</span>
<a name="line-35"></a>        <span class='hs-conid'>LocalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyLocalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendLocalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendLocalRdrEnvList</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>lookupLocalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupLocalRdrOcc</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>elemLocalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>inLocalRdrEnvScope</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>localRdrEnvElts</span><span class='hs-layout'>,</span> <span class='hs-varid'>delLocalRdrEnvList</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-comment'>-- * Global mapping of 'RdrName' to 'GlobalRdrElt's</span>
<a name="line-41"></a>        <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyGlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusGlobalRdrEnv</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>lookupGlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendGlobalRdrEnv</span><span class='hs-layout'>,</span> 
<a name="line-43"></a>        <span class='hs-varid'>pprGlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>globalRdrEnvElts</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>lookupGRE_RdrName</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupGRE_Name</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGRE_NameQualifier_maybes</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>transformGREs</span><span class='hs-layout'>,</span> <span class='hs-varid'>findLocalDupsRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickGREs</span><span class='hs-layout'>,</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-comment'>-- * GlobalRdrElts</span>
<a name="line-48"></a>        <span class='hs-varid'>gresFromAvails</span><span class='hs-layout'>,</span> <span class='hs-varid'>gresFromAvail</span><span class='hs-layout'>,</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-comment'>-- ** Global 'RdrName' mapping elements: 'GlobalRdrElt', 'Provenance', 'ImportSpec'</span>
<a name="line-51"></a>        <span class='hs-conid'>GlobalRdrElt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isLocalGRE</span><span class='hs-layout'>,</span> <span class='hs-varid'>unQualOK</span><span class='hs-layout'>,</span> <span class='hs-varid'>qualSpecOK</span><span class='hs-layout'>,</span> <span class='hs-varid'>unQualSpecOK</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-conid'>Provenance</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprNameProvenance</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-conid'>Parent</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-conid'>ImportSpec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImpDeclSpec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImpItemSpec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>importSpecLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>importSpecModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>isExplicitItem</span>
<a name="line-56"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span><span class='hs-layout'>(</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{The main data type}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="RdrName"></a><span class='hs-comment'>-- | Do not use the data constructors of RdrName directly: prefer the family</span>
<a name="line-2"></a><a name="RdrName"></a><span class='hs-comment'>-- of functions that creates them, such as 'mkRdrUnqual'</span>
<a name="line-3"></a><a name="RdrName"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RdrName</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unqual</span> <span class='hs-conid'>OccName</span>
<a name="line-5"></a>        <span class='hs-comment'>-- ^ Used for ordinary, unqualified occurrences, e.g. @x@, @y@ or @Foo@.</span>
<a name="line-6"></a>        <span class='hs-comment'>-- Create such a 'RdrName' with 'mkRdrUnqual'</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Qual</span> <span class='hs-conid'>ModuleName</span> <span class='hs-conid'>OccName</span>
<a name="line-9"></a>        <span class='hs-comment'>-- ^ A qualified name written by the user in</span>
<a name="line-10"></a>        <span class='hs-comment'>-- /source/ code.  The module isn't necessarily</span>
<a name="line-11"></a>        <span class='hs-comment'>-- the module where the thing is defined;</span>
<a name="line-12"></a>        <span class='hs-comment'>-- just the one from which it is imported.</span>
<a name="line-13"></a>        <span class='hs-comment'>-- Examples are @Bar.x@, @Bar.y@ or @Bar.Foo@.</span>
<a name="line-14"></a>        <span class='hs-comment'>-- Create such a 'RdrName' with 'mkRdrQual'</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Orig</span> <span class='hs-conid'>Module</span> <span class='hs-conid'>OccName</span>
<a name="line-17"></a>        <span class='hs-comment'>-- ^ An original name; the module is the /defining/ module.</span>
<a name="line-18"></a>        <span class='hs-comment'>-- This is used when GHC generates code that will be fed</span>
<a name="line-19"></a>        <span class='hs-comment'>-- into the renamer (e.g. from deriving clauses), but where</span>
<a name="line-20"></a>        <span class='hs-comment'>-- we want to say \"Use Prelude.map dammit\". One of these</span>
<a name="line-21"></a>        <span class='hs-comment'>-- can be created with 'mkOrig'</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Exact</span> <span class='hs-conid'>Name</span>
<a name="line-24"></a>        <span class='hs-comment'>-- ^ We know exactly the 'Name'. This is used:</span>
<a name="line-25"></a>        <span class='hs-comment'>--</span>
<a name="line-26"></a>        <span class='hs-comment'>--  (1) When the parser parses built-in syntax like @[]@</span>
<a name="line-27"></a>        <span class='hs-comment'>--      and @(,)@, but wants a 'RdrName' from it</span>
<a name="line-28"></a>        <span class='hs-comment'>--</span>
<a name="line-29"></a>        <span class='hs-comment'>--  (2) By Template Haskell, when TH has generated a unique name</span>
<a name="line-30"></a>        <span class='hs-comment'>--</span>
<a name="line-31"></a>        <span class='hs-comment'>-- Such a 'RdrName' can be created by using 'getRdrName' on a 'Name'</span>
<a name="line-32"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Simple functions}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasOccName</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyword'>where</span>
<a name="line-3"></a>  <span class='hs-varid'>occName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdrNameOcc</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="rdrNameOcc"></a><span class='hs-definition'>rdrNameOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-6"></a><span class='hs-definition'>rdrNameOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span>
<a name="line-7"></a><span class='hs-definition'>rdrNameOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span>
<a name="line-8"></a><span class='hs-definition'>rdrNameOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span>
<a name="line-9"></a><span class='hs-definition'>rdrNameOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="rdrNameSpace"></a><span class='hs-definition'>rdrNameSpace</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSpace</span>
<a name="line-12"></a><span class='hs-definition'>rdrNameSpace</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameSpace</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rdrNameOcc</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="setRdrNameSpace"></a><span class='hs-definition'>setRdrNameSpace</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-15"></a><span class='hs-comment'>-- ^ This rather gruesome function is used mainly by the parser.</span>
<a name="line-16"></a><span class='hs-comment'>-- When parsing:</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- &gt; data T a = T | T1 Int</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- we parse the data constructors as /types/ because of parser ambiguities,</span>
<a name="line-21"></a><span class='hs-comment'>-- so then we need to change the /type constr/ to a /data constr/</span>
<a name="line-22"></a><span class='hs-comment'>--</span>
<a name="line-23"></a><span class='hs-comment'>-- The exact-name case /can/ occur when parsing:</span>
<a name="line-24"></a><span class='hs-comment'>--</span>
<a name="line-25"></a><span class='hs-comment'>-- &gt; data [] a = [] | a : [a]</span>
<a name="line-26"></a><span class='hs-comment'>--</span>
<a name="line-27"></a><span class='hs-comment'>-- For the exact-name case we return an original name.</span>
<a name="line-28"></a><span class='hs-definition'>setRdrNameSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>setOccNameSpace</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-definition'>setRdrNameSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Qual</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>setOccNameSpace</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-definition'>setRdrNameSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-varid'>m</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Orig</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>setOccNameSpace</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-definition'>setRdrNameSpace</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span>
<a name="line-32"></a>                                  <span class='hs-conid'>Orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>setOccNameSpace</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="demoteRdrName"></a><span class='hs-comment'>-- demoteRdrName lowers the NameSpace of RdrName.</span>
<a name="line-36"></a><span class='hs-comment'>-- see Note [Demotion] in OccName</span>
<a name="line-37"></a><span class='hs-definition'>demoteRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>RdrName</span>
<a name="line-38"></a><span class='hs-definition'>demoteRdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>Unqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>demoteOccName</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-definition'>demoteRdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>demoteOccName</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-definition'>demoteRdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"demoteRdrName"</span>
<a name="line-41"></a><span class='hs-definition'>demoteRdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"demoteRdrName"</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a>        <span class='hs-comment'>-- These two are the basic constructors</span>
<a name="line-2"></a><a name="mkRdrUnqual"></a><span class='hs-definition'>mkRdrUnqual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-3"></a><span class='hs-definition'>mkRdrUnqual</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="mkRdrQual"></a><span class='hs-definition'>mkRdrQual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-6"></a><span class='hs-definition'>mkRdrQual</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Qual</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="mkOrig"></a><span class='hs-definition'>mkOrig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-9"></a><span class='hs-definition'>mkOrig</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Orig</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>---------------</span>
<a name="line-12"></a>        <span class='hs-comment'>-- These two are used when parsing source files</span>
<a name="line-13"></a>        <span class='hs-comment'>-- They do encode the module and occurrence names</span>
<a name="line-14"></a><a name="mkUnqual"></a><span class='hs-definition'>mkUnqual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-15"></a><span class='hs-definition'>mkUnqual</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkOccNameFS</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="mkVarUnqual"></a><span class='hs-definition'>mkVarUnqual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-18"></a><span class='hs-definition'>mkVarUnqual</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="mkQual"></a><span class='hs-comment'>-- | Make a qualified 'RdrName' in the given namespace and where the 'ModuleName' and</span>
<a name="line-21"></a><span class='hs-comment'>-- the 'OccName' are taken from the first and second elements of the tuple respectively</span>
<a name="line-22"></a><span class='hs-definition'>mkQual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FastString</span><span class='hs-layout'>,</span> <span class='hs-conid'>FastString</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-23"></a><span class='hs-definition'>mkQual</span> <span class='hs-varid'>sp</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Qual</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleNameFS</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkOccNameFS</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="getRdrName"></a><span class='hs-definition'>getRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NamedThing</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-26"></a><span class='hs-definition'>getRdrName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameRdrName</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="nameRdrName"></a><span class='hs-definition'>nameRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-29"></a><span class='hs-definition'>nameRdrName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Exact</span> <span class='hs-varid'>name</span>
<a name="line-30"></a><span class='hs-comment'>-- Keep the Name even for Internal names, so that the</span>
<a name="line-31"></a><span class='hs-comment'>-- unique is still there for debug printing, particularly</span>
<a name="line-32"></a><span class='hs-comment'>-- of Types (which are converted to IfaceTypes before printing)</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="nukeExact"></a><span class='hs-definition'>nukeExact</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-35"></a><span class='hs-definition'>nukeExact</span> <span class='hs-varid'>n</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unqual</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="isRdrDataCon"></a><span class='hs-definition'>isRdrDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><a name="isRdrTyVar"></a><span class='hs-definition'>isRdrTyVar</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3"></a><a name="isRdrTc"></a><span class='hs-definition'>isRdrTc</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>isRdrDataCon</span> <span class='hs-varid'>rn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDataOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rn</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>isRdrTyVar</span>   <span class='hs-varid'>rn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTvOcc</span>   <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rn</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>isRdrTc</span>      <span class='hs-varid'>rn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTcOcc</span>   <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rn</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="isSrcRdrName"></a><span class='hs-definition'>isSrcRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-10"></a><span class='hs-definition'>isSrcRdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-11"></a><span class='hs-definition'>isSrcRdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-12"></a><span class='hs-definition'>isSrcRdrName</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="isUnqual"></a><span class='hs-definition'>isUnqual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-15"></a><span class='hs-definition'>isUnqual</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-16"></a><span class='hs-definition'>isUnqual</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="isQual"></a><span class='hs-definition'>isQual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-19"></a><span class='hs-definition'>isQual</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-20"></a><span class='hs-definition'>isQual</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="isQual_maybe"></a><span class='hs-definition'>isQual_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>OccName</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-definition'>isQual_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>isQual_maybe</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="isOrig"></a><span class='hs-definition'>isOrig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-27"></a><span class='hs-definition'>isOrig</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-28"></a><span class='hs-definition'>isOrig</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="isOrig_maybe"></a><span class='hs-definition'>isOrig_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>OccName</span><span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-definition'>isOrig_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-varid'>m</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-definition'>isOrig_maybe</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="isExact"></a><span class='hs-definition'>isExact</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-35"></a><span class='hs-definition'>isExact</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-36"></a><span class='hs-definition'>isExact</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="isExact_maybe"></a><span class='hs-definition'>isExact_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-39"></a><span class='hs-definition'>isExact_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>
<a name="line-40"></a><span class='hs-definition'>isExact_maybe</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Instances}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-3"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span>
<a name="line-4"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dot</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span>
<a name="line-5"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>sty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprModulePrefix</span> <span class='hs-varid'>sty</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>OutputableBndr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>pprBndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span>
<a name="line-9"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTvOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-10"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-11"></a>
<a name="line-12"></a>    <span class='hs-varid'>pprInfixOcc</span>  <span class='hs-varid'>rdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprInfixVar</span>  <span class='hs-layout'>(</span><span class='hs-varid'>isSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-13"></a>    <span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>rdr</span>
<a name="line-14"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isExact_maybe</span> <span class='hs-varid'>rdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixName</span> <span class='hs-varid'>name</span>
<a name="line-15"></a>             <span class='hs-comment'>-- pprPrefixName has some special cases, so</span>
<a name="line-16"></a>             <span class='hs-comment'>-- we delegate to them rather than reproduce them</span>
<a name="line-17"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span>    <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span><span class='hs-varop'>==</span><span class='hs-varid'>n2</span>
<a name="line-21"></a>        <span class='hs-comment'>-- Convert exact to orig</span>
<a name="line-22"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span>    <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nukeExact</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span>
<a name="line-23"></a>    <span class='hs-varid'>r1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nukeExact</span> <span class='hs-varid'>n2</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>o1</span><span class='hs-layout'>)</span>  <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-varid'>m2</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m1</span><span class='hs-varop'>==</span><span class='hs-varid'>m2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>o1</span><span class='hs-varop'>==</span><span class='hs-varid'>o2</span>
<a name="line-26"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>o1</span><span class='hs-layout'>)</span>  <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m2</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m1</span><span class='hs-varop'>==</span><span class='hs-varid'>m2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>o1</span><span class='hs-varop'>==</span><span class='hs-varid'>o2</span>
<a name="line-27"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>o1</span><span class='hs-layout'>)</span>   <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o1</span><span class='hs-varop'>==</span><span class='hs-varid'>o2</span>
<a name="line-28"></a>    <span class='hs-keyword'>_</span>             <span class='hs-varop'>==</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;</span>  <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span>  <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>}</span>
<a name="line-34"></a>    <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;</span>  <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>}</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-comment'>-- Exact &lt; Unqual &lt; Qual &lt; Orig</span>
<a name="line-37"></a>        <span class='hs-comment'>-- [Note: Apr 2004] We used to use nukeExact to convert Exact to Orig</span>
<a name="line-38"></a>        <span class='hs-comment'>--      before comparing so that Prelude.map == the exact Prelude.map, but</span>
<a name="line-39"></a>        <span class='hs-comment'>--      that meant that we reported duplicates when renaming bindings</span>
<a name="line-40"></a>        <span class='hs-comment'>--      generated by Template Haskell; e.g</span>
<a name="line-41"></a>        <span class='hs-comment'>--      do { n1 &lt;- newName "foo"; n2 &lt;- newName "foo";</span>
<a name="line-42"></a>        <span class='hs-comment'>--           &lt;decl involving n1,n2&gt; }</span>
<a name="line-43"></a>        <span class='hs-comment'>--      I think we can do without this conversion</span>
<a name="line-44"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>n2</span>
<a name="line-45"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-46"></a>
<a name="line-47"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-48"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>o1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span>  <span class='hs-varid'>o2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>o2</span>
<a name="line-49"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Exact</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-52"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-53"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>o1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-varid'>m2</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>o1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`thenCmp`</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Qual</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-55"></a>
<a name="line-56"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-varid'>m1</span> <span class='hs-varid'>o1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-varid'>m2</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>o1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`thenCmp`</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span>
<a name="line-57"></a>    <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                        LocalRdrEnv
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="LocalRdrEnv"></a><span class='hs-comment'>-- | This environment is used to store local bindings (@let@, @where@, lambda, @case@).</span>
<a name="line-2"></a><a name="LocalRdrEnv"></a><span class='hs-comment'>-- It is keyed by OccName, because we never use it for qualified names</span>
<a name="line-3"></a><a name="LocalRdrEnv"></a><span class='hs-comment'>-- We keep the current mapping, *and* the set of all Names in scope</span>
<a name="line-4"></a><a name="LocalRdrEnv"></a><span class='hs-comment'>-- Reason: see Note [Splicing Exact Names] in RnEnv</span>
<a name="line-5"></a><a name="LocalRdrEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccEnv</span> <span class='hs-conid'>Name</span>
<a name="line-6"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-10"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"LocalRdrEnv {"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"env ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprOccEnv</span> <span class='hs-varid'>ppr_elt</span> <span class='hs-varid'>env</span>
<a name="line-12"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in_scope ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSetToList</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                 <span class='hs-keyglyph'>]</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'}'</span><span class='hs-layout'>)</span>
<a name="line-14"></a>    <span class='hs-keyword'>where</span>
<a name="line-15"></a>      <span class='hs-varid'>ppr_elt</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-16"></a>                     <span class='hs-comment'>-- So we can see if the keys line up correctly</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="emptyLocalRdrEnv"></a><span class='hs-definition'>emptyLocalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span>
<a name="line-19"></a><span class='hs-definition'>emptyLocalRdrEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyOccEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyNameSet</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="extendLocalRdrEnv"></a><span class='hs-definition'>extendLocalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRdrEnv</span>
<a name="line-22"></a><span class='hs-comment'>-- The Name should be a non-top-level thing</span>
<a name="line-23"></a><span class='hs-definition'>extendLocalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span>
<a name="line-25"></a>    <span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span>
<a name="line-26"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addOneToNameSet</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="extendLocalRdrEnvList"></a><span class='hs-definition'>extendLocalRdrEnvList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRdrEnv</span>
<a name="line-29"></a><span class='hs-definition'>extendLocalRdrEnvList</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>names</span> <span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendOccEnvList</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>names</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addListToNameSet</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>names</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="lookupLocalRdrEnv"></a><span class='hs-definition'>lookupLocalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-35"></a><span class='hs-definition'>lookupLocalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occ</span>
<a name="line-36"></a><span class='hs-definition'>lookupLocalRdrEnv</span> <span class='hs-keyword'>_</span>                       <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="lookupLocalRdrOcc"></a><span class='hs-definition'>lookupLocalRdrOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-39"></a><span class='hs-definition'>lookupLocalRdrOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occ</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="elemLocalRdrEnv"></a><span class='hs-definition'>elemLocalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-42"></a><span class='hs-definition'>elemLocalRdrEnv</span> <span class='hs-varid'>rdr_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>      <span class='hs-conid'>Unqual</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>occ</span>  <span class='hs-varop'>`elemOccEnv`</span> <span class='hs-varid'>env</span>
<a name="line-45"></a>      <span class='hs-conid'>Exact</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>ns</span>  <span class='hs-comment'>-- See Note [Local bindings with Exact Names]</span>
<a name="line-46"></a>      <span class='hs-conid'>Qual</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-47"></a>      <span class='hs-conid'>Orig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="localRdrEnvElts"></a><span class='hs-definition'>localRdrEnvElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-50"></a><span class='hs-definition'>localRdrEnvElts</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occEnvElts</span> <span class='hs-varid'>env</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="inLocalRdrEnvScope"></a><span class='hs-definition'>inLocalRdrEnvScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-53"></a><span class='hs-comment'>-- This is the point of the NameSet</span>
<a name="line-54"></a><span class='hs-definition'>inLocalRdrEnvScope</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>ns</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="delLocalRdrEnvList"></a><span class='hs-definition'>delLocalRdrEnvList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OccName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRdrEnv</span>
<a name="line-57"></a><span class='hs-definition'>delLocalRdrEnvList</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>occs</span> 
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lre_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delListFromOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occs</span>
<a name="line-59"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>lre_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Local bindings with Exact Names]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
With Template Haskell we can make local bindings that have Exact Names.
Computing shadowing etc may use elemLocalRdrEnv (at least it certainly
does so in RnTpes.bindHsTyVars), so for an Exact Name we must consult
the in-scope-name-set.


%************************************************************************
%*                                                                      *
                        GlobalRdrEnv
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="GlobalRdrEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- ^ Keyed by 'OccName'; when looking up a qualified name</span>
<a name="line-3"></a><span class='hs-comment'>-- we look up the 'OccName' part, and then check the 'Provenance'</span>
<a name="line-4"></a><span class='hs-comment'>-- to see if the appropriate qualification is valid.  This</span>
<a name="line-5"></a><span class='hs-comment'>-- saves routinely doubling the size of the env by adding both</span>
<a name="line-6"></a><span class='hs-comment'>-- qualified and unqualified names to the domain.</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- The list in the codomain is required because there may be name clashes</span>
<a name="line-9"></a><span class='hs-comment'>-- These only get reported on lookup, not on construction</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>-- INVARIANT: All the members of the list have distinct</span>
<a name="line-12"></a><span class='hs-comment'>--            'gre_name' fields; that is, no duplicate Names</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- INVARIANT: Imported provenance =&gt; Name is an ExternalName</span>
<a name="line-15"></a><span class='hs-comment'>--            However LocalDefs can have an InternalName.  This</span>
<a name="line-16"></a><span class='hs-comment'>--            happens only when type-checking a [d| ... |] Template</span>
<a name="line-17"></a><span class='hs-comment'>--            Haskell quotation; see this note in RnNames</span>
<a name="line-18"></a><span class='hs-comment'>--            Note [Top-level Names in Template Haskell decl quotes]</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="GlobalRdrElt"></a><span class='hs-comment'>-- | An element of the 'GlobalRdrEnv'</span>
<a name="line-21"></a><a name="GlobalRdrElt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GlobalRdrElt</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>
<a name="line-23"></a>          <span class='hs-varid'>gre_par</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Parent</span><span class='hs-layout'>,</span>
<a name="line-24"></a>          <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Provenance</span>        <span class='hs-comment'>-- ^ Why it's in scope</span>
<a name="line-25"></a>    <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="Parent"></a><span class='hs-comment'>-- | The children of a Name are the things that are abbreviated by the ".."</span>
<a name="line-28"></a><a name="Parent"></a><span class='hs-comment'>--   notation in export lists.  See Note [Parents]</span>
<a name="line-29"></a><a name="Parent"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoParent</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ParentIs</span> <span class='hs-conid'>Name</span>
<a name="line-30"></a>              <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Parent</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>   <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoParent</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-34"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParentIs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"parent:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="plusParent"></a><span class='hs-definition'>plusParent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Parent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Parent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Parent</span>
<a name="line-37"></a><span class='hs-comment'>-- See Note [Combining parents]</span>
<a name="line-38"></a><span class='hs-definition'>plusParent</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParentIs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hasParent</span> <span class='hs-varid'>n</span> <span class='hs-varid'>p2</span>
<a name="line-39"></a><span class='hs-definition'>plusParent</span> <span class='hs-varid'>p1</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParentIs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hasParent</span> <span class='hs-varid'>n</span> <span class='hs-varid'>p1</span>
<a name="line-40"></a><span class='hs-definition'>plusParent</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoParent</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="hasParent"></a><span class='hs-definition'>hasParent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Parent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Parent</span>
<a name="line-43"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-44"></a><span class='hs-definition'>hasParent</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParentIs</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"hasParent"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Parents should agree</span>
<a name="line-46"></a><span class='hs-cpp'>#endif</span>
<a name="line-47"></a><span class='hs-definition'>hasParent</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParentIs</span> <span class='hs-varid'>n</span>
</pre>\end{code}

Note [Parents]
~~~~~~~~~~~~~~~~~
  Parent           Children
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  data T           Data constructors
                   Record-field ids

  data family T    Data constructors and record-field ids
                   of all visible data instances of T

  class C          Class operations
                   Associated type constructors

Note [Combining parents]
~~~~~~~~~~~~~~~~~~~~~~~~
With an associated type we might have
   module M where
     class C a where
       data T a
       op :: T a -> a
     instance C Int where
       data T Int = TInt
     instance C Bool where
       data T Bool = TBool

Then:   C is the parent of T
        T is the parent of TInt and TBool
So: in an export list
    C(..) is short for C( op, T )
    T(..) is short for T( TInt, TBool )

Module M exports everything, so its exports will be
   AvailTC C [C,T,op]
   AvailTC T [T,TInt,TBool]
On import we convert to GlobalRdrElt and the combine
those.  For T that will mean we have
  one GRE with Parent C
  one GRE with NoParent
That's why plusParent picks the "best" case.


\begin{code}
<pre><a name="line-1"></a><a name="gresFromAvails"></a><span class='hs-comment'>-- | make a 'GlobalRdrEnv' where all the elements point to the same</span>
<a name="line-2"></a><span class='hs-comment'>-- Provenance (useful for "hiding" imports, or imports with</span>
<a name="line-3"></a><span class='hs-comment'>-- no details).</span>
<a name="line-4"></a><span class='hs-definition'>gresFromAvails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Provenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>gresFromAvails</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>avails</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>gresFromAvail</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>prov</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>avails</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="gresFromAvail"></a><span class='hs-definition'>gresFromAvail</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Provenance</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-definition'>gresFromAvail</span> <span class='hs-varid'>prov_fn</span> <span class='hs-varid'>avail</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span>
<a name="line-11"></a>           <span class='hs-varid'>gre_par</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkParent</span> <span class='hs-varid'>n</span> <span class='hs-varid'>avail</span><span class='hs-layout'>,</span>
<a name="line-12"></a>           <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prov_fn</span> <span class='hs-varid'>n</span><span class='hs-layout'>}</span>
<a name="line-13"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>avail</span> <span class='hs-keyglyph'>]</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="mkParent"></a><span class='hs-definition'>mkParent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AvailInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Parent</span>
<a name="line-17"></a><span class='hs-definition'>mkParent</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Avail</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoParent</span>
<a name="line-18"></a><span class='hs-definition'>mkParent</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>AvailTC</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoParent</span>
<a name="line-19"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ParentIs</span> <span class='hs-varid'>m</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="emptyGlobalRdrEnv"></a><span class='hs-definition'>emptyGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-22"></a><span class='hs-definition'>emptyGlobalRdrEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyOccEnv</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="globalRdrEnvElts"></a><span class='hs-definition'>globalRdrEnvElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a><span class='hs-definition'>globalRdrEnvElts</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>env</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyword'>where</span>
<a name="line-28"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_par</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-29"></a>               <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprNameProvenance</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="pprGlobalRdrEnv"></a><span class='hs-definition'>pprGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-32"></a><span class='hs-definition'>pprGlobalRdrEnv</span> <span class='hs-varid'>locals_only</span> <span class='hs-varid'>env</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"GlobalRdrEnv"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppWhen</span> <span class='hs-varid'>locals_only</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(locals only)"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-34"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>lbrace</span>
<a name="line-35"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pp</span> <span class='hs-layout'>(</span><span class='hs-varid'>remove_locals</span> <span class='hs-varid'>gre_list</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gre_list</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>occEnvElts</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>]</span> 
<a name="line-36"></a>             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>rbrace</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>remove_locals</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>locals_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isLocalGRE</span> <span class='hs-varid'>gres</span>
<a name="line-39"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gres</span>
<a name="line-40"></a>    <span class='hs-varid'>pp</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-41"></a>    <span class='hs-varid'>pp</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>occ</span>
<a name="line-42"></a>                     <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"unique"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                     <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-44"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>gres</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>      <span class='hs-keyword'>where</span>
<a name="line-46"></a>        <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>gres</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="lookupGlobalRdrEnv"></a><span class='hs-definition'>lookupGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-49"></a><span class='hs-definition'>lookupGlobalRdrEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occ_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occ_name</span> <span class='hs-keyword'>of</span>
<a name="line-50"></a>                                  <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-51"></a>                                  <span class='hs-conid'>Just</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gres</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="lookupGRE_RdrName"></a><span class='hs-definition'>lookupGRE_RdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-54"></a><span class='hs-definition'>lookupGRE_RdrName</span> <span class='hs-varid'>rdr_name</span> <span class='hs-varid'>env</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-56"></a>    <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-57"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pickGREs</span> <span class='hs-varid'>rdr_name</span> <span class='hs-varid'>gres</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="lookupGRE_Name"></a><span class='hs-definition'>lookupGRE_Name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-60"></a><span class='hs-definition'>lookupGRE_Name</span> <span class='hs-varid'>env</span> <span class='hs-varid'>name</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupGlobalRdrEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-62"></a>            <span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>]</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="getGRE_NameQualifier_maybes"></a><span class='hs-definition'>getGRE_NameQualifier_maybes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-65"></a><span class='hs-comment'>-- Returns all the qualifiers by which 'x' is in scope</span>
<a name="line-66"></a><span class='hs-comment'>-- Nothing means "the unqualified version is in scope"</span>
<a name="line-67"></a><span class='hs-comment'>-- [] means the thing is not in scope at all</span>
<a name="line-68"></a><span class='hs-definition'>getGRE_NameQualifier_maybes</span> <span class='hs-varid'>env</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>qualifier_maybe</span> <span class='hs-varop'>.</span> <span class='hs-varid'>gre_prov</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookupGRE_Name</span> <span class='hs-varid'>env</span>
<a name="line-70"></a>  <span class='hs-keyword'>where</span>
<a name="line-71"></a>    <span class='hs-varid'>qualifier_maybe</span> <span class='hs-conid'>LocalDef</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-72"></a>    <span class='hs-varid'>qualifier_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Imported</span> <span class='hs-varid'>iss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_as</span> <span class='hs-varop'>.</span> <span class='hs-varid'>is_decl</span><span class='hs-layout'>)</span> <span class='hs-varid'>iss</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="isLocalGRE"></a><span class='hs-definition'>isLocalGRE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-75"></a><span class='hs-definition'>isLocalGRE</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-76"></a><span class='hs-definition'>isLocalGRE</span> <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="unQualOK"></a><span class='hs-definition'>unQualOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-79"></a><span class='hs-comment'>-- ^ Test if an unqualifed version of this thing would be in scope</span>
<a name="line-80"></a><span class='hs-definition'>unQualOK</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-81"></a><span class='hs-definition'>unQualOK</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-varid'>is</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>unQualSpecOK</span> <span class='hs-varid'>is</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="pickGREs"></a><span class='hs-definition'>pickGREs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-84"></a><span class='hs-comment'>-- ^ Take a list of GREs which have the right OccName</span>
<a name="line-85"></a><span class='hs-comment'>-- Pick those GREs that are suitable for this RdrName</span>
<a name="line-86"></a><span class='hs-comment'>-- And for those, keep only only the Provenances that are suitable</span>
<a name="line-87"></a><span class='hs-comment'>-- Only used for Qual and Unqual, not Orig or Exact</span>
<a name="line-88"></a><span class='hs-comment'>--</span>
<a name="line-89"></a><span class='hs-comment'>-- Consider:</span>
<a name="line-90"></a><span class='hs-comment'>--</span>
<a name="line-91"></a><span class='hs-comment'>-- @</span>
<a name="line-92"></a><span class='hs-comment'>--       module A ( f ) where</span>
<a name="line-93"></a><span class='hs-comment'>--       import qualified Foo( f )</span>
<a name="line-94"></a><span class='hs-comment'>--       import Baz( f )</span>
<a name="line-95"></a><span class='hs-comment'>--       f = undefined</span>
<a name="line-96"></a><span class='hs-comment'>-- @</span>
<a name="line-97"></a><span class='hs-comment'>--</span>
<a name="line-98"></a><span class='hs-comment'>-- Let's suppose that @Foo.f@ and @Baz.f@ are the same entity really.</span>
<a name="line-99"></a><span class='hs-comment'>-- The export of @f@ is ambiguous because it's in scope from the local def</span>
<a name="line-100"></a><span class='hs-comment'>-- and the import.  The lookup of @Unqual f@ should return a GRE for</span>
<a name="line-101"></a><span class='hs-comment'>-- the locally-defined @f@, and a GRE for the imported @f@, with a /single/</span>
<a name="line-102"></a><span class='hs-comment'>-- provenance, namely the one for @Baz(f)@.</span>
<a name="line-103"></a><span class='hs-definition'>pickGREs</span> <span class='hs-varid'>rdr_name</span> <span class='hs-varid'>gres</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidates</span>  <span class='hs-comment'>-- This is usually false, so we don't have to</span>
<a name="line-105"></a>                               <span class='hs-comment'>-- even look at internal_candidates</span>
<a name="line-106"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>internal_candidates</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>gre</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- For this internal_candidate stuff,</span>
<a name="line-108"></a>           <span class='hs-comment'>-- see Note [Template Haskell binders in the GlobalRdrEnv]</span>
<a name="line-109"></a>           <span class='hs-comment'>-- If there are multiple Internal candidates, pick the</span>
<a name="line-110"></a>           <span class='hs-comment'>-- first one (ie with the (innermost binding)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isSrcRdrName</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_name</span> <span class='hs-layout'>)</span>
<a name="line-113"></a>    <span class='hs-varid'>candidates</span>
<a name="line-114"></a>  <span class='hs-keyword'>where</span>
<a name="line-115"></a>    <span class='hs-varid'>candidates</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>pick</span> <span class='hs-varid'>gres</span>
<a name="line-116"></a>    <span class='hs-varid'>internal_candidates</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isInternalName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>gre_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>candidates</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class='hs-varid'>rdr_is_unqual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnqual</span> <span class='hs-varid'>rdr_name</span>
<a name="line-119"></a>    <span class='hs-varid'>rdr_is_qual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isQual_maybe</span> <span class='hs-varid'>rdr_name</span>
<a name="line-120"></a>
<a name="line-121"></a>    <span class='hs-varid'>pick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GlobalRdrElt</span>
<a name="line-122"></a>    <span class='hs-varid'>pick</span> <span class='hs-varid'>gre</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Local def</span>
<a name="line-123"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rdr_is_unqual</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>gre</span>
<a name="line-124"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rdr_is_qual</span>        <span class='hs-comment'>-- Qualified name</span>
<a name="line-125"></a>        <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>n</span>   <span class='hs-comment'>-- Binder is External</span>
<a name="line-126"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>n_mod</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>gre</span>
<a name="line-127"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-128"></a>    <span class='hs-varid'>pick</span> <span class='hs-varid'>gre</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>is</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Single import (efficiency)</span>
<a name="line-129"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rdr_is_unqual</span><span class='hs-layout'>,</span>
<a name="line-130"></a>          <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_qual</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>gre</span>
<a name="line-131"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rdr_is_qual</span><span class='hs-layout'>,</span>
<a name="line-132"></a>          <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>is_as</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>gre</span>
<a name="line-133"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-134"></a>    <span class='hs-varid'>pick</span> <span class='hs-varid'>gre</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-varid'>is</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Multiple import</span>
<a name="line-135"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>filtered_is</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-136"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-varid'>filtered_is</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-137"></a>        <span class='hs-keyword'>where</span>
<a name="line-138"></a>          <span class='hs-varid'>filtered_is</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rdr_is_unqual</span>
<a name="line-139"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>is_qual</span>    <span class='hs-varop'>.</span> <span class='hs-varid'>is_decl</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span>
<a name="line-140"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rdr_is_qual</span>
<a name="line-141"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>is_as</span> <span class='hs-varop'>.</span> <span class='hs-varid'>is_decl</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span>
<a name="line-142"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-143"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
</pre>\end{code}

Building GlobalRdrEnvs

\begin{code}
<pre><a name="line-1"></a><a name="plusGlobalRdrEnv"></a><span class='hs-definition'>plusGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-2"></a><span class='hs-definition'>plusGlobalRdrEnv</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>env2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusOccEnv_C</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>insertGRE</span><span class='hs-layout'>)</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>env2</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="mkGlobalRdrEnv"></a><span class='hs-definition'>mkGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-5"></a><span class='hs-definition'>mkGlobalRdrEnv</span> <span class='hs-varid'>gres</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyGlobalRdrEnv</span> <span class='hs-varid'>gres</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>gre</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendOccEnv_Acc</span> <span class='hs-varid'>insertGRE</span> <span class='hs-varid'>singleton</span> <span class='hs-varid'>env</span>
<a name="line-9"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>gre_name</span> <span class='hs-varid'>gre</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>                                   <span class='hs-varid'>gre</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="insertGRE"></a><span class='hs-definition'>insertGRE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a><span class='hs-definition'>insertGRE</span> <span class='hs-varid'>new_g</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>new_g</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a><span class='hs-definition'>insertGRE</span> <span class='hs-varid'>new_g</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_g</span> <span class='hs-conop'>:</span> <span class='hs-varid'>old_gs</span><span class='hs-layout'>)</span>
<a name="line-15"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>new_g</span> <span class='hs-varop'>==</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>old_g</span>
<a name="line-16"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_g</span> <span class='hs-varop'>`plusGRE`</span> <span class='hs-varid'>old_g</span> <span class='hs-conop'>:</span> <span class='hs-varid'>old_gs</span>
<a name="line-17"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-18"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_g</span> <span class='hs-conop'>:</span> <span class='hs-varid'>insertGRE</span> <span class='hs-varid'>new_g</span> <span class='hs-varid'>old_gs</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="plusGRE"></a><span class='hs-definition'>plusGRE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span>
<a name="line-21"></a><span class='hs-comment'>-- Used when the gre_name fields match</span>
<a name="line-22"></a><span class='hs-definition'>plusGRE</span> <span class='hs-varid'>g1</span> <span class='hs-varid'>g2</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gre_name</span> <span class='hs-varid'>g1</span><span class='hs-layout'>,</span>
<a name="line-24"></a>          <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gre_prov</span> <span class='hs-varid'>g1</span> <span class='hs-varop'>`plusProv`</span>   <span class='hs-varid'>gre_prov</span> <span class='hs-varid'>g2</span><span class='hs-layout'>,</span>
<a name="line-25"></a>          <span class='hs-varid'>gre_par</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gre_par</span>  <span class='hs-varid'>g1</span> <span class='hs-varop'>`plusParent`</span> <span class='hs-varid'>gre_par</span>  <span class='hs-varid'>g2</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="transformGREs"></a><span class='hs-definition'>transformGREs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span><span class='hs-layout'>)</span>
<a name="line-28"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OccName</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-30"></a><span class='hs-comment'>-- ^ Apply a transformation function to the GREs for these OccNames</span>
<a name="line-31"></a><span class='hs-definition'>transformGREs</span> <span class='hs-varid'>trans_gre</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>rdr_env</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>trans</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occs</span>
<a name="line-33"></a>  <span class='hs-keyword'>where</span>
<a name="line-34"></a>    <span class='hs-varid'>trans</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>env</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>of</span>
<a name="line-36"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendOccEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>trans_gre</span> <span class='hs-varid'>gres</span><span class='hs-layout'>)</span>
<a name="line-37"></a>           <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="extendGlobalRdrEnv"></a><span class='hs-definition'>extendGlobalRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-40"></a><span class='hs-comment'>-- Extend with new LocalDef GREs from the AvailInfos.</span>
<a name="line-41"></a><span class='hs-comment'>--</span>
<a name="line-42"></a><span class='hs-comment'>-- If do_shadowing is True, first remove name clashes between the new</span>
<a name="line-43"></a><span class='hs-comment'>-- AvailInfos and the existing GlobalRdrEnv.</span>
<a name="line-44"></a><span class='hs-comment'>-- This is used by the GHCi top-level</span>
<a name="line-45"></a><span class='hs-comment'>--</span>
<a name="line-46"></a><span class='hs-comment'>-- E.g.  Adding a LocalDef "x" when there is an existing GRE for Q.x</span>
<a name="line-47"></a><span class='hs-comment'>--       should remove any unqualified import of Q.x,</span>
<a name="line-48"></a><span class='hs-comment'>--       leaving only the qualified one</span>
<a name="line-49"></a><span class='hs-comment'>--</span>
<a name="line-50"></a><span class='hs-comment'>-- However do *not* remove name clashes between the AvailInfos themselves,</span>
<a name="line-51"></a><span class='hs-comment'>-- so that (say)   data T = A | A</span>
<a name="line-52"></a><span class='hs-comment'>-- will still give a duplicate-binding error.</span>
<a name="line-53"></a><span class='hs-comment'>-- Same thing if there are multiple AvailInfos (don't remove clashes),</span>
<a name="line-54"></a><span class='hs-comment'>-- though I'm not sure this ever happens with do_shadowing=True</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-definition'>extendGlobalRdrEnv</span> <span class='hs-varid'>do_shadowing</span> <span class='hs-varid'>env</span> <span class='hs-varid'>avails</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>add_avail</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>avails</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>availNames</span> <span class='hs-varid'>avails</span>
<a name="line-60"></a>    <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>do_shadowing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>shadow_name</span> <span class='hs-varid'>env</span> <span class='hs-varid'>names</span>
<a name="line-61"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-62"></a>         <span class='hs-comment'>-- By doing the removal first, we ensure that the new AvailInfos</span>
<a name="line-63"></a>         <span class='hs-comment'>-- don't shadow each other; that would conceal genuine errors</span>
<a name="line-64"></a>         <span class='hs-comment'>-- E.g. in GHCi   data T = A | A</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>add_avail</span> <span class='hs-varid'>env</span> <span class='hs-varid'>avail</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_name</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>availNames</span> <span class='hs-varid'>avail</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-varid'>add_name</span> <span class='hs-varid'>avail</span> <span class='hs-varid'>env</span> <span class='hs-varid'>name</span>
<a name="line-69"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendOccEnv_Acc</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>singleton</span> <span class='hs-varid'>env</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>gre</span>
<a name="line-70"></a>       <span class='hs-keyword'>where</span>
<a name="line-71"></a>         <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-72"></a>         <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-73"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>gre_par</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkParent</span> <span class='hs-varid'>name</span> <span class='hs-varid'>avail</span>
<a name="line-74"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="shadow_name"></a><span class='hs-definition'>shadow_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-77"></a><span class='hs-definition'>shadow_name</span> <span class='hs-varid'>env</span> <span class='hs-varid'>name</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>alter_fn</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-79"></a>  <span class='hs-keyword'>where</span>
<a name="line-80"></a>    <span class='hs-varid'>alter_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a>    <span class='hs-varid'>alter_fn</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-layout'>(</span><span class='hs-varid'>shadow_with</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>gres</span>
<a name="line-82"></a>
<a name="line-83"></a>    <span class='hs-varid'>shadow_with</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GlobalRdrElt</span>
<a name="line-84"></a>    <span class='hs-varid'>shadow_with</span> <span class='hs-varid'>new_name</span> <span class='hs-varid'>old_gre</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-85"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>old_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>new_name</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-86"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>      <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-87"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>old_mod</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>new_mod</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>new_mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-88"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>old_mod</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_gre</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fake_imp_spec</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-89"></a>              <span class='hs-keyword'>where</span>
<a name="line-90"></a>                 <span class='hs-varid'>fake_imp_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpSpec</span> <span class='hs-varid'>id_spec</span> <span class='hs-conid'>ImpAll</span>  <span class='hs-comment'>-- Urgh!</span>
<a name="line-91"></a>                 <span class='hs-varid'>old_mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>old_mod</span>
<a name="line-92"></a>                 <span class='hs-varid'>id_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_mod_name</span>
<a name="line-93"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>is_as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_mod_name</span>
<a name="line-94"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>is_qual</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-95"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>is_dloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>old_name</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>    <span class='hs-varid'>shadow_with</span> <span class='hs-varid'>new_name</span> <span class='hs-varid'>old_gre</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-varid'>imp_specs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-97"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>imp_specs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-98"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_gre</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-varid'>imp_specs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-99"></a>       <span class='hs-keyword'>where</span>
<a name="line-100"></a>         <span class='hs-varid'>imp_specs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-layout'>(</span><span class='hs-varid'>shadow_is</span> <span class='hs-varid'>new_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>imp_specs</span>
<a name="line-101"></a>
<a name="line-102"></a>    <span class='hs-varid'>shadow_is</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ImportSpec</span>
<a name="line-103"></a>    <span class='hs-varid'>shadow_is</span> <span class='hs-varid'>new_name</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_spec</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-104"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>new_mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameModule_maybe</span> <span class='hs-varid'>new_name</span>
<a name="line-105"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>is_as</span> <span class='hs-varid'>id_spec</span> <span class='hs-varop'>==</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>new_mod</span>
<a name="line-106"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>   <span class='hs-comment'>-- Shadow both qualified and unqualified</span>
<a name="line-107"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- Shadow unqualified only</span>
<a name="line-108"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_spec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_qual</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Template Haskell binders in the GlobalRdrEnv]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For reasons described in Note [Top-level Names in Template Haskell decl quotes]
in RnNames, a GRE with an Internal gre_name (i.e. one generated by a TH decl
quote) should *shadow* a GRE with an External gre_name.  Hence some faffing
around in pickGREs and findLocalDupsRdrEnv

\begin{code}
<pre><a name="line-1"></a><a name="findLocalDupsRdrEnv"></a><span class='hs-definition'>findLocalDupsRdrEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- ^ For each 'OccName', see if there are multiple local definitions</span>
<a name="line-3"></a><span class='hs-comment'>-- for it; return a list of all such</span>
<a name="line-4"></a><span class='hs-comment'>-- and return a list of the duplicate bindings</span>
<a name="line-5"></a><span class='hs-definition'>findLocalDupsRdrEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occs</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rdr_env</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>occs</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>       <span class='hs-varid'>dups</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dups</span>
<a name="line-9"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>dups</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-conop'>:</span><span class='hs-varid'>names</span><span class='hs-layout'>)</span>
<a name="line-10"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>pick</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>gres</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>          <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rdr_env</span>  <span class='hs-varid'>dups</span>              <span class='hs-varid'>names</span>
<a name="line-12"></a>          <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rdr_env</span>  <span class='hs-varid'>dups</span>              <span class='hs-varid'>names</span>   <span class='hs-comment'>-- The common case</span>
<a name="line-13"></a>          <span class='hs-varid'>dup_gres</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rdr_env'</span> <span class='hs-layout'>(</span><span class='hs-varid'>dup_gres</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>
<a name="line-14"></a>      <span class='hs-keyword'>where</span>
<a name="line-15"></a>        <span class='hs-varid'>occ</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span>
<a name="line-16"></a>        <span class='hs-varid'>gres</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupOccEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-17"></a>        <span class='hs-varid'>rdr_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromOccEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occ</span>
<a name="line-18"></a>            <span class='hs-comment'>-- The delFromOccEnv avoids repeating the same</span>
<a name="line-19"></a>            <span class='hs-comment'>-- complaint twice, when names itself has a duplicate</span>
<a name="line-20"></a>            <span class='hs-comment'>-- which is a common case</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-comment'>-- See Note [Template Haskell binders in the GlobalRdrEnv]</span>
<a name="line-23"></a>    <span class='hs-varid'>pick</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInternalName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isInternalName</span> <span class='hs-varid'>n</span>
<a name="line-25"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-26"></a>    <span class='hs-varid'>pick</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                        Provenance
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="Provenance"></a><span class='hs-comment'>-- | The 'Provenance' of something says how it came to be in scope.</span>
<a name="line-2"></a><a name="Provenance"></a><span class='hs-comment'>-- It's quite elaborate so that we can give accurate unused-name warnings.</span>
<a name="line-3"></a><a name="Provenance"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Provenance</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span>            <span class='hs-comment'>-- ^ The thing was defined locally</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Imported</span>
<a name="line-6"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportSpec</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ The thing was imported.</span>
<a name="line-7"></a>                        <span class='hs-comment'>--</span>
<a name="line-8"></a>                        <span class='hs-comment'>-- INVARIANT: the list of 'ImportSpec' is non-empty</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="ImportSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpSpec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_decl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImpDeclSpec</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                            <span class='hs-varid'>is_item</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImpItemSpec</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>                <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="ImpDeclSpec"></a><span class='hs-comment'>-- | Describes a particular import declaration and is</span>
<a name="line-15"></a><a name="ImpDeclSpec"></a><span class='hs-comment'>-- shared among all the 'Provenance's for that decl</span>
<a name="line-16"></a><a name="ImpDeclSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImpDeclSpec</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-layout'>{</span>
<a name="line-18"></a>        <span class='hs-varid'>is_mod</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Module imported, e.g. @import Muggle@</span>
<a name="line-19"></a>                                   <span class='hs-comment'>-- Note the @Muggle@ may well not be</span>
<a name="line-20"></a>                                   <span class='hs-comment'>-- the defining module for this thing!</span>
<a name="line-21"></a>
<a name="line-22"></a>                                   <span class='hs-comment'>-- TODO: either should be Module, or there</span>
<a name="line-23"></a>                                   <span class='hs-comment'>-- should be a Maybe PackageId here too.</span>
<a name="line-24"></a>        <span class='hs-varid'>is_as</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Import alias, e.g. from @as M@ (or @Muggle@ if there is no @as@ clause)</span>
<a name="line-25"></a>        <span class='hs-varid'>is_qual</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- ^ Was this import qualified?</span>
<a name="line-26"></a>        <span class='hs-varid'>is_dloc</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>     <span class='hs-comment'>-- ^ The location of the entire import declaration</span>
<a name="line-27"></a>    <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="ImpItemSpec"></a><span class='hs-comment'>-- | Describes import info a particular Name</span>
<a name="line-30"></a><a name="ImpItemSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImpItemSpec</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImpAll</span>              <span class='hs-comment'>-- ^ The import had no import list,</span>
<a name="line-32"></a>                        <span class='hs-comment'>-- or had a hiding list</span>
<a name="line-33"></a>
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImpSome</span> <span class='hs-layout'>{</span>
<a name="line-35"></a>        <span class='hs-varid'>is_explicit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>is_iloc</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>  <span class='hs-comment'>-- Location of the import item</span>
<a name="line-37"></a>    <span class='hs-layout'>}</span>   <span class='hs-comment'>-- ^ The import had an import list.</span>
<a name="line-38"></a>        <span class='hs-comment'>-- The 'is_explicit' field is @True@ iff the thing was named</span>
<a name="line-39"></a>        <span class='hs-comment'>-- /explicitly/ in the import specs rather</span>
<a name="line-40"></a>        <span class='hs-comment'>-- than being imported as part of a "..." group. Consider:</span>
<a name="line-41"></a>        <span class='hs-comment'>--</span>
<a name="line-42"></a>        <span class='hs-comment'>-- &gt; import C( T(..) )</span>
<a name="line-43"></a>        <span class='hs-comment'>--</span>
<a name="line-44"></a>        <span class='hs-comment'>-- Here the constructors of @T@ are not named explicitly;</span>
<a name="line-45"></a>        <span class='hs-comment'>-- only @T@ is named explicitly.</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="unQualSpecOK"></a><span class='hs-definition'>unQualSpecOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-48"></a><span class='hs-comment'>-- ^ Is in scope unqualified?</span>
<a name="line-49"></a><span class='hs-definition'>unQualSpecOK</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_qual</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="qualSpecOK"></a><span class='hs-definition'>qualSpecOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-52"></a><span class='hs-comment'>-- ^ Is in scope qualified with the given module?</span>
<a name="line-53"></a><span class='hs-definition'>qualSpecOK</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>is_as</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="importSpecLoc"></a><span class='hs-definition'>importSpecLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-56"></a><span class='hs-definition'>importSpecLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImpSpec</span> <span class='hs-varid'>decl</span> <span class='hs-conid'>ImpAll</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_dloc</span> <span class='hs-varid'>decl</span>
<a name="line-57"></a><span class='hs-definition'>importSpecLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImpSpec</span> <span class='hs-keyword'>_</span>    <span class='hs-varid'>item</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_iloc</span> <span class='hs-varid'>item</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="importSpecModule"></a><span class='hs-definition'>importSpecModule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span>
<a name="line-60"></a><span class='hs-definition'>importSpecModule</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_mod</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="isExplicitItem"></a><span class='hs-definition'>isExplicitItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImpItemSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-63"></a><span class='hs-definition'>isExplicitItem</span> <span class='hs-conid'>ImpAll</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-64"></a><span class='hs-definition'>isExplicitItem</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImpSome</span> <span class='hs-layout'>{</span><span class='hs-varid'>is_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-comment'>-- Note [Comparing provenance]</span>
<a name="line-67"></a><span class='hs-comment'>-- Comparison of provenance is just used for grouping</span>
<a name="line-68"></a><span class='hs-comment'>-- error messages (in RnEnv.warnUnusedBinds)</span>
<a name="line-69"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>Provenance</span> <span class='hs-keyword'>where</span>
<a name="line-70"></a>  <span class='hs-varid'>p1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>p2</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-keyword'>where</span>
<a name="line-73"></a>  <span class='hs-varid'>p1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>p2</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>ImpItemSpec</span> <span class='hs-keyword'>where</span>
<a name="line-76"></a>  <span class='hs-varid'>p1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>p2</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>Provenance</span> <span class='hs-keyword'>where</span>
<a name="line-79"></a>   <span class='hs-varid'>compare</span> <span class='hs-conid'>LocalDef</span>      <span class='hs-conid'>LocalDef</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-80"></a>   <span class='hs-varid'>compare</span> <span class='hs-conid'>LocalDef</span>      <span class='hs-layout'>(</span><span class='hs-conid'>Imported</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-81"></a>   <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Imported</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>)</span> <span class='hs-conid'>LocalDef</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-82"></a>   <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>Imported</span> <span class='hs-varid'>is1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Imported</span> <span class='hs-varid'>is2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>is1</span><span class='hs-layout'>)</span>
<a name="line-83"></a>        <span class='hs-comment'>{- See Note [Comparing provenance] -}</span>      <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>is2</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>ImpDeclSpec</span> <span class='hs-keyword'>where</span>
<a name="line-86"></a>   <span class='hs-varid'>compare</span> <span class='hs-varid'>is1</span> <span class='hs-varid'>is2</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_mod</span> <span class='hs-varid'>is1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>is_mod</span> <span class='hs-varid'>is2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`thenCmp`</span>
<a name="line-87"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>is_dloc</span> <span class='hs-varid'>is1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>is_dloc</span> <span class='hs-varid'>is2</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>ImpItemSpec</span> <span class='hs-keyword'>where</span>
<a name="line-90"></a>   <span class='hs-varid'>compare</span> <span class='hs-varid'>is1</span> <span class='hs-varid'>is2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_iloc</span> <span class='hs-varid'>is1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>is_iloc</span> <span class='hs-varid'>is2</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="plusProv"></a><span class='hs-definition'>plusProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Provenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Provenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Provenance</span>
<a name="line-2"></a><span class='hs-comment'>-- Choose LocalDef over Imported</span>
<a name="line-3"></a><span class='hs-comment'>-- There is an obscure bug lurking here; in the presence</span>
<a name="line-4"></a><span class='hs-comment'>-- of recursive modules, something can be imported *and* locally</span>
<a name="line-5"></a><span class='hs-comment'>-- defined, and one might refer to it with a qualified name from</span>
<a name="line-6"></a><span class='hs-comment'>-- the import -- but I'm going to ignore that because it makes</span>
<a name="line-7"></a><span class='hs-comment'>-- the isLocalGRE predicate so much nicer this way</span>
<a name="line-8"></a><span class='hs-definition'>plusProv</span> <span class='hs-conid'>LocalDef</span>        <span class='hs-conid'>LocalDef</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"plusProv"</span>
<a name="line-9"></a><span class='hs-definition'>plusProv</span> <span class='hs-conid'>LocalDef</span>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span>
<a name="line-10"></a><span class='hs-definition'>plusProv</span> <span class='hs-keyword'>_</span>               <span class='hs-conid'>LocalDef</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span>
<a name="line-11"></a><span class='hs-definition'>plusProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Imported</span> <span class='hs-varid'>is1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Imported</span> <span class='hs-varid'>is2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-layout'>(</span><span class='hs-varid'>is1</span><span class='hs-varop'>++</span><span class='hs-varid'>is2</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="pprNameProvenance"></a><span class='hs-definition'>pprNameProvenance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-14"></a><span class='hs-comment'>-- ^ Print out the place where the name was imported</span>
<a name="line-15"></a><span class='hs-definition'>pprNameProvenance</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalDef</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"defined at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSrcLoc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>pprNameProvenance</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRE</span> <span class='hs-layout'>{</span><span class='hs-varid'>gre_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>gre_prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Imported</span> <span class='hs-varid'>whys</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>whys</span> <span class='hs-keyword'>of</span>
<a name="line-19"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>why</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_why</span> <span class='hs-varid'>whys</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_why</span> <span class='hs-varid'>why</span>
<a name="line-21"></a>        <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprNameProvenance"</span>
<a name="line-22"></a>  <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>pp_why</span> <span class='hs-varid'>why</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>why</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_defn_site</span> <span class='hs-varid'>why</span> <span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="ppr_defn_site"></a><span class='hs-comment'>-- If we know the exact definition point (which we may do with GHCi)</span>
<a name="line-26"></a><span class='hs-comment'>-- then show that too.  But not if it's just "imported from X".</span>
<a name="line-27"></a><span class='hs-definition'>ppr_defn_site</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-28"></a><span class='hs-definition'>ppr_defn_site</span> <span class='hs-varid'>imp_spec</span> <span class='hs-varid'>name</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>same_module</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGoodSrcSpan</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>              <span class='hs-comment'>-- Nothing interesting to say</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and originally defined"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_mod</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-34"></a>  <span class='hs-keyword'>where</span>
<a name="line-35"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>name</span>
<a name="line-36"></a>    <span class='hs-varid'>defining_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span>
<a name="line-37"></a>    <span class='hs-varid'>same_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>importSpecModule</span> <span class='hs-varid'>imp_spec</span> <span class='hs-varop'>==</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>defining_mod</span>
<a name="line-38"></a>    <span class='hs-varid'>pp_mod</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>same_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-39"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>defining_mod</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ImportSpec</span> <span class='hs-keyword'>where</span>
<a name="line-43"></a>   <span class='hs-varid'>ppr</span> <span class='hs-varid'>imp_spec</span>
<a name="line-44"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"imported"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>qual</span>
<a name="line-45"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"from"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>importSpecModule</span> <span class='hs-varid'>imp_spec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>importSpecLoc</span> <span class='hs-varid'>imp_spec</span><span class='hs-layout'>)</span>
<a name="line-47"></a>     <span class='hs-keyword'>where</span>
<a name="line-48"></a>       <span class='hs-varid'>qual</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_qual</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_decl</span> <span class='hs-varid'>imp_spec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"qualified"</span><span class='hs-layout'>)</span>
<a name="line-49"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="pprLoc"></a><span class='hs-definition'>pprLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-52"></a><span class='hs-definition'>pprLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealSrcSpan</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span>
<a name="line-53"></a><span class='hs-definition'>pprLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnhelpfulSpan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
</pre>\end{code}
</body>
</html>
