<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>main/SysTools.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
-----------------------------------------------------------------------------
--
-- (c) The University of Glasgow 2001-2003
--
-- Access to system tools: gcc, cp, rm etc
--
-----------------------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>SysTools</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-comment'>-- Initialisation</span>
<a name="line-3"></a>        <span class='hs-varid'>initSysTools</span><span class='hs-layout'>,</span>
<a name="line-4"></a>
<a name="line-5"></a>        <span class='hs-comment'>-- Interface to system tools</span>
<a name="line-6"></a>        <span class='hs-varid'>runUnlit</span><span class='hs-layout'>,</span> <span class='hs-varid'>runCpp</span><span class='hs-layout'>,</span> <span class='hs-varid'>runCc</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-7"></a>        <span class='hs-varid'>runPp</span><span class='hs-layout'>,</span>                   <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-8"></a>        <span class='hs-varid'>runSplit</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-9"></a>        <span class='hs-varid'>runAs</span><span class='hs-layout'>,</span> <span class='hs-varid'>runLink</span><span class='hs-layout'>,</span> <span class='hs-varid'>runLibtool</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- [Option] -&gt; IO ()</span>
<a name="line-10"></a>        <span class='hs-varid'>runMkDLL</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>runWindres</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>runLlvmOpt</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>runLlvmLlc</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>runClang</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>figureLlvmVersion</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>readElfSection</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-varid'>getLinkerInfo</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>getCompilerInfo</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-varid'>linkDynLib</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-varid'>askCc</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-varid'>touch</span><span class='hs-layout'>,</span>                  <span class='hs-comment'>-- String -&gt; String -&gt; IO ()</span>
<a name="line-26"></a>        <span class='hs-varid'>copy</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>copyWithHeader</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- Temporary-file management</span>
<a name="line-30"></a>        <span class='hs-varid'>setTmpDir</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>newTempName</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>cleanTempDirs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanTempFiles</span><span class='hs-layout'>,</span> <span class='hs-varid'>cleanTempFilesExcept</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>addFilesToClean</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-conid'>Option</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DriverPhases</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Packages</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Config</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Exception</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Exit</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Environment</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Error</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>IO</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>ParserCombinators</span><span class='hs-varop'>.</span><span class='hs-conid'>ReadP</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>ParserCombinators</span><span class='hs-varop'>.</span><span class='hs-conid'>ReadP</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>R</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-cpp'>#ifndef mingw32_HOST_OS</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span>
<a name="line-69"></a><span class='hs-cpp'>#else /* Must be Win32 */</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span><span class='hs-varop'>.</span><span class='hs-conid'>String</span>
<a name="line-72"></a><span class='hs-cpp'>#endif</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Process</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>SrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSrcLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>noSrcSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSrcSpan</span> <span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-cpp'>#ifdef mingw32_HOST_OS</span>
<a name="line-80"></a><span class='hs-cpp'># if defined(i386_HOST_ARCH)</span>
<a name="line-81"></a><span class='hs-cpp'>#  define WINDOWS_CCONV stdcall</span>
<a name="line-82"></a><span class='hs-cpp'># elif defined(x86_64_HOST_ARCH)</span>
<a name="line-83"></a><span class='hs-cpp'>#  define WINDOWS_CCONV ccall</span>
<a name="line-84"></a><span class='hs-cpp'># else</span>
<a name="line-85"></a><span class='hs-cpp'>#  error Unknown mingw32 arch</span>
<a name="line-86"></a><span class='hs-cpp'># endif</span>
<a name="line-87"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

How GHC finds its files
~~~~~~~~~~~~~~~~~~~~~~~

[Note topdir]

GHC needs various support files (library packages, RTS etc), plus
various auxiliary programs (cp, gcc, etc).  It starts by finding topdir,
the root of GHC's support files

On Unix:
  - ghc always has a shell wrapper that passes a -B<dir> option

On Windows:
  - ghc never has a shell wrapper.
  - we can find the location of the ghc binary, which is
        $topdir/bin/<something>.exe
    where <something> may be "ghc", "ghc-stage2", or similar
  - we strip off the "bin/<something>.exe" to leave $topdir.

from topdir we can find package.conf, ghc-asm, etc.


SysTools.initSysProgs figures out exactly where all the auxiliary programs
are, and initialises mutable variables to make it easy to call them.
To to this, it makes use of definitions in Config.hs, which is a Haskell
file containing variables whose value is figured out by the build system.

Config.hs contains two sorts of things

  cGCC,         The *names* of the programs
  cCPP            e.g.  cGCC = gcc
  cUNLIT                cCPP = gcc -E
  etc           They do *not* include paths


  cUNLIT_DIR   The *path* to the directory containing unlit, split etc
  cSPLIT_DIR   *relative* to the root of the build tree,
                   for use when running *in-place* in a build tree (only)



---------------------------------------------
NOTES for an ALTERNATIVE scheme (i.e *not* what is currently implemented):

Another hair-brained scheme for simplifying the current tool location
nightmare in GHC: Simon originally suggested using another
configuration file along the lines of GCC's specs file - which is fine
except that it means adding code to read yet another configuration
file.  What I didn't notice is that the current package.conf is
general enough to do this:

Package
    {name = "tools",    import_dirs = [],  source_dirs = [],
     library_dirs = [], hs_libraries = [], extra_libraries = [],
     include_dirs = [], c_includes = [],   package_deps = [],
     extra_ghc_opts = ["-pgmc/usr/bin/gcc","-pgml${topdir}/bin/unlit", ... etc.],
     extra_cc_opts = [], extra_ld_opts = []}

Which would have the advantage that we get to collect together in one
place the path-specific package stuff with the path-specific tool
stuff.
                End of NOTES
---------------------------------------------

%************************************************************************
%*                                                                      *
\subsection{Initialisation}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="initSysTools"></a><span class='hs-definition'>initSysTools</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span>    <span class='hs-comment'>-- Maybe TopDir path (without the '-B' prefix)</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Settings</span>     <span class='hs-comment'>-- Set all the mutable variables above, holding</span>
<a name="line-3"></a>                                <span class='hs-comment'>--      (a) the system programs</span>
<a name="line-4"></a>                                <span class='hs-comment'>--      (b) the package-config file</span>
<a name="line-5"></a>                                <span class='hs-comment'>--      (c) the GHC usage message</span>
<a name="line-6"></a><span class='hs-definition'>initSysTools</span> <span class='hs-varid'>mbMinusB</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>top_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findTopDir</span> <span class='hs-varid'>mbMinusB</span>
<a name="line-8"></a>             <span class='hs-comment'>-- see [Note topdir]</span>
<a name="line-9"></a>             <span class='hs-comment'>-- NB: top_dir is assumed to be in standard Unix</span>
<a name="line-10"></a>             <span class='hs-comment'>-- format, '/' separated</span>
<a name="line-11"></a>
<a name="line-12"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>settingsFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"settings"</span>
<a name="line-13"></a>           <span class='hs-varid'>platformConstantsFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"platformConstants"</span>
<a name="line-14"></a>           <span class='hs-varid'>installed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-15"></a>           <span class='hs-varid'>installed</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>file</span>
<a name="line-16"></a>
<a name="line-17"></a>       <span class='hs-varid'>settingsStr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readFile</span> <span class='hs-varid'>settingsFile</span>
<a name="line-18"></a>       <span class='hs-varid'>platformConstantsStr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readFile</span> <span class='hs-varid'>platformConstantsFile</span>
<a name="line-19"></a>       <span class='hs-varid'>mySettings</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeReadFuzzy</span> <span class='hs-varid'>settingsStr</span> <span class='hs-keyword'>of</span>
<a name="line-20"></a>                     <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-21"></a>                         <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-22"></a>                     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-23"></a>                         <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Can't parse "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-24"></a>       <span class='hs-varid'>platformConstants</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeReadFuzzy</span> <span class='hs-varid'>platformConstantsStr</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-26"></a>                                <span class='hs-varid'>return</span> <span class='hs-varid'>s</span>
<a name="line-27"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-28"></a>                                <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Can't parse "</span> <span class='hs-varop'>++</span>
<a name="line-29"></a>                                          <span class='hs-varid'>show</span> <span class='hs-varid'>platformConstantsFile</span><span class='hs-layout'>)</span>
<a name="line-30"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>getSetting</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>mySettings</span> <span class='hs-keyword'>of</span>
<a name="line-31"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-32"></a>                                <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stripPrefix</span> <span class='hs-str'>"$topdir"</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-33"></a>                                         <span class='hs-conid'>Just</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-34"></a>                                             <span class='hs-varid'>top_dir</span>
<a name="line-35"></a>                                         <span class='hs-conid'>Just</span> <span class='hs-varid'>xs'</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-37"></a>                                             <span class='hs-varid'>top_dir</span> <span class='hs-varop'>++</span> <span class='hs-varid'>xs'</span>
<a name="line-38"></a>                                         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-39"></a>                                             <span class='hs-varid'>xs</span>
<a name="line-40"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"No entry for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" in "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-41"></a>           <span class='hs-varid'>getBooleanSetting</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>mySettings</span> <span class='hs-keyword'>of</span>
<a name="line-42"></a>                                   <span class='hs-conid'>Just</span> <span class='hs-str'>"YES"</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-43"></a>                                   <span class='hs-conid'>Just</span> <span class='hs-str'>"NO"</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-44"></a>                                   <span class='hs-conid'>Just</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Bad value for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                                   <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"No entry for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" in "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-46"></a>           <span class='hs-varid'>readSetting</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>key</span> <span class='hs-varid'>mySettings</span> <span class='hs-keyword'>of</span>
<a name="line-47"></a>                             <span class='hs-conid'>Just</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-48"></a>                                 <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeRead</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-49"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-50"></a>                                 <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Failed to read "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" value "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pgmError</span> <span class='hs-layout'>(</span><span class='hs-str'>"No entry for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>key</span> <span class='hs-varop'>++</span> <span class='hs-str'>" in "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>settingsFile</span><span class='hs-layout'>)</span>
<a name="line-52"></a>       <span class='hs-varid'>targetArch</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target arch"</span>
<a name="line-53"></a>       <span class='hs-varid'>targetOS</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target os"</span>
<a name="line-54"></a>       <span class='hs-varid'>targetWordSize</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target word size"</span>
<a name="line-55"></a>       <span class='hs-varid'>targetUnregisterised</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"Unregisterised"</span>
<a name="line-56"></a>       <span class='hs-varid'>targetHasGnuNonexecStack</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target has GNU nonexec stack"</span>
<a name="line-57"></a>       <span class='hs-varid'>targetHasIdentDirective</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target has .ident directive"</span>
<a name="line-58"></a>       <span class='hs-varid'>targetHasSubsectionsViaSymbols</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readSetting</span> <span class='hs-str'>"target has subsections via symbols"</span>
<a name="line-59"></a>       <span class='hs-varid'>myExtraGccViaCFlags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"GCC extra via C opts"</span>
<a name="line-60"></a>       <span class='hs-comment'>-- On Windows, mingw is distributed with GHC,</span>
<a name="line-61"></a>       <span class='hs-comment'>-- so we look in TopDir/../mingw/bin</span>
<a name="line-62"></a>       <span class='hs-comment'>-- It would perhaps be nice to be able to override this</span>
<a name="line-63"></a>       <span class='hs-comment'>-- with the settings file, but it would be a little fiddly</span>
<a name="line-64"></a>       <span class='hs-comment'>-- to make that possible, so for now you can't.</span>
<a name="line-65"></a>       <span class='hs-varid'>gcc_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"C compiler command"</span>
<a name="line-66"></a>       <span class='hs-varid'>gcc_args_str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"C compiler flags"</span>
<a name="line-67"></a>       <span class='hs-varid'>cpp_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"Haskell CPP command"</span>
<a name="line-68"></a>       <span class='hs-varid'>cpp_args_str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"Haskell CPP flags"</span>
<a name="line-69"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>unreg_gcc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>targetUnregisterised</span>
<a name="line-70"></a>                            <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-DNO_REGS"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-DUSE_MINIINTERPRETER"</span><span class='hs-keyglyph'>]</span>
<a name="line-71"></a>                            <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-72"></a>           <span class='hs-comment'>-- TABLES_NEXT_TO_CODE affects the info table layout.</span>
<a name="line-73"></a>           <span class='hs-varid'>tntc_gcc_args</span>
<a name="line-74"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mkTablesNextToCode</span> <span class='hs-varid'>targetUnregisterised</span>
<a name="line-75"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-DTABLES_NEXT_TO_CODE"</span><span class='hs-keyglyph'>]</span>
<a name="line-76"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-77"></a>           <span class='hs-varid'>cpp_args</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>words</span> <span class='hs-varid'>cpp_args_str</span><span class='hs-layout'>)</span>
<a name="line-78"></a>           <span class='hs-varid'>gcc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>words</span> <span class='hs-varid'>gcc_args_str</span>
<a name="line-79"></a>                               <span class='hs-varop'>++</span> <span class='hs-varid'>unreg_gcc_args</span>
<a name="line-80"></a>                               <span class='hs-varop'>++</span> <span class='hs-varid'>tntc_gcc_args</span><span class='hs-layout'>)</span>
<a name="line-81"></a>       <span class='hs-varid'>ldSupportsCompactUnwind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld supports compact unwind"</span>
<a name="line-82"></a>       <span class='hs-varid'>ldSupportsBuildId</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld supports build-id"</span>
<a name="line-83"></a>       <span class='hs-varid'>ldSupportsFilelist</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld supports filelist"</span>
<a name="line-84"></a>       <span class='hs-varid'>ldIsGnuLd</span>               <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBooleanSetting</span> <span class='hs-str'>"ld is GNU ld"</span>
<a name="line-85"></a>       <span class='hs-varid'>perl_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"perl command"</span>
<a name="line-86"></a>
<a name="line-87"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>pkgconfig_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-str'>"package.conf.d"</span>
<a name="line-88"></a>           <span class='hs-varid'>ghc_usage_msg_path</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-str'>"ghc-usage.txt"</span>
<a name="line-89"></a>           <span class='hs-varid'>ghci_usage_msg_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-str'>"ghci-usage.txt"</span>
<a name="line-90"></a>
<a name="line-91"></a>             <span class='hs-comment'>-- For all systems, unlit, split, mangle are GHC utilities</span>
<a name="line-92"></a>             <span class='hs-comment'>-- architecture-specific stuff is done when building Config.hs</span>
<a name="line-93"></a>           <span class='hs-varid'>unlit_path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-varid'>cGHC_UNLIT_PGM</span>
<a name="line-94"></a>
<a name="line-95"></a>             <span class='hs-comment'>-- split is a Perl script</span>
<a name="line-96"></a>           <span class='hs-varid'>split_script</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>installed</span> <span class='hs-varid'>cGHC_SPLIT_PGM</span>
<a name="line-97"></a>
<a name="line-98"></a>       <span class='hs-varid'>windres_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"windres command"</span>
<a name="line-99"></a>       <span class='hs-varid'>libtool_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"libtool command"</span>
<a name="line-100"></a>
<a name="line-101"></a>       <span class='hs-varid'>tmpdir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTemporaryDirectory</span>
<a name="line-102"></a>
<a name="line-103"></a>       <span class='hs-varid'>touch_path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"touch command"</span>
<a name="line-104"></a>
<a name="line-105"></a>       <span class='hs-keyword'>let</span> <span class='hs-comment'>-- On Win32 we don't want to rely on #!/bin/perl, so we prepend</span>
<a name="line-106"></a>           <span class='hs-comment'>-- a call to Perl to get the invocation of split.</span>
<a name="line-107"></a>           <span class='hs-comment'>-- On Unix, scripts are invoked using the '#!' method.  Binary</span>
<a name="line-108"></a>           <span class='hs-comment'>-- installations of GHC on Unix place the correct line on the</span>
<a name="line-109"></a>           <span class='hs-comment'>-- front of the script at installation time, so we don't want</span>
<a name="line-110"></a>           <span class='hs-comment'>-- to wire-in our knowledge of $(PERL) on the host system here.</span>
<a name="line-111"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>split_prog</span><span class='hs-layout'>,</span>  <span class='hs-varid'>split_args</span><span class='hs-layout'>)</span>
<a name="line-112"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWindowsHost</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>perl_path</span><span class='hs-layout'>,</span>    <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-varid'>split_script</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-113"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>split_script</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-114"></a>       <span class='hs-varid'>mkdll_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"dllwrap command"</span>
<a name="line-115"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>mkdll_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-116"></a>
<a name="line-117"></a>       <span class='hs-comment'>-- cpp is derived from gcc on all platforms</span>
<a name="line-118"></a>       <span class='hs-comment'>-- HACK, see setPgmP below. We keep 'words' here to remember to fix</span>
<a name="line-119"></a>       <span class='hs-comment'>-- Config.hs one day.</span>
<a name="line-120"></a>
<a name="line-121"></a>
<a name="line-122"></a>       <span class='hs-comment'>-- Other things being equal, as and ld are simply gcc</span>
<a name="line-123"></a>       <span class='hs-varid'>gcc_link_args_str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"C compiler link flags"</span>
<a name="line-124"></a>       <span class='hs-keyword'>let</span>   <span class='hs-varid'>as_prog</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_prog</span>
<a name="line-125"></a>             <span class='hs-varid'>as_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_args</span>
<a name="line-126"></a>             <span class='hs-varid'>ld_prog</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_prog</span>
<a name="line-127"></a>             <span class='hs-varid'>ld_args</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gcc_args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>words</span> <span class='hs-varid'>gcc_link_args_str</span><span class='hs-layout'>)</span>
<a name="line-128"></a>
<a name="line-129"></a>       <span class='hs-comment'>-- We just assume on command line</span>
<a name="line-130"></a>       <span class='hs-varid'>lc_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"LLVM llc command"</span>
<a name="line-131"></a>       <span class='hs-varid'>lo_prog</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSetting</span> <span class='hs-str'>"LLVM opt command"</span>
<a name="line-132"></a>
<a name="line-133"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Platform</span> <span class='hs-layout'>{</span>
<a name="line-134"></a>                          <span class='hs-varid'>platformArch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetArch</span><span class='hs-layout'>,</span>
<a name="line-135"></a>                          <span class='hs-varid'>platformOS</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetOS</span><span class='hs-layout'>,</span>
<a name="line-136"></a>                          <span class='hs-varid'>platformWordSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetWordSize</span><span class='hs-layout'>,</span>
<a name="line-137"></a>                          <span class='hs-varid'>platformUnregisterised</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetUnregisterised</span><span class='hs-layout'>,</span>
<a name="line-138"></a>                          <span class='hs-varid'>platformHasGnuNonexecStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetHasGnuNonexecStack</span><span class='hs-layout'>,</span>
<a name="line-139"></a>                          <span class='hs-varid'>platformHasIdentDirective</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetHasIdentDirective</span><span class='hs-layout'>,</span>
<a name="line-140"></a>                          <span class='hs-varid'>platformHasSubsectionsViaSymbols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetHasSubsectionsViaSymbols</span>
<a name="line-141"></a>                      <span class='hs-layout'>}</span>
<a name="line-142"></a>
<a name="line-143"></a>       <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Settings</span> <span class='hs-layout'>{</span>
<a name="line-144"></a>                    <span class='hs-varid'>sTargetPlatform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platform</span><span class='hs-layout'>,</span>
<a name="line-145"></a>                    <span class='hs-varid'>sTmpDir</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>tmpdir</span><span class='hs-layout'>,</span>
<a name="line-146"></a>                    <span class='hs-varid'>sGhcUsagePath</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ghc_usage_msg_path</span><span class='hs-layout'>,</span>
<a name="line-147"></a>                    <span class='hs-varid'>sGhciUsagePath</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ghci_usage_msg_path</span><span class='hs-layout'>,</span>
<a name="line-148"></a>                    <span class='hs-varid'>sTopDir</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span><span class='hs-layout'>,</span>
<a name="line-149"></a>                    <span class='hs-varid'>sRawSettings</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mySettings</span><span class='hs-layout'>,</span>
<a name="line-150"></a>                    <span class='hs-varid'>sExtraGccViaCFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>words</span> <span class='hs-varid'>myExtraGccViaCFlags</span><span class='hs-layout'>,</span>
<a name="line-151"></a>                    <span class='hs-varid'>sSystemPackageConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgconfig_path</span><span class='hs-layout'>,</span>
<a name="line-152"></a>                    <span class='hs-varid'>sLdSupportsCompactUnwind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldSupportsCompactUnwind</span><span class='hs-layout'>,</span>
<a name="line-153"></a>                    <span class='hs-varid'>sLdSupportsBuildId</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldSupportsBuildId</span><span class='hs-layout'>,</span>
<a name="line-154"></a>                    <span class='hs-varid'>sLdSupportsFilelist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldSupportsFilelist</span><span class='hs-layout'>,</span>
<a name="line-155"></a>                    <span class='hs-varid'>sLdIsGnuLd</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldIsGnuLd</span><span class='hs-layout'>,</span>
<a name="line-156"></a>                    <span class='hs-varid'>sPgm_L</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlit_path</span><span class='hs-layout'>,</span>
<a name="line-157"></a>                    <span class='hs-varid'>sPgm_P</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpp_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>cpp_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-158"></a>                    <span class='hs-varid'>sPgm_F</span>   <span class='hs-keyglyph'>=</span> <span class='hs-str'>""</span><span class='hs-layout'>,</span>
<a name="line-159"></a>                    <span class='hs-varid'>sPgm_c</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcc_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>gcc_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-160"></a>                    <span class='hs-varid'>sPgm_s</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>split_prog</span><span class='hs-layout'>,</span><span class='hs-varid'>split_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-161"></a>                    <span class='hs-varid'>sPgm_a</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>as_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>as_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-162"></a>                    <span class='hs-varid'>sPgm_l</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ld_prog</span><span class='hs-layout'>,</span> <span class='hs-varid'>ld_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-163"></a>                    <span class='hs-varid'>sPgm_dll</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkdll_prog</span><span class='hs-layout'>,</span><span class='hs-varid'>mkdll_args</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-164"></a>                    <span class='hs-varid'>sPgm_T</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>touch_path</span><span class='hs-layout'>,</span>
<a name="line-165"></a>                    <span class='hs-varid'>sPgm_sysman</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top_dir</span> <span class='hs-varop'>++</span> <span class='hs-str'>"/ghc/rts/parallel/SysMan"</span><span class='hs-layout'>,</span>
<a name="line-166"></a>                    <span class='hs-varid'>sPgm_windres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>windres_path</span><span class='hs-layout'>,</span>
<a name="line-167"></a>                    <span class='hs-varid'>sPgm_libtool</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libtool_path</span><span class='hs-layout'>,</span>
<a name="line-168"></a>                    <span class='hs-varid'>sPgm_lo</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lo_prog</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-169"></a>                    <span class='hs-varid'>sPgm_lc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lc_prog</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-170"></a>                    <span class='hs-comment'>-- Hans: this isn't right in general, but you can</span>
<a name="line-171"></a>                    <span class='hs-comment'>-- elaborate it in the same way as the others</span>
<a name="line-172"></a>                    <span class='hs-varid'>sOpt_L</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-173"></a>                    <span class='hs-varid'>sOpt_P</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-174"></a>                    <span class='hs-varid'>sOpt_F</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-175"></a>                    <span class='hs-varid'>sOpt_c</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-176"></a>                    <span class='hs-varid'>sOpt_a</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-177"></a>                    <span class='hs-varid'>sOpt_l</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-178"></a>                    <span class='hs-varid'>sOpt_windres</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-179"></a>                    <span class='hs-varid'>sOpt_lo</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-180"></a>                    <span class='hs-varid'>sOpt_lc</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-181"></a>                    <span class='hs-varid'>sPlatformConstants</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformConstants</span>
<a name="line-182"></a>             <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="findTopDir"></a><span class='hs-comment'>-- returns a Unix-format path (relying on getBaseDir to do so too)</span>
<a name="line-2"></a><span class='hs-definition'>findTopDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- Maybe TopDir path (without the '-B' prefix).</span>
<a name="line-3"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>String</span>    <span class='hs-comment'>-- TopDir (in Unix format '/' separated)</span>
<a name="line-4"></a><span class='hs-definition'>findTopDir</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>minusb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>normalise</span> <span class='hs-varid'>minusb</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>findTopDir</span> <span class='hs-conid'>Nothing</span>
<a name="line-6"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- Get directory of executable</span>
<a name="line-7"></a>         <span class='hs-varid'>maybe_exec_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBaseDir</span>
<a name="line-8"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_exec_dir</span> <span class='hs-keyword'>of</span>
<a name="line-9"></a>             <span class='hs-comment'>-- "Just" on Windows, "Nothing" on unix</span>
<a name="line-10"></a>             <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstallationError</span> <span class='hs-str'>"missing -B&lt;dir&gt; option"</span><span class='hs-layout'>)</span>
<a name="line-11"></a>             <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>dir</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Running an external program}
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="runUnlit"></a><span class='hs-definition'>runUnlit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>runUnlit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_L</span> <span class='hs-varid'>dflags</span>
<a name="line-4"></a>      <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_L</span>
<a name="line-5"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Literate pre-processor"</span> <span class='hs-varid'>prog</span>
<a name="line-6"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>opts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="runCpp"></a><span class='hs-definition'>runCpp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-9"></a><span class='hs-definition'>runCpp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>   <span class='hs-keyword'>do</span>
<a name="line-10"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_P</span> <span class='hs-varid'>dflags</span>
<a name="line-11"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_P</span><span class='hs-layout'>)</span>
<a name="line-12"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WarnIsError</span> <span class='hs-varid'>dflags</span>
<a name="line-13"></a>                 <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Werror"</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a>                 <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-15"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-16"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span>  <span class='hs-str'>"C pre-processor"</span> <span class='hs-varid'>p</span>
<a name="line-17"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_env</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="runPp"></a><span class='hs-definition'>runPp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-20"></a><span class='hs-definition'>runPp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>   <span class='hs-keyword'>do</span>
<a name="line-21"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_F</span> <span class='hs-varid'>dflags</span>
<a name="line-22"></a>      <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_F</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Haskell pre-processor"</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>opts</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="runCc"></a><span class='hs-definition'>runCc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-26"></a><span class='hs-definition'>runCc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>   <span class='hs-keyword'>do</span>
<a name="line-27"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-28"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_c</span><span class='hs-layout'>)</span>
<a name="line-29"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-30"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-31"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cc_filter</span> <span class='hs-str'>"C Compiler"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-32"></a> <span class='hs-keyword'>where</span>
<a name="line-33"></a>  <span class='hs-comment'>-- discard some harmless warnings from gcc that we can't turn off</span>
<a name="line-34"></a>  <span class='hs-varid'>cc_filter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlines</span> <span class='hs-varop'>.</span> <span class='hs-varid'>doFilter</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lines</span>
<a name="line-35"></a>
<a name="line-36"></a>  <span class='hs-comment'>{-
<a name="line-37"></a>  gcc gives warnings in chunks like so:
<a name="line-38"></a>      In file included from /foo/bar/baz.h:11,
<a name="line-39"></a>                       from /foo/bar/baz2.h:22,
<a name="line-40"></a>                       from wibble.c:33:
<a name="line-41"></a>      /foo/flibble:14: global register variable ...
<a name="line-42"></a>      /foo/flibble:15: warning: call-clobbered r...
<a name="line-43"></a>  We break it up into its chunks, remove any call-clobbered register
<a name="line-44"></a>  warnings from each chunk, and then delete any chunks that we have
<a name="line-45"></a>  emptied of warnings.
<a name="line-46"></a>  -}</span>
<a name="line-47"></a>  <span class='hs-varid'>doFilter</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unChunkWarnings</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varop'>.</span> <span class='hs-varid'>chunkWarnings</span> <span class='hs-conid'>[]</span>
<a name="line-48"></a>  <span class='hs-comment'>-- We can't assume that the output will start with an "In file inc..."</span>
<a name="line-49"></a>  <span class='hs-comment'>-- line, so we start off expecting a list of warnings rather than a</span>
<a name="line-50"></a>  <span class='hs-comment'>-- location stack.</span>
<a name="line-51"></a>  <span class='hs-varid'>chunkWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- The location stack to use for the next</span>
<a name="line-52"></a>                            <span class='hs-comment'>-- list of warnings</span>
<a name="line-53"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- The remaining lines to look at</span>
<a name="line-54"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-55"></a>  <span class='hs-varid'>chunkWarnings</span> <span class='hs-varid'>loc_stack</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>loc_stack</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-56"></a>  <span class='hs-varid'>chunkWarnings</span> <span class='hs-varid'>loc_stack</span> <span class='hs-varid'>xs</span>
<a name="line-57"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>break</span> <span class='hs-varid'>loc_stack_start</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-58"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>warnings</span><span class='hs-layout'>,</span> <span class='hs-varid'>lss</span><span class='hs-conop'>:</span><span class='hs-varid'>xs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-59"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>span</span> <span class='hs-varid'>loc_start_continuation</span> <span class='hs-varid'>xs'</span> <span class='hs-keyword'>of</span>
<a name="line-60"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>lsc</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-61"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>loc_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnings</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>chunkWarnings</span> <span class='hs-layout'>(</span><span class='hs-varid'>lss</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lsc</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs''</span>
<a name="line-62"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>loc_stack</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a>
<a name="line-64"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-65"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-66"></a>  <span class='hs-comment'>-- If the warnings are already empty then we are probably doing</span>
<a name="line-67"></a>  <span class='hs-comment'>-- something wrong, so don't delete anything</span>
<a name="line-68"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-69"></a>  <span class='hs-varid'>filterWarnings</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>wantedWarning</span> <span class='hs-varid'>ys</span> <span class='hs-keyword'>of</span>
<a name="line-70"></a>                                       <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-71"></a>                                       <span class='hs-varid'>ys'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>filterWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-72"></a>
<a name="line-73"></a>  <span class='hs-varid'>unChunkWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-74"></a>  <span class='hs-varid'>unChunkWarnings</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-75"></a>  <span class='hs-varid'>unChunkWarnings</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unChunkWarnings</span> <span class='hs-varid'>zs</span>
<a name="line-76"></a>
<a name="line-77"></a>  <span class='hs-varid'>loc_stack_start</span>        <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"In file included from "</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>s</span>
<a name="line-78"></a>  <span class='hs-varid'>loc_start_continuation</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"                 from "</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>s</span>
<a name="line-79"></a>  <span class='hs-varid'>wantedWarning</span> <span class='hs-varid'>w</span>
<a name="line-80"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-str'>"warning: call-clobbered register used"</span> <span class='hs-varop'>`isContainedIn`</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-81"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="isContainedIn"></a><span class='hs-definition'>isContainedIn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-84"></a><a name="isContainedIn"></a><span class='hs-definition'>xs</span> <span class='hs-varop'>`isContainedIn`</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tails</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="askCc"></a><span class='hs-definition'>askCc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>String</span>
<a name="line-87"></a><span class='hs-definition'>askCc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-88"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-89"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_c</span><span class='hs-layout'>)</span>
<a name="line-90"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-91"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-92"></a>  <span class='hs-varid'>runSomethingWith</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"gcc"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>real_args</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-93"></a>    <span class='hs-varid'>readCreateProcess</span> <span class='hs-layout'>(</span><span class='hs-varid'>proc</span> <span class='hs-varid'>p</span> <span class='hs-varid'>real_args</span><span class='hs-layout'>)</span><span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_env</span> <span class='hs-layout'>}</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="readCreateProcess"></a><span class='hs-comment'>-- Version of System.Process.readProcessWithExitCode that takes an environment</span>
<a name="line-96"></a><span class='hs-definition'>readCreateProcess</span>
<a name="line-97"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CreateProcess</span>
<a name="line-98"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ^ stdout</span>
<a name="line-99"></a><span class='hs-definition'>readCreateProcess</span> <span class='hs-varid'>proc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-100"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>outh</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>pid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-101"></a>        <span class='hs-varid'>createProcess</span> <span class='hs-varid'>proc</span><span class='hs-layout'>{</span> <span class='hs-varid'>std_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CreatePipe</span> <span class='hs-layout'>}</span>
<a name="line-102"></a>
<a name="line-103"></a>    <span class='hs-comment'>-- fork off a thread to start consuming the output</span>
<a name="line-104"></a>    <span class='hs-varid'>output</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetContents</span> <span class='hs-varid'>outh</span>
<a name="line-105"></a>    <span class='hs-varid'>outMVar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-106"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>evaluate</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>output</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>putMVar</span> <span class='hs-varid'>outMVar</span> <span class='hs-conid'>()</span>
<a name="line-107"></a>
<a name="line-108"></a>    <span class='hs-comment'>-- wait on the output</span>
<a name="line-109"></a>    <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>outMVar</span>
<a name="line-110"></a>    <span class='hs-varid'>hClose</span> <span class='hs-varid'>outh</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-comment'>-- wait on the process</span>
<a name="line-113"></a>    <span class='hs-varid'>ex</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitForProcess</span> <span class='hs-varid'>pid</span>
<a name="line-114"></a>
<a name="line-115"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ex</span><span class='hs-layout'>,</span> <span class='hs-varid'>output</span><span class='hs-layout'>)</span>
<a name="line-116"></a>
<a name="line-117"></a>
<a name="line-118"></a><a name="getGccEnv"></a><span class='hs-comment'>-- If the -B&lt;dir&gt; option is set, add &lt;dir&gt; to PATH.  This works around</span>
<a name="line-119"></a><span class='hs-comment'>-- a bug in gcc on Windows Vista where it can't find its auxiliary</span>
<a name="line-120"></a><span class='hs-comment'>-- binaries (see bug #1110).</span>
<a name="line-121"></a><span class='hs-definition'>getGccEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-122"></a><span class='hs-definition'>getGccEnv</span> <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span>
<a name="line-123"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>b_dirs</span>
<a name="line-124"></a>     <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-125"></a>     <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnvironment</span>
<a name="line-126"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mangle_path</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-127"></a> <span class='hs-keyword'>where</span>
<a name="line-128"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>b_dirs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>get_b_opt</span> <span class='hs-varid'>opts</span>
<a name="line-129"></a>
<a name="line-130"></a>  <span class='hs-varid'>get_b_opt</span> <span class='hs-layout'>(</span><span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-chr'>'-'</span><span class='hs-conop'>:</span><span class='hs-chr'>'B'</span><span class='hs-conop'>:</span><span class='hs-varid'>dir</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>dir</span>
<a name="line-131"></a>  <span class='hs-varid'>get_b_opt</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>other</span>
<a name="line-132"></a>
<a name="line-133"></a>  <span class='hs-varid'>mangle_path</span> <span class='hs-layout'>(</span><span class='hs-varid'>path</span><span class='hs-layout'>,</span><span class='hs-varid'>paths</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toUpper</span> <span class='hs-varid'>path</span> <span class='hs-varop'>==</span> <span class='hs-str'>"PATH"</span>
<a name="line-134"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>path</span><span class='hs-layout'>,</span> <span class='hs-chr'>'\"'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>head</span> <span class='hs-varid'>b_dirs</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\";"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>paths</span><span class='hs-layout'>)</span>
<a name="line-135"></a>  <span class='hs-varid'>mangle_path</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="runSplit"></a><span class='hs-definition'>runSplit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-138"></a><span class='hs-definition'>runSplit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-139"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_s</span> <span class='hs-varid'>dflags</span>
<a name="line-140"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Splitter"</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span><span class='hs-varop'>++</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="runAs"></a><span class='hs-definition'>runAs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-143"></a><span class='hs-definition'>runAs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-144"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_a</span> <span class='hs-varid'>dflags</span>
<a name="line-145"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_a</span><span class='hs-layout'>)</span>
<a name="line-146"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-147"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-148"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Assembler"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="runLlvmOpt"></a><span class='hs-comment'>-- | Run the LLVM Optimiser</span>
<a name="line-151"></a><span class='hs-definition'>runLlvmOpt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-152"></a><span class='hs-definition'>runLlvmOpt</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-153"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_lo</span> <span class='hs-varid'>dflags</span>
<a name="line-154"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_lo</span><span class='hs-layout'>)</span>
<a name="line-155"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"LLVM Optimiser"</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="runLlvmLlc"></a><span class='hs-comment'>-- | Run the LLVM Compiler</span>
<a name="line-158"></a><span class='hs-definition'>runLlvmLlc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-159"></a><span class='hs-definition'>runLlvmLlc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-160"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_lc</span> <span class='hs-varid'>dflags</span>
<a name="line-161"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_lc</span><span class='hs-layout'>)</span>
<a name="line-162"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"LLVM Compiler"</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="runClang"></a><span class='hs-comment'>-- | Run the clang compiler (used as an assembler for the LLVM</span>
<a name="line-165"></a><span class='hs-comment'>-- backend on OS X as LLVM doesn't support the OS X system</span>
<a name="line-166"></a><span class='hs-comment'>-- assembler)</span>
<a name="line-167"></a><span class='hs-definition'>runClang</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-168"></a><span class='hs-definition'>runClang</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-169"></a>  <span class='hs-comment'>-- we simply assume its available on the PATH</span>
<a name="line-170"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>clang</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"clang"</span>
<a name="line-171"></a>      <span class='hs-comment'>-- be careful what options we call clang with</span>
<a name="line-172"></a>      <span class='hs-comment'>-- see #5903 and #7617 for bugs caused by this.</span>
<a name="line-173"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_a</span> <span class='hs-varid'>dflags</span>
<a name="line-174"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_a</span><span class='hs-layout'>)</span>
<a name="line-175"></a>      <span class='hs-varid'>args2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-176"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-177"></a>  <span class='hs-conid'>Exception</span><span class='hs-varop'>.</span><span class='hs-varid'>catch</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-178"></a>        <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Clang (Assembler)"</span> <span class='hs-varid'>clang</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-179"></a>    <span class='hs-layout'>)</span>
<a name="line-180"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-181"></a>        <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-182"></a>            <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-str'>"Error running clang! you need clang installed to use the"</span> <span class='hs-varop'>++</span>
<a name="line-183"></a>                <span class='hs-str'>"LLVM backend"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$+$</span>
<a name="line-184"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"(or GHC tried to execute clang incorrectly)"</span>
<a name="line-185"></a>        <span class='hs-varid'>throwIO</span> <span class='hs-varid'>err</span>
<a name="line-186"></a>    <span class='hs-layout'>)</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="figureLlvmVersion"></a><span class='hs-comment'>-- | Figure out which version of LLVM we are running this session</span>
<a name="line-189"></a><span class='hs-definition'>figureLlvmVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-190"></a><span class='hs-definition'>figureLlvmVersion</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-191"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pgm</span><span class='hs-layout'>,</span><span class='hs-varid'>opts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_lc</span> <span class='hs-varid'>dflags</span>
<a name="line-192"></a>      <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>opts</span><span class='hs-layout'>)</span>
<a name="line-193"></a>      <span class='hs-comment'>-- we grab the args even though they should be useless just in</span>
<a name="line-194"></a>      <span class='hs-comment'>-- case the user is using a customised 'llc' that requires some</span>
<a name="line-195"></a>      <span class='hs-comment'>-- of the options they've specified. llc doesn't care what other</span>
<a name="line-196"></a>      <span class='hs-comment'>-- options are specified when '-version' is used.</span>
<a name="line-197"></a>      <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-version"</span><span class='hs-keyglyph'>]</span>
<a name="line-198"></a>  <span class='hs-varid'>ver</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-199"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>pin</span><span class='hs-layout'>,</span> <span class='hs-varid'>pout</span><span class='hs-layout'>,</span> <span class='hs-varid'>perr</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runInteractiveProcess</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args'</span>
<a name="line-200"></a>                                             <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span>
<a name="line-201"></a>             <span class='hs-comment'>{- &gt; llc -version
<a name="line-202"></a>                  Low Level Virtual Machine (<a href="http://llvm.org/):">http://llvm.org/):</a>
<a name="line-203"></a>                    llvm version 2.8 (Ubuntu 2.8-0Ubuntu1)
<a name="line-204"></a>                    ...
<a name="line-205"></a>             -}</span>
<a name="line-206"></a>             <span class='hs-varid'>hSetBinaryMode</span> <span class='hs-varid'>pout</span> <span class='hs-conid'>False</span>
<a name="line-207"></a>             <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetLine</span> <span class='hs-varid'>pout</span>
<a name="line-208"></a>             <span class='hs-varid'>vline</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetLine</span> <span class='hs-varid'>pout</span>
<a name="line-209"></a>             <span class='hs-varid'>v</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isDigit</span> <span class='hs-varid'>vline</span> <span class='hs-keyword'>of</span>
<a name="line-210"></a>                            <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"no digits!"</span>
<a name="line-211"></a>                            <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"only 1 digit! ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span>
<a name="line-212"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>read</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-213"></a>             <span class='hs-varid'>hClose</span> <span class='hs-varid'>pin</span>
<a name="line-214"></a>             <span class='hs-varid'>hClose</span> <span class='hs-varid'>pout</span>
<a name="line-215"></a>             <span class='hs-varid'>hClose</span> <span class='hs-varid'>perr</span>
<a name="line-216"></a>             <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>
<a name="line-217"></a>            <span class='hs-layout'>)</span>
<a name="line-218"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-219"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-220"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out LLVM version):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-221"></a>                     <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-222"></a>                <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-223"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-224"></a>                          <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out LLVM version!"</span> <span class='hs-varop'>$$</span>
<a name="line-225"></a>                          <span class='hs-varid'>text</span> <span class='hs-str'>"Make sure you have installed LLVM"</span><span class='hs-keyglyph'>]</span>
<a name="line-226"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-227"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>ver</span>
<a name="line-228"></a>
<a name="line-229"></a><span class='hs-comment'>{- Note [Windows stack usage]
<a name="line-230"></a>
<a name="line-231"></a>See: Trac #8870 (and #8834 for related info)
<a name="line-232"></a>
<a name="line-233"></a>On Windows, occasionally we need to grow the stack. In order to do
<a name="line-234"></a>this, we would normally just bump the stack pointer - but there's a
<a name="line-235"></a>catch on Windows.
<a name="line-236"></a>
<a name="line-237"></a>If the stack pointer is bumped by more than a single page, then the
<a name="line-238"></a>pages between the initial pointer and the resulting location must be
<a name="line-239"></a>properly committed by the Windows virtual memory subsystem. This is
<a name="line-240"></a>only needed in the event we bump by more than one page (i.e 4097 bytes
<a name="line-241"></a>or more).
<a name="line-242"></a>
<a name="line-243"></a>Windows compilers solve this by emitting a call to a special function
<a name="line-244"></a>called _chkstk, which does this committing of the pages for you.
<a name="line-245"></a>
<a name="line-246"></a>The reason this was causing a segfault was because due to the fact the
<a name="line-247"></a>new code generator tends to generate larger functions, we needed more
<a name="line-248"></a>stack space in GHC itself. In the x86 codegen, we needed approximately
<a name="line-249"></a>~12kb of stack space in one go, which caused the process to segfault,
<a name="line-250"></a>as the intervening pages were not committed.
<a name="line-251"></a>
<a name="line-252"></a>In the future, we should do the same thing, to make the problem
<a name="line-253"></a>completely go away. In the mean time, we're using a workaround: we
<a name="line-254"></a>instruct the linker to specify the generated PE as having an initial
<a name="line-255"></a>reserved stack size of 8mb, as well as a initial *committed* stack
<a name="line-256"></a>size of 8mb. The default committed size was previously only 4k.
<a name="line-257"></a>
<a name="line-258"></a>Theoretically it's possible to still hit this problem if you request a
<a name="line-259"></a>stack bump of more than 8mb in one go. But the amount of code
<a name="line-260"></a>necessary is quite large, and 8mb "should be more than enough for
<a name="line-261"></a>anyone" right now (he said, before millions of lines of code cried out
<a name="line-262"></a>in terror).
<a name="line-263"></a>
<a name="line-264"></a>-}</span>
<a name="line-265"></a>
<a name="line-266"></a><span class='hs-comment'>{- Note [Run-time linker info]
<a name="line-267"></a>
<a name="line-268"></a>See also: Trac #5240, Trac #6063
<a name="line-269"></a>
<a name="line-270"></a>Before 'runLink', we need to be sure to get the relevant information
<a name="line-271"></a>about the linker we're using at runtime to see if we need any extra
<a name="line-272"></a>options. For example, GNU ld requires '--reduce-memory-overheads' and
<a name="line-273"></a>'--hash-size=31' in order to use reasonable amounts of memory (see
<a name="line-274"></a>trac #5240.) But this isn't supported in GNU gold.
<a name="line-275"></a>
<a name="line-276"></a>Generally, the linker changing from what was detected at ./configure
<a name="line-277"></a>time has always been possible using -pgml, but on Linux it can happen
<a name="line-278"></a>'transparently' by installing packages like binutils-gold, which
<a name="line-279"></a>change what /usr/bin/ld actually points to.
<a name="line-280"></a>
<a name="line-281"></a>Clang vs GCC notes:
<a name="line-282"></a>
<a name="line-283"></a>For gcc, 'gcc -Wl,--version' gives a bunch of output about how to
<a name="line-284"></a>invoke the linker before the version information string. For 'clang',
<a name="line-285"></a>the version information for 'ld' is all that's output. For this
<a name="line-286"></a>reason, we typically need to slurp up all of the standard error output
<a name="line-287"></a>and look through it.
<a name="line-288"></a>
<a name="line-289"></a>Other notes:
<a name="line-290"></a>
<a name="line-291"></a>We cache the LinkerInfo inside DynFlags, since clients may link
<a name="line-292"></a>multiple times. The definition of LinkerInfo is there to avoid a
<a name="line-293"></a>circular dependency.
<a name="line-294"></a>
<a name="line-295"></a>-}</span>
<a name="line-296"></a>
<a name="line-297"></a>
<a name="line-298"></a><a name="neededLinkArgs"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LinkerInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-299"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-300"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuGold</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-301"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>DarwinLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-302"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>SolarisLD</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span>
<a name="line-303"></a><span class='hs-definition'>neededLinkArgs</span> <span class='hs-conid'>UnknownLD</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="getLinkerInfo"></a><span class='hs-comment'>-- Grab linker info and cache it in DynFlags.</span>
<a name="line-306"></a><span class='hs-definition'>getLinkerInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>LinkerInfo</span>
<a name="line-307"></a><span class='hs-definition'>getLinkerInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-308"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtldInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-309"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-310"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-311"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-312"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLinkerInfo'</span> <span class='hs-varid'>dflags</span>
<a name="line-313"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtldInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-314"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-315"></a>
<a name="line-316"></a><a name="getLinkerInfo'"></a><span class='hs-comment'>-- See Note [Run-time linker info].</span>
<a name="line-317"></a><span class='hs-definition'>getLinkerInfo'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>LinkerInfo</span>
<a name="line-318"></a><span class='hs-definition'>getLinkerInfo'</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-319"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-320"></a>      <span class='hs-varid'>os</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span>
<a name="line-321"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>pgm</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_l</span> <span class='hs-varid'>dflags</span>
<a name="line-322"></a>
<a name="line-323"></a>      <span class='hs-comment'>-- Try to grab the info from the process output.</span>
<a name="line-324"></a>      <span class='hs-varid'>parseLinkerInfo</span> <span class='hs-varid'>stdo</span> <span class='hs-sel'>_stde</span> <span class='hs-sel'>_exitc</span>
<a name="line-325"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"GNU ld"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stdo</span> <span class='hs-keyglyph'>=</span>
<a name="line-326"></a>          <span class='hs-comment'>-- GNU ld specifically needs to use less memory. This especially</span>
<a name="line-327"></a>          <span class='hs-comment'>-- hurts on small object files. Trac #5240.</span>
<a name="line-328"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuLD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,--hash-size=31"</span><span class='hs-layout'>,</span>
<a name="line-329"></a>                                      <span class='hs-str'>"-Wl,--reduce-memory-overheads"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-330"></a>
<a name="line-331"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"GNU gold"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stdo</span> <span class='hs-keyglyph'>=</span>
<a name="line-332"></a>          <span class='hs-comment'>-- GNU gold does not require any special arguments.</span>
<a name="line-333"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GnuGold</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-334"></a>
<a name="line-335"></a>         <span class='hs-comment'>-- Unknown linker.</span>
<a name="line-336"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"invalid --version output, or linker is unsupported"</span>
<a name="line-337"></a>
<a name="line-338"></a>  <span class='hs-comment'>-- Process the executable call</span>
<a name="line-339"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-340"></a>             <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-341"></a>               <span class='hs-conid'>OSSolaris2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-342"></a>                 <span class='hs-comment'>-- Solaris uses its own Solaris linker. Even all</span>
<a name="line-343"></a>                 <span class='hs-comment'>-- GNU C are recommended to configure with Solaris</span>
<a name="line-344"></a>                 <span class='hs-comment'>-- linker instead of using GNU binutils linker. Also</span>
<a name="line-345"></a>                 <span class='hs-comment'>-- all GCC distributed with Solaris follows this rule</span>
<a name="line-346"></a>                 <span class='hs-comment'>-- precisely so we assume here, the Solaris linker is</span>
<a name="line-347"></a>                 <span class='hs-comment'>-- used.</span>
<a name="line-348"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SolarisLD</span> <span class='hs-conid'>[]</span>
<a name="line-349"></a>               <span class='hs-conid'>OSDarwin</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-350"></a>                 <span class='hs-comment'>-- Darwin has neither GNU Gold or GNU LD, but a strange linker</span>
<a name="line-351"></a>                 <span class='hs-comment'>-- that doesn't support --version. We can just assume that's</span>
<a name="line-352"></a>                 <span class='hs-comment'>-- what we're using.</span>
<a name="line-353"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DarwinLD</span> <span class='hs-conid'>[]</span>
<a name="line-354"></a>               <span class='hs-conid'>OSiOS</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-355"></a>                 <span class='hs-comment'>-- Ditto for iOS</span>
<a name="line-356"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DarwinLD</span> <span class='hs-conid'>[]</span>
<a name="line-357"></a>               <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-358"></a>                 <span class='hs-comment'>-- GHC doesn't support anything but GNU ld on Windows anyway.</span>
<a name="line-359"></a>                 <span class='hs-comment'>-- Process creation is also fairly expensive on win32, so</span>
<a name="line-360"></a>                 <span class='hs-comment'>-- we short-circuit here.</span>
<a name="line-361"></a>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GnuLD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span>
<a name="line-362"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- Reduce ld memory usage</span>
<a name="line-363"></a>                     <span class='hs-str'>"-Wl,--hash-size=31"</span>
<a name="line-364"></a>                   <span class='hs-layout'>,</span> <span class='hs-str'>"-Wl,--reduce-memory-overheads"</span>
<a name="line-365"></a>                     <span class='hs-comment'>-- Increase default stack, see</span>
<a name="line-366"></a>                     <span class='hs-comment'>-- Note [Windows stack usage]</span>
<a name="line-367"></a>                   <span class='hs-layout'>,</span> <span class='hs-str'>"-Xlinker"</span><span class='hs-layout'>,</span> <span class='hs-str'>"--stack=0x800000,0x800000"</span> <span class='hs-keyglyph'>]</span>
<a name="line-368"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-369"></a>                 <span class='hs-comment'>-- In practice, we use the compiler as the linker here. Pass</span>
<a name="line-370"></a>                 <span class='hs-comment'>-- -Wl,--version to get linker version info.</span>
<a name="line-371"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>exitc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readProcessWithExitCode</span> <span class='hs-varid'>pgm</span>
<a name="line-372"></a>                                        <span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,--version"</span><span class='hs-keyglyph'>]</span> <span class='hs-str'>""</span>
<a name="line-373"></a>                 <span class='hs-comment'>-- Split the output by lines to make certain kinds</span>
<a name="line-374"></a>                 <span class='hs-comment'>-- of processing easier. In particular, 'clang' and 'gcc'</span>
<a name="line-375"></a>                 <span class='hs-comment'>-- have slightly different outputs for '-Wl,--version', but</span>
<a name="line-376"></a>                 <span class='hs-comment'>-- it's still easy to figure out.</span>
<a name="line-377"></a>                 <span class='hs-varid'>parseLinkerInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-varid'>exitc</span>
<a name="line-378"></a>            <span class='hs-layout'>)</span>
<a name="line-379"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-380"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-381"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out linker information):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-382"></a>                     <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-383"></a>                <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>)</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-384"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out linker information!"</span> <span class='hs-varop'>$$</span>
<a name="line-385"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Make sure you're using GNU ld, GNU gold"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-386"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"or the built in OS X linker, etc."</span>
<a name="line-387"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>UnknownLD</span><span class='hs-layout'>)</span>
<a name="line-388"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>info</span>
<a name="line-389"></a>
<a name="line-390"></a><a name="getCompilerInfo"></a><span class='hs-comment'>-- Grab compiler info and cache it in DynFlags.</span>
<a name="line-391"></a><span class='hs-definition'>getCompilerInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CompilerInfo</span>
<a name="line-392"></a><span class='hs-definition'>getCompilerInfo</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-393"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtccInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-394"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-395"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-396"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-397"></a>      <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCompilerInfo'</span> <span class='hs-varid'>dflags</span>
<a name="line-398"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtccInfo</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-399"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-400"></a>
<a name="line-401"></a><a name="getCompilerInfo'"></a><span class='hs-comment'>-- See Note [Run-time linker info].</span>
<a name="line-402"></a><span class='hs-definition'>getCompilerInfo'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CompilerInfo</span>
<a name="line-403"></a><span class='hs-definition'>getCompilerInfo'</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-404"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pgm</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-405"></a>      <span class='hs-comment'>-- Try to grab the info from the process output.</span>
<a name="line-406"></a>      <span class='hs-varid'>parseCompilerInfo</span> <span class='hs-sel'>_stdo</span> <span class='hs-varid'>stde</span> <span class='hs-sel'>_exitc</span>
<a name="line-407"></a>        <span class='hs-comment'>-- Regular GCC</span>
<a name="line-408"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"gcc version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-409"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>GCC</span>
<a name="line-410"></a>        <span class='hs-comment'>-- Regular clang</span>
<a name="line-411"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"clang version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-412"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>Clang</span>
<a name="line-413"></a>        <span class='hs-comment'>-- XCode 5.1 clang</span>
<a name="line-414"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple LLVM version 5.1"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-415"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang51</span>
<a name="line-416"></a>        <span class='hs-comment'>-- XCode 5 clang</span>
<a name="line-417"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple LLVM version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-418"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang</span>
<a name="line-419"></a>        <span class='hs-comment'>-- XCode 4.1 clang</span>
<a name="line-420"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-str'>"Apple clang version"</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span> <span class='hs-varid'>stde</span> <span class='hs-keyglyph'>=</span>
<a name="line-421"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>AppleClang</span>
<a name="line-422"></a>         <span class='hs-comment'>-- Unknown linker.</span>
<a name="line-423"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail</span> <span class='hs-str'>"invalid -v output, or compiler is unsupported"</span>
<a name="line-424"></a>
<a name="line-425"></a>  <span class='hs-comment'>-- Process the executable call</span>
<a name="line-426"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catchIO</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-427"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>exitc</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>,</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readProcessWithExitCode</span> <span class='hs-varid'>pgm</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-v"</span><span class='hs-keyglyph'>]</span> <span class='hs-str'>""</span>
<a name="line-428"></a>                <span class='hs-comment'>-- Split the output by lines to make certain kinds</span>
<a name="line-429"></a>                <span class='hs-comment'>-- of processing easier.</span>
<a name="line-430"></a>                <span class='hs-varid'>parseCompilerInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stdo</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>stde</span><span class='hs-layout'>)</span> <span class='hs-varid'>exitc</span>
<a name="line-431"></a>            <span class='hs-layout'>)</span>
<a name="line-432"></a>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-433"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span>
<a name="line-434"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Error (figuring out compiler information):"</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-435"></a>                     <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-436"></a>                <span class='hs-varid'>errorMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Warning:"</span><span class='hs-layout'>)</span> <span class='hs-num'>9</span> <span class='hs-varop'>$</span>
<a name="line-437"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Couldn't figure out linker information!"</span> <span class='hs-varop'>$$</span>
<a name="line-438"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"Make sure you're using GNU gcc, or clang"</span>
<a name="line-439"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>UnknownCC</span><span class='hs-layout'>)</span>
<a name="line-440"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>info</span>
<a name="line-441"></a>
<a name="line-442"></a><a name="runLink"></a><span class='hs-definition'>runLink</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-443"></a><span class='hs-definition'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-444"></a>  <span class='hs-comment'>-- See Note [Run-time linker info]</span>
<a name="line-445"></a>  <span class='hs-varid'>linkargs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>neededLinkArgs</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>getLinkerInfo</span> <span class='hs-varid'>dflags</span>
<a name="line-446"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_l</span> <span class='hs-varid'>dflags</span>
<a name="line-447"></a>      <span class='hs-varid'>args1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span><span class='hs-layout'>)</span>
<a name="line-448"></a>      <span class='hs-varid'>args2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>linkargs</span>
<a name="line-449"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-450"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Linker"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="runLibtool"></a><span class='hs-definition'>runLibtool</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-453"></a><span class='hs-definition'>runLibtool</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-454"></a>  <span class='hs-varid'>linkargs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>neededLinkArgs</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>getLinkerInfo</span> <span class='hs-varid'>dflags</span>
<a name="line-455"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>args1</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_l</span><span class='hs-layout'>)</span>
<a name="line-456"></a>      <span class='hs-varid'>args2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-static"</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>linkargs</span>
<a name="line-457"></a>      <span class='hs-varid'>libtool</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_libtool</span> <span class='hs-varid'>dflags</span>    
<a name="line-458"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>args2</span>
<a name="line-459"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Linker"</span> <span class='hs-varid'>libtool</span> <span class='hs-varid'>args2</span> <span class='hs-varid'>mb_env</span>
<a name="line-460"></a>
<a name="line-461"></a><a name="runMkDLL"></a><span class='hs-definition'>runMkDLL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-462"></a><span class='hs-definition'>runMkDLL</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-463"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>args0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_dll</span> <span class='hs-varid'>dflags</span>
<a name="line-464"></a>      <span class='hs-varid'>args1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span>
<a name="line-465"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>args0</span><span class='hs-varop'>++</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-466"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Make DLL"</span> <span class='hs-varid'>p</span> <span class='hs-varid'>args1</span> <span class='hs-varid'>mb_env</span>
<a name="line-467"></a>
<a name="line-468"></a><a name="runWindres"></a><span class='hs-definition'>runWindres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-469"></a><span class='hs-definition'>runWindres</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-470"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcc</span><span class='hs-layout'>,</span> <span class='hs-varid'>gcc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_c</span> <span class='hs-varid'>dflags</span>
<a name="line-471"></a>      <span class='hs-varid'>windres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pgm_windres</span> <span class='hs-varid'>dflags</span>
<a name="line-472"></a>      <span class='hs-varid'>opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>opt_windres</span><span class='hs-layout'>)</span>
<a name="line-473"></a>      <span class='hs-varid'>quote</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"\""</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\""</span>
<a name="line-474"></a>      <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- If windres.exe and gcc.exe are in a directory containing</span>
<a name="line-475"></a>              <span class='hs-comment'>-- spaces then windres fails to run gcc. We therefore need</span>
<a name="line-476"></a>              <span class='hs-comment'>-- to tell it what command to use...</span>
<a name="line-477"></a>              <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-str'>"--preprocessor="</span> <span class='hs-varop'>++</span>
<a name="line-478"></a>                      <span class='hs-varid'>unwords</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>quote</span> <span class='hs-layout'>(</span><span class='hs-varid'>gcc</span> <span class='hs-conop'>:</span>
<a name="line-479"></a>                                          <span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>gcc_args</span> <span class='hs-varop'>++</span>
<a name="line-480"></a>                                          <span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>opts</span> <span class='hs-varop'>++</span>
<a name="line-481"></a>                                          <span class='hs-keyglyph'>[</span><span class='hs-str'>"-E"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-xc"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-DRC_INVOKED"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-482"></a>              <span class='hs-comment'>-- ...but if we do that then if windres calls popen then</span>
<a name="line-483"></a>              <span class='hs-comment'>-- it can't understand the quoting, so we have to use</span>
<a name="line-484"></a>              <span class='hs-comment'>-- --use-temp-file so that it interprets it correctly.</span>
<a name="line-485"></a>              <span class='hs-comment'>-- See #1828.</span>
<a name="line-486"></a>            <span class='hs-conop'>:</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"--use-temp-file"</span>
<a name="line-487"></a>            <span class='hs-conop'>:</span> <span class='hs-varid'>args</span>
<a name="line-488"></a>  <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGccEnv</span> <span class='hs-varid'>gcc_args</span>
<a name="line-489"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-str'>"Windres"</span> <span class='hs-varid'>windres</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>mb_env</span>
<a name="line-490"></a>
<a name="line-491"></a><a name="touch"></a><span class='hs-definition'>touch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-492"></a><span class='hs-definition'>touch</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span>
<a name="line-493"></a>  <span class='hs-varid'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-layout'>(</span><span class='hs-varid'>pgm_T</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-494"></a>
<a name="line-495"></a><a name="copy"></a><span class='hs-definition'>copy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-496"></a><span class='hs-definition'>copy</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>copyWithHeader</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span>
<a name="line-497"></a>
<a name="line-498"></a><a name="copyWithHeader"></a><span class='hs-definition'>copyWithHeader</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-499"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-500"></a><span class='hs-definition'>copyWithHeader</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span> <span class='hs-varid'>maybe_header</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-501"></a>  <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>purpose</span>
<a name="line-502"></a>
<a name="line-503"></a>  <span class='hs-varid'>hout</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openBinaryFile</span> <span class='hs-varid'>to</span>   <span class='hs-conid'>WriteMode</span>
<a name="line-504"></a>  <span class='hs-varid'>hin</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openBinaryFile</span> <span class='hs-varid'>from</span> <span class='hs-conid'>ReadMode</span>
<a name="line-505"></a>  <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetContents</span> <span class='hs-varid'>hin</span> <span class='hs-comment'>-- inefficient, but it'll do for now. ToDo: speed up</span>
<a name="line-506"></a>  <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>header</span> <span class='hs-varid'>hout</span><span class='hs-layout'>)</span> <span class='hs-varid'>maybe_header</span>
<a name="line-507"></a>  <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>hout</span> <span class='hs-varid'>ls</span>
<a name="line-508"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hout</span>
<a name="line-509"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hin</span>
<a name="line-510"></a> <span class='hs-keyword'>where</span>
<a name="line-511"></a>  <span class='hs-comment'>-- write the header string in UTF-8.  The header is something like</span>
<a name="line-512"></a>  <span class='hs-comment'>--   {-# LINE "foo.hs" #-}</span>
<a name="line-513"></a>  <span class='hs-comment'>-- and we want to make sure a Unicode filename isn't mangled.</span>
<a name="line-514"></a>  <span class='hs-varid'>header</span> <span class='hs-varid'>h</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-515"></a>   <span class='hs-varid'>hSetEncoding</span> <span class='hs-varid'>h</span> <span class='hs-varid'>utf8</span>
<a name="line-516"></a>   <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span> <span class='hs-varid'>str</span>
<a name="line-517"></a>   <span class='hs-varid'>hSetBinaryMode</span> <span class='hs-varid'>h</span> <span class='hs-conid'>True</span>
<a name="line-518"></a>
<a name="line-519"></a><a name="readElfSection"></a><span class='hs-comment'>-- | read the contents of the named section in an ELF object as a</span>
<a name="line-520"></a><span class='hs-comment'>-- String.</span>
<a name="line-521"></a><span class='hs-definition'>readElfSection</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-522"></a><span class='hs-definition'>readElfSection</span> <span class='hs-sel'>_dflags</span> <span class='hs-varid'>section</span> <span class='hs-varid'>exe</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-523"></a>  <span class='hs-keyword'>let</span>
<a name="line-524"></a>     <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"readelf"</span>
<a name="line-525"></a>     <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-p"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>section</span><span class='hs-layout'>,</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>exe</span><span class='hs-keyglyph'>]</span>
<a name="line-526"></a>  <span class='hs-comment'>--</span>
<a name="line-527"></a>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readProcessWithExitCode</span> <span class='hs-varid'>prog</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-str'>""</span>
<a name="line-528"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-529"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>,</span> <span class='hs-varid'>out</span><span class='hs-layout'>,</span> <span class='hs-sel'>_err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>doFilter</span> <span class='hs-layout'>(</span><span class='hs-varid'>lines</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-530"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-531"></a> <span class='hs-keyword'>where</span>
<a name="line-532"></a>  <span class='hs-varid'>doFilter</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-533"></a>  <span class='hs-varid'>doFilter</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>readP_to_S</span> <span class='hs-varid'>parse</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-534"></a>                    <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p</span>
<a name="line-535"></a>                    <span class='hs-sel'>_r</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>doFilter</span> <span class='hs-varid'>r</span>
<a name="line-536"></a>   <span class='hs-keyword'>where</span> <span class='hs-varid'>parse</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-537"></a>           <span class='hs-varid'>skipSpaces</span>
<a name="line-538"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>R</span><span class='hs-varop'>.</span><span class='hs-varid'>char</span> <span class='hs-chr'>'['</span>
<a name="line-539"></a>           <span class='hs-varid'>skipSpaces</span>
<a name="line-540"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>string</span> <span class='hs-str'>"0]"</span>
<a name="line-541"></a>           <span class='hs-varid'>skipSpaces</span>
<a name="line-542"></a>           <span class='hs-varid'>munch</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Managing temporary files
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="cleanTempDirs"></a><span class='hs-definition'>cleanTempDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>cleanTempDirs</span> <span class='hs-varid'>dflags</span>
<a name="line-3"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepTmpFiles</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-4"></a>   <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span>
<a name="line-5"></a>   <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dirsToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-6"></a>        <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-7"></a>        <span class='hs-varid'>removeTmpDirs</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="cleanTempFiles"></a><span class='hs-definition'>cleanTempFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-10"></a><span class='hs-definition'>cleanTempFiles</span> <span class='hs-varid'>dflags</span>
<a name="line-11"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepTmpFiles</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-12"></a>   <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span>
<a name="line-13"></a>   <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-14"></a>        <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>fs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-15"></a>        <span class='hs-varid'>removeTmpFiles</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fs</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="cleanTempFilesExcept"></a><span class='hs-definition'>cleanTempFilesExcept</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-18"></a><span class='hs-definition'>cleanTempFilesExcept</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dont_delete</span>
<a name="line-19"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_KeepTmpFiles</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-20"></a>   <span class='hs-varop'>$</span> <span class='hs-varid'>mask_</span>
<a name="line-21"></a>   <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-22"></a>        <span class='hs-varid'>to_delete</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>files</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-23"></a>            <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_keep</span><span class='hs-layout'>,</span><span class='hs-varid'>to_delete</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>dont_delete</span><span class='hs-layout'>)</span> <span class='hs-varid'>files</span>
<a name="line-24"></a>            <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>to_keep</span><span class='hs-layout'>,</span><span class='hs-varid'>to_delete</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-varid'>removeTmpFiles</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>to_delete</span>
<a name="line-26"></a>
<a name="line-27"></a>
<a name="line-28"></a><a name="newTempSuffix"></a><span class='hs-comment'>-- Return a unique numeric temp file suffix</span>
<a name="line-29"></a><span class='hs-definition'>newTempSuffix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span>
<a name="line-30"></a><span class='hs-definition'>newTempSuffix</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>nextTempSuffix</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="newTempName"></a><span class='hs-comment'>-- Find a temporary name that doesn't already exist.</span>
<a name="line-33"></a><span class='hs-definition'>newTempName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Suffix</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-34"></a><span class='hs-definition'>newTempName</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>extn</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTempDir</span> <span class='hs-varid'>dflags</span>
<a name="line-36"></a>       <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProcessID</span>
<a name="line-37"></a>       <span class='hs-varid'>findTempName</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"ghc"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span>
<a name="line-38"></a>  <span class='hs-keyword'>where</span>
<a name="line-39"></a>    <span class='hs-varid'>findTempName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-40"></a>    <span class='hs-varid'>findTempName</span> <span class='hs-varid'>prefix</span>
<a name="line-41"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempSuffix</span> <span class='hs-varid'>dflags</span>
<a name="line-42"></a>           <span class='hs-keyword'>let</span> <span class='hs-varid'>filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefix</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>extn</span>
<a name="line-43"></a>           <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>filename</span>
<a name="line-44"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>findTempName</span> <span class='hs-varid'>prefix</span>
<a name="line-45"></a>                <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- clean it up later</span>
<a name="line-46"></a>                        <span class='hs-varid'>consIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>filename</span>
<a name="line-47"></a>                        <span class='hs-varid'>return</span> <span class='hs-varid'>filename</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="getTempDir"></a><span class='hs-comment'>-- Return our temporary directory within tmp_dir, creating one if we</span>
<a name="line-50"></a><span class='hs-comment'>-- don't have one yet.</span>
<a name="line-51"></a><span class='hs-definition'>getTempDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-52"></a><span class='hs-definition'>getTempDir</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-53"></a>    <span class='hs-varid'>mapping</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>dir_ref</span>
<a name="line-54"></a>    <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varid'>mapping</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-56"></a>            <span class='hs-varid'>pid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProcessID</span>
<a name="line-57"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>prefix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"ghc"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>pid</span> <span class='hs-varop'>++</span> <span class='hs-str'>"_"</span>
<a name="line-58"></a>            <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTempDir</span> <span class='hs-varid'>prefix</span>
<a name="line-59"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>dir</span>
<a name="line-60"></a>  <span class='hs-keyword'>where</span>
<a name="line-61"></a>    <span class='hs-varid'>tmp_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>dflags</span>
<a name="line-62"></a>    <span class='hs-varid'>dir_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dirsToClean</span> <span class='hs-varid'>dflags</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-varid'>mkTempDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-65"></a>    <span class='hs-varid'>mkTempDir</span> <span class='hs-varid'>prefix</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-66"></a>        <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTempSuffix</span> <span class='hs-varid'>dflags</span>
<a name="line-67"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>our_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prefix</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-comment'>-- 1. Speculatively create our new directory.</span>
<a name="line-70"></a>        <span class='hs-varid'>createDirectory</span> <span class='hs-varid'>our_dir</span>
<a name="line-71"></a>
<a name="line-72"></a>        <span class='hs-comment'>-- 2. Update the dirsToClean mapping unless an entry already exists</span>
<a name="line-73"></a>        <span class='hs-comment'>-- (i.e. unless another thread beat us to it).</span>
<a name="line-74"></a>        <span class='hs-varid'>their_dir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>dir_ref</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mapping</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-75"></a>            <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varid'>mapping</span> <span class='hs-keyword'>of</span>
<a name="line-76"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapping</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span><span class='hs-layout'>)</span>
<a name="line-77"></a>                <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>tmp_dir</span> <span class='hs-varid'>our_dir</span> <span class='hs-varid'>mapping</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-comment'>-- 3. If there was an existing entry, return it and delete the</span>
<a name="line-80"></a>        <span class='hs-comment'>-- directory we created.  Otherwise return the directory we created.</span>
<a name="line-81"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>their_dir</span> <span class='hs-keyword'>of</span>
<a name="line-82"></a>            <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-83"></a>                <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span>
<a name="line-84"></a>                    <span class='hs-varid'>text</span> <span class='hs-str'>"Created temporary directory:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>our_dir</span>
<a name="line-85"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>our_dir</span>
<a name="line-86"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-87"></a>                <span class='hs-varid'>removeDirectory</span> <span class='hs-varid'>our_dir</span>
<a name="line-88"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>dir</span>
<a name="line-89"></a>      <span class='hs-varop'>`catchIO`</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isAlreadyExistsError</span> <span class='hs-varid'>e</span>
<a name="line-90"></a>                      <span class='hs-keyword'>then</span> <span class='hs-varid'>mkTempDir</span> <span class='hs-varid'>prefix</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>ioError</span> <span class='hs-varid'>e</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="addFilesToClean"></a><span class='hs-definition'>addFilesToClean</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-93"></a><span class='hs-comment'>-- May include wildcards [used by DriverPipeline.run_phase SplitMangle]</span>
<a name="line-94"></a><span class='hs-definition'>addFilesToClean</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>new_files</span>
<a name="line-95"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>filesToClean</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>files</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_files</span><span class='hs-varop'>++</span><span class='hs-varid'>files</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="removeTmpDirs"></a><span class='hs-definition'>removeTmpDirs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-98"></a><span class='hs-definition'>removeTmpDirs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ds</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Deleting temp dirs"</span>
<a name="line-100"></a>             <span class='hs-layout'>(</span><span class='hs-str'>"Deleting: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unwords</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-101"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>removeDirectory</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="removeTmpFiles"></a><span class='hs-definition'>removeTmpFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-104"></a><span class='hs-definition'>removeTmpFiles</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fs</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnNon</span> <span class='hs-varop'>$</span>
<a name="line-106"></a>    <span class='hs-varid'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"Deleting temp files"</span>
<a name="line-107"></a>             <span class='hs-layout'>(</span><span class='hs-str'>"Deleting: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unwords</span> <span class='hs-varid'>deletees</span><span class='hs-layout'>)</span>
<a name="line-108"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>removeFile</span><span class='hs-layout'>)</span> <span class='hs-varid'>deletees</span><span class='hs-layout'>)</span>
<a name="line-109"></a>  <span class='hs-keyword'>where</span>
<a name="line-110"></a>     <span class='hs-comment'>-- Flat out refuse to delete files that are likely to be source input</span>
<a name="line-111"></a>     <span class='hs-comment'>-- files (is there a worse bug than having a compiler delete your source</span>
<a name="line-112"></a>     <span class='hs-comment'>-- files?)</span>
<a name="line-113"></a>     <span class='hs-comment'>--</span>
<a name="line-114"></a>     <span class='hs-comment'>-- Deleting source files is a sign of a bug elsewhere, so prominently flag</span>
<a name="line-115"></a>     <span class='hs-comment'>-- the condition.</span>
<a name="line-116"></a>    <span class='hs-varid'>warnNon</span> <span class='hs-varid'>act</span>
<a name="line-117"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>non_deletees</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span>
<a name="line-118"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-119"></a>        <span class='hs-varid'>putMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"WARNING - NOT deleting source files:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>text</span> <span class='hs-varid'>non_deletees</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-120"></a>        <span class='hs-varid'>act</span>
<a name="line-121"></a>
<a name="line-122"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>non_deletees</span><span class='hs-layout'>,</span> <span class='hs-varid'>deletees</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isHaskellUserSrcFilename</span> <span class='hs-varid'>fs</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="removeWith"></a><span class='hs-definition'>removeWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-125"></a><span class='hs-definition'>removeWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>remover</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>remover</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`catchIO`</span>
<a name="line-126"></a>  <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-127"></a>   <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>e</span>
<a name="line-128"></a>             <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Warning: deleting non-existent"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>f</span>
<a name="line-129"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Warning: exception raised when deleting"</span><span class='hs-layout'>)</span>
<a name="line-130"></a>                                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-131"></a>               <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-132"></a>   <span class='hs-keyword'>in</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-varid'>msg</span>
<a name="line-133"></a>  <span class='hs-layout'>)</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-136"></a><span class='hs-comment'>-- Running an external program</span>
<a name="line-137"></a>
<a name="line-138"></a><a name="runSomething"></a><span class='hs-definition'>runSomething</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-139"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>          <span class='hs-comment'>-- For -v message</span>
<a name="line-140"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>          <span class='hs-comment'>-- Command name (possibly a full path)</span>
<a name="line-141"></a>                                <span class='hs-comment'>--      assumed already dos-ified</span>
<a name="line-142"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Arguments</span>
<a name="line-143"></a>                                <span class='hs-comment'>--      runSomething will dos-ify them</span>
<a name="line-144"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-145"></a>
<a name="line-146"></a><span class='hs-definition'>runSomething</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>
<a name="line-147"></a>  <span class='hs-varid'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-conid'>Nothing</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="runSomethingFiltered"></a><span class='hs-definition'>runSomethingFiltered</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-151"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-152"></a>
<a name="line-153"></a><span class='hs-definition'>runSomethingFiltered</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-154"></a>    <span class='hs-varid'>runSomethingWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>real_args</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-155"></a>        <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>builderMainLoop</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span> <span class='hs-varid'>mb_env</span>
<a name="line-156"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="runSomethingWith"></a><span class='hs-definition'>runSomethingWith</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span><span class='hs-keyglyph'>]</span>
<a name="line-160"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-162"></a>
<a name="line-163"></a><span class='hs-definition'>runSomethingWith</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>args</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-164"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>real_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>notNull</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>showOpt</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-165"></a>      <span class='hs-varid'>cmdLine</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showCommandForUser</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span>
<a name="line-166"></a>  <span class='hs-varid'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>cmdLine</span> <span class='hs-varop'>$</span> <span class='hs-varid'>handleProc</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>phase_name</span> <span class='hs-varop'>$</span> <span class='hs-varid'>io</span> <span class='hs-varid'>real_args</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="handleProc"></a><span class='hs-definition'>handleProc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>r</span>
<a name="line-169"></a><span class='hs-definition'>handleProc</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>proc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-170"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>rc</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>proc</span> <span class='hs-varop'>`catchIO`</span> <span class='hs-varid'>handler</span>
<a name="line-171"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>rc</span> <span class='hs-keyword'>of</span>
<a name="line-172"></a>      <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-173"></a>      <span class='hs-conid'>ExitFailure</span> <span class='hs-varid'>n</span>
<a name="line-174"></a>        <span class='hs-comment'>-- rawSystem returns (ExitFailure 127) if the exec failed for any</span>
<a name="line-175"></a>        <span class='hs-comment'>-- reason (eg. the program doesn't exist).  This is the only clue</span>
<a name="line-176"></a>        <span class='hs-comment'>-- we have, but we need to report something to the user because in</span>
<a name="line-177"></a>        <span class='hs-comment'>-- the case of a missing program there will otherwise be no output</span>
<a name="line-178"></a>        <span class='hs-comment'>-- at all.</span>
<a name="line-179"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>127</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>does_not_exist</span>
<a name="line-180"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhaseFailed</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>rc</span><span class='hs-layout'>)</span>
<a name="line-181"></a>  <span class='hs-keyword'>where</span>
<a name="line-182"></a>    <span class='hs-varid'>handler</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span>
<a name="line-183"></a>       <span class='hs-keyword'>if</span> <span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>err</span>
<a name="line-184"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>does_not_exist</span>
<a name="line-185"></a>          <span class='hs-keyword'>else</span> <span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-varid'>ioError</span> <span class='hs-varid'>err</span>
<a name="line-186"></a>
<a name="line-187"></a>    <span class='hs-varid'>does_not_exist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstallationError</span> <span class='hs-layout'>(</span><span class='hs-str'>"could not execute: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pgm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-188"></a>
<a name="line-189"></a>
<a name="line-190"></a><a name="builderMainLoop"></a><span class='hs-definition'>builderMainLoop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-191"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-192"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExitCode</span>
<a name="line-193"></a><span class='hs-definition'>builderMainLoop</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>filter_fn</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span> <span class='hs-varid'>mb_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-194"></a>  <span class='hs-varid'>chan</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newChan</span>
<a name="line-195"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>hStdIn</span><span class='hs-layout'>,</span> <span class='hs-varid'>hStdOut</span><span class='hs-layout'>,</span> <span class='hs-varid'>hStdErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>hProcess</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runInteractiveProcess</span> <span class='hs-varid'>pgm</span> <span class='hs-varid'>real_args</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>mb_env</span>
<a name="line-196"></a>
<a name="line-197"></a>  <span class='hs-comment'>-- and run a loop piping the output from the compiler to the log_action in DynFlags</span>
<a name="line-198"></a>  <span class='hs-varid'>hSetBuffering</span> <span class='hs-varid'>hStdOut</span> <span class='hs-conid'>LineBuffering</span>
<a name="line-199"></a>  <span class='hs-varid'>hSetBuffering</span> <span class='hs-varid'>hStdErr</span> <span class='hs-conid'>LineBuffering</span>
<a name="line-200"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>readerProc</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hStdOut</span> <span class='hs-varid'>filter_fn</span><span class='hs-layout'>)</span>
<a name="line-201"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>readerProc</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hStdErr</span> <span class='hs-varid'>filter_fn</span><span class='hs-layout'>)</span>
<a name="line-202"></a>  <span class='hs-comment'>-- we don't want to finish until 2 streams have been completed</span>
<a name="line-203"></a>  <span class='hs-comment'>-- (stdout and stderr)</span>
<a name="line-204"></a>  <span class='hs-comment'>-- nor until 1 exit code has been retrieved.</span>
<a name="line-205"></a>  <span class='hs-varid'>rc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Integer</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Integer</span><span class='hs-layout'>)</span> <span class='hs-conid'>ExitSuccess</span>
<a name="line-206"></a>  <span class='hs-comment'>-- after that, we're done here.</span>
<a name="line-207"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hStdIn</span>
<a name="line-208"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hStdOut</span>
<a name="line-209"></a>  <span class='hs-varid'>hClose</span> <span class='hs-varid'>hStdErr</span>
<a name="line-210"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>rc</span>
<a name="line-211"></a>  <span class='hs-keyword'>where</span>
<a name="line-212"></a>    <span class='hs-comment'>-- status starts at zero, and increments each time either</span>
<a name="line-213"></a>    <span class='hs-comment'>-- a reader process gets EOF, or the build proc exits.  We wait</span>
<a name="line-214"></a>    <span class='hs-comment'>-- for all of these to happen (status==3).</span>
<a name="line-215"></a>    <span class='hs-comment'>-- ToDo: we should really have a contingency plan in case any of</span>
<a name="line-216"></a>    <span class='hs-comment'>-- the threads dies, such as a timeout.</span>
<a name="line-217"></a>    <span class='hs-varid'>loop</span> <span class='hs-keyword'>_</span>    <span class='hs-keyword'>_</span>        <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>exitcode</span>
<a name="line-218"></a>    <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-219"></a>      <span class='hs-varid'>mb_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-220"></a>                   <span class='hs-keyword'>then</span> <span class='hs-varid'>getProcessExitCode</span> <span class='hs-varid'>hProcess</span>
<a name="line-221"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-222"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_code</span> <span class='hs-keyword'>of</span>
<a name="line-223"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>code</span>
<a name="line-224"></a>        <span class='hs-conid'>Nothing</span>
<a name="line-225"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-226"></a>              <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readChan</span> <span class='hs-varid'>chan</span>
<a name="line-227"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-228"></a>                <span class='hs-conid'>BuildMsg</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-229"></a>                  <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>SevInfo</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultUserStyle</span> <span class='hs-varid'>msg</span>
<a name="line-230"></a>                  <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-231"></a>                <span class='hs-conid'>BuildError</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-232"></a>                  <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>SevError</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>defaultUserStyle</span> <span class='hs-varid'>msg</span>
<a name="line-233"></a>                  <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-234"></a>                <span class='hs-conid'>EOF</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-235"></a>                  <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-236"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hProcess</span> <span class='hs-varid'>t</span> <span class='hs-varid'>p</span> <span class='hs-varid'>exitcode</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="readerProc"></a><span class='hs-definition'>readerProc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Chan</span> <span class='hs-conid'>BuildMessage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-239"></a><span class='hs-definition'>readerProc</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>hdl</span> <span class='hs-varid'>filter_fn</span> <span class='hs-keyglyph'>=</span>
<a name="line-240"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hGetContents</span> <span class='hs-varid'>hdl</span>
<a name="line-241"></a>        <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>linesPlatform</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter_fn</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-242"></a>    <span class='hs-varop'>`finally`</span>
<a name="line-243"></a>       <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-conid'>EOF</span>
<a name="line-244"></a>        <span class='hs-comment'>-- ToDo: check errors more carefully</span>
<a name="line-245"></a>        <span class='hs-comment'>-- ToDo: in the future, the filter should be implemented as</span>
<a name="line-246"></a>        <span class='hs-comment'>-- a stream transformer.</span>
<a name="line-247"></a>    <span class='hs-keyword'>where</span>
<a name="line-248"></a>        <span class='hs-varid'>loop</span> <span class='hs-conid'>[]</span>     <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-249"></a>        <span class='hs-varid'>loop</span> <span class='hs-conid'>[]</span>     <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>err</span>
<a name="line-250"></a>        <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-varid'>ls</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_err</span>     <span class='hs-keyglyph'>=</span>
<a name="line-251"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>in_err</span> <span class='hs-keyword'>of</span>
<a name="line-252"></a>                  <span class='hs-conid'>Just</span> <span class='hs-varid'>err</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BuildError</span> <span class='hs-varid'>srcLoc</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-253"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>leading_whitespace</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-254"></a>                        <span class='hs-varid'>loop</span> <span class='hs-varid'>ls</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuildError</span> <span class='hs-varid'>srcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-255"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-256"></a>                        <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-varid'>err</span>
<a name="line-257"></a>                        <span class='hs-varid'>checkError</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ls</span>
<a name="line-258"></a>                  <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-259"></a>                        <span class='hs-varid'>checkError</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ls</span>
<a name="line-260"></a>                  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"readerProc/loop"</span>
<a name="line-261"></a>
<a name="line-262"></a>        <span class='hs-varid'>checkError</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ls</span>
<a name="line-263"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>parseError</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-264"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-265"></a>                    <span class='hs-varid'>writeChan</span> <span class='hs-varid'>chan</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuildMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-266"></a>                    <span class='hs-varid'>loop</span> <span class='hs-varid'>ls</span> <span class='hs-conid'>Nothing</span>
<a name="line-267"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>file</span><span class='hs-layout'>,</span> <span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>colNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-268"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>srcLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span> <span class='hs-varid'>lineNum</span> <span class='hs-varid'>colNum</span>
<a name="line-269"></a>                    <span class='hs-varid'>loop</span> <span class='hs-varid'>ls</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuildError</span> <span class='hs-varid'>srcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-270"></a>
<a name="line-271"></a>        <span class='hs-varid'>leading_whitespace</span> <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-272"></a>        <span class='hs-varid'>leading_whitespace</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSpace</span> <span class='hs-varid'>x</span>
<a name="line-273"></a>
<a name="line-274"></a><a name="parseError"></a><span class='hs-definition'>parseError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-275"></a><span class='hs-definition'>parseError</span> <span class='hs-varid'>s0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>breakColon</span> <span class='hs-varid'>s0</span> <span class='hs-keyword'>of</span>
<a name="line-276"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-277"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>breakIntColon</span> <span class='hs-varid'>s1</span> <span class='hs-keyword'>of</span>
<a name="line-278"></a>                    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-279"></a>                        <span class='hs-keyword'>case</span> <span class='hs-varid'>breakIntColon</span> <span class='hs-varid'>s2</span> <span class='hs-keyword'>of</span>
<a name="line-280"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>columnNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>s3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-281"></a>                            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>columnNum</span><span class='hs-layout'>,</span> <span class='hs-varid'>s3</span><span class='hs-layout'>)</span>
<a name="line-282"></a>                        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-283"></a>                            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>lineNum</span><span class='hs-layout'>,</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-284"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-285"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="breakColon"></a><span class='hs-definition'>breakColon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-288"></a><span class='hs-definition'>breakColon</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-chr'>':'</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-289"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span>
<a name="line-290"></a>                    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-291"></a>
<a name="line-292"></a><a name="breakIntColon"></a><span class='hs-definition'>breakIntColon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-293"></a><span class='hs-definition'>breakIntColon</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-chr'>':'</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-294"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>zs</span><span class='hs-layout'>)</span>
<a name="line-295"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isAscii</span> <span class='hs-varid'>ys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isDigit</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-296"></a>                           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>read</span> <span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span>
<a name="line-297"></a>                       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="BuildMessage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BuildMessage</span>
<a name="line-300"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BuildMsg</span>   <span class='hs-varop'>!</span><span class='hs-conid'>SDoc</span>
<a name="line-301"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BuildError</span> <span class='hs-varop'>!</span><span class='hs-conid'>SrcLoc</span> <span class='hs-varop'>!</span><span class='hs-conid'>SDoc</span>
<a name="line-302"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EOF</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="traceCmd"></a><span class='hs-definition'>traceCmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-305"></a><span class='hs-comment'>-- trace the command (at two levels of verbosity)</span>
<a name="line-306"></a><span class='hs-definition'>traceCmd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>cmd_line</span> <span class='hs-varid'>action</span>
<a name="line-307"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>   <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>verb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dflags</span>
<a name="line-308"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>phase_name</span>
<a name="line-309"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>cmd_line</span><span class='hs-layout'>)</span>
<a name="line-310"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>flushErr</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-311"></a>              <span class='hs-conid'>FlushErr</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>io</span>
<a name="line-312"></a>
<a name="line-313"></a>           <span class='hs-comment'>-- And run it!</span>
<a name="line-314"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>action</span> <span class='hs-varop'>`catchIO`</span> <span class='hs-varid'>handle_exn</span> <span class='hs-varid'>verb</span>
<a name="line-315"></a>        <span class='hs-layout'>}</span>
<a name="line-316"></a>  <span class='hs-keyword'>where</span>
<a name="line-317"></a>    <span class='hs-varid'>handle_exn</span> <span class='hs-sel'>_verb</span> <span class='hs-varid'>exn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'\n'</span><span class='hs-layout'>)</span>
<a name="line-318"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Failed:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>cmd_line</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>exn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-319"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhaseFailed</span> <span class='hs-varid'>phase_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitFailure</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Support code}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- Define       getBaseDir     :: IO (Maybe String)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="getBaseDir"></a><span class='hs-definition'>getBaseDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-cpp'>#if defined(mingw32_HOST_OS)</span>
<a name="line-6"></a><span class='hs-comment'>-- Assuming we are running ghc, accessed by path  $(stuff)/bin/ghc.exe,</span>
<a name="line-7"></a><span class='hs-comment'>-- return the path $(stuff)/lib.</span>
<a name="line-8"></a><span class='hs-definition'>getBaseDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>try_size</span> <span class='hs-num'>2048</span> <span class='hs-comment'>-- plenty, PATH_MAX is 512 under Win32.</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>try_size</span> <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allocaArray</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>buf</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-11"></a>        <span class='hs-varid'>ret</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>c_GetModuleFileName</span> <span class='hs-varid'>nullPtr</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>size</span>
<a name="line-12"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>ret</span> <span class='hs-keyword'>of</span>
<a name="line-13"></a>          <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-14"></a>          <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ret</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rootDir</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>peekCWString</span> <span class='hs-varid'>buf</span>
<a name="line-15"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>try_size</span> <span class='hs-layout'>(</span><span class='hs-varid'>size</span> <span class='hs-varop'>*</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-16"></a>    
<a name="line-17"></a>    <span class='hs-varid'>rootDir</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitFileName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-18"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>ghc_exe</span><span class='hs-layout'>)</span>
<a name="line-19"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lower</span> <span class='hs-varid'>ghc_exe</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"ghc.exe"</span><span class='hs-layout'>,</span>
<a name="line-20"></a>                                         <span class='hs-str'>"ghc-stage1.exe"</span><span class='hs-layout'>,</span>
<a name="line-21"></a>                                         <span class='hs-str'>"ghc-stage2.exe"</span><span class='hs-layout'>,</span>
<a name="line-22"></a>                                         <span class='hs-str'>"ghc-stage3.exe"</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-23"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>splitFileName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeDirectory</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>of</span>
<a name="line-24"></a>                    <span class='hs-comment'>-- ghc is in $topdir/bin/ghc.exe</span>
<a name="line-25"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>d'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bin</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>lower</span> <span class='hs-varid'>bin</span> <span class='hs-varop'>==</span> <span class='hs-str'>"bin"</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>takeDirectory</span> <span class='hs-varid'>d'</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"lib"</span>
<a name="line-26"></a>                    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span>
<a name="line-27"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span>
<a name="line-28"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>fail</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"can't decompose ghc.exe path: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-29"></a>              <span class='hs-varid'>lower</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toLower</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>WINDOWS_CCONV</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"windows.h GetModuleFileNameW"</span>
<a name="line-32"></a>  <span class='hs-varid'>c_GetModuleFileName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CWString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word32</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Word32</span>
<a name="line-33"></a><span class='hs-cpp'>#else</span>
<a name="line-34"></a><span class='hs-definition'>getBaseDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-35"></a><span class='hs-cpp'>#endif</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-cpp'>#ifdef mingw32_HOST_OS</span>
<a name="line-38"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"_getpid"</span> <span class='hs-varid'>getProcessID</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- relies on Int == Int32 on Windows</span>
<a name="line-39"></a><span class='hs-cpp'>#else</span>
<a name="line-40"></a><a name="getProcessID"></a><span class='hs-definition'>getProcessID</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Int</span>
<a name="line-41"></a><span class='hs-definition'>getProcessID</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-varid'>c_getpid</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromIntegral</span>
<a name="line-42"></a><span class='hs-cpp'>#endif</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="linesPlatform"></a><span class='hs-comment'>-- Divvy up text stream into lines, taking platform dependent</span>
<a name="line-45"></a><span class='hs-comment'>-- line termination into account.</span>
<a name="line-46"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-47"></a><span class='hs-cpp'>#if !defined(mingw32_HOST_OS)</span>
<a name="line-48"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lines</span> <span class='hs-varid'>ls</span>
<a name="line-49"></a><span class='hs-cpp'>#else</span>
<a name="line-50"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-51"></a><span class='hs-definition'>linesPlatform</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span>
<a name="line-52"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lineBreak</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span>
<a name="line-53"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>xs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>as</span> <span class='hs-conop'>:</span> <span class='hs-varid'>linesPlatform</span> <span class='hs-varid'>xs1</span>
<a name="line-54"></a>  <span class='hs-keyword'>where</span>
<a name="line-55"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-56"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-layout'>(</span><span class='hs-chr'>'\r'</span><span class='hs-conop'>:</span><span class='hs-chr'>'\n'</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-57"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-layout'>(</span><span class='hs-chr'>'\n'</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-58"></a>   <span class='hs-varid'>lineBreak</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lineBreak</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-cpp'>#endif</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="linkDynLib"></a><span class='hs-definition'>linkDynLib</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-63"></a><span class='hs-definition'>linkDynLib</span> <span class='hs-varid'>dflags0</span> <span class='hs-varid'>o_files</span> <span class='hs-varid'>dep_packages</span>
<a name="line-64"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-65"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>-- This is a rather ugly hack to fix dynamically linked</span>
<a name="line-66"></a>        <span class='hs-comment'>-- GHC on Windows. If GHC is linked with -threaded, then</span>
<a name="line-67"></a>        <span class='hs-comment'>-- it links against libHSrts_thr. But if base is linked</span>
<a name="line-68"></a>        <span class='hs-comment'>-- against libHSrts, then both end up getting loaded,</span>
<a name="line-69"></a>        <span class='hs-comment'>-- and things go wrong. We therefore link the libraries</span>
<a name="line-70"></a>        <span class='hs-comment'>-- with the same RTS flags that we link GHC with.</span>
<a name="line-71"></a>        <span class='hs-varid'>dflags1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cGhcThreaded</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>addWay'</span> <span class='hs-conid'>WayThreaded</span> <span class='hs-varid'>dflags0</span>
<a name="line-72"></a>                                  <span class='hs-keyword'>else</span>                     <span class='hs-varid'>dflags0</span>
<a name="line-73"></a>        <span class='hs-varid'>dflags2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cGhcDebugged</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>addWay'</span> <span class='hs-conid'>WayDebug</span> <span class='hs-varid'>dflags1</span>
<a name="line-74"></a>                                  <span class='hs-keyword'>else</span>                  <span class='hs-varid'>dflags1</span>
<a name="line-75"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateWays</span> <span class='hs-varid'>dflags2</span>
<a name="line-76"></a>
<a name="line-77"></a>        <span class='hs-varid'>verbFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getVerbFlags</span> <span class='hs-varid'>dflags</span>
<a name="line-78"></a>        <span class='hs-varid'>o_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outputFile</span> <span class='hs-varid'>dflags</span>
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPreloadPackagesAnd</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dep_packages</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pkg_lib_paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLibraryPaths</span> <span class='hs-varid'>pkgs</span>
<a name="line-83"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pkg_lib_path_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>get_pkg_lib_path_opts</span> <span class='hs-varid'>pkg_lib_paths</span>
<a name="line-84"></a>        <span class='hs-varid'>get_pkg_lib_path_opts</span> <span class='hs-varid'>l</span>
<a name="line-85"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span> <span class='hs-varid'>osElfTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-86"></a>             <span class='hs-varid'>osMachOTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-87"></a>           <span class='hs-varid'>dynLibLoader</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>SystemDependent</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-88"></a>           <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_Static</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-89"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-L"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-str'>"-Wl,-rpath"</span><span class='hs-layout'>,</span> <span class='hs-str'>"-Wl,"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span>
<a name="line-90"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-L"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>lib_paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libraryPaths</span> <span class='hs-varid'>dflags</span>
<a name="line-93"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>lib_path_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>"-L"</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>lib_paths</span>
<a name="line-94"></a>
<a name="line-95"></a>    <span class='hs-comment'>-- We don't want to link our dynamic libs against the RTS package,</span>
<a name="line-96"></a>    <span class='hs-comment'>-- because the RTS lib comes in several flavours and we want to be</span>
<a name="line-97"></a>    <span class='hs-comment'>-- able to pick the flavour when a binary is linked.</span>
<a name="line-98"></a>    <span class='hs-comment'>-- On Windows we need to link the RTS import lib as Windows does</span>
<a name="line-99"></a>    <span class='hs-comment'>-- not allow undefined symbols.</span>
<a name="line-100"></a>    <span class='hs-comment'>-- The RTS library path is still added to the library search path</span>
<a name="line-101"></a>    <span class='hs-comment'>-- above in case the RTS is being explicitly linked in (see #3807).</span>
<a name="line-102"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-103"></a>        <span class='hs-varid'>os</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span>
<a name="line-104"></a>        <span class='hs-varid'>pkgs_no_rts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-105"></a>                      <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-106"></a>                          <span class='hs-varid'>pkgs</span>
<a name="line-107"></a>                      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-108"></a>                          <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>rtsPackageId</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>packageConfigId</span><span class='hs-layout'>)</span> <span class='hs-varid'>pkgs</span>
<a name="line-109"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pkg_link_opts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>package_hs_libs</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_libs</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_flags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectLinkOpts</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pkgs_no_rts</span>
<a name="line-110"></a>                        <span class='hs-keyword'>in</span>  <span class='hs-varid'>package_hs_libs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_libs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>other_flags</span>
<a name="line-111"></a>
<a name="line-112"></a>        <span class='hs-comment'>-- probably _stub.o files</span>
<a name="line-113"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>extra_ld_inputs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ldInputs</span> <span class='hs-varid'>dflags</span>
<a name="line-114"></a>
<a name="line-115"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-116"></a>        <span class='hs-conid'>OSMinGW32</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-117"></a>            <span class='hs-comment'>-------------------------------------------------------------</span>
<a name="line-118"></a>            <span class='hs-comment'>-- Making a DLL</span>
<a name="line-119"></a>            <span class='hs-comment'>-------------------------------------------------------------</span>
<a name="line-120"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>output_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>o_file</span> <span class='hs-keyword'>of</span>
<a name="line-121"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-122"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"HSdll.dll"</span>
<a name="line-123"></a>
<a name="line-124"></a>            <span class='hs-varid'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span>
<a name="line-125"></a>                    <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>verbFlags</span>
<a name="line-126"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-o"</span>
<a name="line-127"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>output_fn</span>
<a name="line-128"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-shared"</span>
<a name="line-129"></a>                    <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-130"></a>                    <span class='hs-keyglyph'>[</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>"-Wl,--out-implib="</span> <span class='hs-layout'>(</span><span class='hs-varid'>output_fn</span> <span class='hs-varop'>++</span> <span class='hs-str'>".a"</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SharedImplib</span> <span class='hs-varid'>dflags</span>
<a name="line-132"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-133"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-varid'>o_files</span>
<a name="line-134"></a>
<a name="line-135"></a>                 <span class='hs-comment'>-- Permit the linker to auto link _symbol to _imp_symbol</span>
<a name="line-136"></a>                 <span class='hs-comment'>-- This lets us link against DLLs without needing an "import library"</span>
<a name="line-137"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Option</span> <span class='hs-str'>"-Wl,--enable-auto-import"</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a>
<a name="line-139"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>extra_ld_inputs</span>
<a name="line-140"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span>
<a name="line-141"></a>                    <span class='hs-varid'>lib_path_opts</span>
<a name="line-142"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>pkg_lib_path_opts</span>
<a name="line-143"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>pkg_link_opts</span>
<a name="line-144"></a>                <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-145"></a>        <span class='hs-conid'>OSDarwin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-146"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-147"></a>            <span class='hs-comment'>-- Making a darwin dylib</span>
<a name="line-148"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-149"></a>            <span class='hs-comment'>-- About the options used for Darwin:</span>
<a name="line-150"></a>            <span class='hs-comment'>-- -dynamiclib</span>
<a name="line-151"></a>            <span class='hs-comment'>--   Apple's way of saying -shared</span>
<a name="line-152"></a>            <span class='hs-comment'>-- -undefined dynamic_lookup:</span>
<a name="line-153"></a>            <span class='hs-comment'>--   Without these options, we'd have to specify the correct</span>
<a name="line-154"></a>            <span class='hs-comment'>--   dependencies for each of the dylibs. Note that we could</span>
<a name="line-155"></a>            <span class='hs-comment'>--   (and should) do without this for all libraries except</span>
<a name="line-156"></a>            <span class='hs-comment'>--   the RTS; all we need to do is to pass the correct</span>
<a name="line-157"></a>            <span class='hs-comment'>--   HSfoo_dyn.dylib files to the link command.</span>
<a name="line-158"></a>            <span class='hs-comment'>--   This feature requires Mac OS X 10.3 or later; there is</span>
<a name="line-159"></a>            <span class='hs-comment'>--   a similar feature, -flat_namespace -undefined suppress,</span>
<a name="line-160"></a>            <span class='hs-comment'>--   which works on earlier versions, but it has other</span>
<a name="line-161"></a>            <span class='hs-comment'>--   disadvantages.</span>
<a name="line-162"></a>            <span class='hs-comment'>-- -single_module</span>
<a name="line-163"></a>            <span class='hs-comment'>--   Build the dynamic library as a single "module", i.e. no</span>
<a name="line-164"></a>            <span class='hs-comment'>--   dynamic binding nonsense when referring to symbols from</span>
<a name="line-165"></a>            <span class='hs-comment'>--   within the library. The NCG assumes that this option is</span>
<a name="line-166"></a>            <span class='hs-comment'>--   specified (on i386, at least).</span>
<a name="line-167"></a>            <span class='hs-comment'>-- -install_name</span>
<a name="line-168"></a>            <span class='hs-comment'>--   Mac OS/X stores the path where a dynamic library is (to</span>
<a name="line-169"></a>            <span class='hs-comment'>--   be) installed in the library itself.  It's called the</span>
<a name="line-170"></a>            <span class='hs-comment'>--   "install name" of the library. Then any library or</span>
<a name="line-171"></a>            <span class='hs-comment'>--   executable that links against it before it's installed</span>
<a name="line-172"></a>            <span class='hs-comment'>--   will search for it in its ultimate install location.</span>
<a name="line-173"></a>            <span class='hs-comment'>--   By default we set the install name to the absolute path</span>
<a name="line-174"></a>            <span class='hs-comment'>--   at build time, but it can be overridden by the</span>
<a name="line-175"></a>            <span class='hs-comment'>--   -dylib-install-name option passed to ghc. Cabal does</span>
<a name="line-176"></a>            <span class='hs-comment'>--   this.</span>
<a name="line-177"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-178"></a>
<a name="line-179"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>output_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>o_file</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"a.out"</span><span class='hs-layout'>;</span> <span class='hs-layout'>}</span>
<a name="line-180"></a>
<a name="line-181"></a>            <span class='hs-varid'>instName</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dylibInstallName</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-182"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n</span>
<a name="line-183"></a>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-str'>"@rpath"</span> <span class='hs-varop'>`combine`</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeFileName</span> <span class='hs-varid'>output_fn</span><span class='hs-layout'>)</span>
<a name="line-184"></a>            <span class='hs-varid'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span>
<a name="line-185"></a>                    <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>verbFlags</span>
<a name="line-186"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-dynamiclib"</span>
<a name="line-187"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-o"</span>
<a name="line-188"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>output_fn</span>
<a name="line-189"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-190"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>o_files</span>
<a name="line-191"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-undefined"</span><span class='hs-layout'>,</span>
<a name="line-192"></a>                      <span class='hs-conid'>Option</span> <span class='hs-str'>"dynamic_lookup"</span><span class='hs-layout'>,</span>
<a name="line-193"></a>                      <span class='hs-conid'>Option</span> <span class='hs-str'>"-single_module"</span> <span class='hs-keyglyph'>]</span>
<a name="line-194"></a>                 <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ArchX86_64</span>
<a name="line-195"></a>                     <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyglyph'>]</span>
<a name="line-196"></a>                     <span class='hs-keyword'>else</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-Wl,-read_only_relocs,suppress"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-197"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-install_name"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>instName</span> <span class='hs-keyglyph'>]</span>
<a name="line-198"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>lib_path_opts</span>
<a name="line-199"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>extra_ld_inputs</span>
<a name="line-200"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_lib_path_opts</span>
<a name="line-201"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_link_opts</span>
<a name="line-202"></a>              <span class='hs-layout'>)</span>
<a name="line-203"></a>        <span class='hs-conid'>OSiOS</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwGhcExceptionIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProgramError</span> <span class='hs-str'>"dynamic libraries are not supported on iOS target"</span><span class='hs-layout'>)</span>
<a name="line-204"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-205"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-206"></a>            <span class='hs-comment'>-- Making a DSO</span>
<a name="line-207"></a>            <span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-208"></a>
<a name="line-209"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>output_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>o_file</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"a.out"</span><span class='hs-layout'>;</span> <span class='hs-layout'>}</span>
<a name="line-210"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>buildingRts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rtsPackageId</span>
<a name="line-211"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>bsymbolicFlag</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>buildingRts</span>
<a name="line-212"></a>                                <span class='hs-keyword'>then</span> <span class='hs-comment'>-- -Bsymbolic breaks the way we implement</span>
<a name="line-213"></a>                                     <span class='hs-comment'>-- hooks in the RTS</span>
<a name="line-214"></a>                                     <span class='hs-conid'>[]</span>
<a name="line-215"></a>                                <span class='hs-keyword'>else</span> <span class='hs-comment'>-- we need symbolic linking to resolve</span>
<a name="line-216"></a>                                     <span class='hs-comment'>-- non-PIC intra-package-relocations</span>
<a name="line-217"></a>                                     <span class='hs-keyglyph'>[</span><span class='hs-str'>"-Wl,-Bsymbolic"</span><span class='hs-keyglyph'>]</span>
<a name="line-218"></a>
<a name="line-219"></a>            <span class='hs-varid'>runLink</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span>
<a name="line-220"></a>                    <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>verbFlags</span>
<a name="line-221"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-o"</span>
<a name="line-222"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>FileOption</span> <span class='hs-str'>""</span> <span class='hs-varid'>output_fn</span>
<a name="line-223"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-224"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>o_files</span>
<a name="line-225"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-str'>"-shared"</span> <span class='hs-keyglyph'>]</span>
<a name="line-226"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>bsymbolicFlag</span>
<a name="line-227"></a>                    <span class='hs-comment'>-- Set the library soname. We use -h rather than -soname as</span>
<a name="line-228"></a>                    <span class='hs-comment'>-- Solaris 10 doesn't support the latter:</span>
<a name="line-229"></a>                 <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Option</span> <span class='hs-layout'>(</span><span class='hs-str'>"-Wl,-h,"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>takeFileName</span> <span class='hs-varid'>output_fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-230"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>lib_path_opts</span>
<a name="line-231"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>extra_ld_inputs</span>
<a name="line-232"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_lib_path_opts</span>
<a name="line-233"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Option</span> <span class='hs-varid'>pkg_link_opts</span>
<a name="line-234"></a>              <span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
