<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>simplCore/CoreMonad.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The AQUA Project, Glasgow University, 1993-1998
%
\section[CoreMonad]{The core pipeline monad}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://ghc.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE UndecidableInstances #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreMonad</span> <span class='hs-layout'>(</span>
<a name="line-11"></a>    <span class='hs-comment'>-- * Configuration of the core-to-core passes</span>
<a name="line-12"></a>    <span class='hs-conid'>CoreToDo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>runWhen</span><span class='hs-layout'>,</span> <span class='hs-varid'>runMaybe</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-conid'>SimplifierMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-14"></a>    <span class='hs-conid'>FloatOutSwitches</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-15"></a>    <span class='hs-varid'>dumpSimplPhase</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPassDetails</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>
<a name="line-17"></a>    <span class='hs-comment'>-- * Plugins</span>
<a name="line-18"></a>    <span class='hs-conid'>PluginPass</span><span class='hs-layout'>,</span> <span class='hs-conid'>Plugin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CommandLineOption</span><span class='hs-layout'>,</span> 
<a name="line-19"></a>    <span class='hs-varid'>defaultPlugin</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindsOnlyPass</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-comment'>-- * Counting</span>
<a name="line-22"></a>    <span class='hs-conid'>SimplCount</span><span class='hs-layout'>,</span> <span class='hs-varid'>doSimplTick</span><span class='hs-layout'>,</span> <span class='hs-varid'>doFreeSimplTick</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplCountN</span><span class='hs-layout'>,</span>
<a name="line-23"></a>    <span class='hs-varid'>pprSimplCount</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusSimplCount</span><span class='hs-layout'>,</span> <span class='hs-varid'>zeroSimplCount</span><span class='hs-layout'>,</span> 
<a name="line-24"></a>    <span class='hs-varid'>isZeroSimplCount</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasDetailedCounts</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-comment'>-- * The monad</span>
<a name="line-27"></a>    <span class='hs-conid'>CoreM</span><span class='hs-layout'>,</span> <span class='hs-varid'>runCoreM</span><span class='hs-layout'>,</span>
<a name="line-28"></a>    
<a name="line-29"></a>    <span class='hs-comment'>-- ** Reading from the monad</span>
<a name="line-30"></a>    <span class='hs-varid'>getHscEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getRuleBase</span><span class='hs-layout'>,</span> <span class='hs-varid'>getModule</span><span class='hs-layout'>,</span>
<a name="line-31"></a>    <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>getOrigNameCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>getPackageFamInstEnv</span><span class='hs-layout'>,</span>
<a name="line-32"></a>    
<a name="line-33"></a>    <span class='hs-comment'>-- ** Writing to the monad</span>
<a name="line-34"></a>    <span class='hs-varid'>addSimplCount</span><span class='hs-layout'>,</span>
<a name="line-35"></a>    
<a name="line-36"></a>    <span class='hs-comment'>-- ** Lifting into the monad</span>
<a name="line-37"></a>    <span class='hs-varid'>liftIO</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftIOWithCount</span><span class='hs-layout'>,</span>
<a name="line-38"></a>    <span class='hs-varid'>liftIO1</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftIO2</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftIO3</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftIO4</span><span class='hs-layout'>,</span>
<a name="line-39"></a>    
<a name="line-40"></a>    <span class='hs-comment'>-- ** Global initialization</span>
<a name="line-41"></a>    <span class='hs-varid'>reinitializeGlobals</span><span class='hs-layout'>,</span>
<a name="line-42"></a>    
<a name="line-43"></a>    <span class='hs-comment'>-- ** Dealing with annotations</span>
<a name="line-44"></a>    <span class='hs-varid'>getAnnotations</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFirstAnnotations</span><span class='hs-layout'>,</span>
<a name="line-45"></a>    
<a name="line-46"></a>    <span class='hs-comment'>-- ** Debug output</span>
<a name="line-47"></a>    <span class='hs-varid'>showPass</span><span class='hs-layout'>,</span> <span class='hs-varid'>endPass</span><span class='hs-layout'>,</span> <span class='hs-varid'>dumpPassResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>lintPassResult</span><span class='hs-layout'>,</span> 
<a name="line-48"></a>    <span class='hs-varid'>lintInteractiveExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>dumpIfSet</span><span class='hs-layout'>,</span>
<a name="line-49"></a>
<a name="line-50"></a>    <span class='hs-comment'>-- ** Screen output</span>
<a name="line-51"></a>    <span class='hs-varid'>putMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>putMsgS</span><span class='hs-layout'>,</span> <span class='hs-varid'>errorMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>errorMsgS</span><span class='hs-layout'>,</span> 
<a name="line-52"></a>    <span class='hs-varid'>fatalErrorMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>fatalErrorMsgS</span><span class='hs-layout'>,</span> 
<a name="line-53"></a>    <span class='hs-varid'>debugTraceMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>debugTraceMsgS</span><span class='hs-layout'>,</span>
<a name="line-54"></a>    <span class='hs-varid'>dumpIfSet_dyn</span><span class='hs-layout'>,</span> 
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-57"></a>    <span class='hs-comment'>-- * Getting 'Name's</span>
<a name="line-58"></a>    <span class='hs-varid'>thNameToGhcName</span>
<a name="line-59"></a><span class='hs-cpp'>#endif</span>
<a name="line-60"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span><span class='hs-layout'>(</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-cpp'>#endif</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreLint</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>lintCoreBindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>lintExpr</span> <span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>	
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Rules</span>            <span class='hs-layout'>(</span> <span class='hs-conid'>RuleBase</span> <span class='hs-layout'>)</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>CompilerPhase</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IOEnv</span> <span class='hs-varid'>hiding</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>liftIO</span><span class='hs-layout'>,</span> <span class='hs-varid'>failM</span><span class='hs-layout'>,</span> <span class='hs-varid'>failWithM</span> <span class='hs-layout'>)</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>IOEnv</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>)</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>            <span class='hs-layout'>(</span> <span class='hs-varid'>tcLookupGlobal</span> <span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>initTcForLookup</span> <span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>             <span class='hs-layout'>(</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-layout'>)</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>               <span class='hs-layout'>(</span> <span class='hs-varid'>idType</span> <span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-86"></a>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>ErrUtils</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Err</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>UniqFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterUFM</span> <span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span> <span class='hs-layout'>(</span> <span class='hs-varid'>split</span> <span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>runs</span> <span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dynamic</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>A</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>read</span> <span class='hs-layout'>)</span>
<a name="line-110"></a>
<a name="line-111"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>MVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span><span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Linker</span> <span class='hs-layout'>(</span> <span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-varid'>saveLinkerGlobals</span><span class='hs-layout'>,</span> <span class='hs-varid'>restoreLinkerGlobals</span> <span class='hs-layout'>)</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcSplice</span> <span class='hs-layout'>(</span> <span class='hs-varid'>lookupThName_maybe</span> <span class='hs-layout'>)</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-116"></a><span class='hs-cpp'>#else</span>
<a name="line-117"></a><a name="saveLinkerGlobals"></a><span class='hs-definition'>saveLinkerGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-118"></a><span class='hs-definition'>saveLinkerGlobals</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-119"></a>
<a name="line-120"></a><a name="restoreLinkerGlobals"></a><span class='hs-definition'>restoreLinkerGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-121"></a><span class='hs-definition'>restoreLinkerGlobals</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-122"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

%************************************************************************
%*									*
                       Debug output
%*									*
%************************************************************************

These functions are not CoreM monad stuff, but they probably ought to
be, and it makes a conveneint place.  place for them.  They print out
stuff before and after core passes, and do Core Lint when necessary.

\begin{code}
<pre><a name="line-1"></a><a name="showPass"></a><span class='hs-definition'>showPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>showPpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="endPass"></a><span class='hs-definition'>endPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-5"></a><span class='hs-definition'>endPass</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dumpPassResult</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mb_flag</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPassDetails</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lintPassResult</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>}</span>      
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span> 
<a name="line-10"></a>    <span class='hs-varid'>mb_flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coreDumpFlag</span> <span class='hs-varid'>pass</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>dflags</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>flag</span>
<a name="line-12"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>flag</span>
<a name="line-13"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="dumpIfSet"></a><span class='hs-definition'>dumpIfSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-16"></a><span class='hs-definition'>dumpIfSet</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dump_me</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>extra_info</span> <span class='hs-varid'>doc</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dump_me</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>extra_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>doc</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="dumpPassResult"></a><span class='hs-definition'>dumpPassResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> 
<a name="line-20"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DumpFlag</span>		<span class='hs-comment'>-- Just df =&gt; show details in a file whose</span>
<a name="line-21"></a>	       	  			<span class='hs-comment'>--            name is specified by df</span>
<a name="line-22"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> 			<span class='hs-comment'>-- Header</span>
<a name="line-23"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> 			<span class='hs-comment'>-- Extra info to appear after header</span>
<a name="line-24"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreRule</span><span class='hs-keyglyph'>]</span> 
<a name="line-25"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-26"></a><span class='hs-definition'>dumpPassResult</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mb_flag</span> <span class='hs-varid'>hdr</span> <span class='hs-varid'>extra_info</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rules</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_flag</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>flag</span> <span class='hs-layout'>(</span><span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>hdr</span><span class='hs-layout'>)</span> <span class='hs-varid'>dump_doc</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>debugTraceMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>2</span> <span class='hs-varid'>size_doc</span>
<a name="line-32"></a>          <span class='hs-comment'>-- Report result size </span>
<a name="line-33"></a>	  <span class='hs-comment'>-- This has the side effect of forcing the intermediate to be evaluated</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-varid'>size_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"Result size of"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hdr</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreBindsStats</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-varid'>dump_doc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>extra_info</span>
<a name="line-39"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>size_doc</span>
<a name="line-40"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>blankLine</span>
<a name="line-41"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>pprCoreBindings</span> <span class='hs-varid'>binds</span> 
<a name="line-42"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>rules</span><span class='hs-layout'>)</span> <span class='hs-varid'>pp_rules</span> <span class='hs-keyglyph'>]</span>
<a name="line-43"></a>    <span class='hs-varid'>pp_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>blankLine</span>
<a name="line-44"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"------ Local rules for imported ids --------"</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>pprRules</span> <span class='hs-varid'>rules</span> <span class='hs-keyglyph'>]</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="lintPassResult"></a><span class='hs-definition'>lintPassResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-48"></a><span class='hs-definition'>lintPassResult</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>binds</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DoCoreLinting</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lintCoreBindings</span> <span class='hs-layout'>(</span><span class='hs-varid'>interactiveInScope</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-str'>"Core Linted result of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showPpr</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span>
<a name="line-54"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>displayLintResults</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>warns</span> <span class='hs-varid'>errs</span> <span class='hs-varid'>binds</span>  <span class='hs-layout'>}</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span> 
<a name="line-56"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="displayLintResults"></a><span class='hs-definition'>displayLintResults</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span>
<a name="line-59"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-conid'>MsgDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-60"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-61"></a><span class='hs-definition'>displayLintResults</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>warns</span> <span class='hs-varid'>errs</span> <span class='hs-varid'>binds</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-conid'>SevDump</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultDumpStyle</span>
<a name="line-64"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>lint_banner</span> <span class='hs-str'>"errors"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>pprMessageBag</span> <span class='hs-varid'>errs</span>
<a name="line-65"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"*** Offending Program ***"</span><span class='hs-layout'>)</span>
<a name="line-66"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>pprCoreBindings</span> <span class='hs-varid'>binds</span>
<a name="line-67"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"*** End of Offense ***"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>ghcExit</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>1</span> <span class='hs-layout'>}</span>
<a name="line-69"></a>
<a name="line-70"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>warns</span><span class='hs-layout'>)</span>
<a name="line-71"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>pass</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>CoreDesugar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-72"></a>    	<span class='hs-comment'>-- Suppress warnings after desugaring pass because some</span>
<a name="line-73"></a>	<span class='hs-comment'>-- are legitimate. Notably, the desugarer generates instance</span>
<a name="line-74"></a>	<span class='hs-comment'>-- methods with INLINE pragmas that form a mutually recursive</span>
<a name="line-75"></a>	<span class='hs-comment'>-- group.  Only afer a round of simplification are they unravelled.</span>
<a name="line-76"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_NoDebugOutput</span>
<a name="line-77"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>showLintWarnings</span> <span class='hs-varid'>pass</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-conid'>SevDump</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultDumpStyle</span>
<a name="line-79"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>lint_banner</span> <span class='hs-str'>"warnings"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pass</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>pprMessageBag</span> <span class='hs-varid'>warns</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="lint_banner"></a><span class='hs-definition'>lint_banner</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-85"></a><span class='hs-definition'>lint_banner</span> <span class='hs-varid'>string</span> <span class='hs-varid'>pass</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"*** Core Lint"</span><span class='hs-layout'>)</span>      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>string</span> 
<a name="line-86"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>": in result of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pass</span>
<a name="line-87"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"***"</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="showLintWarnings"></a><span class='hs-definition'>showLintWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-90"></a><span class='hs-comment'>-- Disable Lint warnings on the first simplifier pass, because</span>
<a name="line-91"></a><span class='hs-comment'>-- there may be some INLINE knots still tied, which is tiresomely noisy</span>
<a name="line-92"></a><span class='hs-definition'>showLintWarnings</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoSimplify</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InitialPhase</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-93"></a><span class='hs-definition'>showLintWarnings</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="lintInteractiveExpr"></a><span class='hs-definition'>lintInteractiveExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-96"></a><span class='hs-definition'>lintInteractiveExpr</span> <span class='hs-varid'>what</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>expr</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_DoCoreLinting</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lintExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>interactiveInScope</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> 
<a name="line-100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>display_lint_err</span> <span class='hs-varid'>err</span>
<a name="line-101"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>ghcExit</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>1</span> <span class='hs-layout'>}</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-104"></a>  <span class='hs-keyword'>where</span>
<a name="line-105"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-varid'>display_lint_err</span> <span class='hs-varid'>err</span>
<a name="line-108"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>log_action</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-conid'>SevDump</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>defaultDumpStyle</span>
<a name="line-109"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>lint_banner</span> <span class='hs-str'>"errors"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>what</span><span class='hs-layout'>)</span> 
<a name="line-110"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>err</span>
<a name="line-111"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"*** Offending Program ***"</span><span class='hs-layout'>)</span>
<a name="line-112"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>pprCoreExpr</span> <span class='hs-varid'>expr</span>
<a name="line-113"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"*** End of Offense ***"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-114"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>ghcExit</span> <span class='hs-varid'>dflags</span> <span class='hs-num'>1</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="interactiveInScope"></a><span class='hs-definition'>interactiveInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a><span class='hs-comment'>-- In GHCi we may lint expressions, or bindings arising from 'deriving'</span>
<a name="line-118"></a><span class='hs-comment'>-- clauses, that mention variables bound in the interactive context.</span>
<a name="line-119"></a><span class='hs-comment'>-- These are Local things (see Note [Interactively-bound Ids in GHCi] in HscTypes).</span>
<a name="line-120"></a><span class='hs-comment'>-- So we have to tell Lint about them, lest it reports them as out of scope.</span>
<a name="line-121"></a><span class='hs-comment'>-- </span>
<a name="line-122"></a><span class='hs-comment'>-- We do this by find local-named things that may appear free in interactive</span>
<a name="line-123"></a><span class='hs-comment'>-- context.  This function is pretty revolting and quite possibly not quite right.</span>
<a name="line-124"></a><span class='hs-comment'>-- When we are not in GHCi, the interactive context (hsc_IC hsc_env) is empty</span>
<a name="line-125"></a><span class='hs-comment'>-- so this is a (cheap) no-op.</span>
<a name="line-126"></a><span class='hs-comment'>-- </span>
<a name="line-127"></a><span class='hs-comment'>-- See Trac #8215 for an example</span>
<a name="line-128"></a><span class='hs-definition'>interactiveInScope</span> <span class='hs-varid'>hsc_env</span> 
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ids</span>
<a name="line-130"></a>  <span class='hs-keyword'>where</span>
<a name="line-131"></a>    <span class='hs-comment'>-- C.f. TcRnDriver.setInteractiveContext, Desugar.deSugarExpr</span>
<a name="line-132"></a>    <span class='hs-varid'>ictxt</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-133"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>cls_insts</span><span class='hs-layout'>,</span> <span class='hs-sel'>_fam_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_instances</span> <span class='hs-varid'>ictxt</span>
<a name="line-134"></a>    <span class='hs-varid'>te1</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTypeEnvWithImplicits</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_tythings</span> <span class='hs-varid'>ictxt</span><span class='hs-layout'>)</span>
<a name="line-135"></a>    <span class='hs-varid'>te</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTypeEnvWithIds</span> <span class='hs-varid'>te1</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>cls_insts</span><span class='hs-layout'>)</span>
<a name="line-136"></a>    <span class='hs-varid'>ids</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeEnvIds</span> <span class='hs-varid'>te</span>
<a name="line-137"></a>    <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>ids</span>
<a name="line-138"></a>              <span class='hs-comment'>-- Why the type variables?  How can the top level envt have free tyvars?</span>
<a name="line-139"></a>              <span class='hs-comment'>-- I think it's because of the GHCi debugger, which can bind variables</span>
<a name="line-140"></a>              <span class='hs-comment'>--   f :: [t] -&gt; [t]</span>
<a name="line-141"></a>              <span class='hs-comment'>-- where t is a RuntimeUnk (see TcType)</span>
</pre>\end{code}


%************************************************************************
%*									*
              The CoreToDo type and related types
	  Abstraction of core-to-core passes to run.
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="CoreToDo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoreToDo</span>           <span class='hs-comment'>-- These are diff core-to-core passes,</span>
<a name="line-3"></a>                        <span class='hs-comment'>-- which may be invoked in any order,</span>
<a name="line-4"></a>                        <span class='hs-comment'>-- as many times as you like.</span>
<a name="line-5"></a>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoSimplify</span>      <span class='hs-comment'>-- The core-to-core simplifier.</span>
<a name="line-7"></a>        <span class='hs-conid'>Int</span>                    <span class='hs-comment'>-- Max iterations</span>
<a name="line-8"></a>        <span class='hs-conid'>SimplifierMode</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoPluginPass</span> <span class='hs-conid'>String</span> <span class='hs-conid'>PluginPass</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoFloatInwards</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-conid'>FloatOutSwitches</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreLiberateCase</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoPrintCore</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoStaticArgs</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoStrictness</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoWorkerWrapper</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoSpecialising</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoSpecConstr</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreCSE</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoRuleCheck</span> <span class='hs-conid'>CompilerPhase</span> <span class='hs-conid'>String</span>   <span class='hs-comment'>-- Check for non-application of rules</span>
<a name="line-21"></a>                                           <span class='hs-comment'>-- matching this string</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoVectorisation</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoNothing</span>                <span class='hs-comment'>-- Useful when building up</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDoPasses</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- lists of these things</span>
<a name="line-25"></a>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDesugar</span>    <span class='hs-comment'>-- Right after desugaring, no simple optimisation yet!</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreDesugarOpt</span> <span class='hs-comment'>-- CoreDesugarXXX: Not strictly a core-to-core pass, but produces</span>
<a name="line-28"></a>                       <span class='hs-comment'>--                 Core output, and hence useful to pass to endPass</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoreTidy</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CorePrep</span>
<a name="line-32"></a>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="coreDumpFlag"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>DumpFlag</span>
<a name="line-2"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoSimplify</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_simpl_phases</span>
<a name="line-3"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPluginPass</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_core_pipeline</span>
<a name="line-4"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoFloatInwards</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_verbose_core2core</span>
<a name="line-5"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_verbose_core2core</span>
<a name="line-6"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreLiberateCase</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_verbose_core2core</span>
<a name="line-7"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoStaticArgs</span> 	      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_verbose_core2core</span>
<a name="line-8"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoStrictness</span> 	      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_stranal</span>
<a name="line-9"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoWorkerWrapper</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_worker_wrapper</span>
<a name="line-10"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoSpecialising</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_spec</span>
<a name="line-11"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoSpecConstr</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_spec</span>
<a name="line-12"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreCSE</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_cse</span> 
<a name="line-13"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoVectorisation</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_vect</span>
<a name="line-14"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDesugar</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_ds</span> 
<a name="line-15"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDesugarOpt</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_ds</span> 
<a name="line-16"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreTidy</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_simpl</span>
<a name="line-17"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CorePrep</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Opt_D_dump_prep</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoPrintCore</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-20"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoRuleCheck</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-21"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-conid'>CoreDoNothing</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-22"></a><span class='hs-definition'>coreDumpFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyword'>where</span>
<a name="line-25"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoSimplify</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Simplifier"</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPluginPass</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Core plugin: "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>s</span>
<a name="line-27"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoFloatInwards</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Float inwards"</span><span class='hs-layout'>)</span>
<a name="line-28"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoFloatOutwards</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Float out"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreLiberateCase</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Liberate case"</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoStaticArgs</span> 	       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Static argument"</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoStrictness</span> 	       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Demand analysis"</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoWorkerWrapper</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Worker Wrapper binds"</span><span class='hs-layout'>)</span>
<a name="line-33"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoSpecialising</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Specialise"</span><span class='hs-layout'>)</span>
<a name="line-34"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoSpecConstr</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SpecConstr"</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreCSE</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Common sub-expression"</span><span class='hs-layout'>)</span>
<a name="line-36"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoVectorisation</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Vectorisation"</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDesugar</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Desugar (before optimization)"</span><span class='hs-layout'>)</span>
<a name="line-38"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDesugarOpt</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Desugar (after optimization)"</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreTidy</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Tidy Core"</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CorePrep</span> 		       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CorePrep"</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoPrintCore</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Print core"</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoRuleCheck</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Rule check"</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CoreDoNothing</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CoreDoNothing"</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoPasses</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CoreDoPasses"</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="pprPassDetails"></a><span class='hs-definition'>pprPassDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-47"></a><span class='hs-definition'>pprPassDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreDoSimplify</span> <span class='hs-varid'>n</span> <span class='hs-varid'>md</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Max iterations ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> 
<a name="line-48"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>md</span> <span class='hs-keyglyph'>]</span>
<a name="line-49"></a><span class='hs-definition'>pprPassDetails</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="SimplifierMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SimplifierMode</span>             <span class='hs-comment'>-- See comments in SimplMonad</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SimplMode</span>
<a name="line-3"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>sm_names</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Name(s) of the phase</span>
<a name="line-4"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>sm_phase</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CompilerPhase</span>
<a name="line-5"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>sm_rules</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- Whether RULES are enabled</span>
<a name="line-6"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>sm_inline</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- Whether inlining is enabled</span>
<a name="line-7"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>sm_case_case</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- Whether case-of-case is enabled</span>
<a name="line-8"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>sm_eta_expand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- Whether eta-expansion is enabled</span>
<a name="line-9"></a>        <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SimplifierMode</span> <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_phase</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ss</span>
<a name="line-13"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>sm_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span>
<a name="line-14"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>sm_eta_expand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_case_case</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-15"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SimplMode"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span>
<a name="line-16"></a>         <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Phase ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-17"></a>               <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>intersperse</span> <span class='hs-str'>","</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-18"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>pp_flag</span> <span class='hs-varid'>i</span>   <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inline"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-19"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>pp_flag</span> <span class='hs-varid'>r</span>   <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"rules"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-20"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>pp_flag</span> <span class='hs-varid'>eta</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"eta-expand"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-21"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>pp_flag</span> <span class='hs-varid'>cc</span>  <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"case-of-case"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-22"></a>	 <span class='hs-keyword'>where</span>
<a name="line-23"></a>           <span class='hs-varid'>pp_flag</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppUnless</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"no"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-varid'>s</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="FloatOutSwitches"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-layout'>{</span>
<a name="line-2"></a>  <span class='hs-varid'>floatOutLambdas</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- ^ Just n &lt;=&gt; float lambdas to top level, if</span>
<a name="line-3"></a>                                   <span class='hs-comment'>-- doing so will abstract over n or fewer </span>
<a name="line-4"></a>                                   <span class='hs-comment'>-- value variables</span>
<a name="line-5"></a>				   <span class='hs-comment'>-- Nothing &lt;=&gt; float all lambdas to top level,</span>
<a name="line-6"></a>                                   <span class='hs-comment'>--             regardless of how many free variables</span>
<a name="line-7"></a>                                   <span class='hs-comment'>-- Just 0 is the vanilla case: float a lambda</span>
<a name="line-8"></a>                                   <span class='hs-comment'>--    iff it has no free vars</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-varid'>floatOutConstants</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- ^ True &lt;=&gt; float constants to top level,</span>
<a name="line-11"></a>                                   <span class='hs-comment'>--            even if they do not escape a lambda</span>
<a name="line-12"></a>  <span class='hs-varid'>floatOutPartialApplications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- ^ True &lt;=&gt; float out partial applications</span>
<a name="line-13"></a>                                            <span class='hs-comment'>--            based on arity information.</span>
<a name="line-14"></a>  <span class='hs-layout'>}</span>
<a name="line-15"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprFloatOutSwitches</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="pprFloatOutSwitches"></a><span class='hs-definition'>pprFloatOutSwitches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FloatOutSwitches</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-19"></a><span class='hs-definition'>pprFloatOutSwitches</span> <span class='hs-varid'>sw</span> 
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"FOS"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span>
<a name="line-21"></a>     <span class='hs-varid'>sep</span> <span class='hs-varop'>$</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span> 
<a name="line-22"></a>     <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Lam ="</span><span class='hs-layout'>)</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatOutLambdas</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span>
<a name="line-23"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Consts ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatOutConstants</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span>
<a name="line-24"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"PAPs ="</span><span class='hs-layout'>)</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>floatOutPartialApplications</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="runWhen"></a><span class='hs-comment'>-- The core-to-core pass ordering is derived from the DynFlags:</span>
<a name="line-27"></a><span class='hs-definition'>runWhen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span>
<a name="line-28"></a><span class='hs-definition'>runWhen</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>do_this</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_this</span>
<a name="line-29"></a><span class='hs-definition'>runWhen</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoNothing</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="runMaybe"></a><span class='hs-definition'>runMaybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreToDo</span>
<a name="line-32"></a><span class='hs-definition'>runMaybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span>
<a name="line-33"></a><span class='hs-definition'>runMaybe</span> <span class='hs-conid'>Nothing</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreDoNothing</span>
<a name="line-34"></a>
<a name="line-35"></a>
<a name="line-36"></a><a name="dumpSimplPhase"></a><span class='hs-definition'>dumpSimplPhase</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplifierMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-37"></a><span class='hs-definition'>dumpSimplPhase</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mode</span>
<a name="line-38"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>spec_string</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>shouldDumpSimplPhase</span> <span class='hs-varid'>dflags</span>
<a name="line-39"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match_spec</span> <span class='hs-varid'>spec_string</span>
<a name="line-40"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-41"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_verbose_core2core</span> <span class='hs-varid'>dflags</span>
<a name="line-42"></a>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>match_spec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-45"></a>    <span class='hs-varid'>match_spec</span> <span class='hs-varid'>spec_string</span> 
<a name="line-46"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>or</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>and</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>match</span> <span class='hs-varop'>.</span> <span class='hs-varid'>split</span> <span class='hs-chr'>':'</span><span class='hs-layout'>)</span> 
<a name="line-47"></a>           <span class='hs-varop'>$</span> <span class='hs-varid'>split</span> <span class='hs-chr'>','</span> <span class='hs-varid'>spec_string</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-varid'>match</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-50"></a>    <span class='hs-varid'>match</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-51"></a>    <span class='hs-varid'>match</span> <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>reads</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-52"></a>                <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>phase_num</span>  <span class='hs-varid'>n</span>
<a name="line-53"></a>                <span class='hs-keyword'>_</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>phase_name</span> <span class='hs-varid'>s</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-varid'>phase_num</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-56"></a>    <span class='hs-varid'>phase_num</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sm_phase</span> <span class='hs-varid'>mode</span> <span class='hs-keyword'>of</span>
<a name="line-57"></a>                    <span class='hs-conid'>Phase</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>k</span>
<a name="line-58"></a>                    <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-59"></a>
<a name="line-60"></a>    <span class='hs-varid'>phase_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-61"></a>    <span class='hs-varid'>phase_name</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>sm_names</span> <span class='hs-varid'>mode</span>
</pre>\end{code}


Note [RULEs enabled in SimplGently]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
RULES are enabled when doing "gentle" simplification.  Two reasons:

  * We really want the class-op cancellation to happen:
        op (df d1 d2) --> $cop3 d1 d2
    because this breaks the mutual recursion between 'op' and 'df'

  * I wanted the RULE
        lift String ===> ...
    to work in Template Haskell when simplifying
    splices, so we get simpler code for literal strings

But watch out: list fusion can prevent floating.  So use phase control
to switch off those rules until after floating.


%************************************************************************
%*									*
             Types for Plugins
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="CommandLineOption"></a><span class='hs-comment'>-- | Command line options gathered from the -PModule.Name:stuff syntax are given to you as this type</span>
<a name="line-2"></a><a name="CommandLineOption"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CommandLineOption</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>String</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="Plugin"></a><span class='hs-comment'>-- | 'Plugin' is the core compiler plugin data type. Try to avoid</span>
<a name="line-5"></a><a name="Plugin"></a><span class='hs-comment'>-- constructing one of these directly, and just modify some fields of</span>
<a name="line-6"></a><a name="Plugin"></a><span class='hs-comment'>-- 'defaultPlugin' instead: this is to try and preserve source-code</span>
<a name="line-7"></a><a name="Plugin"></a><span class='hs-comment'>-- compatability when we add fields to this.</span>
<a name="line-8"></a><a name="Plugin"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><a name="Plugin"></a><span class='hs-comment'>-- Nonetheless, this API is preliminary and highly likely to change in the future.</span>
<a name="line-10"></a><a name="Plugin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Plugin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Plugin</span> <span class='hs-layout'>{</span> 
<a name="line-11"></a>        <span class='hs-varid'>installCoreToDos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CommandLineOption</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreToDo</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a>                <span class='hs-comment'>-- ^ Modify the Core pipeline that will be used for compilation. </span>
<a name="line-13"></a>                <span class='hs-comment'>-- This is called as the Core pipeline is built for every module</span>
<a name="line-14"></a>                <span class='hs-comment'>--  being compiled, and plugins get the opportunity to modify </span>
<a name="line-15"></a>                <span class='hs-comment'>-- the pipeline in a nondeterministic order.</span>
<a name="line-16"></a>     <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="defaultPlugin"></a><span class='hs-comment'>-- | Default plugin: does nothing at all! For compatability reasons you should base all your</span>
<a name="line-19"></a><span class='hs-comment'>-- plugin definitions on this default value.</span>
<a name="line-20"></a><span class='hs-definition'>defaultPlugin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Plugin</span>
<a name="line-21"></a><span class='hs-definition'>defaultPlugin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Plugin</span> <span class='hs-layout'>{</span>
<a name="line-22"></a>        <span class='hs-varid'>installCoreToDos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-varid'>return</span>
<a name="line-23"></a>    <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="PluginPass"></a><span class='hs-comment'>-- | A description of the plugin pass itself</span>
<a name="line-26"></a><a name="PluginPass"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PluginPass</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="bindsOnlyPass"></a><span class='hs-definition'>bindsOnlyPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>CoreProgram</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>ModGuts</span>
<a name="line-29"></a><span class='hs-definition'>bindsOnlyPass</span> <span class='hs-varid'>pass</span> <span class='hs-varid'>guts</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pass</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_binds</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>guts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
             Counting and logging
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="verboseSimplStats"></a><span class='hs-definition'>verboseSimplStats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>verboseSimplStats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_PprStyle_Debug</span>		<span class='hs-comment'>-- For now, anyway</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="zeroSimplCount"></a><span class='hs-definition'>zeroSimplCount</span>	   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span>
<a name="line-5"></a><a name="isZeroSimplCount"></a><span class='hs-definition'>isZeroSimplCount</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-6"></a><a name="hasDetailedCounts"></a><span class='hs-definition'>hasDetailedCounts</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-7"></a><a name="pprSimplCount"></a><span class='hs-definition'>pprSimplCount</span>	   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-8"></a><a name="doSimplTick"></a><span class='hs-definition'>doSimplTick</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span>
<a name="line-9"></a><a name="doFreeSimplTick"></a><span class='hs-definition'>doFreeSimplTick</span>    <span class='hs-keyglyph'>::</span>             <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span>
<a name="line-10"></a><a name="plusSimplCount"></a><span class='hs-definition'>plusSimplCount</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplCount</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="SimplCount"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SimplCount</span> 
<a name="line-2"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VerySimplCount</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>	<span class='hs-comment'>-- Used when don't want detailed stats</span>
<a name="line-3"></a>
<a name="line-4"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SimplCount</span>	<span class='hs-layout'>{</span>
<a name="line-5"></a>	<span class='hs-varid'>ticks</span>   <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Total ticks</span>
<a name="line-6"></a>	<span class='hs-varid'>details</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>TickCounts</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- How many of each type</span>
<a name="line-7"></a>
<a name="line-8"></a>	<span class='hs-varid'>n_log</span>	<span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- N</span>
<a name="line-9"></a>	<span class='hs-varid'>log1</span>	<span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Tick</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Last N events; &lt;= opt_HistorySize, </span>
<a name="line-10"></a>		   		<span class='hs-comment'>--   most recent first</span>
<a name="line-11"></a>	<span class='hs-varid'>log2</span>	<span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Tick</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Last opt_HistorySize events before that</span>
<a name="line-12"></a>		   		<span class='hs-comment'>-- Having log1, log2 lets us accumulate the</span>
<a name="line-13"></a>				<span class='hs-comment'>-- recent history reasonably efficiently</span>
<a name="line-14"></a>     <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="TickCounts"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TickCounts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Tick</span> <span class='hs-conid'>Int</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="simplCountN"></a><span class='hs-definition'>simplCountN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-19"></a><span class='hs-definition'>simplCountN</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerySimplCount</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-20"></a><span class='hs-definition'>simplCountN</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="zeroSimplCount"></a><span class='hs-definition'>zeroSimplCount</span> <span class='hs-varid'>dflags</span>
<a name="line-23"></a>		<span class='hs-comment'>-- This is where we decide whether to do</span>
<a name="line-24"></a>		<span class='hs-comment'>-- the VerySimpl version or the full-stats version</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_simpl_stats</span> <span class='hs-varid'>dflags</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span><span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span>
<a name="line-27"></a>                <span class='hs-varid'>n_log</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>log1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>log2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VerySimplCount</span> <span class='hs-num'>0</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="isZeroSimplCount"></a><span class='hs-definition'>isZeroSimplCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerySimplCount</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>    	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-num'>0</span>
<a name="line-32"></a><span class='hs-definition'>isZeroSimplCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-num'>0</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="hasDetailedCounts"></a><span class='hs-definition'>hasDetailedCounts</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerySimplCount</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-35"></a><span class='hs-definition'>hasDetailedCounts</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="doFreeSimplTick"></a><span class='hs-definition'>doFreeSimplTick</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>sc</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dts</span> <span class='hs-layout'>}</span> 
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dts</span> <span class='hs-varop'>`addTick`</span> <span class='hs-varid'>tick</span> <span class='hs-layout'>}</span>
<a name="line-39"></a><span class='hs-definition'>doFreeSimplTick</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc</span> 
<a name="line-40"></a>
<a name="line-41"></a><a name="doSimplTick"></a><span class='hs-definition'>doSimplTick</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tick</span>
<a name="line-42"></a>    <span class='hs-varid'>sc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tks</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dts</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_log</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nl</span><span class='hs-layout'>,</span> <span class='hs-varid'>log1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nl</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>historySize</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n_log</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>log1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tick</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>log2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span> <span class='hs-layout'>}</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n_log</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nl</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>log1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tick</span> <span class='hs-conop'>:</span> <span class='hs-varid'>l1</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>  <span class='hs-keyword'>where</span>
<a name="line-46"></a>    <span class='hs-varid'>sc1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tks</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dts</span> <span class='hs-varop'>`addTick`</span> <span class='hs-varid'>tick</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>doSimplTick</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerySimplCount</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VerySimplCount</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a>
<a name="line-51"></a><a name="addTick"></a><span class='hs-comment'>-- Don't use Map.unionWith because that's lazy, and we want to </span>
<a name="line-52"></a><span class='hs-comment'>-- be pretty strict here!</span>
<a name="line-53"></a><span class='hs-definition'>addTick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TickCounts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TickCounts</span>
<a name="line-54"></a><span class='hs-definition'>addTick</span> <span class='hs-varid'>fm</span> <span class='hs-varid'>tick</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>fm</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>			<span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>tick</span> <span class='hs-num'>1</span> <span class='hs-varid'>fm</span>
<a name="line-56"></a>			<span class='hs-conid'>Just</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>n1</span> <span class='hs-varid'>fm</span>
<a name="line-57"></a>				<span class='hs-keyword'>where</span>
<a name="line-58"></a>				   <span class='hs-varid'>n1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span>
<a name="line-59"></a>
<a name="line-60"></a>
<a name="line-61"></a><a name="plusSimplCount"></a><span class='hs-definition'>plusSimplCount</span> <span class='hs-varid'>sc1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tks1</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dts1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-62"></a>	       <span class='hs-varid'>sc2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tks2</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dts2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>log_base</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tks1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>tks2</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>unionWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-varid'>dts1</span> <span class='hs-varid'>dts2</span> <span class='hs-layout'>}</span>
<a name="line-64"></a>  <span class='hs-keyword'>where</span>
<a name="line-65"></a>	<span class='hs-comment'>-- A hackish way of getting recent log info</span>
<a name="line-66"></a>    <span class='hs-varid'>log_base</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>log1</span> <span class='hs-varid'>sc2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc1</span>	<span class='hs-comment'>-- Nothing at all in sc2</span>
<a name="line-67"></a>	     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>log2</span> <span class='hs-varid'>sc2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc2</span> <span class='hs-layout'>{</span> <span class='hs-varid'>log2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>log1</span> <span class='hs-varid'>sc1</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>	     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc2</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>plusSimplCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerySimplCount</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerySimplCount</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VerySimplCount</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-definition'>plusSimplCount</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"plusSimplCount"</span>
<a name="line-72"></a>       <span class='hs-comment'>-- We use one or the other consistently</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="pprSimplCount"></a><span class='hs-definition'>pprSimplCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerySimplCount</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Total ticks:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-75"></a><span class='hs-definition'>pprSimplCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tks</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dts</span><span class='hs-layout'>,</span> <span class='hs-varid'>log1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span><span class='hs-layout'>,</span> <span class='hs-varid'>log2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Total ticks:    "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>tks</span><span class='hs-layout'>,</span>
<a name="line-77"></a>	  <span class='hs-varid'>blankLine</span><span class='hs-layout'>,</span>
<a name="line-78"></a>	  <span class='hs-varid'>pprTickCounts</span> <span class='hs-varid'>dts</span><span class='hs-layout'>,</span>
<a name="line-79"></a>	  <span class='hs-keyword'>if</span> <span class='hs-varid'>verboseSimplStats</span> <span class='hs-keyword'>then</span>
<a name="line-80"></a>		<span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>blankLine</span><span class='hs-layout'>,</span>
<a name="line-81"></a>		      <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Log (most recent first)"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-82"></a>		      <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>l1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-83"></a>	  <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span>
<a name="line-84"></a>    <span class='hs-keyglyph'>]</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="pprTickCounts"></a><span class='hs-definition'>pprTickCounts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Tick</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-87"></a><span class='hs-definition'>pprTickCounts</span> <span class='hs-varid'>counts</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTickGroup</span> <span class='hs-varid'>groups</span><span class='hs-layout'>)</span>
<a name="line-89"></a>  <span class='hs-keyword'>where</span>
<a name="line-90"></a>    <span class='hs-varid'>groups</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Tick</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Each group shares a comon tag</span>
<a name="line-91"></a>    	      			<span class='hs-comment'>-- toList returns common tags adjacent</span>
<a name="line-92"></a>    <span class='hs-varid'>groups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runs</span> <span class='hs-varid'>same_tag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>counts</span><span class='hs-layout'>)</span>
<a name="line-93"></a>    <span class='hs-varid'>same_tag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tick1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tick2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tickToTag</span> <span class='hs-varid'>tick1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tickToTag</span> <span class='hs-varid'>tick2</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="pprTickGroup"></a><span class='hs-definition'>pprTickGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Tick</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-96"></a><span class='hs-definition'>pprTickGroup</span> <span class='hs-varid'>group</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tick1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>sum</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>group</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickString</span> <span class='hs-varid'>tick1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-98"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTickCts</span> <span class='hs-varid'>tick</span>  
<a name="line-99"></a>                                    <span class='hs-comment'>-- flip as we want largest first</span>
<a name="line-100"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tick</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>group</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-definition'>pprTickGroup</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprTickGroup"</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="Tick"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Tick</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PreInlineUnconditionally</span>	<span class='hs-conid'>Id</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PostInlineUnconditionally</span>	<span class='hs-conid'>Id</span>
<a name="line-4"></a>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnfoldingDone</span>    		<span class='hs-conid'>Id</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuleFired</span>			<span class='hs-conid'>FastString</span>	<span class='hs-comment'>-- Rule name</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LetFloatFromLet</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EtaExpansion</span>		<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- LHS binder</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EtaReduction</span>		<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Binder on outer lambda</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BetaReduction</span>		<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Lambda binder</span>
<a name="line-12"></a>
<a name="line-13"></a>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseOfCase</span>			<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Bndr on *inner* case</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KnownBranch</span>			<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Case binder</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseMerge</span>			<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Binder on outer case</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AltMerge</span>			<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Case binder</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseElim</span>			<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Case binder</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseIdentity</span>		<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Case binder</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FillInCaseDefault</span>		<span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Case binder</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BottomFound</span>		
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SimplifierDone</span>		<span class='hs-comment'>-- Ticked at each iteration of the simplifier</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Tick</span> <span class='hs-keyword'>where</span>
<a name="line-26"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>tick</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickString</span> <span class='hs-varid'>tick</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTickCts</span> <span class='hs-varid'>tick</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>Tick</span> <span class='hs-keyword'>where</span>
<a name="line-29"></a>  <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`cmpTick`</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-30"></a>           <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-31"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>Tick</span> <span class='hs-keyword'>where</span>
<a name="line-34"></a>  <span class='hs-varid'>compare</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmpTick</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="tickToTag"></a><span class='hs-definition'>tickToTag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-37"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>PreInlineUnconditionally</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-38"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>PostInlineUnconditionally</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-39"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfoldingDone</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span>
<a name="line-40"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleFired</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-num'>3</span>
<a name="line-41"></a><span class='hs-definition'>tickToTag</span> <span class='hs-conid'>LetFloatFromLet</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-42"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaExpansion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>5</span>
<a name="line-43"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaReduction</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>6</span>
<a name="line-44"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>BetaReduction</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>7</span>
<a name="line-45"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseOfCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>8</span>
<a name="line-46"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>KnownBranch</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>9</span>
<a name="line-47"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseMerge</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-num'>10</span>
<a name="line-48"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseElim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-num'>11</span>
<a name="line-49"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseIdentity</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>12</span>
<a name="line-50"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>FillInCaseDefault</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>13</span>
<a name="line-51"></a><span class='hs-definition'>tickToTag</span> <span class='hs-conid'>BottomFound</span>			<span class='hs-keyglyph'>=</span> <span class='hs-num'>14</span>
<a name="line-52"></a><span class='hs-definition'>tickToTag</span> <span class='hs-conid'>SimplifierDone</span>		<span class='hs-keyglyph'>=</span> <span class='hs-num'>16</span>
<a name="line-53"></a><span class='hs-definition'>tickToTag</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltMerge</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-num'>17</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="tickString"></a><span class='hs-definition'>tickString</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-56"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>PreInlineUnconditionally</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-str'>"PreInlineUnconditionally"</span>
<a name="line-57"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>PostInlineUnconditionally</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-str'>"PostInlineUnconditionally"</span>
<a name="line-58"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfoldingDone</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"UnfoldingDone"</span>
<a name="line-59"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleFired</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"RuleFired"</span>
<a name="line-60"></a><span class='hs-definition'>tickString</span> <span class='hs-conid'>LetFloatFromLet</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"LetFloatFromLet"</span>
<a name="line-61"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaExpansion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"EtaExpansion"</span>
<a name="line-62"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaReduction</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"EtaReduction"</span>
<a name="line-63"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>BetaReduction</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"BetaReduction"</span>
<a name="line-64"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseOfCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"CaseOfCase"</span>
<a name="line-65"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>KnownBranch</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"KnownBranch"</span>
<a name="line-66"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseMerge</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"CaseMerge"</span>
<a name="line-67"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltMerge</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-str'>"AltMerge"</span>
<a name="line-68"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseElim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-str'>"CaseElim"</span>
<a name="line-69"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseIdentity</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"CaseIdentity"</span>
<a name="line-70"></a><span class='hs-definition'>tickString</span> <span class='hs-layout'>(</span><span class='hs-conid'>FillInCaseDefault</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-str'>"FillInCaseDefault"</span>
<a name="line-71"></a><span class='hs-definition'>tickString</span> <span class='hs-conid'>BottomFound</span>			<span class='hs-keyglyph'>=</span> <span class='hs-str'>"BottomFound"</span>
<a name="line-72"></a><span class='hs-definition'>tickString</span> <span class='hs-conid'>SimplifierDone</span>		<span class='hs-keyglyph'>=</span> <span class='hs-str'>"SimplifierDone"</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="pprTickCts"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-75"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>PreInlineUnconditionally</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-76"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>PostInlineUnconditionally</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-77"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfoldingDone</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-78"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleFired</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-79"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-conid'>LetFloatFromLet</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-80"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaExpansion</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-81"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaReduction</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-82"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>BetaReduction</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-83"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseOfCase</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-84"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>KnownBranch</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-85"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseMerge</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-86"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltMerge</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-87"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseElim</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-88"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseIdentity</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-89"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-layout'>(</span><span class='hs-conid'>FillInCaseDefault</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-90"></a><span class='hs-definition'>pprTickCts</span> <span class='hs-keyword'>_</span>    			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="cmpTick"></a><span class='hs-definition'>cmpTick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-93"></a><span class='hs-definition'>cmpTick</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>tickToTag</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>tickToTag</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-94"></a>		<span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GT</span>
<a name="line-95"></a>		<span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmpEqTick</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-96"></a>		<span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LT</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="cmpEqTick"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Tick</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ordering</span>
<a name="line-99"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>PreInlineUnconditionally</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>	<span class='hs-layout'>(</span><span class='hs-conid'>PreInlineUnconditionally</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-100"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>PostInlineUnconditionally</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>	<span class='hs-layout'>(</span><span class='hs-conid'>PostInlineUnconditionally</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-101"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnfoldingDone</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>UnfoldingDone</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-102"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleFired</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>			<span class='hs-layout'>(</span><span class='hs-conid'>RuleFired</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-103"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaExpansion</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>EtaExpansion</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-104"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>EtaReduction</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>EtaReduction</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-105"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>BetaReduction</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>BetaReduction</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-106"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseOfCase</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>CaseOfCase</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-107"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>KnownBranch</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>KnownBranch</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-108"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseMerge</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>			<span class='hs-layout'>(</span><span class='hs-conid'>CaseMerge</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-109"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltMerge</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>			<span class='hs-layout'>(</span><span class='hs-conid'>AltMerge</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-110"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseElim</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>			<span class='hs-layout'>(</span><span class='hs-conid'>CaseElim</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-111"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseIdentity</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>CaseIdentity</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-112"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-layout'>(</span><span class='hs-conid'>FillInCaseDefault</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-layout'>(</span><span class='hs-conid'>FillInCaseDefault</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span>
<a name="line-113"></a><span class='hs-definition'>cmpEqTick</span> <span class='hs-keyword'>_</span>     			<span class='hs-keyword'>_</span>     				<span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
</pre>\end{code}


%************************************************************************
%*									*
             Monad and carried data structure definitions
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="CoreState"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>CoreState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreState</span> <span class='hs-layout'>{</span>
<a name="line-2"></a>        <span class='hs-varid'>cs_uniq_supply</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-3"></a><span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="CoreReader"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoreReader</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreReader</span> <span class='hs-layout'>{</span>
<a name="line-6"></a>        <span class='hs-varid'>cr_hsc_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-varid'>cr_rule_base</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RuleBase</span><span class='hs-layout'>,</span>
<a name="line-8"></a>        <span class='hs-varid'>cr_module</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>
<a name="line-9"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-10"></a>        <span class='hs-varid'>cr_globals</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>PersistentLinkerState</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-cpp'>#else</span>
<a name="line-12"></a>        <span class='hs-varid'>cr_globals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>()</span>
<a name="line-13"></a><span class='hs-cpp'>#endif</span>
<a name="line-14"></a><span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="CoreWriter"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoreWriter</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreWriter</span> <span class='hs-layout'>{</span>
<a name="line-17"></a>        <span class='hs-varid'>cw_simpl_count</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>SimplCount</span>  
<a name="line-18"></a>        <span class='hs-comment'>-- Making this strict fixes a nasty space leak</span>
<a name="line-19"></a>        <span class='hs-comment'>-- See Trac #7702</span>
<a name="line-20"></a><span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="emptyWriter"></a><span class='hs-definition'>emptyWriter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreWriter</span>
<a name="line-23"></a><span class='hs-definition'>emptyWriter</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreWriter</span> <span class='hs-layout'>{</span>
<a name="line-24"></a>        <span class='hs-varid'>cw_simpl_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zeroSimplCount</span> <span class='hs-varid'>dflags</span>
<a name="line-25"></a>    <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="plusWriter"></a><span class='hs-definition'>plusWriter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreWriter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreWriter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreWriter</span>
<a name="line-28"></a><span class='hs-definition'>plusWriter</span> <span class='hs-varid'>w1</span> <span class='hs-varid'>w2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreWriter</span> <span class='hs-layout'>{</span>
<a name="line-29"></a>        <span class='hs-varid'>cw_simpl_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cw_simpl_count</span> <span class='hs-varid'>w1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`plusSimplCount`</span> <span class='hs-layout'>(</span><span class='hs-varid'>cw_simpl_count</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span>
<a name="line-30"></a>    <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="CoreIOEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoreIOEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IOEnv</span> <span class='hs-conid'>CoreReader</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="CoreM"></a><span class='hs-comment'>-- | The monad used by Core-to-Core passes to access common state, register simplification</span>
<a name="line-35"></a><a name="CoreM"></a><span class='hs-comment'>-- statistics and so on</span>
<a name="line-36"></a><a name="CoreM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>CoreM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unCoreM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreIOEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreState</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreWriter</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-39"></a>    <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ma</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-40"></a>        <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ma</span>
<a name="line-41"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nop</span> <span class='hs-varid'>s</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-45"></a>    <span class='hs-varid'>mx</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>w1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unCoreM</span> <span class='hs-varid'>mx</span> <span class='hs-varid'>s</span>
<a name="line-47"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>s''</span><span class='hs-layout'>,</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unCoreM</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>s'</span>
<a name="line-48"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w1</span> <span class='hs-varop'>`plusWriter`</span> <span class='hs-varid'>w2</span> <span class='hs-comment'>-- forcing w before returning avoids a space leak (Trac #7702)</span>
<a name="line-49"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>seq</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>s''</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>A</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-52"></a>    <span class='hs-varid'>pure</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-53"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadPlus</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>A</span><span class='hs-varop'>.</span><span class='hs-conid'>Alternative</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>empty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mzero</span>
<a name="line-57"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&lt;|&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mplus</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-comment'>-- For use if the user has imported Control.Monad.Error from MTL</span>
<a name="line-60"></a><span class='hs-comment'>-- Requires UndecidableInstances</span>
<a name="line-61"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadPlus</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadPlus</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-62"></a>    <span class='hs-varid'>mzero</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>mzero</span><span class='hs-layout'>)</span>
<a name="line-63"></a>    <span class='hs-varid'>m</span> <span class='hs-varop'>`mplus`</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>rs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unCoreM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>rs</span> <span class='hs-varop'>`mplus`</span> <span class='hs-varid'>unCoreM</span> <span class='hs-varid'>n</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-66"></a>    <span class='hs-varid'>getUniqueSupplyM</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-67"></a>        <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getS</span> <span class='hs-varid'>cs_uniq_supply</span>
<a name="line-68"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-69"></a>        <span class='hs-varid'>modifyS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_uniq_supply</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-70"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>us1</span>
<a name="line-71"></a>
<a name="line-72"></a>    <span class='hs-varid'>getUniqueM</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-73"></a>        <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getS</span> <span class='hs-varid'>cs_uniq_supply</span>
<a name="line-74"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span><span class='hs-varid'>us'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeUniqFromSupply</span> <span class='hs-varid'>us</span>
<a name="line-75"></a>        <span class='hs-varid'>modifyS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_uniq_supply</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-76"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>u</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="runCoreM"></a><span class='hs-definition'>runCoreM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-79"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleBase</span>
<a name="line-80"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-81"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-82"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-varid'>a</span>
<a name="line-83"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>SimplCount</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-definition'>runCoreM</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>rule_base</span> <span class='hs-varid'>us</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-85"></a>        <span class='hs-varid'>glbls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>saveLinkerGlobals</span>
<a name="line-86"></a>        <span class='hs-varid'>liftM</span> <span class='hs-varid'>extract</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runIOEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>reader</span> <span class='hs-varid'>glbls</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unCoreM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>state</span>
<a name="line-87"></a>  <span class='hs-keyword'>where</span>
<a name="line-88"></a>    <span class='hs-varid'>reader</span> <span class='hs-varid'>glbls</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreReader</span> <span class='hs-layout'>{</span>
<a name="line-89"></a>            <span class='hs-varid'>cr_hsc_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>,</span>
<a name="line-90"></a>            <span class='hs-varid'>cr_rule_base</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rule_base</span><span class='hs-layout'>,</span>
<a name="line-91"></a>            <span class='hs-varid'>cr_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span>
<a name="line-92"></a>            <span class='hs-varid'>cr_globals</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>glbls</span>
<a name="line-93"></a>        <span class='hs-layout'>}</span>
<a name="line-94"></a>    <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreState</span> <span class='hs-layout'>{</span> 
<a name="line-95"></a>            <span class='hs-varid'>cs_uniq_supply</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us</span>
<a name="line-96"></a>        <span class='hs-layout'>}</span>
<a name="line-97"></a>
<a name="line-98"></a>    <span class='hs-varid'>extract</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreState</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreWriter</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>SimplCount</span><span class='hs-layout'>)</span>
<a name="line-99"></a>    <span class='hs-varid'>extract</span> <span class='hs-layout'>(</span><span class='hs-varid'>value</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>writer</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>value</span><span class='hs-layout'>,</span> <span class='hs-varid'>cw_simpl_count</span> <span class='hs-varid'>writer</span><span class='hs-layout'>)</span>
<a name="line-100"></a>
</pre>\end{code}


%************************************************************************
%*									*
             Core combinators, not exported
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="nop"></a><span class='hs-definition'>nop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreIOEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreState</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreWriter</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>nop</span> <span class='hs-varid'>s</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>    <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEnv</span>
<a name="line-5"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWriter</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cr_hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="read"></a><span class='hs-definition'>read</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreReader</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-varid'>a</span>
<a name="line-8"></a><span class='hs-definition'>read</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getEnv</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nop</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="getS"></a><span class='hs-definition'>getS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-varid'>a</span>
<a name="line-11"></a><span class='hs-definition'>getS</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nop</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="modifyS"></a><span class='hs-definition'>modifyS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreState</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-14"></a><span class='hs-definition'>modifyS</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nop</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="write"></a><span class='hs-definition'>write</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreWriter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-17"></a><span class='hs-definition'>write</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
</pre>\end{code}

\subsection{Lifting IO into the monad}

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="liftIOEnv"></a><span class='hs-comment'>-- | Lift an 'IOEnv' operation into 'CoreM'</span>
<a name="line-3"></a><span class='hs-definition'>liftIOEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreIOEnv</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-varid'>a</span>
<a name="line-4"></a><span class='hs-definition'>liftIOEnv</span> <span class='hs-varid'>mx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mx</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nop</span> <span class='hs-varid'>s</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadIO</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIOEnv</span> <span class='hs-varop'>.</span> <span class='hs-conid'>IOEnv</span><span class='hs-varop'>.</span><span class='hs-varid'>liftIO</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="liftIOWithCount"></a><span class='hs-comment'>-- | Lift an 'IO' operation into 'CoreM' while consuming its 'SimplCount'</span>
<a name="line-10"></a><span class='hs-definition'>liftIOWithCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCount</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-varid'>a</span>
<a name="line-11"></a><span class='hs-definition'>liftIOWithCount</span> <span class='hs-varid'>what</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>count</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addSimplCount</span> <span class='hs-varid'>count</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
</pre>\end{code}


%************************************************************************
%*									*
             Reader, writer and state accessors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="getHscEnv"></a><span class='hs-definition'>getHscEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2"></a><span class='hs-definition'>getHscEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>read</span> <span class='hs-varid'>cr_hsc_env</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="getRuleBase"></a><span class='hs-definition'>getRuleBase</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>RuleBase</span>
<a name="line-5"></a><span class='hs-definition'>getRuleBase</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>read</span> <span class='hs-varid'>cr_rule_base</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="addSimplCount"></a><span class='hs-definition'>addSimplCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplCount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-8"></a><span class='hs-definition'>addSimplCount</span> <span class='hs-varid'>count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>write</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoreWriter</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cw_simpl_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>-- Convenience accessors for useful fields of HscEnv</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasDynFlags</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasModule</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>getModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>read</span> <span class='hs-varid'>cr_module</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="getOrigNameCache"></a><span class='hs-comment'>-- | The original name cache is the current mapping from 'Module' and</span>
<a name="line-19"></a><span class='hs-comment'>-- 'OccName' to a compiler-wide unique 'Name'</span>
<a name="line-20"></a><span class='hs-definition'>getOrigNameCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>OrigNameCache</span>
<a name="line-21"></a><span class='hs-definition'>getOrigNameCache</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-22"></a>    <span class='hs-varid'>nameCacheRef</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>hsc_NC</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-23"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>nsNames</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>nameCacheRef</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="getPackageFamInstEnv"></a><span class='hs-definition'>getPackageFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>PackageFamInstEnv</span>
<a name="line-26"></a><span class='hs-definition'>getPackageFamInstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-27"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-28"></a>    <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span>
<a name="line-29"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>eps_fam_inst_env</span> <span class='hs-varid'>eps</span>
</pre>\end{code}

%************************************************************************
%*									*
             Initializing globals
%*									*
%************************************************************************

This is a rather annoying function. When a plugin is loaded, it currently
gets linked against a *newly loaded* copy of the GHC package. This would
not be a problem, except that the new copy has its own mutable state
that is not shared with that state that has already been initialized by
the original GHC package.

(NB This mechanism is sufficient for granting plugins read-only access to
globals that are guaranteed to be initialized before the plugin is loaded.  If
any further synchronization is necessary, I would suggest using the more
sophisticated mechanism involving GHC.Conc.Sync.sharedCAF and rts/Globals.c to
share a single instance of the global variable among the compiler and the
plugins.  Perhaps we should migrate all global variables to use that mechanism,
for robustness... -- NSF July 2013)

This leads to loaded plugins calling GHC code which pokes the static flags,
and then dying with a panic because the static flags *it* sees are uninitialized.

There are two possible solutions:
  1. Export the symbols from the GHC executable from the GHC library and link
     against this existing copy rather than a new copy of the GHC library
  2. Carefully ensure that the global state in the two copies of the GHC
     library matches

I tried 1. and it *almost* works (and speeds up plugin load times!) except
on Windows. On Windows the GHC library tends to export more than 65536 symbols
(see #5292) which overflows the limit of what we can export from the EXE and
causes breakage.

(Note that if the GHC exeecutable was dynamically linked this wouldn't be a problem,
because we could share the GHC library it links to.)

We are going to try 2. instead. Unfortunately, this means that every plugin
will have to say `reinitializeGlobals` before it does anything, but never mind.

I've threaded the cr_globals through CoreM rather than giving them as an
argument to the plugin function so that we can turn this function into
(return ()) without breaking any plugins when we eventually get 1. working.

\begin{code}
<pre><a name="line-1"></a><a name="reinitializeGlobals"></a><span class='hs-definition'>reinitializeGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>reinitializeGlobals</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>    <span class='hs-varid'>linker_globals</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>read</span> <span class='hs-varid'>cr_globals</span>
<a name="line-4"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-5"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-6"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>restoreLinkerGlobals</span> <span class='hs-varid'>linker_globals</span>
<a name="line-7"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setUnsafeGlobalDynFlags</span> <span class='hs-varid'>dflags</span>
</pre>\end{code}

%************************************************************************
%*									*
             Dealing with annotations
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="getAnnotations"></a><span class='hs-comment'>-- | Get all annotations of a given type. This happens lazily, that is</span>
<a name="line-2"></a><span class='hs-comment'>-- no deserialization will take place until the [a] is actually demanded and</span>
<a name="line-3"></a><span class='hs-comment'>-- the [a] can also be empty (the UniqFM is not filtered).</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- This should be done once at the start of a Core-to-Core pass that uses</span>
<a name="line-6"></a><span class='hs-comment'>-- annotations.</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- See Note [Annotations]</span>
<a name="line-9"></a><span class='hs-definition'>getAnnotations</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqFM</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>getAnnotations</span> <span class='hs-varid'>deserialize</span> <span class='hs-varid'>guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-11"></a>     <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-12"></a>     <span class='hs-varid'>ann_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prepareAnnotations</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>guts</span><span class='hs-layout'>)</span>
<a name="line-13"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>deserializeAnns</span> <span class='hs-varid'>deserialize</span> <span class='hs-varid'>ann_env</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="getFirstAnnotations"></a><span class='hs-comment'>-- | Get at most one annotation of a given type per Unique.</span>
<a name="line-16"></a><span class='hs-definition'>getFirstAnnotations</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqFM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>getFirstAnnotations</span> <span class='hs-varid'>deserialize</span> <span class='hs-varid'>guts</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapUFM</span> <span class='hs-varid'>head</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filterUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-varop'>$</span> <span class='hs-varid'>getAnnotations</span> <span class='hs-varid'>deserialize</span> <span class='hs-varid'>guts</span>
<a name="line-20"></a>  
</pre>\end{code}

Note [Annotations]
~~~~~~~~~~~~~~~~~~
A Core-to-Core pass that wants to make use of annotations calls
getAnnotations or getFirstAnnotations at the beginning to obtain a UniqFM with
annotations of a specific type. This produces all annotations from interface
files read so far. However, annotations from interface files read during the
pass will not be visible until getAnnotations is called again. This is similar
to how rules work and probably isn't too bad.

The current implementation could be optimised a bit: when looking up
annotations for a thing from the HomePackageTable, we could search directly in
the module where the thing is defined rather than building one UniqFM which
contains all annotations we know of. This would work because annotations can
only be given to things defined in the same module. However, since we would
only want to deserialise every annotation once, we would have to build a cache
for every module in the HTP. In the end, it's probably not worth it as long as
we aren't using annotations heavily.

%************************************************************************
%*									*
                Direct screen output
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="msg"></a><span class='hs-definition'>msg</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>msg</span> <span class='hs-varid'>how</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-5"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>how</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>doc</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="putMsgS"></a><span class='hs-comment'>-- | Output a String message to the screen</span>
<a name="line-8"></a><span class='hs-definition'>putMsgS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-9"></a><span class='hs-definition'>putMsgS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putMsg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>text</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="putMsg"></a><span class='hs-comment'>-- | Output a message to the screen</span>
<a name="line-12"></a><span class='hs-definition'>putMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-13"></a><span class='hs-definition'>putMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>putMsg</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="errorMsgS"></a><span class='hs-comment'>-- | Output a string error to the screen</span>
<a name="line-16"></a><span class='hs-definition'>errorMsgS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-17"></a><span class='hs-definition'>errorMsgS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>errorMsg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>text</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="errorMsg"></a><span class='hs-comment'>-- | Output an error to the screen</span>
<a name="line-20"></a><span class='hs-definition'>errorMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-21"></a><span class='hs-definition'>errorMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>errorMsg</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="fatalErrorMsgS"></a><span class='hs-comment'>-- | Output a fatal string error to the screen. Note this does not by itself cause the compiler to die</span>
<a name="line-24"></a><span class='hs-definition'>fatalErrorMsgS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-25"></a><span class='hs-definition'>fatalErrorMsgS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fatalErrorMsg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>text</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="fatalErrorMsg"></a><span class='hs-comment'>-- | Output a fatal error to the screen. Note this does not by itself cause the compiler to die</span>
<a name="line-28"></a><span class='hs-definition'>fatalErrorMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-29"></a><span class='hs-definition'>fatalErrorMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>fatalErrorMsg</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="debugTraceMsgS"></a><span class='hs-comment'>-- | Output a string debugging message at verbosity level of @-v@ or higher</span>
<a name="line-32"></a><span class='hs-definition'>debugTraceMsgS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-33"></a><span class='hs-definition'>debugTraceMsgS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>debugTraceMsg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>text</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="debugTraceMsg"></a><span class='hs-comment'>-- | Outputs a debugging message at verbosity level of @-v@ or higher</span>
<a name="line-36"></a><span class='hs-definition'>debugTraceMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-37"></a><span class='hs-definition'>debugTraceMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>debugTraceMsg</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="dumpIfSet_dyn"></a><span class='hs-comment'>-- | Show some labelled 'SDoc' if a particular flag is set or at a verbosity level of @-v -ddump-most@ or higher</span>
<a name="line-40"></a><span class='hs-definition'>dumpIfSet_dyn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DumpFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-conid'>()</span>
<a name="line-41"></a><span class='hs-definition'>dumpIfSet_dyn</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Err</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
               Finding TyThings
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadThings</span> <span class='hs-conid'>CoreM</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>    <span class='hs-varid'>lookupThing</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-4"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initTcForLookup</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLookupGlobal</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
               Template Haskell interoperability
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-cpp'>#</span><span class='hs-varid'>ifdef</span> <span class='hs-conid'>GHCI</span>
<a name="line-2"></a><a name="thNameToGhcName"></a><span class='hs-comment'>-- | Attempt to convert a Template Haskell name to one that GHC can</span>
<a name="line-3"></a><span class='hs-comment'>-- understand. Original TH names such as those you get when you use</span>
<a name="line-4"></a><span class='hs-comment'>-- the @'foo@ syntax will be translated to their equivalent GHC name</span>
<a name="line-5"></a><span class='hs-comment'>-- exactly. Qualified or unqualifed TH names will be dynamically bound</span>
<a name="line-6"></a><span class='hs-comment'>-- to names in the module being compiled, if possible. Exact TH names</span>
<a name="line-7"></a><span class='hs-comment'>-- will be bound to the name they represent, exactly.</span>
<a name="line-8"></a><span class='hs-definition'>thNameToGhcName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>thNameToGhcName</span> <span class='hs-varid'>th_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-10"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-11"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initTcForLookup</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupThName_maybe</span> <span class='hs-varid'>th_name</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}
</body>
</html>
