<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>deSugar/DsExpr.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Desugaring exporessions.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>DsExpr</span> <span class='hs-layout'>(</span> <span class='hs-varid'>dsExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsLExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsLocalBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsValBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsLit</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Match</span>
<a name="line-6"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MatchLit</span>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsBinds</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsGRHSs</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsListComp</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsUtils</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsArrows</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMonad</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>(</span> <span class='hs-varid'>topNormaliseType</span> <span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-18"></a>        <span class='hs-comment'>-- Template Haskell stuff iff bootstrapped</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DsMeta</span>
<a name="line-20"></a><span class='hs-cpp'>#endif</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-comment'>-- NB: The desugarer, which straddles the source and Core worlds, sometimes</span>
<a name="line-25"></a><span class='hs-comment'>--     needs to see source types</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreFVs</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                dsLocalBinds, dsValBinds
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dsLocalBinds"></a><span class='hs-definition'>dsLocalBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a><span class='hs-definition'>dsLocalBinds</span> <span class='hs-conid'>EmptyLocalBinds</span>    <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>body</span>
<a name="line-3"></a><span class='hs-definition'>dsLocalBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsValBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>body</span>
<a name="line-4"></a><span class='hs-definition'>dsLocalBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>  <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsIPBinds</span>  <span class='hs-varid'>binds</span> <span class='hs-varid'>body</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="dsValBinds"></a><span class='hs-comment'>-------------------------</span>
<a name="line-7"></a><span class='hs-definition'>dsValBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-8"></a><span class='hs-definition'>dsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>binds</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrM</span> <span class='hs-varid'>ds_val_bind</span> <span class='hs-varid'>body</span> <span class='hs-varid'>binds</span>
<a name="line-9"></a><span class='hs-definition'>dsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span>  <span class='hs-keyword'>_</span>     <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsValBinds ValBindsIn"</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="dsIPBinds"></a><span class='hs-comment'>-------------------------</span>
<a name="line-12"></a><span class='hs-definition'>dsIPBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsIPBinds</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-13"></a><span class='hs-definition'>dsIPBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>ip_binds</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ds_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsTcEvBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inner</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreLets</span> <span class='hs-varid'>ds_binds</span> <span class='hs-varid'>body</span>
<a name="line-16"></a>                <span class='hs-comment'>-- The dict bindings may not be in </span>
<a name="line-17"></a>                <span class='hs-comment'>-- dependency order; hence Rec</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>foldrM</span> <span class='hs-varid'>ds_ip_bind</span> <span class='hs-varid'>inner</span> <span class='hs-varid'>ip_binds</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>ds_ip_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-21"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>e</span>
<a name="line-22"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>n</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="ds_val_bind"></a><span class='hs-comment'>-------------------------</span>
<a name="line-25"></a><span class='hs-definition'>ds_val_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-26"></a><span class='hs-comment'>-- Special case for bindings which bind unlifted variables</span>
<a name="line-27"></a><span class='hs-comment'>-- We need to do a case right away, rather than building</span>
<a name="line-28"></a><span class='hs-comment'>-- a tuple and doing selections.</span>
<a name="line-29"></a><span class='hs-comment'>-- Silently ignore INLINE and SPECIALISE pragmas...</span>
<a name="line-30"></a><span class='hs-definition'>ds_val_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRecursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsbinds</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>hsbinds</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-comment'>-- Non-recursive, non-overloaded bindings only come in ones</span>
<a name="line-33"></a>        <span class='hs-comment'>-- ToDo: in some bizarre case it's conceivable that there</span>
<a name="line-34"></a>        <span class='hs-comment'>--       could be dict binds in the 'binds'.  (See the notes</span>
<a name="line-35"></a>        <span class='hs-comment'>--       below.  Then pattern-match would fail.  Urk.)</span>
<a name="line-36"></a>    <span class='hs-varid'>strictMatchOnly</span> <span class='hs-varid'>bind</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putSrcSpanDs</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsStrictBind</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-comment'>-- Ordinary case for bindings; none should be unlifted</span>
<a name="line-40"></a><span class='hs-definition'>ds_val_bind</span> <span class='hs-layout'>(</span><span class='hs-sel'>_is_rec</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLHsBinds</span> <span class='hs-varid'>binds</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-sel'>_is_rec</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>)</span>
<a name="line-43"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>prs</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>            <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>body</span>
<a name="line-45"></a>            <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>        <span class='hs-comment'>-- Use a Rec regardless of is_rec. </span>
<a name="line-47"></a>        <span class='hs-comment'>-- Why? Because it allows the binds to be all</span>
<a name="line-48"></a>        <span class='hs-comment'>-- mixed up, which is what happens in one rare case</span>
<a name="line-49"></a>        <span class='hs-comment'>-- Namely, for an AbsBind with no tyvars and no dicts,</span>
<a name="line-50"></a>        <span class='hs-comment'>--         but which does have dictionary bindings.</span>
<a name="line-51"></a>        <span class='hs-comment'>-- See notes with TcSimplify.inferLoop [NO TYVARS]</span>
<a name="line-52"></a>        <span class='hs-comment'>-- It turned out that wrapping a Rec here was the easiest solution</span>
<a name="line-53"></a>        <span class='hs-comment'>--</span>
<a name="line-54"></a>        <span class='hs-comment'>-- NB The previous case dealt with unlifted bindings, so we</span>
<a name="line-55"></a>        <span class='hs-comment'>--    only have to deal with lifted ones now; so Rec is ok</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="dsStrictBind"></a><span class='hs-comment'>------------------</span>
<a name="line-58"></a><span class='hs-definition'>dsStrictBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-59"></a><span class='hs-definition'>dsStrictBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-60"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span>
<a name="line-61"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span>
<a name="line-62"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lbinds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>body1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>bind_export</span> <span class='hs-varid'>body</span> <span class='hs-varid'>exports</span>
<a name="line-64"></a>             <span class='hs-varid'>bind_export</span> <span class='hs-varid'>export</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindNonRec</span> <span class='hs-layout'>(</span><span class='hs-varid'>abe_poly</span> <span class='hs-varid'>export</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-layout'>(</span><span class='hs-varid'>abe_mono</span> <span class='hs-varid'>export</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>body2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldlBagM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>body</span> <span class='hs-varid'>lbind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dsStrictBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>lbind</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-66"></a>                            <span class='hs-varid'>body1</span> <span class='hs-varid'>lbinds</span> 
<a name="line-67"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ds_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsTcEvBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoreLets</span> <span class='hs-varid'>ds_binds</span> <span class='hs-varid'>body2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>dsStrictBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_fn</span> 
<a name="line-71"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>fun_tick</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tick</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_infix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inf</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-72"></a>                <span class='hs-comment'>-- Can't be a bang pattern (that looks like a PatBind)</span>
<a name="line-73"></a>                <span class='hs-comment'>-- so must be simply unboxed</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchWrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunRhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>)</span> <span class='hs-varid'>inf</span><span class='hs-layout'>)</span> <span class='hs-varid'>matches</span>
<a name="line-75"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span> <span class='hs-comment'>-- Functions aren't lifted</span>
<a name="line-76"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isIdHsWrapper</span> <span class='hs-varid'>co_fn</span> <span class='hs-layout'>)</span>
<a name="line-77"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOptTickBox</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>rhs</span>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindNonRec</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-definition'>dsStrictBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span><span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span>     <span class='hs-comment'>-- let C x# y# = rhs in body</span>
<a name="line-82"></a>        <span class='hs-comment'>-- ==&gt; case rhs of C x# y# -&gt; body</span>
<a name="line-83"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsGuarded</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>ty</span>
<a name="line-84"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>upat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>pat</span>
<a name="line-85"></a>             <span class='hs-varid'>eqn</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EqnInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eqn_pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>upat</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> 
<a name="line-86"></a>                             <span class='hs-varid'>eqn_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cantFailMatchResult</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span>
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectMatchVar</span> <span class='hs-varid'>upat</span>
<a name="line-88"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchEquations</span> <span class='hs-conid'>PatBindRhs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eqn</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-89"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindNonRec</span> <span class='hs-varid'>var</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>
<a name="line-91"></a><span class='hs-definition'>dsStrictBind</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dsLet: unlifted"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="strictMatchOnly"></a><span class='hs-comment'>----------------------</span>
<a name="line-94"></a><span class='hs-definition'>strictMatchOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-95"></a><span class='hs-definition'>strictMatchOnly</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lbinds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>strictMatchOnly</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>lbinds</span>
<a name="line-97"></a><span class='hs-definition'>strictMatchOnly</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lpat</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-99"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>isStrictLPat</span> <span class='hs-varid'>lpat</span>
<a name="line-100"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>lpat</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-definition'>strictMatchOnly</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-103"></a><span class='hs-definition'>strictMatchOnly</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- I hope!  Checked immediately by caller in fact</span>
<a name="line-104"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[DsExpr-vars-and-cons]{Variables, constructors, literals}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dsLExpr"></a><span class='hs-definition'>dsLExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>dsLExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putSrcSpanDs</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>e</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="dsExpr"></a><span class='hs-definition'>dsExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-6"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>e</span>
<a name="line-7"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySigOut</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>e</span>
<a name="line-8"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>varToCoreExpr</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- See Note [Desugaring vars]</span>
<a name="line-9"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr: HsIPVar"</span>
<a name="line-10"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsLit</span> <span class='hs-varid'>lit</span>
<a name="line-11"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsOverLit</span> <span class='hs-varid'>lit</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>e</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapped_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsWrapper</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>e'</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warnAboutIdentities</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>wrapped_e</span><span class='hs-layout'>)</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>wrapped_e</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>neg_expr</span><span class='hs-layout'>)</span> 
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>App</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>neg_expr</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>a_Match</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uncurry</span> <span class='hs-varid'>mkLams</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>matchWrapper</span> <span class='hs-conid'>LambdaExpr</span> <span class='hs-varid'>a_Match</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-varid'>arg</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>discrim_var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>matching_code</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchWrapper</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>matches</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>arg_var</span> <span class='hs-varop'>$</span> <span class='hs-varid'>bindNonRec</span> <span class='hs-varid'>discrim_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>arg_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>matching_code</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreAppDs</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&lt;*&gt;</span>  <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>arg</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnboundVar</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr: HsUnboundVar"</span>
</pre>\end{code}

Note [Desugaring vars]
~~~~~~~~~~~~~~~~~~~~~~
In one situation we can get a *coercion* variable in a HsVar, namely
the support method for an equality superclass:
   class (a~b) => C a b where ...
   instance (blah) => C (T a) (T b) where ..
Then we get
   $dfCT :: forall ab. blah => C (T a) (T b)
   $dfCT ab blah = MkC ($c$p1C a blah) ($cop a blah)

   $c$p1C :: forall ab. blah => (T a ~ T b)
   $c$p1C ab blah = let ...; g :: T a ~ T b = ... } in g

That 'g' in the 'in' part is an evidence variable, and when
converting to core it must become a CO.
   
Operator sections.  At first it looks as if we can convert
\begin{verbatim}
        (expr op)
\end{verbatim}
to
\begin{verbatim}
        \x -> op expr x
\end{verbatim}

But no!  expr might be a redex, and we can lose laziness badly this
way.  Consider
\begin{verbatim}
        map (expr op) xs
\end{verbatim}
for example.  So we convert instead to
\begin{verbatim}
        let y = expr in \x -> op y x
\end{verbatim}
If \tr{expr} is actually just a variable, say, then the simplifier
will sort it out.

\begin{code}
<pre><a name="line-1"></a><a name="dsExpr"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- for the type of y, we need the type of op's 2nd argument</span>
<a name="line-3"></a>    <span class='hs-varid'>mkCoreAppsDs</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>op</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span> <span class='hs-varid'>e2</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>    
<a name="line-5"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- Desugar (e !) to ((!) e)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoreAppDs</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>op</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>-- dsLExpr (SectionR op expr)   -- \ x -&gt; op x expr</span>
<a name="line-9"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>op</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-10"></a>    <span class='hs-varid'>core_op</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>op</span>
<a name="line-11"></a>    <span class='hs-comment'>-- for the type of x, we need the type of op's 2nd argument</span>
<a name="line-12"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>x_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>y_ty</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>core_op</span><span class='hs-layout'>)</span>
<a name="line-13"></a>        <span class='hs-comment'>-- See comment with SectionL</span>
<a name="line-14"></a>    <span class='hs-varid'>y_core</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-15"></a>    <span class='hs-varid'>x_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-varid'>x_ty</span>
<a name="line-16"></a>    <span class='hs-varid'>y_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-varid'>y_ty</span>
<a name="line-17"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindNonRec</span> <span class='hs-varid'>y_id</span> <span class='hs-varid'>y_core</span> <span class='hs-varop'>$</span>
<a name="line-18"></a>            <span class='hs-conid'>Lam</span> <span class='hs-varid'>x_id</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoreAppsDs</span> <span class='hs-varid'>core_op</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span> <span class='hs-varid'>x_id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>y_id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>lam_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                    <span class='hs-comment'>-- For every missing expression, we need</span>
<a name="line-23"></a>                    <span class='hs-comment'>-- another lambda in the desugaring.</span>
<a name="line-24"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lam_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lam_var</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lam_vars</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>lam_var</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>             <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>lam_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                    <span class='hs-comment'>-- Expressions that are present don't generate</span>
<a name="line-28"></a>                    <span class='hs-comment'>-- lambdas, just arguments.</span>
<a name="line-29"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>core_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-30"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lam_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>core_expr</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lam_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tup_args</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                <span class='hs-comment'>-- The reverse is because foldM goes left-to-right</span>
<a name="line-34"></a>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkCoreLams</span> <span class='hs-varid'>lam_vars</span> <span class='hs-varop'>$</span> 
<a name="line-36"></a>                  <span class='hs-varid'>mkConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxityNormalTupleSort</span> <span class='hs-varid'>boxity</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tup_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varop'>.</span> <span class='hs-varid'>exprType</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-40"></a>    <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-41"></a>    <span class='hs-varid'>count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goptM</span> <span class='hs-conid'>Opt_ProfCountEntries</span>
<a name="line-42"></a>    <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-43"></a>    <span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProfNote</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUserCC</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-varid'>count</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>expr</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>discrim</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>core_discrim</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>discrim</span>
<a name="line-50"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>discrim_var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>matching_code</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchWrapper</span> <span class='hs-conid'>CaseAlt</span> <span class='hs-varid'>matches</span>
<a name="line-51"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindNonRec</span> <span class='hs-varid'>discrim_var</span> <span class='hs-varid'>core_discrim</span> <span class='hs-varid'>matching_code</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-comment'>-- Pepe: The binds are in scope in the body but NOT in the binding group</span>
<a name="line-54"></a><span class='hs-comment'>--       This is to avoid silliness in breakpoints</span>
<a name="line-55"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-56"></a>    <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>body</span>
<a name="line-57"></a>    <span class='hs-varid'>dsLocalBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>body'</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-comment'>-- We need the `ListComp' form to use `deListComp' (rather than the "do" form)</span>
<a name="line-60"></a><span class='hs-comment'>-- because the interpretation of `stmts' depends on what sort of thing it is.</span>
<a name="line-61"></a><span class='hs-comment'>--</span>
<a name="line-62"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>ListComp</span>     <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsListComp</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>res_ty</span>
<a name="line-63"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>PArrComp</span>     <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsPArrComp</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>DoExpr</span>       <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsDo</span> <span class='hs-varid'>stmts</span> 
<a name="line-65"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>GhciStmtCtxt</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsDo</span> <span class='hs-varid'>stmts</span> 
<a name="line-66"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>MDoExpr</span>      <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsDo</span> <span class='hs-varid'>stmts</span> 
<a name="line-67"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-conid'>MonadComp</span>    <span class='hs-varid'>stmts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsMonadComp</span> <span class='hs-varid'>stmts</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-varid'>mb_fun</span> <span class='hs-varid'>guard_expr</span> <span class='hs-varid'>then_expr</span> <span class='hs-varid'>else_expr</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>guard_expr</span>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>then_expr</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>else_expr</span>
<a name="line-73"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_fun</span> <span class='hs-keyword'>of</span>
<a name="line-74"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>core_fun</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>fun</span>
<a name="line-75"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoreApps</span> <span class='hs-varid'>core_fun</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span><span class='hs-varid'>b1</span><span class='hs-layout'>,</span><span class='hs-varid'>b2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-76"></a>           <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkIfThenElse</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span> <span class='hs-layout'>}</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>alts</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorExpr</span>
<a name="line-81"></a>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>match_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr1</span> <span class='hs-varid'>combineMatchResults</span><span class='hs-layout'>)</span>
<a name="line-84"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>dsGRHS</span> <span class='hs-conid'>IfAlt</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>error_expr</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkErrorExpr</span>
<a name="line-86"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>extractMatchResult</span> <span class='hs-varid'>match_result</span> <span class='hs-varid'>error_expr</span> <span class='hs-layout'>}</span>
<a name="line-87"></a>  <span class='hs-keyword'>where</span>
<a name="line-88"></a>    <span class='hs-varid'>mkErrorExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorAppDs</span> <span class='hs-varid'>nON_EXHAUSTIVE_GUARDS_ERROR_ID</span> <span class='hs-varid'>res_ty</span>
<a name="line-89"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"multi-way if"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


\noindent
\underline{\bf Various data construction things}
%              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\begin{code}
<pre><a name="line-1"></a><a name="dsExpr"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>wit</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> 
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsExplicitList</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>wit</span> <span class='hs-varid'>xs</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-- We desugar [:x1, ..., xn:] as</span>
<a name="line-5"></a><span class='hs-comment'>--   singletonP x1 +:+ ... +:+ singletonP xn</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-8"></a>    <span class='hs-varid'>emptyP</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsDPHBuiltin</span> <span class='hs-varid'>emptyPVar</span>
<a name="line-9"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>emptyP</span> <span class='hs-varop'>`App`</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-11"></a>    <span class='hs-varid'>singletonP</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsDPHBuiltin</span> <span class='hs-varid'>singletonPVar</span>
<a name="line-12"></a>    <span class='hs-varid'>appP</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsDPHBuiltin</span> <span class='hs-varid'>appPVar</span>
<a name="line-13"></a>    <span class='hs-varid'>xs'</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>xs</span>
<a name="line-14"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>foldr1</span> <span class='hs-layout'>(</span><span class='hs-varid'>binary</span> <span class='hs-varid'>appP</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>unary</span> <span class='hs-varid'>singletonP</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs'</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>unary</span>  <span class='hs-varid'>fn</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>    <span class='hs-varid'>binary</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>y</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>witness</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>witness</span> <span class='hs-keyword'>of</span>
<a name="line-21"></a>     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dsArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>seq</span>
<a name="line-22"></a>     <span class='hs-conid'>Just</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> 
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>fl</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>newArithSeq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>seq</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fl'</span> <span class='hs-varid'>newArithSeq</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-varid'>to</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>from</span> <span class='hs-varid'>thn</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-varid'>thn</span><span class='hs-layout'>,</span> <span class='hs-varid'>to</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"DsExpr.dsExpr: Infinite parallel array!"</span>
<a name="line-35"></a>    <span class='hs-comment'>-- the parser shouldn't have generated it and the renamer and typechecker</span>
<a name="line-36"></a>    <span class='hs-comment'>-- shouldn't have let it through</span>
</pre>\end{code}

\noindent
\underline{\bf Record construction and update}
%              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For record construction we do this (assuming T has three arguments)
\begin{verbatim}
        T { op2 = e }
==>
        let err = /\a -> recConErr a 
        T (recConErr t1 "M.lhs/230/op1") 
          e 
          (recConErr t1 "M.lhs/230/op3")
\end{verbatim}
@recConErr@ then converts its arugment string into a proper message
before printing it as
\begin{verbatim}
        M.lhs, line 230: missing field op1 was evaluated
\end{verbatim}

We also handle @C{}@ as valid construction syntax for an unlabelled
constructor @C@, setting all of @C@'s fields to bottom.

\begin{code}
<pre><a name="line-1"></a><a name="dsExpr"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>data_con_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>con_expr</span> <span class='hs-varid'>rbinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2"></a>    <span class='hs-varid'>con_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>con_expr</span>
<a name="line-3"></a>    <span class='hs-keyword'>let</span>
<a name="line-4"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>con_expr'</span><span class='hs-layout'>)</span>
<a name="line-5"></a>        <span class='hs-comment'>-- A newtype in the corner should be opaque; </span>
<a name="line-6"></a>        <span class='hs-comment'>-- hence TcType.tcSplitFunTys</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-varid'>mk_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Selector id has the field label as its name</span>
<a name="line-9"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findField</span> <span class='hs-layout'>(</span><span class='hs-varid'>rec_flds</span> <span class='hs-varid'>rbinds</span><span class='hs-layout'>)</span> <span class='hs-varid'>lbl</span> <span class='hs-keyword'>of</span>
<a name="line-10"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>rhs</span><span class='hs-conop'>:</span><span class='hs-varid'>rhss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>rhss</span> <span class='hs-layout'>)</span>
<a name="line-11"></a>                            <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-12"></a>              <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkErrorAppDs</span> <span class='hs-varid'>rEC_CON_ERROR_ID</span> <span class='hs-varid'>arg_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span>
<a name="line-13"></a>        <span class='hs-varid'>unlabelled_bottom</span> <span class='hs-varid'>arg_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorAppDs</span> <span class='hs-varid'>rEC_CON_ERROR_ID</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>empty</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-varid'>labels</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-layout'>(</span><span class='hs-varid'>idDataCon</span> <span class='hs-varid'>data_con_id</span><span class='hs-layout'>)</span>
<a name="line-16"></a>        <span class='hs-comment'>-- The data_con_id is guaranteed to be the wrapper id of the constructor</span>
<a name="line-17"></a>    
<a name="line-18"></a>    <span class='hs-varid'>con_args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>labels</span>
<a name="line-19"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>unlabelled_bottom</span> <span class='hs-varid'>arg_tys</span>
<a name="line-20"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mk_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"dsExpr:RecordCon"</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>labels</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    
<a name="line-22"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkApps</span> <span class='hs-varid'>con_expr'</span> <span class='hs-varid'>con_args</span><span class='hs-layout'>)</span>
</pre>\end{code}

Record update is a little harder. Suppose we have the decl:
\begin{verbatim}
        data T = T1 {op1, op2, op3 :: Int}
               | T2 {op4, op2 :: Int}
               | T3
\end{verbatim}
Then we translate as follows:
\begin{verbatim}
        r { op2 = e }
===>
        let op2 = e in
        case r of
          T1 op1 _ op3 -> T1 op1 op2 op3
          T2 op4 _     -> T2 op4 op2
          other        -> recUpdError "M.lhs/230"
\end{verbatim}
It's important that we use the constructor Ids for @T1@, @T2@ etc on the
RHSs, and do not generate a Core constructor application directly, because the constructor
might do some argument-evaluation first; and may have to throw away some
dictionaries.

Note [Update for GADTs]
~~~~~~~~~~~~~~~~~~~~~~~
Consider 
   data T a b where
     T1 { f1 :: a } :: T a Int

Then the wrapper function for T1 has type 
   $WT1 :: a -> T a Int
But if x::T a b, then
   x { f1 = v } :: T a b   (not T a Int!)
So we need to cast (T a Int) to (T a b).  Sigh.

\begin{code}
<pre><a name="line-1"></a><a name="dsExpr"></a><span class='hs-definition'>dsExpr</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>record_expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fields</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2"></a>                       <span class='hs-varid'>cons_to_upd</span> <span class='hs-varid'>in_inst_tys</span> <span class='hs-varid'>out_inst_tys</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fields</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>record_expr</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>notNull</span> <span class='hs-varid'>cons_to_upd</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>record_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>record_expr</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>field_binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>ds_field</span> <span class='hs-varid'>fields</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>upd_fld_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>Id</span> <span class='hs-comment'>-- Maps field name to the LocalId of the field binding</span>
<a name="line-11"></a>              <span class='hs-varid'>upd_fld_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>field_binds'</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-comment'>-- It's important to generate the match with matchWrapper,</span>
<a name="line-14"></a>        <span class='hs-comment'>-- and the right hand sides with applications of the wrapper Id</span>
<a name="line-15"></a>        <span class='hs-comment'>-- so that everything works when we are doing fancy unboxing on the</span>
<a name="line-16"></a>        <span class='hs-comment'>-- constructor aguments.</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>alts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_alt</span> <span class='hs-varid'>upd_fld_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons_to_upd</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>discrim_var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>matching_code</span><span class='hs-layout'>)</span> 
<a name="line-19"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchWrapper</span> <span class='hs-conid'>RecUpd</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alts</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>in_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>out_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Generated</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_field_binds</span> <span class='hs-varid'>field_binds'</span> <span class='hs-varop'>$</span>
<a name="line-22"></a>                  <span class='hs-varid'>bindNonRec</span> <span class='hs-varid'>discrim_var</span> <span class='hs-varid'>record_expr'</span> <span class='hs-varid'>matching_code</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>  <span class='hs-keyword'>where</span>
<a name="line-24"></a>    <span class='hs-varid'>ds_field</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsRecField</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-25"></a>      <span class='hs-comment'>-- Clone the Id in the HsRecField, because its Name is that</span>
<a name="line-26"></a>      <span class='hs-comment'>-- of the record selector, and we must not make that a lcoal binder</span>
<a name="line-27"></a>      <span class='hs-comment'>-- else we shadow other uses of the record selector</span>
<a name="line-28"></a>      <span class='hs-comment'>-- Hence 'lcl_id'.  Cf Trac #2735</span>
<a name="line-29"></a>    <span class='hs-varid'>ds_field</span> <span class='hs-varid'>rec_field</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsRecFieldArg</span> <span class='hs-varid'>rec_field</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fld_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsRecFieldId</span> <span class='hs-varid'>rec_field</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>lcl_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>fld_id</span><span class='hs-layout'>)</span>
<a name="line-32"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>fld_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcl_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a>    <span class='hs-varid'>add_field_binds</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span>
<a name="line-35"></a>    <span class='hs-varid'>add_field_binds</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindNonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_field_binds</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-comment'>-- Awkwardly, for families, the match goes </span>
<a name="line-38"></a>        <span class='hs-comment'>-- from instance type to family type</span>
<a name="line-39"></a>    <span class='hs-varid'>tycon</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>cons_to_upd</span><span class='hs-layout'>)</span>
<a name="line-40"></a>    <span class='hs-varid'>in_ty</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>in_inst_tys</span>
<a name="line-41"></a>    <span class='hs-varid'>out_ty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFamilyTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>out_inst_tys</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>mk_alt</span> <span class='hs-varid'>upd_fld_env</span> <span class='hs-varid'>con</span>
<a name="line-44"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> 
<a name="line-45"></a>                  <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>con</span>
<a name="line-46"></a>                 <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>in_inst_tys</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a>                <span class='hs-comment'>-- I'm not bothering to clone the ex_tvs</span>
<a name="line-49"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>eqs_vars</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newPredVarDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqSpecPreds</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-50"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>theta_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newPredVarDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-51"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>arg_ids</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalsDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-52"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"dsExpr:RecordUpd"</span> <span class='hs-varid'>mk_val_arg</span>
<a name="line-53"></a>                                         <span class='hs-layout'>(</span><span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_ids</span>
<a name="line-54"></a>                 <span class='hs-varid'>mk_val_arg</span> <span class='hs-varid'>field_name</span> <span class='hs-varid'>pat_arg_id</span> 
<a name="line-55"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>upd_fld_env</span> <span class='hs-varid'>field_name</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pat_arg_id</span><span class='hs-layout'>)</span>
<a name="line-56"></a>                 <span class='hs-varid'>inst_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsWrap</span> <span class='hs-varid'>wrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>                        <span class='hs-comment'>-- Reconstruct with the WrapId so that unpacking happens</span>
<a name="line-58"></a>                 <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>theta_vars</span>          <span class='hs-varop'>&lt;.&gt;</span>
<a name="line-59"></a>                        <span class='hs-varid'>mkWpTyApps</span>    <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;.&gt;</span>
<a name="line-60"></a>                        <span class='hs-varid'>mkWpTyApps</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>out_inst_tys</span>
<a name="line-61"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>wrap_subst</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-62"></a>                 <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nlHsApp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_con</span> <span class='hs-varid'>val_args</span>
<a name="line-63"></a>
<a name="line-64"></a>                        <span class='hs-comment'>-- Tediously wrap the application in a cast</span>
<a name="line-65"></a>                        <span class='hs-comment'>-- Note [Update for GADTs]</span>
<a name="line-66"></a>                 <span class='hs-varid'>wrap_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tycon</span>
<a name="line-67"></a>                                <span class='hs-keyglyph'>[</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>univ_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>out_inst_tys</span> <span class='hs-keyglyph'>]</span>
<a name="line-68"></a>                 <span class='hs-varid'>lookup</span> <span class='hs-varid'>univ_tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>wrap_subst</span> <span class='hs-varid'>univ_tv</span> <span class='hs-keyword'>of</span>
<a name="line-69"></a>                                        <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-70"></a>                                        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span>
<a name="line-71"></a>                 <span class='hs-varid'>wrap_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eq_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-72"></a>                                       <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>eq_var</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eq_spec</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>eqs_vars</span> <span class='hs-keyglyph'>]</span>
<a name="line-73"></a>
<a name="line-74"></a>                 <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ConPatOut</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-75"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>pat_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-76"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>pat_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs_vars</span> <span class='hs-varop'>++</span> <span class='hs-varid'>theta_vars</span>
<a name="line-77"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>pat_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcEvBinds</span>
<a name="line-78"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>pat_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PrefixCon</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>nlVarPat</span> <span class='hs-varid'>arg_ids</span>
<a name="line-79"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>pat_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_inst_tys</span>
<a name="line-80"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>pat_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span> <span class='hs-layout'>}</span>
<a name="line-81"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wrapped_rhs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eq_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span>
<a name="line-82"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLHsWrap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSubCo</span> <span class='hs-varid'>wrap_co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-83"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSimpleMatch</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pat</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>wrapped_rhs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-84"></a>
</pre>\end{code}

Here is where we desugar the Template Haskell brackets and escapes

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- Template Haskell stuff</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="dsExpr"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRnBracketOut</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr HsRnBracketOut"</span>
<a name="line-4"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-5"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsBracket</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ps</span>
<a name="line-6"></a><span class='hs-cpp'>#else</span>
<a name="line-7"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr HsBracketOut"</span>
<a name="line-8"></a><span class='hs-cpp'>#endif</span>
<a name="line-9"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dsExpr:splice"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>-- Arrow notation extension</span>
<a name="line-12"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsProcExpr</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>cmd</span>
</pre>\end{code}

Hpc Support 

\begin{code}
<pre><a name="line-1"></a><a name="dsExpr"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2"></a>  <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>e</span>
<a name="line-3"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>tickish</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>-- There is a problem here. The then and else branches</span>
<a name="line-6"></a><span class='hs-comment'>-- have no free variables, so they are open to lifting.</span>
<a name="line-7"></a><span class='hs-comment'>-- We need someway of stopping this.</span>
<a name="line-8"></a><span class='hs-comment'>-- This will make no difference to binary coverage</span>
<a name="line-9"></a><span class='hs-comment'>-- (did you go here: YES or NO), but will effect accurate</span>
<a name="line-10"></a><span class='hs-comment'>-- tick counting.</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBinTick</span> <span class='hs-varid'>ixT</span> <span class='hs-varid'>ixF</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-13"></a>  <span class='hs-varid'>e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>e</span>
<a name="line-14"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>e2</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>boolTy</span><span class='hs-layout'>)</span>
<a name="line-15"></a>       <span class='hs-varid'>mkBinaryTickBox</span> <span class='hs-varid'>ixT</span> <span class='hs-varid'>ixF</span> <span class='hs-varid'>e2</span>
<a name="line-16"></a>     <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="dsExpr"></a><span class='hs-comment'>-- HsSyn constructs that just shouldn't be here:</span>
<a name="line-3"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:ExprWithTySig"</span>
<a name="line-4"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBracket</span>     <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:HsBracket"</span>
<a name="line-5"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteE</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:HsQuasiQuoteE"</span>
<a name="line-6"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArrApp</span>      <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:HsArrApp"</span>
<a name="line-7"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArrForm</span>     <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:HsArrForm"</span>
<a name="line-8"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span>  <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:HsTickPragma"</span>
<a name="line-9"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EWildPat</span>      <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:EWildPat"</span>
<a name="line-10"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EAsPat</span>        <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:EAsPat"</span>
<a name="line-11"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EViewPat</span>      <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:EViewPat"</span>
<a name="line-12"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ELazyPat</span>      <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:ELazyPat"</span>
<a name="line-13"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span>        <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:HsType"</span>
<a name="line-14"></a><span class='hs-definition'>dsExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span>          <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsExpr:HsDo"</span>
<a name="line-15"></a>
<a name="line-16"></a>
<a name="line-17"></a><a name="findField"></a><span class='hs-definition'>findField</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsRecField</span> <span class='hs-conid'>Id</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a><span class='hs-definition'>findField</span> <span class='hs-varid'>rbinds</span> <span class='hs-varid'>lbl</span> 
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsRecField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rbinds</span> 
<a name="line-20"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>lbl</span> <span class='hs-varop'>==</span> <span class='hs-varid'>idName</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%--------------------------------------------------------------------

Note [Desugaring explicit lists]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Explicit lists are desugared in a cleverer way to prevent some
fruitless allocations.  Essentially, whenever we see a list literal
[x_1, ..., x_n] we:

1. Find the tail of the list that can be allocated statically (say
   [x_k, ..., x_n]) by later stages and ensure we desugar that
   normally: this makes sure that we don't cause a code size increase
   by having the cons in that expression fused (see later) and hence
   being unable to statically allocate any more

2. For the prefix of the list which cannot be allocated statically,
   say [x_1, ..., x_(k-1)], we turn it into an expression involving
   build so that if we find any foldrs over it it will fuse away
   entirely!
   
   So in this example we will desugar to:
   build (\c n -> x_1 `c` x_2 `c` .... `c` foldr c n [x_k, ..., x_n]
   
   If fusion fails to occur then build will get inlined and (since we
   defined a RULE for foldr (:) []) we will get back exactly the
   normal desugaring for an explicit list.

This optimisation can be worth a lot: up to 25% of the total
allocation in some nofib programs. Specifically

        Program           Size    Allocs   Runtime  CompTime
        rewrite          +0.0%    -26.3%      0.02     -1.8%
           ansi          -0.3%    -13.8%      0.00     +0.0%
           lift          +0.0%     -8.7%      0.00     -2.3%

Of course, if rules aren't turned on then there is pretty much no
point doing this fancy stuff, and it may even be harmful.

=======>  Note by SLPJ Dec 08.

I'm unconvinced that we should *ever* generate a build for an explicit
list.  See the comments in GHC.Base about the foldr/cons rule, which 
points out that (foldr k z [a,b,c]) may generate *much* less code than
(a `k` b `k` c `k` z).

Furthermore generating builds messes up the LHS of RULES. 
Example: the foldr/single rule in GHC.Base
   foldr k z [x] = ...
We do not want to generate a build invocation on the LHS of this RULE!

We fix this by disabling rules in rule LHSs, and testing that
flag here; see Note [Desugaring RULE left hand sides] in Desugar

To test this I've added a (static) flag -fsimple-list-literals, which
makes all list literals be generated via the simple route.  


\begin{code}
<pre><a name="line-1"></a><a name="dsExplicitList"></a><span class='hs-definition'>dsExplicitList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PostTcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [Desugaring explicit lists]</span>
<a name="line-3"></a><span class='hs-definition'>dsExplicitList</span> <span class='hs-varid'>elt_ty</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>xs</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>xs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>xs</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>dynamic_prefix</span><span class='hs-layout'>,</span> <span class='hs-varid'>static_suffix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spanTail</span> <span class='hs-varid'>is_static</span> <span class='hs-varid'>xs'</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_SimpleListLiterals</span> <span class='hs-varid'>dflags</span>        <span class='hs-comment'>-- -fsimple-list-literals</span>
<a name="line-8"></a>         <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_EnableRewriteRules</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Rewrite rules off</span>
<a name="line-9"></a>                <span class='hs-comment'>-- Don't generate a build if there are no rules to eliminate it!</span>
<a name="line-10"></a>                <span class='hs-comment'>-- See Note [Desugaring RULE left hand sides] in Desugar</span>
<a name="line-11"></a>         <span class='hs-varop'>||</span> <span class='hs-varid'>null</span> <span class='hs-varid'>dynamic_prefix</span>   <span class='hs-comment'>-- Avoid build (\c n. foldr c n xs)!</span>
<a name="line-12"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkListExpr</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>xs'</span>
<a name="line-13"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>mkBuildExpr</span> <span class='hs-varid'>elt_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSplitExplicitList</span> <span class='hs-varid'>dynamic_prefix</span> <span class='hs-varid'>static_suffix</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>is_static</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-16"></a>    <span class='hs-varid'>is_static</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>is_static_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprFreeVars</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>is_static_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-19"></a>    <span class='hs-varid'>is_static_var</span> <span class='hs-varid'>v</span> 
<a name="line-20"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Top-level things are given external names</span>
<a name="line-21"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>                   <span class='hs-comment'>-- Type variables</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>mkSplitExplicitList</span> <span class='hs-varid'>prefix</span> <span class='hs-varid'>suffix</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>n_ty</span><span class='hs-layout'>)</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>suffix'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkListExpr</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>suffix</span>
<a name="line-25"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>folded_suffix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkFoldrExpr</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>n_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>suffix'</span>
<a name="line-26"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varop'>.</span> <span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>folded_suffix</span> <span class='hs-varid'>prefix</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>dsExplicitList</span> <span class='hs-varid'>elt_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fln</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fln'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>fln</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>list</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExplicitList</span> <span class='hs-varid'>elt_ty</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>xs</span>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fln'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntExprInt</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>list</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>       
<a name="line-34"></a><a name="spanTail"></a><span class='hs-definition'>spanTail</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-definition'>spanTail</span> <span class='hs-varid'>f</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rejected</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>satisfying</span><span class='hs-layout'>)</span>
<a name="line-36"></a>    <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>satisfying</span><span class='hs-layout'>,</span> <span class='hs-varid'>rejected</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-varid'>f</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>xs</span>
<a name="line-37"></a>    
<a name="line-38"></a><a name="dsArithSeq"></a><span class='hs-definition'>dsArithSeq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PostTcExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-39"></a><span class='hs-definition'>dsArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>from</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>App</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>from</span>
<a name="line-41"></a><span class='hs-definition'>dsArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-43"></a>       <span class='hs-varid'>warnAboutEmptyEnumerations</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>from</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>to</span>
<a name="line-44"></a>       <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>expr</span>
<a name="line-45"></a>       <span class='hs-varid'>from'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>from</span>
<a name="line-46"></a>       <span class='hs-varid'>to'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>to</span>
<a name="line-47"></a>       <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkApps</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>from'</span><span class='hs-layout'>,</span> <span class='hs-varid'>to'</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a><span class='hs-definition'>dsArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>from</span> <span class='hs-varid'>thn</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApps</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>expr</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-varid'>thn</span><span class='hs-keyglyph'>]</span>
<a name="line-50"></a><span class='hs-definition'>dsArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>from</span> <span class='hs-varid'>thn</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-52"></a>       <span class='hs-varid'>warnAboutEmptyEnumerations</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>from</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>thn</span><span class='hs-layout'>)</span> <span class='hs-varid'>to</span>
<a name="line-53"></a>       <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>expr</span>
<a name="line-54"></a>       <span class='hs-varid'>from'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>from</span>
<a name="line-55"></a>       <span class='hs-varid'>thn'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>thn</span>
<a name="line-56"></a>       <span class='hs-varid'>to'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>to</span>
<a name="line-57"></a>       <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkApps</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>from'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thn'</span><span class='hs-layout'>,</span> <span class='hs-varid'>to'</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

Desugar 'do' and 'mdo' expressions (NOT list comprehensions, they're
handled in DsListComp).  Basically does the translation given in the
Haskell 98 report:

\begin{code}
<pre><a name="line-1"></a><a name="dsDo"></a><span class='hs-definition'>dsDo</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ExprLStmt</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a><span class='hs-definition'>dsDo</span> <span class='hs-varid'>stmts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goL</span> <span class='hs-varid'>stmts</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>goL</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsDo"</span>
<a name="line-6"></a>    <span class='hs-varid'>goL</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>stmt</span><span class='hs-conop'>:</span><span class='hs-varid'>lstmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putSrcSpanDs</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>lstmts</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  
<a name="line-8"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-9"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>)</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>body</span>
<a name="line-10"></a>        <span class='hs-comment'>-- The 'return' op isn't used for 'do' expressions</span>
<a name="line-11"></a>
<a name="line-12"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>then_expr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-13"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-14"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>warnDiscardedDoBindings</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span> 
<a name="line-15"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>then_expr2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>then_expr</span>
<a name="line-16"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goL</span> <span class='hs-varid'>stmts</span>
<a name="line-17"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkApps</span> <span class='hs-varid'>then_expr2</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>    
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-20"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goL</span> <span class='hs-varid'>stmts</span>
<a name="line-21"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>dsLocalBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>body</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>goL</span> <span class='hs-varid'>stmts</span>
<a name="line-25"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsLExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-26"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>bind_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>bind_op</span>
<a name="line-27"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>var</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>selectSimpleMatchVarL</span> <span class='hs-varid'>pat</span>
<a name="line-28"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bind_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>bind_op'</span>   <span class='hs-comment'>-- rhs -&gt; (pat -&gt; res1) -&gt; res2</span>
<a name="line-29"></a>                  <span class='hs-varid'>res1_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funResultTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>funArgTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>funResultTy</span> <span class='hs-varid'>bind_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>match</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchSinglePat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>StmtCtxt</span> <span class='hs-conid'>DoExpr</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span>
<a name="line-31"></a>                                      <span class='hs-varid'>res1_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>cantFailMatchResult</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-32"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>match_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handle_failure</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>match</span> <span class='hs-varid'>fail_op</span>
<a name="line-33"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkApps</span> <span class='hs-varid'>bind_op'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>var</span> <span class='hs-varid'>match_code</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>    
<a name="line-35"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>later_ids</span>
<a name="line-36"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op</span>
<a name="line-37"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>recS_mfix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mfix_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_bind_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span>
<a name="line-38"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_rets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_rets</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>stmts</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>goL</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_bind_stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- rec_ids can be empty; eg  rec { print 'x' }</span>
<a name="line-40"></a>      <span class='hs-keyword'>where</span>
<a name="line-41"></a>        <span class='hs-varid'>new_bind_stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BindStmt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBigLHsPatTup</span> <span class='hs-varid'>later_pats</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                                         <span class='hs-varid'>mfix_app</span> <span class='hs-varid'>bind_op</span> 
<a name="line-43"></a>                                         <span class='hs-varid'>noSyntaxExpr</span>  <span class='hs-comment'>-- Tuple cannot fail</span>
<a name="line-44"></a>
<a name="line-45"></a>        <span class='hs-varid'>tup_ids</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_ids</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>rec_ids</span><span class='hs-layout'>)</span> <span class='hs-varid'>later_ids</span>
<a name="line-46"></a>        <span class='hs-varid'>tup_ty</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBigCoreTupTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>tup_ids</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Deals with singleton case</span>
<a name="line-47"></a>        <span class='hs-varid'>rec_tup_pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>nlVarPat</span> <span class='hs-varid'>tup_ids</span>
<a name="line-48"></a>        <span class='hs-varid'>later_pats</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_tup_pats</span>
<a name="line-49"></a>        <span class='hs-varid'>rets</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>noLoc</span> <span class='hs-varid'>rec_rets</span>
<a name="line-50"></a>        <span class='hs-varid'>mfix_app</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>mfix_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>mfix_arg</span>
<a name="line-51"></a>        <span class='hs-varid'>mfix_arg</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsLam</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkSimpleMatch</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mfix_pat</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>body</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tup_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body_ty</span>
<a name="line-53"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Generated</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-54"></a>        <span class='hs-varid'>mfix_pat</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LazyPat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkBigLHsPatTup</span> <span class='hs-varid'>rec_tup_pats</span>
<a name="line-55"></a>        <span class='hs-varid'>body</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsDo</span> <span class='hs-conid'>DoExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>rec_stmts</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ret_stmt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_ty</span>
<a name="line-56"></a>        <span class='hs-varid'>ret_app</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>return_op</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBigLHsTup</span> <span class='hs-varid'>rets</span><span class='hs-layout'>)</span>
<a name="line-57"></a>        <span class='hs-varid'>ret_stmt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkLastStmt</span> <span class='hs-varid'>ret_app</span>
<a name="line-58"></a>                     <span class='hs-comment'>-- This LastStmt will be desugared with dsDo, </span>
<a name="line-59"></a>                     <span class='hs-comment'>-- which ignores the return_op in the LastStmt,</span>
<a name="line-60"></a>                     <span class='hs-comment'>-- so we must apply the return_op explicitly </span>
<a name="line-61"></a>
<a name="line-62"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span>   <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsDo ParStmt"</span>
<a name="line-63"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"dsDo TransStmt"</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="handle_failure"></a><span class='hs-definition'>handle_failure</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SyntaxExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-66"></a>    <span class='hs-comment'>-- In a do expression, pattern-match failure just calls</span>
<a name="line-67"></a>    <span class='hs-comment'>-- the monadic 'fail' rather than throwing an exception</span>
<a name="line-68"></a><span class='hs-definition'>handle_failure</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>match</span> <span class='hs-varid'>fail_op</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>matchCanFail</span> <span class='hs-varid'>match</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fail_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsExpr</span> <span class='hs-varid'>fail_op</span>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fail_msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkStringExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_fail_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-73"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>extractMatchResult</span> <span class='hs-varid'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fail_op'</span> <span class='hs-varid'>fail_msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractMatchResult</span> <span class='hs-varid'>match</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-str'>"It can't fail"</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="mk_fail_msg"></a><span class='hs-definition'>mk_fail_msg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-78"></a><span class='hs-definition'>mk_fail_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Pattern match failure in do expression at "</span> <span class='hs-varop'>++</span> 
<a name="line-79"></a>                         <span class='hs-varid'>showPpr</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection{Errors and contexts}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="warnDiscardedDoBindings"></a><span class='hs-comment'>-- Warn about certain types of values discarded in monadic bindings (#3263)</span>
<a name="line-2"></a><span class='hs-definition'>warnDiscardedDoBindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DsM</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>warnDiscardedDoBindings</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>m_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warn_unused</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnUnusedDoBind</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warn_wrong</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnWrongDoBind</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>warn_unused</span> <span class='hs-varop'>||</span> <span class='hs-varid'>warn_wrong</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsGetFamInstEnvs</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>norm_elt_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topNormaliseType</span> <span class='hs-varid'>fam_inst_envs</span> <span class='hs-varid'>elt_ty</span>
<a name="line-10"></a>
<a name="line-11"></a>           <span class='hs-comment'>-- Warn about discarding non-() things in 'monadic' binding</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>warn_unused</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnitTy</span> <span class='hs-varid'>norm_elt_ty</span><span class='hs-layout'>)</span>
<a name="line-13"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>warnDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>badMonadBind</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>elt_ty</span>
<a name="line-14"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-fno-warn-unused-do-bind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>         <span class='hs-keyword'>else</span>
<a name="line-16"></a>
<a name="line-17"></a>           <span class='hs-comment'>-- Warn about discarding m a things in 'monadic' binding of the same type,</span>
<a name="line-18"></a>           <span class='hs-comment'>-- but only if we didn't already warn due to Opt_WarnUnusedDoBind</span>
<a name="line-19"></a>           <span class='hs-varid'>when</span> <span class='hs-varid'>warn_wrong</span> <span class='hs-varop'>$</span>
<a name="line-20"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>norm_elt_ty</span> <span class='hs-keyword'>of</span>
<a name="line-21"></a>                         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>elt_m_ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m_ty</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>topNormaliseType</span> <span class='hs-varid'>fam_inst_envs</span> <span class='hs-varid'>elt_m_ty</span>
<a name="line-23"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>warnDs</span> <span class='hs-layout'>(</span><span class='hs-varid'>badMonadBind</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>elt_ty</span>
<a name="line-24"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-fno-warn-wrong-do-bind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- RHS does have type of form (m ty), which is weird</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- but at lesat this warning is irrelevant</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="badMonadBind"></a><span class='hs-definition'>badMonadBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-31"></a><span class='hs-definition'>badMonadBind</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>flag_doc</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A do-notation statement discarded a result of type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-33"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Suppress this warning by saying"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"_ &lt;-"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-36"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or by using the flag"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>  <span class='hs-varid'>flag_doc</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}
</body>
</html>
