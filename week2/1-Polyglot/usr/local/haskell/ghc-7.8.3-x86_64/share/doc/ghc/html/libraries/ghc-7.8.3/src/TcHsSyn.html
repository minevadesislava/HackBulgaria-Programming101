<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcHsSyn.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The AQUA Project, Glasgow University, 1996-1998
%

TcHsSyn: Specialisations of the @HsSyn@ syntax for the typechecker

This module is an extension of @HsSyn@ syntax, for use in the type
checker.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcHsSyn</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-varid'>mkHsConApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHsDictLet</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHsApp</span><span class='hs-layout'>,</span>
<a name="line-3"></a>        <span class='hs-varid'>hsLitType</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsLPatType</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsPatType</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>mkHsAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSimpleHsAlt</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>nlHsIntLit</span><span class='hs-layout'>,</span>
<a name="line-6"></a>        <span class='hs-varid'>shortCutLit</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsOverLitName</span><span class='hs-layout'>,</span>
<a name="line-7"></a>        <span class='hs-varid'>conLikeResTy</span><span class='hs-layout'>,</span>
<a name="line-8"></a>
<a name="line-9"></a>        <span class='hs-comment'>-- re-exported from TcMonad</span>
<a name="line-10"></a>        <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSet</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-varid'>zonkTopDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTopExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTopLExpr</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>zonkTopBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTyBndrsX</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>emptyZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEmptyZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarZonkEnv</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>zonkTcTypeToType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTypeToTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTyVarOcc</span><span class='hs-layout'>,</span>
<a name="line-16"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>     <span class='hs-comment'>-- We can see the representation of types</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span> <span class='hs-layout'>(</span> <span class='hs-varid'>defaultKindVarToStar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkQuantifiedTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span><span class='hs-layout'>(</span> <span class='hs-varid'>patSynInstResTy</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-layout'>(</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[mkFailurePair]{Code for pattern-matching and other failures}
%*                                                                      *
%************************************************************************

Note: If @hsLPatType@ doesn't bear a strong resemblance to @exprType@,
then something is wrong.
\begin{code}
<pre><a name="line-1"></a><a name="hsLPatType"></a><span class='hs-definition'>hsLPatType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutPat</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>hsLPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsPatType</span> <span class='hs-varid'>pat</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="hsPatType"></a><span class='hs-definition'>hsPatType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-5"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLPatType</span> <span class='hs-varid'>pat</span>
<a name="line-6"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>WildPat</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-7"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarPat</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>var</span>
<a name="line-8"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>BangPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLPatType</span> <span class='hs-varid'>pat</span>
<a name="line-9"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LazyPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLPatType</span> <span class='hs-varid'>pat</span>
<a name="line-10"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitPat</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLitType</span> <span class='hs-varid'>lit</span>
<a name="line-11"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsPat</span> <span class='hs-varid'>var</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViewPat</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-13"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkListTy</span> <span class='hs-varid'>ty</span>
<a name="line-14"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-15"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrPat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPArrTy</span> <span class='hs-varid'>ty</span>
<a name="line-16"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bx</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTupleTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>boxityNormalTupleSort</span> <span class='hs-varid'>bx</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-17"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatOut</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_con</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-18"></a>                                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>conLikeResTy</span> <span class='hs-varid'>con</span> <span class='hs-varid'>tys</span>
<a name="line-19"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigPatOut</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-20"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>NPat</span> <span class='hs-varid'>lit</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>overLitType</span> <span class='hs-varid'>lit</span>
<a name="line-21"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>NPlusKPat</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-definition'>hsPatType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoPat</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a><span class='hs-definition'>hsPatType</span> <span class='hs-varid'>p</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"hsPatType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="conLikeResTy"></a><span class='hs-definition'>conLikeResTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConLike</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-26"></a><span class='hs-definition'>conLikeResTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-27"></a><span class='hs-definition'>conLikeResTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>    <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>patSynInstResTy</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>tys</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="hsLitType"></a><span class='hs-definition'>hsLitType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-30"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsChar</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>charTy</span>
<a name="line-31"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCharPrim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>charPrimTy</span>
<a name="line-32"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsString</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stringTy</span>
<a name="line-33"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStringPrim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addrPrimTy</span>
<a name="line-34"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsInt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>intTy</span>
<a name="line-35"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIntPrim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>intPrimTy</span>
<a name="line-36"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWordPrim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wordPrimTy</span>
<a name="line-37"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsInt64Prim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>int64PrimTy</span>
<a name="line-38"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWord64Prim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>word64PrimTy</span>
<a name="line-39"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsInteger</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-40"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-41"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFloatPrim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>floatPrimTy</span>
<a name="line-42"></a><span class='hs-definition'>hsLitType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDoublePrim</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doublePrimTy</span>
</pre>\end{code}

Overloaded literals. Here mainly because it uses isIntTy etc

\begin{code}
<pre><a name="line-1"></a><a name="shortCutLit"></a><span class='hs-definition'>shortCutLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OverLitVal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>shortCutLit</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIntegral</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIntTy</span> <span class='hs-varid'>ty</span>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inIntRange</span>  <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsInt</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWordTy</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>inWordRange</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLit</span> <span class='hs-varid'>wordDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWordPrim</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIntegerTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsInteger</span> <span class='hs-varid'>i</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shortCutLit</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFractional</span> <span class='hs-layout'>(</span><span class='hs-varid'>integralFractionalLit</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-7"></a>        <span class='hs-comment'>-- The 'otherwise' case is important</span>
<a name="line-8"></a>        <span class='hs-comment'>-- Consider (3 :: Float).  Syntactically it looks like an IntLit,</span>
<a name="line-9"></a>        <span class='hs-comment'>-- so we'll call shortCutIntLit, but of course it's a float</span>
<a name="line-10"></a>        <span class='hs-comment'>-- This can make a big difference for programs with a lot of</span>
<a name="line-11"></a>        <span class='hs-comment'>-- literals, compiled without -O</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>shortCutLit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFractional</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFloatTy</span> <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLit</span> <span class='hs-varid'>floatDataCon</span>  <span class='hs-layout'>(</span><span class='hs-conid'>HsFloatPrim</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDoubleTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLit</span> <span class='hs-varid'>doubleDataCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDoublePrim</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>shortCutLit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIsString</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStringTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsString</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="mkLit"></a><span class='hs-definition'>mkLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span>
<a name="line-23"></a><span class='hs-definition'>mkLit</span> <span class='hs-varid'>con</span> <span class='hs-varid'>lit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="hsOverLitName"></a><span class='hs-comment'>------------------------------</span>
<a name="line-26"></a><span class='hs-definition'>hsOverLitName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OverLitVal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-27"></a><span class='hs-comment'>-- Get the canonical 'fromX' name for a particular OverLitVal</span>
<a name="line-28"></a><span class='hs-definition'>hsOverLitName</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIntegral</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegerName</span>
<a name="line-29"></a><span class='hs-definition'>hsOverLitName</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFractional</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromRationalName</span>
<a name="line-30"></a><span class='hs-definition'>hsOverLitName</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIsString</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromStringName</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[BackSubst-HsBinds]{Running a substitution over @HsBinds@}
%*                                                                      *
%************************************************************************

The rest of the zonking is done *after* typechecking.
The main zonking pass runs over the bindings

 a) to convert TcTyVars to TyVars etc, dereferencing any bindings etc
 b) convert unbound TcTyVar to Void
 c) convert each TcId to an Id by zonking its type

The type variables are converted by binding mutable tyvars to immutable ones
and then zonking as normal.

The Ids are converted by binding them in the normal Tc envt; that
way we maintain sharing; eg an Id is zonked at its binding site and they
all occurrences of that Id point to the common zonked copy

It's all pretty boring stuff, because HsSyn is such a large type, and
the environment manipulation is tiresome.

\begin{code}
<pre><a name="line-1"></a><a name="UnboundTyVarZonker"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UnboundTyVarZonker</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a>        <span class='hs-comment'>-- How to zonk an unbound type variable</span>
<a name="line-3"></a>        <span class='hs-comment'>-- Note [Zonking the LHS of a RULE]</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="ZonkEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-7"></a>      <span class='hs-conid'>UnboundTyVarZonker</span>
<a name="line-8"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>          <span class='hs-comment'>--</span>
<a name="line-9"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>IdEnv</span>    <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>            <span class='hs-comment'>-- What variables are in scope</span>
<a name="line-10"></a>        <span class='hs-comment'>-- Maps an Id or EvVar to its zonked version; both have the same Name</span>
<a name="line-11"></a>        <span class='hs-comment'>-- Note that all evidence (coercion variables as well as dictionaries)</span>
<a name="line-12"></a>        <span class='hs-comment'>--      are kept in the ZonkEnv</span>
<a name="line-13"></a>        <span class='hs-comment'>-- Only *type* abstraction is done by side effect</span>
<a name="line-14"></a>        <span class='hs-comment'>-- Is only consulted lazily; hence knot-tying</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyword'>_</span> <span class='hs-sel'>_ty_env</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a>
<a name="line-20"></a><a name="emptyZonkEnv"></a><span class='hs-definition'>emptyZonkEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-21"></a><span class='hs-definition'>emptyZonkEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyZonkEnv</span> <span class='hs-varid'>zonkTypeZapping</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="mkEmptyZonkEnv"></a><span class='hs-definition'>mkEmptyZonkEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnboundTyVarZonker</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-24"></a><span class='hs-definition'>mkEmptyZonkEnv</span> <span class='hs-varid'>zonker</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonker</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="extendIdZonkEnv"></a><span class='hs-definition'>extendIdZonkEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-27"></a><span class='hs-definition'>extendIdZonkEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-varid'>ty_env</span> <span class='hs-varid'>id_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-varid'>ty_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>id_env</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="extendIdZonkEnv1"></a><span class='hs-definition'>extendIdZonkEnv1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-31"></a><span class='hs-definition'>extendIdZonkEnv1</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-varid'>ty_env</span> <span class='hs-varid'>id_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-varid'>ty_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>id_env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="extendTyZonkEnv1"></a><span class='hs-definition'>extendTyZonkEnv1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-35"></a><span class='hs-definition'>extendTyZonkEnv1</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-varid'>ty_env</span> <span class='hs-varid'>id_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>ty_env</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>id_env</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="mkTyVarZonkEnv"></a><span class='hs-definition'>mkTyVarZonkEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-39"></a><span class='hs-definition'>mkTyVarZonkEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonkTypeZapping</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="setZonkType"></a><span class='hs-definition'>setZonkType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnboundTyVarZonker</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-42"></a><span class='hs-definition'>setZonkType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty_env</span> <span class='hs-varid'>id_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_ty</span> <span class='hs-varid'>ty_env</span> <span class='hs-varid'>id_env</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="zonkEnvIds"></a><span class='hs-definition'>zonkEnvIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a><span class='hs-definition'>zonkEnvIds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>id_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>id_env</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="zonkIdOcc"></a><span class='hs-definition'>zonkIdOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-48"></a><span class='hs-comment'>-- Ids defined in this module should be in the envt;</span>
<a name="line-49"></a><span class='hs-comment'>-- ignore others.  (Actually, data constructors are also</span>
<a name="line-50"></a><span class='hs-comment'>-- not LocalVars, even when locally defined, but that is fine.)</span>
<a name="line-51"></a><span class='hs-comment'>-- (Also foreign-imported things aren't currently in the ZonkEnv;</span>
<a name="line-52"></a><span class='hs-comment'>--  that's ok because they don't need zonking.)</span>
<a name="line-53"></a><span class='hs-comment'>--</span>
<a name="line-54"></a><span class='hs-comment'>-- Actually, Template Haskell works in 'chunks' of declarations, and</span>
<a name="line-55"></a><span class='hs-comment'>-- an earlier chunk won't be in the 'env' that the zonking phase</span>
<a name="line-56"></a><span class='hs-comment'>-- carries around.  Instead it'll be in the tcg_gbl_env, already fully</span>
<a name="line-57"></a><span class='hs-comment'>-- zonked.  There's no point in looking it up there (except for error</span>
<a name="line-58"></a><span class='hs-comment'>-- checking), and it's not conveniently to hand; hence the simple</span>
<a name="line-59"></a><span class='hs-comment'>-- 'orElse' case in the LocalVar branch.</span>
<a name="line-60"></a><span class='hs-comment'>--</span>
<a name="line-61"></a><span class='hs-comment'>-- Even without template splices, in module Main, the checking of</span>
<a name="line-62"></a><span class='hs-comment'>-- 'main' is done as a separate chunk.</span>
<a name="line-63"></a><span class='hs-definition'>zonkIdOcc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-sel'>_zonk_ty</span> <span class='hs-sel'>_ty_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLocalVar</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>id</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="zonkIdOccs"></a><span class='hs-definition'>zonkIdOccs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-68"></a><span class='hs-definition'>zonkIdOccs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="zonkIdBndr"></a><span class='hs-comment'>-- zonkIdBndr is used *after* typechecking to get the Id's type</span>
<a name="line-71"></a><span class='hs-comment'>-- to its final form.  The TyVarEnv give</span>
<a name="line-72"></a><span class='hs-definition'>zonkIdBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Id</span>
<a name="line-73"></a><span class='hs-definition'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-75"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-varop'>.</span><span class='hs-varid'>setIdType</span> <span class='hs-varid'>id</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="zonkIdBndrs"></a><span class='hs-definition'>zonkIdBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-78"></a><span class='hs-definition'>zonkIdBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="zonkTopBndrs"></a><span class='hs-definition'>zonkTopBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a><span class='hs-definition'>zonkTopBndrs</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkIdBndrs</span> <span class='hs-varid'>emptyZonkEnv</span> <span class='hs-varid'>ids</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="zonkEvBndrsX"></a><span class='hs-definition'>zonkEvBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-definition'>zonkEvBndrsX</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>zonkEvBndrX</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="zonkEvBndrX"></a><span class='hs-definition'>zonkEvBndrX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-comment'>-- Works for dictionaries and coercions</span>
<a name="line-88"></a><span class='hs-definition'>zonkEvBndrX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-90"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdZonkEnv1</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var'</span><span class='hs-layout'>,</span> <span class='hs-varid'>var'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="zonkEvBndr"></a><span class='hs-definition'>zonkEvBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-93"></a><span class='hs-comment'>-- Works for dictionaries and coercions</span>
<a name="line-94"></a><span class='hs-comment'>-- Does not extend the ZonkEnv</span>
<a name="line-95"></a><span class='hs-definition'>zonkEvBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>var_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>var</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-98"></a>           <span class='hs-comment'>{-# SCC "zonkEvBndr_zonkTcTypeToType" #-}</span>
<a name="line-99"></a>           <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var_ty</span>
<a name="line-100"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>var</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="zonkEvVarOcc"></a><span class='hs-definition'>zonkEvVarOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span>
<a name="line-103"></a><span class='hs-definition'>zonkEvVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="zonkTyBndrsX"></a><span class='hs-definition'>zonkTyBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-106"></a><span class='hs-definition'>zonkTyBndrsX</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>zonkTyBndrX</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="zonkTyBndrX"></a><span class='hs-definition'>zonkTyBndrX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-109"></a><span class='hs-comment'>-- This guarantees to return a TyVar (not a TcTyVar)</span>
<a name="line-110"></a><span class='hs-comment'>-- then we add it to the envt, so all occurrences are replaced</span>
<a name="line-111"></a><span class='hs-definition'>zonkTyBndrX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-113"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ki</span>
<a name="line-114"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTyZonkEnv1</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="zonkTopExpr"></a><span class='hs-definition'>zonkTopExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>zonkTopExpr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>emptyZonkEnv</span> <span class='hs-varid'>e</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="zonkTopLExpr"></a><span class='hs-definition'>zonkTopLExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>zonkTopLExpr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>emptyZonkEnv</span> <span class='hs-varid'>e</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="zonkTopDecls"></a><span class='hs-definition'>zonkTopDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span>
<a name="line-8"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NameSet</span>
<a name="line-9"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-11"></a>                     <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span>
<a name="line-12"></a>                     <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span>    <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-16"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span>    <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>zonkTopDecls</span> <span class='hs-varid'>ev_binds</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sig_ns</span> <span class='hs-varid'>rules</span> <span class='hs-varid'>vects</span> <span class='hs-varid'>imp_specs</span> <span class='hs-varid'>fords</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvBinds</span> <span class='hs-varid'>emptyZonkEnv</span> <span class='hs-varid'>ev_binds</span>
<a name="line-19"></a>
<a name="line-20"></a>         <span class='hs-comment'>-- Warn about missing signatures</span>
<a name="line-21"></a>         <span class='hs-comment'>-- Do this only when we we have a type to offer</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warn_missing_sigs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnMissingSigs</span>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sig_warn</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>warn_missing_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topSigWarn</span> <span class='hs-varid'>sig_ns</span>
<a name="line-24"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noSigWarn</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkRecMonoBinds</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>binds</span>
<a name="line-27"></a>                        <span class='hs-comment'>-- Top level is implicitly recursive</span>
<a name="line-28"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rules'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkRules</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>rules</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>vects'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkVects</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>vects</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>specs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLTcSpecPrags</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>imp_specs</span>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fords'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkForeignExports</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>fords</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkEnvIds</span> <span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fords'</span><span class='hs-layout'>,</span> <span class='hs-varid'>specs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rules'</span><span class='hs-layout'>,</span> <span class='hs-varid'>vects'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="zonkLocalBinds"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-35"></a><span class='hs-definition'>zonkLocalBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-definition'>zonkLocalBinds</span> <span class='hs-varid'>env</span> <span class='hs-conid'>EmptyLocalBinds</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>EmptyLocalBinds</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>zonkLocalBinds</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"zonkLocalBinds"</span> <span class='hs-comment'>-- Not in typechecker output</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-definition'>zonkLocalBinds</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-varid'>vb</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>warn_missing_sigs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnMissingLocalSigs</span>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sig_warn</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>warn_missing_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noSigWarn</span>
<a name="line-45"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>localSigWarn</span> <span class='hs-varid'>sig_ns</span>
<a name="line-46"></a>              <span class='hs-varid'>sig_ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTypeSigNames</span> <span class='hs-varid'>vb</span>
<a name="line-47"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>binds</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsOut</span> <span class='hs-varid'>new_binds</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-51"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-52"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-53"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkRecMonoBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>b</span>
<a name="line-54"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>bs</span>
<a name="line-55"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>b'</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-definition'>zonkLocalBinds</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>dict_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-58"></a>    <span class='hs-varid'>new_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>zonk_ip_bind</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-59"></a>    <span class='hs-keyword'>let</span>
<a name="line-60"></a>        <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_binds</span><span class='hs-keyglyph'>]</span>
<a name="line-61"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_dict_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcEvBinds</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>dict_binds</span>
<a name="line-62"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsIPBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBinds</span> <span class='hs-varid'>new_binds</span> <span class='hs-varid'>new_dict_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyword'>where</span>
<a name="line-64"></a>    <span class='hs-varid'>zonk_ip_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-varid'>n</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-65"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapIPNameTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-66"></a>             <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-67"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPBind</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="zonkRecMonoBinds"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-70"></a><span class='hs-definition'>zonkRecMonoBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigWarn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-definition'>zonkRecMonoBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>binds</span>
<a name="line-72"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-73"></a>        <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsBindsBinders</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span>
<a name="line-74"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMonoBinds</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>binds</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="SigWarn"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-78"></a><a name="SigWarn"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SigWarn</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-79"></a>     <span class='hs-comment'>-- Missing-signature warning</span>
<a name="line-80"></a>     <span class='hs-comment'>-- The Bool is True for an AbsBinds, False otherwise</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="noSigWarn"></a><span class='hs-definition'>noSigWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SigWarn</span>
<a name="line-83"></a><span class='hs-definition'>noSigWarn</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="topSigWarn"></a><span class='hs-definition'>topSigWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigWarn</span>
<a name="line-86"></a><span class='hs-definition'>topSigWarn</span> <span class='hs-varid'>sig_ns</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSigWarnId</span> <span class='hs-varid'>sig_ns</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="topSigWarnId"></a><span class='hs-definition'>topSigWarnId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-89"></a><span class='hs-comment'>-- The NameSet is the Ids that *lack* a signature</span>
<a name="line-90"></a><span class='hs-comment'>-- We have to do it this way round because there are</span>
<a name="line-91"></a><span class='hs-comment'>-- lots of top-level bindings that are generated by GHC</span>
<a name="line-92"></a><span class='hs-comment'>-- and that don't have signatures</span>
<a name="line-93"></a><span class='hs-definition'>topSigWarnId</span> <span class='hs-varid'>sig_ns</span> <span class='hs-varid'>id</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>sig_ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnMissingSig</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>id</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-96"></a>  <span class='hs-keyword'>where</span>
<a name="line-97"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Top-level binding with no type signature:"</span><span class='hs-layout'>)</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="localSigWarn"></a><span class='hs-definition'>localSigWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigWarn</span>
<a name="line-100"></a><span class='hs-definition'>localSigWarn</span> <span class='hs-varid'>sig_ns</span> <span class='hs-varid'>is_abs_bind</span> <span class='hs-varid'>ids</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_abs_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>localSigWarnId</span> <span class='hs-varid'>sig_ns</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="localSigWarnId"></a><span class='hs-definition'>localSigWarnId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-105"></a><span class='hs-comment'>-- NameSet are the Ids that *have* type signatures</span>
<a name="line-106"></a><span class='hs-definition'>localSigWarnId</span> <span class='hs-varid'>sig_ns</span> <span class='hs-varid'>id</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSigmaTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>sig_ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>warnMissingSig</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>id</span>
<a name="line-110"></a>  <span class='hs-keyword'>where</span>
<a name="line-111"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Polymorphic local binding with no type signature:"</span><span class='hs-layout'>)</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="warnMissingSig"></a><span class='hs-definition'>warnMissingSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-114"></a><span class='hs-definition'>warnMissingSig</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>id</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-116"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env0</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-117"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>addWarnTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-118"></a>  <span class='hs-keyword'>where</span>
<a name="line-119"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprPrefixName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>]</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="zonkMonoBinds"></a><span class='hs-comment'>---------------------------------------------</span>
<a name="line-122"></a><span class='hs-definition'>zonkMonoBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigWarn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-123"></a><span class='hs-definition'>zonkMonoBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBagM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonk_lbind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-124"></a>
<a name="line-125"></a><a name="zonk_lbind"></a><span class='hs-definition'>zonk_lbind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigWarn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-126"></a><span class='hs-definition'>zonk_lbind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonk_bind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span><span class='hs-layout'>)</span>
<a name="line-127"></a>
<a name="line-128"></a><a name="zonk_bind"></a><span class='hs-definition'>zonk_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigWarn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBind</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBind</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-definition'>zonk_bind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-sel'>_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>            <span class='hs-comment'>-- Env already extended</span>
<a name="line-131"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_warn</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectPatBinders</span> <span class='hs-varid'>new_pat</span><span class='hs-layout'>)</span>
<a name="line-132"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_grhss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkGRHSs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>grhss</span>
<a name="line-133"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_ty</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-134"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_pat</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_grhss</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-135"></a>
<a name="line-136"></a><span class='hs-definition'>zonk_bind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-137"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_var</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-138"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sig_warn</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>new_var</span><span class='hs-keyglyph'>]</span>
<a name="line-139"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-140"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-definition'>zonk_bind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FunBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span>
<a name="line-143"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>fun_co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co_fn</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-145"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sig_warn</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>new_var</span><span class='hs-keyglyph'>]</span>
<a name="line-146"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_co_fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co_fn</span>
<a name="line-147"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMatchGroup</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>ms</span>
<a name="line-148"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ms</span>
<a name="line-149"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>fun_co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_co_fn</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-150"></a>
<a name="line-151"></a><span class='hs-definition'>zonk_bind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sig_warn</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evs</span>
<a name="line-152"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds</span>
<a name="line-153"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exports</span>
<a name="line-154"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>val_binds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>)</span>
<a name="line-156"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env0</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tyvars</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyBndrsX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span>
<a name="line-157"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_evs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvBndrsX</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>evs</span>
<a name="line-158"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_ev_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcEvBinds</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ev_binds</span>
<a name="line-159"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_val_bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_exports</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-varid'>new_val_binds</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-160"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env2</span> <span class='hs-layout'>(</span><span class='hs-varid'>collectHsBindsBinders</span> <span class='hs-varid'>new_val_binds</span><span class='hs-layout'>)</span>
<a name="line-161"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>new_val_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMonoBinds</span> <span class='hs-varid'>env3</span> <span class='hs-varid'>noSigWarn</span> <span class='hs-varid'>val_binds</span>
<a name="line-162"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>new_exports</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExport</span> <span class='hs-varid'>env3</span><span class='hs-layout'>)</span> <span class='hs-varid'>exports</span>
<a name="line-163"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_val_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_exports</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-164"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sig_warn</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>abe_poly</span> <span class='hs-varid'>new_exports</span><span class='hs-layout'>)</span>
<a name="line-165"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_evs</span>
<a name="line-166"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ev_binds</span>
<a name="line-167"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_exports</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_val_bind</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-168"></a>  <span class='hs-keyword'>where</span>
<a name="line-169"></a>    <span class='hs-varid'>zonkExport</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABE</span><span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poly_id</span>
<a name="line-170"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mono_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prags</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-171"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_poly_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>poly_id</span>
<a name="line-172"></a>             <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_wrap</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>wrap</span>
<a name="line-173"></a>             <span class='hs-varid'>new_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSpecPrags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>prags</span>
<a name="line-174"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ABE</span><span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_poly_id</span>
<a name="line-175"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>mono_id</span>
<a name="line-176"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_prags</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-177"></a>
<a name="line-178"></a><span class='hs-definition'>zonk_bind</span> <span class='hs-varid'>env</span> <span class='hs-sel'>_sig_warn</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PatSynBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>id</span>
<a name="line-179"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span>
<a name="line-180"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_def</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lpat</span>
<a name="line-181"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>id'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span>
<a name="line-183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPatSynDetails</span> <span class='hs-varid'>env</span> <span class='hs-varid'>details</span>
<a name="line-184"></a>       <span class='hs-layout'>;</span><span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>lpat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lpat</span>
<a name="line-185"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-sel'>_env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>dir'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPatSynDir</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>dir</span>
<a name="line-186"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>patsyn_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>id'</span>
<a name="line-187"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details'</span>
<a name="line-188"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_def</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lpat'</span>
<a name="line-189"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>patsyn_dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="zonkPatSynDetails"></a><span class='hs-definition'>zonkPatSynDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-192"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsPatSynDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-193"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPatSynDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-194"></a><span class='hs-definition'>zonkPatSynDetails</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-195"></a>
<a name="line-196"></a><a name="zonkPatSynDir"></a><span class='hs-definition'>zonkPatSynDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsPatSynDir</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsPatSynDir</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-197"></a><span class='hs-definition'>zonkPatSynDir</span> <span class='hs-varid'>env</span> <span class='hs-conid'>Unidirectional</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>Unidirectional</span><span class='hs-layout'>)</span>
<a name="line-198"></a><span class='hs-definition'>zonkPatSynDir</span> <span class='hs-varid'>env</span> <span class='hs-conid'>ImplicitBidirectional</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImplicitBidirectional</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="zonkSpecPrags"></a><span class='hs-definition'>zonkSpecPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSpecPrags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcSpecPrags</span>
<a name="line-201"></a><span class='hs-definition'>zonkSpecPrags</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>IsDefaultMethod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>IsDefaultMethod</span>
<a name="line-202"></a><span class='hs-definition'>zonkSpecPrags</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrags</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLTcSpecPrags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ps</span>
<a name="line-203"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrags</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-204"></a>
<a name="line-205"></a><a name="zonkLTcSpecPrags"></a><span class='hs-definition'>zonkLTcSpecPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span>
<a name="line-206"></a><span class='hs-definition'>zonkLTcSpecPrags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ps</span>
<a name="line-207"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonk_prag</span> <span class='hs-varid'>ps</span>
<a name="line-208"></a>  <span class='hs-keyword'>where</span>
<a name="line-209"></a>    <span class='hs-varid'>zonk_prag</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-varid'>id</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-210"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_fn'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co_fn</span>
<a name="line-211"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>co_fn'</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[BackSubst-Match-GRHSs]{Match and GRHSs}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkMatchGroup"></a><span class='hs-definition'>zonkMatchGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-2"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>zonkMatchGroup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ms'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkMatch</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg_tys</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>res_ty</span>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mg_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="zonkMatch"></a><span class='hs-definition'>zonkMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-11"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LMatch</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LMatch</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-definition'>zonkMatch</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>pats</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>grhss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_pats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pats</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_grhss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkGRHSs</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>zBody</span> <span class='hs-varid'>grhss</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-varid'>new_pats</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>new_grhss</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="zonkGRHSs"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-19"></a><span class='hs-definition'>zonkGRHSs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-20"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRHSs</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>zonkGRHSs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>grhss</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-24"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLocalBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>binds</span>
<a name="line-25"></a>    <span class='hs-keyword'>let</span>
<a name="line-26"></a>        <span class='hs-varid'>zonk_grhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>guarded</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_guarded</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>guarded</span>
<a name="line-28"></a>               <span class='hs-varid'>new_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zBody</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>rhs</span>
<a name="line-29"></a>               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>new_guarded</span> <span class='hs-varid'>new_rhs</span><span class='hs-layout'>)</span>
<a name="line-30"></a>    <span class='hs-varid'>new_grhss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>zonk_grhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>grhss</span>
<a name="line-31"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>new_grhss</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[BackSubst-HsExpr]{Running a zonkitution over a TypeCheckedExpr}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkLExprs"></a><span class='hs-definition'>zonkLExprs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><a name="zonkLExpr"></a><span class='hs-definition'>zonkLExpr</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>TcId</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-3"></a><a name="zonkExpr"></a><span class='hs-definition'>zonkExpr</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>zonkLExprs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>exprs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>exprs</span>
<a name="line-6"></a><span class='hs-definition'>zonkLExpr</span>  <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIPVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRat</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-16"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRat</span> <span class='hs-varid'>f</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>lit'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkOverLit</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lit</span>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>lit'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_matches</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMatchGroup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>matches</span>
<a name="line-27"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLam</span> <span class='hs-varid'>new_matches</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_arg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span>
<a name="line-31"></a>       <span class='hs-varid'>new_matches</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMatchGroup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>matches</span>
<a name="line-32"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLamCase</span> <span class='hs-varid'>new_arg</span> <span class='hs-varid'>new_matches</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-36"></a>       <span class='hs-varid'>new_e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-37"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsApp</span> <span class='hs-varid'>new_e1</span> <span class='hs-varid'>new_e2</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRnBracketOut</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zonkExpr: HsRnBracketOut"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>body</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>bs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonk_b</span> <span class='hs-varid'>bs</span>
<a name="line-44"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTcBracketOut</span> <span class='hs-varid'>body</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyword'>where</span>
<a name="line-46"></a>    <span class='hs-varid'>zonk_b</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-47"></a>                       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>t</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span> <span class='hs-layout'>)</span> <span class='hs-comment'>-- Should not happen</span>
<a name="line-50"></a>                             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceE</span> <span class='hs-varid'>t</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-54"></a>       <span class='hs-varid'>new_op</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>op</span>
<a name="line-55"></a>       <span class='hs-varid'>new_e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-56"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>new_e1</span> <span class='hs-varid'>new_op</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>new_e2</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-60"></a>       <span class='hs-varid'>new_op</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>op</span>
<a name="line-61"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_op</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-65"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPar</span> <span class='hs-varid'>new_e</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-69"></a>       <span class='hs-varid'>new_op</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>op</span>
<a name="line-70"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionL</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_op</span><span class='hs-layout'>)</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>op</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_op</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>op</span>
<a name="line-74"></a>       <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-75"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SectionR</span> <span class='hs-varid'>new_op</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>tup_args</span> <span class='hs-varid'>boxed</span><span class='hs-layout'>)</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_tup_args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonk_tup_arg</span> <span class='hs-varid'>tup_args</span>
<a name="line-79"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitTuple</span> <span class='hs-varid'>new_tup_args</span> <span class='hs-varid'>boxed</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>  <span class='hs-keyword'>where</span>
<a name="line-81"></a>    <span class='hs-varid'>zonk_tup_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Present</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-82"></a>    <span class='hs-varid'>zonk_tup_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Missing</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-86"></a>       <span class='hs-varid'>new_ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMatchGroup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>ms</span>
<a name="line-87"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCase</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_ms</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-varid'>e0</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>e3</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_e0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmapMaybeM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>e0</span>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_e3</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e3</span>
<a name="line-94"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIf</span> <span class='hs-varid'>new_e0</span> <span class='hs-varid'>new_e1</span> <span class='hs-varid'>new_e2</span> <span class='hs-varid'>new_e3</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsMultiIf</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>zonk_alt</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-99"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsMultiIf</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>alts'</span> <span class='hs-layout'>}</span>
<a name="line-100"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>zonk_alt</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHS</span> <span class='hs-varid'>guard</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-101"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>guard'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>guard</span>
<a name="line-102"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>expr'</span>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>expr</span>
<a name="line-103"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRHS</span> <span class='hs-varid'>guard'</span> <span class='hs-varid'>expr'</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLocalBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>binds</span>
<a name="line-107"></a>       <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>expr</span>
<a name="line-108"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLet</span> <span class='hs-varid'>new_binds</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_stmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>stmts</span>
<a name="line-112"></a>       <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-113"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>new_stmts</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>wit</span> <span class='hs-varid'>exprs</span><span class='hs-layout'>)</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-117"></a>       <span class='hs-varid'>new_wit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkWit</span> <span class='hs-varid'>env</span> <span class='hs-varid'>wit</span>
<a name="line-118"></a>       <span class='hs-varid'>new_exprs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExprs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>exprs</span>
<a name="line-119"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>new_wit</span> <span class='hs-varid'>new_exprs</span><span class='hs-layout'>)</span>
<a name="line-120"></a>   <span class='hs-keyword'>where</span> <span class='hs-varid'>zonkWit</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-121"></a>         <span class='hs-varid'>zonkWit</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fln</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_fln</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fln</span>
<a name="line-122"></a>                                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>new_fln</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exprs</span><span class='hs-layout'>)</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-126"></a>       <span class='hs-varid'>new_exprs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExprs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>exprs</span>
<a name="line-127"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExplicitPArr</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>new_exprs</span><span class='hs-layout'>)</span>
<a name="line-128"></a>
<a name="line-129"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>con_expr</span> <span class='hs-varid'>rbinds</span><span class='hs-layout'>)</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_con_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>con_expr</span>
<a name="line-131"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_rbinds</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkRecFields</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rbinds</span>
<a name="line-132"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordCon</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>new_con_expr</span> <span class='hs-varid'>new_rbinds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>rbinds</span> <span class='hs-varid'>cons</span> <span class='hs-varid'>in_tys</span> <span class='hs-varid'>out_tys</span><span class='hs-layout'>)</span>
<a name="line-135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_expr</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-136"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_in_tys</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>in_tys</span>
<a name="line-137"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_out_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>out_tys</span>
<a name="line-138"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_rbinds</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkRecFields</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rbinds</span>
<a name="line-139"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_rbinds</span> <span class='hs-varid'>cons</span> <span class='hs-varid'>new_in_tys</span> <span class='hs-varid'>new_out_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySigOut</span> <span class='hs-varid'>e</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-143"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySigOut</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-144"></a>
<a name="line-145"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprWithTySig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"zonkExpr env:ExprWithTySig"</span>
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>wit</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-148"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-149"></a>       <span class='hs-varid'>new_wit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkWit</span> <span class='hs-varid'>env</span> <span class='hs-varid'>wit</span>
<a name="line-150"></a>       <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkArithSeq</span> <span class='hs-varid'>env</span> <span class='hs-varid'>info</span>
<a name="line-151"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_wit</span> <span class='hs-varid'>new_info</span><span class='hs-layout'>)</span>
<a name="line-152"></a>   <span class='hs-keyword'>where</span> <span class='hs-varid'>zonkWit</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-153"></a>         <span class='hs-varid'>zonkWit</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fln</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_fln</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fln</span>
<a name="line-154"></a>                                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>new_fln</span><span class='hs-layout'>)</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-158"></a>       <span class='hs-varid'>new_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkArithSeq</span> <span class='hs-varid'>env</span> <span class='hs-varid'>info</span>
<a name="line-159"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeq</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_info</span><span class='hs-layout'>)</span>
<a name="line-160"></a>
<a name="line-161"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-162"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-163"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSCC</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>info</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-167"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTickPragma</span> <span class='hs-varid'>info</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-168"></a>
<a name="line-169"></a><span class='hs-comment'>-- hdaume: core annotations</span>
<a name="line-170"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-172"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreAnn</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-173"></a>
<a name="line-174"></a><span class='hs-comment'>-- arrow notation extensions</span>
<a name="line-175"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>
<a name="line-177"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCmdTop</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>body</span>
<a name="line-178"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsProc</span> <span class='hs-varid'>new_pat</span> <span class='hs-varid'>new_body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-179"></a>
<a name="line-180"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_co_fn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co_fn</span>
<a name="line-182"></a>       <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>expr</span>
<a name="line-183"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrap</span> <span class='hs-varid'>new_co_fn</span> <span class='hs-varid'>new_expr</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnboundVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnboundVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-187"></a>
<a name="line-188"></a><span class='hs-definition'>zonkExpr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zonkExpr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="zonkLCmd"></a><span class='hs-definition'>zonkLCmd</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>TcId</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmd</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-193"></a><a name="zonkCmd"></a><span class='hs-definition'>zonkCmd</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsCmd</span> <span class='hs-conid'>TcId</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmd</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-194"></a>
<a name="line-195"></a><span class='hs-definition'>zonkLCmd</span>  <span class='hs-varid'>env</span> <span class='hs-varid'>cmd</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkCmd</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmd</span>
<a name="line-196"></a>
<a name="line-197"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCast</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcCoToCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-199"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cmd'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cmd</span>
<a name="line-200"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCast</span> <span class='hs-varid'>co'</span> <span class='hs-varid'>cmd'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-201"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ho</span> <span class='hs-varid'>rl</span><span class='hs-layout'>)</span>
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-203"></a>       <span class='hs-varid'>new_e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-204"></a>       <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-205"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrApp</span> <span class='hs-varid'>new_e1</span> <span class='hs-varid'>new_e2</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>ho</span> <span class='hs-varid'>rl</span><span class='hs-layout'>)</span>
<a name="line-206"></a>
<a name="line-207"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-208"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_op</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>op</span>
<a name="line-209"></a>       <span class='hs-varid'>new_args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkCmdTop</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-210"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>new_op</span> <span class='hs-varid'>fixity</span> <span class='hs-varid'>new_args</span><span class='hs-layout'>)</span>
<a name="line-211"></a>
<a name="line-212"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>c</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-213"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c</span>
<a name="line-214"></a>       <span class='hs-varid'>new_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-215"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdApp</span> <span class='hs-varid'>new_c</span> <span class='hs-varid'>new_e</span><span class='hs-layout'>)</span>
<a name="line-216"></a>
<a name="line-217"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_matches</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMatchGroup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>matches</span>
<a name="line-219"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLam</span> <span class='hs-varid'>new_matches</span><span class='hs-layout'>)</span>
<a name="line-220"></a>
<a name="line-221"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c</span>
<a name="line-223"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdPar</span> <span class='hs-varid'>new_c</span><span class='hs-layout'>)</span>
<a name="line-224"></a>
<a name="line-225"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>
<a name="line-226"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-227"></a>       <span class='hs-varid'>new_ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkMatchGroup</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>ms</span>
<a name="line-228"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdCase</span> <span class='hs-varid'>new_expr</span> <span class='hs-varid'>new_ms</span><span class='hs-layout'>)</span>
<a name="line-229"></a>
<a name="line-230"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-varid'>eCond</span> <span class='hs-varid'>ePred</span> <span class='hs-varid'>cThen</span> <span class='hs-varid'>cElse</span><span class='hs-layout'>)</span>
<a name="line-231"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_eCond</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmapMaybeM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>eCond</span>
<a name="line-232"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_ePred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ePred</span>
<a name="line-233"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_cThen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cThen</span>
<a name="line-234"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_cElse</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cElse</span>
<a name="line-235"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdIf</span> <span class='hs-varid'>new_eCond</span> <span class='hs-varid'>new_ePred</span> <span class='hs-varid'>new_cThen</span> <span class='hs-varid'>new_cElse</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-236"></a>
<a name="line-237"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>cmd</span><span class='hs-layout'>)</span>
<a name="line-238"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLocalBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>binds</span>
<a name="line-239"></a>       <span class='hs-varid'>new_cmd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>cmd</span>
<a name="line-240"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdLet</span> <span class='hs-varid'>new_binds</span> <span class='hs-varid'>new_cmd</span><span class='hs-layout'>)</span>
<a name="line-241"></a>
<a name="line-242"></a><span class='hs-definition'>zonkCmd</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdDo</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-243"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_stmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>stmts</span>
<a name="line-244"></a>       <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-245"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdDo</span> <span class='hs-varid'>new_stmts</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span>
<a name="line-246"></a>
<a name="line-247"></a>
<a name="line-248"></a>
<a name="line-249"></a>
<a name="line-250"></a>
<a name="line-251"></a><a name="zonkCmdTop"></a><span class='hs-definition'>zonkCmdTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-252"></a><span class='hs-definition'>zonkCmdTop</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonk_cmd_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmd</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="zonk_cmd_top"></a><span class='hs-definition'>zonk_cmd_top</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsCmdTop</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-255"></a><span class='hs-definition'>zonk_cmd_top</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>cmd</span> <span class='hs-varid'>stack_tys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-256"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_cmd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLCmd</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cmd</span>
<a name="line-257"></a>       <span class='hs-varid'>new_stack_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>stack_tys</span>
<a name="line-258"></a>       <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-259"></a>       <span class='hs-varid'>new_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapSndM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-260"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-varid'>new_cmd</span> <span class='hs-varid'>new_stack_tys</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>new_ids</span><span class='hs-layout'>)</span>
<a name="line-261"></a>
<a name="line-262"></a><a name="zonkCoFn"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-263"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>
<a name="line-264"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-conid'>WpHole</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpHole</span><span class='hs-layout'>)</span>
<a name="line-265"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>c1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>c1</span>
<a name="line-266"></a>                                    <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>c2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>c2</span>
<a name="line-267"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpCompose</span> <span class='hs-varid'>c1'</span> <span class='hs-varid'>c2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-268"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcCoToCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-269"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpCast</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-270"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvBndrX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ev</span>
<a name="line-271"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>ev'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-272"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span>
<a name="line-273"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-274"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-275"></a>                              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyBndrX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-276"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-277"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-278"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-279"></a><span class='hs-definition'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpLet</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcEvBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-280"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>WpLet</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-281"></a>
<a name="line-282"></a><a name="zonkOverLit"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-283"></a><span class='hs-definition'>zonkOverLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-284"></a><span class='hs-definition'>zonkOverLit</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lit</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>OverLit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ol_witness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>ol_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-285"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-286"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-287"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ol_witness</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ol_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-288"></a>
<a name="line-289"></a><a name="zonkArithSeq"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-290"></a><span class='hs-definition'>zonkArithSeq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-291"></a>
<a name="line-292"></a><span class='hs-definition'>zonkArithSeq</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-293"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-294"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>From</span> <span class='hs-varid'>new_e</span><span class='hs-layout'>)</span>
<a name="line-295"></a>
<a name="line-296"></a><span class='hs-definition'>zonkArithSeq</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-297"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-298"></a>       <span class='hs-varid'>new_e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-299"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThen</span> <span class='hs-varid'>new_e1</span> <span class='hs-varid'>new_e2</span><span class='hs-layout'>)</span>
<a name="line-300"></a>
<a name="line-301"></a><span class='hs-definition'>zonkArithSeq</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-302"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-303"></a>       <span class='hs-varid'>new_e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-304"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromTo</span> <span class='hs-varid'>new_e1</span> <span class='hs-varid'>new_e2</span><span class='hs-layout'>)</span>
<a name="line-305"></a>
<a name="line-306"></a><span class='hs-definition'>zonkArithSeq</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span> <span class='hs-varid'>e3</span><span class='hs-layout'>)</span>
<a name="line-307"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-308"></a>       <span class='hs-varid'>new_e2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-309"></a>       <span class='hs-varid'>new_e3</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e3</span>
<a name="line-310"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>new_e1</span> <span class='hs-varid'>new_e2</span> <span class='hs-varid'>new_e3</span><span class='hs-layout'>)</span>
<a name="line-311"></a>
<a name="line-312"></a>
<a name="line-313"></a><a name="zonkStmts"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-314"></a><span class='hs-definition'>zonkStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-315"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-316"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-317"></a><span class='hs-definition'>zonkStmts</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-318"></a><span class='hs-definition'>zonkStmts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>s'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocSndM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-319"></a>                                <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ss'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>zBody</span> <span class='hs-varid'>ss</span>
<a name="line-320"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>s'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-321"></a>
<a name="line-322"></a><a name="zonkStmt"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-323"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-324"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>TcId</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Stmt</span> <span class='hs-conid'>Id</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-varid'>body</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-325"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmt</span> <span class='hs-varid'>stmts_w_bndrs</span> <span class='hs-varid'>mzip_op</span> <span class='hs-varid'>bind_op</span><span class='hs-layout'>)</span>
<a name="line-326"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_stmts_w_bndrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonk_branch</span> <span class='hs-varid'>stmts_w_bndrs</span>
<a name="line-327"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ParStmtBlock</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_stmts_w_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span><span class='hs-keyglyph'>]</span>
<a name="line-328"></a>             <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>new_binders</span>
<a name="line-329"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_mzip</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>mzip_op</span>
<a name="line-330"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_bind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>bind_op</span>
<a name="line-331"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>ParStmt</span> <span class='hs-varid'>new_stmts_w_bndrs</span> <span class='hs-varid'>new_mzip</span> <span class='hs-varid'>new_bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-332"></a>  <span class='hs-keyword'>where</span>
<a name="line-333"></a>    <span class='hs-varid'>zonk_branch</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>stmts</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>return_op</span><span class='hs-layout'>)</span>
<a name="line-334"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_stmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>stmts</span>
<a name="line-335"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>new_return</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>return_op</span>
<a name="line-336"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParStmtBlock</span> <span class='hs-varid'>new_stmts</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdOccs</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_return</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-337"></a>
<a name="line-338"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>segStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rvs</span>
<a name="line-339"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ret_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_mfix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mfix_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_bind_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_id</span>
<a name="line-340"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_rets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>later_rets</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_rets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_rets</span>
<a name="line-341"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ret_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-342"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_rvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rvs</span>
<a name="line-343"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_lvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lvs</span>
<a name="line-344"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_ret_ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ret_ty</span>
<a name="line-345"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_ret_id</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ret_id</span>
<a name="line-346"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_mfix_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>mfix_id</span>
<a name="line-347"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_bind_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bind_id</span>
<a name="line-348"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>new_rvs</span>
<a name="line-349"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_segStmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>zBody</span> <span class='hs-varid'>segStmts</span>
<a name="line-350"></a>        <span class='hs-comment'>-- Zonk the ret-expressions in an envt that</span>
<a name="line-351"></a>        <span class='hs-comment'>-- has the polymorphic bindings in the envt</span>
<a name="line-352"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_later_rets</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>later_rets</span>
<a name="line-353"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_rec_rets</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span> <span class='hs-varid'>rec_rets</span>
<a name="line-354"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>new_lvs</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Only the lvs are needed</span>
<a name="line-355"></a>                 <span class='hs-conid'>RecStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_segStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_lvs</span>
<a name="line-356"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_rvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ret_id</span>
<a name="line-357"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>recS_mfix_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_mfix_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_bind_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_bind_id</span>
<a name="line-358"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>recS_later_rets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_later_rets</span>
<a name="line-359"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>recS_rec_rets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_rec_rets</span><span class='hs-layout'>,</span> <span class='hs-varid'>recS_ret_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ret_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-360"></a>
<a name="line-361"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>then_op</span> <span class='hs-varid'>guard_op</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-362"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>body</span>
<a name="line-363"></a>       <span class='hs-varid'>new_then</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>then_op</span>
<a name="line-364"></a>       <span class='hs-varid'>new_guard</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>guard_op</span>
<a name="line-365"></a>       <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-366"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>BodyStmt</span> <span class='hs-varid'>new_body</span> <span class='hs-varid'>new_then</span> <span class='hs-varid'>new_guard</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span>
<a name="line-367"></a>
<a name="line-368"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>LastStmt</span> <span class='hs-varid'>body</span> <span class='hs-varid'>ret_op</span><span class='hs-layout'>)</span>
<a name="line-369"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>body</span>
<a name="line-370"></a>       <span class='hs-varid'>new_ret</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ret_op</span>
<a name="line-371"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>LastStmt</span> <span class='hs-varid'>new_body</span> <span class='hs-varid'>new_ret</span><span class='hs-layout'>)</span>
<a name="line-372"></a>
<a name="line-373"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderMap</span>
<a name="line-374"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using</span>
<a name="line-375"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>trS_ret</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM_op</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-376"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkStmts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>stmts</span>
<a name="line-377"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>binderMap'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkBinderMapEntry</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>binderMap</span>
<a name="line-378"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>by'</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmapMaybeM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span> <span class='hs-varid'>by</span>
<a name="line-379"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>using'</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>using</span>
<a name="line-380"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>return_op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>return_op</span>
<a name="line-381"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>bind_op'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>bind_op</span>
<a name="line-382"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>liftM_op'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>liftM_op</span>
<a name="line-383"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env'</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>binderMap'</span><span class='hs-layout'>)</span>
<a name="line-384"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env''</span><span class='hs-layout'>,</span> <span class='hs-conid'>TransStmt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>trS_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderMap'</span>
<a name="line-385"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>trS_by</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>by'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_form</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>form</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_using</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>using'</span>
<a name="line-386"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>trS_ret</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>trS_fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM_op'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-387"></a>  <span class='hs-keyword'>where</span>
<a name="line-388"></a>    <span class='hs-varid'>zonkBinderMapEntry</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>oldBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>newBinder</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-389"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>oldBinder'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>oldBinder</span>
<a name="line-390"></a>        <span class='hs-varid'>newBinder'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>newBinder</span>
<a name="line-391"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>oldBinder'</span><span class='hs-layout'>,</span> <span class='hs-varid'>newBinder'</span><span class='hs-layout'>)</span>
<a name="line-392"></a>
<a name="line-393"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetStmt</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-394"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLocalBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>binds</span>
<a name="line-395"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>LetStmt</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span>
<a name="line-396"></a>
<a name="line-397"></a><span class='hs-definition'>zonkStmt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>zBody</span> <span class='hs-layout'>(</span><span class='hs-conid'>BindStmt</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-varid'>bind_op</span> <span class='hs-varid'>fail_op</span><span class='hs-layout'>)</span>
<a name="line-398"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_body</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zBody</span> <span class='hs-varid'>env</span> <span class='hs-varid'>body</span>
<a name="line-399"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>
<a name="line-400"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_bind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bind_op</span>
<a name="line-401"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>new_fail</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fail_op</span>
<a name="line-402"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>BindStmt</span> <span class='hs-varid'>new_pat</span> <span class='hs-varid'>new_body</span> <span class='hs-varid'>new_bind</span> <span class='hs-varid'>new_fail</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-403"></a>
<a name="line-404"></a><a name="zonkRecFields"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-405"></a><span class='hs-definition'>zonkRecFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsRecordBinds</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecordBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-406"></a><span class='hs-definition'>zonkRecFields</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>flds</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span>
<a name="line-407"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>flds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonk_rbind</span> <span class='hs-varid'>flds</span>
<a name="line-408"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>flds'</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-409"></a>  <span class='hs-keyword'>where</span>
<a name="line-410"></a>    <span class='hs-varid'>zonk_rbind</span> <span class='hs-varid'>fld</span>
<a name="line-411"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_id</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsRecFieldId</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span>
<a name="line-412"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsRecFieldArg</span> <span class='hs-varid'>fld</span><span class='hs-layout'>)</span>
<a name="line-413"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fld</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_expr</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-414"></a>
<a name="line-415"></a><a name="mapIPNameTc"></a><span class='hs-comment'>-------------------------------------------------------------------------</span>
<a name="line-416"></a><span class='hs-definition'>mapIPNameTc</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>HsIPName</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>HsIPName</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-417"></a><span class='hs-definition'>mapIPNameTc</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-418"></a><span class='hs-definition'>mapIPNameTc</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span>
<a name="line-419"></a>                             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection[BackSubst-Pats]{Patterns}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkPat"></a><span class='hs-definition'>zonkPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutPat</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutPat</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Extend the environment as we go, because it's possible for one</span>
<a name="line-3"></a><span class='hs-comment'>-- pattern to bind something that is used in another (inside or</span>
<a name="line-4"></a><span class='hs-comment'>-- to the right)</span>
<a name="line-5"></a><span class='hs-definition'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocSndM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonk_pat</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="zonk_pat"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-8"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>p'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>p</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>ParPat</span> <span class='hs-varid'>p'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>WildPat</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>WildPat</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarPat</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdZonkEnv1</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v'</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarPat</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LazyPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span>  <span class='hs-conid'>LazyPat</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>BangPat</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span>  <span class='hs-conid'>BangPat</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdZonkEnv1</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat</span>
<a name="line-31"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>AsPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViewPat</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>ViewPat</span> <span class='hs-varid'>expr'</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pats</span>
<a name="line-42"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>ty'</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-layout'>,</span><span class='hs-varid'>wit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>wit'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>wit</span>
<a name="line-46"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty2</span>
<a name="line-47"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pats</span>
<a name="line-49"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>ListPat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span><span class='hs-varid'>wit'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrPat</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-53"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pats</span>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>PArrPat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePat</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>boxed</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-58"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pats</span>
<a name="line-59"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>TuplePat</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>boxed</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ConPatOut</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span>
<a name="line-62"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>pat_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span>
<a name="line-63"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>pat_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapper</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>)</span>
<a name="line-65"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>new_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-66"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env0</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tyvars</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyBndrsX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span>
<a name="line-67"></a>          <span class='hs-comment'>-- Must zonk the existential variables, because their</span>
<a name="line-68"></a>          <span class='hs-comment'>-- /kind/ need potential zonking.</span>
<a name="line-69"></a>          <span class='hs-comment'>-- cf typecheck/should_compile/tc221.hs</span>
<a name="line-70"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_evs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvBndrsX</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>evs</span>
<a name="line-71"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcEvBinds</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>binds</span>
<a name="line-72"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env3</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_wrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>wrapper</span>
<a name="line-73"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkConStuff</span> <span class='hs-varid'>env3</span> <span class='hs-varid'>args</span>
<a name="line-74"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>p</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tys</span><span class='hs-layout'>,</span>
<a name="line-75"></a>                            <span class='hs-varid'>pat_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tyvars</span><span class='hs-layout'>,</span>
<a name="line-76"></a>                            <span class='hs-varid'>pat_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_evs</span><span class='hs-layout'>,</span>
<a name="line-77"></a>                            <span class='hs-varid'>pat_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>,</span>
<a name="line-78"></a>                            <span class='hs-varid'>pat_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_args</span><span class='hs-layout'>,</span>
<a name="line-79"></a>                            <span class='hs-varid'>pat_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wrapper</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitPat</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>LitPat</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigPatOut</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-85"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>
<a name="line-86"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>SigPatOut</span> <span class='hs-varid'>pat'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NPat</span> <span class='hs-varid'>lit</span> <span class='hs-varid'>mb_neg</span> <span class='hs-varid'>eq_expr</span><span class='hs-layout'>)</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>lit'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkOverLit</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lit</span>
<a name="line-90"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mb_neg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmapMaybeM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_neg</span>
<a name="line-91"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>eq_expr'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>eq_expr</span>
<a name="line-92"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>NPat</span> <span class='hs-varid'>lit'</span> <span class='hs-varid'>mb_neg'</span> <span class='hs-varid'>eq_expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NPlusKPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>lit</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n</span>
<a name="line-96"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>lit'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkOverLit</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lit</span>
<a name="line-97"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>e1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e1</span>
<a name="line-98"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>e2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e2</span>
<a name="line-99"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdZonkEnv1</span> <span class='hs-varid'>env</span> <span class='hs-varid'>n'</span><span class='hs-layout'>,</span> <span class='hs-conid'>NPlusKPat</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span> <span class='hs-varid'>lit'</span> <span class='hs-varid'>e1'</span> <span class='hs-varid'>e2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoPat</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_fn'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkCoFn</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co_fn</span>
<a name="line-103"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env''</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env'</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-104"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env''</span> <span class='hs-varid'>ty</span>
<a name="line-105"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env''</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoPat</span> <span class='hs-varid'>co_fn'</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-106"></a>
<a name="line-107"></a><span class='hs-definition'>zonk_pat</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zonk_pat"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-108"></a>
<a name="line-109"></a><a name="zonkConStuff"></a><span class='hs-comment'>---------------------------</span>
<a name="line-110"></a><span class='hs-definition'>zonkConStuff</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span>
<a name="line-111"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsConDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutPat</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-112"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span>
<a name="line-113"></a>                     <span class='hs-conid'>HsConDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutPat</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutPat</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-114"></a><span class='hs-definition'>zonkConStuff</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>pats</span><span class='hs-layout'>)</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pats</span>
<a name="line-116"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-definition'>zonkConStuff</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>p1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span>  <span class='hs-varid'>p1</span>
<a name="line-120"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>p2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>p2</span>
<a name="line-121"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1'</span> <span class='hs-varid'>p2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-definition'>zonkConStuff</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>rpats</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-124"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-varid'>rpats</span><span class='hs-layout'>)</span>
<a name="line-125"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rpats'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>rp</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>rpats</span> <span class='hs-varid'>pats'</span>
<a name="line-126"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>rpats'</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-127"></a>        <span class='hs-comment'>-- Field selectors have declared types; hence no zonking</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="zonkPats"></a><span class='hs-comment'>---------------------------</span>
<a name="line-130"></a><span class='hs-definition'>zonkPats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OutPat</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OutPat</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-131"></a><span class='hs-definition'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-132"></a><span class='hs-definition'>zonkPats</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>pat</span><span class='hs-conop'>:</span><span class='hs-varid'>pats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPat</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pat</span>
<a name="line-133"></a>                             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPats</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>pats</span>
<a name="line-134"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat'</span><span class='hs-conop'>:</span><span class='hs-varid'>pats'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[BackSubst-Foreign]{Foreign exports}
%*                                                                      *
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="zonkForeignExports"></a><span class='hs-definition'>zonkForeignExports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>zonkForeignExports</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkForeignExport</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ls</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="zonkForeignExport"></a><span class='hs-definition'>zonkForeignExport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignDecl</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignDecl</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>zonkForeignExport</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignExport</span> <span class='hs-varid'>i</span> <span class='hs-sel'>_hs_ty</span> <span class='hs-varid'>co</span> <span class='hs-varid'>spec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-6"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignExport</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>undefined</span> <span class='hs-varid'>co</span> <span class='hs-varid'>spec</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>zonkForeignExport</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>for_imp</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>for_imp</span>     <span class='hs-comment'>-- Foreign imports don't need zonking</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="zonkRules"></a><span class='hs-definition'>zonkRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>zonkRules</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkRule</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rs</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="zonkRule"></a><span class='hs-definition'>zonkRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RuleDecl</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleDecl</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>zonkRule</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>act</span> <span class='hs-layout'>(</span><span class='hs-varid'>vars</span><span class='hs-comment'>{-::[RuleBndr TcId]-}</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>fv_lhs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>fv_rhs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unbound_tkv_set</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env_rule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setZonkType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkTvCollecting</span> <span class='hs-varid'>unbound_tkv_set</span><span class='hs-layout'>)</span>
<a name="line-8"></a>              <span class='hs-comment'>-- See Note [Zonking the LHS of a RULE]</span>
<a name="line-9"></a>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_inside</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>zonk_bndr</span> <span class='hs-varid'>env_rule</span> <span class='hs-varid'>vars</span>
<a name="line-11"></a>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env_inside</span> <span class='hs-varid'>lhs</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_rhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env_inside</span> <span class='hs-varid'>rhs</span>
<a name="line-14"></a>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unbound_tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>unbound_tkv_set</span>
<a name="line-16"></a>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RuleBndr</span> <span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a>             <span class='hs-varid'>final_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>noLoc</span><span class='hs-layout'>)</span>
<a name="line-19"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>varSetElemsKvsFirst</span> <span class='hs-varid'>unbound_tkvs</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                           <span class='hs-varop'>++</span> <span class='hs-varid'>new_bndrs</span>
<a name="line-21"></a>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-23"></a>         <span class='hs-conid'>HsRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>act</span> <span class='hs-varid'>final_bndrs</span> <span class='hs-varid'>new_lhs</span> <span class='hs-varid'>fv_lhs</span> <span class='hs-varid'>new_rhs</span> <span class='hs-varid'>fv_rhs</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>  <span class='hs-keyword'>where</span>
<a name="line-25"></a>   <span class='hs-varid'>zonk_bndr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonk_it</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-27"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>RuleBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>   <span class='hs-varid'>zonk_bndr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndrSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"zonk_bndr RuleBndrSig"</span>
<a name="line-29"></a>
<a name="line-30"></a>   <span class='hs-varid'>zonk_it</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-31"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>v</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-32"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendIdZonkEnv1</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-34"></a>                    <span class='hs-varid'>zonkTyBndrX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-35"></a>                    <span class='hs-comment'>-- DV: used to be return (env,v) but that is plain</span>
<a name="line-36"></a>                    <span class='hs-comment'>-- wrong because we may need to go inside the kind</span>
<a name="line-37"></a>                    <span class='hs-comment'>-- of v and zonk there!</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="zonkVects"></a><span class='hs-definition'>zonkVects</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>zonkVects</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkVect</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="zonkVect"></a><span class='hs-definition'>zonkVect</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VectDecl</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>VectDecl</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>zonkVect</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVect</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkLExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVect</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>e'</span>
<a name="line-9"></a>       <span class='hs-layout'>}</span>
<a name="line-10"></a><span class='hs-definition'>zonkVect</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNoVect</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdBndr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsNoVect</span> <span class='hs-varid'>v'</span>
<a name="line-13"></a>       <span class='hs-layout'>}</span>
<a name="line-14"></a><span class='hs-definition'>zonkVect</span> <span class='hs-sel'>_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectTypeOut</span> <span class='hs-varid'>s</span> <span class='hs-varid'>t</span> <span class='hs-varid'>rt</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVectTypeOut</span> <span class='hs-varid'>s</span> <span class='hs-varid'>t</span> <span class='hs-varid'>rt</span>
<a name="line-16"></a><span class='hs-definition'>zonkVect</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectTypeIn</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcHsSyn.zonkVect: HsVectTypeIn"</span>
<a name="line-17"></a><span class='hs-definition'>zonkVect</span> <span class='hs-sel'>_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectClassOut</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVectClassOut</span> <span class='hs-varid'>c</span>
<a name="line-19"></a><span class='hs-definition'>zonkVect</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectClassIn</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcHsSyn.zonkVect: HsVectClassIn"</span>
<a name="line-20"></a><span class='hs-definition'>zonkVect</span> <span class='hs-sel'>_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectInstOut</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVectInstOut</span> <span class='hs-varid'>i</span>
<a name="line-22"></a><span class='hs-definition'>zonkVect</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVectInstIn</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"TcHsSyn.zonkVect: HsVectInstIn"</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
              Constraints and evidence
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkEvTerm"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvTerm</span>
<a name="line-2"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-layout'>)</span>
<a name="line-3"></a>                                    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcCoToCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-5"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-6"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tm</span>
<a name="line-7"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcCoToCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-8"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEvCast</span> <span class='hs-varid'>tm'</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-9"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tm</span>
<a name="line-10"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>tm'</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>tms</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tms'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkEvTerm</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tms</span>
<a name="line-12"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>tms'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>EvLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>d'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-varid'>d</span>
<a name="line-15"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>d'</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-varid'>df</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tms</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tms'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkEvTerm</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tms</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkIdOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>df</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span> <span class='hs-varid'>tms'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a><span class='hs-definition'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="zonkTcEvBinds"></a><span class='hs-definition'>zonkTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-definition'>zonkTcEvBinds</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvBindsVar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-26"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a><span class='hs-definition'>zonkTcEvBinds</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-28"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="zonkEvBindsVar"></a><span class='hs-definition'>zonkEvBindsVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-definition'>zonkEvBindsVar</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-varid'>ref</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-32"></a>                                           <span class='hs-layout'>;</span> <span class='hs-varid'>zonkEvBinds</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="zonkEvBinds"></a><span class='hs-definition'>zonkEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-definition'>zonkEvBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>binds</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "zonkEvBinds" #-}</span>
<a name="line-37"></a>    <span class='hs-varid'>fixM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-38"></a>         <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdZonkEnv</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>collect_ev_bndrs</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>)</span>
<a name="line-39"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkEvBind</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-40"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>collect_ev_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-43"></a>    <span class='hs-varid'>collect_ev_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>add</span> <span class='hs-conid'>[]</span>
<a name="line-44"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>var</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>var</span> <span class='hs-conop'>:</span> <span class='hs-varid'>vars</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="zonkEvBind"></a><span class='hs-definition'>zonkEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvBind</span>
<a name="line-47"></a><span class='hs-definition'>zonkEvBind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>var</span> <span class='hs-varid'>term</span><span class='hs-layout'>)</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>var'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "zonkEvBndr" #-}</span> <span class='hs-varid'>zonkEvBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-49"></a>
<a name="line-50"></a>         <span class='hs-comment'>-- Optimise the common case of Refl coercions</span>
<a name="line-51"></a>         <span class='hs-comment'>-- See Note [Optimise coercion zonking]</span>
<a name="line-52"></a>         <span class='hs-comment'>-- This has a very big effect on some programs (eg Trac #5030)</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>var'</span>
<a name="line-54"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>ty'</span> <span class='hs-keyword'>of</span>
<a name="line-55"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span>
<a name="line-56"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>var'</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>           <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>term'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvTerm</span> <span class='hs-varid'>env</span> <span class='hs-varid'>term</span>
<a name="line-58"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>var'</span> <span class='hs-varid'>term'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                         Zonking types
%*                                                                      *
%************************************************************************

Note [Zonking the LHS of a RULE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to gather the type variables mentioned on the LHS so we can
quantify over them.  Example:
  data T a = C

  foo :: T a -> Int
  foo C = 1

  {-# RULES "myrule"  foo C = 1 #-}

After type checking the LHS becomes (foo a (C a))
and we do not want to zap the unbound tyvar 'a' to (), because
that limits the applicability of the rule.  Instead, we
want to quantify over it!

It's easiest to get zonkTvCollecting to gather the free tyvars
here. Attempts to do so earlier are tiresome, because (a) the data
type is big and (b) finding the free type vars of an expression is
necessarily monadic operation. (consider /\a -> f @ b, where b is
side-effected to a)

And that in turn is why ZonkEnv carries the function to use for
type variables!

Note [Zonking mutable unbound type or kind variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In zonkTypeZapping, we zonk mutable but unbound type or kind variables to an
arbitrary type. We know if they are unbound even though we don't carry an
environment, because at the binding site for a variable we bind the mutable
var to a fresh immutable one.  So the mutable store plays the role of an
environment.  If we come across a mutable variable that isn't so bound, it
must be completely free. We zonk the expected kind to make sure we don't get
some unbound meta variable as the kind.

Note that since we have kind polymorphism, zonk_unbound_tyvar will handle both
type and kind variables. Consider the following datatype:

  data Phantom a = Phantom Int

The type of Phantom is (forall (k : BOX). forall (a : k). Int). Both `a` and
`k` are unbound variables. We want to zonk this to
(forall (k : AnyK). forall (a : Any AnyK). Int). For that we have to check if
we have a type or a kind variable; for kind variables we just return AnyK (and
not the ill-kinded Any BOX).

Note [Optimise coercion zonkind]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When optimising evidence binds we may come across situations where
a coercion looks like
      cv = ReflCo ty
or    cv1 = cv2
where the type 'ty' is big.  In such cases it is a waste of time to zonk both
  * The variable on the LHS
  * The coercion on the RHS
Rather, we can zonk the variable, and if its type is (ty ~ ty), we can just
use Refl on the right, ignoring the actual coercion on the RHS.

This can have a very big effect, because the constraint solver sometimes does go
to a lot of effort to prove Refl!  (Eg when solving  10+3 = 10+3; cf Trac #5030)

\begin{code}
<pre><a name="line-1"></a><a name="zonkTyVarOcc"></a><span class='hs-definition'>zonkTyVarOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-2"></a><span class='hs-definition'>zonkTyVarOcc</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ZonkEnv</span> <span class='hs-varid'>zonk_unbound_tyvar</span> <span class='hs-varid'>tv_env</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-5"></a>         <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookup_in_env</span>
<a name="line-6"></a>         <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookup_in_env</span>
<a name="line-7"></a>         <span class='hs-conid'>FlatSkol</span> <span class='hs-varid'>ty</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-8"></a>         <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-10"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>                      <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "zonkKind1" #-}</span>
<a name="line-12"></a>                                            <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                                  <span class='hs-layout'>;</span> <span class='hs-varid'>zonk_unbound_tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>                      <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>zty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-15"></a>                                        <span class='hs-comment'>-- Small optimisation: shortern-out indirect steps</span>
<a name="line-16"></a>                                        <span class='hs-comment'>-- so that the old type may be more easily collected.</span>
<a name="line-17"></a>                                        <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indirect</span> <span class='hs-varid'>zty</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>zty</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_in_env</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>lookup_in_env</span>    <span class='hs-comment'>-- Look up in the env just as we do for Ids</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-24"></a>          <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-25"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="zonkTcTypeToType"></a><span class='hs-definition'>zonkTcTypeToType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-28"></a><span class='hs-definition'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-32"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                <span class='hs-comment'>-- Establish Type invariants</span>
<a name="line-34"></a>                <span class='hs-comment'>-- See Note [Zonking inside the knot] in TcHsType</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-39"></a>                              <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-40"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>
<a name="line-43"></a>                              <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-44"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-45"></a>                <span class='hs-comment'>-- NB the mkAppTy; we might have instantiated a</span>
<a name="line-46"></a>                <span class='hs-comment'>-- type variable to a type constructor, so we need</span>
<a name="line-47"></a>                <span class='hs-comment'>-- to pull the TyConApp to the top.</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-comment'>-- The two interesting cases!</span>
<a name="line-50"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTyVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-51"></a>
<a name="line-52"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-53"></a>                          <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyBndrX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-54"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>ty</span>
<a name="line-55"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="zonkTcTypeToTypes"></a><span class='hs-definition'>zonkTcTypeToTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-58"></a><span class='hs-definition'>zonkTcTypeToTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="zonkTvCollecting"></a><span class='hs-definition'>zonkTvCollecting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnboundTyVarZonker</span>
<a name="line-61"></a><span class='hs-comment'>-- This variant collects unbound type variables in a mutable variable</span>
<a name="line-62"></a><span class='hs-comment'>-- Works on both types and kinds</span>
<a name="line-63"></a><span class='hs-definition'>zonkTvCollecting</span> <span class='hs-varid'>unbound_tv_set</span> <span class='hs-varid'>tv</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>poly_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PolyKinds</span>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>poly_kinds</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>defaultKindVarToStar</span> <span class='hs-varid'>tv</span>
<a name="line-66"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-67"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkQuantifiedTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-68"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tv_set</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>unbound_tv_set</span>
<a name="line-69"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>unbound_tv_set</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>tv_set</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-70"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="zonkTypeZapping"></a><span class='hs-definition'>zonkTypeZapping</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnboundTyVarZonker</span>
<a name="line-73"></a><span class='hs-comment'>-- This variant is used for everything except the LHS of rules</span>
<a name="line-74"></a><span class='hs-comment'>-- It zaps unbound type variables to (), or some other arbitrary type</span>
<a name="line-75"></a><span class='hs-comment'>-- Works on both types and kinds</span>
<a name="line-76"></a><span class='hs-definition'>zonkTypeZapping</span> <span class='hs-varid'>tv</span>
<a name="line-77"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>tv</span>
<a name="line-78"></a>                  <span class='hs-comment'>-- ty is actually a kind, zonk to AnyK</span>
<a name="line-79"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>anyKind</span>
<a name="line-80"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>anyTypeOfKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-81"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-83"></a>
<a name="line-84"></a>
<a name="line-85"></a><a name="zonkTcCoToCo"></a><span class='hs-definition'>zonkTcCoToCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZonkEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-86"></a><span class='hs-comment'>-- NB: zonking often reveals that the coercion is an identity</span>
<a name="line-87"></a><span class='hs-comment'>--     in which case the Refl-ness can propagate up to the top</span>
<a name="line-88"></a><span class='hs-comment'>--     which in turn gives more efficient desugaring.  So it's</span>
<a name="line-89"></a><span class='hs-comment'>--     worth using the 'mk' smart constructors on the RHS</span>
<a name="line-90"></a><span class='hs-definition'>zonkTcCoToCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-92"></a>  <span class='hs-keyword'>where</span>
<a name="line-93"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcEvBinds</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-94"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcCoToCo</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>co</span>
<a name="line-95"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>bs'</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkEvVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-97"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-98"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-99"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-102"></a>                              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-103"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>;</span> <span class='hs-varid'>co2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-104"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-105"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCastCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>;</span> <span class='hs-varid'>co2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-106"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCastCo</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPhantomCo</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span>
<a name="line-108"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty2</span>
<a name="line-109"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPhantomCo</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-110"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-111"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-112"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-113"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>;</span> <span class='hs-varid'>co2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-114"></a>                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTransCo</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-116"></a>                                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-117"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSubCo</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-118"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ts</span>
<a name="line-119"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>cs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span>
<a name="line-120"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts'</span> <span class='hs-varid'>cs'</span><span class='hs-layout'>)</span>
<a name="line-121"></a>                                     <span class='hs-layout'>}</span>
</pre>\end{code}
</body>
</html>
